<!doctype html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
        }

        .chat-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 80%;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 1rem;
        }

        .user-msg {
            background-color: #dbeafe;
            margin-left: auto;
            color: #1e3a8a;
        }

        .ai-msg {
            background-color: #ffffff;
            margin-right: auto;
            border: 1px solid #e5e7eb;
            color: #374151;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: #2563eb;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <header class="bg-blue-900 text-white p-4 shadow-md flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            Gemini AI Assistant
        </h1>
    </header>

    <main class="flex-1 max-w-4xl mx-auto w-full p-4">
        <div id="chat-box" class="chat-container bg-gray-50 rounded-lg p-4">
            <div class="message ai-msg">
                <p><strong>Xin chào!</strong> Tôi là trợ lý AI sử dụng <strong>Gemini 1.5 Pro</strong>.</p>
                <p>Hãy nhập câu hỏi hoặc yêu cầu của bạn.</p>
            </div>
        </div>

        <div class="mt-4 flex gap-2">
            <textarea id="userInput"
                class="flex-1 border border-gray-300 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500 resize-none"
                rows="2" placeholder="Nhập tin nhắn..."></textarea>
            <button onclick="sendMessage()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                Gửi
            </button>
        </div>
    </main>

    <script>
        // ============================================================
        // GEMINI AI CONFIGURATION
        // ============================================================

        // API Key Management - Priority: localStorage > Default Key > empty
        const savedGeminiProKey = localStorage.getItem("geminiApiKey");
        window.GEMINI_PRO_KEY = savedGeminiProKey || 'AIzaSyAQtOsL4Iir7MpLBwaNjIll1I_bQDfHobs' || '';

        // Model Configuration - Available models: gemini-1.5-pro, gemini-1.5-flash, gemini-2.0-flash
        const GEMINI_MODEL = 'gemini-1.5-pro';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent`;

        console.log('[GEMINI] Using model:', GEMINI_MODEL);
        console.log('[GEMINI] API Key configured:', window.GEMINI_PRO_KEY ? 'Yes' : 'No');

        // ============================================================
        // STATE & CONFIGURATION
        // ============================================================

        let conversationHistory = [];

        // System Prompt - Customize this for your use case
        const systemInstruction = `
            Bạn là một trợ lý AI thông minh và hữu ích.
            Hãy trả lời bằng tiếng Việt một cách rõ ràng và chi tiết.
        `;

        // ============================================================
        // CHAT FUNCTIONS
        // ============================================================

        function addMessage(role, text) {
            const box = document.getElementById("chat-box");
            const div = document.createElement("div");
            div.className = `message ${role === "user" ? "user-msg" : "ai-msg"}`;
            div.innerHTML = marked.parse(text);
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById("userInput");
            const text = input.value.trim();
            const apiKey = window.GEMINI_PRO_KEY;

            if (!apiKey) {
                addMessage("ai", "Khong tim thay API Key. Vui long lien he quan tri vien.");
                return;
            }
            if (!text) return;

            // Display user message
            addMessage("user", text);
            input.value = "";

            // Show loading
            const box = document.getElementById("chat-box");
            const loadingDiv = document.createElement("div");
            loadingDiv.className = "message ai-msg";
            loadingDiv.innerHTML = '<span class="loading"></span> Dang xu ly...';
            loadingDiv.id = "loading-msg";
            box.appendChild(loadingDiv);
            box.scrollTop = box.scrollHeight;

            try {
                // Build request payload
                const parts = [{ text: text }];

                // Add system instruction on first message
                if (conversationHistory.length === 0) {
                    parts.unshift({ text: systemInstruction });
                }

                const contents = [{ role: "user", parts: parts }];

                // Call Gemini API
                const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: contents }),
                });

                const data = await response.json();

                // Remove loading
                document.getElementById("loading-msg")?.remove();

                if (data.error) {
                    addMessage("ai", `Loi: ${data.error.message}`);
                } else {
                    const aiText = data.candidates[0].content.parts[0].text;
                    addMessage("ai", aiText);

                    // Save to conversation history
                    conversationHistory.push({ role: "user", parts: parts });
                    conversationHistory.push({ role: "model", parts: [{ text: aiText }] });
                }
            } catch (error) {
                document.getElementById("loading-msg")?.remove();
                addMessage("ai", "Co loi xay ra khi ket noi voi Gemini AI.");
                console.error('[GEMINI ERROR]', error);
            }
        }

        // ============================================================
        // UTILITY FUNCTIONS FOR GEMINI API
        // ============================================================

        /**
         * Call Gemini API directly with custom prompt
         * @param {string} prompt - The prompt to send
         * @param {Array} imageParts - Optional array of image data objects
         * @returns {Promise<string>} - The AI response text
         */
        async function callGeminiAPI(prompt, imageParts = []) {
            const apiKey = window.GEMINI_PRO_KEY;
            if (!apiKey) throw new Error('API Key not configured');

            const parts = [{ text: prompt }, ...imageParts];

            const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: parts }]
                }),
            });

            const data = await response.json();

            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        }

        /**
         * Convert file to base64 for Gemini API
         * @param {File} file - The file to convert
         * @returns {Promise<Object>} - Object with inline_data for Gemini API
         */
        function fileToGeminiPart(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(",")[1];
                    resolve({
                        inline_data: {
                            mime_type: file.type,
                            data: base64,
                        }
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Allow Enter key to send message
        document.getElementById('userInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>

</html>
