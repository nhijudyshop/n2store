<!--
  üìñ GHI CH√ö CHO L·∫¨P TR√åNH VI√äN:
  Khi code ph·∫£i ƒë·ªçc th∆∞ m·ª•c https://github.com/nhijudyshop/n2store/tree/main/docs tr∆∞·ªõc!
  ƒê·ªçc c√°c file SHARED_*.md ƒë·ªÉ hi·ªÉu c√°ch s·ª≠ d·ª•ng shared modules.
-->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X√≥a to√†n b·ªô kh√°ch h√†ng</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #dc2626; }
        .warning {
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .stats {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        .btn-check { background: #3b82f6; color: white; }
        .btn-backup { background: #10b981; color: white; }
        .btn-delete { background: #dc2626; color: white; }
        .btn-delete:disabled { background: #9ca3af; cursor: not-allowed; }
        #log {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö†Ô∏è X√≥a to√†n b·ªô kh√°ch h√†ng</h1>

        <div class="warning">
            <strong>C·∫¢NH B√ÅO:</strong> H√†nh ƒë·ªông n√†y s·∫Ω x√≥a T·∫§T C·∫¢ d·ªØ li·ªáu kh√°ch h√†ng v√† KH√îNG TH·ªÇ ho√†n t√°c!
        </div>

        <div class="stats" id="statsContainer">
            <strong>Th·ªëng k√™ hi·ªán t·∫°i:</strong>
            <div id="statsContent">Ch∆∞a ki·ªÉm tra...</div>
        </div>

        <div>
            <button class="btn-check" onclick="checkStats()">1. Ki·ªÉm tra s·ªë l∆∞·ª£ng</button>
            <button class="btn-backup" onclick="downloadBackup()">2. T·∫£i backup (JSON)</button>
            <button class="btn-delete" id="deleteBtn" onclick="deleteAll()" disabled>3. X√ìA T·∫§T C·∫¢</button>
        </div>

        <div id="log"></div>
    </div>

    <script>
        const API_URL = 'https://chatomni-proxy.nhijudyshop.workers.dev';
        const DIRECT_API_URL = 'https://n2store-fallback.onrender.com';
        let allCustomers = [];

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logEl.innerHTML += `<span class="${className}">[${time}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function checkStats() {
            log('ƒêang ki·ªÉm tra th·ªëng k√™...');
            try {
                const response = await fetch(`${API_URL}/api/customers/stats`);
                const result = await response.json();

                if (result.success) {
                    const stats = result.data;
                    document.getElementById('statsContent').innerHTML = `
                        <br>‚Ä¢ T·ªïng s·ªë: <strong>${stats.total}</strong> kh√°ch h√†ng
                        <br>‚Ä¢ B√¨nh th∆∞·ªùng: ${stats.normal}
                        <br>‚Ä¢ Bom h√†ng: ${stats.danger}
                        <br>‚Ä¢ C·∫£nh b√°o: ${stats.warning}
                        <br>‚Ä¢ Nguy hi·ªÉm: ${stats.critical}
                        <br>‚Ä¢ VIP: ${stats.vip}
                        <br>‚Ä¢ T·ªïng n·ª£: ${new Intl.NumberFormat('vi-VN').format(stats.total_debt)} VND
                    `;
                    log(`‚úÖ C√≥ ${stats.total} kh√°ch h√†ng trong database`, 'success');

                    if (stats.total > 0) {
                        document.getElementById('deleteBtn').disabled = false;
                    }
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                log(`‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        async function downloadBackup() {
            log('ƒêang t·∫£i backup...');
            try {
                // Fetch all customers (paginated)
                allCustomers = [];
                let page = 1;
                let hasMore = true;

                while (hasMore) {
                    log(`ƒêang t·∫£i trang ${page}...`);
                    const response = await fetch(`${API_URL}/api/customers?page=${page}&limit=500`);
                    const result = await response.json();

                    if (result.success && result.data.length > 0) {
                        allCustomers = allCustomers.concat(result.data);
                        page++;
                        hasMore = result.data.length === 500;
                    } else {
                        hasMore = false;
                    }
                }

                log(`‚úÖ ƒê√£ t·∫£i ${allCustomers.length} kh√°ch h√†ng`, 'success');

                // Create download
                const backup = {
                    exported_at: new Date().toISOString(),
                    total_count: allCustomers.length,
                    customers: allCustomers
                };

                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `customers-backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);

                log(`‚úÖ ƒê√£ t·∫£i file backup`, 'success');
                document.getElementById('deleteBtn').disabled = false;

            } catch (error) {
                log(`‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        async function deleteAll() {
            const confirmed = confirm('B·∫†N CH·∫ÆC CH·∫ÆN MU·ªêN X√ìA T·∫§T C·∫¢ KH√ÅCH H√ÄNG?\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c!');
            if (!confirmed) {
                log('ƒê√£ h·ªßy x√≥a.', 'info');
                return;
            }

            const doubleConfirm = prompt('Nh·∫≠p "XOA TAT CA" ƒë·ªÉ x√°c nh·∫≠n:');
            if (doubleConfirm !== 'XOA TAT CA') {
                log('X√°c nh·∫≠n kh√¥ng ƒë√∫ng. ƒê√£ h·ªßy.', 'error');
                return;
            }

            log('‚ö†Ô∏è B·∫Øt ƒë·∫ßu x√≥a to√†n b·ªô kh√°ch h√†ng...');
            document.getElementById('deleteBtn').disabled = true;

            try {
                // Try the new delete-all endpoint first
                let response = await fetch(`${API_URL}/api/customers/all?confirm=yes-delete-all`, {
                    method: 'DELETE'
                });

                // If proxy fails, try direct
                if (!response.ok) {
                    log('Proxy kh√¥ng ph·∫£n h·ªìi, th·ª≠ k·∫øt n·ªëi tr·ª±c ti·∫øp...', 'info');
                    response = await fetch(`${DIRECT_API_URL}/api/customers/all?confirm=yes-delete-all`, {
                        method: 'DELETE'
                    });
                }

                const result = await response.json();

                if (result.success) {
                    log(`‚úÖ ƒê√É X√ìA ${result.deleted_count} KH√ÅCH H√ÄNG!`, 'success');
                    log('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x√≥a ho√†n to√†n.', 'success');

                    // Update stats
                    document.getElementById('statsContent').innerHTML = '<br>‚Ä¢ T·ªïng s·ªë: <strong>0</strong> kh√°ch h√†ng';
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                log(`‚ùå L·ªói: ${error.message}`, 'error');
                log('Endpoint delete-all ch∆∞a ƒë∆∞·ª£c deploy. ƒêang x√≥a t·ª´ng kh√°ch h√†ng...', 'info');

                // Fallback: Delete one by one
                await deleteOneByOne();
            }
        }

        async function deleteOneByOne() {
            if (allCustomers.length === 0) {
                log('C·∫ßn t·∫£i backup tr∆∞·ªõc ƒë·ªÉ c√≥ danh s√°ch ID', 'error');
                return;
            }

            let deleted = 0;
            let failed = 0;

            for (const customer of allCustomers) {
                try {
                    const response = await fetch(`${API_URL}/api/customers/${customer.id}?hard_delete=true`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        deleted++;
                        if (deleted % 100 === 0) {
                            log(`ƒê√£ x√≥a ${deleted}/${allCustomers.length}...`);
                        }
                    } else {
                        failed++;
                    }
                } catch (e) {
                    failed++;
                }
            }

            log(`‚úÖ Ho√†n t·∫•t: X√≥a ${deleted}, L·ªói ${failed}`, deleted > 0 ? 'success' : 'error');
        }

        // Auto-check on load
        window.onload = checkStats;
    </script>
</body>
</html>
