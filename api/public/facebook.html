<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Facebook Live Video - TPOS API</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #1877f2 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                overflow: hidden;
            }

            .header {
                background: linear-gradient(135deg, #1877f2 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }

            .header h1 {
                font-size: 28px;
                margin-bottom: 10px;
            }

            .content {
                padding: 30px;
            }

            .controls {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .controls input,
            .controls select {
                flex: 1;
                min-width: 150px;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                font-size: 14px;
            }

            button {
                padding: 12px 24px;
                font-size: 16px;
                font-weight: 600;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .btn-primary {
                background: linear-gradient(135deg, #1877f2 0%, #764ba2 100%);
                color: white;
                flex: 1;
                min-width: 150px;
                justify-content: center;
            }

            .btn-primary:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 5px 20px rgba(24, 119, 242, 0.4);
            }

            .btn-primary:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .status {
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                display: none;
            }

            .status.show {
                display: block;
            }

            .status.loading {
                background: #fff3cd;
                color: #856404;
                border-left: 4px solid #ffc107;
            }

            .status.success {
                background: #d4edda;
                color: #155724;
                border-left: 4px solid #28a745;
            }

            .status.error {
                background: #f8d7da;
                color: #721c24;
                border-left: 4px solid #dc3545;
            }

            .spinner {
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #1877f2;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .video-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .video-card {
                background: #f9fafb;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                overflow: hidden;
                transition: all 0.3s;
                cursor: pointer;
            }

            .video-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
                border-color: #1877f2;
            }

            .video-thumbnail {
                width: 100%;
                height: 180px;
                object-fit: cover;
                background: linear-gradient(135deg, #f0f0f0 0%, #e5e7eb 100%);
                transition: opacity 0.3s ease;
            }

            .video-thumbnail.loading {
                opacity: 0.6;
                animation: pulse 1.5s ease-in-out infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 0.6;
                }
                50% {
                    opacity: 0.8;
                }
            }

            .video-info {
                padding: 15px;
            }

            .video-title {
                font-weight: 600;
                color: #333;
                margin-bottom: 8px;
                font-size: 15px;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .video-meta {
                font-size: 13px;
                color: #6b7280;
                margin-bottom: 5px;
            }

            .video-status {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                margin-top: 8px;
            }

            .status-live {
                background: #fee2e2;
                color: #991b1b;
            }

            .status-ended {
                background: #e5e7eb;
                color: #4b5563;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #6c757d;
            }

            .empty-state svg {
                width: 80px;
                height: 80px;
                margin-bottom: 20px;
                opacity: 0.5;
            }

            .stats {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .stat-card {
                flex: 1;
                min-width: 150px;
                background: #f0f9ff;
                border: 2px solid #3b82f6;
                border-radius: 8px;
                padding: 15px;
                text-align: center;
            }

            .stat-number {
                font-size: 32px;
                font-weight: 700;
                color: #1e40af;
                margin-bottom: 5px;
            }

            .stat-label {
                font-size: 13px;
                color: #6b7280;
            }

            @media (max-width: 768px) {
                .video-grid {
                    grid-template-columns: 1fr;
                }
            }

            /* Comments Modal */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 1000;
                overflow-y: auto;
            }

            .modal.show {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            .modal-content {
                background: white;
                border-radius: 15px;
                max-width: 800px;
                width: 100%;
                max-height: 90vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .modal-header {
                background: linear-gradient(135deg, #1877f2 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-header h2 {
                font-size: 18px;
                margin: 0;
            }

            .close-modal {
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                font-size: 24px;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                cursor: pointer;
                transition: all 0.3s;
            }

            .close-modal:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .comments-container {
                padding: 20px;
                overflow-y: auto;
                flex: 1;
            }

            .comment-item {
                display: flex;
                gap: 12px;
                padding: 15px;
                border-bottom: 1px solid #e5e7eb;
                transition: all 0.3s;
            }

            .comment-item:hover {
                background: #f9fafb;
            }

            .comment-item.new-comment {
                background: #dbeafe;
                border-left: 4px solid #1877f2;
                animation: slideIn 0.5s ease-out;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateX(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .comment-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: linear-gradient(135deg, #1877f2, #764ba2);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 700;
                flex-shrink: 0;
            }

            .comment-content {
                flex: 1;
            }

            .comment-header {
                display: flex;
                justify-content: space-between;
                align-items: start;
                margin-bottom: 5px;
            }

            .comment-author {
                font-weight: 600;
                color: #333;
                font-size: 15px;
            }

            .comment-number {
                background: #e5e7eb;
                color: #6b7280;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
            }

            .comment-message {
                color: #4b5563;
                line-height: 1.5;
                margin-bottom: 5px;
                word-wrap: break-word;
            }

            .comment-time {
                color: #9ca3af;
                font-size: 12px;
            }

            .loading-comments {
                text-align: center;
                padding: 40px;
                color: #6b7280;
            }

            .auto-refresh-badge {
                display: inline-flex;
                align-items: center;
                gap: 5px;
                background: rgba(255, 255, 255, 0.2);
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .auto-refresh-badge:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .auto-refresh-badge.paused .pulse-dot {
                background: #ef4444;
                animation: none;
            }

            .pulse-dot {
                width: 8px;
                height: 8px;
                background: #10b981;
                border-radius: 50%;
                animation: pulse 2s ease-in-out infinite;
            }

            .new-comments-badge {
                position: absolute;
                top: 10px;
                right: 10px;
                background: #10b981;
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 13px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
                animation: bounce 0.5s ease-out;
                z-index: 10;
            }

            @keyframes bounce {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.1);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>🎥 Facebook Live Video</h1>
                <p>Xem danh sách live video từ Facebook Page</p>
            </div>

            <div class="content">
                <div class="controls">
                    <input
                        type="text"
                        id="pageId"
                        placeholder="Facebook Page ID"
                        value="117267091364524"
                    />
                    <input
                        type="number"
                        id="limit"
                        placeholder="Limit"
                        value="10"
                        min="1"
                        max="50"
                    />
                    <button class="btn-primary" onclick="loadVideos()">
                        <span id="btnText">🔄 Tải Video</span>
                        <div
                            class="spinner"
                            id="spinner"
                            style="display: none"
                        ></div>
                    </button>
                </div>

                <div id="status" class="status"></div>

                <div id="stats" class="stats" style="display: none"></div>

                <div id="videoContainer">
                    <div class="empty-state">
                        <svg
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                            ></path>
                        </svg>
                        <p>Nhấn "Tải Video" để xem danh sách</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Modal -->
        <div id="commentsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h2 id="modalTitle">💬 Comments</h2>
                        <div
                            class="auto-refresh-badge"
                            id="autoRefreshBadge"
                            onclick="toggleAutoRefresh()"
                        >
                            <div class="pulse-dot"></div>
                            <span id="refreshStatus">Auto 10s</span>
                        </div>
                    </div>
                    <button class="close-modal" onclick="closeComments()">
                        ×
                    </button>
                </div>
                <div class="comments-container" id="commentsContainer">
                    <div class="loading-comments">
                        <div
                            class="spinner"
                            style="margin: 0 auto 10px; display: inline-block"
                        ></div>
                        <p>Đang tải comments...</p>
                    </div>
                </div>
                <div
                    id="newCommentsBadge"
                    class="new-comments-badge"
                    style="display: none"
                ></div>
            </div>
        </div>

        <script>
            let refreshInterval = null;
            let currentPostId = null;
            let currentVideoTitle = null;
            let previousCommentIds = new Set();
            let newCommentsCount = 0;
            let isPaused = false;

            async function loadVideos() {
                const pageId =
                    document.getElementById("pageId").value ||
                    "117267091364524";
                const limit = document.getElementById("limit").value || 10;

                const btnText = document.getElementById("btnText");
                const spinner = document.getElementById("spinner");
                const status = document.getElementById("status");
                const videoContainer =
                    document.getElementById("videoContainer");
                const statsContainer = document.getElementById("stats");

                // Show loading
                btnText.textContent = "Đang tải...";
                spinner.style.display = "block";
                status.className = "status loading show";
                status.textContent = "⏳ Đang lấy dữ liệu từ Facebook...";

                try {
                    const response = await fetch(
                        `/facebook/livevideo?pageid=${pageId}&limit=${limit}`,
                    );
                    const result = await response.json();

                    if (result.success && result.data) {
                        const videos = result.data.data || [];

                        // Show success status
                        status.className = "status success show";
                        status.textContent = `✅ Tải thành công ${videos.length} video`;

                        // Show stats
                        const liveCount = videos.filter(
                            (v) => v.statusLive === 1,
                        ).length;
                        const totalComments = videos.reduce(
                            (sum, v) => sum + (v.countComment || 0),
                            0,
                        );
                        const totalReactions = videos.reduce(
                            (sum, v) => sum + (v.countReaction || 0),
                            0,
                        );

                        statsContainer.style.display = "flex";
                        statsContainer.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${videos.length}</div>
                            <div class="stat-label">Tổng Video</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${liveCount}</div>
                            <div class="stat-label">Đang Live</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalComments.toLocaleString()}</div>
                            <div class="stat-label">Tổng Comments</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalReactions.toLocaleString()}</div>
                            <div class="stat-label">Tổng Reactions</div>
                        </div>
                    `;

                        // Display videos
                        if (videos.length > 0) {
                            displayVideos(videos);
                        } else {
                            videoContainer.innerHTML = `
                            <div class="empty-state">
                                <p>Không tìm thấy video nào</p>
                            </div>
                        `;
                        }
                    } else {
                        status.className = "status error show";
                        status.textContent =
                            "❌ Lỗi: " +
                            (result.error || "Không thể tải dữ liệu");
                    }
                } catch (error) {
                    status.className = "status error show";
                    status.textContent = "❌ Lỗi kết nối: " + error.message;
                    videoContainer.innerHTML = `
                    <div class="empty-state">
                        <p>❌ Lỗi: ${error.message}</p>
                    </div>
                `;
                } finally {
                    btnText.textContent = "🔄 Tải Video";
                    spinner.style.display = "none";
                }
            }

            function displayVideos(videos) {
                const container = document.getElementById("videoContainer");

                // SVG placeholder base64 - không cần external request
                const placeholderSVG =
                    "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgZmlsbD0iI2U1ZTdlYiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM2YjcyODAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5OHIEtow7RuZyBjw7MgYeG6o25oPC90ZXh0Pjwvc3ZnPg==";

                const html = `
                <div class="video-grid">
                    ${videos
                        .map(
                            (video) => `
                        <div class="video-card" onclick="showComments('${video.objectId}', '${escapeHtml(video.title)}')">
                            <img 
                                src="${video.thumbnail?.url || placeholderSVG}" 
                                alt="${video.title || "No title"}"
                                class="video-thumbnail"
                                onerror="if(this.src!=='${placeholderSVG}')this.src='${placeholderSVG}'"
                                onload="this.classList.remove('loading')"
                                loading="lazy"
                            />
                            <div class="video-info">
                                <div class="video-title">${video.title || "Không có tiêu đề"}</div>
                                <div class="video-meta">
                                    💬 ${(video.countComment || 0).toLocaleString()} comment · 
                                    ❤️ ${(video.countReaction || 0).toLocaleString()} reaction
                                </div>
                                <div class="video-meta">
                                    📅 ${video.channelCreatedTime ? new Date(video.channelCreatedTime).toLocaleString("vi-VN") : "N/A"}
                                </div>
                                <span class="video-status ${video.statusLive === 1 ? "status-live" : "status-ended"}">
                                    ${video.statusLive === 1 ? "🔴 ĐANG LIVE" : "⚫ Đã kết thúc"}
                                </span>
                            </div>
                        </div>
                    `,
                        )
                        .join("")}
                </div>
            `;

                container.innerHTML = html;
            }

            // Auto load on page load
            window.onload = () => {
                loadVideos();
            };

            // Helper function to escape HTML
            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML.replace(/'/g, "&#39;");
            }

            // Show comments modal
            function showComments(postId, title) {
                currentPostId = postId;
                currentVideoTitle = title;
                previousCommentIds.clear();
                newCommentsCount = 0;

                const modal = document.getElementById("commentsModal");
                const modalTitle = document.getElementById("modalTitle");
                const badge = document.getElementById("newCommentsBadge");

                modalTitle.textContent = `💬 ${title}`;
                modal.classList.add("show");
                badge.style.display = "none";

                loadComments();

                // Auto-refresh every 10 seconds (tăng từ 5s → 10s để giảm spam)
                if (refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(() => {
                    // Chỉ refresh nếu: tab active + modal mở + KHÔNG bị pause
                    if (
                        !document.hidden &&
                        modal.classList.contains("show") &&
                        !isPaused
                    ) {
                        loadComments();
                    }
                }, 10000); // 10 giây thay vì 5 giây
            }

            // Close comments modal
            function closeComments() {
                const modal = document.getElementById("commentsModal");
                modal.classList.remove("show");

                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }

                currentPostId = null;
                currentVideoTitle = null;
                previousCommentIds.clear();
                newCommentsCount = 0;
                isPaused = false;

                const badge = document.getElementById("newCommentsBadge");
                badge.style.display = "none";
            }

            // Toggle auto-refresh
            function toggleAutoRefresh() {
                isPaused = !isPaused;
                const badge = document.getElementById("autoRefreshBadge");
                const status = document.getElementById("refreshStatus");

                if (isPaused) {
                    badge.classList.add("paused");
                    status.textContent = "⏸️ Paused";
                    console.log("⏸️ Auto-refresh paused by user");
                } else {
                    badge.classList.remove("paused");
                    status.textContent = "Auto 10s";
                    console.log("▶️ Auto-refresh resumed by user");
                    // Load ngay khi resume
                    loadComments();
                }
            }

            // Load comments
            async function loadComments() {
                if (!currentPostId) return;

                const container = document.getElementById("commentsContainer");

                try {
                    const pageId =
                        document.getElementById("pageId").value ||
                        "117267091364524";
                    const response = await fetch(
                        `/facebook/comments?pageid=${pageId}&postId=${currentPostId}&limit=50`,
                    );
                    const result = await response.json();

                    if (result.success && result.data?.data) {
                        displayComments(result.data.data);
                    } else {
                        container.innerHTML =
                            '<div class="loading-comments"><p>Không có comment nào</p></div>';
                    }
                } catch (error) {
                    console.error("Error loading comments:", error);
                    container.innerHTML = `<div class="loading-comments"><p>❌ Lỗi: ${error.message}</p></div>`;
                }
            }

            // Display comments
            function displayComments(comments) {
                const container = document.getElementById("commentsContainer");
                const badge = document.getElementById("newCommentsBadge");

                if (comments.length === 0) {
                    container.innerHTML =
                        '<div class="loading-comments"><p>Chưa có comment nào</p></div>';
                    return;
                }

                // Detect new comments
                const currentCommentIds = new Set(comments.map((c) => c.id));
                const newComments = new Set();

                if (previousCommentIds.size > 0) {
                    currentCommentIds.forEach((id) => {
                        if (!previousCommentIds.has(id)) {
                            newComments.add(id);
                            newCommentsCount++;
                        }
                    });

                    // Show badge if there are new comments
                    if (newComments.size > 0) {
                        badge.textContent = `🔔 ${newComments.size} comment mới!`;
                        badge.style.display = "block";

                        // Hide badge after 3 seconds
                        setTimeout(() => {
                            badge.style.display = "none";
                        }, 3000);
                    }
                }

                // Update previous comment IDs
                previousCommentIds = currentCommentIds;

                const html = comments
                    .map((comment, index) => {
                        const initial = comment.from?.name?.charAt(0) || "?";
                        const time = new Date(
                            comment.created_time,
                        ).toLocaleString("vi-VN");
                        const isNew = newComments.has(comment.id);

                        return `
                    <div class="comment-item ${isNew ? "new-comment" : ""}">
                        <div class="comment-avatar">${initial}</div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <div class="comment-author">
                                    ${comment.from?.name || "Unknown"}
                                    ${isNew ? '<span style="color: #10b981; font-size: 12px; margin-left: 5px;">✨ MỚI</span>' : ""}
                                </div>
                                <div class="comment-number">#${index + 1}</div>
                            </div>
                            <div class="comment-message">${comment.message || ""}</div>
                            <div class="comment-time">📅 ${time}</div>
                        </div>
                    </div>
                `;
                    })
                    .join("");

                container.innerHTML = html;

                // Scroll to top if there are new comments
                if (newComments.size > 0) {
                    container.scrollTop = 0;
                }
            }

            // Close modal when clicking outside
            document
                .getElementById("commentsModal")
                .addEventListener("click", function (e) {
                    if (e.target === this) {
                        closeComments();
                    }
                });

            // Pause refresh when tab is hidden (giảm spam)
            document.addEventListener("visibilitychange", function () {
                if (document.hidden) {
                    console.log("⏸️ Tab hidden - Paused auto-refresh");
                } else {
                    console.log("▶️ Tab visible - Resumed auto-refresh");
                    // Load ngay khi tab active trở lại
                    if (
                        currentPostId &&
                        document
                            .getElementById("commentsModal")
                            .classList.contains("show")
                    ) {
                        loadComments();
                    }
                }
            });
        </script>
    </body>
</html>
