<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Hệ Thống Quản Lý - N2Shop</title>

        <!-- External CSS -->
        <link rel="stylesheet" href="modern.css" />

        <!-- N2Store Optimization: Core Utilities Loader -->
        <script src="../js/core-loader.js"></script>

        <!-- Navigation Manager - Load trước khi load page scripts -->
        <script src="../js/navigation-modern.js"></script>
        <script src="../js/common-utils.js"></script>

        <!-- Lucide Icons -->
        <script src="https://unpkg.com/lucide@latest"></script>

        <style>
            /* Tab Navigation */
            .tab-navigation {
                background: white;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .tab-nav-content {
                display: flex;
                gap: 0;
                padding: 0 var(--spacing-xl);
            }

            .tab-button {
                padding: 16px 24px;
                background: none;
                border: none;
                color: var(--text-secondary);
                font-size: 15px;
                font-weight: 500;
                cursor: pointer;
                position: relative;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .tab-button:hover {
                color: var(--primary);
                background: var(--gray-50);
            }

            .tab-button.active {
                color: var(--primary);
            }

            .tab-button.active::after {
                content: "";
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                border-radius: 3px 3px 0 0;
            }

            .tab-icon {
                width: 18px;
                height: 18px;
            }

            /* Tab Content */
            .tab-content {
                display: none;
                animation: fadeIn 0.3s ease-in-out;
            }

            .tab-content.active {
                display: block;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* iframe */
            iframe {
                width: 100%;
                height: calc(100vh - 65px);
                border: none;
                background: white;
            }

            /* Sync indicator */
            .sync-indicator {
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                display: none;
                align-items: center;
                gap: 8px;
                font-size: 13px;
                color: var(--success);
                z-index: 1000;
            }

            .sync-indicator.show {
                display: flex;
                animation: slideIn 0.3s ease-out;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            .sync-icon {
                width: 16px;
                height: 16px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i data-lucide="zap"></i>
                    <span>N2Shop</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i data-lucide="panel-left-close"></i>
                </button>
            </div>

            <nav class="sidebar-nav" id="sidebarNav">
                <!-- Menu items auto-generated by navigation-modern.js -->
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <i data-lucide="user-circle"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role">Quản trị viên</div>
                    </div>
                </div>
                <button class="btn-logout" id="btnLogout">
                    <i data-lucide="log-out"></i>
                    <span>Đăng xuất</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <div class="tab-nav-content">
                    <button
                        class="tab-button active"
                        onclick="switchTab('orders')"
                        data-tab="orders"
                    >
                        <i data-lucide="shopping-cart" class="tab-icon"></i>
                        Quản Lý Đơn Hàng
                    </button>
                    <button
                        class="tab-button"
                        onclick="switchTab('statistics')"
                        data-tab="statistics"
                    >
                        <i data-lucide="bar-chart-3" class="tab-icon"></i>
                        Thống Kê
                    </button>
                    <button
                        class="tab-button"
                        onclick="switchTab('upload')"
                        data-tab="upload"
                    >
                        <i data-lucide="upload" class="tab-icon"></i>
                        Upload Đơn Hàng Lên TPOS
                    </button>
                    <button
                        class="tab-button"
                        onclick="switchTab('product-assignment')"
                        data-tab="product-assignment"
                    >
                        <i data-lucide="link" class="tab-icon"></i>
                        Gán Sản Phẩm - STT
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div id="ordersTab" class="tab-content active">
                <iframe id="ordersFrame" src="tab1-orders.html"></iframe>
            </div>

            <div id="statisticsTab" class="tab-content">
                <iframe
                    id="statisticsFrame"
                    src="tab2-statistics.html"
                ></iframe>
            </div>

            <div id="uploadTab" class="tab-content">
                <iframe
                    id="uploadFrame"
                    src="tab-upload-tpos.html"
                ></iframe>
            </div>

            <div id="productAssignmentTab" class="tab-content">
                <iframe
                    id="productAssignmentFrame"
                    src="tab3-product-assignment.html"
                ></iframe>
            </div>
        </main>

        <!-- Sync Indicator -->
        <div class="sync-indicator" id="syncIndicator">
            <i data-lucide="refresh-cw" class="sync-icon"></i>
            <span>Đang đồng bộ dữ liệu...</span>
        </div>

        <!-- Scripts -->
        <script src="auth.js"></script>
        <script src="cache.js"></script>
        <script src="notification-system.js"></script>
        <script src="token-manager.js"></script>

        <script>
            // Initialize Lucide icons
            lucide.createIcons();

            // Tab switching
            function switchTab(tabName) {
                // Save current tab to localStorage
                localStorage.setItem("currentTab", tabName);

                // Update tab buttons
                document.querySelectorAll(".tab-button").forEach((btn) => {
                    btn.classList.remove("active");
                });
                document
                    .querySelector(`[data-tab="${tabName}"]`)
                    .classList.add("active");

                // Update tab content
                document.querySelectorAll(".tab-content").forEach((content) => {
                    content.classList.remove("active");
                });

                if (tabName === "orders") {
                    document
                        .getElementById("ordersTab")
                        .classList.add("active");
                } else if (tabName === "statistics") {
                    document
                        .getElementById("statisticsTab")
                        .classList.add("active");
                    // Trigger statistics refresh when switching to it
                    refreshStatistics();
                } else if (tabName === "upload") {
                    document
                        .getElementById("uploadTab")
                        .classList.add("active");
                } else if (tabName === "product-assignment") {
                    document
                        .getElementById("productAssignmentTab")
                        .classList.add("active");
                    // Send orders data to product assignment tab
                    const ordersFrame = document.getElementById("ordersFrame");
                    if (ordersFrame && ordersFrame.contentWindow) {
                        // Request orders data from tab1
                        ordersFrame.contentWindow.postMessage(
                            { type: "REQUEST_ORDERS_DATA" },
                            "*"
                        );
                    }
                }

                // Reinitialize icons after DOM change
                setTimeout(() => lucide.createIcons(), 100);
            }

            // Listen for filter changes from Tab 1
            window.addEventListener("storage", function (e) {
                if (e.key === "tab1_filter_data") {
                    showSyncIndicator();
                    // Notify Tab 2 about data change
                    const statisticsFrame =
                        document.getElementById("statisticsFrame");
                    if (statisticsFrame && statisticsFrame.contentWindow) {
                        statisticsFrame.contentWindow.postMessage(
                            {
                                type: "FILTER_UPDATE",
                                data: JSON.parse(e.newValue),
                            },
                            "*",
                        );
                    }
                }
            });

            // Listen for messages from iframes
            window.addEventListener("message", function (e) {
                if (e.data.type === "FILTER_CHANGED") {
                    // Tab 1 filter changed
                    localStorage.setItem(
                        "tab1_filter_data",
                        JSON.stringify(e.data.filter),
                    );
                    showSyncIndicator();
                } else if (e.data.type === "REQUEST_FILTER_DATA") {
                    // Tab 2 requesting current filter data
                    const filterData = localStorage.getItem("tab1_filter_data");
                    if (filterData) {
                        e.source.postMessage(
                            {
                                type: "FILTER_DATA",
                                data: JSON.parse(filterData),
                            },
                            "*",
                        );
                    }
                } else if (e.data.type === "SWITCH_TO_TAB1") {
                    // Switch to orders tab
                    switchTab("orders");
                } else if (e.data.type === "REQUEST_ORDERS_DATA_FROM_TAB3") {
                    // Tab 3 requesting orders data
                    const ordersFrame = document.getElementById("ordersFrame");
                    if (ordersFrame && ordersFrame.contentWindow) {
                        // Request orders data from tab1
                        ordersFrame.contentWindow.postMessage(
                            { type: "REQUEST_ORDERS_DATA" },
                            "*"
                        );
                    }
                }
            });

            function refreshStatistics() {
                const statisticsFrame =
                    document.getElementById("statisticsFrame");
                if (statisticsFrame && statisticsFrame.contentWindow) {
                    const filterData = localStorage.getItem("tab1_filter_data");
                    if (filterData) {
                        statisticsFrame.contentWindow.postMessage(
                            {
                                type: "REFRESH_DATA",
                                data: JSON.parse(filterData),
                            },
                            "*",
                        );
                    }
                }
            }

            function showSyncIndicator() {
                const indicator = document.getElementById("syncIndicator");
                indicator.classList.add("show");
                setTimeout(() => {
                    indicator.classList.remove("show");
                }, 2000);
            }

            // Logout handler
            document
                .getElementById("btnLogout")
                .addEventListener("click", function () {
                    if (confirm("Bạn có chắc muốn đăng xuất?")) {
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = "../index.html";
                    }
                });

            // Load user info
            window.addEventListener("DOMContentLoaded", function () {
                try {
                    const authData =
                        sessionStorage.getItem("loginindex_auth") ||
                        localStorage.getItem("loginindex_auth");
                    if (authData) {
                        const auth = JSON.parse(authData);
                        if (auth.userType) {
                            document.getElementById("userName").textContent =
                                auth.userType.split("-")[0];
                        }
                    }
                } catch (error) {
                    console.error("Error loading user info:", error);
                }

                // Restore last active tab or default to orders
                const savedTab = localStorage.getItem("currentTab");
                if (savedTab && ["orders", "statistics", "upload", "product-assignment"].includes(savedTab)) {
                    switchTab(savedTab);
                } else {
                    switchTab("orders");
                }

                // Reinitialize icons after everything loads
                setTimeout(() => lucide.createIcons(), 200);
            });
        </script>
    </body>
</html>
