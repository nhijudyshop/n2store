<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <title>Thống Kê Đơn Hàng - N2Shop</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- External CSS -->
        <link rel="stylesheet" href="modern.css" />

        <!-- Lucide Icons -->
        <script src="https://unpkg.com/lucide@latest"></script>

        <!-- XLSX Library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

        <!-- Firebase -->
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

        <style>
            :root {
                --primary: #6366f1;
                --primary-light: #818cf8;
                --success: #10b981;
                --danger: #ef4444;
                --warning: #f59e0b;
                --info: #3b82f6;
                --gray-50: #f9fafb;
                --gray-100: #f3f4f6;
                --gray-200: #e5e7eb;
                --gray-300: #d1d5db;
                --gray-600: #4b5563;
                --gray-700: #374151;
                --gray-800: #1f2937;
                --gray-900: #111827;
            }

            .content-wrapper {
                padding: 24px;
                max-width: 1400px;
                margin: 0 auto;
            }

            .filter-section {
                background: white;
                border-radius: 12px;
                padding: 24px;
                margin-bottom: 24px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .filter-row {
                display: grid;
                grid-template-columns: 0.8fr 1.2fr 1fr 1fr auto;
                gap: 16px;
                align-items: end;
            }

            .form-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .form-group label {
                font-size: 14px;
                font-weight: 500;
                color: var(--gray-700);
            }

            .form-control {
                padding: 10px 14px;
                border: 1px solid var(--gray-300);
                border-radius: 8px;
                font-size: 14px;
                transition: all 0.2s;
            }

            .form-control:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            }

            select.form-control {
                background: white;
                cursor: pointer;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 10px center;
                background-size: 16px;
                padding-right: 36px;
                appearance: none;
            }

            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn-primary {
                background: var(--primary);
                color: white;
            }

            .btn-primary:hover {
                background: var(--primary-light);
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            }

            .tables-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 24px;
                margin-top: 24px;
            }

            .table-card {
                background: white;
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .table-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                padding-bottom: 16px;
                border-bottom: 2px solid var(--gray-100);
            }

            .table-title {
                font-size: 18px;
                font-weight: 600;
                color: var(--gray-800);
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .table-count {
                font-size: 14px;
                color: var(--gray-600);
                background: var(--gray-100);
                padding: 4px 12px;
                border-radius: 20px;
            }

            .data-table {
                width: 100%;
                border-collapse: collapse;
            }

            .data-table thead th {
                text-align: left;
                padding: 12px;
                font-size: 13px;
                font-weight: 600;
                color: var(--gray-600);
                background: var(--gray-50);
                border-bottom: 2px solid var(--gray-200);
            }

            .data-table tbody td {
                padding: 12px;
                font-size: 14px;
                border-bottom: 1px solid var(--gray-100);
            }

            .data-table tbody tr:hover {
                background: var(--gray-50);
            }

            .status-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
            }

            .status-thanh-cong {
                background: #d1fae5;
                color: #065f46;
            }

            .status-gio-trong {
                background: #fee2e2;
                color: #991b1b;
            }

            .status-xu-ly {
                background: #dbeafe;
                color: #1e40af;
            }

            .status-default {
                background: var(--gray-100);
                color: var(--gray-700);
            }

            .count-badge {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 32px;
                height: 32px;
                background: var(--primary);
                color: white;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                padding: 0 8px;
            }

            .empty-state {
                text-align: center;
                padding: 48px 24px;
                color: var(--gray-600);
            }

            .empty-state i {
                width: 64px;
                height: 64px;
                color: var(--gray-400);
                margin-bottom: 16px;
            }

            .empty-state-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 8px;
            }

            .empty-state-description {
                font-size: 14px;
                color: var(--gray-500);
            }

            @media (max-width: 1200px) {
                .tables-container {
                    grid-template-columns: 1fr;
                }
            }

            @media (max-width: 768px) {
                .filter-row {
                    grid-template-columns: 1fr;
                }
            }

            /* Token Info Badge */
            .token-info {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
                z-index: 1000;
            }

            .token-info.valid {
                border-left: 4px solid var(--success);
            }

            .token-info.invalid {
                border-left: 4px solid var(--danger);
            }

            .token-info i {
                width: 16px;
                height: 16px;
            }

            .token-refresh-btn {
                padding: 4px 8px;
                border: 1px solid var(--gray-300);
                border-radius: 4px;
                background: white;
                cursor: pointer;
                font-size: 11px;
                display: flex;
                align-items: center;
                gap: 4px;
                transition: all 0.2s;
            }

            .token-refresh-btn:hover {
                background: var(--gray-50);
                border-color: var(--primary);
            }

            .token-refresh-btn i {
                width: 12px;
                height: 12px;
            }
        </style>
    </head>

    <body data-page="orders-report">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i data-lucide="zap"></i>
                    <span>N2Shop</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i data-lucide="panel-left-close"></i>
                </button>
            </div>

            <nav class="sidebar-nav" id="sidebarNav">
                <!-- Menu items auto-generated by navigation-modern.js -->
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <i data-lucide="user-circle"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role">Quản trị viên</div>
                    </div>
                </div>
                <button class="btn-permissions" id="btnPermissions">
                    <i data-lucide="shield-check"></i>
                    <span>Xem Quyền Của Tôi</span>
                </button>
                <button class="btn-logout" id="btnLogout">
                    <i data-lucide="log-out"></i>
                    <span>Đăng xuất</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="btn-icon" id="sidebarToggle">
                        <i data-lucide="menu"></i>
                    </button>
                    <div class="breadcrumb">
                        <i data-lucide="shopping-cart"></i>
                        <span>Báo Cáo Sale-Online</span>
                    </div>
                </div>
                <div class="top-bar-right">
                    <button class="btn btn-primary" id="exportExcelBtn">
                        <i data-lucide="download"></i>
                        <span>Xuất Excel</span>
                    </button>
                </div>
            </header>

            <div class="content-wrapper">
                <!-- Filter Section -->
                <div class="filter-section">
                    <!-- Bearer Token Section - HIDDEN (Auto-managed by token-manager.js) -->
                    <div
                        class="form-group"
                        style="margin-bottom: 16px; display: none"
                    >
                        <label for="bearerToken">
                            Bearer Token
                            <span
                                style="
                                    color: var(--danger);
                                    font-size: 12px;
                                    margin-left: 4px;
                                "
                                >*</span
                            >
                        </label>
                        <div style="position: relative">
                            <input
                                type="password"
                                id="bearerToken"
                                class="form-control"
                                placeholder="Nhập Bearer token..."
                                style="
                                    font-family: monospace;
                                    padding-right: 45px;
                                "
                            />
                            <button
                                type="button"
                                id="toggleTokenBtn"
                                class="btn-icon"
                                style="
                                    position: absolute;
                                    right: 8px;
                                    top: 50%;
                                    transform: translateY(-50%);
                                    border: none;
                                    background: transparent;
                                    cursor: pointer;
                                    padding: 4px;
                                "
                                title="Hiển thị/Ẩn token"
                            >
                                <i
                                    data-lucide="eye"
                                    style="width: 18px; height: 18px"
                                ></i>
                            </button>
                        </div>
                        <small
                            style="
                                color: var(--gray-600);
                                font-size: 12px;
                                margin-top: 4px;
                                display: block;
                            "
                        >
                            Token sẽ được lưu tự động vào bộ nhớ máy
                        </small>
                        <small
                            style="
                                color: var(--warning);
                                font-size: 12px;
                                margin-top: 4px;
                                display: block;
                            "
                        >
                            ⚠️ Lưu ý: Nếu gặp lỗi CORS, vui lòng mở trang từ
                            https://tomato.tpos.vn hoặc cài đặt extension CORS
                            Unblock
                        </small>
                    </div>
                    <div class="filter-row">
                        <div class="form-group">
                            <label for="userFilter">Lọc theo User</label>
                            <select id="userFilter" class="form-control">
                                <option value="all">Tất cả</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="facebookPostId">Facebook Post ID</label>
                            <div style="display: flex; gap: 8px">
                                <input
                                    type="text"
                                    id="facebookPostId"
                                    class="form-control"
                                    value="270136663390370_1363806618461599"
                                    placeholder="Nhập Facebook Post ID"
                                    style="flex: 1"
                                />
                                <button
                                    type="button"
                                    id="openPageSelectorBtn"
                                    class="btn btn-primary"
                                    style="
                                        white-space: nowrap;
                                        padding: 10px 16px;
                                    "
                                    title="Chọn từ Livestream Facebook"
                                >
                                    <i
                                        data-lucide="video"
                                        style="width: 18px; height: 18px"
                                    ></i>
                                    <span style="display: none">Chọn</span>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="startDate">Từ ngày</label>
                            <input
                                type="date"
                                id="startDate"
                                class="form-control"
                            />
                        </div>
                        <div class="form-group">
                            <label for="endDate">Đến ngày</label>
                            <input
                                type="date"
                                id="endDate"
                                class="form-control"
                            />
                        </div>
                        <button class="btn btn-primary" id="fetchDataBtn">
                            <i data-lucide="search"></i>
                            <span>Tìm kiếm</span>
                        </button>
                    </div>
                </div>

                <!-- Tables Container -->
                <div class="tables-container">
                    <!-- Left Table: Status Statistics -->
                    <div class="table-card">
                        <div class="table-header">
                            <h3 class="table-title">
                                <i data-lucide="bar-chart-3"></i>
                                <span id="statsTableTitle"
                                    >Thống Kê Theo Trạng Thái</span
                                >
                            </h3>
                            <span class="table-count" id="totalOrders"
                                >0 đơn</span
                            >
                        </div>
                        <div class="table-wrapper" id="statusTableWrapper">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Đang tải dữ liệu...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Table: Customer Details -->
                    <div class="table-card">
                        <div class="table-header">
                            <div
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 12px;
                                "
                            >
                                <h3 class="table-title">
                                    <i data-lucide="users"></i>
                                    Chi Tiết Đơn Hàng
                                </h3>
                                <div id="filterBadge" style="display: none">
                                    <span
                                        class="status-badge"
                                        style="
                                            background: var(--primary);
                                            color: white;
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                        "
                                    >
                                        <span id="filterBadgeText"></span>
                                        <button
                                            id="clearFilterBtn"
                                            style="
                                                background: none;
                                                border: none;
                                                cursor: pointer;
                                                padding: 0;
                                                display: flex;
                                                align-items: center;
                                            "
                                        >
                                            <i
                                                data-lucide="x"
                                                style="
                                                    width: 14px;
                                                    height: 14px;
                                                    color: white;
                                                "
                                            ></i>
                                        </button>
                                    </span>
                                </div>
                            </div>
                            <span class="table-count" id="totalCustomers"
                                >0 đơn</span
                            >
                        </div>
                        <div class="table-wrapper" id="customerTableWrapper">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Đang tải dữ liệu...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Token Info Badge (Optional Display) -->
        <div id="tokenInfoBadge" class="token-info" style="display: none">
            <i data-lucide="key"></i>
            <span id="tokenInfoText">Checking token...</span>
            <button class="token-refresh-btn" onclick="refreshToken()">
                <i data-lucide="refresh-cw"></i>
                Refresh
            </button>
        </div>

        <!-- JavaScript Files - IMPORTANT: Load in correct order -->
        <script src="config.js"></script>
        <script src="notification-system.js"></script>
        <script src="token-manager.js"></script>
        <script src="cache.js"></script>
        <script src="auth.js"></script>
        <script src="../js/navigation-modern.js"></script>

        <script>
            // Initialize Lucide icons
            lucide.createIcons();

            // Initialize notification manager
            const notificationManager = new NotificationManager();
            window.notificationManager = notificationManager;

            // Global variables
            let allOrdersData = [];

            // Helper Functions
            function setDefaultDates() {
                const today = new Date();
                const startDate = new Date(
                    today.getFullYear(),
                    today.getMonth(),
                    1,
                );

                document.getElementById("startDate").valueAsDate = startDate;
                document.getElementById("endDate").valueAsDate = today;
            }

            function dateToAPIFormat(dateString, isEndOfDay = false) {
                const date = new Date(dateString);
                if (isEndOfDay) {
                    date.setHours(23, 59, 59, 999);
                } else {
                    date.setHours(0, 0, 0, 0);
                }
                return `datetime'${date.toISOString()}'`;
            }

            function generateGUID() {
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
                    /[xy]/g,
                    function (c) {
                        const r = (Math.random() * 16) | 0;
                        const v = c === "x" ? r : (r & 0x3) | 0x8;
                        return v.toString(16);
                    },
                );
            }

            function parseTags(tags) {
                if (!tags) return {};
                const pairs = tags.split(";").filter(Boolean);
                const result = {};
                pairs.forEach((pair) => {
                    const [key, value] = pair.split("=");
                    if (key && value !== undefined) {
                        result[key.trim()] = value.trim();
                    }
                });
                return result;
            }

            function getStatus(tags) {
                if (tags["Giỏ Trống"]) return "Giỏ Trống";
                if (tags["Xử Lý"]) return "Xử Lý";
                if (tags["Thành Công"]) return "Thành Công";
                return "Khác";
            }

            function getStatusClass(status) {
                const statusMap = {
                    "Thành Công": "status-thanh-cong",
                    "Giỏ Trống": "status-gio-trong",
                    "Xử Lý": "status-xu-ly",
                };
                return statusMap[status] || "status-default";
            }

            function showEmptyState(containerId, message) {
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-lucide="inbox"></i>
                        <div class="empty-state-title">${message}</div>
                        <div class="empty-state-description">Không có dữ liệu để hiển thị</div>
                    </div>
                `;
                lucide.createIcons();
            }

            function getFilteredData() {
                const userFilter = document.getElementById("userFilter").value;
                if (userFilter === "all") {
                    return allOrdersData;
                }
                return allOrdersData.filter(
                    (order) => order.UserName === userFilter,
                );
            }

            function populateUserFilter(data) {
                const userSelect = document.getElementById("userFilter");
                const users = [...new Set(data.map((order) => order.UserName))];

                userSelect.innerHTML =
                    '<option value="all">Tất cả User</option>';
                users.sort().forEach((user) => {
                    const option = document.createElement("option");
                    option.value = user;
                    option.textContent = user;
                    userSelect.appendChild(option);
                });
            }

            function updateTableTitle() {
                const userFilter = document.getElementById("userFilter").value;
                const filteredData = getFilteredData();

                document.getElementById("totalOrders").textContent =
                    `${filteredData.length} đơn`;
            }

            function renderStatusTable(data) {
                const statusCount = {};

                data.forEach((order) => {
                    const tags = parseTags(order.Tags);
                    const status = getStatus(tags);
                    statusCount[status] = (statusCount[status] || 0) + 1;
                });

                const statusOrder = [
                    "Thành Công",
                    "Giỏ Trống",
                    "Xử Lý",
                    "Khác",
                ];
                const sortedStatuses = Object.keys(statusCount).sort((a, b) => {
                    return statusOrder.indexOf(a) - statusOrder.indexOf(b);
                });

                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Trạng thái</th>
                                <th style="text-align: center">Số lượng</th>
                                <th style="text-align: right">Tỷ lệ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                const total = data.length;
                sortedStatuses.forEach((status) => {
                    const count = statusCount[status];
                    const percentage = ((count / total) * 100).toFixed(1);
                    html += `
                        <tr>
                            <td><span class="status-badge ${getStatusClass(status)}">${status}</span></td>
                            <td style="text-align: center"><span class="count-badge">${count}</span></td>
                            <td style="text-align: right; font-weight: 600; color: var(--gray-700)">${percentage}%</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                document.getElementById("statusTableWrapper").innerHTML = html;
            }

            function renderCustomerTable(data) {
                const customerMap = {};

                data.forEach((order) => {
                    const key = `${order.Name}_${order.Telephone}`;
                    if (!customerMap[key]) {
                        customerMap[key] = {
                            name: order.Name,
                            telephone: order.Telephone,
                            count: 0,
                            totalAmount: 0,
                        };
                    }
                    customerMap[key].count++;
                    customerMap[key].totalAmount += order.TotalAmount || 0;
                });

                const customers = Object.values(customerMap)
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10);

                document.getElementById("totalCustomers").textContent =
                    `${customers.length} khách hàng`;

                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tên khách hàng</th>
                                <th>Số điện thoại</th>
                                <th style="text-align: center">Số đơn</th>
                                <th style="text-align: right">Tổng tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                customers.forEach((customer) => {
                    html += `
                        <tr>
                            <td style="font-weight: 500">${customer.name}</td>
                            <td>${customer.telephone}</td>
                            <td style="text-align: center"><span class="count-badge">${customer.count}</span></td>
                            <td style="text-align: right; font-weight: 600; color: var(--primary)">${customer.totalAmount.toLocaleString("vi-VN")}đ</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                document.getElementById("customerTableWrapper").innerHTML =
                    html;
            }

            // Main fetch function using TokenManager
            async function fetchData() {
                const postId = document.getElementById("facebookPostId").value.trim();
                const startDate = document.getElementById("startDate").value;
                const endDate = document.getElementById("endDate").value;

                if (!postId) {
                    notificationManager.error("Vui lòng nhập Facebook Post ID");
                    return;
                }

                if (!startDate || !endDate) {
                    notificationManager.error("Vui lòng chọn khoảng thời gian");
                    return;
                }

                const loadingId = notificationManager.loading(
                    "Đang tải dữ liệu...",
                );

                try {
                    // Build API URL
                    const startDateAPI = dateToAPIFormat(startDate, false);
                    const endDateAPI = dateToAPIFormat(endDate, true);

                    const apiUrl = `https://tomato.tpos.vn/odata/SaleOnline_Order/ODataService.GetView?$orderby=DateCreated desc&$filter=(DateCreated ge ${startDateAPI} and DateCreated le ${endDateAPI})&$count=true`;

                    console.log("Fetching from:", apiUrl);

                    // Use TokenManager's authenticatedFetch method
                    const response =
                        await window.tokenManager.authenticatedFetch(apiUrl, {
                            method: "GET",
                            headers: {
                                Accept: "application/json, text/plain, */*",
                                "Accept-Encoding": "gzip, deflate, br",
                                "Accept-Language":
                                    "vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7",
                                Origin: "https://tomato.tpos.vn",
                                Referer: "https://tomato.tpos.vn/",
                                "sec-ch-ua":
                                    '"Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24"',
                                "sec-ch-ua-mobile": "?0",
                                "sec-ch-ua-platform": '"Windows"',
                                "sec-fetch-dest": "empty",
                                "sec-fetch-mode": "cors",
                                "sec-fetch-site": "same-origin",
                                tposappversion: "5.9.10.1",
                                "User-Agent":
                                    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
                                "x-request-id": generateGUID(),
                            },
                            credentials: "include",
                        });

                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error(
                                "Token không hợp lệ hoặc đã hết hạn. Vui lòng kiểm tra lại.",
                            );
                        }
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const result = await response.json();

                    // Filter by Facebook Post ID
                    const filteredData = result.value.filter(
                        (order) => order.Facebook_PostId === postId,
                    );

                    console.log(
                        `Found ${filteredData.length} orders matching Post ID`,
                    );

                    notificationManager.remove(loadingId);

                    if (filteredData.length === 0) {
                        notificationManager.warning(
                            "Không tìm thấy đơn hàng nào",
                        );
                        showEmptyState(
                            "statusTableWrapper",
                            "Không tìm thấy đơn hàng nào",
                        );
                        showEmptyState(
                            "customerTableWrapper",
                            "Không tìm thấy đơn hàng nào",
                        );
                        return;
                    }

                    // Store data globally
                    allOrdersData = filteredData;

                    // Populate user filter
                    populateUserFilter(filteredData);

                    // Render tables
                    updateTableTitle();
                    renderStatusTable(getFilteredData());
                    renderCustomerTable(getFilteredData());

                    notificationManager.success(
                        `Đã tải ${filteredData.length} đơn hàng`,
                    );

                    // Update token info display
                    updateTokenInfoDisplay();
                } catch (error) {
                    console.error("Error fetching data:", error);
                    notificationManager.remove(loadingId);
                    notificationManager.error(
                        "Lỗi khi tải dữ liệu: " + error.message,
                    );
                    showEmptyState("statusTableWrapper", "Lỗi khi tải dữ liệu");
                    showEmptyState(
                        "customerTableWrapper",
                        "Lỗi khi tải dữ liệu",
                    );
                }
            }

            // Export to Excel
            function exportToExcel() {
                if (!allOrdersData || allOrdersData.length === 0) {
                    notificationManager.warning("Không có dữ liệu để xuất");
                    return;
                }

                try {
                    const filteredData = getFilteredData();

                    // Prepare data for export
                    const exportData = filteredData.map((order) => {
                        const tags = parseTags(order.Tags);
                        const status = getStatus(tags);
                        const note = order.Note
                            ? order.Note.replace(/\r\n/g, ", ").replace(
                                  /\n/g,
                                  ", ",
                              )
                            : "";

                        return {
                            "Mã đơn": order.Code,
                            "Tên KH": order.Name,
                            SĐT: order.Telephone,
                            "Địa chỉ": order.Address,
                            "Trạng thái": status,
                            "Lý do": note,
                            "Tổng tiền": order.TotalAmount,
                            "Số lượng": order.TotalQuantity,
                            "Ngày tạo": order.DateCreated,
                            User: order.UserName,
                        };
                    });

                    // Create workbook
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Đơn hàng");

                    // Generate filename
                    const userFilter =
                        document.getElementById("userFilter").value;
                    const filename =
                        userFilter === "all"
                            ? `Don_hang_${new Date().getTime()}.xlsx`
                            : `Don_hang_${userFilter}_${new Date().getTime()}.xlsx`;

                    // Save file
                    XLSX.writeFile(wb, filename);

                    notificationManager.success("Đã xuất Excel thành công");
                } catch (error) {
                    console.error("Error exporting to Excel:", error);
                    notificationManager.error(
                        "Lỗi khi xuất Excel: " + error.message,
                    );
                }
            }

            // Token info display (optional)
            function updateTokenInfoDisplay() {
                const tokenInfo = window.tokenManager.getTokenInfo();
                const badge = document.getElementById("tokenInfoBadge");
                const text = document.getElementById("tokenInfoText");

                if (tokenInfo.hasToken) {
                    badge.className = tokenInfo.isValid
                        ? "token-info valid"
                        : "token-info invalid";
                    text.textContent = tokenInfo.isValid
                        ? `Token hợp lệ - ${tokenInfo.timeRemaining}`
                        : "Token hết hạn";
                    badge.style.display = "flex";
                } else {
                    badge.style.display = "none";
                }

                lucide.createIcons();
            }

            // Manual token refresh
            async function refreshToken() {
                try {
                    await window.tokenManager.refresh();
                    updateTokenInfoDisplay();
                } catch (error) {
                    console.error("Error refreshing token:", error);
                }
            }

            // Event listeners
            document
                .getElementById("fetchDataBtn")
                .addEventListener("click", fetchData);
            document
                .getElementById("exportExcelBtn")
                .addEventListener("click", exportToExcel);

            // User filter change event
            document
                .getElementById("userFilter")
                .addEventListener("change", () => {
                    if (allOrdersData.length > 0) {
                        updateTableTitle();
                        const filteredData = getFilteredData();
                        renderStatusTable(filteredData);
                        renderCustomerTable(filteredData);
                    }
                });

            // Initialize
            setDefaultDates();

            // Show initial empty state
            showEmptyState(
                "statusTableWrapper",
                "Nhập thông tin và nhấn Tìm kiếm",
            );
            showEmptyState(
                "customerTableWrapper",
                "Nhập thông tin và nhấn Tìm kiếm",
            );

            // Initialize token info display
            updateTokenInfoDisplay();

            console.log("✅ Application initialized with Token Manager");
        </script>
    </body>
</html>
