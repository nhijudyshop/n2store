<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <title>Báo Cáo Sale-Online - N2Shop</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- External CSS -->
        <link rel="stylesheet" href="modern.css" />
        <link rel="stylesheet" href="facebook-page-selector.css" />

        <!-- Lucide Icons -->
        <script src="https://unpkg.com/lucide@latest"></script>

        <!-- XLSX Library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

        <!-- Firebase -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

        <!-- Core Scripts -->
        <script src="config.js"></script>
        <script src="notification-system.js"></script>
        <script src="cache.js"></script>
        <script src="auth.js"></script>
        <script src="token-manager.js"></script>
        <script src="facebook-page-selector.js"></script>

        <style>
            :root {
                --primary: #6366f1;
                --primary-light: #818cf8;
                --success: #10b981;
                --danger: #ef4444;
                --warning: #f59e0b;
                --info: #3b82f6;
                --gray-50: #f9fafb;
                --gray-100: #f3f4f6;
                --gray-200: #e5e7eb;
                --gray-300: #d1d5db;
                --gray-600: #4b5563;
                --gray-700: #374151;
                --gray-800: #1f2937;
                --gray-900: #111827;
            }

            .content-wrapper {
                padding: 24px;
                max-width: 1400px;
                margin: 0 auto;
            }

            .filter-section {
                background: white;
                border-radius: 12px;
                padding: 24px;
                margin-bottom: 24px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .filter-row {
                display: grid;
                grid-template-columns: 0.8fr 1.2fr 1fr 1fr auto;
                gap: 16px;
                align-items: end;
            }

            .form-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .form-group label {
                font-size: 14px;
                font-weight: 500;
                color: var(--gray-700);
            }

            .form-control {
                padding: 10px 14px;
                border: 1px solid var(--gray-300);
                border-radius: 8px;
                font-size: 14px;
                transition: all 0.2s;
            }

            .form-control:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            }

            select.form-control {
                background: white;
                cursor: pointer;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 10px center;
                background-size: 16px;
                padding-right: 36px;
                appearance: none;
            }

            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn-primary {
                background: var(--primary);
                color: white;
            }

            .btn-primary:hover {
                background: var(--primary-light);
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            }

            .tables-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 24px;
                margin-top: 24px;
            }

            .table-card {
                background: white;
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .table-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                padding-bottom: 16px;
                border-bottom: 2px solid var(--gray-100);
            }

            .table-title {
                font-size: 18px;
                font-weight: 600;
                color: var(--gray-800);
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .table-count {
                font-size: 14px;
                color: var(--gray-600);
                background: var(--gray-100);
                padding: 4px 12px;
                border-radius: 20px;
            }

            .data-table {
                width: 100%;
                border-collapse: collapse;
            }

            .data-table thead th {
                text-align: left;
                padding: 12px;
                font-size: 13px;
                font-weight: 600;
                color: var(--gray-600);
                background: var(--gray-50);
                border-bottom: 2px solid var(--gray-200);
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .data-table tbody td {
                padding: 12px;
                font-size: 14px;
                border-bottom: 1px solid var(--gray-100);
            }

            .data-table tbody tr:hover {
                background: var(--gray-50);
            }

            .table-wrapper {
                max-height: 600px;
                overflow-y: auto;
                position: relative;
            }

            /* Scrollbar styling */
            .table-wrapper::-webkit-scrollbar {
                width: 8px;
            }

            .table-wrapper::-webkit-scrollbar-track {
                background: var(--gray-100);
                border-radius: 4px;
            }

            .table-wrapper::-webkit-scrollbar-thumb {
                background: var(--gray-400);
                border-radius: 4px;
            }

            .table-wrapper::-webkit-scrollbar-thumb:hover {
                background: var(--gray-500);
            }

            .status-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }

            .status-badge:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }

            .status-badge.editable {
                cursor: pointer;
                border: 1px solid transparent;
            }

            .status-badge.editable:hover {
                border-color: var(--primary);
            }

            .status-thanh-cong {
                background: #d1fae5;
                color: #065f46;
            }

            .status-gio-trong {
                background: #fee2e2;
                color: #991b1b;
            }

            .status-xu-ly {
                background: #dbeafe;
                color: #1e40af;
            }

            .status-default {
                background: var(--gray-100);
                color: var(--gray-700);
            }

            .status-row {
                cursor: pointer;
                transition: all 0.2s;
            }

            .status-row:hover {
                background: var(--gray-50) !important;
                transform: translateX(4px);
            }

            .status-row.active {
                background: #e0e7ff !important;
                border-left: 3px solid var(--primary);
            }

            .status-row.active .count-badge {
                background: var(--primary-light);
            }

            .count-badge {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 32px;
                height: 32px;
                background: var(--primary);
                color: white;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                padding: 0 8px;
            }

            .empty-state {
                text-align: center;
                padding: 48px 24px;
                color: var(--gray-600);
            }

            .empty-state i {
                width: 48px;
                height: 48px;
                color: var(--gray-400);
                margin-bottom: 16px;
            }

            .loading-state {
                text-align: center;
                padding: 48px 24px;
                color: var(--gray-600);
            }

            .loading-spinner {
                width: 48px;
                height: 48px;
                margin: 0 auto 16px;
                border: 4px solid var(--gray-200);
                border-top-color: var(--primary);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            @media (max-width: 1024px) {
                .tables-container {
                    grid-template-columns: 1fr;
                }

                .filter-row {
                    grid-template-columns: 1fr;
                }
            }

            /* Modal for editing tags */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 4000;
                backdrop-filter: blur(4px);
            }

            .modal-overlay.show {
                display: flex;
            }

            .modal-content {
                background: white;
                border-radius: 16px;
                padding: 24px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow:
                    0 20px 25px -5px rgba(0, 0, 0, 0.1),
                    0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 16px;
                border-bottom: 2px solid var(--gray-100);
            }

            .modal-title {
                font-size: 18px;
                font-weight: 600;
                color: var(--gray-800);
            }

            .modal-close {
                width: 32px;
                height: 32px;
                border: none;
                background: var(--gray-100);
                border-radius: 8px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }

            .modal-close:hover {
                background: var(--gray-200);
            }

            .tag-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .tag-option {
                padding: 12px 16px;
                border: 2px solid var(--gray-200);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .tag-option:hover {
                border-color: var(--primary);
                background: var(--gray-50);
            }

            .tag-option.selected {
                border-color: var(--primary);
                background: #e0e7ff;
            }

            .tag-option-name {
                font-weight: 500;
                color: var(--gray-700);
            }

            .tag-option-check {
                width: 20px;
                height: 20px;
                border-radius: 4px;
                border: 2px solid var(--gray-300);
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }

            .tag-option.selected .tag-option-check {
                background: var(--primary);
                border-color: var(--primary);
            }

            .modal-footer {
                margin-top: 20px;
                padding-top: 16px;
                border-top: 2px solid var(--gray-100);
                display: flex;
                gap: 12px;
                justify-content: flex-end;
            }

            .btn-secondary {
                background: var(--gray-200);
                color: var(--gray-700);
            }

            .btn-secondary:hover {
                background: var(--gray-300);
            }

            .huyen-header {
                background: var(--primary);
                color: white;
                font-weight: 600;
                text-align: center;
                padding: 16px !important;
            }

            .total-row {
                font-weight: 600;
                background: var(--gray-50);
            }

            .total-row td {
                border-top: 2px solid var(--gray-300) !important;
            }
        </style>
    </head>

    <body data-page="orders-report">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i data-lucide="zap"></i>
                    <span>N2Shop</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i data-lucide="panel-left-close"></i>
                </button>
            </div>

            <nav class="sidebar-nav" id="sidebarNav">
                <!-- Menu items auto-generated by navigation-modern.js -->
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <i data-lucide="user-circle"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role">Quản trị viên</div>
                    </div>
                </div>
                <button class="btn-permissions" id="btnPermissions">
                    <i data-lucide="shield-check"></i>
                    <span>Xem Quyền Của Tôi</span>
                </button>
                <button class="btn-logout" id="btnLogout">
                    <i data-lucide="log-out"></i>
                    <span>Đăng xuất</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="btn-icon" id="sidebarToggle">
                        <i data-lucide="menu"></i>
                    </button>
                    <button class="btn-icon mobile-only" id="menuToggle">
                        <i data-lucide="menu"></i>
                    </button>
                    <div class="breadcrumb">
                        <i data-lucide="home"></i>
                        <span>Báo Cáo Sale-Online</span>
                    </div>
                </div>
                <div class="top-bar-right">
                    <button class="btn btn-primary" id="exportExcelBtn">
                        <i data-lucide="download"></i>
                        <span>Xuất Excel</span>
                    </button>
                </div>
            </header>

            <div class="content-wrapper">
                <!-- Filter Section -->
                <div class="filter-section">
                    <!-- Bearer Token Section - HIDDEN (Auto-managed by token-manager.js) -->
                    <div class="form-group" style="margin-bottom: 16px; display: none;">
                        <label for="bearerToken">
                            Bearer Token
                            <span
                                style="
                                    color: var(--danger);
                                    font-size: 12px;
                                    margin-left: 4px;
                                "
                                >*</span
                            >
                        </label>
                        <div style="position: relative">
                            <input
                                type="password"
                                id="bearerToken"
                                class="form-control"
                                placeholder="Nhập Bearer token..."
                                style="
                                    font-family: monospace;
                                    padding-right: 45px;
                                "
                            />
                            <button
                                type="button"
                                id="toggleTokenBtn"
                                class="btn-icon"
                                style="
                                    position: absolute;
                                    right: 8px;
                                    top: 50%;
                                    transform: translateY(-50%);
                                    border: none;
                                    background: transparent;
                                    cursor: pointer;
                                    padding: 4px;
                                "
                                title="Hiển thị/Ẩn token"
                            >
                                <i
                                    data-lucide="eye"
                                    style="width: 18px; height: 18px"
                                ></i>
                            </button>
                        </div>
                        <small
                            style="
                                color: var(--gray-600);
                                font-size: 12px;
                                margin-top: 4px;
                                display: block;
                            "
                        >
                            Token sẽ được lưu tự động vào bộ nhớ máy
                        </small>
                        <small
                            style="
                                color: var(--warning);
                                font-size: 12px;
                                margin-top: 4px;
                                display: block;
                            "
                        >
                            ⚠️ Lưu ý: Nếu gặp lỗi CORS, vui lòng mở trang từ
                            https://tomato.tpos.vn hoặc cài đặt extension CORS
                            Unblock
                        </small>
                    </div>
                    <div class="filter-row">
                        <div class="form-group">
                            <label for="userFilter">Lọc theo User</label>
                            <select id="userFilter" class="form-control">
                                <option value="all">Tất cả</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="facebookPostId">Facebook Post ID</label>
                            <div style="display: flex; gap: 8px;">
                                <input
                                    type="text"
                                    id="facebookPostId"
                                    class="form-control"
                                    value="270136663390370_1363806618461599"
                                    placeholder="Nhập Facebook Post ID"
                                    style="flex: 1;"
                                />
                                <button
                                    type="button"
                                    id="openPageSelectorBtn"
                                    class="btn btn-primary"
                                    style="white-space: nowrap; padding: 10px 16px;"
                                    title="Chọn từ Livestream Facebook"
                                >
                                    <i data-lucide="video" style="width: 18px; height: 18px;"></i>
                                    <span style="display: none;">Chọn</span>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="startDate">Từ ngày</label>
                            <input
                                type="date"
                                id="startDate"
                                class="form-control"
                            />
                        </div>
                        <div class="form-group">
                            <label for="endDate">Đến ngày</label>
                            <input
                                type="date"
                                id="endDate"
                                class="form-control"
                            />
                        </div>
                        <button class="btn btn-primary" id="fetchDataBtn">
                            <i data-lucide="search"></i>
                            <span>Tìm kiếm</span>
                        </button>
                    </div>
                </div>

                <!-- Tables Container -->
                <div class="tables-container">
                    <!-- Left Table: Status Statistics -->
                    <div class="table-card">
                        <div class="table-header">
                            <h3 class="table-title">
                                <i data-lucide="bar-chart-3"></i>
                                <span id="statsTableTitle"
                                    >Thống Kê Theo Trạng Thái</span
                                >
                            </h3>
                            <span class="table-count" id="totalOrders"
                                >0 đơn</span
                            >
                        </div>
                        <div class="table-wrapper" id="statusTableWrapper">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Đang tải dữ liệu...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Table: Customer Details -->
                    <div class="table-card">
                        <div class="table-header">
                            <div
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 12px;
                                "
                            >
                                <h3 class="table-title">
                                    <i data-lucide="users"></i>
                                    Chi Tiết Đơn Hàng
                                </h3>
                                <div id="filterBadge" style="display: none">
                                    <span
                                        class="status-badge"
                                        style="
                                            background: var(--primary);
                                            color: white;
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                        "
                                    >
                                        <span id="filterBadgeText"></span>
                                        <button
                                            id="clearFilterBtn"
                                            style="
                                                background: none;
                                                border: none;
                                                cursor: pointer;
                                                padding: 0;
                                                display: flex;
                                                align-items: center;
                                            "
                                        >
                                            <i
                                                data-lucide="x"
                                                style="
                                                    width: 14px;
                                                    height: 14px;
                                                    color: white;
                                                "
                                            ></i>
                                        </button>
                                    </span>
                                </div>
                            </div>
                            <span class="table-count" id="totalCustomers"
                                >0 đơn</span
                            >
                        </div>
                        <div class="table-wrapper" id="customerTableWrapper">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Đang tải dữ liệu...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal Edit Tags -->
        <div class="modal-overlay" id="editTagModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Chỉnh Sửa Trạng Thái</h3>
                    <button class="modal-close" id="closeModalBtn">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group" style="margin-bottom: 16px">
                        <label
                            style="
                                display: block;
                                margin-bottom: 8px;
                                font-weight: 500;
                            "
                        >
                            Khách hàng:
                            <span
                                id="modalCustomerName"
                                style="color: var(--primary)"
                            ></span>
                        </label>
                    </div>
                    <div class="tag-list" id="tagList">
                        <!-- Tags will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelModalBtn">
                        Hủy
                    </button>
                    <button class="btn btn-primary" id="saveTagBtn">
                        <i data-lucide="save"></i>
                        <span>Lưu</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script src="config.js"></script>
        <script src="auth.js"></script>
        <script src="cache.js"></script>
        <script src="notification-system.js"></script>

        <script>
            // Initialize notification manager
            const notificationManager = new NotificationManager();

            // Initialize Lucide icons
            lucide.createIcons();

            // Global data storage
            let allOrdersData = [];
            let selectedStatusFilter = null; // null = show all
            let availableTags = []; // All unique tags from data
            let editingOrderId = null; // Order being edited

            // ===== OLD BEARER TOKEN FUNCTIONS (No longer needed - handled by token-manager.js) =====
            // Bearer Token Management
            // const BEARER_TOKEN_KEY = "tpos_bearer_token";
            //
            // function saveBearerToken(token) {
            //     try {
            //         localStorage.setItem(BEARER_TOKEN_KEY, token);
            //         console.log("Bearer token saved to localStorage");
            //     } catch (error) {
            //         console.error("Error saving bearer token:", error);
            //     }
            // }
            //
            // function loadBearerToken() {
            //     try {
            //         const token = localStorage.getItem(BEARER_TOKEN_KEY);
            //         if (token) {
            //             document.getElementById("bearerToken").value = token;
            //             console.log("Bearer token loaded from localStorage");
            //             return token;
            //         }
            //     } catch (error) {
            //         console.error("Error loading bearer token:", error);
            //     }
            //     return null;
            // }

            // Generate GUID for x-request-id
            function generateGUID() {
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
                    /[xy]/g,
                    function (c) {
                        const r = (Math.random() * 16) | 0;
                        const v = c === "x" ? r : (r & 0x3) | 0x8;
                        return v.toString(16);
                    },
                );
            }

            // ===== OLD TOKEN INPUT LISTENERS (No longer needed) =====
            // Save token when input changes
            // document
            //     .getElementById("bearerToken")
            //     .addEventListener("input", (e) => {
            //         const token = e.target.value.trim();
            //         if (token) {
            //             saveBearerToken(token);
            //         }
            //     });
            //
            // // Toggle Bearer token visibility
            // const toggleTokenBtn = document.getElementById("toggleTokenBtn");
            // const bearerTokenInput = document.getElementById("bearerToken");
            // let tokenVisible = false;
            //
            // toggleTokenBtn.addEventListener("click", () => {
            //     tokenVisible = !tokenVisible;
            //     bearerTokenInput.type = tokenVisible ? "text" : "password";
            //
            //     // Update icon
            //     const icon = toggleTokenBtn.querySelector("i");
            //     icon.setAttribute(
            //         "data-lucide",
            //         tokenVisible ? "eye-off" : "eye",
            //     );
            //     lucide.createIcons();
            // });

            // Set default dates (7 days ago to today, GMT+7)
            function setDefaultDates() {
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 7);

                // Format dates for input fields (YYYY-MM-DD)
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, "0");
                    const day = String(date.getDate()).padStart(2, "0");
                    return `${year}-${month}-${day}`;
                };

                document.getElementById("startDate").value =
                    formatDate(sevenDaysAgo);
                document.getElementById("endDate").value = formatDate(today);
            }

            // Convert local date to API format (GMT+7 to GMT+0)
            function dateToAPIFormat(dateString, isEndDate = false) {
                const date = new Date(dateString);

                if (isEndDate) {
                    // Set to end of day (23:59:59)
                    date.setHours(23, 59, 59, 999);
                } else {
                    // Set to start of day (00:00:00)
                    date.setHours(0, 0, 0, 0);
                }

                // Subtract 7 hours to convert GMT+7 to GMT+0
                date.setHours(date.getHours() - 7);

                // Format to ISO string and encode for URL
                const isoString = date.toISOString().split(".")[0] + "+00:00";
                return encodeURIComponent(isoString);
            }

            // Parse tags from JSON string
            function parseTags(tagsString) {
                if (!tagsString || tagsString === "null") return [];

                try {
                    const tags = JSON.parse(tagsString);
                    return tags.map((tag) => tag.Name);
                } catch (error) {
                    console.error("Error parsing tags:", error);
                    return [];
                }
            }

            // Populate user filter dropdown
            function populateUserFilter(data) {
                const users = new Set();
                data.forEach((order) => {
                    if (order.UserName) {
                        users.add(order.UserName);
                    }
                });

                const userFilter = document.getElementById("userFilter");
                userFilter.innerHTML = '<option value="all">Tất cả</option>';

                Array.from(users)
                    .sort()
                    .forEach((user) => {
                        const option = document.createElement("option");
                        option.value = user;
                        option.textContent = user;
                        userFilter.appendChild(option);
                    });
            }

            // Update table title based on selected user
            function updateTableTitle() {
                const userFilter = document.getElementById("userFilter").value;
                const title = document.getElementById("statsTableTitle");

                if (userFilter === "all") {
                    title.textContent = "Thống Kê Theo Trạng Thái";
                } else {
                    title.textContent = `Thống Kê Theo ${userFilter}`;
                }
            }

            // Filter data by selected user
            function getFilteredData() {
                const userFilter = document.getElementById("userFilter").value;

                if (userFilter === "all") {
                    return allOrdersData;
                }

                return allOrdersData.filter(
                    (order) => order.UserName === userFilter,
                );
            }

            // Handle status filter (when clicking on status in left table)
            function handleStatusFilter(status) {
                // Toggle filter: if same status clicked, remove filter
                if (selectedStatusFilter === status) {
                    selectedStatusFilter = null;
                } else {
                    selectedStatusFilter = status;
                }

                // Re-render both tables
                const filteredData = getFilteredData();
                renderStatusTable(filteredData);
                renderCustomerTable(filteredData);
            }

            // Extract all available tags from data
            function extractAvailableTags(data) {
                const tagsSet = new Set();

                data.forEach((order) => {
                    const tags = parseTags(order.Tags);
                    tags.forEach((tag) => tagsSet.add(tag));
                });

                // Add default tag
                tagsSet.add("Bình thường");

                return Array.from(tagsSet).sort();
            }

            // Open edit tag modal
            function openEditTagModal(orderId) {
                editingOrderId = orderId;
                const order = allOrdersData.find((o) => o.Id === orderId);

                if (!order) return;

                // Set customer name in modal
                document.getElementById("modalCustomerName").textContent =
                    order.Name || "N/A";

                // Get current tags
                const currentTags = parseTags(order.Tags);
                const currentStatus = getStatus(currentTags);

                // Populate tag list
                const tagListHtml = availableTags
                    .map((tag) => {
                        const isSelected = currentStatus === tag;
                        const selectedClass = isSelected ? "selected" : "";
                        const checkIcon = isSelected
                            ? '<i data-lucide="check" style="width: 14px; height: 14px; color: white;"></i>'
                            : "";

                        return `
                    <div class="tag-option ${selectedClass}" data-tag="${tag}">
                        <span class="tag-option-name">${tag}</span>
                        <div class="tag-option-check">${checkIcon}</div>
                    </div>
                `;
                    })
                    .join("");

                document.getElementById("tagList").innerHTML = tagListHtml;

                // Show modal
                document.getElementById("editTagModal").classList.add("show");

                // Re-init lucide icons
                lucide.createIcons();

                // Add click handlers to tag options
                document.querySelectorAll(".tag-option").forEach((option) => {
                    option.addEventListener("click", function () {
                        // Remove selected from all
                        document
                            .querySelectorAll(".tag-option")
                            .forEach((opt) => {
                                opt.classList.remove("selected");
                                opt.querySelector(
                                    ".tag-option-check",
                                ).innerHTML = "";
                            });

                        // Add selected to clicked one
                        this.classList.add("selected");
                        this.querySelector(".tag-option-check").innerHTML =
                            '<i data-lucide="check" style="width: 14px; height: 14px; color: white;"></i>';

                        lucide.createIcons();
                    });
                });
            }

            // Close modal
            function closeEditTagModal() {
                document
                    .getElementById("editTagModal")
                    .classList.remove("show");
                editingOrderId = null;
            }

            // Save tag changes
            function saveTagChanges() {
                const selectedOption = document.querySelector(
                    ".tag-option.selected",
                );
                if (!selectedOption || !editingOrderId) return;

                const newStatus = selectedOption.getAttribute("data-tag");

                // Find order in data
                const order = allOrdersData.find(
                    (o) => o.Id === editingOrderId,
                );
                if (!order) return;

                // Update tags in local data
                if (newStatus === "Bình thường") {
                    order.Tags = null;
                } else {
                    // Create a simple tag structure
                    order.Tags = JSON.stringify([
                        {
                            Id: Date.now(),
                            Name: newStatus,
                            Type: "default",
                            Color: "#6366f1",
                        },
                    ]);
                }

                // Close modal
                closeEditTagModal();

                // Re-render tables
                const filteredData = getFilteredData();
                renderStatusTable(filteredData);
                renderCustomerTable(filteredData);

                // Show success notification
                notificationManager.success(
                    `Đã cập nhật trạng thái thành "${newStatus}"`,
                );

                // Note: In production, you would also send an API request here to update the backend
                console.log(
                    "Order updated:",
                    order.Id,
                    "New status:",
                    newStatus,
                );
            }

            // Get status from tags
            function getStatus(tags) {
                if (!tags || tags.length === 0) return "Bình thường";
                return tags.join(", ");
            }

            // Get status badge class
            function getStatusBadgeClass(status) {
                const statusLower = status.toLowerCase();
                if (
                    statusLower.includes("thành công") ||
                    statusLower.includes("ok")
                ) {
                    return "status-thanh-cong";
                } else if (
                    statusLower.includes("giỏ trống") ||
                    statusLower.includes("chờ")
                ) {
                    return "status-gio-trong";
                } else if (
                    statusLower.includes("xử lý") ||
                    statusLower.includes("live")
                ) {
                    return "status-xu-ly";
                }
                return "status-default";
            }

            // Render status table (left table)
            function renderStatusTable(data) {
                const statusData = {};

                // Count orders by status
                data.forEach((order) => {
                    const tags = parseTags(order.Tags);
                    const status = getStatus(tags);

                    if (!statusData[status]) {
                        statusData[status] = 0;
                    }

                    statusData[status]++;
                });

                // Sort statuses
                const sortedStatuses = Object.keys(statusData).sort((a, b) => {
                    // "Bình thường" goes last
                    if (a === "Bình thường") return 1;
                    if (b === "Bình thường") return -1;
                    return statusData[b] - statusData[a]; // Sort by count descending
                });

                // Build table HTML
                let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Trạng thái</th>
                            <th style="text-align: center;">Số lượng đơn</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

                // Add status rows with click handler
                sortedStatuses.forEach((status) => {
                    const badgeClass = getStatusBadgeClass(status);
                    const isActive = selectedStatusFilter === status;
                    const activeClass = isActive ? "active" : "";

                    html += `
                    <tr class="status-row ${activeClass}" data-status="${status}">
                        <td>
                            <span class="status-badge ${badgeClass}">${status}</span>
                        </td>
                        <td style="text-align: center;">
                            <span class="count-badge">${statusData[status]}</span>
                        </td>
                    </tr>
                `;
                });

                // Add total row
                const total = Object.values(statusData).reduce(
                    (sum, count) => sum + count,
                    0,
                );
                html += `
                <tr class="total-row">
                    <td><strong>TỔNG CỘNG</strong></td>
                    <td style="text-align: center;">
                        <span class="count-badge">${total}</span>
                    </td>
                </tr>
            `;

                html += "</tbody></table>";

                document.getElementById("statusTableWrapper").innerHTML = html;
                document.getElementById("totalOrders").textContent =
                    `${total} đơn`;

                // Add click event listeners to status rows
                document.querySelectorAll(".status-row").forEach((row) => {
                    row.addEventListener("click", function () {
                        const status = this.getAttribute("data-status");
                        handleStatusFilter(status);
                    });
                });
            }

            // Render customer table (right table)
            function renderCustomerTable(data) {
                // Filter by selected status if any
                let displayData = data;
                if (selectedStatusFilter) {
                    displayData = data.filter((order) => {
                        const tags = parseTags(order.Tags);
                        const status = getStatus(tags);
                        return status === selectedStatusFilter;
                    });

                    // Show filter badge
                    document.getElementById("filterBadge").style.display =
                        "block";
                    document.getElementById("filterBadgeText").textContent =
                        `Lọc: ${selectedStatusFilter}`;
                    lucide.createIcons();
                } else {
                    // Hide filter badge
                    document.getElementById("filterBadge").style.display =
                        "none";
                }

                let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tên KH</th>
                            <th>SĐT</th>
                            <th>Trạng thái</th>
                            <th>Lý do</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

                displayData.forEach((order) => {
                    const tags = parseTags(order.Tags);
                    const status = getStatus(tags);
                    const badgeClass = getStatusBadgeClass(status);
                    const note = order.Note
                        ? order.Note.replace(/\r\n/g, ", ").replace(/\n/g, ", ")
                        : "-";

                    html += `
                    <tr>
                        <td>${order.Name || "N/A"}</td>
                        <td>${order.Telephone || "N/A"}</td>
                        <td>
                            <span class="status-badge ${badgeClass} editable" 
                                  data-order-id="${order.Id}"
                                  title="Click để chỉnh sửa">
                                ${status}
                            </span>
                        </td>
                        <td style="max-width: 250px; word-wrap: break-word;">${note}</td>
                    </tr>
                `;
                });

                html += "</tbody></table>";

                document.getElementById("customerTableWrapper").innerHTML =
                    html;
                document.getElementById("totalCustomers").textContent =
                    `${displayData.length} đơn`;

                // Add click event listeners to editable status badges
                document
                    .querySelectorAll(".status-badge.editable")
                    .forEach((badge) => {
                        badge.addEventListener("click", function () {
                            const orderId = this.getAttribute("data-order-id");
                            openEditTagModal(orderId);
                        });
                    });
            }

            // Show empty state
            function showEmptyState(containerId, message = "Không có dữ liệu") {
                document.getElementById(containerId).innerHTML = `
                <div class="empty-state">
                    <i data-lucide="inbox"></i>
                    <p>${message}</p>
                </div>
            `;
                lucide.createIcons();
            }

            // Fetch data from API
            async function fetchData() {
                const postId = document
                    .getElementById("facebookPostId")
                    .value.trim();
                const startDate = document.getElementById("startDate").value;
                const endDate = document.getElementById("endDate").value;

                if (!postId) {
                    notificationManager.error("Vui lòng nhập Facebook Post ID");
                    return;
                }

                if (!startDate || !endDate) {
                    notificationManager.error("Vui lòng chọn khoảng thời gian");
                    return;
                }

                const loadingId = notificationManager.loading(
                    "Đang tải dữ liệu...",
                );

                try {
                    // Get bearer token automatically from tokenManager
                    const authHeaders = await window.tokenManager.getAuthHeader();
                    
                    // Build API URL
                    const startDateAPI = dateToAPIFormat(startDate, false);
                    const endDateAPI = dateToAPIFormat(endDate, true);

                    const apiUrl = `https://tomato.tpos.vn/odata/SaleOnline_Order/ODataService.GetView?$orderby=DateCreated desc&$filter=(DateCreated ge ${startDateAPI} and DateCreated le ${endDateAPI})&$count=true`;

                    console.log("Fetching from:", apiUrl);

                    // Prepare headers
                    const headers = {
                        ...authHeaders,
                        Accept: "application/json, text/plain, */*",
                        "x-request-id": generateGUID(),
                    };

                    const response = await fetch(apiUrl, {
                        method: "GET",
                        headers: headers,
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            // Token invalid, try to refresh
                            console.log("[API] 401 error, attempting token refresh...");
                            await window.tokenManager.refresh();
                            
                            // Retry with new token
                            const newAuthHeaders = await window.tokenManager.getAuthHeader();
                            const retryHeaders = {
                                ...newAuthHeaders,
                                Accept: "application/json, text/plain, */*",
                                "x-request-id": generateGUID(),
                            };
                            
                            const retryResponse = await fetch(apiUrl, {
                                method: "GET",
                                headers: retryHeaders,
                            });
                            
                            if (!retryResponse.ok) {
                                throw new Error(
                                    "Token không hợp lệ sau khi refresh. Vui lòng kiểm tra lại.",
                                );
                            }
                            
                            // Use the retry response
                            const retryResult = await retryResponse.json();
                            const filteredData = retryResult.value.filter(
                                (order) => order.Facebook_PostId === postId,
                            );
                            
                            console.log(
                                `Found ${filteredData.length} orders matching Post ID (after retry)`,
                            );
                            
                            processSuccessfulResponse(filteredData, loadingId);
                            return;
                        }
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const result = await response.json();

                    // Filter by Facebook Post ID
                    const filteredData = result.value.filter(
                        (order) => order.Facebook_PostId === postId,
                    );

                    console.log(
                        `Found ${filteredData.length} orders matching Post ID`,
                    );

                    // Process successful response
                    processSuccessfulResponse(filteredData, loadingId);
                } catch (error) {
                    console.error("Error fetching data:", error);
                    notificationManager.remove(loadingId);

                    // Check if it's a CORS error
                    if (
                        error.message.includes("fetch") ||
                        error.message.includes("CORS") ||
                        error.message.includes("NetworkError")
                    ) {
                        notificationManager.error(
                            "Không thể kết nối đến API. Lỗi CORS - Vui lòng mở trang từ domain https://tomato.tpos.vn hoặc sử dụng extension CORS Unblock.",
                            6000,
                        );
                    } else {
                        notificationManager.error(
                            "Lỗi khi tải dữ liệu: " + error.message,
                        );
                    }

                    showEmptyState("statusTableWrapper", "Lỗi khi tải dữ liệu");
                    showEmptyState(
                        "customerTableWrapper",
                        "Lỗi khi tải dữ liệu",
                    );
                }
            }

            // Helper function to process successful API response
            function processSuccessfulResponse(filteredData, loadingId) {
                notificationManager.remove(loadingId);

                if (filteredData.length === 0) {
                    notificationManager.warning(
                        "Không tìm thấy đơn hàng nào",
                    );
                    showEmptyState(
                        "statusTableWrapper",
                        "Không tìm thấy đơn hàng nào",
                    );
                    showEmptyState(
                        "customerTableWrapper",
                        "Không tìm thấy đơn hàng nào",
                    );
                    return;
                }

                // Store data globally
                allOrdersData = filteredData;

                // Extract available tags
                availableTags = extractAvailableTags(filteredData);

                // Reset filter
                selectedStatusFilter = null;

                // Populate user filter
                populateUserFilter(filteredData);

                // Render tables
                updateTableTitle();
                renderStatusTable(getFilteredData());
                renderCustomerTable(getFilteredData());

                notificationManager.success(
                    `Đã tải ${filteredData.length} đơn hàng`,
                );
            }

            // Export to Excel
            function exportToExcel() {
                if (!allOrdersData || allOrdersData.length === 0) {
                    notificationManager.warning("Không có dữ liệu để xuất");
                    return;
                }

                try {
                    const filteredData = getFilteredData();

                    // Further filter by selected status if any
                    let exportData = filteredData;
                    if (selectedStatusFilter) {
                        exportData = filteredData.filter((order) => {
                            const tags = parseTags(order.Tags);
                            const status = getStatus(tags);
                            return status === selectedStatusFilter;
                        });
                    }

                    // Prepare data for export
                    const excelData = exportData.map((order) => {
                        const tags = parseTags(order.Tags);
                        const status = getStatus(tags);
                        const note = order.Note
                            ? order.Note.replace(/\r\n/g, ", ").replace(
                                  /\n/g,
                                  ", ",
                              )
                            : "";

                        return {
                            "Mã đơn": order.Code,
                            "Tên KH": order.Name,
                            SĐT: order.Telephone,
                            "Địa chỉ": order.Address,
                            "Trạng thái": status,
                            "Lý do": note,
                            "Tổng tiền": order.TotalAmount,
                            "Số lượng": order.TotalQuantity,
                            "Ngày tạo": order.DateCreated,
                            User: order.UserName,
                        };
                    });

                    // Create workbook
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Đơn hàng");

                    // Generate filename
                    const userFilter =
                        document.getElementById("userFilter").value;
                    const statusSuffix = selectedStatusFilter
                        ? `_${selectedStatusFilter}`
                        : "";
                    const filename =
                        userFilter === "all"
                            ? `Don_hang${statusSuffix}_${new Date().getTime()}.xlsx`
                            : `Don_hang_${userFilter}${statusSuffix}_${new Date().getTime()}.xlsx`;

                    // Save file
                    XLSX.writeFile(wb, filename);

                    notificationManager.success("Đã xuất Excel thành công");
                } catch (error) {
                    console.error("Error exporting to Excel:", error);
                    notificationManager.error(
                        "Lỗi khi xuất Excel: " + error.message,
                    );
                }
            }

            // Event listeners
            document
                .getElementById("fetchDataBtn")
                .addEventListener("click", fetchData);
            document
                .getElementById("exportExcelBtn")
                .addEventListener("click", exportToExcel);

            // User filter change event
            document
                .getElementById("userFilter")
                .addEventListener("change", () => {
                    if (allOrdersData.length > 0) {
                        updateTableTitle();
                        selectedStatusFilter = null; // Reset status filter when changing user
                        const filteredData = getFilteredData();
                        renderStatusTable(filteredData);
                        renderCustomerTable(filteredData);
                    }
                });

            // Modal event listeners
            document
                .getElementById("closeModalBtn")
                .addEventListener("click", closeEditTagModal);
            document
                .getElementById("cancelModalBtn")
                .addEventListener("click", closeEditTagModal);
            document
                .getElementById("saveTagBtn")
                .addEventListener("click", saveTagChanges);

            // Close modal when clicking outside
            document
                .getElementById("editTagModal")
                .addEventListener("click", function (e) {
                    if (e.target === this) {
                        closeEditTagModal();
                    }
                });

            // Clear filter button
            document.addEventListener("click", function (e) {
                if (e.target.closest("#clearFilterBtn")) {
                    selectedStatusFilter = null;
                    const filteredData = getFilteredData();
                    renderStatusTable(filteredData);
                    renderCustomerTable(filteredData);
                }
            });

            // Initialize
            setDefaultDates();

            // Token is now managed automatically by token-manager.js
            // Show initial empty state
            showEmptyState(
                "statusTableWrapper",
                "Nhấn Tìm kiếm để tải dữ liệu",
            );
            showEmptyState(
                "customerTableWrapper",
                "Nhấn Tìm kiếm để tải dữ liệu",
            );
        </script>

        <!-- Facebook Page Selection Modal -->
        <div class="page-selector-modal" id="pageSelectionModal">
            <div class="page-selector-content">
                <div class="page-selector-header">
                    <h2 class="page-selector-title">
                        <i data-lucide="facebook"></i>
                        Chọn Facebook Livestream
                    </h2>
                    <button class="close-modal-btn" id="closePageSelectorModal">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="page-selector-body">
                    <div class="page-filter-section">
                        <div class="form-group">
                            <label for="fbAccountSelect">Chọn tài khoản Facebook</label>
                            <select id="fbAccountSelect" class="form-control">
                                <option value="">-- Đang tải... --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fbPageSelect">Chọn Page</label>
                            <select id="fbPageSelect" class="form-control" disabled>
                                <option value="">-- Chọn tài khoản trước --</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: end;">
                            <button class="refresh-btn" id="refreshAccountsBtn">
                                <i data-lucide="refresh-cw"></i>
                                Làm mới
                            </button>
                        </div>
                    </div>

                    <div class="livestream-section-header">
                        <h3 class="livestream-section-title">
                            <i data-lucide="video"></i>
                            Danh sách Livestream
                        </h3>
                    </div>

                    <div id="livestreamListContainer">
                        <div class="empty-state">
                            <i data-lucide="video-off" class="empty-icon"></i>
                            <p>Chọn page để xem livestream</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
