<!doctype html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quick View - 50 Đơn Mới Nhất</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="tab1-orders.css" />
    <link rel="stylesheet" href="tab-quick-view.css" />
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Đang tải 50 đơn mới nhất...</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header Bar -->
        <div class="quick-view-header">
            <div class="header-left">
                <h1 class="header-title">
                    <i class="fas fa-bolt"></i> Quick View
                </h1>
                <span class="header-subtitle">50 đơn hàng mới nhất</span>
            </div>

            <div class="header-center">
                <!-- Stats -->
                <div class="quick-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalOrders">0</span>
                        <span class="stat-label">Đơn hàng</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="totalAmount">0đ</span>
                        <span class="stat-label">Tổng giá trị</span>
                    </div>
                </div>
            </div>

            <div class="header-right">
                <!-- Auto-refresh controls -->
                <div class="refresh-controls">
                    <label class="auto-refresh-toggle">
                        <input type="checkbox" id="autoRefreshToggle" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Auto</span>
                    </label>
                    <select id="refreshInterval" class="refresh-select">
                        <option value="3000">3s</option>
                        <option value="5000" selected>5s</option>
                        <option value="10000">10s</option>
                        <option value="15000">15s</option>
                        <option value="30000">30s</option>
                        <option value="60000">60s</option>
                    </select>
                    <button id="setDefaultBtn" class="btn-set-default" title="Lưu làm mặc định">
                        <i class="fas fa-save"></i>
                    </button>
                    <button id="manualRefreshBtn" class="btn-refresh" title="Làm mới ngay">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <!-- New orders badge -->
                <div class="new-orders-badge" id="newOrdersBadge" style="display: none;">
                    <i class="fas fa-bell"></i>
                    <span id="newOrdersCount">0</span> đơn mới
                </div>
            </div>
        </div>

        <!-- Countdown bar -->
        <div class="countdown-bar" id="countdownBar">
            <div class="countdown-progress" id="countdownProgress"></div>
        </div>

        <!-- Table Container -->
        <div class="table-container" id="tableContainer">
            <table class="orders-table" id="ordersTable">
                <thead>
                    <tr>
                        <th data-column="stt" style="width: 50px;">STT</th>
                        <th data-column="actions" style="width: 100px;">Thao tác</th>
                        <th data-column="order-code" style="width: 100px;">Mã ĐH</th>
                        <th data-column="customer" style="width: 120px;">Khách hàng</th>
                        <th data-column="phone" style="width: 110px;">SĐT</th>
                        <th data-column="address" style="width: 200px;">Địa chỉ</th>
                        <th data-column="tag" style="width: 150px;">TAG</th>
                        <th data-column="qr" style="width: 50px;">QR</th>
                        <th data-column="messages" style="width: 150px;">Tin nhắn</th>
                        <th data-column="debt" style="width: 80px;">Công nợ</th>
                        <th data-column="notes" style="width: 150px;">Ghi chú</th>
                        <th data-column="total" style="width: 100px;">Tổng tiền</th>
                        <th data-column="created-date" style="width: 100px;">Ngày tạo</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Data will be rendered here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tag Modal -->
    <div class="tag-modal" id="tagModal">
        <div class="tag-modal-content">
            <div class="tag-modal-header">
                <button class="tag-btn-save-header" onclick="saveOrderTags()">
                    Lưu (Ctrl + Enter)
                </button>
                <button class="tag-btn-refresh" onclick="refreshTags()" title="Tải lại từ TPOS"
                    style="margin-left: 8px; padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    <i class="fas fa-sync"></i>
                </button>
                <button class="tag-modal-close" onclick="closeTagModal()">×</button>
            </div>
            <div class="tag-modal-body">
                <div class="tag-input-container">
                    <div class="selected-tags-pills" id="selectedTagsPills"></div>
                    <input type="text" id="tagSearchInput" class="tag-add-input" placeholder="Tìm tag..."
                        oninput="filterTags()" onkeydown="handleTagInputKeydown(event)" />
                </div>
                <div class="tag-dropdown-list" id="tagList">
                    <div class="no-tags-message">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Đang tải danh sách tag...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div class="qr-modal" id="orderQRModal">
        <div class="qr-modal-content">
            <div class="qr-modal-header">
                <h3><i class="fas fa-qrcode"></i> Mã QR Thanh Toán</h3>
                <button class="qr-modal-close" onclick="closeOrderQRModal()">×</button>
            </div>
            <div class="qr-modal-body" id="orderQRModalBody">
                <!-- QR content rendered by JS -->
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-modal-content">
            <div class="chat-left-panel">
                <div class="chat-modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px 24px;">
                    <div class="chat-header-info" style="flex: 1;">
                        <h3 id="chatModalTitle" style="color: white; font-size: 18px; font-weight: 600; margin: 0 0 4px 0;">Tin nhắn</h3>
                        <p id="chatModalSubtitle" style="color: rgba(255, 255, 255, 0.9); font-size: 13px; margin: 0;">
                            <span id="chatModalSubtitleText">Đang tải...</span>
                        </p>
                    </div>
                    <div class="chat-header-actions" style="display: flex; gap: 8px;">
                        <button onclick="openCommentsInChat()" class="chat-header-btn" title="Xem bình luận" style="background: rgba(255,255,255,0.2); border: none; padding: 8px 12px; border-radius: 6px; color: white; cursor: pointer;">
                            <i class="fas fa-comments"></i> Bình luận
                        </button>
                        <button onclick="closeChatModal()" class="chat-header-btn" style="background: rgba(255,255,255,0.2); border: none; padding: 8px 12px; border-radius: 6px; color: white; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-modal-body" id="chatModalBody">
                    <div class="chat-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Đang tải tin nhắn...</p>
                    </div>
                </div>
                <div class="chat-modal-footer">
                    <div class="chat-input-wrapper">
                        <textarea id="chatInput" placeholder="Nhập tin nhắn..." rows="1"></textarea>
                        <button onclick="sendChatMessage()" class="chat-send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="edit-modal" id="editModal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3><i class="fas fa-edit"></i> Sửa đơn hàng</h3>
                <button class="edit-modal-close" onclick="closeEditModal()">×</button>
            </div>
            <div class="edit-modal-body" id="editModalBody">
                <!-- Edit form rendered by JS -->
            </div>
            <div class="edit-modal-footer">
                <button class="btn-cancel" onclick="closeEditModal()">Hủy</button>
                <button class="btn-save" onclick="saveOrderEdit()">
                    <i class="fas fa-save"></i> Lưu
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <!-- Core dependencies -->
    <script src="api-config.js"></script>
    <script src="config.js"></script>
    <script src="token-manager.js"></script>
    <script src="cache.js"></script>
    <script src="auth.js"></script>
    <script src="notification-system.js"></script>

    <!-- Pancake for chat -->
    <script src="pancake-token-manager.js"></script>
    <script src="pancake-data-manager.js"></script>

    <!-- Main Quick View logic -->
    <script src="tab-quick-view.js"></script>
</body>

</html>
