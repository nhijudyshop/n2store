<!doctype html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="tab1-orders.css" />
    <link rel="stylesheet" href="message-template-modal.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="
                    background: white;
                    padding: 32px;
                    border-radius: 12px;
                    text-align: center;
                ">
            <div class="loading-spinner" style="margin: 0 auto 16px"></div>
            <div class="loading-text" style="font-size: 14px; color: #6b7280">
                ƒêang t·∫£i d·ªØ li·ªáu...
            </div>
        </div>
    </div>
    <!-- Scroll to Top Button -->
    <button class="scroll-to-top" id="scrollToTopBtn">
        <i class="fas fa-arrow-up"></i>
    </button>
    <!-- Main Content -->
    <div class="main-content">
        <!-- Filter Section -->
        <div class="filter-section">
            <label>Kho·∫£ng t·∫£i:</label>
            <select id="skipRangeFilter" style="min-width: 150px">
                <option value="0" selected>3000 ƒë·∫ßu ti√™n</option>
                <option value="3000">3000 ti·∫øp theo</option>
                <option value="6000">3000 th·ª© 3</option>
                <option value="9000">3000 th·ª© 4</option>
                <option value="12000">3000 th·ª© 5</option>
            </select>
            <button class="btn-primary" id="loadCampaignsBtn" style="background: #8b5cf6">
                <i class="fas fa-sync-alt"></i>
                T·∫£i Chi·∫øn D·ªãch
            </button>
            <label>Chi·∫øn d·ªãch Live:</label>
            <select id="campaignFilter" style="min-width: 300px">
                <option value="">ƒêang t·∫£i...</option>
            </select>
            <label>T·ª´ ng√†y:</label>
            <input type="datetime-local" id="startDate" />
            <label>ƒê·∫øn ng√†y:</label>
            <input type="datetime-local" id="endDate" />
            <label>Tr·∫°ng th√°i h·ªôi tho·∫°i:</label>
            <select id="conversationFilter" style="min-width: 150px" onchange="performTableSearch()">
                <option value="all" selected>T·∫•t c·∫£</option>
                <option value="unread">Ch∆∞a ƒë·ªçc</option>
                <option value="read">ƒê√£ ƒë·ªçc</option>
            </select>
            <button class="btn-primary" id="clearCacheBtn" style="background: #ef4444">
                <i class="fas fa-trash"></i>
                X√≥a Cache
            </button>
            <button class="btn-primary" id="pancakeSettingsBtn" onclick="openPancakeSettingsModal()"
                style="background: #8b5cf6">
                <i class="fas fa-cog"></i>
                C√†i ƒë·∫∑t Pancake
            </button>
            <button class="btn-primary" id="chatApiToggleBtn" onclick="toggleChatAPISource()"
                style="background: #3b82f6" title="Ch·ªçn ngu·ªìn API ƒë·ªÉ hi·ªÉn th·ªã tin nh·∫Øn/b√¨nh lu·∫≠n">
                <i class="fas fa-exchange-alt"></i>
                <span id="chatApiSourceLabel">Pancake API</span>
            </button>
            <div
                style="display: flex; align-items: center; gap: 8px; margin-left: 12px; background: #f3f4f6; padding: 4px 8px; border-radius: 8px; border: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <input type="checkbox" id="realtimeToggleCheckbox" onchange="toggleRealtimeMode(this.checked)"
                        style="cursor: pointer; width: 16px; height: 16px;">
                    <label for="realtimeToggleCheckbox"
                        style="cursor: pointer; font-size: 14px; font-weight: 500; color: #374151; user-select: none;">
                        <i class="fas fa-bolt" style="color: #f59e0b; margin-right: 4px;"></i> Realtime
                    </label>
                </div>

                <!-- Mode Switcher (Hidden by default, shown when Realtime is checked) -->
                <div id="realtimeModeContainer"
                    style="display: none; margin-left: 8px; padding-left: 8px; border-left: 1px solid #d1d5db;">
                    <select id="realtimeModeSelect" onchange="changeRealtimeMode(this.value)"
                        style="padding: 2px 6px; border-radius: 4px; border: 1px solid #d1d5db; font-size: 12px; background: white; cursor: pointer;">
                        <option value="browser">Browser (Direct)</option>
                        <option value="server">Server (24/7)</option>
                        <option value="localhost">Server (Localhost)</option>
                    </select>
                    <button onclick="window.realtimeManager.manualConnect()"
                        style="margin-left: 6px; padding: 2px 8px; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer; font-size: 12px; color: #4b5563;"
                        title="K·∫øt n·ªëi l·∫°i th·ªß c√¥ng">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Buttons Section (New) -->
        <div class="action-buttons-section" style="padding: 16px 24px; display: none; gap: 12px; flex-wrap: wrap;"
            id="actionButtonsSection">
            <div style="display: flex; gap: 8px; align-items: center;">
                <span style="color: #6b7280; font-size: 13px; font-weight: 500;">
                    <span id="selectedOrdersCount">0</span> ƒë∆°n ƒë∆∞·ª£c ch·ªçn
                </span>
            </div>
            <button class="btn-message-action" id="assignEmptyCartTagBtn" style="
                        padding: 10px 20px;
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.2s;
                    "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <i class="fas fa-tags"></i>
                G√°n tag "GI·ªé TR·ªêNG"
            </button>
            <button class="btn-message-action" id="sendMessageBtn" onclick="openMessageTemplateModal()" style="
                        padding: 10px 20px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.2s;
                    "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <i class="fab fa-facebook-messenger"></i>
                G·ª≠i tin nh·∫Øn
            </button>
            <button class="btn-message-action" id="sendOrderConfirmBtn" style="
                        padding: 10px 20px;
                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.2s;
                    "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <i class="fas fa-paper-plane"></i>
                G·ª≠i l·∫°i tin ch·ªët ƒë∆°n
            </button>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar" id="statsBar" style="display: none">
            <div class="stats-item">
                <div class="stats-value" id="totalOrdersCount">0</div>
                <div class="stats-label">T·ªïng ƒë∆°n h√†ng</div>
            </div>
            <div class="stats-item">
                <div class="stats-value" id="displayedOrdersCount">0</div>
                <div class="stats-label">ƒêang hi·ªÉn th·ªã</div>
            </div>
            <div class="stats-item">
                <div class="stats-value" id="totalAmountSum">0ƒë</div>
                <div class="stats-label">T·ªïng gi√° tr·ªã</div>
            </div>
            <div class="stats-item">
                <div class="stats-value" id="loadingProgress">0%</div>
                <div class="stats-label">Ti·∫øn ƒë·ªô</div>
            </div>
        </div>
        <!-- Info Banner -->
        <div class="info-banner" id="infoBanner" style="display: none">
            <i class="fas fa-info-circle"></i>
            <span id="infoText"></span>
        </div>
        <!-- Search Section -->
        <div class="search-section" id="searchSection">
            <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="tableSearchInput"
                    placeholder="T√¨m ki·∫øm theo m√£ ƒêH, t√™n kh√°ch h√†ng, SƒêT, ƒë·ªãa ch·ªâ, ghi ch√∫, tr·∫°ng th√°i..."
                    autocomplete="off" />
                <button class="search-clear" id="searchClearBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-info">
                <div>
                    <span class="search-result-count" id="searchResultCount">0</span>
                    <span> k·∫øt qu·∫£</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="search-tips">üí° G√µ ƒë·ªÉ t√¨m ki·∫øm nhanh</div>
                    <button class="btn-column-settings" id="columnSettingsBtn" onclick="openColumnSettingsModal()">
                        <i class="fas fa-columns"></i> C√†i ƒë·∫∑t c·ªôt
                    </button>
                </div>
            </div>
        </div>
        <!-- Table Container -->
        <div class="table-container" id="tableContainer" style="display: none">
            <div class="table-wrapper" id="tableWrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" />
                            </th>
                            <th data-column="stt">STT</th>
                            <th data-column="order-code">M√£ ƒêH</th>
                            <th data-column="customer">Kh√°ch h√†ng</th>
                            <th data-column="messages">Tin nh·∫Øn</th>
                            <th data-column="comments">B√¨nh lu·∫≠n</th>
                            <th data-column="phone">SƒêT</th>
                            <th data-column="address">ƒê·ªãa ch·ªâ</th>
                            <th data-column="notes">Ghi ch√∫</th>
                            <th data-column="total">T·ªïng ti·ªÅn</th>
                            <th data-column="quantity">SL</th>
                            <th data-column="created-date">Ng√†y t·∫°o</th>
                            <th data-column="status">Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="14" style="text-align: center; padding: 40px">
                                Vui l√≤ng ch·ªçn chi·∫øn d·ªãch v√† b·∫•m T√¨m ki·∫øm
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Pagination Info -->
            <div class="pagination-wrapper">
                <div id="pageInfo">Hi·ªÉn th·ªã 0 - 0 c·ªßa 0</div>
                <div style="color: #6b7280; font-size: 12px" id="scrollHint"></div>
            </div>
        </div>
    </div>
    <!-- Tag Management Modal -->
    <div class="tag-modal" id="tagModal">
        <div class="tag-modal-content">
            <div class="tag-modal-header">
                <h3><i class="fas fa-tags"></i> Qu·∫£n l√Ω Tag</h3>
                <button class="tag-modal-close" onclick="closeTagModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tag-modal-body">
                <!-- Search -->
                <div class="tag-search">
                    <div class="tag-search-wrapper">
                        <input type="text" id="tagSearchInput" placeholder="T√¨m ki·∫øm tag..." oninput="filterTags()" />
                        <i class="fas fa-search tag-search-icon"></i>
                    </div>
                </div>
                <!-- Selected Tags -->
                <div class="selected-tags">
                    <span class="selected-tags-label">ƒê√£ ch·ªçn:</span>
                    <div class="selected-tags-list" id="selectedTagsList">
                        <span style="color: #9ca3af; font-size: 12px">
                            Ch∆∞a c√≥ tag n√†o ƒë∆∞·ª£c ch·ªçn
                        </span>
                    </div>
                </div>
                <!-- Tag List -->
                <div class="tag-list" id="tagList">
                    <div class="no-tags-message">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>ƒêang t·∫£i danh s√°ch tag...</p>
                    </div>
                </div>
            </div>
            <div class="tag-modal-footer">
                <button class="tag-btn-cancel" onclick="closeTagModal()">
                    H·ªßy
                </button>
                <button class="tag-btn-save" onclick="saveOrderTags()">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
            </div>
        </div>
    </div>

    <!-- Column Settings Modal -->
    <div class="column-settings-modal" id="columnSettingsModal">
        <div class="column-settings-modal-content">
            <div class="column-settings-modal-header">
                <h3><i class="fas fa-columns"></i> C√†i ƒë·∫∑t hi·ªÉn th·ªã c·ªôt</h3>
                <button class="column-settings-modal-close" onclick="closeColumnSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="column-settings-modal-body">
                <p style="color: #6b7280; font-size: 13px; margin-bottom: 16px;">
                    Ch·ªçn c√°c c·ªôt b·∫°n mu·ªën hi·ªÉn th·ªã trong b·∫£ng:
                </p>
                <div class="column-settings-list" id="columnSettingsList">
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="stt" checked />
                        <span>STT</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="order-code" checked />
                        <span>M√£ ƒë∆°n h√†ng</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="customer" checked />
                        <span>Kh√°ch h√†ng</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="messages" checked />
                        <span>Tin nh·∫Øn</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="comments" checked />
                        <span>B√¨nh lu·∫≠n</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="phone" checked />
                        <span>S·ªë ƒëi·ªán tho·∫°i</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="address" checked />
                        <span>ƒê·ªãa ch·ªâ</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="notes" checked />
                        <span>Ghi ch√∫</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="total" checked />
                        <span>T·ªïng ti·ªÅn</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="quantity" checked />
                        <span>S·ªë l∆∞·ª£ng</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="created-date" checked />
                        <span>Ng√†y t·∫°o</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="status" checked />
                        <span>Tr·∫°ng th√°i</span>
                    </label>
                </div>
            </div>
            <div class="column-settings-modal-footer">
                <button class="column-settings-btn-reset" onclick="resetColumnSettings()">
                    <i class="fas fa-undo"></i> ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh
                </button>
                <div style="display: flex; gap: 8px;">
                    <button class="column-settings-btn-cancel" onclick="closeColumnSettingsModal()">
                        H·ªßy
                    </button>
                    <button class="column-settings-btn-save" onclick="saveColumnSettings()">
                        <i class="fas fa-save"></i> L∆∞u
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Messages Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-modal-content" style="display: flex; flex-direction: row; max-width: 1000px; width: 95%;">
            <!-- Left Panel: Chat -->
            <div class="chat-left-panel"
                style="flex: 1; display: flex; flex-direction: column; border-right: 1px solid #e5e7eb;">
                <div class="chat-modal-header">
                    <div class="chat-header-info">
                        <h3 id="chatModalTitle">Tin nh·∫Øn v·ªõi Kh√°ch h√†ng</h3>
                        <p id="chatModalSubtitle">ƒêang t·∫£i...</p>
                    </div>
                    <button class="chat-modal-close" onclick="closeChatModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="chat-modal-body" id="chatModalBody">
                    <div class="chat-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>ƒêang t·∫£i tin nh·∫Øn...</p>
                    </div>
                </div>
                <!-- Reply Input (ch·ªâ hi·ªÉn th·ªã cho comments) -->
                <div class="chat-reply-container" id="chatReplyContainer" style="display: none;">
                    <div
                        style="display: flex; gap: 8px; align-items: center; padding: 12px; border-top: 1px solid #e5e7eb; background: #f9fafb;">
                        <input type="text" id="chatReplyInput" placeholder="Nh·∫≠p tin nh·∫Øn tr·∫£ l·ªùi..."
                            style="flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;"
                            onkeypress="if(event.key==='Enter') sendReplyComment();" />
                        <button class="chat-btn-send" id="chatSendBtn" onclick="sendReplyComment()"
                            style="padding: 10px 20px; background: linear-gradient(135deg, #0084ff 0%, #0066cc 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 132, 255, 0.3)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <i class="fas fa-paper-plane"></i>
                            G·ª≠i
                        </button>
                    </div>
                </div>
                <div class="chat-modal-footer">
                    <button class="chat-btn-close" onclick="closeChatModal()">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                    <button class="chat-btn-mark-read" id="chatMarkReadBtn" onclick="markChatAsRead()"
                        style="display: none;">
                        <i class="fas fa-check"></i> ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
                    </button>
                </div>
            </div>

            <!-- Right Panel: Products -->
            <div class="chat-right-panel"
                style="width: 350px; display: flex; flex-direction: column; background: #f9fafb;">
                <div class="chat-modal-header" style="background: #f3f4f6; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="font-size: 16px;"><i class="fas fa-box"></i> S·∫£n ph·∫©m</h3>
                    <div class="product-total-badge" id="chatProductTotal"
                        style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                        0ƒë</div>
                </div>

                <div class="chat-product-body" style="flex: 1; overflow-y: auto; padding: 0;">
                    <table class="table table-sm table-hover mb-0" style="font-size: 13px;">
                        <thead style="background: #f9fafb; position: sticky; top: 0;">
                            <tr>
                                <th style="width: 45%">S·∫£n ph·∫©m</th>
                                <th style="width: 25%" class="text-center">SL</th>
                                <th style="width: 20%" class="text-right">Gi√°</th>
                                <th style="width: 10%"></th>
                            </tr>
                        </thead>
                        <tbody id="chatProductTableBody">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <div class="chat-product-footer"
                    style="padding: 12px; border-top: 1px solid #e5e7eb; background: white;">
                    <div style="position: relative;">
                        <input type="text" id="chatProductSearch" placeholder="T√¨m s·∫£n ph·∫©m (t√™n, m√£)..."
                            style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                        <div id="chatProductSuggestions" class="product-suggestions" style="display: none;">
                            <!-- Suggestions -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- API Configuration (load first!) -->
    <script src="api-config.js"></script>

    <script src="token-manager.js"></script>
    <script src="cache.js"></script>
    <script src="auth.js"></script>
    <script src="notification-system.js"></script>
    <script src="pancake-token-manager.js"></script>
    <script src="pancake-data-manager.js"></script>
    <script src="chat-api-settings.js"></script>
    <script src="chat-data-manager.js"></script>
    <script src="message-template-manager.js"></script>
    <script src="product-search-manager.js"></script>
    <script src="chat-product-manager.js"></script>
    <script src="search-functions.js"></script>
    <script src="column-visibility-manager.js"></script>
    <script src="realtime-manager.js"></script>
    <script src="debug-realtime.js"></script>
    <script src="tab1-orders.js"></script>

    <!-- Additional Script for Checkbox Handling -->
    <script>
        // Handle checkbox selection
        document.addEventListener('DOMContentLoaded', function () {
            const selectAllCheckbox = document.getElementById('selectAll');

            // Individual checkbox change
            document.addEventListener('change', function (e) {
                if (e.target.matches('tbody input[type="checkbox"]')) {
                    // Call global updateActionButtons from tab1-orders.js
                    if (typeof updateActionButtons === 'function') {
                        updateActionButtons();
                    }

                    // Update select all checkbox state
                    const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    const someChecked = Array.from(checkboxes).some(cb => cb.checked);

                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = allChecked;
                        selectAllCheckbox.indeterminate = someChecked && !allChecked;
                    }
                }
            });
        });
    </script>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator">
        <i class="fas fa-check-circle"></i>
        <span id="saveIndicatorText">ƒê√£ l∆∞u th√†nh c√¥ng</span>
    </div>

    <!-- Pancake Settings Modal -->
    <div class="tag-modal" id="pancakeSettingsModal" style="display: none;">
        <div class="tag-modal-content">
            <div class="tag-modal-header">
                <h3><i class="fas fa-cog"></i> C√†i ƒë·∫∑t Pancake JWT Token</h3>
                <button class="tag-modal-close" onclick="closePancakeSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tag-modal-body">
                <!-- Token Info -->
                <div style="margin-bottom: 20px; padding: 12px; background: #f3f4f6; border-radius: 8px;">
                    <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                        <strong>Tr·∫°ng th√°i token hi·ªán t·∫°i:</strong>
                    </div>
                    <div id="pancakeTokenInfo" style="font-size: 13px; color: #374151;">
                        ƒêang ki·ªÉm tra...
                    </div>
                </div>

                <!-- Token Input -->
                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: #374151;">
                        JWT Token:
                    </label>
                    <textarea id="pancakeTokenInput"
                        placeholder="Nh·∫≠p JWT token t·ª´ cookie pancake.vn ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ t·ª± ƒë·ªông l·∫•y t·ª´ cookie..."
                        style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                        üí° Token s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o Firebase. N·∫øu ƒë·ªÉ tr·ªëng, h·ªá th·ªëng t·ª± ƒë·ªông l·∫•y t·ª´ cookie pancake.vn (c·∫ßn
                        ƒëƒÉng nh·∫≠p tr∆∞·ªõc).
                    </div>
                </div>

                <!-- Instructions -->
                <div
                    style="padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: #92400e; font-weight: 500; margin-bottom: 8px;">
                        üìã C√°ch l·∫•y JWT token:
                    </div>
                    <ol style="margin: 0; padding-left: 20px; font-size: 12px; color: #92400e;">
                        <li>M·ªü tab m·ªõi: <a href="https://pancake.vn" target="_blank"
                                style="color: #d97706;">https://pancake.vn</a></li>
                        <li>ƒêƒÉng nh·∫≠p v√†o t√†i kho·∫£n Pancake</li>
                        <li>M·ªü DevTools (F12) ‚Üí Console tab</li>
                        <li>G√µ: <code
                                style="background: #fff; padding: 2px 6px; border-radius: 3px;">document.cookie.split(';').find(c => c.includes('jwt'))</code>
                        </li>
                        <li>Copy gi√° tr·ªã sau "jwt=" v√† paste v√†o √¥ tr√™n</li>
                    </ol>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 8px;">
                    <button class="tag-btn-save" onclick="fetchTokenFromCookie()" style="flex: 1; background: #10b981;">
                        <i class="fas fa-sync"></i> L·∫•y t·ª´ Cookie
                    </button>
                    <button class="tag-btn-cancel" onclick="clearPancakeToken()" style="flex: 1; background: #ef4444;">
                        <i class="fas fa-trash"></i> X√≥a Token
                    </button>
                </div>
            </div>
            <div class="tag-modal-footer">
                <button class="tag-btn-cancel" onclick="closePancakeSettingsModal()">
                    ƒê√≥ng
                </button>
                <button class="tag-btn-save" onclick="savePancakeToken()">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
            </div>
        </div>
    </div>

    <!-- Pancake Settings Script -->
    <script>
        // Open Pancake Settings Modal
        async function openPancakeSettingsModal() {
            document.getElementById('pancakeSettingsModal').style.display = 'flex';

            // Load current token info
            if (window.pancakeTokenManager) {
                await window.pancakeTokenManager.initialize();
                const tokenInfo = window.pancakeTokenManager.getTokenInfo();
                const infoDiv = document.getElementById('pancakeTokenInfo');

                if (tokenInfo) {
                    const statusColor = tokenInfo.isExpired ? '#ef4444' : '#10b981';
                    const statusText = tokenInfo.isExpired ? '‚ùå H·∫øt h·∫°n' : '‚úÖ C√≤n h·∫°n';
                    infoDiv.innerHTML = `
                            <div style="margin-bottom: 4px;">
                                <strong>T√™n:</strong> ${tokenInfo.name || 'N/A'}
                            </div>
                            <div style="margin-bottom: 4px;">
                                <strong>User ID:</strong> ${tokenInfo.uid || 'N/A'}
                            </div>
                            <div style="margin-bottom: 4px;">
                                <strong>H·∫øt h·∫°n:</strong> ${tokenInfo.expiryDate}
                            </div>
                            <div style="color: ${statusColor}; font-weight: 500;">
                                <strong>Tr·∫°ng th√°i:</strong> ${statusText}
                            </div>
                        `;
                } else {
                    infoDiv.innerHTML = '<div style="color: #6b7280;">‚ö†Ô∏è Ch∆∞a c√≥ token</div>';
                }
            }
        }

        // Close Pancake Settings Modal
        function closePancakeSettingsModal() {
            document.getElementById('pancakeSettingsModal').style.display = 'none';
            document.getElementById('pancakeTokenInput').value = '';
        }

        // Fetch Token From Cookie
        async function fetchTokenFromCookie() {
            try {
                if (!window.pancakeTokenManager) {
                    throw new Error('PancakeTokenManager not available');
                }

                const token = window.pancakeTokenManager.getTokenFromCookie();
                if (!token) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y JWT token trong cookie. Vui l√≤ng ƒëƒÉng nh·∫≠p v√†o pancake.vn tr∆∞·ªõc.');
                }

                // Show in input
                document.getElementById('pancakeTokenInput').value = token;

                // Save to Firebase
                await window.pancakeTokenManager.saveTokenToFirebase(token);

                if (window.notificationManager) {
                    window.notificationManager.show('‚úÖ ƒê√£ l·∫•y token t·ª´ cookie v√† l∆∞u v√†o Firebase!', 'success');
                } else {
                    alert('‚úÖ ƒê√£ l·∫•y token t·ª´ cookie v√† l∆∞u v√†o Firebase!');
                }

                // Refresh token info
                await openPancakeSettingsModal();

            } catch (error) {
                console.error('[PANCAKE-SETTINGS] Error fetching token:', error);
                if (window.notificationManager) {
                    window.notificationManager.show('‚ùå L·ªói: ' + error.message, 'error');
                } else {
                    alert('‚ùå L·ªói: ' + error.message);
                }
            }
        }

        // Save Pancake Token
        async function savePancakeToken() {
            try {
                const tokenInput = document.getElementById('pancakeTokenInput').value.trim();

                if (!tokenInput) {
                    throw new Error('Vui l√≤ng nh·∫≠p JWT token ho·∫∑c b·∫•m "L·∫•y t·ª´ Cookie"');
                }

                if (!window.pancakeTokenManager) {
                    throw new Error('PancakeTokenManager not available');
                }

                await window.pancakeTokenManager.setTokenManual(tokenInput);

                if (window.notificationManager) {
                    window.notificationManager.show('‚úÖ ƒê√£ l∆∞u token v√†o Firebase!', 'success');
                } else {
                    alert('‚úÖ ƒê√£ l∆∞u token v√†o Firebase!');
                }

                closePancakeSettingsModal();

                // Re-initialize PancakeDataManager
                if (window.pancakeDataManager) {
                    await window.pancakeDataManager.initialize();
                }

            } catch (error) {
                console.error('[PANCAKE-SETTINGS] Error saving token:', error);
                if (window.notificationManager) {
                    window.notificationManager.show('‚ùå L·ªói: ' + error.message, 'error');
                } else {
                    alert('‚ùå L·ªói: ' + error.message);
                }
            }
        }

        // Clear Pancake Token
        async function clearPancakeToken() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a token?')) {
                return;
            }

            try {
                if (!window.pancakeTokenManager) {
                    throw new Error('PancakeTokenManager not available');
                }

                await window.pancakeTokenManager.clearToken();

                if (window.notificationManager) {
                    window.notificationManager.show('‚úÖ ƒê√£ x√≥a token!', 'success');
                } else {
                    alert('‚úÖ ƒê√£ x√≥a token!');
                }

                closePancakeSettingsModal();

            } catch (error) {
                console.error('[PANCAKE-SETTINGS] Error clearing token:', error);
                if (window.notificationManager) {
                    window.notificationManager.show('‚ùå L·ªói: ' + error.message, 'error');
                } else {
                    alert('‚ùå L·ªói: ' + error.message);
                }
            }
        }

        // ====== CHAT API SOURCE TOGGLE ======
        /**
         * Toggle gi·ªØa Pancake API v√† ChatOmni API
         */
        function toggleChatAPISource() {
            if (!window.chatAPISettings) {
                console.error('[CHAT-API-TOGGLE] chatAPISettings not available');
                alert('‚ùå L·ªói: chatAPISettings kh√¥ng kh·∫£ d·ª•ng');
                return;
            }

            // Toggle source
            const newSource = window.chatAPISettings.toggle();
            const displayName = window.chatAPISettings.getDisplayName(newSource);

            console.log(`[CHAT-API-TOGGLE] Switched to: ${displayName}`);

            // Update UI label
            updateChatAPISourceLabel();

            // Show notification
            if (window.notificationManager) {
                window.notificationManager.show(`‚úÖ ƒê√£ chuy·ªÉn sang ${displayName}`, 'success');
            } else {
                alert(`‚úÖ ƒê√£ chuy·ªÉn sang ${displayName}`);
            }

            // Reload table ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu m·ªõi
            if (typeof performSearch === 'function') {
                console.log('[CHAT-API-TOGGLE] Reloading table...');
                performSearch();
            } else {
                console.warn('[CHAT-API-TOGGLE] performSearch function not found, please reload manually');
            }
        }

        /**
         * Update UI label cho button
         */
        function updateChatAPISourceLabel() {
            const label = document.getElementById('chatApiSourceLabel');
            if (!label || !window.chatAPISettings) return;

            const displayName = window.chatAPISettings.getDisplayName();
            label.textContent = displayName;
        }

        // ====== REALTIME TOGGLE ======
        function toggleRealtimeMode(enabled) {
            if (!window.chatAPISettings) {
                console.error('[REALTIME-TOGGLE] chatAPISettings not available');
                return;
            }

            window.chatAPISettings.setRealtimeEnabled(enabled);
            updateRealtimeCheckbox(); // Update UI visibility

            if (window.notificationManager) {
                const status = enabled ? 'B·∫¨T' : 'T·∫ÆT';
                window.notificationManager.show(`‚úÖ Realtime: ${status}`, 'success');
            }
        }

        function changeRealtimeMode(mode) {
            if (!window.chatAPISettings) return;
            window.chatAPISettings.setRealtimeMode(mode);

            if (window.notificationManager) {
                const label = mode === 'browser' ? 'Browser (Tr·ª±c ti·∫øp)' : 'Server (24/7)';
                window.notificationManager.show(`‚úÖ Ch·∫ø ƒë·ªô Realtime: ${label}`, 'success');
            }
        }

        function updateRealtimeCheckbox() {
            const checkbox = document.getElementById('realtimeToggleCheckbox');
            const modeContainer = document.getElementById('realtimeModeContainer');
            const modeSelect = document.getElementById('realtimeModeSelect');

            if (!checkbox || !window.chatAPISettings) return;

            const isEnabled = window.chatAPISettings.isRealtimeEnabled();
            checkbox.checked = isEnabled;

            // Show/Hide mode selector
            if (modeContainer) {
                modeContainer.style.display = isEnabled ? 'block' : 'none';
            }

            // Set current mode
            if (modeSelect) {
                modeSelect.value = window.chatAPISettings.getRealtimeMode();
            }
        }

        // Update label khi page load
        document.addEventListener('DOMContentLoaded', function () {
            updateChatAPISourceLabel();
            updateRealtimeCheckbox();

            // Listen for API source changes from other sources
            window.addEventListener('chatApiSourceChanged', function (e) {
                console.log('[CHAT-API-TOGGLE] API source changed:', e.detail.source);
                updateChatAPISourceLabel();
                updateRealtimeCheckbox();
            });
        });
        // ====================================
    </script>
</body>

</html>