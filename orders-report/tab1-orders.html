<!doctype html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="tab1-orders.css" />
    <link rel="stylesheet" href="message-template-modal.css" />
    <link rel="stylesheet" href="quick-reply-modal.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="decoding-utility.js"></script>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="
                    background: white;
                    padding: 32px;
                    border-radius: 12px;
                    text-align: center;
                ">
            <div class="loading-spinner" style="margin: 0 auto 16px"></div>
            <div class="loading-text" style="font-size: 14px; color: #6b7280">
                ƒêang t·∫£i d·ªØ li·ªáu...
            </div>
        </div>
    </div>
    <!-- Scroll to Top Button -->
    <button class="scroll-to-top" id="scrollToTopBtn">
        <i class="fas fa-arrow-up"></i>
    </button>
    <!-- Main Content -->
    <div class="main-content">
        <!-- Filter Toggle Button -->
        <div style="padding: 10px 20px 0 20px;">
            <button id="toggleControlBarBtn" class="btn-primary" onclick="toggleControlBar()" style="background: #6b7280; padding: 6px 12px; font-size: 13px;">
                <i class="fas fa-sliders-h"></i> Hi·ªÉn th·ªã b·ªô l·ªçc
            </button>
        </div>

        <!-- Filter Section -->
        <div class="filter-section" id="controlBar" style="display: none;">
            <button class="btn-primary" id="employeeSettingsBtn" onclick="toggleEmployeeDrawer()"
                style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)"
                title="C√†i ƒë·∫∑t ph√¢n chia nh√¢n vi√™n">
                <i class="fas fa-users-cog"></i>
                C√†i ƒë·∫∑t ph√¢n chia nh√¢n vi√™n
            </button>
            <label>Kho·∫£ng t·∫£i:</label>
            <select id="skipRangeFilter" style="min-width: 150px">
                <option value="0" selected>3000 ƒë·∫ßu ti√™n</option>
                <option value="3000">3000 ti·∫øp theo</option>
                <option value="6000">3000 th·ª© 3</option>
                <option value="9000">3000 th·ª© 4</option>
                <option value="12000">3000 th·ª© 5</option>
            </select>
            <button class="btn-primary" id="loadCampaignsBtn" style="background: #8b5cf6">
                <i class="fas fa-sync-alt"></i>
                T·∫£i Chi·∫øn D·ªãch
            </button>
            <label>Chi·∫øn d·ªãch Live:</label>
            <select id="campaignFilter" style="min-width: 300px">
                <option value="">ƒêang t·∫£i...</option>
            </select>
            <label>T·ª´ ng√†y:</label>
            <input type="datetime-local" id="startDate" />
            <label>ƒê·∫øn ng√†y:</label>
            <input type="datetime-local" id="endDate" />
            <label>Tr·∫°ng th√°i h·ªôi tho·∫°i:</label>
            <select id="conversationFilter" style="min-width: 150px" onchange="performTableSearch()">
                <option value="all" selected>T·∫•t c·∫£</option>
                <option value="unread">Ch∆∞a ƒë·ªçc</option>
                <option value="read">ƒê√£ ƒë·ªçc</option>
            </select>
            <button class="btn-primary" id="clearCacheBtn" style="background: #ef4444">
                <i class="fas fa-trash"></i>
                X√≥a Cache
            </button>
            <button class="btn-primary" id="pancakeSettingsBtn" onclick="openPancakeSettingsModal()"
                style="background: #8b5cf6">
                <i class="fas fa-cog"></i>
                C√†i ƒë·∫∑t Pancake
            </button>
            <button class="btn-primary" id="chatApiToggleBtn" onclick="toggleChatAPISource()"
                style="background: #3b82f6" title="Ch·ªçn ngu·ªìn API ƒë·ªÉ hi·ªÉn th·ªã tin nh·∫Øn/b√¨nh lu·∫≠n">
                <i class="fas fa-exchange-alt"></i>
                <span id="chatApiSourceLabel">Pancake API</span>
            </button>
            <button class="btn-primary" id="mergeProductsBtn" onclick="executeBulkMergeOrderProducts()"
                style="background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%)"
                title="G·ªôp s·∫£n ph·∫©m t·ª´ c√°c ƒë∆°n c√≥ c√πng SƒêT v√†o ƒë∆°n STT l·ªõn nh·∫•t">
                <i class="fas fa-compress-arrows-alt"></i>
                G·ªôp s·∫£n ph·∫©m ƒë∆°n tr√πng SƒêT
            </button>
            <div
                style="display: flex; align-items: center; gap: 8px; margin-left: 12px; background: #f3f4f6; padding: 4px 8px; border-radius: 8px; border: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <input type="checkbox" id="realtimeToggleCheckbox" onchange="toggleRealtimeMode(this.checked)"
                        style="cursor: pointer; width: 16px; height: 16px;" checked>
                    <label for="realtimeToggleCheckbox"
                        style="cursor: pointer; font-size: 14px; font-weight: 500; color: #374151; user-select: none;">
                        <i class="fas fa-bolt" style="color: #f59e0b; margin-right: 4px;"></i> Realtime
                    </label>
                </div>

                <!-- Mode Switcher (Shown by default with Server 24/7 selected) -->
                <div id="realtimeModeContainer"
                    style="display: block; margin-left: 8px; padding-left: 8px; border-left: 1px solid #d1d5db;">
                    <select id="realtimeModeSelect" onchange="changeRealtimeMode(this.value)"
                        style="padding: 2px 6px; border-radius: 4px; border: 1px solid #d1d5db; font-size: 12px; background: white; cursor: pointer;">
                        <option value="browser">Browser (Direct)</option>
                        <option value="server" selected>Server (24/7)</option>
                        <option value="localhost">Server (Localhost)</option>
                    </select>
                    <button onclick="window.realtimeManager.manualConnect()"
                        style="margin-left: 6px; padding: 2px 8px; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer; font-size: 12px; color: #4b5563;"
                        title="K·∫øt n·ªëi l·∫°i th·ªß c√¥ng">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Buttons Section (New) -->
        <div class="action-buttons-section" style="padding: 16px 24px; display: none; gap: 12px; flex-wrap: wrap;"
            id="actionButtonsSection">
            <div style="display: flex; gap: 8px; align-items: center;">
                <span style="color: #6b7280; font-size: 13px; font-weight: 500;">
                    <span id="selectedOrdersCount">0</span> ƒë∆°n ƒë∆∞·ª£c ch·ªçn
                </span>
            </div>
            <button class="btn-message-action" id="assignEmptyCartTagBtn" style="
                        padding: 10px 20px;
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.2s;
                    "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <i class="fas fa-tags"></i>
                G√°n tag "GI·ªé TR·ªêNG"
            </button>
            <button class="btn-message-action" id="sendMessageBtn" onclick="openMessageTemplateModal()" style="
                        padding: 10px 20px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.2s;
                    "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <i class="fab fa-facebook-messenger"></i>
                G·ª≠i tin nh·∫Øn
            </button>
            <button class="btn-message-action" id="sendOrderConfirmBtn" style="
                        padding: 10px 20px;
                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.2s;
                    "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                <i class="fas fa-paper-plane"></i>
                G·ª≠i l·∫°i tin ch·ªët ƒë∆°n
            </button>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar" id="statsBar" style="display: none">
            <div class="stats-item">
                <div class="stats-value" id="totalOrdersCount">0</div>
                <div class="stats-label">T·ªïng ƒë∆°n h√†ng</div>
                <div class="stats-sublabel" id="mergedOrdersInfo" style="font-size: 11px; color: #9ca3af; margin-top: 4px;">-</div>
            </div>
            <div class="stats-item">
                <div class="stats-value" id="displayedOrdersCount">0</div>
                <div class="stats-label">ƒêang hi·ªÉn th·ªã</div>
            </div>
            <div class="stats-item">
                <div class="stats-value" id="totalAmountSum">0ƒë</div>
                <div class="stats-label">T·ªïng gi√° tr·ªã</div>
            </div>
            <div class="stats-item">
                <div class="stats-value" id="loadingProgress">0%</div>
                <div class="stats-label">Ti·∫øn ƒë·ªô</div>
            </div>
        </div>
        <!-- Info Banner -->
        <div class="info-banner" id="infoBanner" style="display: none">
            <i class="fas fa-info-circle"></i>
            <span id="infoText"></span>
        </div>
        <!-- Search Section -->
        <div class="search-section" id="searchSection">
            <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="tableSearchInput"
                    placeholder="T√¨m ki·∫øm theo m√£ ƒêH, t√™n kh√°ch h√†ng, SƒêT, ƒë·ªãa ch·ªâ, ghi ch√∫, tr·∫°ng th√°i..."
                    autocomplete="off" />
                <button class="search-clear" id="searchClearBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-info">
                <div>
                    <span class="search-result-count" id="searchResultCount">0</span>
                    <span> k·∫øt qu·∫£</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="search-tips">üí° G√µ ƒë·ªÉ t√¨m ki·∫øm nhanh</div>
                    <button class="btn-column-settings" id="columnSettingsBtn" onclick="openColumnSettingsModal()">
                        <i class="fas fa-columns"></i> C√†i ƒë·∫∑t c·ªôt
                    </button>
                </div>
            </div>
        </div>
        <!-- Table Container -->
        <div class="table-container" id="tableContainer" style="display: none">
            <div class="table-wrapper" id="tableWrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" />
                            </th>
                            <th data-column="stt">STT</th>
                            <th data-column="employee" style="width: 90px;">Nh√¢n vi√™n</th>
                            <th data-column="tag">TAG</th>
                            <th data-column="order-code">M√£ ƒêH</th>
                            <th data-column="customer">Kh√°ch h√†ng</th>
                            <th data-column="messages">Tin nh·∫Øn</th>
                            <th data-column="comments">B√¨nh lu·∫≠n</th>
                            <th data-column="phone">SƒêT</th>
                            <th data-column="address">ƒê·ªãa ch·ªâ</th>
                            <th data-column="notes">Ghi ch√∫</th>
                            <th data-column="total">T·ªïng ti·ªÅn</th>
                            <th data-column="quantity">SL</th>
                            <th data-column="created-date">Ng√†y t·∫°o</th>
                            <th data-column="status">Tr·∫°ng th√°i</th>
                            <th data-column="actions">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="16" style="text-align: center; padding: 40px">
                                Vui l√≤ng ch·ªçn chi·∫øn d·ªãch v√† b·∫•m T√¨m ki·∫øm
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Pagination Info -->
            <div class="pagination-wrapper">
                <div id="pageInfo">Hi·ªÉn th·ªã 0 - 0 c·ªßa 0</div>
                <div style="color: #6b7280; font-size: 12px" id="scrollHint"></div>
            </div>
        </div>
    </div>
    <!-- Tag Management Modal -->
    <div class="tag-modal" id="tagModal">
        <div class="tag-modal-content">
            <div class="tag-modal-header">
                <h3><i class="fas fa-tags"></i> Qu·∫£n l√Ω Tag</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="tag-settings-btn" onclick="openTagSettingsModal()" title="C√†i ƒë·∫∑t Tag">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="tag-modal-close" onclick="closeTagModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="tag-modal-body">
                <!-- Search -->
                <div class="tag-search">
                    <div class="tag-search-wrapper">
                        <input type="text" id="tagSearchInput" placeholder="T√¨m ki·∫øm tag..." oninput="filterTags()" />
                        <i class="fas fa-search tag-search-icon"></i>
                    </div>
                </div>
                <!-- Selected Tags -->
                <div class="selected-tags">
                    <span class="selected-tags-label">ƒê√£ ch·ªçn:</span>
                    <div class="selected-tags-list" id="selectedTagsList">
                        <span style="color: #9ca3af; font-size: 12px">
                            Ch∆∞a c√≥ tag n√†o ƒë∆∞·ª£c ch·ªçn
                        </span>
                    </div>
                </div>
                <!-- Tag List -->
                <div class="tag-list" id="tagList">
                    <div class="no-tags-message">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>ƒêang t·∫£i danh s√°ch tag...</p>
                    </div>
                </div>
            </div>
            <div class="tag-modal-footer">
                <button class="tag-btn-cancel" onclick="closeTagModal()">
                    H·ªßy
                </button>
                <button class="tag-btn-save" onclick="saveOrderTags()">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
            </div>
        </div>
    </div>

    <!-- Tag Settings Modal -->
    <div class="tag-modal" id="tagSettingsModal" style="display: none;">
        <div class="tag-modal-content" style="max-width: 700px;">
            <div class="tag-modal-header">
                <h3><i class="fas fa-cog"></i> C√†i ƒë·∫∑t Tag</h3>
                <button class="tag-modal-close" onclick="closeTagSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tag-modal-body">
                <!-- Search -->
                <div class="tag-search">
                    <div class="tag-search-wrapper">
                        <input type="text" id="tagSettingsSearchInput" placeholder="T√¨m ki·∫øm tag..." oninput="filterTagSettings()" />
                        <i class="fas fa-search tag-search-icon"></i>
                    </div>
                </div>

                <!-- Info -->
                <div style="margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
                    <div style="font-size: 13px; color: #1e40af;">
                        <i class="fas fa-info-circle"></i>
                        Nh·∫≠p ghi ch√∫ ho·∫∑c t√™n t√πy ch·ªânh cho m·ªói tag. Th√¥ng tin n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô.
                    </div>
                </div>

                <!-- Tag Settings List -->
                <div class="tag-settings-list" id="tagSettingsList" style="max-height: 400px; overflow-y: auto;">
                    <div class="no-tags-message">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>ƒêang t·∫£i danh s√°ch tag...</p>
                    </div>
                </div>
            </div>
            <div class="tag-modal-footer">
                <button class="tag-btn-cancel" onclick="closeTagSettingsModal()">
                    ƒê√≥ng
                </button>
                <button class="tag-btn-save" onclick="saveTagSettings()">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
            </div>
        </div>
    </div>

    <!-- Column Settings Modal -->
    <div class="column-settings-modal" id="columnSettingsModal">
        <div class="column-settings-modal-content">
            <div class="column-settings-modal-header">
                <h3><i class="fas fa-columns"></i> C√†i ƒë·∫∑t hi·ªÉn th·ªã c·ªôt</h3>
                <button class="column-settings-modal-close" onclick="closeColumnSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="column-settings-modal-body">
                <p style="color: #6b7280; font-size: 13px; margin-bottom: 16px;">
                    Ch·ªçn c√°c c·ªôt b·∫°n mu·ªën hi·ªÉn th·ªã trong b·∫£ng:
                </p>
                <div class="column-settings-list" id="columnSettingsList">
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="stt" checked />
                        <span>STT</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="employee" />
                        <span>Nh√¢n vi√™n</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="tag" checked />
                        <span>TAG</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="order-code" />
                        <span>M√£ ƒë∆°n h√†ng</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="customer" checked />
                        <span>Kh√°ch h√†ng</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="messages" checked />
                        <span>Tin nh·∫Øn</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="comments" checked />
                        <span>B√¨nh lu·∫≠n</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="phone" checked />
                        <span>S·ªë ƒëi·ªán tho·∫°i</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="address" />
                        <span>ƒê·ªãa ch·ªâ</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="notes" />
                        <span>Ghi ch√∫</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="total" checked />
                        <span>T·ªïng ti·ªÅn</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="quantity" checked />
                        <span>S·ªë l∆∞·ª£ng</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="created-date" />
                        <span>Ng√†y t·∫°o</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="status" checked />
                        <span>Tr·∫°ng th√°i</span>
                    </label>
                    <label class="column-setting-item">
                        <input type="checkbox" data-column="actions" checked />
                        <span>Thao t√°c</span>
                    </label>
                </div>
            </div>
            <div class="column-settings-modal-footer">
                <button class="column-settings-btn-reset" onclick="resetColumnSettings()">
                    <i class="fas fa-undo"></i> ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh
                </button>
                <div style="display: flex; gap: 8px;">
                    <button class="column-settings-btn-cancel" onclick="closeColumnSettingsModal()">
                        H·ªßy
                    </button>
                    <button class="column-settings-btn-save" onclick="saveColumnSettings()">
                        <i class="fas fa-save"></i> L∆∞u
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Messages Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-modal-content" style="display: flex; flex-direction: row; max-width: 1000px; width: 95%;">
            <!-- Left Panel: Chat -->
            <div class="chat-left-panel"
                style="flex: 1; display: flex; flex-direction: column; border-right: 1px solid #e5e7eb;">
                <div class="chat-modal-header"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px 24px; border-bottom: none;">
                    <div class="chat-header-info">
                        <h3 id="chatModalTitle"
                            style="color: white; font-size: 18px; font-weight: 600; margin: 0 0 4px 0;">Tin nh·∫Øn v·ªõi
                            Kh√°ch h√†ng</h3>
                        <p id="chatModalSubtitle" style="color: rgba(255, 255, 255, 0.9); font-size: 13px; margin: 0;">
                            ƒêang t·∫£i...</p>
                    </div>
                    <button class="chat-modal-close" onclick="closeChatModal()"
                        style="background: rgba(255, 255, 255, 0.2); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                        onmouseover="this.style.background='rgba(255, 255, 255, 0.3)';"
                        onmouseout="this.style.background='rgba(255, 255, 255, 0.2)';">
                        <i class="fas fa-times" style="color: white; font-size: 16px;"></i>
                    </button>
                </div>
                <div class="chat-modal-body" id="chatModalBody">
                    <div class="chat-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>ƒêang t·∫£i tin nh·∫Øn...</p>
                    </div>
                </div>
                <!-- Reply Input (ch·ªâ hi·ªÉn th·ªã cho comments) -->
                <div class="chat-reply-container" id="chatReplyContainer"
                    style="display: none; background: white; border-top: 1px solid #e5e7eb;">
                    <!-- Input Row -->
                    <div style="display: flex; gap: 8px; align-items: center; padding: 12px 16px;">
                        <input type="text" id="chatReplyInput" placeholder="Nh·∫≠p tin nh·∫Øn tr·∫£ l·ªùi..."
                            style="flex: 1; padding: 10px 14px; border: 1px solid #e5e7eb; border-radius: 20px; font-size: 14px; background: #f9fafb; transition: all 0.2s;"
                            onfocus="this.style.borderColor='#667eea'; this.style.background='white';"
                            onblur="this.style.borderColor='#e5e7eb'; this.style.background='#f9fafb';"
                            onkeypress="if(event.key==='Enter') sendReplyComment();" />
                        <button class="chat-btn-send" id="chatSendBtn" onclick="sendReplyComment()"
                            style="padding: 10px 24px; background: linear-gradient(135deg, #0084ff 0%, #0066cc 100%); color: white; border: none; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0, 132, 255, 0.3);"
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0, 132, 255, 0.4)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 132, 255, 0.3)';">
                            <i class="fas fa-paper-plane"></i>
                            G·ª≠i
                        </button>
                    </div>

                    <!-- Toolbar Row -->
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; padding: 8px 16px 12px 16px; border-top: 1px solid #f3f4f6;">
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <!-- Help Icon -->
                            <button class="toolbar-icon-btn" title="Tr·ª£ gi√∫p"
                                style="background: none; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: #6b7280;"
                                onmouseover="this.style.background='#f3f4f6';"
                                onmouseout="this.style.background='none';">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                    viewBox="0 0 256 256">
                                    <path
                                        d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,168a12,12,0,1,1,12-12A12,12,0,0,1,128,192Zm8-48.72V144a8,8,0,0,1-16,0v-8a8,8,0,0,1,8-8c13.23,0,24-9,24-20s-10.77-20-24-20-24,9-24,20v4a8,8,0,0,1-16,0v-4c0-19.85,17.94-36,40-36s40,16.15,40,36C168,125.38,154.24,139.93,136,143.28Z">
                                    </path>
                                </svg>
                            </button>

                            <!-- Message Template Icon -->
                            <button class="toolbar-icon-btn" title="Tin nh·∫Øn m·∫´u"
                                onclick="openChatTemplateModal()"
                                style="background: none; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: #6b7280;"
                                onmouseover="this.style.background='#f3f4f6';"
                                onmouseout="this.style.background='none';">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                    viewBox="0 0 256 256">
                                    <path
                                        d="M128,24A104,104,0,0,0,36.18,176.88L24.83,210.93a16,16,0,0,0,20.24,20.24l34.05-11.35A104,104,0,1,0,128,24Zm32,128H96a8,8,0,0,1,0-16h64a8,8,0,0,1,0,16Zm0-32H96a8,8,0,0,1,0-16h64a8,8,0,0,1,0,16Z">
                                    </path>
                                </svg>
                            </button>
                        </div>

                        <div style="display: flex; gap: 4px; align-items: center;">
                            <!-- Photo Icon -->
                            <button class="toolbar-icon-btn" title="H√¨nh ·∫£nh"
                                style="background: none; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: #6b7280;"
                                onmouseover="this.style.background='#f3f4f6';"
                                onmouseout="this.style.background='none';">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                    viewBox="0 0 256 256">
                                    <path
                                        d="M216,40H72A16,16,0,0,0,56,56V72H40A16,16,0,0,0,24,88V200a16,16,0,0,0,16,16H184a16,16,0,0,0,16-16V184h16a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40ZM172,72a12,12,0,1,1-12,12A12,12,0,0,1,172,72Zm12,128H40V88H56v80a16,16,0,0,0,16,16H184Zm32-32H72V120.69l30.34-30.35a8,8,0,0,1,11.32,0L163.31,140,189,114.34a8,8,0,0,1,11.31,0L216,130.07V168Z">
                                    </path>
                                </svg>
                            </button>

                            <!-- File Attachment Icon -->
                            <button class="toolbar-icon-btn" title="T·ªáp ƒë√≠nh k√®m"
                                onclick="document.getElementById('uploadFileInput').click();"
                                style="background: none; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: #6b7280;"
                                onmouseover="this.style.background='#f3f4f6';"
                                onmouseout="this.style.background='none';">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                    viewBox="0 0 256 256">
                                    <path
                                        d="M209.66,122.34a8,8,0,0,1,0,11.32l-82.05,82a56,56,0,0,1-79.2-79.21L147.67,35.73a40,40,0,1,1,56.61,56.55L105,193A24,24,0,1,1,71,159L154.3,74.38A8,8,0,1,1,165.7,85.6L82.39,170.31a8,8,0,1,0,11.27,11.36L192.93,81A24,24,0,1,0,159,47L59.76,147.68a40,40,0,1,0,56.53,56.62l82.06-82A8,8,0,0,1,209.66,122.34Z">
                                    </path>
                                </svg>
                            </button>
                            <input id="uploadFileInput" type="file" multiple=""
                                accept="video/*, audio/*, .docx, .doc, .xlsx, .xls, .pdf, .csv, .gif, .text, .pptx, .ppt, image/*"
                                style="display: none;">

                            <!-- Sticker Icon -->
                            <button class="toolbar-icon-btn" title="Sticker"
                                style="background: none; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: #6b7280;"
                                onmouseover="this.style.background='#f3f4f6';"
                                onmouseout="this.style.background='none';">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                    viewBox="0 0 256 256">
                                    <path
                                        d="M168,32H88A56.06,56.06,0,0,0,32,88v80a56.06,56.06,0,0,0,56,56h48a8.07,8.07,0,0,0,2.53-.41c26.23-8.75,76.31-58.83,85.06-85.06A8.07,8.07,0,0,0,224,136V88A56.06,56.06,0,0,0,168,32ZM136,207.42V176a40,40,0,0,1,40-40h31.42C198.16,157.55,157.55,198.16,136,207.42Z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="chat-modal-footer">
                    <button class="chat-btn-close" onclick="closeChatModal()">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                    <button class="chat-btn-mark-read" id="chatMarkReadBtn" onclick="markChatAsRead()"
                        style="display: none;">
                        <i class="fas fa-check"></i> ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
                    </button>
                </div>
            </div>

            <!-- Right Panel: Orders -->
            <div class="chat-right-panel"
                style="flex: 1; display: flex; flex-direction: column; background: #f8fafc; border-left: 1px solid #e2e8f0;">

                <!-- Header -->
                <div class="chat-panel-header" style="
                    padding: 16px 20px;
                    background: white;
                    border-bottom: 1px solid #e2e8f0;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                ">
                    <h3
                        style="font-size: 16px; font-weight: 600; color: #1e293b; margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-shopping-cart" style="color: #3b82f6;"></i>
                        ƒê∆°n h√†ng
                    </h3>
                    <div class="chat-product-count" id="chatProductCountBadge" style="
                        background: #eff6ff;
                        color: #3b82f6;
                        padding: 4px 10px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 600;
                    ">
                        0 s·∫£n ph·∫©m
                    </div>
                </div>

                <!-- Product Search -->
                <div class="chat-product-search-inline" style="padding: 16px; background: white; border-bottom: 1px solid #e2e8f0;">
                    <div class="chat-search-input-wrapper" style="position: relative;">
                        <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 14px;"></i>
                        <input type="text" id="chatInlineProductSearch" placeholder="T√¨m s·∫£n ph·∫©m theo t√™n ho·∫∑c m√£..." autocomplete="off"
                            style="width: 100%; padding: 10px 12px 10px 36px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: all 0.2s; background: #f8fafc;"
                            onfocus="this.style.borderColor='#3b82f6'; this.style.background='white';"
                            onblur="this.style.borderColor='#cbd5e1'; this.style.background='#f8fafc';">
                    </div>
                    <div id="chatInlineSearchResults" class="chat-inline-search-results" style="display: none; margin-top: 8px; max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);"></div>
                </div>

                <!-- Products Table Container -->
                <div style="flex: 1; overflow-y: auto; background: white;">
                    <div id="chatProductsTableContainer" style="padding: 16px;">
                        <!-- Empty State -->
                        <div class="chat-empty-products" style="text-align: center; padding: 40px 20px; color: #94a3b8;">
                            <i class="fas fa-box-open" style="font-size: 40px; margin-bottom: 12px; opacity: 0.5;"></i>
                            <p style="font-size: 14px; margin: 0;">Ch∆∞a c√≥ s·∫£n ph·∫©m</p>
                            <p style="font-size: 12px; margin-top: 4px;">T√¨m ki·∫øm ƒë·ªÉ th√™m s·∫£n ph·∫©m v√†o ƒë∆°n</p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="chat-panel-footer" style="
                    padding: 16px;
                    background: white;
                    border-top: 1px solid #e2e8f0;
                    box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
                ">
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 16px;
                    ">
                        <span style="font-size: 14px; color: #64748b;">T·ªïng ti·ªÅn:</span>
                        <span id="chatProductTotal" style="font-size: 18px; font-weight: 700; color: #3b82f6;">0ƒë</span>
                    </div>
                    <div style="font-size: 12px; color: #94a3b8; text-align: center;">
                        <span id="productCount">0</span> s·∫£n ph·∫©m
                    </div>
                </div>
            </div>


        </div>

        <style>
            /* Tab Buttons */
            .product-tab-btn:hover {
                background: rgba(255, 255, 255, 0.1) !important;
            }

            .product-tab-btn.active:hover {
                background: white !important;
            }

            /* Custom Scrollbar for Product List */
            .chat-product-list::-webkit-scrollbar,
            .chat-product-history::-webkit-scrollbar {
                width: 6px;
            }

            .chat-product-list::-webkit-scrollbar-track,
            .chat-product-history::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 10px;
            }

            .chat-product-list::-webkit-scrollbar-thumb,
            .chat-product-history::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
            }

            .chat-product-list::-webkit-scrollbar-thumb:hover,
            .chat-product-history::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #764ba2 0%, #667eea 100%);
            }

            /* Custom Scrollbar for Products */
            .chat-product-body::-webkit-scrollbar {
                width: 6px;
            }

            .chat-product-body::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }

            .chat-product-body::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
            }

            .chat-product-body::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #764ba2 0%, #667eea 100%);
            }

            /* Product Card Styles */
            .product-card {
                background: white;
                border-radius: 12px;
                padding: 14px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border: 1px solid #e5e7eb;
                position: relative;
                overflow: hidden;
                flex-shrink: 0;
            }

            .product-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 4px;
                height: 100%;
                background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
                opacity: 0;
                transition: opacity 0.3s;
            }

            .product-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 16px rgba(102, 126, 234, 0.15);
                border-color: #667eea;
            }

            .product-card:hover::before {
                opacity: 1;
            }

            .product-card-content {
                display: flex;
                gap: 12px;
                align-items: flex-start;
            }

            .product-image {
                width: 60px;
                height: 60px;
                border-radius: 10px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
            }

            .product-image i {
                font-size: 24px;
                color: white;
            }

            .product-details {
                flex: 1;
                min-width: 0;
            }

            .product-name {
                font-size: 14px;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 6px;
                line-height: 1.4;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .product-meta {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 8px;
                flex-wrap: wrap;
            }

            .product-quantity {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                background: #f3f4f6;
                padding: 4px 10px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 600;
                color: #6b7280;
            }

            .product-price {
                font-size: 15px;
                font-weight: 700;
                color: #667eea;
                white-space: nowrap;
            }

            .product-actions {
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px solid #f3f4f6;
                display: flex;
                gap: 8px;
            }

            .product-action-btn {
                flex: 1;
                padding: 6px 12px;
                border: 1px solid #e5e7eb;
                background: white;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }

            .product-action-btn:hover {
                background: #f9fafb;
                border-color: #667eea;
                color: #667eea;
            }

            .product-action-btn.delete:hover {
                background: #fef2f2;
                border-color: #ef4444;
                color: #ef4444;
            }

            /* Product Suggestions Dropdown */
            .product-suggestions {
                position: absolute;
                top: calc(100% + 4px);
                left: 0;
                right: 0;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                max-height: 300px;
                overflow-y: auto;
                z-index: 1000;
                border: 1px solid #e5e7eb;
            }

            .suggestion-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 10px 14px;
                cursor: pointer;
                transition: background 0.2s;
                border-bottom: 1px solid #f3f4f6;
            }

            .suggestion-item:hover {
                background: #f9fafb;
            }

            .suggestion-item:last-child {
                border-bottom: none;
            }

            .product-suggestions::-webkit-scrollbar {
                width: 6px;
            }

            .product-suggestions::-webkit-scrollbar-track {
                background: #f9fafb;
            }

            .product-suggestions::-webkit-scrollbar-thumb {
                background: #d1d5db;
                border-radius: 3px;
            }

            .product-suggestions::-webkit-scrollbar-thumb:hover {
                background: #9ca3af;
            }

            /* History Item Styles */
            .history-item {
                flex-shrink: 0;
                padding: 12px 14px;
                border-bottom: 1px solid #f3f4f6;
                display: flex;
                align-items: flex-start;
                gap: 12px;
                transition: all 0.2s;
                position: relative;
            }

            .history-item:hover {
                background: #f9fafb;
                border-left: 3px solid;
                padding-left: 11px;
            }

            .history-item:hover .delete-history-btn {
                opacity: 1;
            }

            .delete-history-btn {
                position: absolute;
                top: 8px;
                right: 8px;
                width: 24px;
                height: 24px;
                border: none;
                background: #fee2e2;
                color: #ef4444;
                border-radius: 4px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: all 0.2s;
                font-size: 11px;
            }

            .delete-history-btn:hover {
                background: #ef4444;
                color: white;
            }

            /* Chat Products Table Styles */
            .chat-products-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
                background: white;
            }

            .chat-products-table thead {
                background: #f8fafc;
                border-bottom: 2px solid #e2e8f0;
            }

            .chat-products-table th {
                padding: 12px 8px;
                text-align: left;
                font-weight: 600;
                color: #475569;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .chat-products-table td {
                padding: 12px 8px;
                border-bottom: 1px solid #f1f5f9;
                vertical-align: middle;
            }

            .chat-products-table tbody tr:hover {
                background: #f8fafc;
            }

            .chat-product-row {
                transition: all 0.2s;
            }

            .chat-product-image {
                width: 50px;
                height: 50px;
                object-fit: cover;
                border-radius: 8px;
                border: 1px solid #e2e8f0;
            }

            .chat-quantity-controls {
                display: flex;
                align-items: center;
                gap: 8px;
                justify-content: center;
            }

            .chat-qty-btn {
                width: 28px;
                height: 28px;
                border: 1px solid #cbd5e1;
                background: white;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
                color: #64748b;
            }

            .chat-qty-btn:hover {
                background: #f1f5f9;
                border-color: #3b82f6;
                color: #3b82f6;
            }

            .chat-quantity-input {
                width: 50px;
                text-align: center;
                padding: 6px;
                border: 1px solid #cbd5e1;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
            }

            .chat-note-input {
                width: 100%;
                padding: 6px 8px;
                border: 1px solid #cbd5e1;
                border-radius: 6px;
                font-size: 12px;
                transition: all 0.2s;
            }

            .chat-note-input:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

            .chat-btn-product-action {
                padding: 6px 10px;
                border: 1px solid #cbd5e1;
                background: white;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s;
                color: #64748b;
                font-size: 12px;
            }

            .chat-btn-edit-item:hover {
                background: #eff6ff;
                border-color: #3b82f6;
                color: #3b82f6;
            }

            .chat-btn-delete-item:hover {
                background: #fef2f2;
                border-color: #ef4444;
                color: #ef4444;
            }

            .chat-products-table tfoot {
                background: #f8fafc;
                font-weight: 600;
                border-top: 2px solid #e2e8f0;
            }

            .chat-products-table tfoot td {
                padding: 14px 8px;
                color: #1e293b;
            }

            /* Chat Inline Search Results */
            .chat-inline-search-results {
                scrollbar-width: thin;
                scrollbar-color: #cbd5e1 #f8fafc;
            }

            .chat-inline-search-results::-webkit-scrollbar {
                width: 6px;
            }

            .chat-inline-search-results::-webkit-scrollbar-track {
                background: #f8fafc;
            }

            .chat-inline-search-results::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }

            .chat-search-result-item {
                padding: 12px;
                border-bottom: 1px solid #f1f5f9;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .chat-search-result-item:hover {
                background: #f8fafc;
            }

            .chat-search-result-item:last-child {
                border-bottom: none;
            }

            .chat-search-result-image {
                width: 45px;
                height: 45px;
                object-fit: cover;
                border-radius: 6px;
                border: 1px solid #e2e8f0;
                flex-shrink: 0;
            }

            .chat-search-result-info {
                flex: 1;
                min-width: 0;
            }

            .chat-search-result-name {
                font-size: 13px;
                font-weight: 600;
                color: #1e293b;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .chat-search-result-code {
                font-size: 11px;
                color: #64748b;
            }

            .chat-search-result-price {
                font-size: 13px;
                font-weight: 600;
                color: #3b82f6;
                flex-shrink: 0;
            }

            .chat-search-no-results {
                padding: 20px;
                text-align: center;
                color: #94a3b8;
                font-size: 13px;
            }
        </style>
    </div>
    </div>

    <!-- Scripts -->
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- API Configuration (load first!) -->
    <script src="api-config.js"></script>

    <!-- User Employee Loader -->
    <script src="user-employee-loader.js"></script>

    <script src="token-manager.js"></script>
    <script src="cache.js"></script>
    <script src="auth.js"></script>
    <script src="notification-system.js"></script>
    <script src="pancake-token-manager.js"></script>
    <script src="pancake-data-manager.js"></script>
    <script src="chat-api-settings.js"></script>
    <script src="chat-data-manager.js"></script>
    <script src="message-template-manager.js"></script>
    <script src="quick-reply-manager.js"></script>
    <script src="product-search-manager.js"></script>
    <script src="chat-product-manager.js"></script>
    <script src="chat-modal-products.js"></script>
    <script src="search-functions.js"></script>
    <script src="column-visibility-manager.js"></script>
    <script src="quick-tag-manager.js"></script>
    <script src="realtime-manager.js"></script>
    <script src="debug-realtime.js"></script>
    <script src="tab1-orders.js"></script>

    <!-- Additional Script for Checkbox Handling -->
    <script>
        // Handle checkbox selection
        document.addEventListener('DOMContentLoaded', function () {
            const selectAllCheckbox = document.getElementById('selectAll');

            // Individual checkbox change
            document.addEventListener('change', function (e) {
                if (e.target.matches('tbody input[type="checkbox"]')) {
                    // Call global updateActionButtons from tab1-orders.js
                    if (typeof updateActionButtons === 'function') {
                        updateActionButtons();
                    }

                    // Update select all checkbox state
                    const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    const someChecked = Array.from(checkboxes).some(cb => cb.checked);

                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = allChecked;
                        selectAllCheckbox.indeterminate = someChecked && !allChecked;
                    }
                }
            });
        });

        /**
         * Open quick reply modal for inserting into chat input
         */
        function openChatTemplateModal() {
            console.log('üîî Opening quick reply modal...');

            if (!window.quickReplyManager) {
                console.error('‚ùå QuickReplyManager not initialized');
                if (window.notificationManager) {
                    window.notificationManager.error('H·ªá th·ªëng ch∆∞a s·∫µn s√†ng, vui l√≤ng th·ª≠ l·∫°i');
                }
                return;
            }

            // Open quick reply modal with target input
            window.quickReplyManager.openModal('chatReplyInput');

            console.log('‚úÖ Quick reply modal opened');
        }
    </script>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator">
        <i class="fas fa-check-circle"></i>
        <span id="saveIndicatorText">ƒê√£ l∆∞u th√†nh c√¥ng</span>
    </div>

    <!-- Pancake Settings Modal -->
    <div class="tag-modal" id="pancakeSettingsModal" style="display: none;">
        <div class="tag-modal-content">
            <div class="tag-modal-header">
                <h3><i class="fas fa-cog"></i> C√†i ƒë·∫∑t Pancake JWT Token</h3>
                <button class="tag-modal-close" onclick="closePancakeSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tag-modal-body">
                <!-- Token Info -->
                <div style="margin-bottom: 20px; padding: 12px; background: #f3f4f6; border-radius: 8px;">
                    <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                        <strong>Tr·∫°ng th√°i token hi·ªán t·∫°i:</strong>
                    </div>
                    <div id="pancakeTokenInfo" style="font-size: 13px; color: #374151;">
                        ƒêang ki·ªÉm tra...
                    </div>
                </div>

                <!-- Token Input -->
                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: #374151;">
                        JWT Token:
                    </label>
                    <textarea id="pancakeTokenInput"
                        placeholder="Nh·∫≠p JWT token t·ª´ cookie pancake.vn ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ t·ª± ƒë·ªông l·∫•y t·ª´ cookie..."
                        style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                        üí° Token s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o Firebase. N·∫øu ƒë·ªÉ tr·ªëng, h·ªá th·ªëng t·ª± ƒë·ªông l·∫•y t·ª´ cookie pancake.vn (c·∫ßn
                        ƒëƒÉng nh·∫≠p tr∆∞·ªõc).
                    </div>
                </div>

                <!-- Instructions -->
                <div
                    style="padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: #92400e; font-weight: 500; margin-bottom: 8px;">
                        üìã C√°ch l·∫•y JWT token:
                    </div>
                    <ol style="margin: 0; padding-left: 20px; font-size: 12px; color: #92400e;">
                        <li>M·ªü tab m·ªõi: <a href="https://pancake.vn" target="_blank"
                                style="color: #d97706;">https://pancake.vn</a></li>
                        <li>ƒêƒÉng nh·∫≠p v√†o t√†i kho·∫£n Pancake</li>
                        <li>M·ªü DevTools (F12) ‚Üí Console tab</li>
                        <li>G√µ: <code
                                style="background: #fff; padding: 2px 6px; border-radius: 3px;">document.cookie.split(';').find(c => c.includes('jwt'))</code>
                        </li>
                        <li>Copy gi√° tr·ªã sau "jwt=" v√† paste v√†o √¥ tr√™n</li>
                    </ol>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 8px;">
                    <button class="tag-btn-save" onclick="fetchTokenFromCookie()" style="flex: 1; background: #10b981;">
                        <i class="fas fa-sync"></i> L·∫•y t·ª´ Cookie
                    </button>
                    <button class="tag-btn-cancel" onclick="clearPancakeToken()" style="flex: 1; background: #ef4444;">
                        <i class="fas fa-trash"></i> X√≥a Token
                    </button>
                </div>
            </div>
            <div class="tag-modal-footer">
                <button class="tag-btn-cancel" onclick="closePancakeSettingsModal()">
                    ƒê√≥ng
                </button>
                <button class="tag-btn-save" onclick="savePancakeToken()">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
            </div>
        </div>
    </div>

    <!-- Pancake Settings Script -->
    <script>
        // Open Pancake Settings Modal
        async function openPancakeSettingsModal() {
            document.getElementById('pancakeSettingsModal').style.display = 'flex';

            // Load current token info
            if (window.pancakeTokenManager) {
                await window.pancakeTokenManager.initialize();
                const tokenInfo = window.pancakeTokenManager.getTokenInfo();
                const infoDiv = document.getElementById('pancakeTokenInfo');

                if (tokenInfo) {
                    const statusColor = tokenInfo.isExpired ? '#ef4444' : '#10b981';
                    const statusText = tokenInfo.isExpired ? '‚ùå H·∫øt h·∫°n' : '‚úÖ C√≤n h·∫°n';
                    infoDiv.innerHTML = `
                            <div style="margin-bottom: 4px;">
                                <strong>T√™n:</strong> ${tokenInfo.name || 'N/A'}
                            </div>
                            <div style="margin-bottom: 4px;">
                                <strong>User ID:</strong> ${tokenInfo.uid || 'N/A'}
                            </div>
                            <div style="margin-bottom: 4px;">
                                <strong>H·∫øt h·∫°n:</strong> ${tokenInfo.expiryDate}
                            </div>
                            <div style="color: ${statusColor}; font-weight: 500;">
                                <strong>Tr·∫°ng th√°i:</strong> ${statusText}
                            </div>
                        `;
                } else {
                    infoDiv.innerHTML = '<div style="color: #6b7280;">‚ö†Ô∏è Ch∆∞a c√≥ token</div>';
                }
            }
        }

        // Close Pancake Settings Modal
        function closePancakeSettingsModal() {
            document.getElementById('pancakeSettingsModal').style.display = 'none';
            document.getElementById('pancakeTokenInput').value = '';
        }

        // Fetch Token From Cookie
        async function fetchTokenFromCookie() {
            try {
                if (!window.pancakeTokenManager) {
                    throw new Error('PancakeTokenManager not available');
                }

                const token = window.pancakeTokenManager.getTokenFromCookie();
                if (!token) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y JWT token trong cookie. Vui l√≤ng ƒëƒÉng nh·∫≠p v√†o pancake.vn tr∆∞·ªõc.');
                }

                // Show in input
                document.getElementById('pancakeTokenInput').value = token;

                // Save to Firebase
                await window.pancakeTokenManager.saveTokenToFirebase(token);

                if (window.notificationManager) {
                    window.notificationManager.show('‚úÖ ƒê√£ l·∫•y token t·ª´ cookie v√† l∆∞u v√†o Firebase!', 'success');
                } else {
                    alert('‚úÖ ƒê√£ l·∫•y token t·ª´ cookie v√† l∆∞u v√†o Firebase!');
                }

                // Refresh token info
                await openPancakeSettingsModal();

            } catch (error) {
                console.error('[PANCAKE-SETTINGS] Error fetching token:', error);
                if (window.notificationManager) {
                    window.notificationManager.show('‚ùå L·ªói: ' + error.message, 'error');
                } else {
                    alert('‚ùå L·ªói: ' + error.message);
                }
            }
        }

        // Save Pancake Token
        async function savePancakeToken() {
            try {
                const tokenInput = document.getElementById('pancakeTokenInput').value.trim();

                if (!tokenInput) {
                    throw new Error('Vui l√≤ng nh·∫≠p JWT token ho·∫∑c b·∫•m "L·∫•y t·ª´ Cookie"');
                }

                if (!window.pancakeTokenManager) {
                    throw new Error('PancakeTokenManager not available');
                }

                await window.pancakeTokenManager.setTokenManual(tokenInput);

                if (window.notificationManager) {
                    window.notificationManager.show('‚úÖ ƒê√£ l∆∞u token v√†o Firebase!', 'success');
                } else {
                    alert('‚úÖ ƒê√£ l∆∞u token v√†o Firebase!');
                }

                closePancakeSettingsModal();

                // Re-initialize PancakeDataManager
                if (window.pancakeDataManager) {
                    await window.pancakeDataManager.initialize();
                }

            } catch (error) {
                console.error('[PANCAKE-SETTINGS] Error saving token:', error);
                if (window.notificationManager) {
                    window.notificationManager.show('‚ùå L·ªói: ' + error.message, 'error');
                } else {
                    alert('‚ùå L·ªói: ' + error.message);
                }
            }
        }

        // Clear Pancake Token
        async function clearPancakeToken() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a token?')) {
                return;
            }

            try {
                if (!window.pancakeTokenManager) {
                    throw new Error('PancakeTokenManager not available');
                }

                await window.pancakeTokenManager.clearToken();

                if (window.notificationManager) {
                    window.notificationManager.show('‚úÖ ƒê√£ x√≥a token!', 'success');
                } else {
                    alert('‚úÖ ƒê√£ x√≥a token!');
                }

                closePancakeSettingsModal();

            } catch (error) {
                console.error('[PANCAKE-SETTINGS] Error clearing token:', error);
                if (window.notificationManager) {
                    window.notificationManager.show('‚ùå L·ªói: ' + error.message, 'error');
                } else {
                    alert('‚ùå L·ªói: ' + error.message);
                }
            }
        }

        // ====== TAG SETTINGS ======
        const TAG_SETTINGS_KEY = 'tagSettingsCustomData';

        /**
         * Get tag custom data from localStorage
         */
        function getTagSettings() {
            try {
                const saved = localStorage.getItem(TAG_SETTINGS_KEY);
                return saved ? JSON.parse(saved) : {};
            } catch (error) {
                console.error('[TAG-SETTINGS] Error loading tag settings:', error);
                return {};
            }
        }

        /**
         * Save tag custom data to localStorage
         */
        function setTagSettings(settings) {
            try {
                localStorage.setItem(TAG_SETTINGS_KEY, JSON.stringify(settings));
                console.log('[TAG-SETTINGS] Tag settings saved');
            } catch (error) {
                console.error('[TAG-SETTINGS] Error saving tag settings:', error);
            }
        }

        /**
         * Open tag settings modal
         */
        async function openTagSettingsModal() {
            const modal = document.getElementById('tagSettingsModal');
            modal.style.display = 'flex';

            // Load available tags if not loaded
            if (!window.availableTags || window.availableTags.length === 0) {
                await loadAvailableTags();
            }

            // Render tag settings list
            renderTagSettingsList();
        }

        /**
         * Close tag settings modal
         */
        function closeTagSettingsModal() {
            document.getElementById('tagSettingsModal').style.display = 'none';
            document.getElementById('tagSettingsSearchInput').value = '';
        }

        /**
         * Render tag settings list
         */
        function renderTagSettingsList(filteredTags = null) {
            const listContainer = document.getElementById('tagSettingsList');
            if (!listContainer) return;

            const tags = filteredTags || window.availableTags || [];
            const settings = getTagSettings();

            if (tags.length === 0) {
                listContainer.innerHTML = `
                    <div class="no-tags-message">
                        <i class="fas fa-info-circle"></i>
                        <p>Kh√¥ng t√¨m th·∫•y tag n√†o</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = tags.map(tag => {
                const customValue = settings[tag.Id] || '';
                const hasSavedValue = customValue !== '';
                return `
                    <div class="tag-settings-item" data-tag-id="${tag.Id}">
                        <div class="tag-settings-color" style="background-color: ${tag.Color || '#6b7280'}"></div>
                        <div class="tag-settings-name">${tag.Name}</div>
                        <input
                            type="text"
                            class="tag-settings-input"
                            id="tagInput_${tag.Id}"
                            data-tag-id="${tag.Id}"
                            value="${customValue}"
                            placeholder="Nh·∫≠p ghi ch√∫..."
                        />
                        <button
                            class="tag-settings-save-btn"
                            onclick="saveTagSettingItem('${tag.Id}')"
                            title="L∆∞u ghi ch√∫">
                            <i class="fas fa-save"></i> L∆∞u
                        </button>
                        ${hasSavedValue ? `<div class="tag-settings-saved-badge" id="savedBadge_${tag.Id}"><i class="fas fa-check"></i></div>` : ''}
                    </div>
                `;
            }).join('');
        }

        /**
         * Filter tag settings based on search input
         */
        function filterTagSettings() {
            const searchTerm = document.getElementById('tagSettingsSearchInput').value.toLowerCase().trim();

            if (!window.availableTags) return;

            if (!searchTerm) {
                renderTagSettingsList();
                return;
            }

            const filtered = window.availableTags.filter(tag =>
                tag.Name.toLowerCase().includes(searchTerm)
            );

            renderTagSettingsList(filtered);
        }

        /**
         * Save individual tag setting
         */
        function saveTagSettingItem(tagId) {
            const input = document.getElementById(`tagInput_${tagId}`);
            if (!input) return;

            const value = input.value.trim();
            const settings = getTagSettings();

            if (value) {
                settings[tagId] = value;
            } else {
                delete settings[tagId];
            }

            setTagSettings(settings);

            // Show saved badge
            let badge = document.getElementById(`savedBadge_${tagId}`);
            if (value && !badge) {
                const item = input.closest('.tag-settings-item');
                badge = document.createElement('div');
                badge.className = 'tag-settings-saved-badge';
                badge.id = `savedBadge_${tagId}`;
                badge.innerHTML = '<i class="fas fa-check"></i>';
                item.appendChild(badge);
            } else if (!value && badge) {
                badge.remove();
            }

            // Show notification
            if (window.notificationManager) {
                window.notificationManager.show('‚úÖ ƒê√£ l∆∞u!', 'success');
            }
        }

        /**
         * Save all tag settings (for footer Save button)
         */
        function saveTagSettings() {
            const inputs = document.querySelectorAll('.tag-settings-input');
            const settings = getTagSettings();

            inputs.forEach(input => {
                const tagId = input.dataset.tagId;
                const value = input.value.trim();

                if (value) {
                    settings[tagId] = value;
                } else {
                    delete settings[tagId];
                }
            });

            setTagSettings(settings);

            if (window.notificationManager) {
                window.notificationManager.show('‚úÖ ƒê√£ l∆∞u t·∫•t c·∫£ c√†i ƒë·∫∑t tag!', 'success');
            } else {
                alert('‚úÖ ƒê√£ l∆∞u t·∫•t c·∫£ c√†i ƒë·∫∑t tag!');
            }

            closeTagSettingsModal();
        }

        // ====== CHAT API SOURCE TOGGLE ======
        /**
         * Toggle gi·ªØa Pancake API v√† ChatOmni API
         */
        function toggleChatAPISource() {
            if (!window.chatAPISettings) {
                console.error('[CHAT-API-TOGGLE] chatAPISettings not available');
                alert('‚ùå L·ªói: chatAPISettings kh√¥ng kh·∫£ d·ª•ng');
                return;
            }

            // Toggle source
            const newSource = window.chatAPISettings.toggle();
            const displayName = window.chatAPISettings.getDisplayName(newSource);

            console.log(`[CHAT-API-TOGGLE] Switched to: ${displayName}`);

            // Update UI label
            updateChatAPISourceLabel();

            // Show notification
            if (window.notificationManager) {
                window.notificationManager.show(`‚úÖ ƒê√£ chuy·ªÉn sang ${displayName}`, 'success');
            } else {
                alert(`‚úÖ ƒê√£ chuy·ªÉn sang ${displayName}`);
            }

            // Reload table ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu m·ªõi
            if (typeof performSearch === 'function') {
                console.log('[CHAT-API-TOGGLE] Reloading table...');
                performSearch();
            } else {
                console.warn('[CHAT-API-TOGGLE] performSearch function not found, please reload manually');
            }
        }

        /**
         * Update UI label cho button
         */
        function updateChatAPISourceLabel() {
            const label = document.getElementById('chatApiSourceLabel');
            if (!label || !window.chatAPISettings) return;

            const displayName = window.chatAPISettings.getDisplayName();
            label.textContent = displayName;
        }

        // ====== REALTIME TOGGLE ======
        function toggleRealtimeMode(enabled) {
            if (!window.chatAPISettings) {
                console.error('[REALTIME-TOGGLE] chatAPISettings not available');
                return;
            }

            window.chatAPISettings.setRealtimeEnabled(enabled);
            updateRealtimeCheckbox(); // Update UI visibility

            if (window.notificationManager) {
                const status = enabled ? 'B·∫¨T' : 'T·∫ÆT';
                window.notificationManager.show(`‚úÖ Realtime: ${status}`, 'success');
            }
        }

        function changeRealtimeMode(mode) {
            if (!window.chatAPISettings) return;
            window.chatAPISettings.setRealtimeMode(mode);

            if (window.notificationManager) {
                const label = mode === 'browser' ? 'Browser (Tr·ª±c ti·∫øp)' : 'Server (24/7)';
                window.notificationManager.show(`‚úÖ Ch·∫ø ƒë·ªô Realtime: ${label}`, 'success');
            }
        }

        function updateRealtimeCheckbox() {
            const checkbox = document.getElementById('realtimeToggleCheckbox');
            const modeContainer = document.getElementById('realtimeModeContainer');
            const modeSelect = document.getElementById('realtimeModeSelect');

            if (!checkbox || !window.chatAPISettings) return;

            const isEnabled = window.chatAPISettings.isRealtimeEnabled();
            checkbox.checked = isEnabled;

            // Show/Hide mode selector
            if (modeContainer) {
                modeContainer.style.display = isEnabled ? 'block' : 'none';
            }

            // Set current mode
            if (modeSelect) {
                modeSelect.value = window.chatAPISettings.getRealtimeMode();
            }
        }

        // Update label khi page load
        document.addEventListener('DOMContentLoaded', function () {
            updateChatAPISourceLabel();
            updateRealtimeCheckbox();

            // Listen for API source changes from other sources
            window.addEventListener('chatApiSourceChanged', function (e) {
                console.log('[CHAT-API-TOGGLE] API source changed:', e.detail.source);
                updateChatAPISourceLabel();
                updateRealtimeCheckbox();
            });
        });
        // ====================================
    </script>

    <!-- Employee Assignment Drawer -->
    <div class="employee-drawer-overlay" id="employeeDrawerOverlay" onclick="toggleEmployeeDrawer()"></div>
    <div class="employee-drawer" id="employeeDrawer">
        <div class="employee-drawer-header">
            <h3>
                <i class="fas fa-users-cog"></i>
                C√†i ƒë·∫∑t ph√¢n chia nh√¢n vi√™n
            </h3>
            <button class="employee-drawer-close" onclick="toggleEmployeeDrawer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="employee-drawer-body">
            <div id="employeeAssignmentTable"
                style="max-height: calc(100vh - 200px); overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 16px;">
                <table style="width: 100%; font-size: 13px;">
                    <thead
                        style="position: sticky; top: 0; background: #f8f9fa; border-bottom: 1px solid #e5e7eb; z-index: 1;">
                        <tr>
                            <th style="padding: 8px; text-align: left; font-weight: 600;">Nh√¢n vi√™n</th>
                            <th style="padding: 8px; text-align: center; width: 100px; font-weight: 600;">STT T·ª´</th>
                            <th style="padding: 8px; text-align: center; width: 100px; font-weight: 600;">STT ƒê·∫øn</th>
                        </tr>
                    </thead>
                    <tbody id="employeeAssignmentBody">
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 20px; color: #9ca3af;">
                                <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i danh s√°ch nh√¢n vi√™n...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="employee-input-help" style="margin-bottom: 16px;">
                <i class="fas fa-info-circle"></i>
                Nh·∫≠p kho·∫£ng STT cho t·ª´ng nh√¢n vi√™n. D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông khi b·∫•m "√Åp d·ª•ng".
            </div>
        </div>
        <div class="employee-drawer-footer">
            <button class="btn-secondary" onclick="toggleEmployeeDrawer()">
                <i class="fas fa-times"></i> ƒê√≥ng
            </button>
            <button class="btn-primary" onclick="applyEmployeeRanges()">
                <i class="fas fa-check"></i> √Åp d·ª•ng
            </button>
        </div>
    </div>
</body>

</html>