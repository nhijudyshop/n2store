<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Quản lý đơn hàng</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    "Helvetica Neue", Arial, sans-serif;
                font-size: 13px;
                color: #333;
                background-color: #f5f5f5;
            }

            .main-content {
                padding: 16px 24px;
            }

            .content-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                background: white;
                padding: 16px;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .content-actions {
                display: flex;
                gap: 12px;
                align-items: center;
                flex-wrap: wrap;
            }

            .filter-section {
                background: white;
                padding: 16px;
                border-radius: 8px;
                margin-bottom: 16px;
                display: flex;
                gap: 12px;
                align-items: center;
                flex-wrap: wrap;
            }

            .filter-section label {
                font-size: 13px;
                font-weight: 500;
                color: #6b7280;
                margin: 0;
            }

            .filter-section input,
            .filter-section select {
                padding: 6px 10px;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                font-size: 13px;
            }

            .btn-primary {
                padding: 6px 16px;
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 13px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .btn-primary:hover {
                background: #2563eb;
            }

            .table-container {
                background: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .table-wrapper {
                overflow-x: auto;
                max-height: 70vh;
                overflow-y: auto;
                position: relative;
            }

            .table {
                width: 100%;
                border-collapse: collapse;
                font-size: 12px;
                white-space: nowrap;
            }

            .table th {
                background: #f9fafb;
                padding: 12px 8px;
                text-align: left;
                font-weight: 600;
                color: #374151;
                border-bottom: 2px solid #e5e7eb;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .table td {
                padding: 10px 8px;
                border-bottom: 1px solid #f3f4f6;
            }

            .table tbody tr:hover {
                background: #f9fafb;
            }

            /* Column width control */
            .table th:nth-child(3),
            .table td:nth-child(3) {
                max-width: 120px;
                width: 120px;
            }

            /* Phone number column - smaller */
            .table th:nth-child(6),
            .table td:nth-child(6) {
                max-width: 100px;
                width: 100px;
            }

            /* Address column - larger */
            .table th:nth-child(7),
            .table td:nth-child(7) {
                max-width: 500px;
                width: 500px;
            }

            .status-badge {
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 500;
            }

            .status-draft {
                background: #dbeafe;
                color: #1e40af;
            }

            .status-order {
                background: #d1fae5;
                color: #065f46;
            }

            .order-tag {
                display: inline-block;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 10px;
                font-weight: 500;
                margin-top: 4px;
                color: white;
            }

            .partner-status {
                display: inline-block;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 10px;
                font-weight: 500;
                margin-top: 4px;
                color: white;
            }

            .pagination-wrapper {
                padding: 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: white;
                border-top: 1px solid #e5e7eb;
            }

            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            }

            .loading-overlay.show {
                display: flex;
            }

            .loading-spinner {
                width: 48px;
                height: 48px;
                border: 4px solid #f3f4f6;
                border-top-color: #3b82f6;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .info-banner {
                background: #eff6ff;
                border: 1px solid #bfdbfe;
                border-radius: 8px;
                padding: 12px 16px;
                margin-bottom: 16px;
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 13px;
            }

            .info-banner i {
                color: #3b82f6;
            }

            .loading-more-indicator {
                text-align: center;
                padding: 20px;
                color: #6b7280;
            }

            .loading-more-indicator .spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 2px solid #e5e7eb;
                border-top-color: #3b82f6;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
                margin-right: 8px;
            }

            .stats-bar {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                margin-bottom: 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .stats-item {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .stats-value {
                font-size: 24px;
                font-weight: 700;
            }

            .stats-label {
                font-size: 11px;
                opacity: 0.9;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .scroll-to-top {
                position: fixed;
                bottom: 24px;
                right: 24px;
                width: 48px;
                height: 48px;
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 50%;
                cursor: pointer;
                display: none;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                transition: all 0.3s;
                z-index: 1000;
            }

            .scroll-to-top.show {
                display: flex;
            }

            .scroll-to-top:hover {
                background: #2563eb;
                transform: translateY(-4px);
                box-shadow: 0 8px 16px rgba(59, 130, 246, 0.5);
            }

            /* ===== TAG MANAGEMENT STYLES ===== */
            .tag-icon-btn {
                background: none;
                border: none;
                padding: 4px 8px;
                cursor: pointer;
                color: #6b7280;
                border-radius: 4px;
                transition: all 0.2s;
            }

            .tag-icon-btn:hover {
                background: #f3f4f6;
                color: #3b82f6;
            }

            .tag-icon-btn i {
                font-size: 14px;
            }

            .tag-count {
                display: inline-block;
                background: #3b82f6;
                color: white;
                font-size: 10px;
                padding: 2px 6px;
                border-radius: 10px;
                margin-left: 4px;
                min-width: 18px;
                text-align: center;
            }

            /* Tag Modal */
            .tag-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.2s;
            }

            .tag-modal.show {
                display: flex;
            }

            .tag-modal-content {
                background: white;
                border-radius: 12px;
                width: 90%;
                max-width: 700px;
                max-height: 80vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
                animation: slideUp 0.3s ease-out;
            }

            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .tag-modal-header {
                padding: 20px 24px;
                border-bottom: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .tag-modal-header h3 {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
                color: #111827;
            }

            .tag-modal-close {
                background: none;
                border: none;
                font-size: 24px;
                color: #6b7280;
                cursor: pointer;
                padding: 0;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 6px;
                transition: all 0.2s;
            }

            .tag-modal-close:hover {
                background: #f3f4f6;
                color: #111827;
            }

            .tag-modal-body {
                padding: 24px;
                overflow-y: auto;
                flex: 1;
            }

            .tag-search {
                margin-bottom: 20px;
            }

            .tag-search input {
                width: 100%;
                padding: 10px 40px 10px 12px;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                font-size: 14px;
                transition: all 0.2s;
            }

            .tag-search input:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

            .tag-search-wrapper {
                position: relative;
            }

            .tag-search-icon {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
                pointer-events: none;
            }

            .selected-tags {
                margin-bottom: 20px;
                padding: 12px;
                background: #f9fafb;
                border-radius: 8px;
                min-height: 50px;
            }

            .selected-tags-label {
                font-size: 12px;
                font-weight: 600;
                color: #6b7280;
                margin-bottom: 8px;
                display: block;
            }

            .selected-tags-list {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }

            .selected-tag-item {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 500;
                color: white;
            }

            .selected-tag-remove {
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                padding: 0;
                width: 16px;
                height: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.2s;
            }

            .selected-tag-remove:hover {
                background: rgba(0, 0, 0, 0.2);
            }

            .tag-list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 8px;
            }

            .tag-item {
                display: flex;
                align-items: center;
                padding: 10px 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s;
                background: white;
            }

            .tag-item:hover {
                border-color: #3b82f6;
                background: #f9fafb;
            }

            .tag-item.selected {
                border-color: #3b82f6;
                background: #eff6ff;
            }

            .tag-item-checkbox {
                margin-right: 10px;
                width: 18px;
                height: 18px;
                cursor: pointer;
            }

            .tag-item-color {
                width: 20px;
                height: 20px;
                border-radius: 4px;
                margin-right: 10px;
                flex-shrink: 0;
                border: 1px solid rgba(0, 0, 0, 0.1);
            }

            .tag-item-name {
                flex: 1;
                font-size: 13px;
                font-weight: 500;
                color: #374151;
            }

            .tag-modal-footer {
                padding: 16px 24px;
                border-top: 1px solid #e5e7eb;
                display: flex;
                justify-content: flex-end;
                gap: 12px;
            }

            .tag-modal-footer button {
                padding: 8px 20px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }

            .tag-btn-cancel {
                background: white;
                border: 1px solid #e5e7eb;
                color: #374151;
            }

            .tag-btn-cancel:hover {
                background: #f9fafb;
            }

            .tag-btn-save {
                background: #3b82f6;
                border: none;
                color: white;
            }

            .tag-btn-save:hover {
                background: #2563eb;
            }

            .no-tags-message {
                text-align: center;
                padding: 40px 20px;
                color: #9ca3af;
            }

            .no-tags-message i {
                font-size: 48px;
                margin-bottom: 12px;
                display: block;
            }
        </style>
    </head>

    <body>
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div
                style="
                    background: white;
                    padding: 32px;
                    border-radius: 12px;
                    text-align: center;
                "
            >
                <div class="loading-spinner" style="margin: 0 auto 16px"></div>
                <div
                    class="loading-text"
                    style="font-size: 14px; color: #6b7280"
                >
                    Đang tải dữ liệu...
                </div>
            </div>
        </div>

        <!-- Scroll to Top Button -->
        <button class="scroll-to-top" id="scrollToTopBtn">
            <i class="fas fa-arrow-up"></i>
        </button>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Filter Section -->
            <div class="filter-section">
                <label>Chiến dịch Live:</label>
                <select id="campaignFilter" style="min-width: 300px">
                    <option value="">Đang tải...</option>
                </select>

                <label>Từ ngày:</label>
                <input type="datetime-local" id="startDate" />

                <label>Đến ngày:</label>
                <input type="datetime-local" id="endDate" />

                <button class="btn-primary" id="searchBtn">
                    <i class="fas fa-search"></i>
                    Tìm kiếm
                </button>

                <button
                    class="btn-primary"
                    id="clearCacheBtn"
                    style="background: #ef4444"
                >
                    <i class="fas fa-trash"></i>
                    Xóa Cache
                </button>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar" id="statsBar" style="display: none">
                <div class="stats-item">
                    <div class="stats-value" id="totalOrdersCount">0</div>
                    <div class="stats-label">Tổng đơn hàng</div>
                </div>
                <div class="stats-item">
                    <div class="stats-value" id="displayedOrdersCount">0</div>
                    <div class="stats-label">Đang hiển thị</div>
                </div>
                <div class="stats-item">
                    <div class="stats-value" id="totalAmountSum">0đ</div>
                    <div class="stats-label">Tổng giá trị</div>
                </div>
                <div class="stats-item">
                    <div class="stats-value" id="loadingProgress">0%</div>
                    <div class="stats-label">Tiến độ</div>
                </div>
            </div>

            <!-- Info Banner -->
            <div class="info-banner" id="infoBanner" style="display: none">
                <i class="fas fa-info-circle"></i>
                <span id="infoText"></span>
            </div>

            <!-- Table Container -->
            <div class="table-container" id="tableContainer" style="display: none">
                <div class="table-wrapper" id="tableWrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" />
                                </th>
                                <th>STT</th>
                                <th>Mã ĐH</th>
                                <th>Khách hàng</th>
                                <th>SĐT</th>
                                <th>Địa chỉ</th>
                                <th>Ghi chú</th>
                                <th>Tổng tiền</th>
                                <th>SL</th>
                                <th>Ngày tạo</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td
                                    colspan="11"
                                    style="text-align: center; padding: 40px"
                                >
                                    Vui lòng chọn chiến dịch và bấm Tìm kiếm
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Info -->
                <div class="pagination-wrapper">
                    <div id="pageInfo">Hiển thị 0 - 0 của 0</div>
                    <div
                        style="color: #6b7280; font-size: 12px"
                        id="scrollHint"
                    ></div>
                </div>
            </div>
        </div>

        <!-- Tag Management Modal -->
        <div class="tag-modal" id="tagModal">
            <div class="tag-modal-content">
                <div class="tag-modal-header">
                    <h3>
                        <i class="fas fa-tags"></i> Quản lý Tag
                    </h3>
                    <button class="tag-modal-close" onclick="closeTagModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="tag-modal-body">
                    <!-- Search -->
                    <div class="tag-search">
                        <div class="tag-search-wrapper">
                            <input
                                type="text"
                                id="tagSearchInput"
                                placeholder="Tìm kiếm tag..."
                                oninput="filterTags()"
                            />
                            <i class="fas fa-search tag-search-icon"></i>
                        </div>
                    </div>

                    <!-- Selected Tags -->
                    <div class="selected-tags">
                        <span class="selected-tags-label">Đã chọn:</span>
                        <div class="selected-tags-list" id="selectedTagsList">
                            <span style="color: #9ca3af; font-size: 12px">
                                Chưa có tag nào được chọn
                            </span>
                        </div>
                    </div>

                    <!-- Tag List -->
                    <div class="tag-list" id="tagList">
                        <div class="no-tags-message">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Đang tải danh sách tag...</p>
                        </div>
                    </div>
                </div>
                <div class="tag-modal-footer">
                    <button class="tag-btn-cancel" onclick="closeTagModal()">
                        Hủy
                    </button>
                    <button class="tag-btn-save" onclick="saveOrderTags()">
                        <i class="fas fa-save"></i> Lưu
                    </button>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script src="token-manager.js"></script>
        <script src="cache.js"></script>
        <script src="auth.js"></script>

        <script>
            // =====================================================
            // GLOBAL VARIABLES
            // =====================================================
            let allData = [];
            let filteredData = [];
            let displayedData = [];
            // Removed lazy loading constants - render all data at once
            let totalCount = 0;
            let selectedCampaign = null;

            // Tag Management State
            let availableTags = [];
            let currentEditingOrderId = null;
            let currentOrderTags = [];

            // =====================================================
            // INITIALIZATION
            // =====================================================
            window.addEventListener("DOMContentLoaded", async function () {
                console.log("[CACHE] Clearing all cache on page load...");
                if (window.cacheManager) {
                    window.cacheManager.clear("orders");
                    window.cacheManager.clear("campaigns");
                }

                await loadCampaignList();

                // Set default dates (last 30 days)
                const now = new Date();
                const thirtyDaysAgo = new Date(
                    now.getTime() - 30 * 24 * 60 * 60 * 1000,
                );
                document.getElementById("endDate").value =
                    formatDateTimeLocal(now);
                document.getElementById("startDate").value =
                    formatDateTimeLocal(thirtyDaysAgo);

                // Event listeners
                document
                    .getElementById("searchBtn")
                    .addEventListener("click", handleSearch);
                document
                    .getElementById("clearCacheBtn")
                    .addEventListener("click", handleClearCache);
                document
                    .getElementById("selectAll")
                    .addEventListener("change", handleSelectAll);
                document
                    .getElementById("campaignFilter")
                    .addEventListener("change", handleCampaignChange);

                // Scroll to top button
                const scrollBtn = document.getElementById("scrollToTopBtn");
                const tableWrapper = document.getElementById("tableWrapper");

                tableWrapper.addEventListener("scroll", function () {
                    if (tableWrapper.scrollTop > 300) {
                        scrollBtn.classList.add("show");
                    } else {
                        scrollBtn.classList.remove("show");
                    }
                });

                scrollBtn.addEventListener("click", function () {
                    tableWrapper.scrollTo({ top: 0, behavior: "smooth" });
                });

                // Load tags
                await loadAvailableTags();
            });

            // =====================================================
            // TAG MANAGEMENT FUNCTIONS
            // =====================================================
            async function loadAvailableTags() {
                try {
                    // Check cache first
                    const cached = window.cacheManager.get('tags', 'tags');
                    if (cached) {
                        console.log('[TAG] Using cached tags');
                        availableTags = cached;
                        return;
                    }

                    console.log('[TAG] Loading tags from API...');
                    const headers = await window.tokenManager.getAuthHeader();
                    
                    const response = await fetch('https://tomato.tpos.vn/odata/Tag?$top=320&$count=true', {
                        method: 'GET',
                        headers: {
                            ...headers,
                            'accept': 'application/json',
                            'content-type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    availableTags = data.value || [];
                    
                    // Cache tags for 24 hours
                    window.cacheManager.set('tags', availableTags, 'tags');
                    
                    console.log(`[TAG] Loaded ${availableTags.length} tags from API`);
                } catch (error) {
                    console.error('[TAG] Error loading tags:', error);
                    availableTags = [];
                }
            }

            function openTagModal(orderId, orderCode) {
                // orderId is now a string (GUID)
                currentEditingOrderId = orderId;
                
                // Find order and get its current tags
                const order = allData.find(o => o.Id === orderId);
                if (order && order.Tags) {
                    try {
                        currentOrderTags = JSON.parse(order.Tags);
                    } catch (error) {
                        currentOrderTags = [];
                    }
                } else {
                    currentOrderTags = [];
                }

                // Update modal title
                document.querySelector('.tag-modal-header h3').innerHTML = 
                    `<i class="fas fa-tags"></i> Quản lý Tag - ${orderCode}`;

                // Render tag list
                renderTagList();
                updateSelectedTagsDisplay();

                // Show modal
                document.getElementById('tagModal').classList.add('show');
            }

            function closeTagModal() {
                document.getElementById('tagModal').classList.remove('show');
                document.getElementById('tagSearchInput').value = '';
                currentEditingOrderId = null;
                currentOrderTags = [];
            }

            function renderTagList(searchQuery = '') {
                const tagList = document.getElementById('tagList');
                
                if (availableTags.length === 0) {
                    tagList.innerHTML = `
                        <div class="no-tags-message">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Không có tag nào</p>
                        </div>
                    `;
                    return;
                }

                // Filter tags based on search
                const filteredTags = availableTags.filter(tag => {
                    if (!searchQuery) return true;
                    const query = searchQuery.toLowerCase();
                    return tag.Name.toLowerCase().includes(query) ||
                           tag.NameNosign.toLowerCase().includes(query);
                });

                if (filteredTags.length === 0) {
                    tagList.innerHTML = `
                        <div class="no-tags-message">
                            <i class="fas fa-search"></i>
                            <p>Không tìm thấy tag phù hợp</p>
                        </div>
                    `;
                    return;
                }

                // Render tags
                tagList.innerHTML = filteredTags.map(tag => {
                    const isSelected = currentOrderTags.some(t => t.Id === tag.Id);
                    return `
                        <div class="tag-item ${isSelected ? 'selected' : ''}" 
                             onclick="toggleTag(${tag.Id})"
                             data-tag-id="${tag.Id}">
                            <input type="checkbox" 
                                   class="tag-item-checkbox" 
                                   ${isSelected ? 'checked' : ''}
                                   onclick="event.stopPropagation(); toggleTag(${tag.Id})">
                            <div class="tag-item-color" style="background-color: ${tag.Color}"></div>
                            <div class="tag-item-name">${tag.Name}</div>
                        </div>
                    `;
                }).join('');
            }

            function toggleTag(tagId) {
                const tag = availableTags.find(t => t.Id === tagId);
                if (!tag) return;

                const existingIndex = currentOrderTags.findIndex(t => t.Id === tagId);
                
                if (existingIndex >= 0) {
                    // Remove tag
                    currentOrderTags.splice(existingIndex, 1);
                } else {
                    // Add tag
                    currentOrderTags.push({
                        Id: tag.Id,
                        Name: tag.Name,
                        Color: tag.Color
                    });
                }

                // Update displays
                updateSelectedTagsDisplay();
                
                // Update tag item appearance
                const tagItem = document.querySelector(`[data-tag-id="${tagId}"]`);
                if (tagItem) {
                    tagItem.classList.toggle('selected');
                    const checkbox = tagItem.querySelector('.tag-item-checkbox');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                }
            }

            function updateSelectedTagsDisplay() {
                const container = document.getElementById('selectedTagsList');
                
                if (currentOrderTags.length === 0) {
                    container.innerHTML = '<span style="color: #9ca3af; font-size: 12px">Chưa có tag nào được chọn</span>';
                    return;
                }

                container.innerHTML = currentOrderTags.map(tag => `
                    <span class="selected-tag-item" style="background-color: ${tag.Color}">
                        ${tag.Name}
                        <button class="selected-tag-remove" onclick="event.stopPropagation(); toggleTag(${tag.Id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>
                `).join('');
            }

            function filterTags() {
                const searchQuery = document.getElementById('tagSearchInput').value;
                renderTagList(searchQuery);
            }

            async function saveOrderTags() {
                if (!currentEditingOrderId) return;

                try {
                    showLoading(true);

                    // Convert tags to JSON string
                    const tagsJson = JSON.stringify(currentOrderTags);

                    // Update via API - wrap GUID in single quotes for OData
                    const headers = await window.tokenManager.getAuthHeader();
                    const response = await fetch(`https://tomato.tpos.vn/odata/SaleOnline_Order('${currentEditingOrderId}')`, {
                        method: 'PATCH',
                        headers: {
                            ...headers,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            Tags: tagsJson
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    // Update local data
                    const order = allData.find(o => o.Id === currentEditingOrderId);
                    if (order) {
                        order.Tags = tagsJson;
                    }

                    // Refresh display
                    renderTable();
                    
                    // Clear cache
                    if (window.cacheManager) {
                        window.cacheManager.clear('orders');
                    }

                    showLoading(false);
                    closeTagModal();
                    
                    showInfoBanner(`✅ Đã cập nhật tag cho đơn hàng thành công!`);

                } catch (error) {
                    console.error('[TAG] Error saving tags:', error);
                    showLoading(false);
                    alert('Lỗi khi lưu tag: ' + error.message);
                }
            }

            // =====================================================
            // UTILITY FUNCTIONS
            // =====================================================
            function formatDateTimeLocal(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                const day = String(date.getDate()).padStart(2, "0");
                const hours = String(date.getHours()).padStart(2, "0");
                const minutes = String(date.getMinutes()).padStart(2, "0");
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            function convertToUTC(dateTimeLocal) {
                const date = new Date(dateTimeLocal);
                return date.toISOString();
            }

            // =====================================================
            // CAMPAIGN LOADING
            // =====================================================
            async function loadCampaignList() {
                try {
                    showLoading(true);

                    const now = new Date();
                    const thirtyDaysAgo = new Date(
                        now.getTime() - 30 * 24 * 60 * 60 * 1000,
                    );
                    const startDate = thirtyDaysAgo.toISOString();
                    const endDate = now.toISOString();

                    const filter = `(DateCreated ge ${startDate} and DateCreated le ${endDate})`;
                    const url = `https://tomato.tpos.vn/odata/SaleOnline_Order/ODataService.GetView?$top=2000&$orderby=DateCreated desc&$filter=${encodeURIComponent(filter)}&$count=true`;

                    const headers = await window.tokenManager.getAuthHeader();
                    const response = await fetch(url, {
                        method: "GET",
                        headers: {
                            ...headers,
                            accept: "application/json",
                            "content-type": "application/json",
                        },
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const orders = data.value || [];

                    const campaignMap = new Map();
                    orders.forEach((order) => {
                        if (order.LiveCampaignId) {
                            if (!campaignMap.has(order.LiveCampaignId)) {
                                campaignMap.set(order.LiveCampaignId, {
                                    campaignId: order.LiveCampaignId,
                                    campaignName:
                                        order.LiveCampaignName ||
                                        "Không có tên",
                                    latestDate: order.DateCreated,
                                });
                            }
                            const campaign = campaignMap.get(
                                order.LiveCampaignId,
                            );
                            if (
                                new Date(order.DateCreated) >
                                new Date(campaign.latestDate)
                            ) {
                                campaign.latestDate = order.DateCreated;
                            }
                        }
                    });

                    const campaigns = Array.from(campaignMap.values())
                        .map((c) => ({
                            campaignId: c.campaignId,
                            displayName: c.campaignName,
                            latestDate: c.latestDate,
                        }))
                        .sort(
                            (a, b) =>
                                new Date(b.latestDate) - new Date(a.latestDate),
                        );

                    populateCampaignFilter(campaigns);
                } catch (error) {
                    console.error("Error loading campaigns:", error);
                    alert("Lỗi khi tải danh sách chiến dịch: " + error.message);
                } finally {
                    showLoading(false);
                }
            }

            function populateCampaignFilter(campaigns) {
                const select = document.getElementById("campaignFilter");
                select.innerHTML =
                    '<option value="">-- Chọn chiến dịch --</option>';

                campaigns.forEach((campaign) => {
                    const option = document.createElement("option");
                    option.value = campaign.campaignId;
                    option.textContent = campaign.displayName;
                    option.dataset.campaign = JSON.stringify(campaign);
                    select.appendChild(option);
                });

                if (campaigns.length > 0) {
                    select.value = campaigns[0].campaignId;
                    handleCampaignChange();
                }
            }

            function handleCampaignChange() {
                const select = document.getElementById("campaignFilter");
                const selectedOption = select.options[select.selectedIndex];

                if (selectedOption && selectedOption.dataset.campaign) {
                    selectedCampaign = JSON.parse(
                        selectedOption.dataset.campaign,
                    );
                } else {
                    selectedCampaign = null;
                }
            }

            // =====================================================
            // SEARCH & DATA FETCHING
            // =====================================================
            async function handleSearch() {
                if (!selectedCampaign || !selectedCampaign.campaignId) {
                    alert("Vui lòng chọn chiến dịch");
                    return;
                }

                console.log("[CACHE] Clearing all cache before search...");
                if (window.cacheManager) {
                    window.cacheManager.clear("orders");
                    window.cacheManager.clear("campaigns");
                }

                // Reset state
                allData = [];
                filteredData = [];
                displayedData = [];
                hasMoreData = false;

                await fetchOrders();
            }

            async function fetchOrders() {
                try {
                    showLoading(true);

                    const startDate = convertToUTC(
                        document.getElementById("startDate").value,
                    );
                    const endDate = convertToUTC(
                        document.getElementById("endDate").value,
                    );
                    const campaignId = selectedCampaign.campaignId;

                    console.log(
                        "Fetching all orders for campaign:",
                        campaignId,
                    );

                    const filter = `(DateCreated ge ${startDate} and DateCreated le ${endDate}) and LiveCampaignId eq ${campaignId}`;

                    // Fetch data with pagination (1000 per request)
                    const PAGE_SIZE = 1000;
                    let skip = 0;
                    let hasMore = true;
                    allData = [];

                    const headers = await window.tokenManager.getAuthHeader();

                    // LOAD ALL DATA FIRST
                    while (hasMore) {
                        const url = `https://tomato.tpos.vn/odata/SaleOnline_Order/ODataService.GetView?$top=${PAGE_SIZE}&$skip=${skip}&$orderby=DateCreated desc&$filter=${encodeURIComponent(filter)}&$count=true`;

                        const response = await fetch(url, {
                            method: "GET",
                            headers: {
                                ...headers,
                                accept: "application/json",
                                "content-type": "application/json",
                            },
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        const data = await response.json();
                        const orders = data.value || [];

                        if (skip === 0) {
                            totalCount = data["@odata.count"] || 0;
                        }

                        // Check if any order has different CampaignId - STOP if found
                        const hasDifferentCampaign = orders.some(
                            (order) =>
                                order.LiveCampaignId &&
                                order.LiveCampaignId !== campaignId,
                        );

                        if (hasDifferentCampaign) {
                            console.log(
                                `⚠️ Found different CampaignId at skip=${skip}, stopping fetch`,
                            );
                            // Only add orders that match the selected campaign
                            const matchingOrders = orders.filter(
                                (order) => order.LiveCampaignId === campaignId,
                            );
                            allData = allData.concat(matchingOrders);
                            hasMore = false;
                            break;
                        }

                        // Add all orders from this batch
                        allData = allData.concat(orders);

                        // Update loading overlay with progress
                        const loadingText = document.querySelector(
                            ".loading-overlay .loading-text",
                        );
                        if (loadingText) {
                            loadingText.textContent = `Đang tải dữ liệu... (${allData.length} đơn hàng)`;
                        }

                        console.log(
                            `Fetched ${allData.length} orders so far...`,
                        );

                        // Check if we got less than PAGE_SIZE (no more data)
                        if (orders.length < PAGE_SIZE) {
                            hasMore = false;
                        } else {
                            skip += PAGE_SIZE;
                        }

                        // Small delay between requests to avoid rate limiting
                        if (hasMore) {
                            await new Promise((resolve) =>
                                setTimeout(resolve, 300),
                            );
                        }
                    }

                    // Filter out empty/invalid orders
                    filteredData = allData.filter(
                        (order) =>
                            order &&
                            order.Id &&
                            order.LiveCampaignId === campaignId,
                    );

                    console.log(
                        `✅ Loaded ALL ${filteredData.length} valid orders`,
                    );

                    // Show stats bar and table
                    document.getElementById("statsBar").style.display = "flex";
                    document.getElementById("tableContainer").style.display = "block";

                    // RENDER ALL DATA AT ONCE (no more lazy loading)
                    displayedData = filteredData;

                    renderTable();
                    updatePageInfo();
                    updateStats();

                    showInfoBanner(
                        `✅ Đã tải và hiển thị TOÀN BỘ ${filteredData.length} đơn hàng.`,
                    );

                    // Hide loading overlay
                    showLoading(false);

                    // Send complete data to Tab 2
                    sendDataToTab2();
                } catch (error) {
                    console.error("Error fetching data:", error);
                    alert("Lỗi khi tải dữ liệu: " + error.message);
                    showLoading(false);
                }
            }

            // =====================================================
            // RENDERING FUNCTIONS
            // =====================================================
            function renderTable() {
                const tbody = document.getElementById("tableBody");

                if (displayedData.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="11" style="text-align: center; padding: 40px;">Không có dữ liệu</td></tr>';
                    return;
                }

                tbody.innerHTML = displayedData
                    .filter((order) => order && order.Id) // Filter out invalid orders
                    .map((order) => createRowHTML(order))
                    .join("");
            }

            function createRowHTML(order) {
                // Skip if order is invalid
                if (!order || !order.Id) return "";

                // Parse tags and count
                let tagsCount = 0;
                let tagsHTML = '';
                if (order.Tags) {
                    try {
                        const tags = JSON.parse(order.Tags);
                        if (Array.isArray(tags)) {
                            tagsCount = tags.length;
                            tagsHTML = parseOrderTags(order.Tags);
                        }
                    } catch (error) {
                        // Ignore parse errors
                    }
                }
                
                // Format partner status
                const partnerStatusHTML = formatPartnerStatus(order.PartnerStatusText);

                return `
                    <tr>
                        <td><input type="checkbox" value="${order.Id}" /></td>
                        <td>${order.SessionIndex || ""}</td>
                        <td style="max-width: 120px; white-space: normal;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span>${order.Code || ""}</span>
                                <button class="tag-icon-btn" onclick="openTagModal('${order.Id}', '${order.Code}')" title="Quản lý tag" style="padding: 2px 6px;">
                                    <i class="fas fa-tags"></i>
                                    ${tagsCount > 0 ? `<span class="tag-count">${tagsCount}</span>` : ''}
                                </button>
                            </div>
                            ${tagsHTML}
                        </td>
                        <td>
                            <div>${order.Name || ""}</div>
                            ${partnerStatusHTML}
                        </td>
                        <td style="max-width: 100px; white-space: normal;">${order.Telephone || ""}</td>
                        <td style="max-width: 500px; white-space: normal;">${order.Address || ""}</td>
                        <td style="max-width: 200px; white-space: normal;">${order.Note || ""}</td>
                        <td>${(order.TotalAmount || 0).toLocaleString("vi-VN")}đ</td>
                        <td>${order.TotalQuantity || 0}</td>
                        <td>${new Date(order.DateCreated).toLocaleString("vi-VN")}</td>
                        <td>
                            <span class="status-badge ${order.Status === "Draft" ? "status-draft" : "status-order"}">
                                ${order.StatusText || order.Status || ""}
                            </span>
                        </td>
                    </tr>
                `;
            }

            function parseOrderTags(tagsJson) {
                if (!tagsJson) return "";
                
                try {
                    const tags = JSON.parse(tagsJson);
                    if (!Array.isArray(tags) || tags.length === 0) return "";
                    
                    return tags.map(tag => {
                        const color = tag.Color || "#6b7280";
                        const name = tag.Name || "";
                        return `<span class="order-tag" style="background-color: ${color};">${name}</span>`;
                    }).join(" ");
                } catch (error) {
                    console.error("Error parsing tags:", error);
                    return "";
                }
            }

            function formatPartnerStatus(statusText) {
                if (!statusText) return "";
                
                // Partner status color mapping
                const statusColors = {
                    "Bình thường": "#5cb85c",
                    "Bom hàng": "#d1332e",
                    "Cảnh báo": "#f0ad4e",
                    "Khách sỉ": "#5cb85c",
                    "Nguy hiểm": "#d9534f",
                    "Thân thiết": "#5bc0de",
                    "Vip": "#337ab7",
                    "VIP": "#5bc0deff"
                };
                
                const color = statusColors[statusText] || "#6b7280"; // Default gray if not found
                
                return `<span class="partner-status" style="background-color: ${color};">${statusText}</span>`;
            }

            // =====================================================
            // UPDATE FUNCTIONS
            // =====================================================
            function updateStats() {
                // Only count valid orders
                const validDisplayed = displayedData.filter(
                    (order) => order && order.Id,
                );
                const totalAmount = validDisplayed.reduce(
                    (sum, order) => sum + (order.TotalAmount || 0),
                    0,
                );
                const progress =
                    filteredData.length > 0
                        ? Math.round(
                              (validDisplayed.length / filteredData.length) *
                                  100,
                          )
                        : 0;

                document.getElementById("totalOrdersCount").textContent =
                    filteredData.length.toLocaleString("vi-VN");
                document.getElementById("displayedOrdersCount").textContent =
                    validDisplayed.length.toLocaleString("vi-VN");
                document.getElementById("totalAmountSum").textContent =
                    totalAmount.toLocaleString("vi-VN") + "đ";
                document.getElementById("loadingProgress").textContent =
                    progress + "%";
            }

            function updatePageInfo() {
                // Count only valid displayed orders
                const validDisplayed = displayedData.filter(
                    (order) => order && order.Id,
                );
                const totalDisplayed = validDisplayed.length;
                const totalFiltered = filteredData.length;

                let infoText = `Hiển thị ${totalDisplayed.toLocaleString("vi-VN")} / ${totalFiltered.toLocaleString("vi-VN")}`;
                document.getElementById("pageInfo").textContent = infoText;

                const scrollHint = document.getElementById("scrollHint");
                if (totalDisplayed > 0) {
                    scrollHint.textContent = "✅ Đã hiển thị tất cả";
                } else {
                    scrollHint.textContent = "";
                }
            }

            // =====================================================
            // TAB 2 COMMUNICATION
            // =====================================================
            function sendDataToTab2() {
                const startDate = convertToUTC(
                    document.getElementById("startDate").value,
                );
                const endDate = convertToUTC(
                    document.getElementById("endDate").value,
                );

                const filterData = {
                    startDate: startDate,
                    endDate: endDate,
                    campaignId: selectedCampaign?.campaignId || null,
                    campaignName: selectedCampaign?.displayName || "",
                    data: allData,
                    totalRecords: allData.length,
                    timestamp: new Date().toISOString(),
                };

                if (window.parent && window.parent !== window) {
                    window.parent.postMessage(
                        { type: "FILTER_CHANGED", filter: filterData },
                        "*",
                    );
                }

                localStorage.setItem(
                    "tab1_filter_data",
                    JSON.stringify(filterData),
                );
                console.log(
                    "Data sent to Tab 2:",
                    filterData.totalRecords,
                    "orders",
                );
            }

            // =====================================================
            // EVENT HANDLERS
            // =====================================================
            function handleSelectAll() {
                const checkboxes = document.querySelectorAll(
                    '#tableBody input[type="checkbox"]',
                );
                const selectAll = document.getElementById("selectAll");
                checkboxes.forEach((cb) => (cb.checked = selectAll.checked));
            }

            function handleClearCache() {
                if (confirm("Bạn có chắc muốn xóa toàn bộ cache?")) {
                    console.log("[CACHE] Manual cache clear triggered");
                    window.cacheManager.clear("orders");
                    window.cacheManager.clear("campaigns");
                    alert("Đã xóa cache");
                    location.reload();
                }
            }

            // =====================================================
            // UI HELPERS
            // =====================================================
            function showLoading(show) {
                document
                    .getElementById("loadingOverlay")
                    .classList.toggle("show", show);
            }

            function showInfoBanner(text) {
                const banner = document.getElementById("infoBanner");
                document.getElementById("infoText").textContent = text;
                banner.style.display = "flex";
                setTimeout(() => {
                    banner.style.display = "none";
                }, 5000);
            }

            // =====================================================
            // CLEANUP
            // =====================================================
            window.addEventListener("beforeunload", function () {
                console.log("[CACHE] Clearing cache on page unload...");
                if (window.cacheManager) {
                    window.cacheManager.clear("orders");
                    window.cacheManager.clear("campaigns");
                }
            });

            // Export for future use
            window.clearCacheAfterEdit = function () {
                console.log("[CACHE] Clearing cache after data edit...");
                if (window.cacheManager) {
                    window.cacheManager.clear("orders");
                    window.cacheManager.clear("campaigns");
                }
                if (selectedCampaign && selectedCampaign.campaignId) {
                    handleSearch();
                }
            };

            // Close TAG modal with ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('tagModal');
                    if (modal && modal.classList.contains('show')) {
                        closeTagModal();
                    }
                }
            });

            // Close modal when clicking outside
            document.addEventListener('click', function(e) {
                const modal = document.getElementById('tagModal');
                const modalContent = document.querySelector('.tag-modal-content');
                
                if (modal && modal.classList.contains('show') && 
                    e.target === modal && 
                    modalContent && !modalContent.contains(e.target)) {
                    closeTagModal();
                }
            });
        </script>
    </body>
</html>
