# AI Agent Instructions for orders-report

> Hướng dẫn cho AI Agent (Claude, GPT, etc.) khi làm việc với thư mục này.
>
> **Related docs:**
> - [MODULE_MAP.md](MODULE_MAP.md) - Navigation map với line ranges chính xác
> - [ARCHITECTURE.md](ARCHITECTURE.md) - Chi tiết kỹ thuật, API reference, flow diagrams

---

## TRƯỚC KHI BẮT ĐẦU BẤT KỲ TASK NÀO

### Step 1: Đọc MODULE_MAP.md
```
Đọc file: orders-report/MODULE_MAP.md
```
File này chứa:
- Cấu trúc thư mục tổng quan
- Section map cho tab1-orders.js (25,975 lines)
- Line ranges chính xác cho từng feature
- API dependencies
- Cross-tab communication patterns

### Step 2: Xác định Section cần sửa
Từ MODULE_MAP.md, tìm section phù hợp với task:

| Task Type | Section | Lines |
|-----------|---------|-------|
| Table display | SECTION 8 | 6864-7507 |
| Tag feature | SECTION 5-6 | 1627-5037 |
| Chat modal | SECTION 12 | 10002-15761 |
| Debt display | SECTION 17 | 21680-23411 |
| Create PBH (F9) | SECTION 18 | 23412-25975 |
| Search/filter | SECTION 7 | 5038-6863 |

### Step 3: Đọc CHỈ section cần thiết
```javascript
// Ví dụ: Đọc section CHAT MODAL
Read("tab1-orders.js", offset=10002, limit=1000)
```

**TUYỆT ĐỐI KHÔNG** đọc toàn bộ file - sẽ gây context overflow!

---

## QUY TẮC QUAN TRỌNG

### 1. File Size Limits
- `tab1-orders.js` = 25,975 lines → ĐỌC THEO SECTION
- `tab-overview.html` = 8,806 lines → ĐỌC THEO SECTION
- Các file < 2,000 lines → Có thể đọc toàn bộ

### 2. Global State Management
Tất cả state được định nghĩa ở **SECTION 1** (lines 119-239):
```javascript
// Đọc trước khi modify bất kỳ function nào
let allData = [];           // Tất cả orders
let filteredData = [];      // Sau filter
let displayedData = [];     // Sau employee filter
let employeeRanges = [];    // Employee config
let currentEditOrderData = null;
```

### 3. Firebase Patterns
Firebase listeners setup ở **SECTION 2** (lines 240-710):
```javascript
// Pattern chuẩn
database.ref('path').on('value', snapshot => {
    // Handle update
});

// Emit changes
await database.ref('path').set(data);
```

### 4. API Call Patterns
Tất cả API calls qua Cloudflare Worker:
```javascript
const BASE_URL = 'https://chatomni-proxy.nhijudyshop.workers.dev';

// GET request
const response = await fetch(`${BASE_URL}/api/odata/DraftOrder`);

// PUT request
await fetch(`${BASE_URL}/api/odata/DraftOrder(${id})`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
});
```

### 5. Cross-Tab Communication
Tab communication qua postMessage:
```javascript
// Gửi message
window.parent.postMessage({ type: 'EVENT_TYPE', data: payload }, '*');

// Nhận message
window.addEventListener('message', (event) => {
    if (event.data.type === 'EVENT_TYPE') {
        // Handle
    }
});
```

---

## COMMON PATTERNS

### Thêm Column mới vào bảng
1. Đọc SECTION 8 (lines 6864-7507)
2. Tìm `createRowHTML()` function
3. Thêm column vào template literal
4. Cập nhật header trong tab1-orders.html

### Thêm Filter mới
1. Đọc SECTION 7 (lines 5038-6863)
2. Tìm `performTableSearch()` hoặc `applyFilters()`
3. Thêm filter logic
4. Cập nhật UI controls

### Sửa Chat Modal
1. Đọc SECTION 12 (lines 10002-15761)
2. Chú ý global state: `window.currentChatPSID`, etc.
3. Kiểm tra realtime listeners

### Integrate Customer Hub
1. Đọc SECTION 18 (lines 23412-25975)
2. Tìm `confirmAndPrintSale()` (~line 25200)
3. Thêm wallet deduction logic trước khi call TPOS API

---

## DEPENDENCIES GIỮA CÁC FILES

```
tab1-orders.js
├── Depends on:
│   ├── config.js (Firebase config)
│   ├── auth.js (Authentication)
│   ├── api-config.js (API URLs)
│   ├── api-handler.js (API helpers)
│   ├── pancake-data-manager.js (Pancake API)
│   ├── pancake-token-manager.js (JWT tokens)
│   └── product-search-manager.js (Product search)
│
├── Used by:
│   ├── main.html (Tab container)
│   ├── tab3-product-assignment.js (Orders data)
│   └── tab-overview.html (Orders data)
│
└── Shared managers:
    ├── window.pancakeDataManager
    ├── window.pancakeTokenManager
    ├── window.tokenManager
    ├── window.authManager
    └── window.productSearchManager
```

---

## DEBUG TIPS

### Console Prefixes
```
[TAG-REALTIME]  - Tag sync logs
[PANCAKE]       - Pancake API logs
[CHAT]          - Chat modal logs
[KPI]           - KPI calculation logs
[NOTE-TRACKER]  - Note tracking logs
[DEBT]          - Debt/wallet logs
```

### Check Current State
```javascript
// In browser console:
console.log('allData:', allData.length);
console.log('displayedData:', displayedData.length);
console.log('employeeRanges:', employeeRanges);
console.log('currentEditOrderData:', currentEditOrderData);
```

---

## TESTING CHECKLIST

Sau khi modify code:

- [ ] Check browser console for errors
- [ ] Test feature manually
- [ ] Verify Firebase sync (open 2 tabs, check realtime)
- [ ] Check cross-tab communication
- [ ] Test on mobile view (responsive)
- [ ] Verify API calls in Network tab

---

## KHÔNG ĐƯỢC LÀM

1. **KHÔNG** đọc toàn bộ tab1-orders.js
2. **KHÔNG** modify global state mà không check dependencies
3. **KHÔNG** hardcode API URLs (dùng config)
4. **KHÔNG** bypass Cloudflare Worker proxy
5. **KHÔNG** remove existing console.log (dùng cho debug)
6. **KHÔNG** thay đổi Firebase structure mà không update docs

---

## FILE DOCUMENTATION STANDARDS

Khi thêm function mới, sử dụng JSDoc:
```javascript
/**
 * @ai-context Mô tả ngắn gọn chức năng
 * @ai-related-files File liên quan
 * @ai-api-calls API endpoints được gọi
 * @ai-side-effects Side effects (state changes, etc.)
 *
 * @param {Type} paramName - Mô tả
 * @returns {Type} Mô tả return value
 */
function newFunction(paramName) {
    // Implementation
}
```

---

*Cập nhật: 2025-01-07*
