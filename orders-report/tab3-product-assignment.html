<!--
  üìñ GHI CH√ö CHO L·∫¨P TR√åNH VI√äN:
  Khi code ph·∫£i ƒë·ªçc th∆∞ m·ª•c https://github.com/nhijudyshop/n2store/tree/main/docs tr∆∞·ªõc!
  ƒê·ªçc c√°c file SHARED_*.md ƒë·ªÉ hi·ªÉu c√°ch s·ª≠ d·ª•ng shared modules.
-->
<!doctype html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G√°n S·∫£n Ph·∫©m - STT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="js/utils/decoding-utility.js"></script>

    <link rel="stylesheet" href="css/tab3-product-assignment.css" />
</head>

<body>
    <!-- Main Container -->
    <div class="container-fluid p-4">
        <!-- Header -->
        <div class="header-section mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-link"></i> G√°n S·∫£n Ph·∫©m - S·ªë Th·ª© T·ª± ƒê∆°n H√†ng</h2>
                    <p class="text-muted mb-0">Li√™n k·∫øt s·∫£n ph·∫©m v·ªõi s·ªë th·ª© t·ª± ƒë∆°n h√†ng</p>
                </div>
                <div>
                    <button class="btn btn-sm btn-primary me-2" onclick="openUploadHistoryV2Modal()">
                        <i class="fas fa-history"></i> L·ªãch S·ª≠ Upload v2
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="reloadWithCacheClear()"
                        title="X√≥a cache v√† reload Tab1 + Tab3 ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t">
                        <i class="fas fa-redo"></i> Reload Page
                    </button>
                    <button class="btn btn-sm btn-success me-2" onclick="openExportExcelModal()"
                        title="Xu·∫•t danh s√°ch ƒë∆°n h√†ng t·ª´ TPOS ra file Excel">
                        <i class="fas fa-file-excel"></i> Xu·∫•t Excel
                    </button>
                    <button class="btn btn-sm btn-warning me-2" onclick="openRemoveProductModal()"
                        title="G·ª° s·∫£n ph·∫©m kh·ªèi ƒë∆°n h√†ng">
                        <i class="fas fa-minus-circle"></i> G·ª° S·∫£n Ph·∫©m
                    </button>
                    <span class="badge bg-info ms-2" id="ordersCountBadge">
                        <i class="fas fa-database"></i> <span id="ordersCount">0</span> ƒë∆°n h√†ng
                    </span>
                </div>
            </div>
        </div>

        <!-- Assignment Table -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-table"></i> Danh s√°ch g√°n (<span id="assignmentCount">0</span>)</h5>
                <button class="btn btn-light btn-sm" onclick="clearAllAssignments()">
                    <i class="fas fa-trash"></i> X√≥a t·∫•t c·∫£
                </button>
            </div>

            <!-- Product Search Section (inside Assignment Table) -->
            <div class="card-body bg-light border-bottom">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="search-wrapper position-relative">
                            <input type="text" class="form-control form-control-lg" id="productSearch"
                                placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m (nh·∫≠p m√£ ho·∫∑c barcode)..." autocomplete="off" />
                            <div class="suggestions-dropdown" id="productSuggestions"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-lg" id="assignmentSearch"
                            placeholder="üîé L·ªçc danh s√°ch (m√£ SP, t√™n SP, STT)..." autocomplete="off"
                            oninput="filterAssignments(this.value)" />
                    </div>
                </div>
                <div id="loadingIndicator" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                    <small class="d-block mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m...</small>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50%">S·∫£n ph·∫©m</th>
                                <th style="width: 40%">STT ƒê∆°n H√†ng</th>
                                <th style="width: 10%">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="assignmentTableBody">
                            <tr>
                                <td colspan="3" class="text-center text-muted py-5">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c g√°n. H√£y t√¨m ki·∫øm v√† th√™m s·∫£n ph·∫©m.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- UPLOAD SECTION - NEW FEATURE -->
        <!-- ========================================= -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-upload"></i> Upload S·∫£n Ph·∫©m L√™n TPOS</h5>
                    <div class="btn-group btn-group-sm view-mode-toggle" role="group">
                        <button type="button" class="btn btn-light" id="viewByOrderBtn" onclick="switchViewMode('order')">
                            <i class="fas fa-list"></i> Theo ƒê∆°n
                        </button>
                        <button type="button" class="btn btn-light active" id="viewByProductBtn" onclick="switchViewMode('product')">
                            <i class="fas fa-box"></i> Theo S·∫£n Ph·∫©m
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <!-- Upload Stats -->
                <div class="upload-stats mb-3">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-card bg-danger-subtle">
                                <i class="fas fa-shopping-cart text-danger"></i>
                                <div class="stat-value" id="totalItems">0</div>
                                <div class="stat-label">T·ªïng Items</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-success-subtle">
                                <i class="fas fa-box text-success"></i>
                                <div class="stat-value" id="totalProducts">0</div>
                                <div class="stat-label">T·ªïng S·∫£n Ph·∫©m</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-info-subtle">
                                <i class="fas fa-hashtag text-info"></i>
                                <div class="stat-value" id="totalOrders">0</div>
                                <div class="stat-label">T·ªïng STT</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-warning-subtle">
                                <i class="fas fa-check-square text-warning"></i>
                                <div class="stat-value" id="selectedCount">0</div>
                                <div class="stat-label">ƒê√£ Ch·ªçn</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Table Container -->
                <div class="table-responsive" id="uploadTableContainer">
                    <table class="table table-hover mb-0" id="uploadTable">
                        <thead class="table-light" id="uploadTableHead">
                            <!-- Will be populated by JavaScript -->
                        </thead>
                        <tbody id="uploadTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-5">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ upload. H√£y g√°n s·∫£n ph·∫©m ·ªü b·∫£ng tr√™n.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-outline-secondary btn-sm" id="selectAllUploadBtn" onclick="selectAllUpload()">
                            <i class="fas fa-check-double"></i> Ch·ªçn T·∫•t C·∫£
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="deselectAllUploadBtn" onclick="deselectAllUpload()">
                            <i class="fas fa-times"></i> B·ªè Ch·ªçn T·∫•t C·∫£
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success btn-sm" id="previewUploadBtn" onclick="previewUpload()" disabled>
                            <i class="fas fa-cloud-upload-alt"></i> Upload TPOS
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- PREVIEW MODAL -->
    <!-- ========================================= -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-eye"></i> Xem Tr∆∞·ªõc Upload
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="previewModalBody">
                    <div class="text-center py-5">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">ƒêang t·∫£i preview...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" id="confirmUploadBtn" onclick="confirmUpload()">
                        <i class="fas fa-check"></i> X√°c Nh·∫≠n Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- FINALIZE SESSION MODAL -->
    <!-- ========================================= -->
    <div class="modal fade" id="finalizeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-flag-checkered"></i> Finalize Session
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Ch√∫ √Ω:</strong> Finalize session s·∫Ω l∆∞u t·∫•t c·∫£ d·ªØ li·ªáu hi·ªán t·∫°i v√†o l·ªãch s·ª≠ v√† x√≥a to√†n b·ªô assignments.
                        B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?
                    </div>

                    <div class="finalize-summary">
                        <h6><i class="fas fa-info-circle"></i> Th·ªëng K√™ Hi·ªán T·∫°i:</h6>
                        <ul>
                            <li>T·ªïng STT: <strong id="finalizeTotalSTT">0</strong></li>
                            <li>T·ªïng S·∫£n Ph·∫©m: <strong id="finalizeTotalProducts">0</strong></li>
                            <li>T·ªïng Items: <strong id="finalizeTotalItems">0</strong></li>
                        </ul>
                    </div>

                    <div class="form-group mt-3">
                        <label for="finalizeNote" class="form-label">Ghi ch√∫ (t√πy ch·ªçn):</label>
                        <textarea class="form-control" id="finalizeNote" rows="3" placeholder="Nh·∫≠p ghi ch√∫ cho session n√†y..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                    <button type="button" class="btn btn-warning" id="confirmFinalizeBtn" onclick="confirmFinalize()">
                        <i class="fas fa-check"></i> X√°c Nh·∫≠n Finalize
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload History Modal -->
    <div class="modal fade" id="uploadHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-history"></i> L·ªãch S·ª≠ Upload TPOS
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Filters -->
                    <div class="history-filters mb-3">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="historyStatusFilter"
                                    onchange="filterUploadHistory()">
                                    <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                    <option value="completed">‚úÖ Th√†nh c√¥ng</option>
                                    <option value="partial">‚ö†Ô∏è Th√†nh c√¥ng m·ªôt ph·∫ßn</option>
                                    <option value="failed">‚ùå Th·∫•t b·∫°i</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control form-control-sm" id="historyDateFrom"
                                    onchange="filterUploadHistory()" placeholder="T·ª´ ng√†y">
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control form-control-sm" id="historyDateTo"
                                    onchange="filterUploadHistory()" placeholder="ƒê·∫øn ng√†y">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" id="historySearchSTT"
                                    oninput="filterUploadHistory()" placeholder="üîç T√¨m STT...">
                            </div>
                        </div>
                    </div>

                    <!-- History List Container -->
                    <div id="historyListContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">ƒêang t·∫£i l·ªãch s·ª≠...</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div id="historyPagination" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload History Detail Modal -->
    <div class="modal fade" id="uploadHistoryDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="historyDetailModalTitle">
                        <i class="fas fa-info-circle"></i> Chi Ti·∫øt Upload
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="historyDetailModalBody">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Cart History Modal -->
    <div class="modal fade" id="compareCartHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-balance-scale"></i> So S√°nh Gi·ªè H√†ng
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="compareCartHistoryModalBody">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- UPLOAD HISTORY V2 MODAL (GI·ªêNG 100% TAB-UPLOAD-TPOS) -->
    <!-- ========================================= -->
    <div class="modal fade" id="uploadHistoryV2Modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-history"></i> L·ªãch S·ª≠ Upload TPOS v2
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Filters -->
                    <div class="history-filters mb-3">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="historyV2UserFilter"
                                    onchange="loadUploadHistoryV2()">
                                    <option value="current">üë§ L·ªãch s·ª≠ c·ªßa t√¥i</option>
                                    <option value="all">üë• T·∫•t c·∫£ ng∆∞·ªùi d√πng</option>
                                    <!-- User options will be populated by JS -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="historyV2StatusFilter"
                                    onchange="filterUploadHistoryV2()">
                                    <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                    <option value="completed">‚úÖ Th√†nh c√¥ng</option>
                                    <option value="partial">‚ö†Ô∏è Th√†nh c√¥ng m·ªôt ph·∫ßn</option>
                                    <option value="failed">‚ùå Th·∫•t b·∫°i</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="datetime-local" class="form-control form-control-sm" id="historyV2DateFrom"
                                    onchange="filterUploadHistoryV2()" placeholder="T·ª´ ng√†y">
                            </div>
                            <div class="col-md-3">
                                <input type="datetime-local" class="form-control form-control-sm" id="historyV2DateTo"
                                    onchange="filterUploadHistoryV2()" placeholder="ƒê·∫øn ng√†y">
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm" id="historyV2SearchSTT"
                                    oninput="filterUploadHistoryV2()" placeholder="üîç T√¨m STT...">
                            </div>
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm" id="historyV2SearchProduct"
                                    oninput="filterUploadHistoryV2()" placeholder="üîç T√¨m m√£ s·∫£n ph·∫©m...">
                            </div>
                            <div class="col-md-2">
                                <div class="form-check form-switch h-100 d-flex align-items-center">
                                    <input class="form-check-input" type="checkbox" id="historyV2GroupBySTT"
                                        onchange="toggleGroupBySTTView()">
                                    <label class="form-check-label ms-2" for="historyV2GroupBySTT">L·ªçc theo STT</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- History List Container -->
                    <div id="historyV2ListContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">ƒêang t·∫£i l·ªãch s·ª≠...</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div id="historyV2Pagination" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload History V2 Detail Modal -->
    <div class="modal fade" id="uploadHistoryV2DetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="historyV2DetailModalTitle">
                        <i class="fas fa-info-circle"></i> Chi Ti·∫øt Upload
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="historyV2DetailModalBody">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Cart History V2 Modal -->
    <div class="modal fade" id="compareCartHistoryV2Modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-balance-scale"></i> So S√°nh Gi·ªè H√†ng
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="compareCartHistoryV2ModalBody">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Info Tooltip (Hidden by default) -->
    <div class="order-tooltip" id="orderTooltip"></div>

    <!-- Export Excel Modal -->
    <div class="modal fade" id="exportExcelModal" tabindex="-1" aria-labelledby="exportExcelModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="exportExcelModalLabel">
                        <i class="fas fa-file-excel"></i> Xu·∫•t Excel ƒê∆°n H√†ng
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="exportSkipRange" class="form-label fw-bold">Ch·ªçn kho·∫£ng t·∫£i:</label>
                        <select class="form-select form-select-lg" id="exportSkipRange">
                            <option value="0" selected>3000 ƒë∆°n ƒë·∫ßu ti√™n</option>
                            <option value="3000">3000 ƒë∆°n ti·∫øp theo (3001 - 6000)</option>
                            <option value="6000">3000 ƒë∆°n th·ª© 3 (6001 - 9000)</option>
                            <option value="9000">3000 ƒë∆°n th·ª© 4 (9001 - 12000)</option>
                            <option value="12000">3000 ƒë∆°n th·ª© 5 (12001 - 15000)</option>
                        </select>
                        <div class="form-text text-muted mt-2">
                            <i class="fas fa-info-circle"></i> D·ªØ li·ªáu ƒë∆∞·ª£c t·∫£i tr·ª±c ti·∫øp t·ª´ TPOS, s·∫Øp x·∫øp theo ng√†y t·∫°o m·ªõi nh·∫•t.
                        </div>
                    </div>
                    <!-- Export Progress -->
                    <div id="exportProgress" style="display: none;">
                        <div class="d-flex align-items-center justify-content-center py-3">
                            <div class="spinner-border text-success me-3" role="status">
                                <span class="visually-hidden">ƒêang t·∫£i...</span>
                            </div>
                            <span id="exportProgressText">ƒêang t·∫£i ƒë∆°n h√†ng t·ª´ TPOS...</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                                 role="progressbar" id="exportProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" id="exportModalFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" id="exportExcelBtn" onclick="exportOrdersToExcel()">
                        <i class="fas fa-download"></i> Xu·∫•t Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove Product Modal -->
    <div class="modal fade" id="removeProductModal" tabindex="-1" aria-labelledby="removeProductModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white;">
                    <h5 class="modal-title" id="removeProductModalLabel">
                        <i class="fas fa-minus-circle"></i> G·ª° S·∫£n Ph·∫©m Kh·ªèi ƒê∆°n H√†ng
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="closeRemoveProductModal()"></button>
                </div>
                <div class="modal-body">
                    <!-- Product Search Section -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-search"></i> T√¨m Ki·∫øm S·∫£n Ph·∫©m C·∫ßn G·ª°</h6>
                        </div>
                        <div class="card-body">
                            <div class="search-wrapper position-relative">
                                <input type="text" class="form-control form-control-lg" id="removalProductSearch"
                                    placeholder="üîç Nh·∫≠p m√£ s·∫£n ph·∫©m (vd: n77, n1769) ƒë·ªÉ t√¨m ki·∫øm..."
                                    autocomplete="off"
                                    spellcheck="false" />
                                <div class="suggestions-dropdown" id="removalProductSuggestions"></div>
                            </div>
                            <small class="text-muted d-block mt-2">
                                üí° <strong>G·ª£i √Ω:</strong> Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª± ƒë·ªÉ t√¨m ki·∫øm s·∫£n ph·∫©m
                            </small>
                        </div>
                    </div>

                    <!-- Removals Table -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-list"></i> Danh S√°ch G·ª° (<span id="removalCount">0</span>)</h6>
                            <button class="btn btn-sm btn-outline-dark" onclick="clearAllRemovals()">
                                <i class="fas fa-trash"></i> X√≥a T·∫•t C·∫£
                            </button>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover table-sm" id="removalTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="width: 40%">S·∫£n Ph·∫©m</th>
                                        <th style="width: 35%">STT ƒê∆°n H√†ng</th>
                                        <th style="width: 15%" class="text-center">SL Hi·ªán T·∫°i</th>
                                        <th style="width: 10%" class="text-center">Thao T√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="removalTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-3x mb-2"></i>
                                            <p class="mb-0">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</p>
                                            <small>Vui l√≤ng t√¨m ki·∫øm v√† th√™m s·∫£n ph·∫©m c·∫ßn g·ª°</small>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="card" id="removalPreviewCard" style="display: none;">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-eye"></i> Preview G·ª° S·∫£n Ph·∫©m</h6>
                        </div>
                        <div class="card-body">
                            <!-- View Mode Toggle -->
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-outline-primary" id="removalViewByProduct" onclick="switchRemovalViewMode('product')">
                                    <i class="fas fa-box"></i> Theo S·∫£n Ph·∫©m
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="removalViewByOrder" onclick="switchRemovalViewMode('order')">
                                    <i class="fas fa-shopping-cart"></i> Theo ƒê∆°n H√†ng
                                </button>
                            </div>

                            <!-- Preview Area -->
                            <div id="removalPreviewArea" style="max-height: 500px; overflow-y: auto;">
                                <!-- Will be populated by JS -->
                            </div>

                            <!-- Selection Summary -->
                            <div class="alert alert-info mt-3" id="removalSelectionSummary" style="display: none;">
                                <strong>ƒê√£ ch·ªçn:</strong> <span id="removalSelectedCount">0</span> STT
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeRemoveProductModal()">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                    <button type="button" class="btn btn-primary" onclick="previewRemoval()">
                        <i class="fas fa-eye"></i> Xem Tr∆∞·ªõc
                    </button>
                    <button type="button" class="btn btn-danger" onclick="executeRemoval()" id="executeRemovalBtn" style="display: none;">
                        <i class="fas fa-minus-circle"></i> G·ª° S·∫£n Ph·∫©m
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Removal Progress Modal -->
    <div class="modal fade" id="removalProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-danger mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">ƒêang x·ª≠ l√Ω...</span>
                    </div>
                    <h5 id="removalProgressText">ƒêang g·ª° s·∫£n ph·∫©m...</h5>
                    <p id="removalProgressDetail" class="text-muted mb-0">0 / 0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Removal Results Modal -->
    <div class="modal fade" id="removalResultsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-chart-bar"></i> K·∫øt Qu·∫£ G·ª° S·∫£n Ph·∫©m</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="removalResultsBody">
                    <!-- Will be populated by JS -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="js/core/api-config.js"></script>
    <script src="js/core/token-manager.js"></script>
    <!-- IndexedDB Storage for large data (replaces localStorage for caches) -->
    <script src="js/core/indexeddb-storage.js"></script>
    <script src="js/core/cache.js"></script>
    <script src="js/core/auth.js"></script>
    <script src="js/core/user-storage-manager.js"></script>
    <script src="js/core/notification-system.js"></script>
    <!-- Version checker is now in navigation-modern.js (loaded in main.html) -->
    <!-- Note: TPOS token caching is now handled server-side (Cloudflare Worker & Render.com) -->

    <script src="js/tab3/tab3-product-assignment.js"></script>
</body>

</html>