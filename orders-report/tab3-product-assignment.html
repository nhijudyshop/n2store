<!doctype html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G√°n S·∫£n Ph·∫©m - STT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="decoding-utility.js"></script>

    <link rel="stylesheet" href="tab3-product-assignment.css" />
</head>

<body>
    <!-- Main Container -->
    <div class="container-fluid p-4">
        <!-- Header -->
        <div class="header-section mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-link"></i> G√°n S·∫£n Ph·∫©m - S·ªë Th·ª© T·ª± ƒê∆°n H√†ng</h2>
                    <p class="text-muted mb-0">Li√™n k·∫øt s·∫£n ph·∫©m v·ªõi s·ªë th·ª© t·ª± ƒë∆°n h√†ng</p>
                </div>
                <div>
                    <button class="btn btn-sm btn-primary me-2" onclick="openUploadHistoryV2Modal()">
                        <i class="fas fa-history"></i> L·ªãch S·ª≠ Upload v2
                    </button>
                    <button class="btn btn-sm btn-warning me-2" onclick="hardRefreshFromFirebase()"
                        title="Load l·∫°i d·ªØ li·ªáu t·ª´ Firebase">
                        <i class="fas fa-sync-alt"></i> Hard Refresh
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.location.reload()"
                        title="Reload to√†n b·ªô trang">
                        <i class="fas fa-redo"></i> Reload Page
                    </button>
                    <span class="badge bg-info ms-2" id="ordersCountBadge">
                        <i class="fas fa-database"></i> <span id="ordersCount">0</span> ƒë∆°n h√†ng
                    </span>
                </div>
            </div>
        </div>

        <!-- Assignment Table -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-table"></i> Danh s√°ch g√°n (<span id="assignmentCount">0</span>)</h5>
                <button class="btn btn-light btn-sm" onclick="clearAllAssignments()">
                    <i class="fas fa-trash"></i> X√≥a t·∫•t c·∫£
                </button>
            </div>

            <!-- Product Search Section (inside Assignment Table) -->
            <div class="card-body bg-light border-bottom">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="search-wrapper position-relative">
                            <input type="text" class="form-control form-control-lg" id="productSearch"
                                placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m (nh·∫≠p m√£ ho·∫∑c barcode)..." autocomplete="off" />
                            <div class="suggestions-dropdown" id="productSuggestions"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-lg" id="assignmentSearch"
                            placeholder="üîé L·ªçc danh s√°ch (m√£ SP, t√™n SP, STT)..." autocomplete="off"
                            oninput="filterAssignments(this.value)" />
                    </div>
                </div>
                <div id="loadingIndicator" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                    <small class="d-block mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m...</small>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50%">S·∫£n ph·∫©m</th>
                                <th style="width: 40%">STT ƒê∆°n H√†ng</th>
                                <th style="width: 10%">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="assignmentTableBody">
                            <tr>
                                <td colspan="3" class="text-center text-muted py-5">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c g√°n. H√£y t√¨m ki·∫øm v√† th√™m s·∫£n ph·∫©m.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- UPLOAD SECTION - NEW FEATURE -->
        <!-- ========================================= -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-upload"></i> Upload S·∫£n Ph·∫©m L√™n TPOS</h5>
                    <div class="btn-group btn-group-sm view-mode-toggle" role="group">
                        <button type="button" class="btn btn-light active" id="viewByOrderBtn" onclick="switchViewMode('order')">
                            <i class="fas fa-list"></i> Theo ƒê∆°n
                        </button>
                        <button type="button" class="btn btn-light" id="viewByProductBtn" onclick="switchViewMode('product')">
                            <i class="fas fa-box"></i> Theo S·∫£n Ph·∫©m
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <!-- Upload Stats -->
                <div class="upload-stats mb-3">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-card bg-info-subtle">
                                <i class="fas fa-hashtag text-info"></i>
                                <div class="stat-value" id="totalOrders">0</div>
                                <div class="stat-label">T·ªïng STT</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-success-subtle">
                                <i class="fas fa-box text-success"></i>
                                <div class="stat-value" id="totalProducts">0</div>
                                <div class="stat-label">T·ªïng S·∫£n Ph·∫©m</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-warning-subtle">
                                <i class="fas fa-check-square text-warning"></i>
                                <div class="stat-value" id="selectedCount">0</div>
                                <div class="stat-label">ƒê√£ Ch·ªçn</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-danger-subtle">
                                <i class="fas fa-shopping-cart text-danger"></i>
                                <div class="stat-value" id="totalItems">0</div>
                                <div class="stat-label">T·ªïng Items</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Table Container -->
                <div class="table-responsive" id="uploadTableContainer">
                    <table class="table table-hover mb-0" id="uploadTable">
                        <thead class="table-light" id="uploadTableHead">
                            <!-- Will be populated by JavaScript -->
                        </thead>
                        <tbody id="uploadTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-5">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ upload. H√£y g√°n s·∫£n ph·∫©m ·ªü b·∫£ng tr√™n.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-outline-secondary btn-sm" id="selectAllUploadBtn" onclick="selectAllUpload()">
                            <i class="fas fa-check-double"></i> Ch·ªçn T·∫•t C·∫£
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="deselectAllUploadBtn" onclick="deselectAllUpload()">
                            <i class="fas fa-times"></i> B·ªè Ch·ªçn T·∫•t C·∫£
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success btn-sm me-2" id="previewUploadBtn" onclick="uploadToTPOS()" disabled>
                            <i class="fas fa-cloud-upload-alt"></i> Upload L√™n TPOS
                        </button>
                        <button class="btn btn-warning btn-sm" id="finalizeSessionBtn" onclick="finalizeSession()">
                            <i class="fas fa-flag-checkered"></i> Finalize Session
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- PREVIEW MODAL -->
    <!-- ========================================= -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-eye"></i> Xem Tr∆∞·ªõc Upload
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="previewModalBody">
                    <div class="text-center py-5">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">ƒêang t·∫£i preview...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" id="confirmUploadBtn" onclick="confirmUpload()">
                        <i class="fas fa-check"></i> X√°c Nh·∫≠n Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- FINALIZE SESSION MODAL -->
    <!-- ========================================= -->
    <div class="modal fade" id="finalizeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-flag-checkered"></i> Finalize Session
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Ch√∫ √Ω:</strong> Finalize session s·∫Ω l∆∞u t·∫•t c·∫£ d·ªØ li·ªáu hi·ªán t·∫°i v√†o l·ªãch s·ª≠ v√† x√≥a to√†n b·ªô assignments.
                        B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?
                    </div>

                    <div class="finalize-summary">
                        <h6><i class="fas fa-info-circle"></i> Th·ªëng K√™ Hi·ªán T·∫°i:</h6>
                        <ul>
                            <li>T·ªïng STT: <strong id="finalizeTotalSTT">0</strong></li>
                            <li>T·ªïng S·∫£n Ph·∫©m: <strong id="finalizeTotalProducts">0</strong></li>
                            <li>T·ªïng Items: <strong id="finalizeTotalItems">0</strong></li>
                        </ul>
                    </div>

                    <div class="form-group mt-3">
                        <label for="finalizeNote" class="form-label">Ghi ch√∫ (t√πy ch·ªçn):</label>
                        <textarea class="form-control" id="finalizeNote" rows="3" placeholder="Nh·∫≠p ghi ch√∫ cho session n√†y..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                    <button type="button" class="btn btn-warning" id="confirmFinalizeBtn" onclick="confirmFinalize()">
                        <i class="fas fa-check"></i> X√°c Nh·∫≠n Finalize
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload History Modal -->
    <div class="modal fade" id="uploadHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-history"></i> L·ªãch S·ª≠ Upload TPOS
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Filters -->
                    <div class="history-filters mb-3">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="historyStatusFilter"
                                    onchange="filterUploadHistory()">
                                    <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                    <option value="completed">‚úÖ Th√†nh c√¥ng</option>
                                    <option value="partial">‚ö†Ô∏è Th√†nh c√¥ng m·ªôt ph·∫ßn</option>
                                    <option value="failed">‚ùå Th·∫•t b·∫°i</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control form-control-sm" id="historyDateFrom"
                                    onchange="filterUploadHistory()" placeholder="T·ª´ ng√†y">
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control form-control-sm" id="historyDateTo"
                                    onchange="filterUploadHistory()" placeholder="ƒê·∫øn ng√†y">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" id="historySearchSTT"
                                    oninput="filterUploadHistory()" placeholder="üîç T√¨m STT...">
                            </div>
                        </div>
                    </div>

                    <!-- History List Container -->
                    <div id="historyListContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">ƒêang t·∫£i l·ªãch s·ª≠...</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div id="historyPagination" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload History Detail Modal -->
    <div class="modal fade" id="uploadHistoryDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="historyDetailModalTitle">
                        <i class="fas fa-info-circle"></i> Chi Ti·∫øt Upload
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="historyDetailModalBody">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Cart History Modal -->
    <div class="modal fade" id="compareCartHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-balance-scale"></i> So S√°nh Gi·ªè H√†ng
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="compareCartHistoryModalBody">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- UPLOAD HISTORY V2 MODAL (GI·ªêNG 100% TAB-UPLOAD-TPOS) -->
    <!-- ========================================= -->
    <div class="modal fade" id="uploadHistoryV2Modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-history"></i> L·ªãch S·ª≠ Upload TPOS v2
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Filters -->
                    <div class="history-filters mb-3">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="historyV2UserFilter"
                                    onchange="loadUploadHistoryV2()">
                                    <option value="current">üë§ L·ªãch s·ª≠ c·ªßa t√¥i</option>
                                    <option value="all">üë• T·∫•t c·∫£ ng∆∞·ªùi d√πng</option>
                                    <!-- User options will be populated by JS -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="historyV2StatusFilter"
                                    onchange="filterUploadHistoryV2()">
                                    <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                    <option value="completed">‚úÖ Th√†nh c√¥ng</option>
                                    <option value="partial">‚ö†Ô∏è Th√†nh c√¥ng m·ªôt ph·∫ßn</option>
                                    <option value="failed">‚ùå Th·∫•t b·∫°i</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control form-control-sm" id="historyV2DateFrom"
                                    onchange="filterUploadHistoryV2()" placeholder="T·ª´ ng√†y">
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control form-control-sm" id="historyV2DateTo"
                                    onchange="filterUploadHistoryV2()" placeholder="ƒê·∫øn ng√†y">
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" id="historyV2SearchSTT"
                                    oninput="filterUploadHistoryV2()" placeholder="üîç T√¨m STT...">
                            </div>
                        </div>
                    </div>

                    <!-- History List Container -->
                    <div id="historyV2ListContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">ƒêang t·∫£i l·ªãch s·ª≠...</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div id="historyV2Pagination" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload History V2 Detail Modal -->
    <div class="modal fade" id="uploadHistoryV2DetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="historyV2DetailModalTitle">
                        <i class="fas fa-info-circle"></i> Chi Ti·∫øt Upload
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="historyV2DetailModalBody">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Cart History V2 Modal -->
    <div class="modal fade" id="compareCartHistoryV2Modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-balance-scale"></i> So S√°nh Gi·ªè H√†ng
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="compareCartHistoryV2ModalBody">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Info Tooltip (Hidden by default) -->
    <div class="order-tooltip" id="orderTooltip"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="api-config.js"></script>
    <script src="token-manager.js"></script>
    <script src="cache.js"></script>
    <script src="auth.js"></script>
    <script src="user-storage-manager.js"></script>
    <script src="notification-system.js"></script>
    <!-- Version checker is now in navigation-modern.js (loaded in main.html) -->
    <!-- Note: TPOS token caching is now handled server-side (Cloudflare Worker & Render.com) -->

    <script src="tab3-product-assignment.js"></script>
</body>

</html>