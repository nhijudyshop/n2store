<!--
  üìñ GHI CH√ö CHO L·∫¨P TR√åNH VI√äN:
  Khi code ph·∫£i ƒë·ªçc th∆∞ m·ª•c https://github.com/nhijudyshop/n2store/tree/main/docs tr∆∞·ªõc!
  ƒê·ªçc c√°c file SHARED_*.md ƒë·ªÉ hi·ªÉu c√°ch s·ª≠ d·ª•ng shared modules.
-->
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªëng k√™ KPI - Watermark Method</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/tab1-orders.css">
    <link rel="stylesheet" href="css/report-modern.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f8fafc;
            padding: 20px;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .stats-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-refresh {
            background: #3b82f6;
            color: white;
        }

        .btn-refresh:hover {
            background: #2563eb;
        }

        .btn-export {
            background: #10b981;
            color: white;
        }

        .btn-export:hover {
            background: #059669;
        }

        .btn-timeline {
            background: #8b5cf6;
            color: white;
        }

        .btn-timeline:hover {
            background: #7c3aed;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .table th {
            background: #f1f5f9;
            font-weight: 600;
            color: #475569;
            font-size: 13px;
            padding: 12px 16px;
            white-space: nowrap;
        }

        .table td {
            padding: 12px 16px;
            vertical-align: middle;
            color: #334155;
            font-size: 14px;
        }

        .total-row {
            background: #f8fafc;
            font-weight: 600;
        }

        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clickable-row:hover {
            background-color: #f1f5f9;
        }

        .badge-fraud {
            background: #fef2f2;
            color: #dc2626;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-warning {
            background: #fef3c7;
            color: #d97706;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #059669;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-base {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Fullscreen modal */
        .modal.fade .modal-dialog.modal-fullscreen {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
        }

        .modal-dialog.modal-fullscreen {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .modal-dialog.modal-fullscreen .modal-content,
        .modal .modal-dialog.modal-fullscreen .modal-content {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            border: none !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
        }

        .modal-dialog.modal-fullscreen .modal-body {
            flex: 1 !important;
            overflow-y: auto !important;
        }

        /* Summary cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
        }

        .summary-card-title {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .summary-card-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .summary-card-subtitle {
            font-size: 12px;
            color: #9ca3af;
        }

        .summary-card-blue {
            border-left-color: #3b82f6;
        }

        .summary-card-blue .summary-card-value {
            color: #3b82f6;
        }

        .summary-card-green {
            border-left-color: #10b981;
        }

        .summary-card-green .summary-card-value {
            color: #10b981;
        }

        .summary-card-purple {
            border-left-color: #8b5cf6;
        }

        .summary-card-purple .summary-card-value {
            color: #8b5cf6;
        }

        .summary-card-red {
            border-left-color: #ef4444;
        }

        .summary-card-red .summary-card-value {
            color: #ef4444;
        }
    </style>
</head>

<body>
    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card summary-card-blue">
            <div class="summary-card-title"><i class="fas fa-users"></i> T·ªïng ng∆∞·ªùi d√πng</div>
            <div class="summary-card-value" id="totalUsers">0</div>
            <div class="summary-card-subtitle">C√≥ ƒë∆°n h√†ng KPI</div>
        </div>
        <div class="summary-card summary-card-green">
            <div class="summary-card-title"><i class="fas fa-shopping-cart"></i> T·ªïng ƒë∆°n h√†ng</div>
            <div class="summary-card-value" id="totalOrders">0</div>
            <div class="summary-card-subtitle">C√≥ s·∫£n ph·∫©m KPI</div>
        </div>
        <div class="summary-card summary-card-purple">
            <div class="summary-card-title"><i class="fas fa-box"></i> T·ªïng s·∫£n ph·∫©m</div>
            <div class="summary-card-value" id="totalProducts">0</div>
            <div class="summary-card-subtitle">T√≠nh KPI</div>
        </div>
        <div class="summary-card summary-card-red">
            <div class="summary-card-title"><i class="fas fa-coins"></i> T·ªïng KPI</div>
            <div class="summary-card-value" id="totalKPI">0ƒë</div>
            <div class="summary-card-subtitle">Gi√° tr·ªã thanh to√°n</div>
        </div>
    </div>

    <!-- Main Stats Card -->
    <div class="stats-card">
        <div class="stats-header">
            <div class="stats-title">
                <i class="fas fa-chart-bar" style="color: #3b82f6;"></i>
                Th·ªëng k√™ KPI - Watermark Method
            </div>
            <div class="stats-actions">
                <!-- Campaign Filter -->
                <select id="campaignFilter" class="form-select" style="width: 250px; font-size: 13px;">
                    <option value="">-- Ch·ªçn b·∫£ng/chi·∫øn d·ªãch --</option>
                </select>
                <button class="btn-action btn-timeline" onclick="showTimeline()">
                    <i class="fas fa-chart-line"></i> Timeline
                </button>
                <button class="btn-action btn-export" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
                <button class="btn-action btn-refresh" onclick="refreshStats()">
                    <i class="fas fa-sync-alt"></i> L√†m m·ªõi
                </button>
            </div>
        </div>

        <!-- Campaign Info Bar -->
        <div id="campaignInfoBar" style="display: none; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; padding: 12px 16px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <i class="fas fa-calendar-alt" style="color: #0284c7;"></i>
                    <strong id="selectedCampaignName" style="color: #0369a1;">Ch∆∞a ch·ªçn chi·∫øn d·ªãch</strong>
                    <span id="campaignOrderCount" style="color: #64748b; margin-left: 12px;"></span>
                </div>
                <div id="kpiCalculationStatus" style="font-size: 12px; color: #64748b;">
                    <!-- Status will be shown here -->
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 60px; text-align: center;">STT</th>
                        <th>T√™n ng∆∞·ªùi d√πng</th>
                        <th style="text-align: center; width: 100px;">S·ªë ƒë∆°n</th>
                        <th style="text-align: center;">T·ªïng s·ªë l∆∞·ª£ng</th>
                        <th style="text-align: right;">T·ªïng KPI (5.000ƒë/sp)</th>
                        <th style="text-align: center; width: 120px;">Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-hand-point-up mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>
                            Vui l√≤ng ch·ªçn m·ªôt chi·∫øn d·ªãch ƒë·ªÉ xem th·ªëng k√™ KPI
                        </td>
                    </tr>
                </tbody>
                <tfoot id="statsTableFooter" style="display: none;">
                    <tr class="total-row">
                        <td colspan="2" style="text-align: right;">T·ªïng c·ªông:</td>
                        <td style="text-align: center;" id="grandTotalOrders">0</td>
                        <td style="text-align: center;" id="grandTotalQty">0</td>
                        <td style="text-align: right; color: #dc2626;" id="grandTotalAmount">0ƒë</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div class="modal fade" id="timelineModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-chart-line"></i> Timeline KPI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders List Modal (Level 1) -->
    <div class="modal fade" id="ordersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Danh s√°ch ƒë∆°n h√†ng - <span id="modalUserName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-striped mb-0">
                        <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>STT ƒê∆°n</th>
                                <th style="text-align: center;">S·ªë l∆∞·ª£ng SP</th>
                                <th style="text-align: right;">KPI</th>
                                <th>Th·ªùi gian</th>
                                <th style="text-align: center;">Tr·∫°ng th√°i</th>
                                <th style="text-align: center;">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal (Level 2) -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi ti·∫øt ƒë∆°n h√†ng - <span id="orderDetailsTitle"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" id="orderDetailsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="kpi-comparison-tab" data-bs-toggle="tab"
                                data-bs-target="#kpi-comparison" type="button" role="tab">
                                <i class="fas fa-exchange-alt text-primary"></i> So s√°nh KPI
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-products-tab" data-bs-toggle="tab"
                                data-bs-target="#all-products" type="button" role="tab">
                                <i class="fas fa-box"></i> T·∫•t c·∫£ SP (Current)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="base-products-tab" data-bs-toggle="tab"
                                data-bs-target="#base-products" type="button" role="tab">
                                <i class="fas fa-lock text-warning"></i> BASE Products
                            </button>
                        </li>
                    </ul>

                    <!-- Tab content -->
                    <div class="tab-content pt-3" id="orderDetailsTabContent">
                        <!-- KPI Comparison Tab -->
                        <div class="tab-pane fade show active" id="kpi-comparison" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle"></i>
                                <strong>So s√°nh KPI:</strong> So s√°nh s·∫£n ph·∫©m BASE (khi l∆∞u l·∫ßn ƒë·∫ßu) v·ªõi Current (hi·ªán t·∫°i trong ƒë∆°n).
                                KPI = Current - BASE (ch·ªâ t√≠nh tƒÉng)
                            </div>
                            <table class="table table-hover">
                                <thead class="table-primary">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>M√£ s·∫£n ph·∫©m</th>
                                        <th style="text-align: center; width: 120px;">BASE Qty</th>
                                        <th style="text-align: center; width: 120px;">Current Qty</th>
                                        <th style="text-align: center; width: 120px;">KPI Qty</th>
                                        <th style="text-align: right; width: 150px;">Gi√° tr·ªã KPI</th>
                                    </tr>
                                </thead>
                                <tbody id="kpiComparisonTableBody">
                                    <!-- KPI comparison will be loaded here -->
                                </tbody>
                                <tfoot id="kpiComparisonFooter" style="background: #f0fdf4;">
                                    <tr>
                                        <td colspan="4" style="text-align: right; font-weight: 600;">T·ªïng KPI:</td>
                                        <td style="text-align: center; font-weight: 700; color: #059669;" id="totalKpiQty">0</td>
                                        <td style="text-align: right; font-weight: 700; color: #059669;" id="totalKpiValue">0ƒë</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- All Products Tab -->
                        <div class="tab-pane fade" id="all-products" role="tabpanel">
                            <div class="alert alert-secondary mb-3">
                                <i class="fas fa-info-circle"></i>
                                <strong>Current Products:</strong> Danh s√°ch s·∫£n ph·∫©m hi·ªán t·∫°i trong ƒë∆°n h√†ng (t·ª´ report_order_details)
                            </div>
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>M√£ s·∫£n ph·∫©m</th>
                                        <th style="text-align: center; width: 100px;">S·ªë l∆∞·ª£ng</th>
                                    </tr>
                                </thead>
                                <tbody id="allProductsTableBody">
                                    <!-- All products will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- BASE Products Tab -->
                        <div class="tab-pane fade" id="base-products" role="tabpanel">
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-lock"></i>
                                <strong>BASE Products:</strong> Snapshot s·∫£n ph·∫©m khi l∆∞u l·∫ßn ƒë·∫ßu. Kh√¥ng bao gi·ªù thay ƒë·ªïi sau khi t·∫°o.
                            </div>
                            <table class="table table-hover">
                                <thead class="table-warning">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>M√£ s·∫£n ph·∫©m</th>
                                        <th style="text-align: center; width: 100px;">S·ªë l∆∞·ª£ng</th>
                                    </tr>
                                </thead>
                                <tbody id="baseProductsTableBody">
                                    <!-- BASE products will be loaded here -->
                                </tbody>
                            </table>
                            <div id="baseEmpty" style="display: none; text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-lock-open fa-3x mb-3"></i>
                                <p>Ch∆∞a c√≥ BASE cho ƒë∆°n h√†ng n√†y</p>
                                <small>BASE s·∫Ω ƒë∆∞·ª£c t·∫°o khi l∆∞u ƒë∆°n h√†ng l·∫ßn ƒë·∫ßu</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="fetchOrderFromTPOS()" id="btnFetchTPOS">
                        <i class="fas fa-cloud-download-alt"></i> L·∫•y d·ªØ li·ªáu t·ª´ TPOS
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Config & Auth -->
    <script src="js/core/config.js"></script>
    <script src="../shared/js/shared-auth-manager.js"></script>
    <script>
        // Initialize authManager for backward compatibility
        const authManager = new AuthManager({
            redirectUrl: '../index.html',
            sessionDuration: 8 * 60 * 60 * 1000,
            rememberDuration: 30 * 24 * 60 * 60 * 1000
        });
        window.authManager = authManager;
        function getAuthState() { return authManager.getAuthData(); }
        function isAuthenticated() { return authManager.isAuthenticated(); }
        function hasPermission(level) { return authManager.hasPermission(level); }
        function getUserName() {
            const auth = getAuthState();
            return auth?.userType ? auth.userType.split('-')[0] : 'Admin';
        }
    </script>
    <script src="js/core/token-manager.js"></script>
    <script src="js/core/api-config.js"></script>
    <!-- KPI Manager -->
    <script src="js/managers/kpi-manager.js"></script>

    <script>
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Global state
        let allStatsData = {};
        let timelineChart = null;
        let currentCampaignName = null;
        let campaignsList = [];
        let currentOrderId = null; // For TPOS fetch

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function () {
            loadCampaigns();

            // Campaign filter change handler
            document.getElementById('campaignFilter').addEventListener('change', async function (e) {
                const selectedCampaign = e.target.value;
                if (selectedCampaign) {
                    await onCampaignSelected(selectedCampaign);
                } else {
                    currentCampaignName = null;
                    document.getElementById('campaignInfoBar').style.display = 'none';
                    clearStatsTable();
                }
            });
        });

        // ==================== CAMPAIGN LOADING ====================
        async function loadCampaigns() {
            const select = document.getElementById('campaignFilter');

            try {
                const snapshot = await firebase.database().ref('report_order_details').once('value');
                const data = snapshot.val() || {};

                campaignsList = [];

                for (const key in data) {
                    const campaignData = data[key];
                    if (campaignData && campaignData.tableName) {
                        campaignsList.push({
                            key: key,
                            name: campaignData.tableName,
                            orderCount: campaignData.orders?.length || 0,
                            fetchedAt: campaignData.fetchedAt
                        });
                    }
                }

                // Sort by fetchedAt (newest first)
                campaignsList.sort((a, b) => (b.fetchedAt || 0) - (a.fetchedAt || 0));

                // Populate dropdown
                select.innerHTML = '<option value="">-- Ch·ªçn b·∫£ng/chi·∫øn d·ªãch --</option>';
                campaignsList.forEach(campaign => {
                    const option = document.createElement('option');
                    option.value = campaign.name;
                    option.textContent = `${campaign.name} (${campaign.orderCount} ƒë∆°n)`;
                    select.appendChild(option);
                });

                console.log('[KPI-STATS] Loaded', campaignsList.length, 'campaigns');

            } catch (error) {
                console.error('[KPI-STATS] Error loading campaigns:', error);
            }
        }

        // ==================== CAMPAIGN SELECTION ====================
        async function onCampaignSelected(campaignName) {
            currentCampaignName = campaignName;

            const infoBar = document.getElementById('campaignInfoBar');
            const nameEl = document.getElementById('selectedCampaignName');
            const countEl = document.getElementById('campaignOrderCount');
            const statusEl = document.getElementById('kpiCalculationStatus');

            infoBar.style.display = 'block';
            nameEl.textContent = campaignName;

            const campaign = campaignsList.find(c => c.name === campaignName);
            countEl.textContent = campaign ? `(${campaign.orderCount} ƒë∆°n h√†ng)` : '';

            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t√≠nh KPI...';

            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-calculator fa-spin mb-2" style="font-size: 24px;"></i><br>
                        ƒêang t√≠nh KPI cho chi·∫øn d·ªãch "<strong>${campaignName}</strong>"...
                    </td>
                </tr>
            `;

            try {
                // Load and display statistics (calculate KPI directly from BASE vs Current)
                await loadStatsForCampaign(campaignName, statusEl);

            } catch (error) {
                console.error('[KPI-STATS] Error calculating KPI:', error);
                statusEl.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> L·ªói: ${error.message}`;
            }
        }

        // ==================== CALCULATE KPI (same logic as Order Details Modal) ====================
        function calculateOrderKPI(baseProducts, currentProducts) {
            // Create maps for comparison (same logic as renderKPIComparisonTab)
            const baseMap = new Map();
            (baseProducts || []).forEach(p => {
                const code = (p.code || '').toUpperCase();
                if (code) baseMap.set(code, p.quantity || 0);
            });

            const currentMap = new Map();
            (currentProducts || []).forEach(p => {
                const code = (p.code || '').toUpperCase();
                if (code) currentMap.set(code, p.quantity || 0);
            });

            let totalKpiQty = 0;

            // Calculate KPI for all products
            const allCodes = new Set([...baseMap.keys(), ...currentMap.keys()]);
            for (const code of allCodes) {
                const baseQty = baseMap.get(code) || 0;
                const currentQty = currentMap.get(code) || 0;
                const kpiQty = Math.max(0, currentQty - baseQty); // Only count increases
                totalKpiQty += kpiQty;
            }

            return {
                differences: totalKpiQty,
                kpi: totalKpiQty * 5000
            };
        }

        // ==================== LOAD STATISTICS ====================
        async function loadStatsForCampaign(campaignName, statusEl) {
            const tbody = document.getElementById('statsTableBody');
            const tfoot = document.getElementById('statsTableFooter');

            try {
                // Get orders from report_order_details
                const safeTableName = campaignName.replace(/[.$#\[\]\/]/g, '_');
                const ordersSnapshot = await firebase.database()
                    .ref(`report_order_details/${safeTableName}`)
                    .once('value');

                const ordersData = ordersSnapshot.val();
                if (!ordersData || !ordersData.orders || ordersData.orders.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-box-open mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>
                                Ch∆∞a c√≥ ƒë∆°n h√†ng trong chi·∫øn d·ªãch n√†y
                            </td>
                        </tr>
                    `;
                    tfoot.style.display = 'none';
                    updateSummaryCards(0, 0, 0, 0);
                    if (statusEl) statusEl.innerHTML = '<i class="fas fa-info-circle" style="color: #64748b;"></i> Kh√¥ng c√≥ ƒë∆°n h√†ng';
                    return;
                }

                const orders = ordersData.orders;

                // Get all BASE data
                const baseSnapshot = await firebase.database().ref('kpi_base').once('value');
                const allBases = baseSnapshot.val() || {};

                // Calculate KPI for each order (same logic as Order Details Modal)
                const userStats = {};
                let processedCount = 0;
                let noBaseCount = 0;

                for (const order of orders) {
                    const orderId = order.Id || order.id;
                    if (!orderId) continue;

                    // Get BASE for this order
                    const base = allBases[orderId];

                    // Get current products from order (same as getOrderDetailsFromFirebase)
                    const currentProducts = [];
                    if (order.Details && Array.isArray(order.Details)) {
                        order.Details.forEach(d => {
                            const code = d.ProductCode || d.Code || d.DefaultCode || '';
                            if (code) {
                                currentProducts.push({
                                    code: code,
                                    quantity: d.Quantity || 1
                                });
                            }
                        });
                    }

                    // Calculate KPI
                    let kpiResult = { differences: 0, kpi: 0 };
                    let hasBase = false;

                    if (base && base.products) {
                        hasBase = true;
                        kpiResult = calculateOrderKPI(base.products, currentProducts);
                        processedCount++;
                    } else {
                        noBaseCount++;
                    }

                    // Get user info from BASE or order
                    const userId = base?.userId || order.UserId || order.User?.Id || 'unknown';
                    const userName = base?.userName || order.User?.Name || order.UserName || 'Unknown';
                    const stt = base?.stt || order.SessionIndex || 0;

                    // Aggregate by user
                    if (!userStats[userId]) {
                        userStats[userId] = {
                            id: userId,
                            name: userName,
                            totalDifferences: 0,
                            totalKPI: 0,
                            orders: []
                        };
                    }

                    userStats[userId].totalDifferences += kpiResult.differences;
                    userStats[userId].totalKPI += kpiResult.kpi;
                    userStats[userId].orders.push({
                        orderId: orderId,
                        stt: stt,
                        differences: kpiResult.differences,
                        kpi: kpiResult.kpi,
                        hasBase: hasBase,
                        timestamp: base?.timestamp || Date.now()
                    });
                }

                // Update status
                if (statusEl) {
                    let statusText = `<i class="fas fa-check-circle" style="color: #10b981;"></i> ƒê√£ t√≠nh ${processedCount} ƒë∆°n`;
                    if (noBaseCount > 0) statusText += ` <span class="badge-base">${noBaseCount} ƒë∆°n ch∆∞a c√≥ BASE</span>`;
                    statusEl.innerHTML = statusText;
                }

                // Calculate totals
                let totalUsers = Object.keys(userStats).length;
                let totalOrders = 0;
                let totalDifferences = 0;
                let totalKPI = 0;

                for (const user of Object.values(userStats)) {
                    totalOrders += user.orders.length;
                    totalDifferences += user.totalDifferences;
                    totalKPI += user.totalKPI;
                }

                if (totalOrders === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-box-open mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>
                                Ch∆∞a c√≥ d·ªØ li·ªáu KPI cho chi·∫øn d·ªãch n√†y
                                <br><small>Vui l√≤ng ƒë·∫£m b·∫£o ƒë√£ l∆∞u BASE cho c√°c ƒë∆°n h√†ng</small>
                            </td>
                        </tr>
                    `;
                    tfoot.style.display = 'none';
                    updateSummaryCards(0, 0, 0, 0);
                    return;
                }

                // Render table
                let html = '';
                let index = 1;

                // Sort by KPI descending
                const sortedUsers = Object.values(userStats).sort((a, b) => b.totalKPI - a.totalKPI);

                for (const user of sortedUsers) {
                    const hasHighKPI = user.totalKPI > 100000;

                    html += `
                        <tr class="clickable-row ${hasHighKPI ? 'table-warning' : ''}"
                            onclick="showUserOrders('${user.id}', '${user.name.replace(/'/g, "\\'")}')">
                            <td style="text-align: center;">${index++}</td>
                            <td>
                                <strong>${user.name}</strong>
                                ${hasHighKPI ? '<span class="badge-warning" style="margin-left: 8px;"><i class="fas fa-star"></i> Top KPI</span>' : ''}
                            </td>
                            <td style="text-align: center;">${user.orders.length}</td>
                            <td style="text-align: center;">${user.totalDifferences}</td>
                            <td style="text-align: right; color: #dc2626; font-weight: 600;">
                                ${user.totalKPI.toLocaleString('vi-VN')}ƒë
                            </td>
                            <td style="text-align: center;">
                                <span class="badge ${user.totalDifferences > 0 ? 'badge-success' : 'badge-warning'}">
                                    ${user.totalDifferences > 0 ? 'C√≥ KPI' : 'Ch∆∞a c√≥ KPI'}
                                </span>
                            </td>
                        </tr>
                    `;
                }

                tbody.innerHTML = html;

                // Update footer
                tfoot.style.display = 'table-footer-group';
                document.getElementById('grandTotalOrders').textContent = totalOrders;
                document.getElementById('grandTotalQty').textContent = totalDifferences;
                document.getElementById('grandTotalAmount').textContent = totalKPI.toLocaleString('vi-VN') + 'ƒë';

                // Update summary cards
                updateSummaryCards(totalUsers, totalOrders, totalDifferences, totalKPI);

                // Store for later use
                allStatsData = userStats;

            } catch (error) {
                console.error('[KPI-STATS] Error loading stats:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle mb-2" style="font-size: 24px;"></i><br>
                            L·ªói: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // ==================== SHOW USER ORDERS ====================
        function showUserOrders(userId, userName) {
            const user = allStatsData[userId];
            if (!user) return;

            document.getElementById('modalUserName').textContent = userName;

            const tbody = document.getElementById('ordersTableBody');
            let html = '';

            // Sort orders by stt
            const sortedOrders = [...user.orders].sort((a, b) => (a.stt || 0) - (b.stt || 0));

            sortedOrders.forEach((order, index) => {
                const hasKPI = order.differences > 0;
                const hasBase = order.hasBase !== false;

                html += `
                    <tr class="clickable-row ${!hasBase ? 'table-secondary' : ''}" onclick="showOrderKPIDetails('${order.orderId}', ${order.stt})">
                        <td>${index + 1}</td>
                        <td>
                            <strong>STT ${order.stt}</strong>
                            ${!hasBase ? '<span class="badge-base">Ch∆∞a c√≥ BASE</span>' : ''}
                        </td>
                        <td style="text-align: center;">${order.differences} SP</td>
                        <td style="text-align: right; color: #dc2626; font-weight: 600;">${(order.kpi || 0).toLocaleString('vi-VN')}ƒë</td>
                        <td>${order.timestamp ? new Date(order.timestamp).toLocaleString('vi-VN') : '-'}</td>
                        <td style="text-align: center;">
                            <span class="badge ${hasKPI ? 'badge-success' : 'badge-warning'}">
                                ${hasKPI ? 'C√≥ KPI' : 'Kh√¥ng KPI'}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showOrderKPIDetails('${order.orderId}', ${order.stt})">
                                <i class="fas fa-eye"></i> Chi ti·∫øt
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html || `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-box-open mb-2"></i><br>Kh√¥ng c√≥ ƒë∆°n h√†ng
                    </td>
                </tr>
            `;

            const modal = new bootstrap.Modal(document.getElementById('ordersModal'));
            modal.show();
        }

        // ==================== SHOW ORDER KPI DETAILS ====================
        async function showOrderKPIDetails(orderId, stt) {
            currentOrderId = orderId; // Store for TPOS fetch
            document.getElementById('orderDetailsTitle').textContent = `STT ${stt}`;

            // Show loading
            const comparisonBody = document.getElementById('kpiComparisonTableBody');
            const allBody = document.getElementById('allProductsTableBody');
            const baseBody = document.getElementById('baseProductsTableBody');

            comparisonBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</td></tr>`;
            allBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</td></tr>`;
            baseBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</td></tr>`;

            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();

            try {
                // Load BASE and current products
                const base = await window.kpiManager.getKPIBase(orderId);
                const currentProducts = currentCampaignName
                    ? await window.kpiManager.getOrderDetailsFromFirebase(orderId, currentCampaignName)
                    : null;

                // Render KPI Comparison Tab
                renderKPIComparisonTab(base, currentProducts);

                // Render All Products Tab (Current)
                renderAllProductsTab(currentProducts);

                // Render BASE Products Tab
                renderBaseProductsTab(base);

            } catch (error) {
                console.error('[KPI-DETAILS] Error loading order details:', error);
                comparisonBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> L·ªói: ${error.message}</td></tr>`;
            }
        }

        // ==================== RENDER TABS ====================
        function renderKPIComparisonTab(base, currentProducts) {
            const tbody = document.getElementById('kpiComparisonTableBody');
            const baseEmpty = document.getElementById('baseEmpty');

            if (!base || !base.products || base.products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-lock-open fa-2x mb-3" style="opacity: 0.5;"></i><br>
                            Ch∆∞a c√≥ BASE cho ƒë∆°n h√†ng n√†y<br>
                            <small>BASE s·∫Ω ƒë∆∞·ª£c t·∫°o khi l∆∞u ƒë∆°n h√†ng l·∫ßn ƒë·∫ßu</small>
                        </td>
                    </tr>
                `;
                document.getElementById('totalKpiQty').textContent = '0';
                document.getElementById('totalKpiValue').textContent = '0ƒë';
                return;
            }

            // Create maps for comparison
            const baseMap = new Map();
            base.products.forEach(p => {
                baseMap.set(p.code.toUpperCase(), p.quantity);
            });

            const currentMap = new Map();
            if (currentProducts) {
                currentProducts.forEach(p => {
                    currentMap.set(p.code.toUpperCase(), p.quantity);
                });
            }

            let html = '';
            let index = 1;
            let totalKpiQty = 0;
            let totalKpiValue = 0;

            // Process all unique product codes
            const allCodes = new Set([...baseMap.keys(), ...currentMap.keys()]);
            const sortedCodes = Array.from(allCodes).sort();

            for (const code of sortedCodes) {
                const baseQty = baseMap.get(code) || 0;
                const currentQty = currentMap.get(code) || 0;
                const kpiQty = Math.max(0, currentQty - baseQty);
                const kpiValue = kpiQty * 5000;

                totalKpiQty += kpiQty;
                totalKpiValue += kpiValue;

                const rowClass = kpiQty > 0 ? 'table-success' : (baseQty > 0 && currentQty === 0 ? 'table-danger' : '');
                const isNew = baseQty === 0 && currentQty > 0;

                html += `
                    <tr class="${rowClass}">
                        <td>${index++}</td>
                        <td>
                            <code>${code}</code>
                            ${isNew ? '<span class="badge bg-info ms-2">M·ªõi</span>' : ''}
                        </td>
                        <td style="text-align: center;">${baseQty}</td>
                        <td style="text-align: center; font-weight: 600;">${currentQty}</td>
                        <td style="text-align: center; font-weight: 700; color: ${kpiQty > 0 ? '#059669' : '#6b7280'};">
                            ${kpiQty > 0 ? '+' : ''}${kpiQty}
                        </td>
                        <td style="text-align: right; font-weight: 600; color: ${kpiValue > 0 ? '#059669' : '#6b7280'};">
                            ${kpiValue.toLocaleString('vi-VN')}ƒë
                        </td>
                    </tr>
                `;
            }

            tbody.innerHTML = html || `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                        Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÉ so s√°nh
                    </td>
                </tr>
            `;

            document.getElementById('totalKpiQty').textContent = totalKpiQty;
            document.getElementById('totalKpiValue').textContent = totalKpiValue.toLocaleString('vi-VN') + 'ƒë';
        }

        function renderAllProductsTab(currentProducts) {
            const tbody = document.getElementById('allProductsTableBody');

            if (!currentProducts || currentProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-box-open mb-2"></i><br>Kh√¥ng c√≥ s·∫£n ph·∫©m
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            currentProducts.forEach((p, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><code>${p.code}</code></td>
                        <td style="text-align: center; font-weight: 600;">${p.quantity}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function renderBaseProductsTab(base) {
            const tbody = document.getElementById('baseProductsTableBody');
            const emptyEl = document.getElementById('baseEmpty');

            if (!base || !base.products || base.products.length === 0) {
                tbody.innerHTML = '';
                emptyEl.style.display = 'block';
                return;
            }

            emptyEl.style.display = 'none';

            let html = '';
            base.products.forEach((p, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><code>${p.code}</code></td>
                        <td style="text-align: center; font-weight: 600;">${p.quantity}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // ==================== UTILITY FUNCTIONS ====================
        function clearStatsTable() {
            const tbody = document.getElementById('statsTableBody');
            const tfoot = document.getElementById('statsTableFooter');

            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-hand-point-up mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>
                        Vui l√≤ng ch·ªçn m·ªôt chi·∫øn d·ªãch ƒë·ªÉ xem th·ªëng k√™ KPI
                    </td>
                </tr>
            `;
            tfoot.style.display = 'none';
            updateSummaryCards(0, 0, 0, 0);
            allStatsData = {};
        }

        function updateSummaryCards(users, orders, products, kpi) {
            document.getElementById('totalUsers').textContent = users.toLocaleString('vi-VN');
            document.getElementById('totalOrders').textContent = orders.toLocaleString('vi-VN');
            document.getElementById('totalProducts').textContent = products.toLocaleString('vi-VN');
            document.getElementById('totalKPI').textContent = (typeof kpi === 'number' ? kpi : 0).toLocaleString('vi-VN') + 'ƒë';
        }

        function refreshStats() {
            if (currentCampaignName) {
                onCampaignSelected(currentCampaignName);
            } else {
                loadCampaigns();
            }
        }

        // ==================== TIMELINE CHART ====================
        function showTimeline() {
            const modal = new bootstrap.Modal(document.getElementById('timelineModal'));
            modal.show();

            if (Object.keys(allStatsData).length === 0) {
                document.getElementById('timelineChart').parentElement.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #94a3b8;">
                        <i class="fas fa-chart-line fa-3x mb-3" style="opacity: 0.5;"></i>
                        <p>Ch·ªçn chi·∫øn d·ªãch ƒë·ªÉ xem timeline KPI</p>
                    </div>
                `;
                return;
            }

            // Aggregate data by date
            const dateMap = new Map();

            Object.values(allStatsData).forEach(userStat => {
                userStat.orders.forEach(order => {
                    const timestamp = order.timestamp || Date.now();
                    const date = new Date(timestamp).toLocaleDateString('vi-VN');
                    const kpi = order.kpi || 0;
                    const diff = order.differences || 0;

                    if (!dateMap.has(date)) {
                        dateMap.set(date, { kpi: 0, qty: 0, count: 0 });
                    }

                    dateMap.get(date).kpi += kpi;
                    dateMap.get(date).qty += diff;
                    dateMap.get(date).count += 1;
                });
            });

            // Sort by date
            const sortedDates = Array.from(dateMap.keys()).sort((a, b) => {
                const [da, ma, ya] = a.split('/').map(Number);
                const [db, mb, yb] = b.split('/').map(Number);
                return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
            });

            const labels = sortedDates;
            const dataKPI = sortedDates.map(date => dateMap.get(date).kpi / 1000); // Convert to thousands
            const dataQty = sortedDates.map(date => dateMap.get(date).qty);

            // Destroy old chart
            if (timelineChart) {
                timelineChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'KPI (ngh√¨n ƒë·ªìng)',
                            data: dataKPI,
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'S·ªë l∆∞·ª£ng SP',
                            data: dataQty,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Timeline KPI - ${currentCampaignName || 'T·∫•t c·∫£'}`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'KPI (ngh√¨n ƒë·ªìng)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'S·ªë l∆∞·ª£ng SP'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // ==================== EXPORT TO EXCEL ====================
        function exportToExcel() {
            if (Object.keys(allStatsData).length === 0) {
                alert('Vui l√≤ng ch·ªçn chi·∫øn d·ªãch tr∆∞·ªõc khi export');
                return;
            }

            try {
                const data = [];

                // Add header
                data.push(['TH·ªêNG K√ä KPI - WATERMARK METHOD']);
                data.push(['Chi·∫øn d·ªãch:', currentCampaignName || 'N/A']);
                data.push(['Xu·∫•t ng√†y:', new Date().toLocaleString('vi-VN')]);
                data.push([]);

                // Add user summary
                data.push(['STT', 'T√™n ng∆∞·ªùi d√πng', 'S·ªë ƒë∆°n', 'T·ªïng SL', 'T·ªïng KPI (ƒë)']);

                const sortedUsers = Object.values(allStatsData).sort((a, b) => b.totalKPI - a.totalKPI);
                sortedUsers.forEach((user, index) => {
                    data.push([
                        index + 1,
                        user.name,
                        user.orders.length,
                        user.totalDifferences,
                        user.totalKPI
                    ]);
                });

                // Add totals
                data.push([]);
                data.push([
                    '',
                    'T·ªîNG C·ªòNG',
                    sortedUsers.reduce((sum, u) => sum + u.orders.length, 0),
                    sortedUsers.reduce((sum, u) => sum + u.totalDifferences, 0),
                    sortedUsers.reduce((sum, u) => sum + u.totalKPI, 0)
                ]);

                // Add order details
                data.push([]);
                data.push(['CHI TI·∫æT ƒê∆†N H√ÄNG']);
                data.push(['Ng∆∞·ªùi d√πng', 'STT ƒê∆°n', 'Order ID', 'SL SP', 'KPI (ƒë)', 'Th·ªùi gian']);

                sortedUsers.forEach(user => {
                    user.orders.forEach(order => {
                        data.push([
                            user.name,
                            order.stt,
                            order.orderId,
                            order.differences,
                            order.kpi,
                            order.timestamp ? new Date(order.timestamp).toLocaleString('vi-VN') : ''
                        ]);
                    });
                });

                // Create workbook
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Th·ªëng k√™ KPI');

                // Save file
                const safeName = (currentCampaignName || 'all').replace(/[^a-zA-Z0-9]/g, '_');
                const fileName = `KPI_${safeName}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert('ƒê√£ export th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('L·ªói export: ' + error.message);
            }
        }

        // ==================== FETCH ORDER FROM TPOS ====================
        async function fetchOrderFromTPOS() {
            if (!currentOrderId) {
                alert('Kh√¥ng c√≥ Order ID');
                return;
            }

            if (!currentCampaignName) {
                alert('Kh√¥ng c√≥ chi·∫øn d·ªãch ƒë∆∞·ª£c ch·ªçn');
                return;
            }

            const btn = document.getElementById('btnFetchTPOS');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...';
            btn.disabled = true;

            try {
                // Get auth headers
                const headers = await window.tokenManager.getAuthHeader();

                // Fetch order from TPOS API
                const apiUrl = `https://chatomni-proxy.nhijudyshop.workers.dev/api/odata/SaleOnline_Order(${currentOrderId})?$expand=Details,Partner,User`;
                const response = await API_CONFIG.smartFetch(apiUrl, {
                    headers: {
                        ...headers,
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const orderData = await response.json();
                console.log('[TPOS-FETCH] Order data:', orderData);

                // Convert TPOS Details to our format
                const currentProducts = (orderData.Details || []).map(d => ({
                    code: d.ProductCode || d.Code || d.DefaultCode || '',
                    quantity: d.Quantity || 1
                })).filter(p => p.code);

                console.log('[TPOS-FETCH] Current products:', currentProducts);

                // ==================== UPDATE FIREBASE report_order_details ====================
                // Find and update only this order in Firebase
                const safeTableName = currentCampaignName.replace(/[.$#\[\]\/]/g, '_');
                const ordersRef = firebase.database().ref(`report_order_details/${safeTableName}/orders`);

                const ordersSnapshot = await ordersRef.once('value');
                const orders = ordersSnapshot.val() || [];

                // Find index of this order
                let orderIndex = -1;
                for (let i = 0; i < orders.length; i++) {
                    const order = orders[i];
                    const orderId = order.Id || order.id;
                    if (orderId === currentOrderId) {
                        orderIndex = i;
                        break;
                    }
                }

                if (orderIndex !== -1) {
                    // Update the specific order's Details in Firebase
                    const orderRef = firebase.database().ref(`report_order_details/${safeTableName}/orders/${orderIndex}`);

                    // Update Details from TPOS data
                    await orderRef.update({
                        Details: orderData.Details || [],
                        _tposFetchedAt: Date.now(),
                        _tposFetchedBy: 'tab2-statistics'
                    });

                    console.log('[TPOS-FETCH] Updated Firebase order at index:', orderIndex);
                } else {
                    console.warn('[TPOS-FETCH] Order not found in Firebase campaign:', currentOrderId);
                }

                // Get BASE and re-render
                const base = await window.kpiManager.getKPIBase(currentOrderId);

                // Re-render tabs with fresh data
                renderKPIComparisonTab(base, currentProducts);
                renderAllProductsTab(currentProducts);
                renderBaseProductsTab(base);

                // Show success
                btn.innerHTML = '<i class="fas fa-check"></i> ƒê√£ c·∫≠p nh·∫≠t!';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('[TPOS-FETCH] Error:', error);
                alert('L·ªói l·∫•y d·ªØ li·ªáu t·ª´ TPOS: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>
