<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống kê KPI - Watermark Method</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="tab1-orders.css">
    <link rel="stylesheet" href="report-modern.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f8fafc;
            padding: 20px;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .stats-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-refresh {
            background: #3b82f6;
            color: white;
        }

        .btn-refresh:hover {
            background: #2563eb;
        }

        .btn-export {
            background: #10b981;
            color: white;
        }

        .btn-export:hover {
            background: #059669;
        }

        .btn-timeline {
            background: #8b5cf6;
            color: white;
        }

        .btn-timeline:hover {
            background: #7c3aed;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .table th {
            background: #f1f5f9;
            font-weight: 600;
            color: #475569;
            font-size: 13px;
            padding: 12px 16px;
            white-space: nowrap;
        }

        .table td {
            padding: 12px 16px;
            vertical-align: middle;
            color: #334155;
            font-size: 14px;
        }

        .total-row {
            background: #f8fafc;
            font-weight: 600;
        }

        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clickable-row:hover {
            background-color: #f1f5f9;
        }

        .badge-fraud {
            background: #fef2f2;
            color: #dc2626;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-warning {
            background: #fef3c7;
            color: #d97706;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #059669;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Fullscreen modal */
        .modal.fade .modal-dialog.modal-fullscreen {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
        }

        .modal-dialog.modal-fullscreen {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .modal-dialog.modal-fullscreen .modal-content,
        .modal .modal-dialog.modal-fullscreen .modal-content {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            border: none !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
        }

        .modal-dialog.modal-fullscreen .modal-body {
            flex: 1 !important;
            overflow-y: auto !important;
        }

        /* Watermark badges */
        .watermark-info {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }

        .watermark-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
            margin-right: 4px;
        }

        .watermark-baseline {
            background: #e5e7eb;
            color: #4b5563;
        }

        .watermark-current {
            background: #dbeafe;
            color: #1e40af;
        }

        .watermark-kpi {
            background: #d1fae5;
            color: #059669;
            font-weight: 600;
        }

        /* Fraud warning */
        .fraud-warning-row {
            background: #fef2f2 !important;
        }

        .fraud-warning-icon {
            color: #dc2626;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Summary cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
        }

        .summary-card-title {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .summary-card-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .summary-card-subtitle {
            font-size: 12px;
            color: #9ca3af;
        }

        .summary-card-blue {
            border-left-color: #3b82f6;
        }

        .summary-card-blue .summary-card-value {
            color: #3b82f6;
        }

        .summary-card-green {
            border-left-color: #10b981;
        }

        .summary-card-green .summary-card-value {
            color: #10b981;
        }

        .summary-card-purple {
            border-left-color: #8b5cf6;
        }

        .summary-card-purple .summary-card-value {
            color: #8b5cf6;
        }

        .summary-card-red {
            border-left-color: #ef4444;
        }

        .summary-card-red .summary-card-value {
            color: #ef4444;
        }
    </style>
</head>

<body>
    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card summary-card-blue">
            <div class="summary-card-title"><i class="fas fa-users"></i> Tổng người dùng</div>
            <div class="summary-card-value" id="totalUsers">0</div>
            <div class="summary-card-subtitle">Đang hoạt động</div>
        </div>
        <div class="summary-card summary-card-green">
            <div class="summary-card-title"><i class="fas fa-shopping-cart"></i> Tổng đơn hàng</div>
            <div class="summary-card-value" id="totalOrders">0</div>
            <div class="summary-card-subtitle">Có sản phẩm KPI</div>
        </div>
        <div class="summary-card summary-card-purple">
            <div class="summary-card-title"><i class="fas fa-box"></i> Tổng sản phẩm</div>
            <div class="summary-card-value" id="totalProducts">0</div>
            <div class="summary-card-subtitle">Tính KPI</div>
        </div>
        <div class="summary-card summary-card-red">
            <div class="summary-card-title"><i class="fas fa-exclamation-triangle"></i> Cảnh báo</div>
            <div class="summary-card-value" id="totalFraudWarnings">0</div>
            <div class="summary-card-subtitle">Nghi ngờ gian lận</div>
        </div>
    </div>

    <!-- Main Stats Card -->
    <div class="stats-card">
        <div class="stats-header">
            <div class="stats-title">
                <i class="fas fa-chart-bar" style="color: #3b82f6;"></i>
                Thống kê KPI - Watermark Method
            </div>
            <div class="stats-actions">
                <button class="btn-action btn-timeline" onclick="showTimeline()">
                    <i class="fas fa-chart-line"></i> Timeline
                </button>
                <button class="btn-action btn-export" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
                <button class="btn-action btn-refresh" onclick="loadStats()">
                    <i class="fas fa-sync-alt"></i> Làm mới
                </button>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 60px; text-align: center;">STT</th>
                        <th>Tên người dùng</th>
                        <th style="text-align: center; width: 100px;">Số đơn</th>
                        <th style="text-align: center;">Tổng số lượng</th>
                        <th style="text-align: right;">Tổng tiền (5.000đ/sp)</th>
                        <th style="text-align: center; width: 120px;">Trạng thái</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-spinner fa-spin mb-2"></i><br>Đang tải dữ liệu...
                        </td>
                    </tr>
                </tbody>
                <tfoot id="statsTableFooter" style="display: none;">
                    <tr class="total-row">
                        <td colspan="2" style="text-align: right;">Tổng cộng:</td>
                        <td style="text-align: center;" id="grandTotalOrders">0</td>
                        <td style="text-align: center;" id="grandTotalQty">0</td>
                        <td style="text-align: right; color: #3b82f6;" id="grandTotalAmount">0đ</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div class="modal fade" id="timelineModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-chart-line"></i> Timeline KPI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders List Modal (Level 1) -->
    <div class="modal fade" id="ordersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Danh sách đơn hàng - <span id="modalUserName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-striped mb-0">
                        <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>STT Đơn</th>
                                <th>Số lượng SP</th>
                                <th>KPI</th>
                                <th>Thời gian</th>
                                <th>Trạng thái</th>
                                <th style="text-align: center;">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal (Level 2) -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết đơn hàng - <span id="orderDetailsTitle"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" id="orderDetailsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="all-products-tab" data-bs-toggle="tab"
                                data-bs-target="#all-products" type="button" role="tab">
                                <i class="fas fa-box"></i> Tất cả SP
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="kpi-products-tab" data-bs-toggle="tab"
                                data-bs-target="#kpi-products" type="button" role="tab">
                                <i class="fas fa-star text-warning"></i> SP có KPI
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="non-kpi-products-tab" data-bs-toggle="tab"
                                data-bs-target="#non-kpi-products" type="button" role="tab">
                                <i class="fas fa-circle text-muted"></i> SP không KPI
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="invoice-tab" data-bs-toggle="tab" data-bs-target="#invoice"
                                type="button" role="tab">
                                <i class="fas fa-file-invoice"></i> Hóa đơn
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="baseline-tab" data-bs-toggle="tab" data-bs-target="#baseline"
                                type="button" role="tab">
                                <i class="fas fa-lock text-primary"></i> Baseline
                            </button>
                        </li>
                    </ul>

                    <!-- Tab content -->
                    <div class="tab-content pt-3" id="orderDetailsTabContent">
                        <!-- All Products Tab -->
                        <div class="tab-pane fade show active" id="all-products" role="tabpanel">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Tên sản phẩm</th>
                                        <th style="text-align: center; width: 100px;">Số lượng</th>
                                        <th style="text-align: center; width: 200px;">Watermark</th>
                                        <th style="text-align: right; width: 150px;">Giá</th>
                                    </tr>
                                </thead>
                                <tbody id="allProductsTableBody">
                                    <!-- All products will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- KPI Products Tab -->
                        <div class="tab-pane fade" id="kpi-products" role="tabpanel">
                            <table class="table table-hover">
                                <thead class="table-success">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Tên sản phẩm</th>
                                        <th style="text-align: center; width: 100px;">Baseline</th>
                                        <th style="text-align: center; width: 100px;">Current</th>
                                        <th style="text-align: center; width: 100px;">KPI Qty</th>
                                        <th style="text-align: right; width: 150px;">Giá trị KPI</th>
                                    </tr>
                                </thead>
                                <tbody id="kpiProductsTableBody">
                                    <!-- KPI products will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Non-KPI Products Tab -->
                        <div class="tab-pane fade" id="non-kpi-products" role="tabpanel">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Tên sản phẩm</th>
                                        <th style="text-align: center; width: 100px;">Số lượng</th>
                                        <th style="text-align: center; width: 200px;">Watermark</th>
                                        <th>Lý do không tính KPI</th>
                                    </tr>
                                </thead>
                                <tbody id="nonKpiProductsTableBody">
                                    <!-- Non-KPI products will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Invoice Tab -->
                        <div class="tab-pane fade" id="invoice" role="tabpanel">
                            <div class="alert alert-info mb-3 d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Hóa đơn:</strong> Danh sách hóa đơn (30 ngày gần nhất) của khách hàng này, được tải từ API.
                                </div>
                                <button class="btn btn-sm btn-primary" id="refreshInvoiceBtn" style="display: none;">
                                    <i class="fas fa-sync-alt"></i> Làm mới
                                </button>
                            </div>
                            <div id="invoiceContent">
                                <div style="text-align: center; padding: 40px; color: #94a3b8;">
                                    <i class="fas fa-spinner fa-spin mb-2"></i><br>Đang tải hóa đơn...
                                </div>
                            </div>
                        </div>

                        <!-- Baseline Tab -->
                        <div class="tab-pane fade" id="baseline" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle"></i>
                                <strong>Baseline:</strong> Snapshot sản phẩm trong đơn khi thực hiện hành động đầu tiên.
                                Được dùng để so sánh và phát hiện thay đổi. Baseline không bao giờ thay đổi sau khi được tạo.
                            </div>
                            <table class="table table-hover">
                                <thead class="table-primary">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Tên sản phẩm</th>
                                        <th style="text-align: center; width: 150px;">Baseline Qty</th>
                                        <th style="text-align: center; width: 150px;">Current Qty</th>
                                        <th style="text-align: center; width: 150px;">KPI Qty</th>
                                        <th style="text-align: center; width: 100px;">Thay đổi</th>
                                    </tr>
                                </thead>
                                <tbody id="baselineTableBody">
                                    <!-- Baseline products will be loaded here -->
                                </tbody>
                            </table>
                            <div id="baselineEmpty" style="display: none; text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-lock-open fa-3x mb-3"></i>
                                <p>Chưa có baseline cho đơn hàng này</p>
                                <small>Baseline sẽ được tạo khi thực hiện hành động đầu tiên trên đơn hàng</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Config & Auth -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="token-manager.js"></script>
    <script src="api-config.js"></script>

    <script>
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        let allStatsData = {};
        let allOrderSnapshots = {};
        let timelineChart = null;

        document.addEventListener('DOMContentLoaded', function () {
            loadStats();
        });

        async function loadStats() {
            const tbody = document.getElementById('statsTableBody');
            const tfoot = document.getElementById('statsTableFooter');

            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-spinner fa-spin mb-2"></i><br>Đang tải dữ liệu...
                    </td>
                </tr>
            `;

            try {
                // Fetch both stats and snapshots in parallel
                const [statsSnapshot, orderSnapshotsSnapshot] = await Promise.all([
                    firebase.database().ref('held_product_stats').once('value'),
                    firebase.database().ref('order_snapshots').once('value')
                ]);

                const data = statsSnapshot.val();
                const allSnapshots = orderSnapshotsSnapshot.val() || {};
                allOrderSnapshots = allSnapshots;

                if (!data) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-box-open mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>Chưa có dữ liệu
                            </td>
                        </tr>
                    `;
                    tfoot.style.display = 'none';
                    updateSummaryCards(0, 0, 0, 0);
                    return;
                }

                allStatsData = data;

                // Aggregate data by user
                const userStats = {};

                Object.keys(data).forEach(userId => {
                    const userRecords = data[userId];
                    if (!userRecords) return;

                    Object.values(userRecords).forEach(record => {
                        if (!userStats[userId]) {
                            userStats[userId] = {
                                name: record.userName || 'Unknown',
                                totalQty: 0,
                                totalAmount: 0,
                                orderIds: new Set(),
                                id: userId,
                                hasMismatch: false,
                                hasNegativeKPI: false,
                                fraudScore: 0,
                                mismatchDetails: []
                            };
                        }

                        const qty = parseInt(record.productCount) || 0;
                        const amount = record.amount || (qty * 5000);

                        userStats[userId].totalQty += qty;
                        userStats[userId].totalAmount += amount;

                        // Track negative KPI (reductions)
                        if (record.isReduction) {
                            userStats[userId].hasNegativeKPI = true;
                            userStats[userId].fraudScore += 1;
                        }

                        if (record.orderId) {
                            userStats[userId].orderIds.add(record.orderId);
                        }

                        if (record.userName && record.userName !== 'Unknown') {
                            userStats[userId].name = record.userName;
                        }
                    });
                });

                // NOTE: Invoice validation removed - invoiceProducts no longer stored in snapshot
                // Invoice data will be loaded on-demand from API using partnerId

                // Render table
                let html = '';
                let grandTotalQty = 0;
                let grandTotalAmount = 0;
                let grandTotalOrders = 0;
                let totalFraudWarnings = 0;
                let stt = 1;

                Object.values(userStats).forEach(stat => {
                    const orderCount = stat.orderIds.size;

                    let rowClass = "clickable-row";
                    let statusHtml = '<span class="badge-success">OK</span>';

                    // Determine fraud level
                    if (stat.fraudScore >= 3) {
                        rowClass += " fraud-warning-row";
                        statusHtml = `<span class="badge-fraud"><i class="fas fa-exclamation-triangle fraud-warning-icon"></i> Nghi ngờ</span>`;
                        totalFraudWarnings++;
                    } else if (stat.hasNegativeKPI || stat.hasMismatch) {
                        statusHtml = '<span class="badge-warning"><i class="fas fa-exclamation-circle"></i> Cảnh báo</span>';
                    }

                    const tooltipText = stat.mismatchDetails.join('\\n');
                    const tooltipAttr = stat.mismatchDetails.length > 0 ? `title="${tooltipText}"` : '';

                    html += `
                        <tr class="${rowClass}" onclick="showOrders('${stat.id}', '${stat.name.replace(/'/g, "\\'")}')" ${tooltipAttr}>
                            <td style="text-align: center;">${stt++}</td>
                            <td style="font-weight: 500;">${stat.name}</td>
                            <td style="text-align: center; color: #059669; font-weight: 500;">${orderCount}</td>
                            <td style="text-align: center;">${stat.totalQty.toLocaleString('vi-VN')}</td>
                            <td style="text-align: right; font-weight: 600;">${stat.totalAmount.toLocaleString('vi-VN')}đ</td>
                            <td style="text-align: center;">${statusHtml}</td>
                        </tr>
                    `;
                    grandTotalQty += stat.totalQty;
                    grandTotalAmount += stat.totalAmount;
                    grandTotalOrders += orderCount;
                });

                tbody.innerHTML = html;

                // Update footer
                document.getElementById('grandTotalOrders').textContent = grandTotalOrders.toLocaleString('vi-VN');
                document.getElementById('grandTotalQty').textContent = grandTotalQty.toLocaleString('vi-VN');
                document.getElementById('grandTotalAmount').textContent = grandTotalAmount.toLocaleString('vi-VN') + 'đ';
                tfoot.style.display = 'table-footer-group';

                // Update summary cards
                updateSummaryCards(Object.keys(userStats).length, grandTotalOrders, grandTotalQty, totalFraudWarnings);

            } catch (error) {
                console.error('Error loading stats:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle mb-2"></i><br>Lỗi tải dữ liệu: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function updateSummaryCards(users, orders, products, warnings) {
            document.getElementById('totalUsers').textContent = users.toLocaleString('vi-VN');
            document.getElementById('totalOrders').textContent = orders.toLocaleString('vi-VN');
            document.getElementById('totalProducts').textContent = products.toLocaleString('vi-VN');
            document.getElementById('totalFraudWarnings').textContent = warnings.toLocaleString('vi-VN');
        }

        // Level 1: Show list of orders for a user
        async function showOrders(userId, userName) {
            document.getElementById('modalUserName').textContent = userName;
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-spinner fa-spin mb-2"></i><br>Đang tải danh sách đơn...
                    </td>
                </tr>
            `;

            const modal = new bootstrap.Modal(document.getElementById('ordersModal'));
            modal.show();

            try {
                const userOrders = [];
                Object.values(allOrderSnapshots).forEach(order => {
                    if (order.userId === userId) {
                        userOrders.push(order);
                    }
                });

                if (userOrders.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-box-open mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>Chưa có đơn hàng
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Sort by timestamp desc
                userOrders.sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));

                // Calculate KPI for each order
                const ordersWithKPI = userOrders.map(order => {
                    const orderId = order.orderId;
                    let orderKPI = 0;
                    let hasWarning = false;

                    // Find KPI stats for this order
                    if (allStatsData[userId]) {
                        Object.values(allStatsData[userId]).forEach(stat => {
                            if (stat.orderId === orderId) {
                                orderKPI += (stat.productCount || 0);
                                if (stat.isReduction) {
                                    hasWarning = true;
                                }
                            }
                        });
                    }

                    // NOTE: Invoice mismatch check removed - invoiceProducts no longer in snapshot

                    return { ...order, kpi: orderKPI, hasWarning };
                });

                // Render orders table
                let html = '';
                let index = 1;

                ordersWithKPI.forEach(order => {
                    const date = new Date(order.lastUpdated);
                    const timeStr = date.toLocaleString('vi-VN');
                    const productCount = order.products ? order.products.length : 0;
                    const kpiDisplay = order.kpi !== 0 ? (order.kpi > 0 ? `+${order.kpi}` : order.kpi) : '0';
                    const kpiColor = order.kpi > 0 ? '#059669' : (order.kpi < 0 ? '#dc2626' : '#6b7280');
                    const statusBadge = order.hasWarning ? '<span class="badge-warning"><i class="fas fa-exclamation-circle"></i></span>' : '';

                    html += `
                        <tr class="clickable-row ${order.hasWarning ? 'table-warning' : ''}" onclick="showOrderDetails('${order.orderId}', '${order.orderSTT}')">
                            <td>${index++}</td>
                            <td style="font-weight: 500;">${order.orderSTT || 'N/A'}</td>
                            <td style="text-align: center;">${productCount}</td>
                            <td style="text-align: center; font-weight: 600; color: ${kpiColor};">${kpiDisplay}</td>
                            <td style="font-size: 13px;">${timeStr}</td>
                            <td style="text-align: center;">${statusBadge}</td>
                            <td style="text-align: center;">
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); showOrderDetails('${order.orderId}', '${order.orderSTT}')">
                                    <i class="fas fa-eye"></i> Xem
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;

            } catch (error) {
                console.error('Error loading orders:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle mb-2"></i><br>Lỗi tải danh sách đơn: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Level 2: Show product list and invoice for an order
        async function showOrderDetails(orderId, orderSTT) {
            document.getElementById('orderDetailsTitle').textContent = orderSTT || orderId;

            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();

            const order = allOrderSnapshots[orderId];
            if (!order) {
                console.error('Order not found in snapshots:', orderId);
                return;
            }

            // Fetch KPI stats for this order
            let kpiProductsMap = new Map();

            try {
                const statsRef = firebase.database().ref('held_product_stats');
                const statsSnapshot = await statsRef.once('value');
                const allStats = statsSnapshot.val();

                if (allStats) {
                    Object.values(allStats).forEach(userStats => {
                        Object.values(userStats).forEach(statRecord => {
                            if (statRecord.orderId === orderId && statRecord.products) {
                                statRecord.products.forEach(p => {
                                    const key = p.name || 'Unknown';
                                    kpiProductsMap.set(key, p);
                                });
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading KPI stats:', error);
            }

            // Render ALL products table
            const allProductsBody = document.getElementById('allProductsTableBody');
            let allHtml = '';
            let allIndex = 1;

            if (order.products && order.products.length > 0) {
                order.products.forEach(p => {
                    const kpiData = kpiProductsMap.get(p.name);
                    const watermarkHtml = kpiData ? `
                        <span class="watermark-badge watermark-baseline">B: ${kpiData.baselineQty || 0}</span>
                        <span class="watermark-badge watermark-current">C: ${kpiData.newQuantityInOrder || p.quantity}</span>
                        <span class="watermark-badge watermark-kpi">KPI: ${kpiData.newKpiQty || 0}</span>
                    ` : '<span style="color: #9ca3af; font-size: 11px;">Không có KPI</span>';

                    allHtml += `
                        <tr>
                            <td>${allIndex++}</td>
                            <td>${p.name || 'Unknown Product'}</td>
                            <td style="text-align: center; font-weight: 600;">${p.quantity || 0}</td>
                            <td style="text-align: center;">${watermarkHtml}</td>
                            <td style="text-align: right;">${(p.price || 0).toLocaleString('vi-VN')}đ</td>
                        </tr>
                    `;
                });
            } else {
                allHtml = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-box-open mb-2"></i><br>Không có sản phẩm
                        </td>
                    </tr>
                `;
            }
            allProductsBody.innerHTML = allHtml;

            // Render KPI products table
            const kpiProductsBody = document.getElementById('kpiProductsTableBody');
            let kpiHtml = '';
            let kpiIndex = 1;
            let hasKpiProducts = false;

            if (order.products && order.products.length > 0) {
                order.products.forEach(p => {
                    const kpiData = kpiProductsMap.get(p.name);
                    if (kpiData && kpiData.isCounted && kpiData.incrementalQty > 0) {
                        hasKpiProducts = true;
                        const kpiValue = kpiData.incrementalQty * 5000;
                        kpiHtml += `
                            <tr>
                                <td>${kpiIndex++}</td>
                                <td>${p.name || 'Unknown Product'}</td>
                                <td style="text-align: center;">${kpiData.baselineQty || 0}</td>
                                <td style="text-align: center; font-weight: 600;">${kpiData.newQuantityInOrder || 0}</td>
                                <td style="text-align: center; color: #059669; font-weight: 700;">${kpiData.newKpiQty || 0}</td>
                                <td style="text-align: right; color: #059669; font-weight: 600;">${kpiValue.toLocaleString('vi-VN')}đ</td>
                            </tr>
                        `;
                    }
                });
            }

            if (!hasKpiProducts) {
                kpiHtml = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-info-circle mb-2"></i><br>Không có sản phẩm được tính KPI
                        </td>
                    </tr>
                `;
            }
            kpiProductsBody.innerHTML = kpiHtml;

            // Render NON-KPI products table
            const nonKpiProductsBody = document.getElementById('nonKpiProductsTableBody');
            let nonKpiHtml = '';
            let nonKpiIndex = 1;
            let hasNonKpiProducts = false;

            if (order.products && order.products.length > 0) {
                order.products.forEach(p => {
                    const kpiData = kpiProductsMap.get(p.name);
                    let reason = '';
                    let isNonKpi = false;

                    if (!kpiData) {
                        isNonKpi = true;
                        reason = 'Sản phẩm không qua "Sản phẩm đang giữ"';
                    } else if (!kpiData.isCounted || kpiData.incrementalQty === 0) {
                        isNonKpi = true;
                        if (kpiData.newQuantityInOrder <= kpiData.baselineQty) {
                            reason = `Không vượt baseline (Baseline: ${kpiData.baselineQty}, Current: ${kpiData.newQuantityInOrder})`;
                        } else if (kpiData.oldKpiQty >= kpiData.newKpiQty) {
                            reason = `Không tăng KPI (Old: ${kpiData.oldKpiQty}, New: ${kpiData.newKpiQty})`;
                        } else {
                            reason = 'Không đủ điều kiện tính KPI';
                        }
                    }

                    if (isNonKpi) {
                        hasNonKpiProducts = true;
                        const watermarkHtml = kpiData ? `
                            <span class="watermark-badge watermark-baseline">B: ${kpiData.baselineQty || 0}</span>
                            <span class="watermark-badge watermark-current">C: ${kpiData.newQuantityInOrder || p.quantity}</span>
                        ` : '<span style="color: #9ca3af; font-size: 11px;">N/A</span>';

                        nonKpiHtml += `
                            <tr>
                                <td>${nonKpiIndex++}</td>
                                <td>${p.name || 'Unknown Product'}</td>
                                <td style="text-align: center;">${p.quantity || 0}</td>
                                <td style="text-align: center;">${watermarkHtml}</td>
                                <td><span class="badge bg-secondary">${reason}</span></td>
                            </tr>
                        `;
                    }
                });
            }

            if (!hasNonKpiProducts) {
                nonKpiHtml = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-info-circle mb-2"></i><br>Tất cả sản phẩm đều được tính KPI
                        </td>
                    </tr>
                `;
            }
            nonKpiProductsBody.innerHTML = nonKpiHtml;

            // Load invoice when invoice tab is clicked
            document.getElementById('invoice-tab').addEventListener('click', async function () {
                await loadInvoice(orderId, order.partnerId);
                // Show refresh button after loading
                const refreshBtn = document.getElementById('refreshInvoiceBtn');
                if (refreshBtn) {
                    refreshBtn.style.display = 'inline-block';
                    // Add click handler for refresh button
                    refreshBtn.onclick = async () => {
                        await loadInvoice(orderId, order.partnerId);
                    };
                }
            }, { once: true });

            // Load baseline when baseline tab is clicked
            document.getElementById('baseline-tab').addEventListener('click', async function () {
                await loadBaseline(orderId, order.products);
            }, { once: true });
        }

        // Fetch invoice history from API using partnerId
        async function fetchInvoiceHistory(partnerId) {
            if (!partnerId) {
                throw new Error('No partnerId provided');
            }

            // Calculate date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            const formatDate = (date) => {
                return date.toISOString().split('T')[0]; // YYYY-MM-DD
            };

            // Use same endpoint as chat-product-manager.js
            const apiUrl = `https://chatomni-proxy.nhijudyshop.workers.dev/api/odata/FastSaleOrder/ODataService.GetOrdersByPartnerId?partnerId=${partnerId}&fromDate=${formatDate(startDate)}&toDate=${formatDate(endDate)}`;

            console.log('[INVOICE-FETCH] Fetching invoices for partnerId:', partnerId);

            try {
                const headers = await window.tokenManager.getAuthHeader();
                const response = await API_CONFIG.smartFetch(apiUrl, {
                    headers: {
                        ...headers,
                        "Content-Type": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const invoices = data.value || [];

                console.log(`[INVOICE-FETCH] Fetched ${invoices.length} invoices`);

                // Fetch details for each invoice (with OrderLines)
                const detailedInvoices = [];
                for (const invoice of invoices) {
                    try {
                        const details = await fetchInvoiceDetails(invoice.Id);
                        if (details) {
                            detailedInvoices.push(details);
                        }
                    } catch (error) {
                        console.error(`[INVOICE-FETCH] Error fetching details for invoice ${invoice.Id}:`, error);
                        // Still add basic invoice without details
                        detailedInvoices.push(invoice);
                    }
                }

                console.log(`[INVOICE-FETCH] Fetched ${detailedInvoices.length} invoices with details`);
                return detailedInvoices;
            } catch (error) {
                console.error('[INVOICE-FETCH] API Error:', error);
                throw error;
            }
        }

        // Fetch invoice details with OrderLines
        async function fetchInvoiceDetails(invoiceId) {
            const apiUrl = `https://chatomni-proxy.nhijudyshop.workers.dev/api/odata/FastSaleOrder(${invoiceId})?$expand=OrderLines($expand=Product,ProductUOM,User)`;

            try {
                const headers = await window.tokenManager.getAuthHeader();
                const response = await API_CONFIG.smartFetch(apiUrl, {
                    headers: {
                        ...headers,
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log(`[INVOICE-FETCH] Fetched details for invoice ${invoiceId} with ${data.OrderLines?.length || 0} products`);
                return data;
            } catch (error) {
                console.error(`[INVOICE-FETCH] Error fetching invoice ${invoiceId} details:`, error);
                throw error;
            }
        }

        // Fetch and display invoice using partnerId
        async function loadInvoice(orderId, partnerId) {
            const invoiceContent = document.getElementById('invoiceContent');

            if (!partnerId) {
                invoiceContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-file-invoice mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>
                        Không có thông tin khách hàng (partnerId)
                        <p style="font-size: 12px; margin-top: 8px; color: #6b7280;">Không thể tải hóa đơn</p>
                    </div>
                `;
                return;
            }

            invoiceContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #94a3b8;">
                    <i class="fas fa-spinner fa-spin mb-2"></i><br>Đang tải hóa đơn từ API...
                </div>
            `;

            try {
                // Fetch invoices using partnerId
                const invoices = await fetchInvoiceHistory(partnerId);

                if (!invoices || invoices.length === 0) {
                    invoiceContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-file-invoice mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>
                            Không tìm thấy hóa đơn nào (30 ngày gần nhất)
                        </div>
                    `;
                    return;
                }

                // Render all invoices with their OrderLines
                let html = `<div style="padding: 20px;">`;

                invoices.forEach((invoice, idx) => {
                    const invoiceProducts = invoice.OrderLines || [];

                    html += `
                        <div class="card mb-3" style="border-left: 4px solid #3b82f6;">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-file-invoice"></i> Hóa đơn #${invoice.Id}
                                    <span class="badge bg-light text-primary" style="font-size: 10px;">Từ API</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p style="font-size: 13px; margin-bottom: 4px;"><strong>Ngày tạo:</strong> ${invoice.DateInvoice ? new Date(invoice.DateInvoice).toLocaleString('vi-VN') : 'N/A'}</p>
                                        <p style="font-size: 13px; margin-bottom: 4px;"><strong>Trạng thái:</strong> ${invoice.ShowState || invoice.State || 'N/A'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p style="font-size: 13px; margin-bottom: 4px;"><strong>Tổng tiền:</strong> ${(invoice.AmountTotal || 0).toLocaleString('vi-VN')}đ</p>
                                        <p style="font-size: 13px; margin-bottom: 4px;"><strong>Đã thanh toán:</strong> ${(invoice.PaymentAmount || 0).toLocaleString('vi-VN')}đ</p>
                                    </div>
                                </div>

                                ${invoiceProducts.length > 0 ? `
                                    <div class="table-responsive mt-3">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 40px;">#</th>
                                                    <th>Sản phẩm</th>
                                                    <th style="text-align: center; width: 80px;">SL</th>
                                                    <th style="text-align: right; width: 120px;">Đơn giá</th>
                                                    <th style="text-align: right; width: 120px;">Thành tiền</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${invoiceProducts.map((line, idx) => {
                                                    const productName = line.Product?.NameGet || line.ProductName || 'Unknown Product';
                                                    const quantity = line.ProductUOMQty || line.Quantity || 0;
                                                    const price = line.PriceUnit || line.Price || 0;
                                                    const total = line.PriceTotal || (quantity * price);

                                                    return `
                                                        <tr>
                                                            <td>${idx + 1}</td>
                                                            <td style="font-size: 12px;">${productName}</td>
                                                            <td style="text-align: center; font-weight: 600;">${quantity}</td>
                                                            <td style="text-align: right;">${price.toLocaleString('vi-VN')}đ</td>
                                                            <td style="text-align: right; font-weight: 600; color: #059669;">${total.toLocaleString('vi-VN')}đ</td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                            <tfoot style="background: #f9fafb;">
                                                <tr>
                                                    <td colspan="4" style="text-align: right; font-weight: 600; font-size: 13px;">Tổng:</td>
                                                    <td style="text-align: right; font-weight: 700; color: #059669; font-size: 14px;">
                                                        ${invoiceProducts.reduce((sum, p) => sum + (p.PriceTotal || 0), 0).toLocaleString('vi-VN')}đ
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                ` : `
                                    <div class="alert alert-warning mb-0 mt-2" style="font-size: 12px;">
                                        <i class="fas fa-exclamation-circle"></i> Hóa đơn không có sản phẩm
                                    </div>
                                `}
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                invoiceContent.innerHTML = html;

                console.log('[INVOICE] Loaded', invoices.length, 'invoices for partnerId:', partnerId);

            } catch (error) {
                console.error('[INVOICE] Error loading invoices:', error);
                invoiceContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle mb-2"></i><br>
                        Lỗi tải hóa đơn: ${error.message}
                        <p style="font-size: 12px; margin-top: 8px;">Vui lòng thử lại sau</p>
                    </div>
                `;
            }
        }

        // Fetch and display baseline
        async function loadBaseline(orderId, orderProducts) {
            const baselineTableBody = document.getElementById('baselineTableBody');
            const baselineEmpty = document.getElementById('baselineEmpty');

            // Show loading
            baselineTableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-spinner fa-spin mb-2"></i><br>Đang tải baseline...
                    </td>
                </tr>
            `;
            baselineEmpty.style.display = 'none';

            try {
                // Fetch baseline from Firebase order_product_history
                const historyRef = firebase.database().ref(`order_product_history/${orderId}`);
                const historySnapshot = await historyRef.once('value');
                const historyData = historySnapshot.val();

                if (!historyData || Object.keys(historyData).length === 0) {
                    // No baseline data
                    baselineTableBody.innerHTML = '';
                    baselineEmpty.style.display = 'block';
                    return;
                }

                // Create a map of product names from order products
                const productNamesMap = new Map();
                if (orderProducts && orderProducts.length > 0) {
                    orderProducts.forEach(p => {
                        productNamesMap.set(String(p.productId), p.name);
                    });
                }

                // Build baseline table
                let html = '';
                let index = 1;
                let hasBaseline = false;

                Object.entries(historyData).forEach(([productId, data]) => {
                    const baselineQty = data.baselineQty || 0;
                    const currentQty = data.currentQty || 0;
                    const kpiQty = data.kpiQty || 0;
                    const productName = productNamesMap.get(productId) || `Product #${productId}`;

                    // Calculate change
                    const change = currentQty - baselineQty;
                    const changeClass = change > 0 ? 'text-success' : (change < 0 ? 'text-danger' : 'text-muted');
                    const changeIcon = change > 0 ? 'fa-arrow-up' : (change < 0 ? 'fa-arrow-down' : 'fa-minus');
                    const changeText = change > 0 ? `+${change}` : change;

                    hasBaseline = true;
                    html += `
                        <tr>
                            <td>${index++}</td>
                            <td>${productName}</td>
                            <td style="text-align: center; font-weight: 600; color: #6366f1;">
                                <i class="fas fa-lock" style="font-size: 10px; opacity: 0.5;"></i> ${baselineQty}
                            </td>
                            <td style="text-align: center; font-weight: 600;">${currentQty}</td>
                            <td style="text-align: center; font-weight: 700; color: #059669;">${kpiQty}</td>
                            <td style="text-align: center;">
                                <span class="${changeClass}">
                                    <i class="fas ${changeIcon}"></i> ${changeText}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                if (hasBaseline) {
                    baselineTableBody.innerHTML = html;
                    baselineEmpty.style.display = 'none';
                } else {
                    baselineTableBody.innerHTML = '';
                    baselineEmpty.style.display = 'block';
                }

            } catch (error) {
                console.error('Error loading baseline:', error);
                baselineTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle mb-2"></i><br>Lỗi tải baseline: ${error.message}
                        </td>
                    </tr>
                `;
                baselineEmpty.style.display = 'none';
            }
        }

        // Show Timeline Chart
        function showTimeline() {
            const modal = new bootstrap.Modal(document.getElementById('timelineModal'));
            modal.show();

            // Aggregate data by date
            const dateMap = new Map();

            Object.values(allStatsData).forEach(userStats => {
                Object.values(userStats).forEach(record => {
                    const timestamp = record.timestamp || 0;
                    const date = new Date(timestamp).toLocaleDateString('vi-VN');
                    const qty = parseInt(record.productCount) || 0;

                    if (!dateMap.has(date)) {
                        dateMap.set(date, { qty: 0, count: 0 });
                    }

                    dateMap.get(date).qty += qty;
                    dateMap.get(date).count += 1;
                });
            });

            // Sort by date
            const sortedDates = Array.from(dateMap.keys()).sort((a, b) => {
                return new Date(a.split('/').reverse().join('/')) - new Date(b.split('/').reverse().join('/'));
            });

            const labels = sortedDates;
            const dataQty = sortedDates.map(date => dateMap.get(date).qty);
            const dataCount = sortedDates.map(date => dateMap.get(date).count);

            // Destroy old chart
            if (timelineChart) {
                timelineChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Tổng số lượng KPI',
                            data: dataQty,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Số lượt "Lưu vào đơn"',
                            data: dataCount,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Biểu đồ KPI theo thời gian',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Số lượng KPI'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Số lượt lưu'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Export to Excel
        function exportToExcel() {
            try {
                // Prepare data
                const data = [];

                // Add summary row
                data.push(['THỐNG KÊ KPI - WATERMARK METHOD']);
                data.push(['Xuất ngày:', new Date().toLocaleString('vi-VN')]);
                data.push([]);

                // Add user stats
                data.push(['STT', 'Tên người dùng', 'Số đơn', 'Tổng số lượng', 'Tổng tiền (đ)', 'Trạng thái']);

                Object.values(allStatsData).forEach((userStats, userIndex) => {
                    const userData = Object.values(userStats)[0];
                    if (!userData) return;

                    let totalQty = 0;
                    let totalAmount = 0;
                    const orderIds = new Set();

                    Object.values(userStats).forEach(record => {
                        const qty = parseInt(record.productCount) || 0;
                        totalQty += qty;
                        totalAmount += (record.amount || qty * 5000);
                        if (record.orderId) orderIds.add(record.orderId);
                    });

                    data.push([
                        userIndex + 1,
                        userData.userName || 'Unknown',
                        orderIds.size,
                        totalQty,
                        totalAmount,
                        'OK'
                    ]);
                });

                // Create workbook
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Thống kê KPI');

                // Save file
                const fileName = `KPI_Statistics_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert('Đã export thành công!');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Lỗi export: ' + error.message);
            }
        }
    </script>
</body>

</html>
