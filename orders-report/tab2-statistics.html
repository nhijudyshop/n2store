<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống kê sản phẩm đang giữ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="tab1-orders.css">
    <link rel="stylesheet" href="report-modern.css">
    <style>
        body {
            background-color: #f8fafc;
            padding: 20px;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .table th {
            background: #f1f5f9;
            font-weight: 600;
            color: #475569;
            font-size: 13px;
            padding: 12px 16px;
        }

        .table td {
            padding: 12px 16px;
            vertical-align: middle;
            color: #334155;
            font-size: 14px;
        }

        .total-row {
            background: #f8fafc;
            font-weight: 600;
        }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: #2563eb;
        }

        /* Clickable row */
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clickable-row:hover {
            background-color: #f1f5f9;
        }

        /* Fullscreen modal styles - Override Bootstrap and report-modern.css */
        /* Important: report-modern.css has .modal-content { max-width: 600px } that needs to be overridden */

        .modal.fade .modal-dialog.modal-fullscreen {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
        }

        .modal-dialog.modal-fullscreen {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Override the max-width: 600px from report-modern.css */
        .modal-dialog.modal-fullscreen .modal-content,
        .modal .modal-dialog.modal-fullscreen .modal-content,
        #ordersModal .modal-content,
        #orderDetailsModal .modal-content {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            border: none !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
        }

        .modal-dialog.modal-fullscreen .modal-body {
            flex: 1 !important;
            overflow-y: auto !important;
        }

        .modal-dialog.modal-fullscreen .modal-header,
        .modal-dialog.modal-fullscreen .modal-footer {
            flex-shrink: 0 !important;
        }
    </style>
</head>

<body>
    <div class="stats-card">
        <div class="stats-header">
            <div class="stats-title">
                <i class="fas fa-chart-bar" style="color: #3b82f6;"></i>
                Thống kê sản phẩm đang giữ đã lưu vào đơn
            </div>
            <button class="refresh-btn" onclick="loadStats()">
                <i class="fas fa-sync-alt"></i> Làm mới
            </button>
        </div>

        <div class="table-container">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 60px; text-align: center;">STT</th>
                        <th>Tên người dùng</th>
                        <th style="text-align: center; width: 100px;">Số đơn</th>
                        <th style="text-align: center;">Tổng số lượng</th>
                        <th style="text-align: right;">Tổng tiền (5.000đ/sp)</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-spinner fa-spin mb-2"></i><br>Đang tải dữ liệu...
                        </td>
                    </tr>
                </tbody>
                <tfoot id="statsTableFooter" style="display: none;">
                    <tr class="total-row">
                        <td colspan="2" style="text-align: right;">Tổng cộng:</td>
                        <td style="text-align: center;" id="grandTotalOrders">0</td>
                        <td style="text-align: center;" id="grandTotalQty">0</td>
                        <td style="text-align: right; color: #3b82f6;" id="grandTotalAmount">0đ</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Orders List Modal (Level 1) -->
    <div class="modal fade" id="ordersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Danh sách đơn hàng - <span id="modalUserName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-striped mb-0">
                        <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>STT Đơn</th>
                                <th>Số lượng SP</th>
                                <th>Thời gian</th>
                                <th style="text-align: center;">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal (Level 2) -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết đơn hàng - <span id="orderDetailsTitle"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" id="orderDetailsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="all-products-tab" data-bs-toggle="tab"
                                data-bs-target="#all-products" type="button" role="tab">
                                <i class="fas fa-box"></i> Tất cả SP
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="kpi-products-tab" data-bs-toggle="tab"
                                data-bs-target="#kpi-products" type="button" role="tab">
                                <i class="fas fa-star text-warning"></i> SP có KPI
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="non-kpi-products-tab" data-bs-toggle="tab"
                                data-bs-target="#non-kpi-products" type="button" role="tab">
                                <i class="fas fa-circle text-muted"></i> SP không KPI
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="invoice-tab" data-bs-toggle="tab" data-bs-target="#invoice"
                                type="button" role="tab">
                                <i class="fas fa-file-invoice"></i> Hóa đơn
                            </button>
                        </li>
                    </ul>

                    <!-- Tab content -->
                    <div class="tab-content pt-3" id="orderDetailsTabContent">
                        <!-- All Products Tab -->
                        <div class="tab-pane fade show active" id="all-products" role="tabpanel">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Tên sản phẩm</th>
                                        <th style="text-align: center; width: 100px;">Số lượng</th>
                                        <th style="text-align: right; width: 150px;">Giá</th>
                                    </tr>
                                </thead>
                                <tbody id="allProductsTableBody">
                                    <!-- All products will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- KPI Products Tab -->
                        <div class="tab-pane fade" id="kpi-products" role="tabpanel">
                            <table class="table table-hover">
                                <thead class="table-success">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Tên sản phẩm</th>
                                        <th style="text-align: center; width: 100px;">SL trong đơn</th>
                                        <th style="text-align: center; width: 100px;">SL tính KPI</th>
                                        <th style="text-align: right; width: 150px;">Giá trị KPI</th>
                                    </tr>
                                </thead>
                                <tbody id="kpiProductsTableBody">
                                    <!-- KPI products will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Non-KPI Products Tab -->
                        <div class="tab-pane fade" id="non-kpi-products" role="tabpanel">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Tên sản phẩm</th>
                                        <th style="text-align: center; width: 100px;">Số lượng</th>
                                        <th>Lý do không tính KPI</th>
                                    </tr>
                                </thead>
                                <tbody id="nonKpiProductsTableBody">
                                    <!-- Non-KPI products will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Invoice Tab -->
                        <div class="tab-pane fade" id="invoice" role="tabpanel">
                            <div id="invoiceContent">
                                <div style="text-align: center; padding: 40px; color: #94a3b8;">
                                    <i class="fas fa-spinner fa-spin mb-2"></i><br>Đang tải hóa đơn...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Config & Auth -->
    <script src="config.js"></script>
    <script src="auth.js"></script>

    <script>
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        let allStatsData = {}; // Store raw data for modal
        let allOrderSnapshots = {}; // Store order snapshots

        document.addEventListener('DOMContentLoaded', function () {
            loadStats();
        });

        async function loadStats() {
            const tbody = document.getElementById('statsTableBody');
            const tfoot = document.getElementById('statsTableFooter');

            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-spinner fa-spin mb-2"></i><br>Đang tải dữ liệu...
                    </td>
                </tr>
            `;

            try {
                // Fetch both stats and snapshots in parallel
                const [statsSnapshot, orderSnapshotsSnapshot] = await Promise.all([
                    firebase.database().ref('held_product_stats').once('value'),
                    firebase.database().ref('order_snapshots').once('value')
                ]);

                const data = statsSnapshot.val();
                const allSnapshots = orderSnapshotsSnapshot.val() || {};
                allOrderSnapshots = allSnapshots; // Save for modal usage

                if (!data) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-box-open mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>Chưa có dữ liệu
                            </td>
                        </tr>
                    `;
                    tfoot.style.display = 'none';
                    return;
                }

                allStatsData = data; // Save for modal usage

                // Aggregate data by user
                const userStats = {};

                // Data structure: userId -> timestamp -> { userName, productCount, amount, orderId, ... }
                Object.keys(data).forEach(userId => {
                    const userRecords = data[userId];
                    if (!userRecords) return;

                    Object.values(userRecords).forEach(record => {
                        if (!userStats[userId]) {
                            userStats[userId] = {
                                name: record.userName || 'Unknown',
                                totalQty: 0,
                                totalAmount: 0,
                                orderIds: new Set(), // Track unique order IDs
                                id: userId, // Store ID for click handler
                                hasMismatch: false, // Track if any order has mismatch
                                mismatchDetails: [] // Store details of mismatches
                            };
                        }

                        // Use stored amount or calculate 5000 * qty
                        const qty = parseInt(record.productCount) || 0;
                        const amount = record.amount || (qty * 5000);

                        userStats[userId].totalQty += qty;
                        userStats[userId].totalAmount += amount;

                        // Track unique order IDs
                        if (record.orderId) {
                            userStats[userId].orderIds.add(record.orderId);
                        }

                        // Update name if better one found (optional)
                        if (record.userName && record.userName !== 'Unknown') {
                            userStats[userId].name = record.userName;
                        }
                    });
                });

                // Validate products vs invoice for each user
                Object.values(userStats).forEach(stat => {
                    stat.orderIds.forEach(orderId => {
                        const order = allSnapshots[orderId];
                        if (!order) return;

                        // Check if invoice products exist
                        if (order.invoiceProducts && Array.isArray(order.invoiceProducts) && order.invoiceProducts.length > 0) {
                            const orderProducts = order.products || [];
                            const invoiceProducts = order.invoiceProducts;

                            // 1. Check count mismatch
                            if (orderProducts.length !== invoiceProducts.length) {
                                stat.hasMismatch = true;
                                stat.mismatchDetails.push(`Đơn ${order.orderSTT}: Số lượng mã SP không khớp (${orderProducts.length} vs ${invoiceProducts.length})`);
                                return;
                            }

                            // 2. Check content mismatch (Name and Quantity)
                            // Create maps for easier comparison
                            const orderMap = new Map();
                            orderProducts.forEach(p => {
                                const key = (p.name || '').trim();
                                orderMap.set(key, (orderMap.get(key) || 0) + (p.quantity || 0));
                            });

                            const invoiceMap = new Map();
                            invoiceProducts.forEach(p => {
                                const key = (p.name || '').trim();
                                invoiceMap.set(key, (invoiceMap.get(key) || 0) + (p.quantity || 0));
                            });

                            // Compare maps
                            let isMatch = true;
                            if (orderMap.size !== invoiceMap.size) {
                                isMatch = false;
                            } else {
                                for (const [name, qty] of orderMap) {
                                    if (!invoiceMap.has(name) || invoiceMap.get(name) !== qty) {
                                        isMatch = false;
                                        break;
                                    }
                                }
                            }

                            if (!isMatch) {
                                stat.hasMismatch = true;
                                stat.mismatchDetails.push(`Đơn ${order.orderSTT}: Thông tin sản phẩm không khớp với hóa đơn`);
                            }
                        }
                    });
                });

                // Render table
                let html = '';
                let grandTotalQty = 0;
                let grandTotalAmount = 0;
                let grandTotalOrders = 0;
                let stt = 1;

                Object.values(userStats).forEach(stat => {
                    const orderCount = stat.orderIds.size;
                    
                    // Determine row class and tooltip
                    let rowClass = "clickable-row";
                    let warningIcon = "";
                    let tooltipAttr = "";
                    
                    if (stat.hasMismatch) {
                        rowClass += " table-danger"; // Bootstrap danger class
                        const tooltipText = stat.mismatchDetails.join('\\n');
                        warningIcon = `<i class="fas fa-exclamation-triangle text-danger ms-2" title="${tooltipText}"></i>`;
                        tooltipAttr = `title="${tooltipText}"`;
                    }

                    html += `
                        <tr class="${rowClass}" onclick="showOrders('${stat.id}', '${stat.name.replace(/'/g, "\\'")}')" ${tooltipAttr}>
                            <td style="text-align: center;">${stt++}</td>
                            <td style="font-weight: 500;">
                                ${stat.name} ${warningIcon}
                            </td>
                            <td style="text-align: center; color: #059669; font-weight: 500;">${orderCount}</td>
                            <td style="text-align: center;">${stat.totalQty.toLocaleString('vi-VN')}</td>
                            <td style="text-align: right; font-weight: 600;">${stat.totalAmount.toLocaleString('vi-VN')}đ</td>
                        </tr>
                    `;
                    grandTotalQty += stat.totalQty;
                    grandTotalAmount += stat.totalAmount;
                    grandTotalOrders += orderCount;
                });

                tbody.innerHTML = html;

                // Update footer
                document.getElementById('grandTotalOrders').textContent = grandTotalOrders.toLocaleString('vi-VN');
                document.getElementById('grandTotalQty').textContent = grandTotalQty.toLocaleString('vi-VN');
                document.getElementById('grandTotalAmount').textContent = grandTotalAmount.toLocaleString('vi-VN') + 'đ';
                tfoot.style.display = 'table-footer-group';

            } catch (error) {
                console.error('Error loading stats:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle mb-2"></i><br>Lỗi tải dữ liệu: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Level 1: Show list of orders for a user
        async function showOrders(userId, userName) {
            document.getElementById('modalUserName').textContent = userName;
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-spinner fa-spin mb-2"></i><br>Đang tải danh sách đơn...
                    </td>
                </tr>
            `;

            // Show modal first
            const modal = new bootstrap.Modal(document.getElementById('ordersModal'));
            modal.show();

            try {
                // Fetch order snapshots for this user
                const snapshotsRef = firebase.database().ref('order_snapshots');
                const snapshot = await snapshotsRef.once('value');
                const allSnapshots = snapshot.val();

                if (!allSnapshots) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-box-open mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>Chưa có đơn hàng
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Filter orders for this user
                const userOrders = [];
                Object.values(allSnapshots).forEach(order => {
                    if (order.userId === userId) {
                        userOrders.push(order);
                    }
                });

                if (userOrders.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-box-open mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>Chưa có đơn hàng
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Sort by timestamp desc
                userOrders.sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));

                // Store for later use
                allOrderSnapshots = allSnapshots;

                // Render orders table
                let html = '';
                let index = 1;

                userOrders.forEach(order => {
                    const date = new Date(order.lastUpdated);
                    const timeStr = date.toLocaleString('vi-VN');
                    const productCount = order.products ? order.products.length : 0;

                    html += `
                        <tr class="clickable-row" onclick="showOrderDetails('${order.orderId}', '${order.orderSTT}')">
                            <td>${index++}</td>
                            <td style="font-weight: 500;">${order.orderSTT || 'N/A'}</td>
                            <td style="text-align: center;">${productCount}</td>
                            <td style="font-size: 13px;">${timeStr}</td>
                            <td style="text-align: center;">
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); showOrderDetails('${order.orderId}', '${order.orderSTT}')">
                                    <i class="fas fa-eye"></i> Xem
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;

            } catch (error) {
                console.error('Error loading orders:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle mb-2"></i><br>Lỗi tải danh sách đơn: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Level 2: Show product list and invoice for an order
        async function showOrderDetails(orderId, orderSTT) {
            document.getElementById('orderDetailsTitle').textContent = orderSTT || orderId;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();

            // Load products from snapshot
            const order = allOrderSnapshots[orderId];
            if (!order) {
                console.error('Order not found in snapshots:', orderId);
                return;
            }

            // Fetch KPI stats for this order from held_product_stats
            let kpiProductsMap = new Map(); // productId -> kpi data

            try {
                const statsRef = firebase.database().ref('held_product_stats');
                const statsSnapshot = await statsRef.once('value');
                const allStats = statsSnapshot.val();

                if (allStats) {
                    // Search through all users' stats for this orderId
                    Object.values(allStats).forEach(userStats => {
                        Object.values(userStats).forEach(statRecord => {
                            if (statRecord.orderId === orderId && statRecord.products) {
                                // Found stats for this order
                                statRecord.products.forEach(p => {
                                    // Use product name as key since we might not have productId
                                    const key = p.name || 'Unknown';
                                    kpiProductsMap.set(key, p);
                                });
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading KPI stats:', error);
            }

            // Render ALL products table
            const allProductsBody = document.getElementById('allProductsTableBody');
            let allHtml = '';
            let allIndex = 1;

            if (order.products && order.products.length > 0) {
                order.products.forEach(p => {
                    allHtml += `
                        <tr>
                            <td>${allIndex++}</td>
                            <td>${p.name || 'Unknown Product'}</td>
                            <td style="text-align: center;">${p.quantity || 0}</td>
                            <td style="text-align: right;">${(p.price || 0).toLocaleString('vi-VN')}đ</td>
                        </tr>
                    `;
                });
            } else {
                allHtml = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-box-open mb-2"></i><br>Không có sản phẩm
                        </td>
                    </tr>
                `;
            }
            allProductsBody.innerHTML = allHtml;

            // Render KPI products table
            const kpiProductsBody = document.getElementById('kpiProductsTableBody');
            let kpiHtml = '';
            let kpiIndex = 1;
            let hasKpiProducts = false;

            if (order.products && order.products.length > 0) {
                order.products.forEach(p => {
                    const kpiData = kpiProductsMap.get(p.name);
                    if (kpiData && kpiData.isCounted && kpiData.incrementalQty > 0) {
                        hasKpiProducts = true;
                        const kpiValue = kpiData.incrementalQty * 5000;
                        kpiHtml += `
                            <tr>
                                <td>${kpiIndex++}</td>
                                <td>${p.name || 'Unknown Product'}</td>
                                <td style="text-align: center;">${kpiData.newQuantityInOrder || 0}</td>
                                <td style="text-align: center; color: #059669; font-weight: 600;">${kpiData.incrementalQty}</td>
                                <td style="text-align: right; color: #059669; font-weight: 600;">${kpiValue.toLocaleString('vi-VN')}đ</td>
                            </tr>
                        `;
                    }
                });
            }

            if (!hasKpiProducts) {
                kpiHtml = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-info-circle mb-2"></i><br>Không có sản phẩm được tính KPI
                        </td>
                    </tr>
                `;
            }
            kpiProductsBody.innerHTML = kpiHtml;

            // Render NON-KPI products table
            const nonKpiProductsBody = document.getElementById('nonKpiProductsTableBody');
            let nonKpiHtml = '';
            let nonKpiIndex = 1;
            let hasNonKpiProducts = false;

            if (order.products && order.products.length > 0) {
                order.products.forEach(p => {
                    const kpiData = kpiProductsMap.get(p.name);
                    let reason = '';
                    let isNonKpi = false;

                    if (!kpiData) {
                        // No KPI data found - likely wasn't in held products
                        isNonKpi = true;
                        reason = 'Sản phẩm không qua "Sản phẩm đang giữ"';
                    } else if (!kpiData.isCounted || kpiData.incrementalQty === 0) {
                        // Has KPI data but not counted
                        isNonKpi = true;
                        if (kpiData.newQuantityInOrder <= kpiData.historicalMaxQty) {
                            reason = `Đã từng có ${kpiData.historicalMaxQty} trong đơn, hiện tại ${kpiData.newQuantityInOrder}`;
                        } else {
                            reason = 'Không đủ điều kiện tính KPI';
                        }
                    }

                    if (isNonKpi) {
                        hasNonKpiProducts = true;
                        nonKpiHtml += `
                            <tr>
                                <td>${nonKpiIndex++}</td>
                                <td>${p.name || 'Unknown Product'}</td>
                                <td style="text-align: center;">${p.quantity || 0}</td>
                                <td><span class="badge bg-secondary">${reason}</span></td>
                            </tr>
                        `;
                    }
                });
            }

            if (!hasNonKpiProducts) {
                nonKpiHtml = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-info-circle mb-2"></i><br>Tất cả sản phẩm đều được tính KPI
                        </td>
                    </tr>
                `;
            }
            nonKpiProductsBody.innerHTML = nonKpiHtml;

            // Load invoice when invoice tab is clicked
            document.getElementById('invoice-tab').addEventListener('click', async function () {
                await loadInvoice(orderId, order.invoiceId, order.invoiceProducts);
            }, { once: true }); // Use once: true to prevent multiple listeners
        }

        // Fetch and display invoice (now supports cached invoice products)
        async function loadInvoice(orderId, invoiceId, invoiceProducts) {
            const invoiceContent = document.getElementById('invoiceContent');

            invoiceContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #94a3b8;">
                    <i class="fas fa-spinner fa-spin mb-2"></i><br>Đang tải hóa đơn...
                </div>
            `;

            try {
                // Check if we have cached invoice products
                if (invoiceProducts && invoiceProducts.length > 0) {
                    console.log('[INVOICE] Using cached invoice products:', invoiceProducts.length);

                    // Render invoice details from cached data
                    let html = `
                        <div style="padding: 20px;">
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-file-invoice"></i> Thông tin hóa đơn #${invoiceId || 'N/A'} <span class="badge bg-light text-success" style="font-size: 10px;">Từ Cache</span></h6>
                                </div>
                                <div class="card-body">
                                    <p class="mb-0"><i class="fas fa-info-circle"></i> Đang hiển thị dữ liệu sản phẩm từ snapshot (không cần fetch API)</p>
                                </div>
                            </div>
                    `;

                    // Render products from cached invoiceProducts
                    html += `
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-box"></i> Danh sách sản phẩm (${invoiceProducts.length})</h6>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 50px;">#</th>
                                            <th style="width: 80px;">Hình</th>
                                            <th>Tên sản phẩm</th>
                                            <th style="text-align: center; width: 100px;">Số lượng</th>
                                            <th style="text-align: right; width: 120px;">Đơn giá</th>
                                            <th style="text-align: right; width: 120px;">Thành tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    invoiceProducts.forEach((product, index) => {
                        const imageHtml = product.imageUrl
                            ? `<img src="${product.imageUrl}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">`
                            : '<div style="width: 50px; height: 50px; background: #e5e7eb; border-radius: 4px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-box" style="color: #9ca3af;"></i></div>';

                        const noteHtml = product.note ? `<div style="font-size: 11px; color: #6b7280; margin-top: 2px;">Ghi chú: ${product.note}</div>` : '';

                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${imageHtml}</td>
                                <td>
                                    <div style="font-weight: 500;">${product.name || 'Unknown Product'}</div>
                                    ${product.barcode ? `<div style="font-size: 11px; color: #6b7280;">Mã: ${product.barcode}</div>` : ''}
                                    ${noteHtml}
                                </td>
                                <td style="text-align: center; font-weight: 600;">${product.quantity || 0}</td>
                                <td style="text-align: right;">${(product.price || 0).toLocaleString('vi-VN')}đ</td>
                                <td style="text-align: right; font-weight: 600; color: #059669;">${(product.total || 0).toLocaleString('vi-VN')}đ</td>
                            </tr>
                        `;
                    });

                    html += `
                                    </tbody>
                                    <tfoot style="background: #f9fafb;">
                                        <tr>
                                            <td colspan="5" style="text-align: right; font-weight: 600; padding: 12px;">Tổng cộng:</td>
                                            <td style="text-align: right; font-weight: 700; color: #059669; font-size: 16px; padding: 12px;">
                                                ${invoiceProducts.reduce((sum, p) => sum + (p.total || 0), 0).toLocaleString('vi-VN')}đ
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    `;

                    html += `</div>`;
                    invoiceContent.innerHTML = html;
                    return;
                }

                // Fallback: No cached products, try to fetch from API
                console.log('[INVOICE] No cached products, fetching from API...');

                // If no invoice ID, show message
                if (!invoiceId) {
                    invoiceContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-file-invoice mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>
                            Đơn hàng chưa có hóa đơn
                        </div>
                    `;
                    return;
                }

                // Fetch invoice data from API
                const headers = await window.tokenManager.getAuthHeader();
                const apiUrl = `https://chatomni-proxy.nhijudyshop.workers.dev/api/odata/FastSaleOrder(${invoiceId})?$expand=OrderLines`;

                const response = await fetch(apiUrl, {
                    headers: {
                        ...headers,
                        "Content-Type": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const invoice = await response.json();

                // Render invoice details
                let html = `
                    <div style="padding: 20px;">
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-file-invoice"></i> Thông tin hóa đơn #${invoiceId} <span class="badge bg-light text-primary" style="font-size: 10px;">Từ API</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Ngày tạo:</strong> ${invoice.Created ? new Date(invoice.Created).toLocaleString('vi-VN') : 'N/A'}</p>
                                        <p><strong>Trạng thái:</strong> ${invoice.Status || 'N/A'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Tổng tiền:</strong> ${(invoice.TotalAmount || 0).toLocaleString('vi-VN')}đ</p>
                                        <p><strong>Đã thanh toán:</strong> ${(invoice.PaidAmount || 0).toLocaleString('vi-VN')}đ</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;

                // Render products from OrderLines
                if (invoice.OrderLines && invoice.OrderLines.length > 0) {
                    html += `
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-box"></i> Danh sách sản phẩm (${invoice.OrderLines.length})</h6>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 50px;">#</th>
                                            <th>Tên sản phẩm</th>
                                            <th style="text-align: center; width: 100px;">Số lượng</th>
                                            <th style="text-align: right; width: 150px;">Đơn giá</th>
                                            <th style="text-align: right; width: 150px;">Thành tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    invoice.OrderLines.forEach((line, index) => {
                        const subtotal = (line.Quantity || 0) * (line.Price || 0);
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${line.ProductName || 'Unknown Product'}</td>
                                <td style="text-align: center;">${line.Quantity || 0}</td>
                                <td style="text-align: right;">${(line.Price || 0).toLocaleString('vi-VN')}đ</td>
                                <td style="text-align: right; font-weight: 500;">${subtotal.toLocaleString('vi-VN')}đ</td>
                            </tr>
                        `;
                    });

                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle"></i> Hóa đơn không có sản phẩm
                        </div>
                    `;
                }

                html += `</div>`;
                invoiceContent.innerHTML = html;

            } catch (error) {
                console.error('Error loading invoice:', error);
                invoiceContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle mb-2"></i><br>Lỗi tải hóa đơn: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>

</html>