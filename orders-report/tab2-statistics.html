<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống kê KPI - Watermark Method</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="tab1-orders.css">
    <link rel="stylesheet" href="report-modern.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f8fafc;
            padding: 20px;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .stats-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-refresh {
            background: #3b82f6;
            color: white;
        }

        .btn-refresh:hover {
            background: #2563eb;
        }

        .btn-export {
            background: #10b981;
            color: white;
        }

        .btn-export:hover {
            background: #059669;
        }

        .btn-timeline {
            background: #8b5cf6;
            color: white;
        }

        .btn-timeline:hover {
            background: #7c3aed;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .table th {
            background: #f1f5f9;
            font-weight: 600;
            color: #475569;
            font-size: 13px;
            padding: 12px 16px;
            white-space: nowrap;
        }

        .table td {
            padding: 12px 16px;
            vertical-align: middle;
            color: #334155;
            font-size: 14px;
        }

        .total-row {
            background: #f8fafc;
            font-weight: 600;
        }

        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clickable-row:hover {
            background-color: #f1f5f9;
        }

        .badge-fraud {
            background: #fef2f2;
            color: #dc2626;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-warning {
            background: #fef3c7;
            color: #d97706;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #059669;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-base {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Fullscreen modal */
        .modal.fade .modal-dialog.modal-fullscreen {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
        }

        .modal-dialog.modal-fullscreen {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .modal-dialog.modal-fullscreen .modal-content,
        .modal .modal-dialog.modal-fullscreen .modal-content {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            border: none !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
        }

        .modal-dialog.modal-fullscreen .modal-body {
            flex: 1 !important;
            overflow-y: auto !important;
        }

        /* Summary cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
        }

        .summary-card-title {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .summary-card-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .summary-card-subtitle {
            font-size: 12px;
            color: #9ca3af;
        }

        .summary-card-blue {
            border-left-color: #3b82f6;
        }

        .summary-card-blue .summary-card-value {
            color: #3b82f6;
        }

        .summary-card-green {
            border-left-color: #10b981;
        }

        .summary-card-green .summary-card-value {
            color: #10b981;
        }

        .summary-card-purple {
            border-left-color: #8b5cf6;
        }

        .summary-card-purple .summary-card-value {
            color: #8b5cf6;
        }

        .summary-card-red {
            border-left-color: #ef4444;
        }

        .summary-card-red .summary-card-value {
            color: #ef4444;
        }
    </style>
</head>

<body>
    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card summary-card-blue">
            <div class="summary-card-title"><i class="fas fa-users"></i> Tổng người dùng</div>
            <div class="summary-card-value" id="totalUsers">0</div>
            <div class="summary-card-subtitle">Có đơn hàng KPI</div>
        </div>
        <div class="summary-card summary-card-green">
            <div class="summary-card-title"><i class="fas fa-shopping-cart"></i> Tổng đơn hàng</div>
            <div class="summary-card-value" id="totalOrders">0</div>
            <div class="summary-card-subtitle">Có sản phẩm KPI</div>
        </div>
        <div class="summary-card summary-card-purple">
            <div class="summary-card-title"><i class="fas fa-box"></i> Tổng sản phẩm</div>
            <div class="summary-card-value" id="totalProducts">0</div>
            <div class="summary-card-subtitle">Tính KPI</div>
        </div>
        <div class="summary-card summary-card-red">
            <div class="summary-card-title"><i class="fas fa-coins"></i> Tổng KPI</div>
            <div class="summary-card-value" id="totalKPI">0đ</div>
            <div class="summary-card-subtitle">Giá trị thanh toán</div>
        </div>
    </div>

    <!-- Main Stats Card -->
    <div class="stats-card">
        <div class="stats-header">
            <div class="stats-title">
                <i class="fas fa-chart-bar" style="color: #3b82f6;"></i>
                Thống kê KPI - Watermark Method
            </div>
            <div class="stats-actions">
                <!-- Campaign Filter -->
                <select id="campaignFilter" class="form-select" style="width: 250px; font-size: 13px;">
                    <option value="">-- Chọn bảng/chiến dịch --</option>
                </select>
                <button class="btn-action btn-timeline" onclick="showTimeline()">
                    <i class="fas fa-chart-line"></i> Timeline
                </button>
                <button class="btn-action btn-export" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
                <button class="btn-action btn-refresh" onclick="refreshStats()">
                    <i class="fas fa-sync-alt"></i> Làm mới
                </button>
            </div>
        </div>

        <!-- Campaign Info Bar -->
        <div id="campaignInfoBar" style="display: none; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; padding: 12px 16px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <i class="fas fa-calendar-alt" style="color: #0284c7;"></i>
                    <strong id="selectedCampaignName" style="color: #0369a1;">Chưa chọn chiến dịch</strong>
                    <span id="campaignOrderCount" style="color: #64748b; margin-left: 12px;"></span>
                </div>
                <div id="kpiCalculationStatus" style="font-size: 12px; color: #64748b;">
                    <!-- Status will be shown here -->
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 60px; text-align: center;">STT</th>
                        <th>Tên người dùng</th>
                        <th style="text-align: center; width: 100px;">Số đơn</th>
                        <th style="text-align: center;">Tổng số lượng</th>
                        <th style="text-align: right;">Tổng KPI (5.000đ/sp)</th>
                        <th style="text-align: center; width: 120px;">Trạng thái</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-hand-point-up mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>
                            Vui lòng chọn một chiến dịch để xem thống kê KPI
                        </td>
                    </tr>
                </tbody>
                <tfoot id="statsTableFooter" style="display: none;">
                    <tr class="total-row">
                        <td colspan="2" style="text-align: right;">Tổng cộng:</td>
                        <td style="text-align: center;" id="grandTotalOrders">0</td>
                        <td style="text-align: center;" id="grandTotalQty">0</td>
                        <td style="text-align: right; color: #dc2626;" id="grandTotalAmount">0đ</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div class="modal fade" id="timelineModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-chart-line"></i> Timeline KPI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders List Modal (Level 1) -->
    <div class="modal fade" id="ordersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Danh sách đơn hàng - <span id="modalUserName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-striped mb-0">
                        <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>STT Đơn</th>
                                <th style="text-align: center;">Số lượng SP</th>
                                <th style="text-align: right;">KPI</th>
                                <th>Thời gian</th>
                                <th style="text-align: center;">Trạng thái</th>
                                <th style="text-align: center;">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal (Level 2) -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết đơn hàng - <span id="orderDetailsTitle"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" id="orderDetailsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="kpi-comparison-tab" data-bs-toggle="tab"
                                data-bs-target="#kpi-comparison" type="button" role="tab">
                                <i class="fas fa-exchange-alt text-primary"></i> So sánh KPI
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-products-tab" data-bs-toggle="tab"
                                data-bs-target="#all-products" type="button" role="tab">
                                <i class="fas fa-box"></i> Tất cả SP (Current)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="base-products-tab" data-bs-toggle="tab"
                                data-bs-target="#base-products" type="button" role="tab">
                                <i class="fas fa-lock text-warning"></i> BASE Products
                            </button>
                        </li>
                    </ul>

                    <!-- Tab content -->
                    <div class="tab-content pt-3" id="orderDetailsTabContent">
                        <!-- KPI Comparison Tab -->
                        <div class="tab-pane fade show active" id="kpi-comparison" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle"></i>
                                <strong>So sánh KPI:</strong> So sánh sản phẩm BASE (khi lưu lần đầu) với Current (hiện tại trong đơn).
                                KPI = Current - BASE (chỉ tính tăng)
                            </div>
                            <table class="table table-hover">
                                <thead class="table-primary">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Mã sản phẩm</th>
                                        <th style="text-align: center; width: 120px;">BASE Qty</th>
                                        <th style="text-align: center; width: 120px;">Current Qty</th>
                                        <th style="text-align: center; width: 120px;">KPI Qty</th>
                                        <th style="text-align: right; width: 150px;">Giá trị KPI</th>
                                    </tr>
                                </thead>
                                <tbody id="kpiComparisonTableBody">
                                    <!-- KPI comparison will be loaded here -->
                                </tbody>
                                <tfoot id="kpiComparisonFooter" style="background: #f0fdf4;">
                                    <tr>
                                        <td colspan="4" style="text-align: right; font-weight: 600;">Tổng KPI:</td>
                                        <td style="text-align: center; font-weight: 700; color: #059669;" id="totalKpiQty">0</td>
                                        <td style="text-align: right; font-weight: 700; color: #059669;" id="totalKpiValue">0đ</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- All Products Tab -->
                        <div class="tab-pane fade" id="all-products" role="tabpanel">
                            <div class="alert alert-secondary mb-3">
                                <i class="fas fa-info-circle"></i>
                                <strong>Current Products:</strong> Danh sách sản phẩm hiện tại trong đơn hàng (từ report_order_details)
                            </div>
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Mã sản phẩm</th>
                                        <th style="text-align: center; width: 100px;">Số lượng</th>
                                    </tr>
                                </thead>
                                <tbody id="allProductsTableBody">
                                    <!-- All products will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- BASE Products Tab -->
                        <div class="tab-pane fade" id="base-products" role="tabpanel">
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-lock"></i>
                                <strong>BASE Products:</strong> Snapshot sản phẩm khi lưu lần đầu. Không bao giờ thay đổi sau khi tạo.
                            </div>
                            <table class="table table-hover">
                                <thead class="table-warning">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Mã sản phẩm</th>
                                        <th style="text-align: center; width: 100px;">Số lượng</th>
                                    </tr>
                                </thead>
                                <tbody id="baseProductsTableBody">
                                    <!-- BASE products will be loaded here -->
                                </tbody>
                            </table>
                            <div id="baseEmpty" style="display: none; text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-lock-open fa-3x mb-3"></i>
                                <p>Chưa có BASE cho đơn hàng này</p>
                                <small>BASE sẽ được tạo khi lưu đơn hàng lần đầu</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Config & Auth -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="token-manager.js"></script>
    <script src="api-config.js"></script>
    <!-- KPI Manager -->
    <script src="kpi-manager.js"></script>

    <script>
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Global state
        let allStatsData = {};
        let timelineChart = null;
        let currentCampaignName = null;
        let campaignsList = [];

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function () {
            loadCampaigns();

            // Campaign filter change handler
            document.getElementById('campaignFilter').addEventListener('change', async function (e) {
                const selectedCampaign = e.target.value;
                if (selectedCampaign) {
                    await onCampaignSelected(selectedCampaign);
                } else {
                    currentCampaignName = null;
                    document.getElementById('campaignInfoBar').style.display = 'none';
                    clearStatsTable();
                }
            });
        });

        // ==================== CAMPAIGN LOADING ====================
        async function loadCampaigns() {
            const select = document.getElementById('campaignFilter');

            try {
                const snapshot = await firebase.database().ref('report_order_details').once('value');
                const data = snapshot.val() || {};

                campaignsList = [];

                for (const key in data) {
                    const campaignData = data[key];
                    if (campaignData && campaignData.tableName) {
                        campaignsList.push({
                            key: key,
                            name: campaignData.tableName,
                            orderCount: campaignData.orders?.length || 0,
                            fetchedAt: campaignData.fetchedAt
                        });
                    }
                }

                // Sort by fetchedAt (newest first)
                campaignsList.sort((a, b) => (b.fetchedAt || 0) - (a.fetchedAt || 0));

                // Populate dropdown
                select.innerHTML = '<option value="">-- Chọn bảng/chiến dịch --</option>';
                campaignsList.forEach(campaign => {
                    const option = document.createElement('option');
                    option.value = campaign.name;
                    option.textContent = `${campaign.name} (${campaign.orderCount} đơn)`;
                    select.appendChild(option);
                });

                console.log('[KPI-STATS] Loaded', campaignsList.length, 'campaigns');

            } catch (error) {
                console.error('[KPI-STATS] Error loading campaigns:', error);
            }
        }

        // ==================== CAMPAIGN SELECTION ====================
        async function onCampaignSelected(campaignName) {
            currentCampaignName = campaignName;

            const infoBar = document.getElementById('campaignInfoBar');
            const nameEl = document.getElementById('selectedCampaignName');
            const countEl = document.getElementById('campaignOrderCount');
            const statusEl = document.getElementById('kpiCalculationStatus');

            infoBar.style.display = 'block';
            nameEl.textContent = campaignName;

            const campaign = campaignsList.find(c => c.name === campaignName);
            countEl.textContent = campaign ? `(${campaign.orderCount} đơn hàng)` : '';

            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tính KPI...';

            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-calculator fa-spin mb-2" style="font-size: 24px;"></i><br>
                        Đang tính KPI cho chiến dịch "<strong>${campaignName}</strong>"...
                    </td>
                </tr>
            `;

            try {
                // Calculate KPI for all orders in this campaign
                const result = await window.kpiManager.calculateKPIForCampaign(campaignName);

                let statusText = `<i class="fas fa-check-circle" style="color: #10b981;"></i> Đã tính ${result.success} đơn`;
                if (result.failed > 0) statusText += `, ${result.failed} lỗi`;
                if (result.skippedNoBase > 0) statusText += ` <span class="badge-base">${result.skippedNoBase} đơn chưa có BASE</span>`;
                statusEl.innerHTML = statusText;

                // Load and display statistics
                await loadStatsForCampaign(campaignName);

            } catch (error) {
                console.error('[KPI-STATS] Error calculating KPI:', error);
                statusEl.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Lỗi: ${error.message}`;
            }
        }

        // ==================== LOAD STATISTICS ====================
        async function loadStatsForCampaign(campaignName) {
            const tbody = document.getElementById('statsTableBody');
            const tfoot = document.getElementById('statsTableFooter');

            try {
                const stats = await window.kpiManager.getKPIStatisticsByCampaign(campaignName);

                if (!stats || Object.keys(stats).length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-box-open mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>
                                Chưa có dữ liệu KPI cho chiến dịch này
                                <br><small>Vui lòng đảm bảo đã lưu BASE và có order details trong Firebase</small>
                            </td>
                        </tr>
                    `;
                    tfoot.style.display = 'none';
                    updateSummaryCards(0, 0, 0, 0);
                    return;
                }

                // Aggregate by user
                const userStats = {};
                let totalUsers = 0;
                let totalOrders = 0;
                let totalDifferences = 0;
                let totalKPI = 0;

                for (const userId in stats) {
                    const userDates = stats[userId];
                    let userName = 'Unknown';
                    let userTotalDiff = 0;
                    let userTotalKPI = 0;
                    let userOrders = [];

                    for (const date in userDates) {
                        const dateStats = userDates[date];
                        userName = dateStats.orders?.[0]?.userName || userName;

                        (dateStats.orders || []).forEach(order => {
                            userTotalDiff += order.differences || 0;
                            userTotalKPI += order.kpi || 0;
                            userOrders.push(order);
                        });
                    }

                    if (userOrders.length > 0) {
                        userStats[userId] = {
                            id: userId,
                            name: userName,
                            totalDifferences: userTotalDiff,
                            totalKPI: userTotalKPI,
                            orders: userOrders
                        };

                        totalUsers++;
                        totalOrders += userOrders.length;
                        totalDifferences += userTotalDiff;
                        totalKPI += userTotalKPI;
                    }
                }

                // Render table
                let html = '';
                let index = 1;

                // Sort by KPI descending
                const sortedUsers = Object.values(userStats).sort((a, b) => b.totalKPI - a.totalKPI);

                for (const user of sortedUsers) {
                    const hasHighKPI = user.totalKPI > 100000;

                    html += `
                        <tr class="clickable-row ${hasHighKPI ? 'table-warning' : ''}"
                            onclick="showUserOrders('${user.id}', '${user.name.replace(/'/g, "\\'")}')">
                            <td style="text-align: center;">${index++}</td>
                            <td>
                                <strong>${user.name}</strong>
                                ${hasHighKPI ? '<span class="badge-warning" style="margin-left: 8px;"><i class="fas fa-star"></i> Top KPI</span>' : ''}
                            </td>
                            <td style="text-align: center;">${user.orders.length}</td>
                            <td style="text-align: center;">${user.totalDifferences}</td>
                            <td style="text-align: right; color: #dc2626; font-weight: 600;">
                                ${user.totalKPI.toLocaleString('vi-VN')}đ
                            </td>
                            <td style="text-align: center;">
                                <span class="badge ${user.totalDifferences > 0 ? 'badge-success' : 'badge-warning'}">
                                    ${user.totalDifferences > 0 ? 'Có KPI' : 'Chưa có KPI'}
                                </span>
                            </td>
                        </tr>
                    `;
                }

                tbody.innerHTML = html;

                // Update footer
                tfoot.style.display = 'table-footer-group';
                document.getElementById('grandTotalOrders').textContent = totalOrders;
                document.getElementById('grandTotalQty').textContent = totalDifferences;
                document.getElementById('grandTotalAmount').textContent = totalKPI.toLocaleString('vi-VN') + 'đ';

                // Update summary cards
                updateSummaryCards(totalUsers, totalOrders, totalDifferences, totalKPI);

                // Store for later use
                allStatsData = userStats;

            } catch (error) {
                console.error('[KPI-STATS] Error loading stats:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle mb-2" style="font-size: 24px;"></i><br>
                            Lỗi: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // ==================== SHOW USER ORDERS ====================
        function showUserOrders(userId, userName) {
            const user = allStatsData[userId];
            if (!user) return;

            document.getElementById('modalUserName').textContent = userName;

            const tbody = document.getElementById('ordersTableBody');
            let html = '';

            // Sort orders by stt
            const sortedOrders = [...user.orders].sort((a, b) => (a.stt || 0) - (b.stt || 0));

            sortedOrders.forEach((order, index) => {
                const hasKPI = order.differences > 0;
                const hasBase = order.hasBase !== false;

                html += `
                    <tr class="clickable-row ${!hasBase ? 'table-secondary' : ''}" onclick="showOrderKPIDetails('${order.orderId}', ${order.stt})">
                        <td>${index + 1}</td>
                        <td>
                            <strong>STT ${order.stt}</strong>
                            ${!hasBase ? '<span class="badge-base">Chưa có BASE</span>' : ''}
                        </td>
                        <td style="text-align: center;">${order.differences} SP</td>
                        <td style="text-align: right; color: #dc2626; font-weight: 600;">${(order.kpi || 0).toLocaleString('vi-VN')}đ</td>
                        <td>${order.timestamp ? new Date(order.timestamp).toLocaleString('vi-VN') : '-'}</td>
                        <td style="text-align: center;">
                            <span class="badge ${hasKPI ? 'badge-success' : 'badge-warning'}">
                                ${hasKPI ? 'Có KPI' : 'Không KPI'}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showOrderKPIDetails('${order.orderId}', ${order.stt})">
                                <i class="fas fa-eye"></i> Chi tiết
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html || `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-box-open mb-2"></i><br>Không có đơn hàng
                    </td>
                </tr>
            `;

            const modal = new bootstrap.Modal(document.getElementById('ordersModal'));
            modal.show();
        }

        // ==================== SHOW ORDER KPI DETAILS ====================
        async function showOrderKPIDetails(orderId, stt) {
            document.getElementById('orderDetailsTitle').textContent = `STT ${stt}`;

            // Show loading
            const comparisonBody = document.getElementById('kpiComparisonTableBody');
            const allBody = document.getElementById('allProductsTableBody');
            const baseBody = document.getElementById('baseProductsTableBody');

            comparisonBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>`;
            allBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>`;
            baseBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>`;

            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();

            try {
                // Load BASE and current products
                const base = await window.kpiManager.getKPIBase(orderId);
                const currentProducts = currentCampaignName
                    ? await window.kpiManager.getOrderDetailsFromFirebase(orderId, currentCampaignName)
                    : null;

                // Render KPI Comparison Tab
                renderKPIComparisonTab(base, currentProducts);

                // Render All Products Tab (Current)
                renderAllProductsTab(currentProducts);

                // Render BASE Products Tab
                renderBaseProductsTab(base);

            } catch (error) {
                console.error('[KPI-DETAILS] Error loading order details:', error);
                comparisonBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Lỗi: ${error.message}</td></tr>`;
            }
        }

        // ==================== RENDER TABS ====================
        function renderKPIComparisonTab(base, currentProducts) {
            const tbody = document.getElementById('kpiComparisonTableBody');
            const baseEmpty = document.getElementById('baseEmpty');

            if (!base || !base.products || base.products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-lock-open fa-2x mb-3" style="opacity: 0.5;"></i><br>
                            Chưa có BASE cho đơn hàng này<br>
                            <small>BASE sẽ được tạo khi lưu đơn hàng lần đầu</small>
                        </td>
                    </tr>
                `;
                document.getElementById('totalKpiQty').textContent = '0';
                document.getElementById('totalKpiValue').textContent = '0đ';
                return;
            }

            // Create maps for comparison
            const baseMap = new Map();
            base.products.forEach(p => {
                baseMap.set(p.code.toUpperCase(), p.quantity);
            });

            const currentMap = new Map();
            if (currentProducts) {
                currentProducts.forEach(p => {
                    currentMap.set(p.code.toUpperCase(), p.quantity);
                });
            }

            let html = '';
            let index = 1;
            let totalKpiQty = 0;
            let totalKpiValue = 0;

            // Process all unique product codes
            const allCodes = new Set([...baseMap.keys(), ...currentMap.keys()]);
            const sortedCodes = Array.from(allCodes).sort();

            for (const code of sortedCodes) {
                const baseQty = baseMap.get(code) || 0;
                const currentQty = currentMap.get(code) || 0;
                const kpiQty = Math.max(0, currentQty - baseQty);
                const kpiValue = kpiQty * 5000;

                totalKpiQty += kpiQty;
                totalKpiValue += kpiValue;

                const rowClass = kpiQty > 0 ? 'table-success' : (baseQty > 0 && currentQty === 0 ? 'table-danger' : '');
                const isNew = baseQty === 0 && currentQty > 0;

                html += `
                    <tr class="${rowClass}">
                        <td>${index++}</td>
                        <td>
                            <code>${code}</code>
                            ${isNew ? '<span class="badge bg-info ms-2">Mới</span>' : ''}
                        </td>
                        <td style="text-align: center;">${baseQty}</td>
                        <td style="text-align: center; font-weight: 600;">${currentQty}</td>
                        <td style="text-align: center; font-weight: 700; color: ${kpiQty > 0 ? '#059669' : '#6b7280'};">
                            ${kpiQty > 0 ? '+' : ''}${kpiQty}
                        </td>
                        <td style="text-align: right; font-weight: 600; color: ${kpiValue > 0 ? '#059669' : '#6b7280'};">
                            ${kpiValue.toLocaleString('vi-VN')}đ
                        </td>
                    </tr>
                `;
            }

            tbody.innerHTML = html || `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                        Không có sản phẩm để so sánh
                    </td>
                </tr>
            `;

            document.getElementById('totalKpiQty').textContent = totalKpiQty;
            document.getElementById('totalKpiValue').textContent = totalKpiValue.toLocaleString('vi-VN') + 'đ';
        }

        function renderAllProductsTab(currentProducts) {
            const tbody = document.getElementById('allProductsTableBody');

            if (!currentProducts || currentProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <i class="fas fa-box-open mb-2"></i><br>Không có sản phẩm
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            currentProducts.forEach((p, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><code>${p.code}</code></td>
                        <td style="text-align: center; font-weight: 600;">${p.quantity}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function renderBaseProductsTab(base) {
            const tbody = document.getElementById('baseProductsTableBody');
            const emptyEl = document.getElementById('baseEmpty');

            if (!base || !base.products || base.products.length === 0) {
                tbody.innerHTML = '';
                emptyEl.style.display = 'block';
                return;
            }

            emptyEl.style.display = 'none';

            let html = '';
            base.products.forEach((p, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><code>${p.code}</code></td>
                        <td style="text-align: center; font-weight: 600;">${p.quantity}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // ==================== UTILITY FUNCTIONS ====================
        function clearStatsTable() {
            const tbody = document.getElementById('statsTableBody');
            const tfoot = document.getElementById('statsTableFooter');

            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                        <i class="fas fa-hand-point-up mb-2" style="font-size: 24px; opacity: 0.5;"></i><br>
                        Vui lòng chọn một chiến dịch để xem thống kê KPI
                    </td>
                </tr>
            `;
            tfoot.style.display = 'none';
            updateSummaryCards(0, 0, 0, 0);
            allStatsData = {};
        }

        function updateSummaryCards(users, orders, products, kpi) {
            document.getElementById('totalUsers').textContent = users.toLocaleString('vi-VN');
            document.getElementById('totalOrders').textContent = orders.toLocaleString('vi-VN');
            document.getElementById('totalProducts').textContent = products.toLocaleString('vi-VN');
            document.getElementById('totalKPI').textContent = (typeof kpi === 'number' ? kpi : 0).toLocaleString('vi-VN') + 'đ';
        }

        function refreshStats() {
            if (currentCampaignName) {
                onCampaignSelected(currentCampaignName);
            } else {
                loadCampaigns();
            }
        }

        // ==================== TIMELINE CHART ====================
        function showTimeline() {
            const modal = new bootstrap.Modal(document.getElementById('timelineModal'));
            modal.show();

            if (Object.keys(allStatsData).length === 0) {
                document.getElementById('timelineChart').parentElement.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #94a3b8;">
                        <i class="fas fa-chart-line fa-3x mb-3" style="opacity: 0.5;"></i>
                        <p>Chọn chiến dịch để xem timeline KPI</p>
                    </div>
                `;
                return;
            }

            // Aggregate data by date
            const dateMap = new Map();

            Object.values(allStatsData).forEach(userStat => {
                userStat.orders.forEach(order => {
                    const timestamp = order.timestamp || Date.now();
                    const date = new Date(timestamp).toLocaleDateString('vi-VN');
                    const kpi = order.kpi || 0;
                    const diff = order.differences || 0;

                    if (!dateMap.has(date)) {
                        dateMap.set(date, { kpi: 0, qty: 0, count: 0 });
                    }

                    dateMap.get(date).kpi += kpi;
                    dateMap.get(date).qty += diff;
                    dateMap.get(date).count += 1;
                });
            });

            // Sort by date
            const sortedDates = Array.from(dateMap.keys()).sort((a, b) => {
                const [da, ma, ya] = a.split('/').map(Number);
                const [db, mb, yb] = b.split('/').map(Number);
                return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
            });

            const labels = sortedDates;
            const dataKPI = sortedDates.map(date => dateMap.get(date).kpi / 1000); // Convert to thousands
            const dataQty = sortedDates.map(date => dateMap.get(date).qty);

            // Destroy old chart
            if (timelineChart) {
                timelineChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'KPI (nghìn đồng)',
                            data: dataKPI,
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Số lượng SP',
                            data: dataQty,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Timeline KPI - ${currentCampaignName || 'Tất cả'}`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'KPI (nghìn đồng)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Số lượng SP'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // ==================== EXPORT TO EXCEL ====================
        function exportToExcel() {
            if (Object.keys(allStatsData).length === 0) {
                alert('Vui lòng chọn chiến dịch trước khi export');
                return;
            }

            try {
                const data = [];

                // Add header
                data.push(['THỐNG KÊ KPI - WATERMARK METHOD']);
                data.push(['Chiến dịch:', currentCampaignName || 'N/A']);
                data.push(['Xuất ngày:', new Date().toLocaleString('vi-VN')]);
                data.push([]);

                // Add user summary
                data.push(['STT', 'Tên người dùng', 'Số đơn', 'Tổng SL', 'Tổng KPI (đ)']);

                const sortedUsers = Object.values(allStatsData).sort((a, b) => b.totalKPI - a.totalKPI);
                sortedUsers.forEach((user, index) => {
                    data.push([
                        index + 1,
                        user.name,
                        user.orders.length,
                        user.totalDifferences,
                        user.totalKPI
                    ]);
                });

                // Add totals
                data.push([]);
                data.push([
                    '',
                    'TỔNG CỘNG',
                    sortedUsers.reduce((sum, u) => sum + u.orders.length, 0),
                    sortedUsers.reduce((sum, u) => sum + u.totalDifferences, 0),
                    sortedUsers.reduce((sum, u) => sum + u.totalKPI, 0)
                ]);

                // Add order details
                data.push([]);
                data.push(['CHI TIẾT ĐƠN HÀNG']);
                data.push(['Người dùng', 'STT Đơn', 'Order ID', 'SL SP', 'KPI (đ)', 'Thời gian']);

                sortedUsers.forEach(user => {
                    user.orders.forEach(order => {
                        data.push([
                            user.name,
                            order.stt,
                            order.orderId,
                            order.differences,
                            order.kpi,
                            order.timestamp ? new Date(order.timestamp).toLocaleString('vi-VN') : ''
                        ]);
                    });
                });

                // Create workbook
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Thống kê KPI');

                // Save file
                const safeName = (currentCampaignName || 'all').replace(/[^a-zA-Z0-9]/g, '_');
                const fileName = `KPI_${safeName}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert('Đã export thành công!');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Lỗi export: ' + error.message);
            }
        }
    </script>
</body>

</html>
