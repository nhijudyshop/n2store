CUSTOMER 360Â° - UNIFIED CUSTOMER HUB
Tá»”NG QUAN GIáº¢I PHÃP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                         â”‚
â”‚                         CUSTOMER 360Â° - UNIFIED CUSTOMER HUB                            â”‚
â”‚                                                                                         â”‚
â”‚   "Má»™t nÆ¡i duy nháº¥t Ä‘á»ƒ xem Táº¤T Cáº¢ thÃ´ng tin vá» má»™t khÃ¡ch hÃ ng"                         â”‚
â”‚                                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                           ğŸ‘¤ KHÃCH HÃ€NG: 0901234567                             â”‚   â”‚
â”‚   â”‚                              Nguyá»…n VÄƒn A - VIP                                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚   ğŸ’° VÃ      â”‚  â”‚  ğŸ“‹ Sá»° Vá»¤   â”‚  â”‚  ğŸ›’ ÄÆ N     â”‚  â”‚  ğŸ’¬ TÆ¯Æ NG   â”‚              â”‚
â”‚   â”‚   TIá»€N      â”‚  â”‚              â”‚  â”‚   HÃ€NG      â”‚  â”‚   TÃC       â”‚              â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚   â”‚ Sá»‘ dÆ°: 500k â”‚  â”‚ 3 sá»± vá»¥     â”‚  â”‚ 15 Ä‘Æ¡n      â”‚  â”‚ 8 tin nháº¯n  â”‚              â”‚
â”‚   â”‚ áº¢o: 200k    â”‚  â”‚ 1 Ä‘ang xá»­ lÃ½â”‚  â”‚ Tá»•ng: 5tr   â”‚  â”‚ 2 comment   â”‚              â”‚
â”‚   â”‚ Tá»•ng: 700k  â”‚  â”‚ 2 hoÃ n táº¥t  â”‚  â”‚ Last: 3 ngÃ yâ”‚  â”‚ Last: hÃ´m quaâ”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                          ğŸ“Š TIMELINE HOáº T Äá»˜NG                                  â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚   â”‚  05/01 ğŸ’° Chuyá»ƒn khoáº£n 500,000Ä‘                                                â”‚   â”‚
â”‚   â”‚  04/01 ğŸ“‹ Sá»± vá»¥ #123 - BOOM - ÄÃ£ hoÃ n táº¥t                                      â”‚   â”‚
â”‚   â”‚  03/01 ğŸ›’ ÄÆ¡n NJD/2026/45678 - Giao thÃ nh cÃ´ng                                 â”‚   â”‚
â”‚   â”‚  02/01 ğŸ’¬ Inbox há»i vá» size Ã¡o                                                  â”‚   â”‚
â”‚   â”‚  01/01 ğŸ“‹ Sá»± vá»¥ #122 - Äá»•i size - Cáº¥p cÃ´ng ná»£ áº£o 200k                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  ğŸ·ï¸ TAGS & PHÃ‚N LOáº I            â”‚  â”‚  ğŸ“ˆ THá»NG KÃŠ                           â”‚     â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â€¢ Tá»•ng chi tiÃªu: 5,200,000Ä‘           â”‚     â”‚
â”‚   â”‚  â”‚ VIP â”‚ â”‚Loyalâ”‚ â”‚Hay Ä‘á»•i sizeâ”‚ â”‚  â”‚  â€¢ Sá»‘ Ä‘Æ¡n: 15 (12 thÃ nh cÃ´ng)          â”‚     â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â€¢ Tá»· lá»‡ hoÃ n: 20%                     â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â€¢ Äiá»ƒm tÃ­ch lÅ©y: 5,200               â”‚     â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ğŸ”® Má» Rá»˜NG TÆ¯Æ NG LAI                                                           â”‚   â”‚
â”‚   â”‚  â€¢ Loyalty Points â€¢ Upsell Suggestions â€¢ Behavior Analytics â€¢ RFM Scoring      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



1. KIáº¾N TRÃšC Tá»”NG THá»‚
1.1 High-Level Architecture
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CUSTOMER 360Â° ARCHITECTURE                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                              â”‚   CLOUDFLARE        â”‚                                    â”‚
â”‚                              â”‚   WORKER            â”‚                                    â”‚
â”‚                              â”‚   (API Gateway)     â”‚                                    â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                         â”‚                                               â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚                    â”‚                    â”‚                          â”‚
â”‚                    â–¼                    â–¼                    â–¼                          â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚           â”‚   RENDER     â”‚    â”‚   FIREBASE   â”‚    â”‚   TPOS API   â”‚                     â”‚
â”‚           â”‚   (Main DB)  â”‚    â”‚   (Realtime) â”‚    â”‚   (External) â”‚                     â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                    â”‚                    â”‚                    â”‚                          â”‚
â”‚                    â”‚                    â”‚                    â”‚                          â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚           â”‚  CUSTOMER     â”‚    â”‚  REALTIME     â”‚    â”‚  ORDER        â”‚                  â”‚
â”‚           â”‚  DATA HUB     â”‚    â”‚  EVENTS       â”‚    â”‚  HISTORY      â”‚                  â”‚
â”‚           â”‚               â”‚    â”‚               â”‚    â”‚               â”‚                  â”‚
â”‚           â”‚ â€¢ customers   â”‚    â”‚ â€¢ tickets     â”‚    â”‚ â€¢ Orders      â”‚                  â”‚
â”‚           â”‚ â€¢ wallets     â”‚    â”‚   (sync)      â”‚    â”‚ â€¢ Invoices    â”‚                  â”‚
â”‚           â”‚ â€¢ transactionsâ”‚    â”‚ â€¢ activities  â”‚    â”‚ â€¢ Products    â”‚                  â”‚
â”‚           â”‚ â€¢ tickets     â”‚    â”‚ â€¢ presence    â”‚    â”‚               â”‚                  â”‚
â”‚           â”‚ â€¢ activities  â”‚    â”‚               â”‚    â”‚               â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                                         â”‚
â”‚           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                  â”‚
â”‚                                                                                         â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                              â”‚   FRONTEND APPS     â”‚                                    â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                        â”‚                                                â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚           â”‚                            â”‚                            â”‚                   â”‚
â”‚           â–¼                            â–¼                            â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚  customer-    â”‚          â”‚  orders-      â”‚          â”‚  balance-     â”‚              â”‚
â”‚   â”‚  hub/         â”‚          â”‚  report/      â”‚          â”‚  history/     â”‚              â”‚
â”‚   â”‚               â”‚          â”‚               â”‚          â”‚               â”‚              â”‚
â”‚   â”‚  Main Portal  â”‚          â”‚  PBH + Wallet â”‚          â”‚  Bank TXs     â”‚              â”‚
â”‚   â”‚  Customer 360 â”‚          â”‚  Integration  â”‚          â”‚  QR Codes     â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


1.2 Data Flow Architecture
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    DATA FLOW                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                        â”‚
â”‚  â”‚   SePay     â”‚â”€â”€â”€â”€ Webhook â”€â”€â”€â”€â”                                                      â”‚
â”‚  â”‚  (Bank TX)  â”‚                 â”‚                                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚                                                      â”‚
â”‚                                  â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   TPOS      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   PostgreSQL    â”‚               â”‚
â”‚  â”‚  (Orders)   â”‚         â”‚  RENDER.COM     â”‚         â”‚                 â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   Backend       â”‚         â”‚  â€¢ customers    â”‚               â”‚
â”‚                          â”‚                 â”‚         â”‚  â€¢ wallets      â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  API Routes:    â”‚         â”‚  â€¢ tickets      â”‚               â”‚
â”‚  â”‚  Firebase   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  /api/customer  â”‚         â”‚  â€¢ transactions â”‚               â”‚
â”‚  â”‚  (Events)   â”‚  sync   â”‚  /api/wallet    â”‚         â”‚  â€¢ activities   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  /api/ticket    â”‚         â”‚                 â”‚               â”‚
â”‚                          â”‚  /api/activity  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                 â”‚                                            â”‚
â”‚  â”‚  Frontend   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚                                            â”‚
â”‚  â”‚   Apps      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



2. DATABASE SCHEMA (PostgreSQL - Render.com)
2.1 Core Table: customers (Master Customer Data)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Báº¢NG CHÃNH: customers - Master Customer Record
-- KhÃ³a chÃ­nh: phone (SÄT chuáº©n hÃ³a)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE customers (
    id SERIAL PRIMARY KEY,
    
    -- â•â•â• IDENTITY â•â•â•
    phone VARCHAR(20) UNIQUE NOT NULL,           -- KhÃ³a chÃ­nh logic (VD: "0901234567")
    
    -- â•â•â• THÃ”NG TIN CÆ  Báº¢N â•â•â•
    name VARCHAR(255),                           -- TÃªn khÃ¡ch hÃ ng
    email VARCHAR(255),
    
    -- â•â•â• Äá»ŠA CHá»ˆ â•â•â•
    addresses JSONB DEFAULT '[]',                -- Array of addresses
    -- Format: [{"id": 1, "address": "123 ABC", "ward": "...", "district": "...", 
    --           "city": "...", "is_default": true, "label": "NhÃ "}]
    
    -- â•â•â• LIÃŠN Káº¾T EXTERNAL â•â•â•
    tpos_partner_id INTEGER,                     -- Link Ä‘áº¿n TPOS Partner.Id
    facebook_id VARCHAR(100),                    -- Facebook PSID (náº¿u cÃ³)
    zalo_id VARCHAR(100),                        -- Zalo ID (náº¿u cÃ³)
    
    -- â•â•â• PHÃ‚N LOáº I & STATUS â•â•â•
    status VARCHAR(30) DEFAULT 'active',         -- active, warning, danger, blocked
    tier VARCHAR(20) DEFAULT 'normal',           -- normal, silver, gold, vip, blacklist
    tags JSONB DEFAULT '[]',                     -- Flexible tags: ["Hay Ä‘á»•i size", "VIP", ...]
    
    -- â•â•â• THá»NG KÃŠ Tá»° Äá»˜NG (Cáº­p nháº­t bá»Ÿi triggers) â•â•â•
    total_orders INTEGER DEFAULT 0,              -- Tá»•ng sá»‘ Ä‘Æ¡n hÃ ng
    total_spent DECIMAL(15,2) DEFAULT 0,         -- Tá»•ng chi tiÃªu
    successful_orders INTEGER DEFAULT 0,         -- ÄÆ¡n thÃ nh cÃ´ng
    returned_orders INTEGER DEFAULT 0,           -- ÄÆ¡n hoÃ n/boom
    return_rate DECIMAL(5,2) DEFAULT 0,          -- Tá»· lá»‡ hoÃ n (%)
    
    -- â•â•â• ENGAGEMENT METRICS â•â•â•
    first_order_date TIMESTAMP,                  -- NgÃ y Ä‘Æ¡n Ä‘áº§u tiÃªn
    last_order_date TIMESTAMP,                   -- NgÃ y Ä‘Æ¡n gáº§n nháº¥t
    last_interaction_date TIMESTAMP,             -- Láº§n tÆ°Æ¡ng tÃ¡c gáº§n nháº¥t
    days_since_last_order INTEGER,               -- Sá»‘ ngÃ y tá»« Ä‘Æ¡n cuá»‘i
    
    -- â•â•â• RFM SCORING (cho Upsell/Marketing) â•â•â•
    rfm_recency_score INTEGER DEFAULT 0,         -- 1-5 (5 = má»›i mua gáº§n Ä‘Ã¢y)
    rfm_frequency_score INTEGER DEFAULT 0,       -- 1-5 (5 = mua thÆ°á»ng xuyÃªn)
    rfm_monetary_score INTEGER DEFAULT 0,        -- 1-5 (5 = chi tiÃªu cao)
    rfm_segment VARCHAR(30),                     -- Champions, Loyal, At Risk, Lost, etc.
    
    -- â•â•â• GHI CHÃš â•â•â•
    internal_note TEXT,                          -- Ghi chÃº ná»™i bá»™
    
    -- â•â•â• METADATA â•â•â•
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    
    -- â•â•â• CONSTRAINTS â•â•â•
    CONSTRAINT chk_phone_format CHECK (phone ~ '^0[0-9]{9,10}$'),
    CONSTRAINT chk_valid_status CHECK (status IN ('active', 'warning', 'danger', 'blocked')),
    CONSTRAINT chk_valid_tier CHECK (tier IN ('normal', 'silver', 'gold', 'vip', 'blacklist'))
);

-- â•â•â• INDEXES â•â•â•
CREATE INDEX idx_customers_phone ON customers(phone);
CREATE INDEX idx_customers_tpos_id ON customers(tpos_partner_id);
CREATE INDEX idx_customers_status ON customers(status);
CREATE INDEX idx_customers_tier ON customers(tier);
CREATE INDEX idx_customers_last_order ON customers(last_order_date DESC);
CREATE INDEX idx_customers_rfm ON customers(rfm_segment);
CREATE INDEX idx_customers_tags ON customers USING GIN(tags);


2.2 Table: customer_wallets (VÃ­ Tiá»n)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Báº¢NG: customer_wallets - VÃ­ tiá»n khÃ¡ch hÃ ng
-- LiÃªn káº¿t 1-1 vá»›i customers qua phone
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE customer_wallets (
    id SERIAL PRIMARY KEY,
    
    -- â•â•â• LIÃŠN Káº¾T â•â•â•
    customer_id INTEGER REFERENCES customers(id) ON DELETE CASCADE,
    phone VARCHAR(20) UNIQUE NOT NULL REFERENCES customers(phone),
    
    -- â•â•â• Sá» DÆ¯ â•â•â•
    balance DECIMAL(15,2) DEFAULT 0,             -- Sá»‘ dÆ° THá»°C
    virtual_balance DECIMAL(15,2) DEFAULT 0,     -- Sá»‘ dÆ° áº¢O (cÃ´ng ná»£ áº£o active)
    
    -- â•â•â• Tá»”NG Há»¢P â•â•â•
    total_deposited DECIMAL(15,2) DEFAULT 0,     -- Tá»•ng tiá»n Ä‘Ã£ náº¡p
    total_withdrawn DECIMAL(15,2) DEFAULT 0,     -- Tá»•ng tiá»n Ä‘Ã£ rÃºt/dÃ¹ng
    total_virtual_issued DECIMAL(15,2) DEFAULT 0,-- Tá»•ng cÃ´ng ná»£ áº£o Ä‘Ã£ cáº¥p
    total_virtual_used DECIMAL(15,2) DEFAULT 0,  -- Tá»•ng cÃ´ng ná»£ áº£o Ä‘Ã£ dÃ¹ng
    total_virtual_expired DECIMAL(15,2) DEFAULT 0,-- Tá»•ng cÃ´ng ná»£ áº£o Ä‘Ã£ háº¿t háº¡n
    
    -- â•â•â• METADATA â•â•â•
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- â•â•â• CONSTRAINTS â•â•â•
    CONSTRAINT chk_balance_positive CHECK (balance >= 0),
    CONSTRAINT chk_virtual_balance_positive CHECK (virtual_balance >= 0)
);

-- Auto-create wallet when customer is created
CREATE OR REPLACE FUNCTION create_wallet_for_customer()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO customer_wallets (customer_id, phone)
    VALUES (NEW.id, NEW.phone)
    ON CONFLICT (phone) DO NOTHING;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_create_wallet
AFTER INSERT ON customers
FOR EACH ROW EXECUTE FUNCTION create_wallet_for_customer();


2.3 Table: wallet_transactions (Lá»‹ch Sá»­ Giao Dá»‹ch VÃ­)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Báº¢NG: wallet_transactions - Lá»‹ch sá»­ giao dá»‹ch vÃ­ (IMMUTABLE)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE wallet_transactions (
    id SERIAL PRIMARY KEY,
    
    -- â•â•â• LIÃŠN Káº¾T â•â•â•
    phone VARCHAR(20) NOT NULL REFERENCES customers(phone),
    wallet_id INTEGER REFERENCES customer_wallets(id),
    
    -- â•â•â• LOáº I GIAO Dá»ŠCH â•â•â•
    type VARCHAR(30) NOT NULL,
    -- DEPOSIT: Náº¡p tiá»n (tá»« bank transfer, hoÃ n hÃ ng)
    -- WITHDRAW: RÃºt tiá»n (dÃ¹ng Ä‘á»ƒ giáº£m COD, rÃºt vá»)
    -- VIRTUAL_CREDIT: Cáº¥p cÃ´ng ná»£ áº£o
    -- VIRTUAL_DEBIT: Sá»­ dá»¥ng cÃ´ng ná»£ áº£o
    -- VIRTUAL_EXPIRE: CÃ´ng ná»£ áº£o háº¿t háº¡n
    -- ADJUSTMENT: Äiá»u chá»‰nh thá»§ cÃ´ng
    
    -- â•â•â• Sá» TIá»€N â•â•â•
    amount DECIMAL(15,2) NOT NULL,               -- Sá»‘ tiá»n (+ hoáº·c -)
    balance_before DECIMAL(15,2),
    balance_after DECIMAL(15,2),
    virtual_balance_before DECIMAL(15,2),
    virtual_balance_after DECIMAL(15,2),
    
    -- â•â•â• NGUá»’N â•â•â•
    source VARCHAR(50) NOT NULL,
    -- BANK_TRANSFER, RETURN_GOODS, ORDER_PAYMENT, VIRTUAL_CREDIT_ISSUE,
    -- VIRTUAL_CREDIT_USE, VIRTUAL_CREDIT_EXPIRE, MANUAL_ADJUSTMENT
    
    -- â•â•â• THAM CHIáº¾U â•â•â•
    reference_type VARCHAR(30),                  -- bank_tx, ticket, order, manual
    reference_id VARCHAR(100),
    
    -- â•â•â• METADATA â•â•â•
    note TEXT,
    created_by VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_wtx_phone ON wallet_transactions(phone);
CREATE INDEX idx_wtx_type ON wallet_transactions(type);
CREATE INDEX idx_wtx_created_at ON wallet_transactions(created_at DESC);
CREATE INDEX idx_wtx_reference ON wallet_transactions(reference_type, reference_id);


2.4 Table: virtual_credits (CÃ´ng Ná»£ áº¢o)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Báº¢NG: virtual_credits - CÃ´ng ná»£ áº£o cÃ³ thá»i háº¡n
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE virtual_credits (
    id SERIAL PRIMARY KEY,
    
    -- â•â•â• LIÃŠN Káº¾T â•â•â•
    phone VARCHAR(20) NOT NULL REFERENCES customers(phone),
    wallet_id INTEGER REFERENCES customer_wallets(id),
    
    -- â•â•â• Sá» TIá»€N â•â•â•
    original_amount DECIMAL(15,2) NOT NULL,
    remaining_amount DECIMAL(15,2) NOT NULL,
    
    -- â•â•â• THá»œI Háº N â•â•â•
    issued_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    
    -- â•â•â• TRáº NG THÃI â•â•â•
    status VARCHAR(20) DEFAULT 'ACTIVE',         -- ACTIVE, USED, EXPIRED, CANCELLED
    
    -- â•â•â• NGUá»’N â•â•â•
    source_type VARCHAR(30) NOT NULL,            -- RETURN_SHIPPER, COMPENSATION, PROMOTION
    source_id VARCHAR(100),                      -- ticket_id hoáº·c promotion_id
    
    -- â•â•â• Sá»¬ Dá»¤NG â•â•â•
    used_in_orders JSONB DEFAULT '[]',           -- [{orderId, amount, usedAt}]
    
    -- â•â•â• METADATA â•â•â•
    note TEXT,
    created_by VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_vc_phone ON virtual_credits(phone);
CREATE INDEX idx_vc_status ON virtual_credits(status);
CREATE INDEX idx_vc_expires_at ON virtual_credits(expires_at) WHERE status = 'ACTIVE';


2.5 Table: customer_tickets (Sá»± Vá»¥ KhÃ¡ch HÃ ng)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Báº¢NG: customer_tickets - Sá»± vá»¥ khÃ¡ch hÃ ng (MIGRATE tá»« Firebase)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE customer_tickets (
    id SERIAL PRIMARY KEY,
    
    -- â•â•â• IDENTITY â•â•â•
    ticket_code VARCHAR(20) UNIQUE NOT NULL,     -- TV-2026-00001 (auto-generated)
    
    -- â•â•â• LIÃŠN Káº¾T KHÃCH HÃ€NG â•â•â•
    phone VARCHAR(20) NOT NULL REFERENCES customers(phone),
    customer_id INTEGER REFERENCES customers(id),
    customer_name VARCHAR(255),
    
    -- â•â•â• LIÃŠN Káº¾T ÄÆ N HÃ€NG â•â•â•
    order_id VARCHAR(50),                        -- TPOS Order ID (VD: "NJD/2026/12345")
    tpos_order_id INTEGER,                       -- TPOS internal ID
    tracking_code VARCHAR(50),                   -- MÃ£ váº­n Ä‘Æ¡n
    carrier VARCHAR(50),                         -- ÄVVC: GHN, SPX, GHTK...
    
    -- â•â•â• LOáº I & TRáº NG THÃI â•â•â•
    type VARCHAR(30) NOT NULL,
    -- BOOM: KhÃ¡ch khÃ´ng nháº­n
    -- FIX_COD: Sá»­a COD
    -- RETURN_CLIENT: KhÃ¡ch gá»­i vá»
    -- RETURN_SHIPPER: Thu vá» (cÃ´ng ná»£ áº£o)
    -- COMPLAINT: Khiáº¿u náº¡i
    -- WARRANTY: Báº£o hÃ nh
    -- OTHER: KhÃ¡c
    
    status VARCHAR(30) DEFAULT 'PENDING',
    -- PENDING: Chá» xá»­ lÃ½
    -- IN_PROGRESS: Äang xá»­ lÃ½
    -- PENDING_GOODS: Chá» hÃ ng vá»
    -- PENDING_FINANCE: Chá» Ä‘á»‘i soÃ¡t
    -- COMPLETED: HoÃ n táº¥t
    -- CANCELLED: ÄÃ£ há»§y
    
    priority VARCHAR(20) DEFAULT 'normal',       -- low, normal, high, urgent
    
    -- â•â•â• CHI TIáº¾T Sá»° Vá»¤ â•â•â•
    subject VARCHAR(255),                        -- TiÃªu Ä‘á» ngáº¯n
    description TEXT,                            -- MÃ´ táº£ chi tiáº¿t
    
    -- â•â•â• Sáº¢N PHáº¨M LIÃŠN QUAN â•â•â•
    products JSONB DEFAULT '[]',
    -- [{id, name, sku, price, quantity, status: "returned"|"damaged"|"ok"}]
    
    -- â•â•â• TÃ€I CHÃNH â•â•â•
    original_cod DECIMAL(15,2),                  -- COD gá»‘c
    new_cod DECIMAL(15,2),                       -- COD má»›i (náº¿u sá»­a)
    refund_amount DECIMAL(15,2),                 -- Sá»‘ tiá»n hoÃ n
    wallet_credited BOOLEAN DEFAULT FALSE,       -- ÄÃ£ cá»™ng vÃ­ chÆ°a
    wallet_transaction_id INTEGER,               -- Ref Ä‘áº¿n wallet_transaction
    
    -- â•â•â• CÃ”NG Ná»¢ áº¢O (cho RETURN_SHIPPER) â•â•â•
    virtual_credit_id INTEGER REFERENCES virtual_credits(id),
    virtual_credit_amount DECIMAL(15,2),
    
    -- â•â•â• FIX_COD DETAILS â•â•â•
    fix_cod_reason VARCHAR(30),                  -- WRONG_SHIP, CUSTOMER_DEBT, DISCOUNT, REJECT_PARTIAL
    
    -- â•â•â• TIMELINE & TRACKING â•â•â•
    deadline TIMESTAMP,                          -- Deadline xá»­ lÃ½
    carrier_deadline TIMESTAMP,                  -- Deadline ÄVVC tráº£ hÃ ng
    received_at TIMESTAMP,                       -- NgÃ y nháº­n hÃ ng vá» kho
    settled_at TIMESTAMP,                        -- NgÃ y Ä‘á»‘i soÃ¡t xong
    
    -- â•â•â• NGÆ¯á»œI Xá»¬ LÃ â•â•â•
    assigned_to VARCHAR(100),                    -- NhÃ¢n viÃªn phá»¥ trÃ¡ch
    
    -- â•â•â• GHI CHÃš & ATTACHMENTS â•â•â•
    internal_note TEXT,
    attachments JSONB DEFAULT '[]',              -- [{url, filename, type, uploaded_at}]
    
    -- â•â•â• Lá»ŠCH Sá»¬ Xá»¬ LÃ â•â•â•
    action_history JSONB DEFAULT '[]',
    -- [{action, old_status, new_status, performed_by, performed_at, note}]
    
    -- â•â•â• METADATA â•â•â•
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    created_by VARCHAR(100),
    
    -- â•â•â• FIREBASE MIGRATION â•â•â•
    firebase_id VARCHAR(100),                    -- Original Firebase push ID
    
    -- â•â•â• CONSTRAINTS â•â•â•
    CONSTRAINT chk_valid_type CHECK (type IN ('BOOM', 'FIX_COD', 'RETURN_CLIENT', 
        'RETURN_SHIPPER', 'COMPLAINT', 'WARRANTY', 'OTHER')),
    CONSTRAINT chk_valid_status CHECK (status IN ('PENDING', 'IN_PROGRESS', 
        'PENDING_GOODS', 'PENDING_FINANCE', 'COMPLETED', 'CANCELLED'))
);

-- â•â•â• INDEXES â•â•â•
CREATE INDEX idx_tickets_phone ON customer_tickets(phone);
CREATE INDEX idx_tickets_status ON customer_tickets(status);
CREATE INDEX idx_tickets_type ON customer_tickets(type);
CREATE INDEX idx_tickets_order_id ON customer_tickets(order_id);
CREATE INDEX idx_tickets_created_at ON customer_tickets(created_at DESC);
CREATE INDEX idx_tickets_assigned ON customer_tickets(assigned_to);

-- â•â•â• TICKET CODE GENERATOR â•â•â•
CREATE OR REPLACE FUNCTION generate_ticket_code()
RETURNS TRIGGER AS $$
DECLARE
    year_part VARCHAR(4);
    seq_num INTEGER;
BEGIN
    year_part := TO_CHAR(CURRENT_DATE, 'YYYY');
    
    SELECT COALESCE(MAX(
        CAST(SUBSTRING(ticket_code FROM 9 FOR 5) AS INTEGER)
    ), 0) + 1
    INTO seq_num
    FROM customer_tickets
    WHERE ticket_code LIKE 'TV-' || year_part || '-%';
    
    NEW.ticket_code := 'TV-' || year_part || '-' || LPAD(seq_num::TEXT, 5, '0');
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_generate_ticket_code
BEFORE INSERT ON customer_tickets
FOR EACH ROW
WHEN (NEW.ticket_code IS NULL)
EXECUTE FUNCTION generate_ticket_code();


2.6 Table: customer_activities (Timeline Hoáº¡t Äá»™ng)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Báº¢NG: customer_activities - Timeline hoáº¡t Ä‘á»™ng khÃ¡ch hÃ ng
-- Unified activity stream cho Customer 360Â° view
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE customer_activities (
    id SERIAL PRIMARY KEY,
    
    -- â•â•â• LIÃŠN Káº¾T â•â•â•
    phone VARCHAR(20) NOT NULL REFERENCES customers(phone),
    customer_id INTEGER REFERENCES customers(id),
    
    -- â•â•â• LOáº I HOáº T Äá»˜NG â•â•â•
    activity_type VARCHAR(30) NOT NULL,
    -- WALLET_DEPOSIT, WALLET_WITHDRAW, WALLET_VIRTUAL_CREDIT
    -- TICKET_CREATED, TICKET_UPDATED, TICKET_COMPLETED
    -- ORDER_CREATED, ORDER_DELIVERED, ORDER_RETURNED
    -- MESSAGE_SENT, MESSAGE_RECEIVED
    -- PROFILE_UPDATED, TAG_ADDED, NOTE_ADDED
    
    -- â•â•â• Ná»˜I DUNG â•â•â•
    title VARCHAR(255) NOT NULL,                 -- "Chuyá»ƒn khoáº£n 500,000Ä‘"
    description TEXT,                            -- Chi tiáº¿t (optional)
    
    -- â•â•â• THAM CHIáº¾U â•â•â•
    reference_type VARCHAR(30),                  -- wallet_tx, ticket, order, message
    reference_id VARCHAR(100),
    
    -- â•â•â• Dá»® LIá»†U Bá»” SUNG â•â•â•
    metadata JSONB DEFAULT '{}',                 -- Flexible extra data
    
    -- â•â•â• ICON & COLOR (cho UI) â•â•â•
    icon VARCHAR(30),                            -- Font Awesome icon name
    color VARCHAR(20),                           -- green, red, blue, orange...
    
    -- â•â•â• METADATA â•â•â•
    created_by VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_activities_phone ON customer_activities(phone);
CREATE INDEX idx_activities_type ON customer_activities(activity_type);
CREATE INDEX idx_activities_created_at ON customer_activities(created_at DESC);

-- â•â•â• VIEW: Unified Timeline â•â•â•
CREATE OR REPLACE VIEW customer_timeline AS
SELECT 
    id,
    phone,
    activity_type,
    title,
    description,
    reference_type,
    reference_id,
    metadata,
    icon,
    color,
    created_by,
    created_at
FROM customer_activities
ORDER BY created_at DESC;


2.7 Table: customer_notes (Ghi ChÃº)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Báº¢NG: customer_notes - Ghi chÃº vá» khÃ¡ch hÃ ng
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE customer_notes (
    id SERIAL PRIMARY KEY,
    
    phone VARCHAR(20) NOT NULL REFERENCES customers(phone),
    customer_id INTEGER REFERENCES customers(id),
    
    -- â•â•â• Ná»˜I DUNG â•â•â•
    content TEXT NOT NULL,
    is_pinned BOOLEAN DEFAULT FALSE,             -- Ghim lÃªn Ä‘áº§u
    
    -- â•â•â• PHÃ‚N LOáº I â•â•â•
    category VARCHAR(30) DEFAULT 'general',      -- general, warning, important, follow_up
    
    -- â•â•â• METADATA â•â•â•
    created_by VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notes_phone ON customer_notes(phone);
CREATE INDEX idx_notes_pinned ON customer_notes(is_pinned) WHERE is_pinned = TRUE;


2.8 Cáº­p Nháº­t: balance_history (Link to Customer)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ALTER: balance_history - ThÃªm liÃªn káº¿t customer
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALTER TABLE balance_history 
ADD COLUMN IF NOT EXISTS customer_phone VARCHAR(20),
ADD COLUMN IF NOT EXISTS customer_id INTEGER,
ADD COLUMN IF NOT EXISTS wallet_processed BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS wallet_transaction_id INTEGER;

-- Foreign key (soft - khÃ´ng báº¯t buá»™c vÃ¬ cÃ³ thá»ƒ cÃ³ GD khÃ´ng match customer)
CREATE INDEX idx_bh_customer_phone ON balance_history(customer_phone);
CREATE INDEX idx_bh_unprocessed ON balance_history(wallet_processed) WHERE wallet_processed = FALSE;



3. ENTITY RELATIONSHIP DIAGRAM
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ENTITY RELATIONSHIP DIAGRAM                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚                              â”‚      customers        â”‚                                  â”‚
â”‚                              â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚                                  â”‚
â”‚                              â”‚  PK: id               â”‚                                  â”‚
â”‚                              â”‚  UK: phone â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                              â”‚                       â”‚                      â”‚          â”‚
â”‚                              â”‚  name                 â”‚                      â”‚          â”‚
â”‚                              â”‚  status, tier, tags   â”‚                      â”‚          â”‚
â”‚                              â”‚  total_orders         â”‚                      â”‚          â”‚
â”‚                              â”‚  rfm_segment          â”‚                      â”‚          â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚          â”‚
â”‚                                          â”‚                                  â”‚          â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚          â”‚
â”‚               â”‚                          â”‚                          â”‚       â”‚          â”‚
â”‚               â–¼                          â–¼                          â–¼       â”‚          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚          â”‚
â”‚   â”‚  customer_wallets   â”‚   â”‚  customer_tickets   â”‚   â”‚ customer_activities â”‚â”‚          â”‚
â”‚   â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚   â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚   â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚â”‚          â”‚
â”‚   â”‚  PK: id             â”‚   â”‚  PK: id             â”‚   â”‚ PK: id              â”‚â”‚          â”‚
â”‚   â”‚  FK: phone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”‚  FK: phone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”‚ FK: phone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”˜          â”‚
â”‚   â”‚                     â”‚   â”‚                     â”‚   â”‚                     â”‚           â”‚
â”‚   â”‚  balance            â”‚   â”‚  ticket_code        â”‚   â”‚ activity_type       â”‚           â”‚
â”‚   â”‚  virtual_balance    â”‚   â”‚  type, status       â”‚   â”‚ title               â”‚           â”‚
â”‚   â”‚                     â”‚   â”‚  order_id           â”‚   â”‚ reference_type/id   â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  refund_amount      â”‚   â”‚ metadata            â”‚           â”‚
â”‚              â”‚              â”‚  virtual_credit_id â”€â”¼â”€â” â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚              â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                   â”‚
â”‚              â”‚                                      â”‚                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚                     â”‚              â”‚                     â”‚                          â”‚
â”‚   â–¼                     â–¼              â–¼                     â”‚                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                          â”‚
â”‚   â”‚ wallet_transactions â”‚   â”‚   virtual_credits   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚   â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚   â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚                                    â”‚
â”‚   â”‚ PK: id              â”‚   â”‚ PK: id              â”‚                                    â”‚
â”‚   â”‚ FK: phone           â”‚   â”‚ FK: phone           â”‚                                    â”‚
â”‚   â”‚ FK: wallet_id       â”‚   â”‚ FK: wallet_id       â”‚                                    â”‚
â”‚   â”‚                     â”‚   â”‚                     â”‚                                    â”‚
â”‚   â”‚ type, amount        â”‚   â”‚ original_amount     â”‚                                    â”‚
â”‚   â”‚ source              â”‚   â”‚ remaining_amount    â”‚                                    â”‚
â”‚   â”‚ reference_type/id   â”‚   â”‚ expires_at          â”‚                                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ status              â”‚                                    â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚   â”‚   customer_notes    â”‚   â”‚   balance_history   â”‚                                    â”‚
â”‚   â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚   â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚                                    â”‚
â”‚   â”‚ PK: id              â”‚   â”‚ PK: id              â”‚                                    â”‚
â”‚   â”‚ FK: phone           â”‚   â”‚ FK: customer_phone  â”‚ (soft link)                        â”‚
â”‚   â”‚                     â”‚   â”‚                     â”‚                                    â”‚
â”‚   â”‚ content             â”‚   â”‚ sepay_id            â”‚                                    â”‚
â”‚   â”‚ category            â”‚   â”‚ transfer_amount     â”‚                                    â”‚
â”‚   â”‚ is_pinned           â”‚   â”‚ wallet_processed    â”‚                                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



4. API ENDPOINTS
4.1 Customer APIs
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 CUSTOMER APIs                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  GET    /api/customer/:phone                                                            â”‚
â”‚         â†’ Láº¥y thÃ´ng tin Ä‘áº§y Ä‘á»§ cá»§a khÃ¡ch hÃ ng (Customer 360Â° View)                     â”‚
â”‚         Response: {                                                                     â”‚
â”‚           customer: {...},                                                              â”‚
â”‚           wallet: {...},                                                                â”‚
â”‚           tickets: [{...}],        // Latest 10                                         â”‚
â”‚           activities: [{...}],     // Latest 20                                         â”‚
â”‚           notes: [{...}],                                                               â”‚
â”‚           stats: {...}                                                                  â”‚
â”‚         }                                                                               â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/customer                                                                   â”‚
â”‚         â†’ Táº¡o khÃ¡ch hÃ ng má»›i (auto-create wallet)                                      â”‚
â”‚         Body: { phone, name, email?, addresses? }                                       â”‚
â”‚                                                                                         â”‚
â”‚  PUT    /api/customer/:phone                                                            â”‚
â”‚         â†’ Cáº­p nháº­t thÃ´ng tin khÃ¡ch hÃ ng                                                â”‚
â”‚                                                                                         â”‚
â”‚  GET    /api/customer/:phone/tickets                                                    â”‚
â”‚         â†’ Láº¥y danh sÃ¡ch sá»± vá»¥ (paginated)                                              â”‚
â”‚         Query: ?status=&type=&page=&limit=                                             â”‚
â”‚                                                                                         â”‚
â”‚  GET    /api/customer/:phone/activities                                                 â”‚
â”‚         â†’ Láº¥y timeline hoáº¡t Ä‘á»™ng (paginated)                                           â”‚
â”‚         Query: ?type=&from=&to=&page=&limit=                                           â”‚
â”‚                                                                                         â”‚
â”‚  GET    /api/customer/:phone/transactions                                               â”‚
â”‚         â†’ Láº¥y lá»‹ch sá»­ giao dá»‹ch vÃ­ (paginated)                                         â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/customer/:phone/note                                                       â”‚
â”‚         â†’ ThÃªm ghi chÃº vá» khÃ¡ch hÃ ng                                                   â”‚
â”‚                                                                                         â”‚
â”‚  PUT    /api/customer/:phone/tags                                                       â”‚
â”‚         â†’ Cáº­p nháº­t tags                                                                â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/customer/search                                                            â”‚
â”‚         â†’ TÃ¬m kiáº¿m khÃ¡ch hÃ ng                                                          â”‚
â”‚         Body: { query, filters: {status, tier, tags}, sort, page, limit }              â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/customer/batch                                                             â”‚
â”‚         â†’ Láº¥y thÃ´ng tin nhiá»u khÃ¡ch cÃ¹ng lÃºc                                           â”‚
â”‚         Body: { phones: ["0901234567", "0912345678"] }                                  â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


4.2 Wallet APIs
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   WALLET APIs                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  GET    /api/wallet/:phone                                                              â”‚
â”‚         â†’ Láº¥y thÃ´ng tin vÃ­                                                             â”‚
â”‚         Response: { balance, virtual_balance, virtual_credits: [...], totals }         â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/wallet/:phone/deposit                                                      â”‚
â”‚         â†’ Náº¡p tiá»n vÃ o vÃ­                                                              â”‚
â”‚         Body: { amount, source, reference_type?, reference_id?, note? }                â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/wallet/:phone/withdraw                                                     â”‚
â”‚         â†’ RÃºt tiá»n/sá»­ dá»¥ng vÃ­                                                          â”‚
â”‚         Body: { amount, order_id?, note? }                                              â”‚
â”‚         â†’ Tá»± Ä‘á»™ng trá»« virtual credits trÆ°á»›c (FIFO)                                     â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/wallet/:phone/virtual-credit                                               â”‚
â”‚         â†’ Cáº¥p cÃ´ng ná»£ áº£o                                                               â”‚
â”‚         Body: { amount, expiry_days?, source_type, source_id?, note? }                 â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/wallet/batch-summary                                                       â”‚
â”‚         â†’ Láº¥y sá»‘ dÆ° nhiá»u khÃ¡ch cÃ¹ng lÃºc (cho orders-report)                           â”‚
â”‚         Body: { phones: [...] }                                                         â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/wallet/cron/expire-virtual-credits                                         â”‚
â”‚         â†’ Cron job: Thu há»“i cÃ´ng ná»£ áº£o háº¿t háº¡n                                         â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/wallet/cron/process-bank-transactions                                      â”‚
â”‚         â†’ Cron job: Xá»­ lÃ½ giao dá»‹ch bank chÆ°a process                                  â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


4.3 Ticket APIs
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   TICKET APIs                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  GET    /api/ticket                                                                     â”‚
â”‚         â†’ Danh sÃ¡ch táº¥t cáº£ sá»± vá»¥ (paginated)                                           â”‚
â”‚         Query: ?status=&type=&phone=&assigned_to=&from=&to=&page=&limit=              â”‚
â”‚                                                                                         â”‚
â”‚  GET    /api/ticket/:id                                                                 â”‚
â”‚         â†’ Chi tiáº¿t sá»± vá»¥                                                               â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/ticket                                                                     â”‚
â”‚         â†’ Táº¡o sá»± vá»¥ má»›i                                                                â”‚
â”‚         Body: { phone, type, order_id?, products?, ... }                               â”‚
â”‚         â†’ Auto-create customer náº¿u chÆ°a cÃ³                                             â”‚
â”‚         â†’ Auto-issue virtual credit náº¿u type = RETURN_SHIPPER                          â”‚
â”‚                                                                                         â”‚
â”‚  PUT    /api/ticket/:id                                                                 â”‚
â”‚         â†’ Cáº­p nháº­t sá»± vá»¥                                                               â”‚
â”‚                                                                                         â”‚
â”‚  POST   /api/ticket/:id/action                                                          â”‚
â”‚         â†’ Thá»±c hiá»‡n action trÃªn sá»± vá»¥                                                  â”‚
â”‚         Body: { action: "receive_goods"|"settle"|"complete"|"cancel", note? }          â”‚
â”‚         â†’ Auto-credit wallet khi complete (náº¿u applicable)                             â”‚
â”‚                                                                                         â”‚
â”‚  GET    /api/ticket/stats                                                               â”‚
â”‚         â†’ Thá»‘ng kÃª sá»± vá»¥ theo status/type                                              â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



5. FRONTEND MODULE: customer-hub/
5.1 Cáº¥u TrÃºc ThÆ° Má»¥c
n2store/
â”œâ”€â”€ customer-hub/                      # â­ MODULE Má»šI - Customer 360Â°
â”‚   â”œâ”€â”€ index.html                     # Main page - Danh sÃ¡ch khÃ¡ch hÃ ng
â”‚   â”œâ”€â”€ customer-detail.html           # Customer 360Â° View
â”‚   â”‚
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ main.js                    # Entry point, routing
â”‚   â”‚   â”œâ”€â”€ customer-service.js        # API calls
â”‚   â”‚   â”œâ”€â”€ customer-list.js           # Danh sÃ¡ch khÃ¡ch
â”‚   â”‚   â”œâ”€â”€ customer-detail.js         # Chi tiáº¿t khÃ¡ch (360Â° View)
â”‚   â”‚   â”œâ”€â”€ wallet-panel.js            # Panel vÃ­ tiá»n
â”‚   â”‚   â”œâ”€â”€ ticket-panel.js            # Panel sá»± vá»¥
â”‚   â”‚   â”œâ”€â”€ activity-timeline.js       # Timeline hoáº¡t Ä‘á»™ng
â”‚   â”‚   â””â”€â”€ utils.js                   # Utilities
â”‚   â”‚
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”œâ”€â”€ main.css
â”‚   â”‚   â”œâ”€â”€ customer-detail.css
â”‚   â”‚   â””â”€â”€ components.css
â”‚   â”‚
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ orders-report/                     # Sá»¬A: TÃ­ch há»£p Customer Hub
â”‚   â”œâ”€â”€ tab1-orders.js                 # Sá»¬A: Link Ä‘áº¿n Customer Hub
â”‚   â””â”€â”€ wallet-integration.js          # Má»šI: Module wallet
â”‚
â”œâ”€â”€ balance-history/                   # Sá»¬A: Link Ä‘áº¿n Customer Hub
â”‚   â””â”€â”€ main.js                        # Sá»¬A: Click SÄT â†’ Customer Hub
â”‚
â””â”€â”€ issue-tracking/                    # Sáº¼ MIGRATE â†’ customer-hub
    â””â”€â”€ (deprecated - migrate tickets to PostgreSQL)


5.2 UI Mockup: Customer 360Â° View
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â—€ Quay láº¡i              CUSTOMER 360Â° VIEW                              ğŸ””  ğŸ‘¤        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  HEADER - THÃ”NG TIN CHÃNH                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”                                                                         â”‚ â”‚
â”‚  â”‚  â”‚  ğŸ‘¤  â”‚  Nguyá»…n VÄƒn A                              â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚      â”‚  ğŸ“± 0901234567                             â”‚ VIP â”‚  â”‚ Hay Ä‘á»•i sizeâ”‚      â”‚ â”‚
â”‚  â”‚  â”‚ Avatarâ”‚  âœ‰ï¸ nguyenvana@gmail.com                  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  ğŸ“ 123 ABC, Quáº­n 1, TP.HCM                                             â”‚ â”‚
â”‚  â”‚                                                                                   â”‚ â”‚
â”‚  â”‚  KhÃ¡ch hÃ ng tá»«: 15/01/2025  â€¢  Láº§n mua gáº§n nháº¥t: 3 ngÃ y trÆ°á»›c  â€¢  15 Ä‘Æ¡n hÃ ng    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  QUICK STATS                                                                        â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚â”‚
â”‚  â”‚  â”‚  ğŸ’° VÃ TIá»€N  â”‚ â”‚  ğŸ“‹ Sá»° Vá»¤   â”‚ â”‚  ğŸ›’ ÄÆ N HÃ€NG â”‚ â”‚  ğŸ“ˆ CHI TIÃŠU â”‚               â”‚â”‚
â”‚  â”‚  â”‚              â”‚ â”‚              â”‚ â”‚              â”‚ â”‚              â”‚               â”‚â”‚
â”‚  â”‚  â”‚  700,000Ä‘   â”‚ â”‚   3 tá»•ng     â”‚ â”‚  15 Ä‘Æ¡n      â”‚ â”‚  5,200,000Ä‘ â”‚               â”‚â”‚
â”‚  â”‚  â”‚  (Thá»±c: 500k)â”‚ â”‚  (1 Ä‘ang XL) â”‚ â”‚  (12 OK)     â”‚ â”‚  (Avg: 347k) â”‚               â”‚â”‚
â”‚  â”‚  â”‚  (áº¢o: 200k) â”‚ â”‚              â”‚ â”‚  HoÃ n: 20%   â”‚ â”‚              â”‚               â”‚â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚              â”‚ â”‚              â”‚ â”‚              â”‚               â”‚â”‚
â”‚  â”‚  â”‚[Xem chi tiáº¿t]â”‚ â”‚[Xem chi tiáº¿t]â”‚ â”‚[Xem chi tiáº¿t]â”‚ â”‚              â”‚               â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“ GHI CHÃš Ná»˜I Bá»˜       â”‚  â”‚  ğŸ“Š TIMELINE HOáº T Äá»˜NG                             â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚  ğŸ“Œ KhÃ¡ch VIP, Æ°u tiÃªn   â”‚  â”‚  â— 05/01 ğŸ’° Chuyá»ƒn khoáº£n 500,000Ä‘ vÃ o vÃ­          â”‚  â”‚
â”‚  â”‚     xá»­ lÃ½ Ä‘á»•i tráº£        â”‚  â”‚       â””â”€ Ná»™i dung: N2ABC123 Nguyen Van A          â”‚  â”‚
â”‚  â”‚                          â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚  â— 04/01 ğŸ“‹ Sá»± vá»¥ #TV-2026-00003 Ä‘Ã£ hoÃ n táº¥t      â”‚  â”‚
â”‚  â”‚  05/01 - admin:          â”‚  â”‚       â””â”€ BOOM - ÄÆ¡n NJD/2026/45678                 â”‚  â”‚
â”‚  â”‚  ÄÃ£ xá»­ lÃ½ xong váº¥n Ä‘á»    â”‚  â”‚       â””â”€ HoÃ n 300,000Ä‘ vÃ o vÃ­                      â”‚  â”‚
â”‚  â”‚  Ä‘á»•i size láº§n 2          â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚                          â”‚  â”‚  â— 03/01 ğŸ›’ ÄÆ¡n NJD/2026/45678 giao thÃ nh cÃ´ng    â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚       â””â”€ COD: 350,000Ä‘ - Ão thun nam             â”‚  â”‚
â”‚  â”‚  [+ ThÃªm ghi chÃº]        â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚                          â”‚  â”‚  â— 02/01 ğŸ’¬ Inbox tá»« khÃ¡ch: "Cho em há»i size..."  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                                    â”‚  â”‚
â”‚                                â”‚  â— 01/01 ğŸ“‹ Sá»± vá»¥ #TV-2026-00002 - Cáº¥p cÃ´ng ná»£ áº£o â”‚  â”‚
â”‚                                â”‚       â””â”€ RETURN_SHIPPER - Äá»•i size Ã¡o              â”‚  â”‚
â”‚                                â”‚       â””â”€ CÃ´ng ná»£ áº£o: 200,000Ä‘ (cÃ²n 12 ngÃ y)        â”‚  â”‚
â”‚                                â”‚                                                    â”‚  â”‚
â”‚                                â”‚  [Xem thÃªm...]                                     â”‚  â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ğŸ¯ HÃ€NH Äá»˜NG NHANH                                                                 â”‚â”‚
â”‚  â”‚                                                                                     â”‚â”‚
â”‚  â”‚  [ğŸ“‹ Táº¡o sá»± vá»¥ má»›i]  [ğŸ’° Náº¡p tiá»n vÃ­]  [ğŸ’¬ Gá»­i tin nháº¯n]  [ğŸ“¦ Xem Ä‘Æ¡n trÃªn TPOS]  â”‚â”‚
â”‚  â”‚                                                                                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


5.3 Modal: Chi Tiáº¿t VÃ­ Tiá»n
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’° CHI TIáº¾T VÃ TIá»€N - 0901234567                                    [X]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Tá»”NG Sá» DÆ¯ KHáº¢ Dá»¤NG                                                  â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚               ğŸ’µ 700,000Ä‘                                             â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚ â”‚
â”‚  â”‚  â”‚  Sá» DÆ¯ THá»°C             â”‚  â”‚  CÃ”NG Ná»¢ áº¢O             â”‚            â”‚ â”‚
â”‚  â”‚  â”‚  500,000Ä‘              â”‚  â”‚  200,000Ä‘              â”‚            â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚            â”‚ â”‚
â”‚  â”‚  â”‚  CÃ³ thá»ƒ rÃºt vá»         â”‚  â”‚  â° CÃ²n 12 ngÃ y háº¿t háº¡n â”‚            â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ“‹ CÃ”NG Ná»¢ áº¢O CHI TIáº¾T                                               â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  #1  200,000Ä‘  RETURN_SHIPPER  01/01/2026  Háº¿t háº¡n: 16/01  ğŸŸ¢ ACTIVE â”‚ â”‚
â”‚  â”‚      â””â”€ Ticket: TV-2026-00002 - Äá»•i size Ã¡o                          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  (KhÃ´ng cÃ³ cÃ´ng ná»£ áº£o khÃ¡c)                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ“œ Lá»ŠCH Sá»¬ GIAO Dá»ŠCH                                     [Xem táº¥t cáº£]â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  05/01  DEPOSIT      +500,000Ä‘  Bank transfer   N2ABC123             â”‚ â”‚
â”‚  â”‚  04/01  DEPOSIT      +300,000Ä‘  Return goods    Ticket TV-2026-00003 â”‚ â”‚
â”‚  â”‚  01/01  VIRTUAL_CR   +200,000Ä‘  Virtual credit  Ticket TV-2026-00002 â”‚ â”‚
â”‚  â”‚  28/12  WITHDRAW     -150,000Ä‘  Order payment   NJD/2026/44444       â”‚ â”‚
â”‚  â”‚  ...                                                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  HÃ€NH Äá»˜NG                                                            â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  [ğŸ’µ Náº¡p tiá»n thá»§ cÃ´ng]    [ğŸ“¤ Äiá»u chá»‰nh sá»‘ dÆ°]                     â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



6. THUáº¬T TOÃN & LOGIC QUAN TRá»ŒNG
6.1 Thuáº­t ToÃ¡n Trá»« VÃ­ (FIFO Virtual Credits)
/**
 * Trá»« vÃ­ khÃ¡ch hÃ ng - Æ¯u tiÃªn Virtual Credits (FIFO by expires_at)
 * 
 * @param {string} phone - SÄT khÃ¡ch
 * @param {number} amount - Sá»‘ tiá»n cáº§n trá»«
 * @param {string} orderId - MÃ£ Ä‘Æ¡n hÃ ng
 * @returns {Object} Result
 */
async function useWalletBalance(phone, amount, orderId) {
    const client = await pool.connect();
    
    try {
        await client.query('BEGIN');
        
        // 1. Lock wallet for update
        const walletResult = await client.query(
            `SELECT * FROM customer_wallets WHERE phone = $1 FOR UPDATE`,
            [phone]
        );
        
        if (!walletResult.rows.length) {
            throw new WalletError('WALLET_NOT_FOUND', 'VÃ­ khÃ´ng tá»“n táº¡i');
        }
        
        const wallet = walletResult.rows[0];
        const totalAvailable = Number(wallet.balance) + Number(wallet.virtual_balance);
        
        if (amount > totalAvailable) {
            throw new WalletError('INSUFFICIENT_BALANCE', 
                `Sá»‘ dÆ° khÃ´ng Ä‘á»§ (CÃ³: ${totalAvailable}, Cáº§n: ${amount})`);
        }
        
        let remaining = amount;
        let virtualUsed = 0;
        let realUsed = 0;
        const usedCredits = [];
        
        // 2. Trá»« Virtual Credits trÆ°á»›c (FIFO by expires_at)
        if (remaining > 0 && Number(wallet.virtual_balance) > 0) {
            const creditsResult = await client.query(
                `SELECT * FROM virtual_credits 
                 WHERE phone = $1 AND status = 'ACTIVE' AND expires_at > NOW()
                 ORDER BY expires_at ASC
                 FOR UPDATE`,
                [phone]
            );
            
            for (const credit of creditsResult.rows) {
                if (remaining <= 0) break;
                
                const creditRemaining = Number(credit.remaining_amount);
                const useFromCredit = Math.min(creditRemaining, remaining);
                const newCreditRemaining = creditRemaining - useFromCredit;
                const newStatus = newCreditRemaining <= 0 ? 'USED' : 'ACTIVE';
                
                // Update credit
                const usedInOrders = credit.used_in_orders || [];
                usedInOrders.push({
                    orderId,
                    amount: useFromCredit,
                    usedAt: new Date().toISOString()
                });
                
                await client.query(
                    `UPDATE virtual_credits 
                     SET remaining_amount = $1, status = $2, 
                         used_in_orders = $3, updated_at = NOW()
                     WHERE id = $4`,
                    [newCreditRemaining, newStatus, JSON.stringify(usedInOrders), credit.id]
                );
                
                usedCredits.push({
                    creditId: credit.id,
                    amount: useFromCredit
                });
                
                virtualUsed += useFromCredit;
                remaining -= useFromCredit;
            }
        }
        
        // 3. Trá»« Real Balance
        if (remaining > 0) {
            realUsed = remaining;
            remaining = 0;
        }
        
        // 4. Update wallet
        const newBalance = Number(wallet.balance) - realUsed;
        const newVirtualBalance = Number(wallet.virtual_balance) - virtualUsed;
        
        await client.query(
            `UPDATE customer_wallets 
             SET balance = $1, virtual_balance = $2, 
                 total_withdrawn = total_withdrawn + $3,
                 total_virtual_used = total_virtual_used + $4,
                 updated_at = NOW()
             WHERE phone = $5`,
            [newBalance, newVirtualBalance, realUsed, virtualUsed, phone]
        );
        
        // 5. Log transactions
        const transactions = [];
        
        if (virtualUsed > 0) {
            const txResult = await client.query(
                `INSERT INTO wallet_transactions 
                 (phone, wallet_id, type, amount, 
                  balance_before, balance_after,
                  virtual_balance_before, virtual_balance_after,
                  source, reference_type, reference_id, note)
                 VALUES ($1, $2, 'VIRTUAL_DEBIT', $3, $4, $5, $6, $7, 
                         'ORDER_PAYMENT', 'order', $8, $9)
                 RETURNING id`,
                [phone, wallet.id, -virtualUsed, 
                 wallet.balance, newBalance,
                 wallet.virtual_balance, newVirtualBalance,
                 orderId, `Trá»« cÃ´ng ná»£ áº£o - ÄÆ¡n ${orderId}`]
            );
            transactions.push({ type: 'VIRTUAL_DEBIT', id: txResult.rows[0].id });
        }
        
        if (realUsed > 0) {
            const txResult = await client.query(
                `INSERT INTO wallet_transactions 
                 (phone, wallet_id, type, amount,
                  balance_before, balance_after,
                  virtual_balance_before, virtual_balance_after,
                  source, reference_type, reference_id, note)
                 VALUES ($1, $2, 'WITHDRAW', $3, $4, $5, $6, $7,
                         'ORDER_PAYMENT', 'order', $8, $9)
                 RETURNING id`,
                [phone, wallet.id, -realUsed,
                 wallet.balance, newBalance,
                 wallet.virtual_balance, newVirtualBalance,
                 orderId, `Trá»« sá»‘ dÆ° thá»±c - ÄÆ¡n ${orderId}`]
            );
            transactions.push({ type: 'WITHDRAW', id: txResult.rows[0].id });
        }
        
        // 6. Log activity
        await client.query(
            `INSERT INTO customer_activities 
             (phone, customer_id, activity_type, title, description,
              reference_type, reference_id, metadata, icon, color)
             VALUES ($1, (SELECT id FROM customers WHERE phone = $1),
                     'WALLET_WITHDRAW', $2, $3, 'order', $4, $5, 'money-bill', 'orange')`,
            [phone, 
             `Sá»­ dá»¥ng vÃ­ ${formatCurrency(virtualUsed + realUsed)} cho Ä‘Æ¡n hÃ ng`,
             `Virtual: ${formatCurrency(virtualUsed)}, Real: ${formatCurrency(realUsed)}`,
             orderId,
             JSON.stringify({ virtualUsed, realUsed, usedCredits })]
        );
        
        await client.query('COMMIT');
        
        return {
            success: true,
            virtualUsed,
            realUsed,
            totalUsed: virtualUsed + realUsed,
            newBalance,
            newVirtualBalance,
            usedCredits,
            transactions
        };
        
    } catch (error) {
        await client.query('ROLLBACK');
        throw error;
    } finally {
        client.release();
    }
}


6.2 Thuáº­t ToÃ¡n Cáº­p Nháº­t RFM Score
/**
 * Cáº­p nháº­t RFM Score cho khÃ¡ch hÃ ng
 * Cháº¡y daily hoáº·c khi cÃ³ Ä‘Æ¡n hÃ ng má»›i
 * 
 * RFM = Recency (má»›i mua) x Frequency (táº§n suáº¥t) x Monetary (giÃ¡ trá»‹)
 */
async function updateCustomerRFM(phone) {
    const result = await pool.query(`
        WITH customer_metrics AS (
            SELECT 
                c.phone,
                c.last_order_date,
                c.total_orders,
                c.successful_orders,
                c.total_spent,
                EXTRACT(DAY FROM NOW() - c.last_order_date) as days_since_last
            FROM customers c
            WHERE c.phone = $1
        ),
        
        -- Percentile thresholds (cÃ³ thá»ƒ Ä‘iá»u chá»‰nh theo business)
        rfm_calc AS (
            SELECT 
                phone,
                
                -- Recency Score (1-5, 5 = má»›i mua gáº§n Ä‘Ã¢y)
                CASE 
                    WHEN days_since_last IS NULL THEN 1
                    WHEN days_since_last <= 7 THEN 5
                    WHEN days_since_last <= 30 THEN 4
                    WHEN days_since_last <= 90 THEN 3
                    WHEN days_since_last <= 180 THEN 2
                    ELSE 1
                END as recency_score,
                
                -- Frequency Score (1-5, 5 = mua thÆ°á»ng xuyÃªn)
                CASE 
                    WHEN successful_orders >= 10 THEN 5
                    WHEN successful_orders >= 5 THEN 4
                    WHEN successful_orders >= 3 THEN 3
                    WHEN successful_orders >= 2 THEN 2
                    ELSE 1
                END as frequency_score,
                
                -- Monetary Score (1-5, 5 = chi tiÃªu cao)
                CASE 
                    WHEN total_spent >= 5000000 THEN 5
                    WHEN total_spent >= 2000000 THEN 4
                    WHEN total_spent >= 1000000 THEN 3
                    WHEN total_spent >= 500000 THEN 2
                    ELSE 1
                END as monetary_score
                
            FROM customer_metrics
        ),
        
        rfm_segment AS (
            SELECT 
                phone,
                recency_score,
                frequency_score,
                monetary_score,
                
                -- RFM Segment Classification
                CASE 
                    WHEN recency_score >= 4 AND frequency_score >= 4 AND monetary_score >= 4 
                        THEN 'Champions'
                    WHEN recency_score >= 3 AND frequency_score >= 3 AND monetary_score >= 3 
                        THEN 'Loyal'
                    WHEN recency_score >= 4 AND frequency_score <= 2 
                        THEN 'New Customers'
                    WHEN recency_score >= 3 AND frequency_score >= 3 AND monetary_score <= 2 
                        THEN 'Potential Loyalists'
                    WHEN recency_score <= 2 AND frequency_score >= 3 AND monetary_score >= 3 
                        THEN 'At Risk'
                    WHEN recency_score <= 2 AND frequency_score >= 4 AND monetary_score >= 4 
                        THEN 'Cant Lose Them'
                    WHEN recency_score <= 2 AND frequency_score <= 2 
                        THEN 'Lost'
                    ELSE 'Others'
                END as segment
                
            FROM rfm_calc
        )
        
        UPDATE customers c
        SET 
            rfm_recency_score = r.recency_score,
            rfm_frequency_score = r.frequency_score,
            rfm_monetary_score = r.monetary_score,
            rfm_segment = r.segment,
            updated_at = NOW()
        FROM rfm_segment r
        WHERE c.phone = r.phone
        RETURNING c.*;
    `, [phone]);
    
    return result.rows[0];
}


6.3 Trigger: Auto-Update Customer Stats
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- TRIGGER: Tá»± Ä‘á»™ng cáº­p nháº­t customer stats khi cÃ³ ticket completed
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE OR REPLACE FUNCTION update_customer_stats_on_ticket()
RETURNS TRIGGER AS $$
BEGIN
    -- Chá»‰ xá»­ lÃ½ khi ticket chuyá»ƒn sang COMPLETED
    IF NEW.status = 'COMPLETED' AND (OLD.status IS NULL OR OLD.status != 'COMPLETED') THEN
        
        -- Update returned_orders count náº¿u lÃ  BOOM/RETURN
        IF NEW.type IN ('BOOM', 'RETURN_CLIENT', 'RETURN_SHIPPER') THEN
            UPDATE customers
            SET 
                returned_orders = returned_orders + 1,
                return_rate = CASE 
                    WHEN total_orders > 0 THEN 
                        ROUND((returned_orders + 1)::DECIMAL / total_orders * 100, 2)
                    ELSE 0 
                END,
                last_interaction_date = NOW(),
                updated_at = NOW()
            WHERE phone = NEW.phone;
        END IF;
        
        -- Update tier if return rate too high
        UPDATE customers
        SET 
            status = CASE 
                WHEN return_rate > 50 THEN 'danger'
                WHEN return_rate > 30 THEN 'warning'
                ELSE status 
            END
        WHERE phone = NEW.phone AND return_rate > 30;
        
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_customer_on_ticket
AFTER INSERT OR UPDATE ON customer_tickets
FOR EACH ROW EXECUTE FUNCTION update_customer_stats_on_ticket();



7. MIGRATION PLAN
7.1 Phase 1: Database Setup (Tuáº§n 1)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 1: DATABASE SETUP                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Day 1-2: Create Tables                                                     â”‚
â”‚  â”œâ”€â”€ Run migration: customers table                                         â”‚
â”‚  â”œâ”€â”€ Run migration: customer_wallets table                                  â”‚
â”‚  â”œâ”€â”€ Run migration: wallet_transactions table                               â”‚
â”‚  â”œâ”€â”€ Run migration: virtual_credits table                                   â”‚
â”‚  â”œâ”€â”€ Run migration: customer_tickets table                                  â”‚
â”‚  â”œâ”€â”€ Run migration: customer_activities table                               â”‚
â”‚  â””â”€â”€ Run migration: customer_notes table                                    â”‚
â”‚                                                                             â”‚
â”‚  Day 3-4: Create Triggers & Functions                                       â”‚
â”‚  â”œâ”€â”€ Auto-create wallet trigger                                             â”‚
â”‚  â”œâ”€â”€ Ticket code generator                                                  â”‚
â”‚  â”œâ”€â”€ Customer stats update trigger                                          â”‚
â”‚  â””â”€â”€ RFM calculation function                                               â”‚
â”‚                                                                             â”‚
â”‚  Day 5: Migrate Existing Data                                               â”‚
â”‚  â”œâ”€â”€ Import customers from balance_customer_info                            â”‚
â”‚  â”œâ”€â”€ Create wallets with existing debt from balance_history                 â”‚
â”‚  â””â”€â”€ Migrate tickets from Firebase â†’ PostgreSQL                             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


7.2 Phase 2: Backend APIs (Tuáº§n 2)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 2: BACKEND APIs (Render.com)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Day 1-2: Customer APIs                                                     â”‚
â”‚  â”œâ”€â”€ GET /api/customer/:phone (360Â° view)                                   â”‚
â”‚  â”œâ”€â”€ POST /api/customer (create)                                            â”‚
â”‚  â”œâ”€â”€ PUT /api/customer/:phone (update)                                      â”‚
â”‚  â””â”€â”€ POST /api/customer/search                                              â”‚
â”‚                                                                             â”‚
â”‚  Day 3-4: Wallet APIs                                                       â”‚
â”‚  â”œâ”€â”€ GET /api/wallet/:phone                                                 â”‚
â”‚  â”œâ”€â”€ POST /api/wallet/:phone/deposit                                        â”‚
â”‚  â”œâ”€â”€ POST /api/wallet/:phone/withdraw                                       â”‚
â”‚  â”œâ”€â”€ POST /api/wallet/:phone/virtual-credit                                 â”‚
â”‚  â””â”€â”€ POST /api/wallet/batch-summary                                         â”‚
â”‚                                                                             â”‚
â”‚  Day 5: Ticket APIs                                                         â”‚
â”‚  â”œâ”€â”€ CRUD /api/ticket/*                                                     â”‚
â”‚  â”œâ”€â”€ POST /api/ticket/:id/action                                            â”‚
â”‚  â””â”€â”€ Webhook integration with wallet                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


7.3 Phase 3: Frontend - Customer Hub (Tuáº§n 3-4)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 3: FRONTEND - CUSTOMER HUB                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Week 3:                                                                    â”‚
â”‚  â”œâ”€â”€ Create customer-hub/ folder structure                                  â”‚
â”‚  â”œâ”€â”€ Build customer list page (index.html)                                  â”‚
â”‚  â”œâ”€â”€ Build customer detail page (customer-detail.html)                      â”‚
â”‚  â””â”€â”€ Implement wallet panel component                                       â”‚
â”‚                                                                             â”‚
â”‚  Week 4:                                                                    â”‚
â”‚  â”œâ”€â”€ Implement ticket panel component                                       â”‚
â”‚  â”œâ”€â”€ Implement activity timeline component                                  â”‚
â”‚  â”œâ”€â”€ Integrate with orders-report (wallet deduction)                        â”‚
â”‚  â””â”€â”€ Testing & bug fixes                                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


7.4 Phase 4: Integration & Cleanup (Tuáº§n 5)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 4: INTEGRATION & CLEANUP                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”œâ”€â”€ Update orders-report: Link SÄT â†’ Customer Hub                          â”‚
â”‚  â”œâ”€â”€ Update balance-history: Link SÄT â†’ Customer Hub                        â”‚
â”‚  â”œâ”€â”€ Deprecate issue-tracking (redirect to customer-hub)                    â”‚
â”‚  â”œâ”€â”€ âœ… DONE: customer-management folder deleted (replaced by customer-hub) â”‚
â”‚  â”œâ”€â”€ Update navigation menu                                                 â”‚
â”‚  â””â”€â”€ Documentation & training                                               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



8. ISSUE-TRACKING MIGRATION: Firebase â†’ PostgreSQL (Render.com)

8.1 Firebase Current Structure (Source)
```
Firebase Realtime Database
â”‚
â”œâ”€â”€ issue_tracking/
â”‚   â”œâ”€â”€ tickets/
â”‚   â”‚   â””â”€â”€ {pushId}/                    # Ticket object
â”‚   â”‚       â”œâ”€â”€ firebaseId              â†’ firebase_id (VARCHAR)
â”‚   â”‚       â”œâ”€â”€ orderId                 â†’ order_id (VARCHAR)
â”‚   â”‚       â”œâ”€â”€ trackingCode            â†’ tracking_code (VARCHAR)
â”‚   â”‚       â”œâ”€â”€ customer                â†’ customer_name (VARCHAR)
â”‚   â”‚       â”œâ”€â”€ phone                   â†’ phone (VARCHAR) â˜… FK to customers
â”‚   â”‚       â”œâ”€â”€ channel                 â†’ (lÆ°u vÃ o metadata JSONB)
â”‚   â”‚       â”œâ”€â”€ type                    â†’ type (VARCHAR)
â”‚   â”‚       â”œâ”€â”€ status                  â†’ status (VARCHAR)
â”‚   â”‚       â”œâ”€â”€ extendedStatus          â†’ (merge vÃ o status hoáº·c metadata)
â”‚   â”‚       â”œâ”€â”€ products: []            â†’ products (JSONB)
â”‚   â”‚       â”œâ”€â”€ money                   â†’ refund_amount (DECIMAL)
â”‚   â”‚       â”œâ”€â”€ originalCod             â†’ original_cod (DECIMAL)
â”‚   â”‚       â”œâ”€â”€ newCod                  â†’ new_cod (DECIMAL)
â”‚   â”‚       â”œâ”€â”€ codDifference           â†’ (computed: new_cod - original_cod)
â”‚   â”‚       â”œâ”€â”€ fixReason               â†’ fix_cod_reason (VARCHAR)
â”‚   â”‚       â”œâ”€â”€ virtualCredit: {}       â†’ TÃ¡ch ra virtual_credits table
â”‚   â”‚       â”œâ”€â”€ carrierRecoveryDeadline â†’ carrier_deadline (TIMESTAMP)
â”‚   â”‚       â”œâ”€â”€ note                    â†’ internal_note (TEXT)
â”‚   â”‚       â”œâ”€â”€ createdAt               â†’ created_at (TIMESTAMP)
â”‚   â”‚       â”œâ”€â”€ updatedAt               â†’ updated_at (TIMESTAMP)
â”‚   â”‚       â”œâ”€â”€ completedAt             â†’ completed_at (TIMESTAMP)
â”‚   â”‚       â”œâ”€â”€ createdBy               â†’ created_by (VARCHAR)
â”‚   â”‚       â””â”€â”€ actionHistory: []       â†’ action_history (JSONB)
â”‚   â”‚
â”‚   â””â”€â”€ reconciliation_batches/         # Lá»‹ch sá»­ Ä‘á»‘i soÃ¡t - KHÃ”NG migrate
â”‚
â”œâ”€â”€ customer_wallets/                   # Migrate â†’ customer_wallets table
â”‚   â””â”€â”€ {normalizedPhone}/
â”‚       â”œâ”€â”€ phone                       â†’ phone (VARCHAR)
â”‚       â”œâ”€â”€ customerName                â†’ (láº¥y tá»« customers.name)
â”‚       â”œâ”€â”€ balance                     â†’ balance (DECIMAL)
â”‚       â”œâ”€â”€ virtualBalance              â†’ virtual_balance (DECIMAL)
â”‚       â”œâ”€â”€ virtualCredits: []          â†’ TÃ¡ch ra virtual_credits table
â”‚       â””â”€â”€ createdAt/updatedAt         â†’ created_at/updated_at
â”‚
â””â”€â”€ wallet_transactions/                # Migrate â†’ wallet_transactions table
    â””â”€â”€ {transactionId}/
        â”œâ”€â”€ phone                       â†’ phone (VARCHAR)
        â”œâ”€â”€ type                        â†’ type (VARCHAR)
        â”œâ”€â”€ amount                      â†’ amount (DECIMAL)
        â”œâ”€â”€ balanceAfter                â†’ balance_after (DECIMAL)
        â”œâ”€â”€ source                      â†’ source (VARCHAR)
        â”œâ”€â”€ reference                   â†’ reference_id (VARCHAR)
        â”œâ”€â”€ note                        â†’ note (TEXT)
        â””â”€â”€ createdAt                   â†’ created_at (TIMESTAMP)
```


8.2 Field Mapping: Firebase â†’ PostgreSQL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TICKETS: Firebase â†’ customer_tickets                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Firebase Field           â”‚ PostgreSQL Column        â”‚ Transformation                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ firebaseId               â”‚ firebase_id              â”‚ Direct copy                       â”‚
â”‚ orderId                  â”‚ order_id                 â”‚ Direct copy                       â”‚
â”‚ trackingCode             â”‚ tracking_code            â”‚ Direct copy                       â”‚
â”‚ customer                 â”‚ customer_name            â”‚ Direct copy                       â”‚
â”‚ phone                    â”‚ phone                    â”‚ normalizePhone() â†’ "0xxxyyy"      â”‚
â”‚ channel                  â”‚ metadata.channel         â”‚ Move to JSONB metadata            â”‚
â”‚ type                     â”‚ type                     â”‚ Map: BOOM/FIX_COD/RETURN_*        â”‚
â”‚ status                   â”‚ status                   â”‚ Map (see below)                   â”‚
â”‚ extendedStatus           â”‚ metadata.extendedStatus  â”‚ Preserve for reference            â”‚
â”‚ products[]               â”‚ products                 â”‚ JSONB array (keep structure)      â”‚
â”‚ money                    â”‚ refund_amount            â”‚ Direct copy as DECIMAL            â”‚
â”‚ originalCod              â”‚ original_cod             â”‚ Direct copy                       â”‚
â”‚ newCod                   â”‚ new_cod                  â”‚ Direct copy                       â”‚
â”‚ fixReason                â”‚ fix_cod_reason           â”‚ Direct copy                       â”‚
â”‚ virtualCredit.amount     â”‚ virtual_credit_amount    â”‚ Copy to column                    â”‚
â”‚ virtualCredit.*          â”‚ virtual_credits table    â”‚ Create separate record            â”‚
â”‚ carrierRecoveryDeadline  â”‚ carrier_deadline         â”‚ Unix timestamp â†’ TIMESTAMP        â”‚
â”‚ note                     â”‚ internal_note            â”‚ Direct copy                       â”‚
â”‚ createdAt                â”‚ created_at               â”‚ Unix timestamp â†’ TIMESTAMP        â”‚
â”‚ updatedAt                â”‚ updated_at               â”‚ Unix timestamp â†’ TIMESTAMP        â”‚
â”‚ completedAt              â”‚ completed_at             â”‚ Unix timestamp â†’ TIMESTAMP        â”‚
â”‚ createdBy                â”‚ created_by               â”‚ Direct copy                       â”‚
â”‚ actionHistory[]          â”‚ action_history           â”‚ JSONB array (keep structure)      â”‚
â”‚ (auto-gen)               â”‚ ticket_code              â”‚ Generate: TV-YYYY-NNNNN           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


8.3 Status Mapping

Firebase Status â†’ PostgreSQL Status:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firebase status         â”‚ PostgreSQL status   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PENDING_GOODS           â”‚ PENDING_GOODS       â”‚
â”‚ PENDING_FINANCE         â”‚ PENDING_FINANCE     â”‚
â”‚ COMPLETED               â”‚ COMPLETED           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Firebase extendedStatus (lÆ°u vÃ o metadata.extendedStatus):
- NEW, PENDING_RETURN, RECEIVED_VERIFIED
- ACCOUNTING_DONE, VIRTUAL_CREDIT_ISSUED
- NEW_ORDER_PLACED, PENDING_RECOVERY
- COMPLETED, EXPIRED_NO_ACTION, LOGISTICS_ISSUE


8.4 Migration Script (Node.js)
```javascript
/**
 * Migration Script: Firebase issue-tracking â†’ PostgreSQL (Render.com)
 *
 * Cháº¡y tá»« local hoáº·c Render shell:
 * $ node scripts/migrate-issue-tracking.js
 */

const admin = require('firebase-admin');
const { Pool } = require('pg');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BATCH_SIZE = 100;  // Insert batch size
const DRY_RUN = false;   // Set true to test without writing to PostgreSQL

// Firebase Admin SDK init
const serviceAccount = require('./firebase-service-account.json');
admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
    databaseURL: 'https://your-project.firebaseio.com'
});

// PostgreSQL connection (Render.com)
const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: { rejectUnauthorized: false }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function normalizePhone(phone) {
    if (!phone) return null;
    let cleaned = phone.replace(/\D/g, '');
    if (cleaned.startsWith('84')) cleaned = '0' + cleaned.slice(2);
    if (cleaned.startsWith('+84')) cleaned = '0' + cleaned.slice(3);
    if (!cleaned.startsWith('0')) cleaned = '0' + cleaned;
    return cleaned.length >= 10 ? cleaned : null;
}

function timestampToDate(ts) {
    if (!ts) return null;
    if (typeof ts === 'number') {
        return new Date(ts > 1e12 ? ts : ts * 1000).toISOString();
    }
    return new Date(ts).toISOString();
}

function mapTicketStatus(status) {
    const mapping = {
        'PENDING_GOODS': 'PENDING_GOODS',
        'PENDING_FINANCE': 'PENDING_FINANCE',
        'COMPLETED': 'COMPLETED',
        // Fallback
        'NEW': 'PENDING',
        'PENDING_RETURN': 'PENDING_GOODS',
        'RECEIVED_VERIFIED': 'PENDING_FINANCE'
    };
    return mapping[status] || 'PENDING';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 1: MIGRATE CUSTOMERS (upsert tá»« tickets + wallets)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function migrateCustomers() {
    console.log('\nğŸ“¦ STEP 1: Migrate Customers...');

    // Collect unique phones from tickets and wallets
    const db = admin.database();
    const ticketsSnap = await db.ref('issue_tracking/tickets').once('value');
    const walletsSnap = await db.ref('customer_wallets').once('value');

    const customerMap = new Map(); // phone â†’ { name, ... }

    // From tickets
    ticketsSnap.forEach(child => {
        const ticket = child.val();
        const phone = normalizePhone(ticket.phone);
        if (phone && !customerMap.has(phone)) {
            customerMap.set(phone, {
                phone,
                name: ticket.customer || 'Unknown',
                firstSeen: ticket.createdAt
            });
        }
    });

    // From wallets (might have more info)
    walletsSnap.forEach(child => {
        const wallet = child.val();
        const phone = normalizePhone(wallet.phone);
        if (phone) {
            const existing = customerMap.get(phone) || {};
            customerMap.set(phone, {
                ...existing,
                phone,
                name: wallet.customerName || existing.name || 'Unknown',
                firstSeen: Math.min(existing.firstSeen || Infinity, wallet.createdAt || Infinity)
            });
        }
    });

    console.log(`   Found ${customerMap.size} unique customers`);

    if (DRY_RUN) {
        console.log('   [DRY RUN] Skipping database insert');
        return;
    }

    // Batch insert with upsert
    const customers = Array.from(customerMap.values());
    for (let i = 0; i < customers.length; i += BATCH_SIZE) {
        const batch = customers.slice(i, i + BATCH_SIZE);

        const values = batch.map((c, idx) => {
            const offset = idx * 3;
            return `($${offset+1}, $${offset+2}, $${offset+3})`;
        }).join(', ');

        const params = batch.flatMap(c => [
            c.phone,
            c.name,
            timestampToDate(c.firstSeen)
        ]);

        await pool.query(`
            INSERT INTO customers (phone, name, created_at)
            VALUES ${values}
            ON CONFLICT (phone) DO UPDATE SET
                name = COALESCE(EXCLUDED.name, customers.name),
                updated_at = NOW()
        `, params);

        console.log(`   Inserted batch ${Math.ceil((i+1)/BATCH_SIZE)}/${Math.ceil(customers.length/BATCH_SIZE)}`);
    }

    console.log(`   âœ… Migrated ${customerMap.size} customers`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 2: MIGRATE CUSTOMER WALLETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function migrateWallets() {
    console.log('\nğŸ’° STEP 2: Migrate Customer Wallets...');

    const db = admin.database();
    const snapshot = await db.ref('customer_wallets').once('value');

    let count = 0;
    const wallets = [];

    snapshot.forEach(child => {
        const wallet = child.val();
        const phone = normalizePhone(wallet.phone);
        if (!phone) return;

        wallets.push({
            phone,
            balance: wallet.balance || 0,
            virtualBalance: wallet.virtualBalance || 0,
            virtualCredits: wallet.virtualCredits || [],
            createdAt: wallet.createdAt,
            updatedAt: wallet.updatedAt
        });
        count++;
    });

    console.log(`   Found ${count} wallets`);

    if (DRY_RUN) {
        console.log('   [DRY RUN] Skipping database insert');
        return;
    }

    for (const wallet of wallets) {
        // Upsert wallet
        const result = await pool.query(`
            INSERT INTO customer_wallets (phone, balance, virtual_balance, created_at, updated_at)
            SELECT $1, $2, $3, $4, $5
            FROM customers WHERE phone = $1
            ON CONFLICT (phone) DO UPDATE SET
                balance = EXCLUDED.balance,
                virtual_balance = EXCLUDED.virtual_balance,
                updated_at = NOW()
            RETURNING id
        `, [
            wallet.phone,
            wallet.balance,
            wallet.virtualBalance,
            timestampToDate(wallet.createdAt),
            timestampToDate(wallet.updatedAt)
        ]);

        if (result.rows.length === 0) continue;
        const walletId = result.rows[0].id;

        // Migrate virtual credits
        for (const vc of wallet.virtualCredits || []) {
            if (vc.status !== 'ACTIVE') continue; // Only migrate active credits

            await pool.query(`
                INSERT INTO virtual_credits
                (phone, wallet_id, original_amount, remaining_amount,
                 issued_at, expires_at, status, source_type, source_id, note)
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
            `, [
                wallet.phone,
                walletId,
                vc.amount,
                vc.amount, // remaining = original for active
                timestampToDate(vc.issuedAt),
                timestampToDate(vc.expiresAt),
                vc.status,
                'RETURN_SHIPPER',
                vc.ticketId,
                'Migrated from Firebase'
            ]);
        }
    }

    console.log(`   âœ… Migrated ${count} wallets`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 3: MIGRATE TICKETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function migrateTickets() {
    console.log('\nğŸ“‹ STEP 3: Migrate Tickets...');

    const db = admin.database();
    const snapshot = await db.ref('issue_tracking/tickets').once('value');

    let count = 0;
    let skipped = 0;

    const tickets = [];
    snapshot.forEach(child => {
        const firebaseId = child.key;
        const ticket = child.val();
        const phone = normalizePhone(ticket.phone);

        if (!phone) {
            skipped++;
            return;
        }

        tickets.push({
            firebaseId,
            phone,
            customerName: ticket.customer,
            orderId: ticket.orderId,
            trackingCode: ticket.trackingCode,
            type: ticket.type,
            status: mapTicketStatus(ticket.status),
            products: ticket.products || [],
            originalCod: ticket.originalCod,
            newCod: ticket.newCod,
            refundAmount: ticket.money,
            fixCodReason: ticket.fixReason,
            virtualCredit: ticket.virtualCredit,
            carrierDeadline: ticket.carrierRecoveryDeadline,
            internalNote: ticket.note,
            actionHistory: ticket.actionHistory || [],
            metadata: {
                channel: ticket.channel,
                extendedStatus: ticket.extendedStatus,
                hasDefectiveItems: ticket.hasDefectiveItems,
                defectiveItemsNote: ticket.defectiveItemsNote
            },
            createdAt: ticket.createdAt,
            updatedAt: ticket.updatedAt,
            completedAt: ticket.completedAt,
            createdBy: ticket.createdBy
        });
        count++;
    });

    console.log(`   Found ${count} tickets (skipped ${skipped} invalid)`);

    if (DRY_RUN) {
        console.log('   [DRY RUN] Skipping database insert');
        return;
    }

    for (const ticket of tickets) {
        // Get customer_id
        const customerResult = await pool.query(
            'SELECT id FROM customers WHERE phone = $1',
            [ticket.phone]
        );
        const customerId = customerResult.rows[0]?.id;

        // Insert ticket
        const result = await pool.query(`
            INSERT INTO customer_tickets (
                firebase_id, phone, customer_id, customer_name,
                order_id, tracking_code, type, status,
                products, original_cod, new_cod, refund_amount,
                fix_cod_reason, virtual_credit_amount, carrier_deadline,
                internal_note, action_history,
                created_at, updated_at, completed_at, created_by
            )
            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21)
            RETURNING id, ticket_code
        `, [
            ticket.firebaseId,
            ticket.phone,
            customerId,
            ticket.customerName,
            ticket.orderId,
            ticket.trackingCode,
            ticket.type,
            ticket.status,
            JSON.stringify(ticket.products),
            ticket.originalCod,
            ticket.newCod,
            ticket.refundAmount,
            ticket.fixCodReason,
            ticket.virtualCredit?.amount,
            timestampToDate(ticket.carrierDeadline),
            ticket.internalNote,
            JSON.stringify(ticket.actionHistory),
            timestampToDate(ticket.createdAt),
            timestampToDate(ticket.updatedAt),
            timestampToDate(ticket.completedAt),
            ticket.createdBy
        ]);

        // Create virtual credit if applicable
        if (ticket.virtualCredit && ticket.virtualCredit.status === 'ACTIVE') {
            const ticketId = result.rows[0].id;

            // Get wallet_id
            const walletResult = await pool.query(
                'SELECT id FROM customer_wallets WHERE phone = $1',
                [ticket.phone]
            );
            const walletId = walletResult.rows[0]?.id;

            if (walletId) {
                const vcResult = await pool.query(`
                    INSERT INTO virtual_credits
                    (phone, wallet_id, original_amount, remaining_amount,
                     issued_at, expires_at, status, source_type, source_id, note)
                    VALUES ($1, $2, $3, $4, $5, $6, $7, 'RETURN_SHIPPER', $8, 'From ticket migration')
                    RETURNING id
                `, [
                    ticket.phone,
                    walletId,
                    ticket.virtualCredit.amount,
                    ticket.virtualCredit.amount,
                    timestampToDate(ticket.virtualCredit.issuedAt),
                    timestampToDate(ticket.virtualCredit.expiresAt),
                    ticket.virtualCredit.status,
                    ticket.firebaseId
                ]);

                // Link virtual_credit_id back to ticket
                await pool.query(
                    'UPDATE customer_tickets SET virtual_credit_id = $1 WHERE id = $2',
                    [vcResult.rows[0].id, ticketId]
                );
            }
        }

        // Log activity
        await pool.query(`
            INSERT INTO customer_activities
            (phone, customer_id, activity_type, title, description,
             reference_type, reference_id, icon, color, created_at)
            VALUES ($1, $2, 'TICKET_CREATED', $3, $4, 'ticket', $5, 'clipboard-list', 'blue', $6)
        `, [
            ticket.phone,
            customerId,
            `Sá»± vá»¥ ${ticket.type} - ${ticket.orderId}`,
            ticket.internalNote || '',
            result.rows[0].ticket_code,
            timestampToDate(ticket.createdAt)
        ]);
    }

    console.log(`   âœ… Migrated ${count} tickets`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 4: MIGRATE WALLET TRANSACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function migrateWalletTransactions() {
    console.log('\nğŸ’³ STEP 4: Migrate Wallet Transactions...');

    const db = admin.database();
    const snapshot = await db.ref('wallet_transactions').once('value');

    let count = 0;

    if (DRY_RUN) {
        snapshot.forEach(() => count++);
        console.log(`   [DRY RUN] Would migrate ${count} transactions`);
        return;
    }

    const transactions = [];
    snapshot.forEach(child => {
        const tx = child.val();
        const phone = normalizePhone(tx.phone);
        if (!phone) return;

        transactions.push({
            phone,
            type: tx.type,
            amount: tx.amount,
            balanceAfter: tx.balanceAfter,
            source: tx.source,
            referenceId: tx.reference,
            note: tx.note,
            createdAt: tx.createdAt,
            createdBy: tx.createdBy
        });
        count++;
    });

    for (const tx of transactions) {
        // Get wallet_id
        const walletResult = await pool.query(
            'SELECT id FROM customer_wallets WHERE phone = $1',
            [tx.phone]
        );
        const walletId = walletResult.rows[0]?.id;

        await pool.query(`
            INSERT INTO wallet_transactions
            (phone, wallet_id, type, amount, balance_after,
             source, reference_id, note, created_at, created_by)
            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
        `, [
            tx.phone,
            walletId,
            tx.type,
            tx.amount,
            tx.balanceAfter,
            tx.source,
            tx.referenceId,
            tx.note,
            timestampToDate(tx.createdAt),
            tx.createdBy
        ]);
    }

    console.log(`   âœ… Migrated ${count} transactions`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN EXECUTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function main() {
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘  ISSUE-TRACKING MIGRATION: Firebase â†’ PostgreSQL (Render.com)     â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`\nMode: ${DRY_RUN ? 'ğŸ” DRY RUN (no writes)' : 'ğŸš€ LIVE MIGRATION'}`);
    console.log(`Batch size: ${BATCH_SIZE}\n`);

    try {
        await migrateCustomers();
        await migrateWallets();
        await migrateTickets();
        await migrateWalletTransactions();

        console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('âœ… MIGRATION COMPLETED SUCCESSFULLY');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

        // Verification counts
        const counts = await pool.query(`
            SELECT
                (SELECT COUNT(*) FROM customers) as customers,
                (SELECT COUNT(*) FROM customer_wallets) as wallets,
                (SELECT COUNT(*) FROM customer_tickets) as tickets,
                (SELECT COUNT(*) FROM wallet_transactions) as transactions,
                (SELECT COUNT(*) FROM virtual_credits) as virtual_credits
        `);

        console.log('ğŸ“Š MIGRATION SUMMARY:');
        console.log(`   Customers:     ${counts.rows[0].customers}`);
        console.log(`   Wallets:       ${counts.rows[0].wallets}`);
        console.log(`   Tickets:       ${counts.rows[0].tickets}`);
        console.log(`   Transactions:  ${counts.rows[0].transactions}`);
        console.log(`   V.Credits:     ${counts.rows[0].virtual_credits}`);

    } catch (error) {
        console.error('\nâŒ MIGRATION FAILED:', error.message);
        console.error(error.stack);
        process.exit(1);
    } finally {
        await pool.end();
        admin.app().delete();
    }
}

main();
```


8.5 Migration Checklist
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MIGRATION CHECKLIST                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  PRE-MIGRATION:                                                                         â”‚
â”‚  â–¡ Backup Firebase data (export JSON)                                                   â”‚
â”‚  â–¡ Create PostgreSQL tables (run schema.sql)                                            â”‚
â”‚  â–¡ Set up Firebase Admin SDK credentials                                                â”‚
â”‚  â–¡ Configure DATABASE_URL environment variable                                          â”‚
â”‚  â–¡ Run migration script vá»›i DRY_RUN = true                                              â”‚
â”‚  â–¡ Review dry run output, check for errors                                              â”‚
â”‚                                                                                         â”‚
â”‚  MIGRATION:                                                                             â”‚
â”‚  â–¡ Set DRY_RUN = false                                                                  â”‚
â”‚  â–¡ Run migration script                                                                 â”‚
â”‚  â–¡ Verify counts match Firebase data                                                    â”‚
â”‚  â–¡ Spot check 10 random tickets                                                         â”‚
â”‚  â–¡ Verify wallet balances match                                                         â”‚
â”‚  â–¡ Test virtual credits expiry dates                                                    â”‚
â”‚                                                                                         â”‚
â”‚  POST-MIGRATION:                                                                        â”‚
â”‚  â–¡ Update frontend to use new API endpoints                                             â”‚
â”‚  â–¡ Deploy new API routes to Render                                                      â”‚
â”‚  â–¡ Test create/update/delete operations                                                 â”‚
â”‚  â–¡ Monitor for 24-48 hours                                                              â”‚
â”‚  â–¡ Archive Firebase data (keep for 30 days)                                             â”‚
â”‚  â–¡ Disable Firebase writes (read-only mode)                                             â”‚
â”‚  â–¡ After 30 days: Delete Firebase issue_tracking data                                   â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


8.6 Verification Queries
```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- VERIFICATION QUERIES - Run after migration
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- 1. Count comparison
SELECT
    'customers' as table_name, COUNT(*) as count FROM customers
UNION ALL
SELECT 'wallets', COUNT(*) FROM customer_wallets
UNION ALL
SELECT 'tickets', COUNT(*) FROM customer_tickets
UNION ALL
SELECT 'transactions', COUNT(*) FROM wallet_transactions
UNION ALL
SELECT 'virtual_credits', COUNT(*) FROM virtual_credits;

-- 2. Tickets by status
SELECT status, COUNT(*)
FROM customer_tickets
GROUP BY status
ORDER BY COUNT(*) DESC;

-- 3. Tickets by type
SELECT type, COUNT(*)
FROM customer_tickets
GROUP BY type
ORDER BY COUNT(*) DESC;

-- 4. Wallet balance totals
SELECT
    SUM(balance) as total_real_balance,
    SUM(virtual_balance) as total_virtual_balance,
    COUNT(*) as wallet_count
FROM customer_wallets;

-- 5. Active virtual credits
SELECT
    COUNT(*) as active_count,
    SUM(remaining_amount) as total_remaining
FROM virtual_credits
WHERE status = 'ACTIVE' AND expires_at > NOW();

-- 6. Sample ticket with all relations
SELECT
    t.ticket_code,
    t.type,
    t.status,
    t.order_id,
    c.name as customer_name,
    c.phone,
    w.balance,
    w.virtual_balance,
    vc.remaining_amount as virtual_credit_amount,
    vc.expires_at as vc_expires
FROM customer_tickets t
LEFT JOIN customers c ON t.phone = c.phone
LEFT JOIN customer_wallets w ON t.phone = w.phone
LEFT JOIN virtual_credits vc ON t.virtual_credit_id = vc.id
LIMIT 10;

-- 7. Check for orphan records
SELECT 'Tickets without customer' as issue, COUNT(*) as count
FROM customer_tickets t
LEFT JOIN customers c ON t.phone = c.phone
WHERE c.id IS NULL
UNION ALL
SELECT 'Wallets without customer', COUNT(*)
FROM customer_wallets w
LEFT JOIN customers c ON w.phone = c.phone
WHERE c.id IS NULL;
```


8.7 Rollback Plan
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ROLLBACK PLAN                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  Náº¾U MIGRATION THáº¤T Báº I:                                                                â”‚
â”‚                                                                                         â”‚
â”‚  1. STOP - KhÃ´ng tiáº¿p tá»¥c náº¿u cÃ³ lá»—i                                                   â”‚
â”‚                                                                                         â”‚
â”‚  2. ROLLBACK PostgreSQL:                                                                â”‚
â”‚     ```sql                                                                              â”‚
â”‚     -- XÃ³a data Ä‘Ã£ migrate (KHÃ”NG xÃ³a schema)                                          â”‚
â”‚     TRUNCATE customer_activities CASCADE;                                               â”‚
â”‚     TRUNCATE wallet_transactions CASCADE;                                               â”‚
â”‚     TRUNCATE virtual_credits CASCADE;                                                   â”‚
â”‚     TRUNCATE customer_tickets CASCADE;                                                  â”‚
â”‚     TRUNCATE customer_wallets CASCADE;                                                  â”‚
â”‚     TRUNCATE customers CASCADE;                                                         â”‚
â”‚     ```                                                                                 â”‚
â”‚                                                                                         â”‚
â”‚  3. RESTORE Firebase:                                                                   â”‚
â”‚     - Firebase data váº«n cÃ²n nguyÃªn (khÃ´ng bá»‹ xÃ³a trong migration)                      â”‚
â”‚     - Chá»‰ cáº§n revert frontend code vá» dÃ¹ng Firebase APIs                               â”‚
â”‚                                                                                         â”‚
â”‚  4. FIX & RETRY:                                                                        â”‚
â”‚     - Debug migration script                                                            â”‚
â”‚     - Run DRY_RUN again                                                                 â”‚
â”‚     - Re-run migration                                                                  â”‚
â”‚                                                                                         â”‚
â”‚  Náº¾U Cáº¦N PARTIAL ROLLBACK (chá»‰ rollback tickets):                                      â”‚
â”‚     ```sql                                                                              â”‚
â”‚     TRUNCATE customer_activities CASCADE;                                               â”‚
â”‚     DELETE FROM virtual_credits WHERE source_type = 'RETURN_SHIPPER';                  â”‚
â”‚     TRUNCATE customer_tickets CASCADE;                                                  â”‚
â”‚     ```                                                                                 â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


8.8 Post-Migration: Update Frontend
```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEFORE: Firebase API (issue-tracking/api-service.js)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// const db = firebase.database();
// const ticketsRef = db.ref('issue_tracking/tickets');
//
// async function getTickets() {
//     const snapshot = await ticketsRef.once('value');
//     return snapshot.val();
// }
//
// async function createTicket(data) {
//     const newRef = ticketsRef.push();
//     await newRef.set({ ...data, firebaseId: newRef.key });
//     return newRef.key;
// }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AFTER: PostgreSQL API (customer-hub/js/ticket-service.js)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const API_BASE = 'https://your-render-app.onrender.com/api';

// GET all tickets (with filters)
async function getTickets(filters = {}) {
    const params = new URLSearchParams(filters);
    const response = await fetch(`${API_BASE}/ticket?${params}`);
    return response.json();
}

// GET single ticket
async function getTicket(ticketCode) {
    const response = await fetch(`${API_BASE}/ticket/${ticketCode}`);
    return response.json();
}

// CREATE new ticket
async function createTicket(data) {
    const response = await fetch(`${API_BASE}/ticket`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    return response.json();
}

// UPDATE ticket
async function updateTicket(ticketCode, data) {
    const response = await fetch(`${API_BASE}/ticket/${ticketCode}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    return response.json();
}

// PERFORM action (receive_goods, settle, complete)
async function ticketAction(ticketCode, action, note) {
    const response = await fetch(`${API_BASE}/ticket/${ticketCode}/action`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, note })
    });
    return response.json();
}

export { getTickets, getTicket, createTicket, updateTicket, ticketAction };
```


---

9. TÃ“M Táº®T GIáº¢I PHÃP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              TÃ“M Táº®T GIáº¢I PHÃP                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  â“ Váº¤N Äá»€                          â”‚  âœ… GIáº¢I PHÃP                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Dá»¯ liá»‡u khÃ¡ch hÃ ng phÃ¢n tÃ¡n        â”‚  PostgreSQL lÃ m SSOT, SÄT lÃ  khÃ³a chÃ­nh          â”‚
â”‚  KhÃ´ng cÃ³ Customer 360Â° view        â”‚  Module customer-hub/ vá»›i full 360Â° view          â”‚
â”‚  CÃ´ng ná»£ áº£o chÆ°a cÃ³                 â”‚  Table virtual_credits vá»›i expiry & FIFO          â”‚
â”‚  Trá»« vÃ­ khi táº¡o PBH chÆ°a cÃ³         â”‚  API useWalletBalance() + UI integration          â”‚
â”‚  Sá»± vá»¥ náº±m riÃªng Firebase           â”‚  Migrate â†’ customer_tickets trong PostgreSQL      â”‚
â”‚  KhÃ´ng cÃ³ timeline hoáº¡t Ä‘á»™ng        â”‚  Table customer_activities + unified view         â”‚
â”‚  Thiáº¿u phÃ¢n loáº¡i khÃ¡ch              â”‚  RFM Scoring + Tags + Tiers                       â”‚
â”‚                                                                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                         â”‚
â”‚  ğŸ—ï¸ KIáº¾N TRÃšC CHÃNH:                                                                   â”‚
â”‚  â”œâ”€â”€ Storage: PostgreSQL (Render.com) - Single Source of Truth                         â”‚
â”‚  â”œâ”€â”€ Realtime: Firebase (chá»‰ cho notifications, khÃ´ng lÆ°u data)                        â”‚
â”‚  â”œâ”€â”€ External: TPOS API (read-only, orders & products)                                 â”‚
â”‚  â””â”€â”€ Gateway: Cloudflare Worker (proxy & auth)                                         â”‚
â”‚                                                                                         â”‚
â”‚  ğŸ“Š DATABASE TABLES:                                                                    â”‚
â”‚  â”œâ”€â”€ customers (master)                                                                â”‚
â”‚  â”œâ”€â”€ customer_wallets (1-1 vá»›i customers)                                              â”‚
â”‚  â”œâ”€â”€ wallet_transactions (log)                                                         â”‚
â”‚  â”œâ”€â”€ virtual_credits (cÃ´ng ná»£ áº£o)                                                      â”‚
â”‚  â”œâ”€â”€ customer_tickets (sá»± vá»¥)                                                          â”‚
â”‚  â”œâ”€â”€ customer_activities (timeline)                                                    â”‚
â”‚  â””â”€â”€ customer_notes (ghi chÃº)                                                          â”‚
â”‚                                                                                         â”‚
â”‚  ğŸ”‘ KEY FEATURES:                                                                       â”‚
â”‚  â”œâ”€â”€ Customer 360Â° View - Xem táº¥t cáº£ vá» 1 khÃ¡ch hÃ ng                                   â”‚
â”‚  â”œâ”€â”€ Unified Wallet - Sá»‘ dÆ° thá»±c + CÃ´ng ná»£ áº£o                                          â”‚
â”‚  â”œâ”€â”€ Smart Withdraw - FIFO virtual credits                                             â”‚
â”‚  â”œâ”€â”€ Activity Timeline - Lá»‹ch sá»­ tÆ°Æ¡ng tÃ¡c                                             â”‚
â”‚  â”œâ”€â”€ RFM Scoring - PhÃ¢n loáº¡i khÃ¡ch hÃ ng                                                â”‚
â”‚  â””â”€â”€ Extensible - Sáºµn sÃ ng cho Loyalty, Upsell, Analytics                              â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

