# TÃ i Liá»‡u Business Flow: Há»‡ Thá»‘ng Quáº£n LÃ½ Sá»± Vá»¥ Sau BÃ¡n HÃ ng

> **PhÃ¢n tÃ­ch bá»Ÿi:** Senior Technical Business Analyst  
> **NgÃ y táº¡o:** 2026-01-04  
> **Dá»±a trÃªn:** PhÃ¢n tÃ­ch code thá»±c táº¿ tá»« `issue-tracking/`

---

## 1. WORKFLOW SUMMARY (TÃ³m Táº¯t Quy TrÃ¬nh)

### 1.1 Má»¥c ÄÃ­ch Há»‡ Thá»‘ng
Há»‡ thá»‘ng quáº£n lÃ½ cÃ¡c sá»± vá»¥ phÃ¡t sinh sau khi bÃ¡n hÃ ng bao gá»“m:
- **Boom hÃ ng:** KhÃ¡ch khÃ´ng nháº­n Ä‘Æ¡n
- **HoÃ n hÃ ng:** KhÃ¡ch tráº£ láº¡i sáº£n pháº©m (qua shipper hoáº·c bÆ°u Ä‘iá»‡n)
- **Sá»­a COD:** Äiá»u chá»‰nh sá»‘ tiá»n thu há»™
- **CSKH:** CÃ¡c váº¥n Ä‘á» chÄƒm sÃ³c khÃ¡ch hÃ ng khÃ¡c

### 1.2 Architecture Overview

| File | Lines | MÃ´ táº£ |
|------|-------|-------|
| [index.html](file:///c:/Users/51103/github/n2store/n2store/index.html) | 240 | UI structure, modals, forms |
| [script.js](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js) | 846 | **Core logic**: 53 functions, event handling, rendering |
| [api-service.js](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/api-service.js) | 224 | Dual-mode storage (Firebase/LocalStorage) |
| [firebase-init.js](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/firebase-init.js) | 32 | Firebase configuration |
| [style.css](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/style.css) | 240 | Styling |

### 1.3 Data Storage

```
Mode FIREBASE: Firebase Realtime Database â†’ issue_tracking/tickets/{id}
Mode LOCAL: localStorage â†’ n2store_tickets_local
```

---

## 2. DATA MODEL (Cáº¥u TrÃºc Dá»¯ Liá»‡u)

### 2.1 Ticket Object

```javascript
{
  firebaseId: string,      // ID tá»« Firebase hoáº·c auto-generated
  orderId: string,         // MÃ£ Ä‘Æ¡n hÃ ng gá»‘c tá»« TPOS
  customer: string,        // TÃªn khÃ¡ch hÃ ng
  phone: string,           // Sá»‘ Ä‘iá»‡n thoáº¡i
  type: enum,              // Loáº¡i sá»± vá»¥ (xem 2.2)
  channel: string,         // KÃªnh bÃ¡n: "TPOS", "SPX", etc.
  status: enum,            // Tráº¡ng thÃ¡i (xem 2.3)
  products: Array,         // Danh sÃ¡ch sáº£n pháº©m liÃªn quan
  money: number,           // Sá»‘ tiá»n liÃªn quan
  note: string,            // Ghi chÃº ná»™i bá»™
  createdAt: timestamp,    // Thá»i Ä‘iá»ƒm táº¡o
  updatedAt: timestamp,    // Thá»i Ä‘iá»ƒm cáº­p nháº­t
  completedAt: timestamp   // Thá»i Ä‘iá»ƒm hoÃ n táº¥t (nullable)
}
```

### 2.2 Issue Types (Loáº¡i Sá»± Vá»¥)

| Code | TÃªn hiá»ƒn thá»‹ | MÃ´ táº£ | Fields hiá»ƒn thá»‹ |
|------|--------------|-------|-----------------|
| `FIX_COD` | Sá»­a COD (Shipper gá»i) | Äiá»u chá»‰nh tiá»n COD | COD má»›i, LÃ½ do |
| `RETURN_CLIENT` | KhÃ¡ch Gá»­i (Tá»‰nh/BÆ°u cá»¥c) | KhÃ¡ch gá»­i hÃ ng vá» qua bÆ°u Ä‘iá»‡n | Product checklist, MÃ£ VÄ khÃ¡ch gá»­i |
| `RETURN_SHIPPER` | Thu Vá» (Shipper/TP) | Shipper mang hÃ ng vá» | Product checklist, TÃªn shipper |
| `BOOM` | Boom HÃ ng | KhÃ¡ch khÃ´ng nháº­n | Product checklist |
| `OTHER` | CSKH / Váº¥n Ä‘á» khÃ¡c | TÆ° váº¥n, báº£o hÃ nh... | Chá»‰ ghi chÃº |

### 2.3 Status States (Tráº¡ng ThÃ¡i)

| Status | TÃªn hiá»ƒn thá»‹ | Tab | Actions kháº£ dá»¥ng |
|--------|--------------|-----|------------------|
| `PENDING_GOODS` | Chá» HÃ ng Vá» | Chá» HÃ ng Vá» | "ÄÃ£ Nháº­n HÃ ng" |
| `PENDING_FINANCE` | Chá» Äá»‘i SoÃ¡t | Chá» Äá»‘i SoÃ¡t Tiá»n | "ÄÃ£ Thanh ToÃ¡n" |
| `COMPLETED` | HoÃ n Táº¥t | HoÃ n Táº¥t | (none) |

### 2.4 Status Assignment Logic

```javascript
// Trong handleSubmitTicket()
if (type === 'FIX_COD')      â†’ status = 'PENDING_FINANCE'
if (type === 'OTHER')        â†’ status = 'COMPLETED'
if (type === 'BOOM/RETURN')  â†’ status = 'PENDING_GOODS'
```

---

## 3. DETAILED STEP-BY-STEP FLOWS

### 3.1 Flow A: Táº¡o Sá»± Vá»¥ Má»›i

| # | User Action | Code Logic | Database Effect | UI Feedback |
|---|-------------|------------|-----------------|-------------|
| 1 | Click "+ Táº¡o Sá»± Vá»¥ Má»›i" | [openModal(modalCreate)](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#826-827) | None | Modal má»Ÿ |
| 2 | Nháº­p SÄT/MÃ£ Ä‘Æ¡n + Click "TÃ¬m" | [handleSearchOrder()](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#399-444) â†’ `ApiService.searchOrders(query)` | None | Loading overlay |
| 3a | *TÃ¬m tháº¥y* | `selectedOrder = orders[0]` | None | Hiá»‡n order-result, issue-details-form |
| 3b | *KhÃ´ng tháº¥y* | `selectedOrder = null` | None | Alert "KhÃ´ng tÃ¬m tháº¥y" |
| 4 | Chá»n Loáº¡i Sá»± Vá»¥ | [handleIssueTypeChange()](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#445-498) | None | Toggle dynamic fields |
| 5 | Äiá»n thÃ´ng tin + Click "XÃ¡c Nháº­n Táº¡o" | [handleSubmitTicket()](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#508-566) | None | Validation check |
| 6a | *Validation pass* | `ApiService.createTicket(ticketData)` | **INSERT** ticket | Alert success, close modal |
| 6b | *Validation fail* | `return alert(...)` | None | Alert error message |

**Sequence: User â†’ script.js â†’ api-service.js â†’ Firebase/LocalStorage**

---

### 3.2 Flow B: Xá»­ LÃ½ Ticket (Nháº­n HÃ ng / Thanh ToÃ¡n)

| # | User Action | Code Logic | Database Effect | UI Feedback |
|---|-------------|------------|-----------------|-------------|
| 1 | Click "ÄÃ£ Nháº­n HÃ ng" / "ÄÃ£ Thanh ToÃ¡n" | [promptAction(id, 'RECEIVE'/'SETTLE')](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#570-587) | None | Modal confirm má»Ÿ |
| 2 | Click "XÃ¡c Nháº­n" trong modal | [handleConfirmAction()](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#588-608) | None | Loading overlay |
| 3 | Process complete | `ApiService.updateTicket(id, {status: 'COMPLETED'})` | **UPDATE** status | Modal Ä‘Ã³ng, table refresh |

---

### 3.3 Flow C: Dynamic Form Fields

```mermaid
flowchart TD
    A[User chá»n Loáº¡i Sá»± Vá»¥] --> B{Issue Type?}
    B -->|FIX_COD| C[Hiá»‡n: COD Má»›i + LÃ½ do]
    C --> D{LÃ½ do = REJECT_PARTIAL?}
    D -->|Yes| E[Hiá»‡n thÃªm: Product Checklist]
    D -->|No| F[Chá»‰ hiá»‡n COD fields]
    
    B -->|RETURN_CLIENT| G[Hiá»‡n: Product Checklist + MÃ£ VÄ khÃ¡ch gá»­i]
    B -->|RETURN_SHIPPER| H[Hiá»‡n: Product Checklist + TÃªn Shipper]
    B -->|BOOM| I[Hiá»‡n: Product Checklist only]
    B -->|OTHER| J[áº¨n táº¥t cáº£ dynamic fields]
```

---

## 4. VALIDATION RULES (Quy Táº¯c XÃ¡c Thá»±c)

### 4.1 Tá»« Code Thá»±c Táº¿

| Rule ID | Field | Validation | Code Location | Error Message |
|---------|-------|------------|---------------|---------------|
| V01 | Order Search Input | `!query` â†’ reject | [handleSearchOrder():399](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#399-444) | "Vui lÃ²ng nháº­p SÄT hoáº·c MÃ£ Ä‘Æ¡n" |
| V02 | Selected Order | `!selectedOrder` â†’ reject | [handleSubmitTicket():509](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#508-566) | "ChÆ°a chá»n Ä‘Æ¡n hÃ ng!" |
| V03 | Issue Type | `!type` â†’ reject | [handleSubmitTicket():512](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#508-566) | "Vui lÃ²ng chá»n loáº¡i váº¥n Ä‘á»" |
| V04 | Search Query | Empty string â†’ skip | `ApiService.searchOrders():26` | Returns `[]` |
| V05 | Pending Action | `!pendingActionTicketId` â†’ skip | [handleConfirmAction():589](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#588-608) | (silent return) |

### 4.2 Implicit Validations

- **COD Amount:** Parsed as `parseInt()`, defaults to `0` if invalid
- **Products:** Auto-selected all if checklist hidden
- **Money Calculation:** 
  - FIX_COD: `selectedOrder.cod - newCod`
  - BOOM/RETURN: [sum(products.price)](file:///c:/Users/51103/github/n2store/n2store/orders-report/tab1-orders.js#15372-15385)

---

## 5. ERROR HANDLING

### 5.1 Try-Catch Blocks

| Function | Error Type | Handling | User Message |
|----------|------------|----------|--------------|
| [handleSearchOrder()](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#399-444) | API Error | `catch â†’ console.error + alert` | "Lá»—i khi tÃ¬m kiáº¿m Ä‘Æ¡n hÃ ng: {error}" |
| [handleSubmitTicket()](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#508-566) | Create Error | `catch â†’ console.error + alert` | "Lá»—i khi táº¡o sá»± vá»¥: {error}" |
| [handleConfirmAction()](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#588-608) | Update Error | `catch â†’ console.error + alert` | "Lá»—i khi cáº­p nháº­t: {error}" |
| `ApiService.createTicket()` | Firebase Error | `throw error` | Propagated to caller |
| `ApiService.updateTicket()` | Firebase Error | `throw error` | Propagated to caller |

### 5.2 Error Codes (Firebase-side)

| Scenario | Possible Error | Recovery |
|----------|----------------|----------|
| No internet | `NETWORK_ERROR` | Retry manually |
| Permission denied | `PERMISSION_DENIED` | Check Firebase rules |
| Invalid data | `INVALID_INPUT` | Fix input and retry |

---

## 6. EDGE CASES (TrÆ°á»ng Há»£p Äáº·c Biá»‡t)

### 6.1 Tá»« PhÃ¢n TÃ­ch Code

| # | Edge Case | Code Behavior | Location |
|---|-----------|---------------|----------|
| E01 | Multiple orders found | **Chá»‰ láº¥y Ä‘Æ¡n Ä‘áº§u tiÃªn** `orders[0]` | [handleSearchOrder():408](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#399-444) |
| E02 | Order without products | Checklist rá»—ng, `money = 0` | [handleSubmitTicket():522](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#508-566) |
| E03 | Partial return vá»›i FIX_COD | Hiá»‡n thÃªm product checklist khi `reason = REJECT_PARTIAL` | [handleIssueTypeChange():479](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#445-498) |
| E04 | Firebase already initialized | Skip init, log warning | `firebase-init.js:19` |
| E05 | LocalStorage empty | Auto-seed mock data khi mode = LOCAL | `script.js:150-155` |
| E06 | Missing firebaseId | Fallback hiá»ƒn thá»‹ `#---` | [renderDashboard():740](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/script.js#696-775) |
| E07 | Null callback | Silent fail trong [_notifyLocalSubscribers](file:///c:/Users/51103/github/n2store/n2store/issue-tracking/api-service.js#217-223) | `api-service.js:219` |

### 6.2 Business Logic áº¨n

```javascript
// 1. Channel máº·c Ä‘á»‹nh lÃ  "TPOS"
channel: "TPOS"  // hardcoded trong handleSubmitTicket()

// 2. Sorting máº·c Ä‘á»‹nh: Newest first
tickets.sort((a, b) => b.createdAt - a.createdAt)

// 3. Auto-complete OTHER type
if (type === 'OTHER') status = 'COMPLETED'  // Skip waiting states
```

---

## 7. MERMAID FLOWCHART

### 7.1 Full Data Flow

```mermaid
flowchart TB
    subgraph Frontend["ğŸ–¥ï¸ Frontend (index.html + script.js)"]
        UI[User Interface]
        EH[Event Handlers]
        DOM[DOM Manipulation]
    end
    
    subgraph API["ğŸ“¡ API Layer (api-service.js)"]
        AS[ApiService]
        MS{Mode Switch}
        MOCK[Mock Orders]
    end
    
    subgraph Storage["ğŸ’¾ Storage"]
        FB[(Firebase RTDB)]
        LS[(LocalStorage)]
    end
    
    UI -->|Click/Input| EH
    EH -->|handleSearchOrder| AS
    EH -->|handleSubmitTicket| AS
    EH -->|handleConfirmAction| AS
    
    AS -->|searchOrders| MOCK
    AS --> MS
    
    MS -->|mode=FIREBASE| FB
    MS -->|mode=LOCAL| LS
    
    FB -->|Real-time listener| AS
    LS -->|_notifyLocalSubscribers| AS
    
    AS -->|tickets array| EH
    EH -->|renderDashboard| DOM
    DOM -->|Update| UI
```

### 7.2 Ticket State Machine

```mermaid
stateDiagram-v2
    [*] --> PENDING_GOODS: Boom/Return
    [*] --> PENDING_FINANCE: FIX_COD
    [*] --> COMPLETED: OTHER
    
    PENDING_GOODS --> COMPLETED: ÄÃ£ Nháº­n HÃ ng
    PENDING_FINANCE --> COMPLETED: ÄÃ£ Thanh ToÃ¡n
    
    COMPLETED --> [*]
```

---

## 8. TECHNICAL CONSTRAINTS

### 8.1 Dependencies

| Dependency | Version | Purpose |
|------------|---------|---------|
| Firebase SDK | 8.10.0 | Real-time database |
| Mermaid.js | Latest | Flow diagrams |
| Inter Font | Google Fonts | Typography |

### 8.2 Browser APIs Used

- `localStorage` - Mode persistence + local tickets
- `document.querySelectorAll` - DOM manipulation
- `setTimeout` - Async operations, delays

### 8.3 Future Enhancements (Tá»« Implementation Plan)

1. **LUá»’NG D:** CÃ´ng ná»£ áº£o cho RETURN_SHIPPER (15 ngÃ y expiry)
2. **Carrier Liability:** Deadline ÄVVC 10 ngÃ y
3. **HÃ ng Lá»—i Náº·ng:** Flow khÃ´ng láº¥y hÃ ng vá»

---

## 9. NOTES FOR COMPLEX LOGIC

### 9.1 Äoáº¡n Code Cáº§n Kiá»ƒm Tra

```javascript
// script.js:524-532 - Partial Return Logic
// Phá»©c táº¡p: Kiá»ƒm tra cáº£ hidden state vÃ  checked checkboxes
const returnGroup = document.querySelector('[data-type="RETURN"]');
if (!returnGroup.classList.contains('hidden')) {
    const checkedIds = Array.from(
        document.querySelectorAll('#product-checklist input:checked')
    ).map(cb => cb.value);
    selectedProducts = selectedOrder.products
        .filter(p => checkedIds.includes(String(p.id)));
}
```

**Váº¥n Ä‘á» tiá»m áº©n:** So sÃ¡nh `String(p.id)` vá»›i `cb.value` cÃ³ thá»ƒ fail náº¿u id lÃ  number mÃ  value lÃ  string.

### 9.2 Mode Switch Timing

```javascript
// script.js:147-155 - Auto Seed Race Condition
setTimeout(() => {
    const currentTickets = ApiService._getLocalTickets();
    if (!currentTickets || currentTickets.length === 0) {
        seedDatabase();
    }
}, 500);
```

**Risk:** Náº¿u network cháº­m vÃ  Firebase tráº£ vá» trÆ°á»›c 500ms, cÃ³ thá»ƒ duplicate tickets.

---

*Document nÃ y Ä‘Æ°á»£c táº¡o dá»±a trÃªn phÃ¢n tÃ­ch code thá»±c táº¿. Má»i thay Ä‘á»•i code cáº§n Ä‘Æ°á»£c cáº­p nháº­t vÃ o tÃ i liá»‡u nÃ y.*
