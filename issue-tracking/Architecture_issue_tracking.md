# TÃ€I LIá»†U Tá»”NG Há»¢P: Há»† THá»NG QUáº¢N LÃ Sá»° Vá»¤ SAU BÃN HÃ€NG

> **PhiÃªn báº£n:** 5.2 - Báº£n Thiáº¿t Káº¿ Thá»±c Thi Tuyá»‡t Äá»‘i
> **NgÃ y cáº­p nháº­t:** 2026-01-06
> **Má»¥c Ä‘Ã­ch:** TÃ i liá»‡u duy nháº¥t - AI Agent cÃ³ thá»ƒ code chÃ­nh xÃ¡c 100% khÃ´ng cáº§n há»i láº¡i

---

# ğŸ¤– HÆ¯á»šNG DáºªN CHO AI AGENT

## âš ï¸ LÆ¯U Ã QUAN TRá»ŒNG - Äá»ŒC TRÆ¯á»šC KHI LÃ€M Báº¤T Cá»¨ ÄIá»€U GÃŒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ QUY Táº®C Báº®T BUá»˜C CHO AI AGENT                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. TRÆ¯á»šC KHI Báº®T Äáº¦U CÃ”NG VIá»†C:                                           â”‚
â”‚     â†’ Äá»c toÃ n bá»™ file nÃ y Ä‘á»ƒ hiá»ƒu context                                 â”‚
â”‚     â†’ Xem pháº§n "TIáº¾N Äá»˜ THá»°C HIá»†N" Ä‘á»ƒ biáº¿t Ä‘Ã£ lÃ m gÃ¬                       â”‚
â”‚     â†’ Xem pháº§n "TASK TIáº¾P THEO" Ä‘á»ƒ biáº¿t cáº§n lÃ m gÃ¬                         â”‚
â”‚     â†’ Kiá»ƒm tra "PROJECT CONTEXT" Ä‘á»ƒ biáº¿t vá»‹ trÃ­ file, biáº¿n mÃ´i trÆ°á»ng      â”‚
â”‚                                                                             â”‚
â”‚  2. TRONG KHI LÃ€M VIá»†C:                                                    â”‚
â”‚     â†’ TuÃ¢n thá»§ cÃ¡c quy táº¯c trong "CODING STANDARDS"                        â”‚
â”‚     â†’ Tham chiáº¿u "DATA MODEL" khi lÃ m viá»‡c vá»›i database                    â”‚
â”‚     â†’ Kiá»ƒm tra "API REFERENCE" khi gá»i external services                   â”‚
â”‚     â†’ Sá»­ dá»¥ng "UI/UX STANDARDS" cho má»i thay Ä‘á»•i giao diá»‡n                 â”‚
â”‚     â†’ Äá»c "GLOBAL STATE" Ä‘á»ƒ biáº¿t cÃ¡ch truy xuáº¥t dá»¯ liá»‡u dÃ¹ng chung         â”‚
â”‚     â†’ TuÃ¢n thá»§ "SECURITY RULES" khi xá»­ lÃ½ dá»¯ liá»‡u nháº¡y cáº£m                 â”‚
â”‚     â†’ DÃ¹ng "ERROR MATRIX" Ä‘á»ƒ hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i chuáº©n                  â”‚
â”‚                                                                             â”‚
â”‚  3. SAU KHI HOÃ€N THÃ€NH:                                                    â”‚
â”‚     â†’ CHáº Y TEST theo "DEFINITION OF DONE" cá»§a task                         â”‚
â”‚     â†’ Cáº¬P NHáº¬T file nÃ y vá»›i nhá»¯ng gÃ¬ Ä‘Ã£ lÃ m                                â”‚
â”‚     â†’ ÄÃ¡nh dáº¥u checkbox á»Ÿ pháº§n TIáº¾N Äá»˜                                     â”‚
â”‚     â†’ Ghi rÃµ ngÃ y vÃ  mÃ´ táº£ thay Ä‘á»•i á»Ÿ CHANGELOG                            â”‚
â”‚                                                                             â”‚
â”‚  4. âš¡ QUY Táº®C Cáº¬P NHáº¬T NGÆ¯á»¢C (CRITICAL):                                  â”‚
â”‚     â†’ Náº¿u phÃ¡t hiá»‡n LOGIC Má»šI chÆ°a cÃ³ trong tÃ i liá»‡u â†’ Cáº¬P NHáº¬T NGAY      â”‚
â”‚     â†’ Náº¿u phÃ¡t hiá»‡n BIáº¾N/FIELD Má»šI chÆ°a cÃ³ trong Data Model â†’ THÃŠM VÃ€O    â”‚
â”‚     â†’ Náº¿u phÃ¡t hiá»‡n EDGE CASE má»›i â†’ Ghi vÃ o pháº§n Error Matrix              â”‚
â”‚     â†’ Náº¿u thay Ä‘á»•i FLOW nghiá»‡p vá»¥ â†’ Cáº­p nháº­t Mermaid diagram               â”‚
â”‚     â†’ KHÃ”NG ÄÆ¯á»¢C káº¿t thÃºc session mÃ  khÃ´ng cáº­p nháº­t tÃ i liá»‡u!              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

<a id="error-matrix"></a>
## ğŸš¨ ERROR MATRIX (Ma tráº­n Xá»­ lÃ½ Lá»—i)

> **Má»¥c Ä‘Ã­ch:** AI Agent PHáº¢I sá»­ dá»¥ng báº£ng nÃ y Ä‘á»ƒ hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i chuáº©n cho user.
> **Quy táº¯c:** KHÃ”NG tá»± nghÄ© thÃ´ng bÃ¡o lá»—i. Tra cá»©u báº£ng nÃ y trÆ°á»›c.

### Lá»—i API & Network

| Error Code | NguyÃªn nhÃ¢n | ThÃ´ng bÃ¡o cho User (Tiáº¿ng Viá»‡t) | Action |
|------------|-------------|--------------------------------|--------|
| `TPOS_TIMEOUT` | Worker hoáº·c TPOS API cháº­m/quÃ¡ táº£i | "Há»‡ thá»‘ng TPOS Ä‘ang báº­n, vui lÃ²ng thá»­ láº¡i sau 30 giÃ¢y." | Retry button |
| `TPOS_NOT_FOUND` | KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng | "KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng vá»›i thÃ´ng tin nÃ y. Vui lÃ²ng kiá»ƒm tra láº¡i SÄT hoáº·c mÃ£ váº­n Ä‘Æ¡n." | None |
| `TPOS_ERROR` | TPOS tráº£ vá» lá»—i | "Lá»—i tá»« há»‡ thá»‘ng TPOS: {error_message}" | Contact admin |
| `NETWORK_ERROR` | Máº¥t káº¿t ná»‘i internet | "KhÃ´ng cÃ³ káº¿t ná»‘i máº¡ng. Vui lÃ²ng kiá»ƒm tra internet vÃ  thá»­ láº¡i." | Retry button |
| `WORKER_ERROR` | Cloudflare Worker lá»—i | "MÃ¡y chá»§ proxy Ä‘ang gáº·p sá»± cá»‘. Vui lÃ²ng thá»­ láº¡i sau." | Retry button |

### Lá»—i Firebase & Authentication

| Error Code | NguyÃªn nhÃ¢n | ThÃ´ng bÃ¡o cho User | Action |
|------------|-------------|-------------------|--------|
| `PERMISSION_DENIED` | User khÃ´ng cÃ³ quyá»n | "Báº¡n khÃ´ng cÃ³ quyá»n thá»±c hiá»‡n thao tÃ¡c nÃ y. LiÃªn há»‡ Admin náº¿u cáº§n." | None |
| `PERMISSION_ACCOUNTANT` | CSKH cá»‘ hoÃ n táº¥t Ä‘Æ¡n | "Chá»‰ Káº¿ toÃ¡n má»›i Ä‘Æ°á»£c phÃ©p Ä‘Ã¡nh dáº¥u 'ÄÃ£ thanh toÃ¡n'." | None |
| `PERMISSION_WAREHOUSE` | KhÃ´ng pháº£i Kho | "Chá»‰ nhÃ¢n viÃªn Kho má»›i Ä‘Æ°á»£c xÃ¡c nháº­n 'ÄÃ£ nháº­n hÃ ng'." | None |
| `AUTH_EXPIRED` | Session háº¿t háº¡n | "PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i." | Redirect login |
| `AUTH_REQUIRED` | ChÆ°a Ä‘Äƒng nháº­p | "Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c." | Redirect login |
| `FIREBASE_OFFLINE` | Firebase máº¥t káº¿t ná»‘i | "Äang máº¥t káº¿t ná»‘i vá»›i server. Dá»¯ liá»‡u sáº½ tá»± Ä‘á»“ng bá»™ khi cÃ³ máº¡ng." | Auto-retry |

### Lá»—i Wallet (VÃ­ khÃ¡ch hÃ ng)

| Error Code | NguyÃªn nhÃ¢n | ThÃ´ng bÃ¡o cho User | Action |
|------------|-------------|-------------------|--------|
| `INSUFFICIENT_BALANCE` | Sá»‘ dÆ° khÃ´ng Ä‘á»§ | "Sá»‘ dÆ° vÃ­ khÃ¡ch hÃ ng ({current_balance}) khÃ´ng Ä‘á»§ Ä‘á»ƒ thanh toÃ¡n Ä‘Æ¡n nÃ y ({required_amount})." | Show wallet |
| `WALLET_NOT_FOUND` | KhÃ¡ch chÆ°a cÃ³ vÃ­ | "KhÃ¡ch hÃ ng chÆ°a cÃ³ vÃ­. Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng táº¡o vÃ­ má»›i." | Auto-create |
| `INVALID_AMOUNT` | Sá»‘ tiá»n khÃ´ng há»£p lá»‡ | "Sá»‘ tiá»n khÃ´ng há»£p lá»‡. Vui lÃ²ng nháº­p sá»‘ dÆ°Æ¡ng." | Focus input |
| `AMOUNT_EXCEED_LIMIT` | VÆ°á»£t giá»›i háº¡n | "Sá»‘ tiá»n vÆ°á»£t quÃ¡ giá»›i háº¡n cho phÃ©p (100 triá»‡u Ä‘á»“ng)." | None |
| `VIRTUAL_CREDIT_EXPIRED` | CÃ´ng ná»£ áº£o háº¿t háº¡n | "CÃ´ng ná»£ áº£o cá»§a khÃ¡ch Ä‘Ã£ háº¿t háº¡n vÃ o ngÃ y {expiry_date}." | None |

### Lá»—i Validation (Nháº­p liá»‡u)

| Error Code | NguyÃªn nhÃ¢n | ThÃ´ng bÃ¡o cho User | Action |
|------------|-------------|-------------------|--------|
| `INVALID_PHONE` | SÄT sai Ä‘á»‹nh dáº¡ng | "Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡. Pháº£i báº¯t Ä‘áº§u báº±ng 0 vÃ  cÃ³ 10-11 sá»‘." | Focus input |
| `INVALID_ORDER_ID` | Thiáº¿u mÃ£ Ä‘Æ¡n | "Vui lÃ²ng chá»n Ä‘Æ¡n hÃ ng trÆ°á»›c khi táº¡o sá»± vá»¥." | Highlight field |
| `INVALID_TICKET_TYPE` | ChÆ°a chá»n loáº¡i | "Vui lÃ²ng chá»n loáº¡i sá»± vá»¥." | Focus select |
| `INVALID_COD` | COD khÃ´ng há»£p lá»‡ | "COD má»›i pháº£i lÃ  sá»‘ khÃ´ng Ã¢m vÃ  nhá» hÆ¡n COD gá»‘c." | Focus input |
| `NO_PRODUCTS_SELECTED` | ChÆ°a chá»n SP | "Vui lÃ²ng chá»n Ã­t nháº¥t 1 sáº£n pháº©m." | Highlight checklist |

### Lá»—i Business Logic

| Error Code | NguyÃªn nhÃ¢n | ThÃ´ng bÃ¡o cho User | Action |
|------------|-------------|-------------------|--------|
| `TICKET_ALREADY_COMPLETED` | ÄÆ¡n Ä‘Ã£ hoÃ n táº¥t | "Sá»± vá»¥ nÃ y Ä‘Ã£ Ä‘Æ°á»£c hoÃ n táº¥t trÆ°á»›c Ä‘Ã³." | None |
| `DUPLICATE_TICKET` | TrÃ¹ng ticket | "ÄÃ£ cÃ³ sá»± vá»¥ cho Ä‘Æ¡n hÃ ng nÃ y. Báº¡n cÃ³ muá»‘n xem sá»± vá»¥ hiá»‡n cÃ³?" | Link to ticket |
| `ORDER_ALREADY_CANCELLED` | ÄÆ¡n Ä‘Ã£ há»§y | "ÄÆ¡n hÃ ng nÃ y Ä‘Ã£ bá»‹ há»§y trÃªn TPOS, khÃ´ng thá»ƒ táº¡o sá»± vá»¥." | None |
| `CARRIER_DEADLINE_EXCEEDED` | ÄVVC quÃ¡ háº¡n | "âš ï¸ ÄVVC Ä‘Ã£ quÃ¡ háº¡n 10 ngÃ y! Cáº§n liÃªn há»‡ claim bá»“i thÆ°á»ng." | Flag ticket |

### HÃ m xá»­ lÃ½ lá»—i chuáº©n

```javascript
// error-handler.js - AI Agent PHáº¢I sá»­ dá»¥ng pattern nÃ y

const ErrorMessages = {
  // API & Network
  'TPOS_TIMEOUT': 'Há»‡ thá»‘ng TPOS Ä‘ang báº­n, vui lÃ²ng thá»­ láº¡i sau 30 giÃ¢y.',
  'TPOS_NOT_FOUND': 'KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng vá»›i thÃ´ng tin nÃ y.',
  'NETWORK_ERROR': 'KhÃ´ng cÃ³ káº¿t ná»‘i máº¡ng. Vui lÃ²ng kiá»ƒm tra internet.',

  // Firebase
  'PERMISSION_DENIED': 'Báº¡n khÃ´ng cÃ³ quyá»n thá»±c hiá»‡n thao tÃ¡c nÃ y.',
  'PERMISSION_ACCOUNTANT': 'Chá»‰ Káº¿ toÃ¡n má»›i Ä‘Æ°á»£c phÃ©p Ä‘Ã¡nh dáº¥u "ÄÃ£ thanh toÃ¡n".',
  'AUTH_EXPIRED': 'PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.',

  // Wallet
  'INSUFFICIENT_BALANCE': 'Sá»‘ dÆ° vÃ­ khÃ¡ch hÃ ng khÃ´ng Ä‘á»§ Ä‘á»ƒ thanh toÃ¡n.',
  'WALLET_NOT_FOUND': 'KhÃ¡ch hÃ ng chÆ°a cÃ³ vÃ­.',

  // Validation
  'INVALID_PHONE': 'Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡ (pháº£i 10-11 sá»‘, báº¯t Ä‘áº§u báº±ng 0).',
  'INVALID_ORDER_ID': 'Vui lÃ²ng chá»n Ä‘Æ¡n hÃ ng trÆ°á»›c.',
  'INVALID_TICKET_TYPE': 'Vui lÃ²ng chá»n loáº¡i sá»± vá»¥.',

  // Default
  'UNKNOWN': 'ÄÃ£ xáº£y ra lá»—i. Vui lÃ²ng thá»­ láº¡i hoáº·c liÃªn há»‡ Admin.'
};

/**
 * Hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i chuáº©n
 * @param {string} errorCode - MÃ£ lá»—i tá»« ErrorMessages
 * @param {object} params - Tham sá»‘ Ä‘á»™ng (optional)
 */
function showError(errorCode, params = {}) {
  let message = ErrorMessages[errorCode] || ErrorMessages['UNKNOWN'];

  // Replace dynamic params
  Object.keys(params).forEach(key => {
    message = message.replace(`{${key}}`, params[key]);
  });

  // Determine toast type
  const isWarning = errorCode.includes('DEADLINE') || errorCode.includes('EXPIRED');
  const toastType = isWarning ? 'warning' : 'error';

  showToast(toastType, message);
  console.error(`[Error] ${errorCode}:`, message, params);
}

// Sá»­ dá»¥ng:
// showError('INSUFFICIENT_BALANCE', { current_balance: '200,000Ä‘', required_amount: '350,000Ä‘' });
// showError('TPOS_TIMEOUT');
// showError('PERMISSION_ACCOUNTANT');
```

---

<a id="project-context"></a>
## ğŸ“ PROJECT CONTEXT (MÃ´i trÆ°á»ng vÃ  Ngá»¯ cáº£nh)

### Vá»‹ trÃ­ Files trong Project

```
n2store/                              # ROOT PROJECT
â”‚
â”œâ”€â”€ orders-report/                    # Module BÃ¡o cÃ¡o Ä‘Æ¡n hÃ ng
â”‚   â”œâ”€â”€ api-config.js                 # âš ï¸ SHARED: Server URLs, API endpoints
â”‚   â”œâ”€â”€ api-handler.js                # âš ï¸ SHARED: Address search, utilities
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ issue-tracking/                   # ğŸ“ MODULE HIá»†N Táº I
â”‚   â”œâ”€â”€ index.html                    # Entry point - UI chÃ­nh
â”‚   â”œâ”€â”€ script.js                     # Core logic (import api-service.js)
â”‚   â”œâ”€â”€ api-service.js                # Firebase CRUD + TPOS API calls
â”‚   â”œâ”€â”€ wallet-service.js             # [Táº O Má»šI] Module vÃ­ khÃ¡ch hÃ ng
â”‚   â”œâ”€â”€ cron-jobs.js                  # [Táº O Má»šI] Auto-expire jobs
â”‚   â”œâ”€â”€ firebase-init.js              # Firebase configuration
â”‚   â”œâ”€â”€ style.css                     # All styles
â”‚   â”œâ”€â”€ images/                       # Guide images
â”‚   â””â”€â”€ MASTER_DOCUMENTATION.md       # ğŸ“„ FILE NÃ€Y
â”‚
â””â”€â”€ shared/                           # Shared resources
    â””â”€â”€ firebase-config.js            # Firebase keys (náº¿u cÃ³)
```

### Import Dependencies (Thá»© tá»± quan trá»ng trong index.html)

```html
<!-- 1. Firebase SDK - PHáº¢I load trÆ°á»›c -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<!-- 2. Firebase Init - Sau SDK -->
<script src="firebase-init.js"></script>

<!-- 3. Shared Modules tá»« orders-report -->
<script src="../orders-report/api-config.js"></script>

<!-- 4. Local Modules - Theo thá»© tá»± dependency -->
<script src="api-service.js"></script>
<script src="wallet-service.js"></script>      <!-- [Má»šI] Sau api-service -->
<script src="cron-jobs.js"></script>            <!-- [Má»šI] Sau wallet-service -->
<script src="script.js"></script>               <!-- Cuá»‘i cÃ¹ng -->
```

### Biáº¿n MÃ´i TrÆ°á»ng (Environment Variables)

```javascript
// firebase-init.js - Firebase Configuration
// âš ï¸ KHÃ”NG COMMIT giÃ¡ trá»‹ tháº­t lÃªn Git public repo
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",                    // Placeholder
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// api-config.js - API URLs
const API_CONFIG = {
  // Cloudflare Worker Proxy URL
  WORKER_URL: "https://your-worker.your-subdomain.workers.dev",

  // TPOS OData Base URL (qua proxy)
  TPOS_ODATA_BASE: "/api/odata",

  // SePay Webhook (Cloud Function)
  SEPAY_WEBHOOK_URL: "https://us-central1-YOUR_PROJECT.cloudfunctions.net/handleSepayWebhook"
};
```

### ThÆ° viá»‡n bÃªn thá»© 3 - PhiÃªn báº£n CHÃNH XÃC

| Library | Version | Import | LÆ°u Ã½ |
|---------|---------|--------|-------|
| **Firebase SDK** | `8.10.0` | CDN script tags | âš ï¸ DÃ¹ng v8 (compat), KHÃ”NG dÃ¹ng v9 modular |
| **Mermaid.js** | `latest` | CDN | Cho flow diagrams |
| **Inter Font** | Google Fonts | CSS @import | Typography |

```javascript
// âš ï¸ QUAN TRá»ŒNG: Firebase v8 syntax (KHÃ”NG dÃ¹ng v9 modular)

// âœ… ÄÃšNG - Firebase v8 (chÃºng ta Ä‘ang dÃ¹ng)
const db = firebase.database();
const ref = db.ref('issue_tracking/tickets');
ref.push().set(data);
ref.on('value', snapshot => { ... });

// âŒ SAI - Firebase v9 modular (KHÃ”NG dÃ¹ng)
import { getDatabase, ref, push } from 'firebase/database';
```

---

<a id="ui-standards"></a>
## ğŸ¨ UI/UX STANDARDS (TiÃªu chuáº©n Giao diá»‡n)

### Design Tokens (Há»‡ mÃ u)

```css
:root {
  /* === PRIMARY COLORS === */
  --color-primary: #2563eb;           /* Blue - Actions chÃ­nh */
  --color-primary-hover: #1d4ed8;     /* Blue darker */
  --color-primary-light: #dbeafe;     /* Blue light background */

  /* === SEMANTIC COLORS === */
  --color-success: #10b981;           /* Green - HoÃ n táº¥t, thÃ nh cÃ´ng */
  --color-success-light: #d1fae5;
  --color-warning: #f59e0b;           /* Amber - Cáº£nh bÃ¡o, chá» xá»­ lÃ½ */
  --color-warning-light: #fef3c7;
  --color-danger: #ef4444;            /* Red - Lá»—i, quÃ¡ háº¡n */
  --color-danger-light: #fee2e2;
  --color-info: #3b82f6;              /* Blue - ThÃ´ng tin */
  --color-info-light: #dbeafe;

  /* === NEUTRAL COLORS === */
  --color-text-primary: #1f2937;      /* Gray 800 */
  --color-text-secondary: #6b7280;    /* Gray 500 */
  --color-text-muted: #9ca3af;        /* Gray 400 */
  --color-border: #e5e7eb;            /* Gray 200 */
  --color-background: #f9fafb;        /* Gray 50 */
  --color-surface: #ffffff;           /* White */

  /* === EXTENDED STATUS COLORS === */
  --status-new: #3b82f6;              /* Blue */
  --status-pending: #f59e0b;          /* Amber */
  --status-virtual-credit: #8b5cf6;   /* Purple */
  --status-new-order: #06b6d4;        /* Cyan */
  --status-completed: #10b981;        /* Green */
  --status-expired: #ef4444;          /* Red */
  --status-logistics-issue: #ef4444;  /* Red */

  /* === SPACING === */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;

  /* === BORDER RADIUS === */
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  /* === SHADOWS === */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
}
```

### Layout Blueprint

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TOPBAR (height: 60px)                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Logo    â”‚  Tabs (Chá» HÃ ng | Chá» ÄS | HoÃ n Táº¥t)  â”‚  User â”‚ Notifications â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  STATS BAR (height: 80px)                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ Chá» HÃ ng â”‚ Chá» ÄS   â”‚ HoÃ n Táº¥t â”‚ CÃ´ng Ná»£  â”‚                              â”‚
â”‚  â”‚   12     â”‚    5     â”‚   234    â”‚  3 âš ï¸    â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TOOLBAR (height: 50px)                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [+ Táº¡o Sá»± Vá»¥]  â”‚  ğŸ” Search...  â”‚  Filter â–¼  â”‚  Sort â–¼  â”‚  [Export]    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MAIN CONTENT (flex: 1)                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  TABLE / TICKET LIST                                                    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚ #ID â”‚ ÄÆ¡n hÃ ng â”‚ KhÃ¡ch  â”‚ Loáº¡i     â”‚ Sá»‘ tiá»nâ”‚ Tráº¡ng   â”‚ Actions   â”‚ â”‚â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚â”‚
â”‚  â”‚  â”‚ 001 â”‚ NJD/...  â”‚ Nguyá»…n â”‚ BOOM     â”‚ 350k   â”‚ ğŸŸ¡ Chá»  â”‚ [Nháº­n]    â”‚ â”‚â”‚
â”‚  â”‚  â”‚ 002 â”‚ NJD/...  â”‚ Tráº§n   â”‚ FIX_COD  â”‚ 100k   â”‚ ğŸŸ¢ Xong â”‚           â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Library

| Component | Class | MÃ´ táº£ | Example |
|-----------|-------|-------|---------|
| **Button Primary** | `.btn-primary` | NÃºt hÃ nh Ä‘á»™ng chÃ­nh | `<button class="btn-primary">XÃ¡c Nháº­n</button>` |
| **Button Secondary** | `.btn-secondary` | NÃºt phá»¥ | `<button class="btn-secondary">Há»§y</button>` |
| **Button Danger** | `.btn-danger` | NÃºt xÃ³a/há»§y nguy hiá»ƒm | `<button class="btn-danger">XÃ³a</button>` |
| **Input Text** | `.form-input` | Input nháº­p liá»‡u | `<input class="form-input" required>` |
| **Select** | `.form-select` | Dropdown chá»n | `<select class="form-select">` |
| **Badge** | `.badge-{type}` | Status badge | `<span class="badge-success">HoÃ n táº¥t</span>` |
| **Card** | `.card` | Container card | `<div class="card">...</div>` |
| **Modal** | `.modal-overlay` | Modal container | Xem chi tiáº¿t bÃªn dÆ°á»›i |
| **Table** | `.data-table` | Báº£ng dá»¯ liá»‡u | Xem chi tiáº¿t bÃªn dÆ°á»›i |
| **Toast** | `.toast-{type}` | Notification | `showToast('success', 'ÄÃ£ lÆ°u')` |

### Button Styles

```css
/* Buttons */
.btn-primary {
  background: var(--color-primary);
  color: white;
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--radius-md);
  border: none;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.2s;
}
.btn-primary:hover { background: var(--color-primary-hover); }
.btn-primary:disabled { background: var(--color-text-muted); cursor: not-allowed; }

.btn-secondary {
  background: var(--color-surface);
  color: var(--color-text-primary);
  border: 1px solid var(--color-border);
  /* ...same padding, radius... */
}

.btn-danger {
  background: var(--color-danger);
  color: white;
  /* ...same padding, radius... */
}
```

### Input Styles

```css
/* Inputs */
.form-input, .form-select {
  width: 100%;
  padding: var(--spacing-sm) var(--spacing-md);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  font-size: 14px;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.form-input:focus, .form-select:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px var(--color-primary-light);
}
.form-input::placeholder { color: var(--color-text-muted); }

/* Input vá»›i label */
.form-group {
  margin-bottom: var(--spacing-md);
}
.form-label {
  display: block;
  margin-bottom: var(--spacing-xs);
  font-weight: 500;
  color: var(--color-text-primary);
}
.form-label.required::after {
  content: " *";
  color: var(--color-danger);
}
```

### Modal Structure

```html
<!-- Modal Template -->
<div class="modal-overlay" id="modalCreate" style="display: none;">
  <div class="modal-container">
    <div class="modal-header">
      <h2 class="modal-title">Táº¡o Sá»± Vá»¥ Má»›i</h2>
      <button class="modal-close" onclick="closeModal(modalCreate)">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Content here -->
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModal(modalCreate)">Há»§y</button>
      <button class="btn-primary" onclick="handleSubmit()">XÃ¡c Nháº­n</button>
    </div>
  </div>
</div>
```

```css
/* Modal Styles */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.modal-container {
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.modal-header {
  padding: var(--spacing-md) var(--spacing-lg);
  border-bottom: 1px solid var(--color-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.modal-body {
  padding: var(--spacing-lg);
  overflow-y: auto;
  flex: 1;
}
.modal-footer {
  padding: var(--spacing-md) var(--spacing-lg);
  border-top: 1px solid var(--color-border);
  display: flex;
  justify-content: flex-end;
  gap: var(--spacing-sm);
}
```

### Table Styles

```css
/* Data Table */
.data-table {
  width: 100%;
  border-collapse: collapse;
}
.data-table th {
  text-align: left;
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--color-background);
  border-bottom: 2px solid var(--color-border);
  font-weight: 600;
  color: var(--color-text-secondary);
  font-size: 12px;
  text-transform: uppercase;
}
.data-table td {
  padding: var(--spacing-sm) var(--spacing-md);
  border-bottom: 1px solid var(--color-border);
  vertical-align: middle;
}
.data-table tr:hover {
  background: var(--color-background);
}

/* Empty State */
.table-empty {
  text-align: center;
  padding: var(--spacing-xl);
  color: var(--color-text-muted);
}
.table-empty-icon {
  font-size: 48px;
  margin-bottom: var(--spacing-md);
}
```

### Badge Styles

```css
/* Status Badges */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: var(--radius-full);
  font-size: 12px;
  font-weight: 500;
}

.badge-success { background: var(--color-success-light); color: #047857; }
.badge-warning { background: var(--color-warning-light); color: #b45309; }
.badge-danger { background: var(--color-danger-light); color: #b91c1c; }
.badge-info { background: var(--color-info-light); color: #1d4ed8; }
.badge-purple { background: #ede9fe; color: #6d28d9; }
.badge-cyan { background: #cffafe; color: #0e7490; }

/* Status-specific badges */
.badge-status-new { background: #dbeafe; color: #1d4ed8; }
.badge-status-pending { background: #fef3c7; color: #b45309; }
.badge-status-virtual-credit { background: #ede9fe; color: #6d28d9; }
.badge-status-completed { background: #d1fae5; color: #047857; }
.badge-status-expired { background: #fee2e2; color: #b91c1c; }
```

---

<a id="global-state"></a>
## ğŸ—ƒï¸ GLOBAL STATE (Quáº£n lÃ½ Tráº¡ng thÃ¡i)

### AppState Object

```javascript
// Äá»‹nh nghÄ©a á»Ÿ Ä‘áº§u script.js
// AI AGENT: LuÃ´n truy xuáº¥t dá»¯ liá»‡u qua AppState, KHÃ”NG táº¡o biáº¿n global má»›i

window.AppState = {
  // === CURRENT USER ===
  currentUser: null,                    // Firebase Auth user object
  userRole: null,                       // 'ADMIN' | 'ACCOUNTANT' | 'WAREHOUSE' | 'CSKH'

  // === TICKETS DATA ===
  allTickets: [],                       // Táº¥t cáº£ tickets tá»« Firebase
  filteredTickets: [],                  // Tickets sau khi filter
  currentTicket: null,                  // Ticket Ä‘ang xem/edit

  // === ORDER DATA (tá»« TPOS search) ===
  searchResults: [],                    // Káº¿t quáº£ tÃ¬m kiáº¿m Ä‘Æ¡n hÃ ng
  selectedOrder: null,                  // ÄÆ¡n hÃ ng Ä‘Æ°á»£c chá»n Ä‘á»ƒ táº¡o ticket

  // === WALLET DATA ===
  currentWallet: null,                  // VÃ­ cá»§a KH Ä‘ang xem
  walletTransactions: [],               // Lá»‹ch sá»­ giao dá»‹ch vÃ­

  // === UI STATE ===
  currentTab: 'PENDING_GOODS',          // Tab Ä‘ang active
  isLoading: false,                     // Loading state
  activeModal: null,                    // Modal Ä‘ang má»Ÿ

  // === FILTERS ===
  filters: {
    status: null,
    extendedStatus: null,
    type: null,
    dateFrom: null,
    dateTo: null,
    searchQuery: ''
  },

  // === PENDING ACTIONS ===
  pendingActionTicketId: null,          // ID ticket Ä‘ang chá» confirm action
  pendingActionType: null               // 'RECEIVE' | 'SETTLE' | 'DELETE'
};
```

### CÃ¡ch sá»­ dá»¥ng AppState

```javascript
// âœ… ÄÃšNG - Äá»c tá»« AppState
function renderDashboard() {
  const tickets = AppState.filteredTickets;
  // render...
}

// âœ… ÄÃšNG - Cáº­p nháº­t AppState
function onTicketsLoaded(ticketsArray) {
  AppState.allTickets = ticketsArray;
  AppState.filteredTickets = applyFilters(ticketsArray);
  renderDashboard();
}

// âœ… ÄÃšNG - Truy xuáº¥t user info
function checkPermission(action) {
  if (action === 'SETTLE' && AppState.userRole !== 'ACCOUNTANT') {
    alert('Chá»‰ Káº¿ toÃ¡n má»›i Ä‘Æ°á»£c thá»±c hiá»‡n thao tÃ¡c nÃ y');
    return false;
  }
  return true;
}

// âŒ SAI - Táº¡o biáº¿n global má»›i
let tickets = [];  // KHÃ”NG LÃ€M THáº¾ NÃ€Y
var currentOrder; // KHÃ”NG LÃ€M THáº¾ NÃ€Y
```

### State Update Pattern

```javascript
// Pattern chuáº©n Ä‘á»ƒ update state vÃ  re-render

function updateFilters(newFilters) {
  // 1. Update state
  AppState.filters = { ...AppState.filters, ...newFilters };

  // 2. Apply filters
  AppState.filteredTickets = applyFilters(AppState.allTickets);

  // 3. Re-render
  renderDashboard();
  updateStats();
}

function applyFilters(tickets) {
  const { status, type, searchQuery, dateFrom, dateTo } = AppState.filters;

  return tickets.filter(ticket => {
    if (status && ticket.status !== status) return false;
    if (type && ticket.type !== type) return false;
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      if (!ticket.customer.toLowerCase().includes(query) &&
          !ticket.phone.includes(query) &&
          !ticket.orderId.toLowerCase().includes(query)) {
        return false;
      }
    }
    if (dateFrom && ticket.createdAt < dateFrom) return false;
    if (dateTo && ticket.createdAt > dateTo) return false;
    return true;
  });
}
```

---

<a id="security"></a>
## ğŸ”’ SECURITY & DATA INTEGRITY (Báº£o máº­t vÃ  ToÃ n váº¹n Dá»¯ liá»‡u)

### Firebase Security Rules

```json
{
  "rules": {
    // === TICKETS ===
    "issue_tracking": {
      "tickets": {
        ".read": "auth != null",
        ".write": "auth != null",
        "$ticketId": {
          ".validate": "newData.hasChildren(['orderId', 'type', 'status', 'createdAt'])",

          // Chá»‰ ACCOUNTANT má»›i Ä‘Æ°á»£c chuyá»ƒn sang COMPLETED
          "status": {
            ".validate": "newData.val() != 'COMPLETED' || root.child('users').child(auth.uid).child('role').val() == 'ACCOUNTANT' || root.child('users').child(auth.uid).child('role').val() == 'ADMIN'"
          }
        }
      }
    },

    // === WALLETS - Chá»‰ ACCOUNTANT/ADMIN má»›i Ä‘Æ°á»£c write ===
    "customer_wallets": {
      ".read": "auth != null",
      ".write": "auth != null && (root.child('users').child(auth.uid).child('role').val() == 'ACCOUNTANT' || root.child('users').child(auth.uid).child('role').val() == 'ADMIN')",

      "$phone": {
        // Balance khÃ´ng Ä‘Æ°á»£c Ã¢m
        "balance": {
          ".validate": "newData.val() >= 0"
        },
        "virtualBalance": {
          ".validate": "newData.val() >= 0"
        }
      }
    },

    // === TRANSACTIONS - Chá»‰ Ä‘Æ°á»£c táº¡o má»›i, khÃ´ng Ä‘Æ°á»£c sá»­a/xÃ³a ===
    "wallet_transactions": {
      ".read": "auth != null",
      "$transactionId": {
        ".write": "auth != null && !data.exists()",  // Chá»‰ create, khÃ´ng update/delete
        ".validate": "newData.hasChildren(['phone', 'type', 'amount', 'balanceAfter', 'createdAt'])"
      }
    },

    // === SEPAY WEBHOOKS - Chá»‰ Cloud Functions ===
    "sepay_webhooks": {
      ".read": "auth != null && root.child('users').child(auth.uid).child('role').val() == 'ADMIN'",
      ".write": false  // Chá»‰ Cloud Functions (vá»›i admin SDK) má»›i write Ä‘Æ°á»£c
    }
  }
}
```

### Role-Based Access Control

| Role | Tickets | Wallet | Transactions | SePay Logs |
|------|---------|--------|--------------|------------|
| `ADMIN` | Full access | Full access | Read + Create | Read |
| `ACCOUNTANT` | Read + Update status | Full access | Read + Create | No |
| `WAREHOUSE` | Read + Update (nháº­n hÃ ng) | Read only | No | No |
| `CSKH` | Read + Create | Read only | No | No |

```javascript
// Kiá»ƒm tra quyá»n trÆ°á»›c má»i action
function checkPermission(action, resource) {
  const role = AppState.userRole;

  const permissions = {
    'ADMIN': ['*'],
    'ACCOUNTANT': ['ticket.read', 'ticket.update', 'ticket.complete', 'wallet.read', 'wallet.write'],
    'WAREHOUSE': ['ticket.read', 'ticket.receive', 'wallet.read'],
    'CSKH': ['ticket.read', 'ticket.create', 'wallet.read']
  };

  const userPerms = permissions[role] || [];
  if (userPerms.includes('*')) return true;
  return userPerms.includes(`${resource}.${action}`);
}
```

### Atomic Transactions (Wallet Operations)

```javascript
// âš ï¸ Báº®T BUá»˜C: DÃ¹ng Firebase Transaction cho má»i thao tÃ¡c vá»›i sá»‘ dÆ°

// âœ… ÄÃšNG - Sá»­ dá»¥ng transaction
async function deposit(phone, amount, source, reference, note) {
  const walletRef = db.ref(`customer_wallets/${phone}`);

  return walletRef.transaction((currentData) => {
    if (currentData === null) {
      // Wallet chÆ°a tá»“n táº¡i
      return {
        phone,
        balance: amount,
        virtualBalance: 0,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      };
    }

    // Cá»™ng tiá»n
    currentData.balance = (currentData.balance || 0) + amount;
    currentData.updatedAt = firebase.database.ServerValue.TIMESTAMP;
    return currentData;
  }).then((result) => {
    if (result.committed) {
      // Log transaction
      logWalletTransaction(phone, 'DEPOSIT', amount, result.snapshot.val().balance, source, reference, note);
      return result.snapshot.val();
    }
    throw new Error('Transaction failed');
  });
}

// âŒ SAI - Read rá»“i Write riÃªng láº» (cÃ³ thá»ƒ gÃ¢y sai sá»‘ dÆ°)
async function depositWrong(phone, amount) {
  const wallet = await getWallet(phone);
  wallet.balance += amount;  // Race condition!
  await walletRef.update(wallet);
}
```

### Input Validation

```javascript
// Validate táº¥t cáº£ input trÆ°á»›c khi xá»­ lÃ½

const Validators = {
  phone: (value) => {
    const cleaned = value.replace(/[^0-9]/g, '');
    if (!/^0\d{9,10}$/.test(cleaned)) {
      throw new Error('Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡ (pháº£i báº¯t Ä‘áº§u báº±ng 0, 10-11 sá»‘)');
    }
    return cleaned;
  },

  amount: (value) => {
    const num = parseInt(value, 10);
    if (isNaN(num) || num < 0) {
      throw new Error('Sá»‘ tiá»n khÃ´ng há»£p lá»‡');
    }
    if (num > 100000000) { // 100 triá»‡u
      throw new Error('Sá»‘ tiá»n vÆ°á»£t quÃ¡ giá»›i háº¡n');
    }
    return num;
  },

  orderId: (value) => {
    if (!value || value.trim().length === 0) {
      throw new Error('MÃ£ Ä‘Æ¡n hÃ ng khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng');
    }
    return value.trim();
  },

  ticketType: (value) => {
    const validTypes = ['FIX_COD', 'RETURN_CLIENT', 'RETURN_SHIPPER', 'BOOM', 'OTHER'];
    if (!validTypes.includes(value)) {
      throw new Error('Loáº¡i sá»± vá»¥ khÃ´ng há»£p lá»‡');
    }
    return value;
  }
};

// Sá»­ dá»¥ng
try {
  const phone = Validators.phone(formData.phone);
  const amount = Validators.amount(formData.amount);
  // proceed...
} catch (error) {
  showToast('error', error.message);
  return;
}
```

---

<a id="formulas"></a>
## ğŸ“ CÃ”NG THá»¨C TÃ€I CHÃNH

### CÃ´ng thá»©c tÃ­nh tiá»n hoÃ n ÄVVC

$$
\text{RefundAmount} = \text{OriginalCOD} - \text{ActualCOD}
$$

Trong Ä‘Ã³:
- `OriginalCOD`: COD ban Ä‘áº§u khi táº¡o Ä‘Æ¡n
- `ActualCOD`: COD thá»±c táº¿ thu Ä‘Æ°á»£c (cÃ³ thá»ƒ = 0 náº¿u boom)

**VÃ­ dá»¥:**
```
ÄÆ¡n hÃ ng COD gá»‘c: 500,000Ä‘
KhÃ¡ch chá»‰ tráº£: 350,000Ä‘ (nháº­n 1 pháº§n)
â†’ Sá»‘ tiá»n shop pháº£i hoÃ n ÄVVC = 500,000 - 350,000 = 150,000Ä‘
```

### CÃ´ng thá»©c tÃ­nh sá»‘ dÆ° VÃ­

$$
\text{TotalBalance} = \text{RealBalance} + \sum_{i=1}^{n} \text{VirtualCredit}_i \quad \text{where } status = \text{'ACTIVE'}
$$

$$
\text{AvailableBalance} = \text{RealBalance} + \sum_{i=1}^{n} \text{VirtualCredit}_i \quad \text{where } status = \text{'ACTIVE'} \land expiresAt > \text{now}
$$

### CÃ´ng thá»©c tÃ­nh COD Ä‘Æ¡n má»›i (khi dÃ¹ng VÃ­)

$$
\text{NewOrderCOD} = \max(0, \text{OrderTotal} - \text{WalletDeduction})
$$

$$
\text{WalletDeduction} = \min(\text{AvailableBalance}, \text{OrderTotal})
$$

**Logic trá»« VÃ­ (thá»© tá»± Æ°u tiÃªn):**
1. Trá»« CÃ´ng ná»£ áº¢O trÆ°á»›c (FIFO - sáº¯p háº¿t háº¡n trÆ°á»›c)
2. Sau Ä‘Ã³ má»›i trá»« CÃ´ng ná»£ THá»°C

```javascript
function calculateWalletDeduction(orderTotal, wallet) {
  let remaining = orderTotal;
  let virtualUsed = 0;
  let realUsed = 0;

  // 1. Trá»« cÃ´ng ná»£ áº¢O (FIFO by expiresAt)
  const activeCredits = wallet.virtualCredits
    .filter(c => c.status === 'ACTIVE' && c.expiresAt > Date.now())
    .sort((a, b) => a.expiresAt - b.expiresAt);

  for (const credit of activeCredits) {
    if (remaining <= 0) break;
    const use = Math.min(credit.amount, remaining);
    virtualUsed += use;
    remaining -= use;
  }

  // 2. Trá»« cÃ´ng ná»£ THá»°C
  if (remaining > 0 && wallet.balance > 0) {
    realUsed = Math.min(wallet.balance, remaining);
    remaining -= realUsed;
  }

  return {
    virtualUsed,
    realUsed,
    totalDeducted: virtualUsed + realUsed,
    newCOD: remaining  // Sá»‘ tiá»n KH cáº§n tráº£ thÃªm
  };
}
```

---

## ğŸ“‘ Má»¤C Lá»¤C - THá»¨ Tá»° Æ¯U TIÃŠN Äá»ŒC

> **AI Agent:** Äá»c theo thá»© tá»± tá»« trÃªn xuá»‘ng. CÃ¡c pháº§n Ä‘áº§u lÃ  QUAN TRá»ŒNG NHáº¤T.

| # | Pháº§n | Ná»™i dung | Æ¯u tiÃªn | Jump to |
|---|------|----------|---------|---------|
| **0** | ğŸ¤– **AI RULES** | Quy táº¯c báº¯t buá»™c, cáº­p nháº­t ngÆ°á»£c | ğŸ”´ CRITICAL | â¬†ï¸ Äang á»Ÿ Ä‘Ã¢y |
| **1** | ğŸš¨ **Error Matrix** | ThÃ´ng bÃ¡o lá»—i chuáº©n | ğŸ”´ CRITICAL | [Jump](#error-matrix) |
| **2** | ğŸ“ **Project Context** | Vá»‹ trÃ­ files, env vars, imports | ğŸ”´ CRITICAL | [Jump](#project-context) |
| **3** | ğŸ—ƒï¸ **Global State** | AppState object, patterns | ğŸ”´ CRITICAL | [Jump](#global-state) |
| **4** | ğŸ”’ **Security** | Firebase rules, RBAC, atomic | ğŸŸ  HIGH | [Jump](#security) |
| **5** | ğŸ“ **Formulas** | CÃ´ng thá»©c tÃ i chÃ­nh | ğŸŸ  HIGH | [Jump](#formulas) |
| **6** | ğŸ¨ **UI/UX Standards** | Design tokens, components | ğŸŸ¡ MEDIUM | [Jump](#ui-standards) |
| | | | | |
| **A** | ğŸ“‹ **Nghiá»‡p vá»¥** | Flow cÃ´ng viá»‡c (cho BA/User) | ğŸŸ¢ Reference | [Jump](#phan-a) |
| **B** | ğŸ”§ **Ká»¹ thuáº­t** | Data model, API | ğŸŸ¢ Reference | [Jump](#phan-b) |
| **C** | ğŸ“… **Káº¿ hoáº¡ch** | Tasks, DoD, Roadmap | ğŸŸ¢ Reference | [Jump](#phan-c) |
| **D** | ğŸ“Š **Tiáº¿n Ä‘á»™** | Changelog, Standards | ğŸŸ¢ Reference | [Jump](#phan-d) |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“– CÃCH Äá»ŒC TÃ€I LIá»†U NÃ€Y (cho AI Agent)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Láº¦N Äáº¦U VÃ€O SESSION:                                                      â”‚
â”‚  1. Äá»c pháº§n 0-3 (Rules, Error, Context, State) â†’ ~5 phÃºt                 â”‚
â”‚  2. Xem pháº§n D (Tiáº¿n Ä‘á»™) â†’ Biáº¿t task tiáº¿p theo                             â”‚
â”‚  3. Äá»c chi tiáº¿t task trong pháº§n C                                         â”‚
â”‚                                                                             â”‚
â”‚  KHI CODE:                                                                  â”‚
â”‚  â†’ Tra cá»©u pháº§n 4-6 khi cáº§n (Security, Formulas, UI)                       â”‚
â”‚  â†’ Tra cá»©u pháº§n A-B khi cáº§n hiá»ƒu nghiá»‡p vá»¥/data model                      â”‚
â”‚                                                                             â”‚
â”‚  KHI Gáº¶P Lá»–I:                                                              â”‚
â”‚  â†’ Tra pháº§n 1 (Error Matrix) â†’ Copy message chuáº©n                          â”‚
â”‚                                                                             â”‚
â”‚  TRÆ¯á»šC KHI Káº¾T THÃšC:                                                       â”‚
â”‚  â†’ Cáº­p nháº­t pháº§n D (Changelog, Tiáº¿n Ä‘á»™)                                    â”‚
â”‚  â†’ Náº¿u cÃ³ logic má»›i â†’ Cáº­p nháº­t pháº§n B (Data Model)                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

<a id="phan-a"></a>
# PHáº¦N A: NGHIá»†P Vá»¤ Xá»¬ LÃ

## A1. Tá»•ng quan há»‡ thá»‘ng

### A1.1 Má»¥c Ä‘Ã­ch
Há»‡ thá»‘ng quáº£n lÃ½ cÃ¡c sá»± vá»¥ phÃ¡t sinh **sau khi bÃ¡n hÃ ng**, giÃºp:
- Theo dÃµi hÃ ng hoÃ n vá» (boom, tráº£ hÃ ng)
- Quáº£n lÃ½ Ä‘iá»u chá»‰nh COD
- Quáº£n lÃ½ cÃ´ng ná»£ khÃ¡ch hÃ ng
- Äá»‘i soÃ¡t tÃ i chÃ­nh vá»›i ÄVVC

### A1.2 CÃ¡c loáº¡i sá»± vá»¥

| Loáº¡i | MÃ£ | MÃ´ táº£ ngáº¯n | VÃ­ dá»¥ |
|------|-----|------------|-------|
| **Boom hÃ ng** | `BOOM` | KhÃ¡ch khÃ´ng nháº­n Ä‘Æ¡n | KH tá»« chá»‘i nháº­n, khÃ´ng liÃªn láº¡c Ä‘Æ°á»£c |
| **Sá»­a COD** | `FIX_COD` | Shipper gá»i xin Ä‘iá»u chá»‰nh tiá»n thu | KH Ä‘Ã²i giáº£m giÃ¡, chá»‰ nháº­n 1 pháº§n |
| **KhÃ¡ch gá»­i** | `RETURN_CLIENT` | KhÃ¡ch tá»± gá»­i hÃ ng vá» qua bÆ°u Ä‘iá»‡n | KH Ä‘á»•i size, tráº£ hÃ ng lá»—i |
| **Thu vá»** | `RETURN_SHIPPER` | Shipper thu hÃ ng cÅ© khi giao Ä‘Æ¡n má»›i | Äá»•i hÃ ng táº­n nÆ¡i |
| **CSKH khÃ¡c** | `OTHER` | TÆ° váº¥n, báº£o hÃ nh, khiáº¿u náº¡i | Há»i thÃ´ng tin sáº£n pháº©m |

### A1.3 NguyÃªn táº¯c tÃ i chÃ­nh cá»‘t lÃµi

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’° ÄVVC á»¨NG TRÆ¯á»šC 100% COD CHO SHOP NGAY KHI Láº¤Y HÃ€NG                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Khi ÄVVC Ä‘Ã£ láº¥y hÃ ng = Shop Ä‘Ã£ nháº­n Ä‘á»§ tiá»n COD                           â”‚
â”‚                                                                             â”‚
â”‚  â†’ Náº¿u COD giáº£m (sá»­a COD, boom...) = Shop Ná»¢ láº¡i ÄVVC sá»‘ chÃªnh lá»‡ch        â”‚
â”‚  â†’ Káº¿ toÃ¡n PHáº¢I chuyá»ƒn khoáº£n tráº£ láº¡i ÄVVC sau khi Ä‘á»‘i soÃ¡t                 â”‚
â”‚                                                                             â”‚
â”‚  CÃ´ng thá»©c: Sá»‘ tiá»n ná»£ ÄVVC = COD ban Ä‘áº§u - COD thá»±c thu                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### A1.4 Ma tráº­n Luá»“ng Tráº¡ng thÃ¡i (Status Flow Matrix)

> **âš ï¸ QUAN TRá»ŒNG CHO AI AGENT:** ÄÃ¢y lÃ  báº£ng tham chiáº¿u chÃ­nh Ä‘á»ƒ xÃ¡c Ä‘á»‹nh tráº¡ng thÃ¡i ban Ä‘áº§u vÃ  luá»“ng xá»­ lÃ½ cho má»—i loáº¡i ticket.

#### Tá»•ng quan 4 luá»“ng xá»­ lÃ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š 4 LUá»’NG CHUYá»‚N TRáº NG THÃI                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ğŸ”µ LUá»’NG 1: Chá» HÃ ng â†’ Chá» Äá»‘i SoÃ¡t â†’ HoÃ n Táº¥t                            â”‚
â”‚     (CÃ³ hÃ ng hoÃ n VÃ€ cÃ³ tiá»n chÃªnh lá»‡ch cáº§n tráº£ ÄVVC)                      â”‚
â”‚                                                                             â”‚
â”‚  ğŸŸ¢ LUá»’NG 2: Chá» HÃ ng â†’ HoÃ n Táº¥t                                           â”‚
â”‚     (CÃ³ hÃ ng hoÃ n NHÆ¯NG khÃ´ng cáº§n tráº£ tiá»n ÄVVC)                           â”‚
â”‚                                                                             â”‚
â”‚  ğŸŸ¡ LUá»’NG 3: Chá» Äá»‘i SoÃ¡t â†’ HoÃ n Táº¥t                                       â”‚
â”‚     (KhÃ´ng cÃ³ hÃ ng hoÃ n, chá»‰ cáº§n Ä‘á»‘i soÃ¡t tiá»n)                            â”‚
â”‚                                                                             â”‚
â”‚  âš« LUá»’NG 4: HoÃ n Táº¥t Ngay                                                  â”‚
â”‚     (Xá»­ lÃ½ á»Ÿ Tab "Táº¥t cáº£", báº¥m hoÃ n táº¥t thá»§ cÃ´ng)                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Báº£ng chi tiáº¿t theo Loáº¡i Sá»± Vá»¥

| Loáº¡i sá»± vá»¥ | LÃ½ do (fixCodReason) | Status ban Ä‘áº§u | Luá»“ng | Sá»‘ tiá»n | Ghi chÃº |
|------------|---------------------|----------------|-------|---------|---------|
| `BOOM` | - | `PENDING_GOODS` | ğŸ”µ 1 | = ToÃ n bá»™ COD | Táº¥t cáº£ SP hoÃ n vá» |
| `FIX_COD` | `REJECT_PARTIAL` | `PENDING_GOODS` | ğŸ”µ 1 | = GiÃ¡ SP bá»‹ tá»« chá»‘i | Má»™t pháº§n SP hoÃ n vá» |
| `FIX_COD` | `RETURN_OLD_ORDER` | `PENDING_GOODS` | ğŸ”µ 1 | = GiÃ¡ SP Ä‘Æ¡n cÅ© tráº£ | Tráº£ hÃ ng Ä‘Æ¡n cÅ© khi giao Ä‘Æ¡n má»›i |
| `FIX_COD` | `WRONG_SHIP` | `PENDING_FINANCE` | ğŸŸ¡ 3 | = COD gá»‘c - COD má»›i | KhÃ´ng láº¥y hÃ ng thá»«a vá» |
| `FIX_COD` | `CUSTOMER_DEBT` | `PENDING_FINANCE` | ğŸŸ¡ 3 | = COD gá»‘c - COD má»›i | Trá»« ná»£ cÅ© cá»§a khÃ¡ch |
| `FIX_COD` | `DISCOUNT` | `PENDING_FINANCE` | ğŸŸ¡ 3 | = COD gá»‘c - COD má»›i | Shipper deal giáº£m giÃ¡ |
| `RETURN_CLIENT` | - | `PENDING_GOODS` | ğŸŸ¢ 2 | = GiÃ¡ SP hoÃ n | Cá»™ng vÃ o vÃ­ KH |
| `RETURN_SHIPPER` | - | `PENDING_GOODS` | ğŸŸ¢ 2 | = GiÃ¡ SP hoÃ n | CÃ´ng ná»£ áº£o |
| `OTHER` | - | `PENDING_GOODS` | âš« 4 | = 0 | âš ï¸ *Sáº½ hoÃ n thiá»‡n sau* |

#### Chi tiáº¿t tá»«ng luá»“ng

**ğŸ”µ LUá»’NG 1: PENDING_GOODS â†’ PENDING_FINANCE â†’ COMPLETED**
```
Äiá»u kiá»‡n: CÃ³ hÃ ng hoÃ n vá» VÃ€ cÃ³ tiá»n chÃªnh lá»‡ch cáº§n tráº£ ÄVVC
Ãp dá»¥ng: BOOM, FIX_COD (REJECT_PARTIAL)

BÆ°á»›c 1: Táº¡o ticket â†’ status = PENDING_GOODS
BÆ°á»›c 2: Kho nháº­n hÃ ng â†’ Báº¥m "ÄÃ£ nháº­n hÃ ng" â†’ status = PENDING_FINANCE
BÆ°á»›c 3: Káº¿ toÃ¡n CK cho ÄVVC â†’ Báº¥m "ÄÃ£ thanh toÃ¡n" â†’ status = COMPLETED
```

**ğŸŸ¢ LUá»’NG 2: PENDING_GOODS â†’ COMPLETED**
```
Äiá»u kiá»‡n: CÃ³ hÃ ng hoÃ n vá» NHÆ¯NG khÃ´ng cáº§n tráº£ tiá»n ÄVVC
Ãp dá»¥ng: RETURN_CLIENT, RETURN_SHIPPER

BÆ°á»›c 1: Táº¡o ticket â†’ status = PENDING_GOODS
BÆ°á»›c 2: Kho nháº­n hÃ ng OK â†’ Báº¥m "ÄÃ£ nháº­n hÃ ng" â†’ status = COMPLETED

LÃ½ do bá» qua Ä‘á»‘i soÃ¡t: ÄÆ¡n gá»‘c Ä‘Ã£ thu COD Ä‘áº§y Ä‘á»§, khÃ´ng chÃªnh lá»‡ch
```

**ğŸŸ¡ LUá»’NG 3: PENDING_FINANCE â†’ COMPLETED**
```
Äiá»u kiá»‡n: KHÃ”NG cÃ³ hÃ ng hoÃ n vá», chá»‰ cáº§n Ä‘á»‘i soÃ¡t tiá»n
Ãp dá»¥ng: FIX_COD (WRONG_SHIP, CUSTOMER_DEBT, DISCOUNT)

BÆ°á»›c 1: Táº¡o ticket â†’ status = PENDING_FINANCE (bá» qua Chá» HÃ ng)
BÆ°á»›c 2: Káº¿ toÃ¡n CK cho ÄVVC â†’ Báº¥m "ÄÃ£ thanh toÃ¡n" â†’ status = COMPLETED
```

**âš« LUá»’NG 4: (Xá»­ lÃ½ thá»§ cÃ´ng) â†’ COMPLETED**
```
Äiá»u kiá»‡n: KhÃ´ng cÃ³ hÃ ng, khÃ´ng cÃ³ tiá»n
Ãp dá»¥ng: OTHER (tÆ° váº¥n, báº£o hÃ nh, khiáº¿u náº¡i...)

Hiá»‡n táº¡i: Hiá»ƒn thá»‹ á»Ÿ Tab "Táº¥t cáº£ sá»± vá»¥", báº¥m hoÃ n táº¥t thá»§ cÃ´ng
âš ï¸ NOTE: Sáº½ hoÃ n thiá»‡n logic sá»± vá»¥ OTHER sau
```

---

## A2. Chi tiáº¿t tá»«ng loáº¡i sá»± vá»¥


### A2.1 BOOM HÃ€NG (`BOOM`)

**TÃ¬nh huá»‘ng:** KhÃ¡ch khÃ´ng nháº­n Ä‘Æ¡n hÃ ng, shipper mang hÃ ng vá».

**CÃ¡c bÆ°á»›c xá»­ lÃ½:**

```mermaid
flowchart TD
    A[ğŸ“¦ Shipper bÃ¡o khÃ¡ch khÃ´ng nháº­n] --> B[CSKH táº¡o ticket BOOM]
    B --> C[Ticket: PENDING_GOODS]
    C --> D{HÃ ng vá» kho?}
    D -->|CÃ³| E[Kho nháº¥n 'ÄÃ£ nháº­n hÃ ng']
    E --> F[Kiá»ƒm tra sá»‘ lÆ°á»£ng/cháº¥t lÆ°á»£ng]
    F --> G[Táº¡o Phiáº¿u tráº£ hÃ ng TPOS]
    G --> H[Ticket: PENDING_FINANCE]
    H --> I[Káº¿ toÃ¡n hoÃ n tiá»n cho ÄVVC]
    I --> J[Ticket: COMPLETED]
    D -->|QuÃ¡ 10 ngÃ y| K[âš ï¸ Cáº£nh bÃ¡o ÄVVC cháº­m]
```

**ThÃ´ng tin cáº§n thu tháº­p:**
- MÃ£ Ä‘Æ¡n hÃ ng / MÃ£ váº­n Ä‘Æ¡n
- LÃ½ do boom (náº¿u biáº¿t)
- Danh sÃ¡ch sáº£n pháº©m trong Ä‘Æ¡n

**Tiá»n liÃªn quan:** `Sá»‘ tiá»n = Tá»•ng COD cá»§a Ä‘Æ¡n`

---

### A2.2 Sá»¬A COD (`FIX_COD`)

**TÃ¬nh huá»‘ng:** Shipper Ä‘ang giao hÃ ng, gá»i vá» xin Ä‘iá»u chá»‰nh tiá»n COD.

**CÃ¡c lÃ½ do thÆ°á»ng gáº·p:**

| LÃ½ do | MÃ£ | Xá»­ lÃ½ |
|-------|-----|-------|
| Ship sai SP | `WRONG_SHIP` | Giáº£m COD, khÃ´ng láº¥y hÃ ng thá»«a vá» |
| Trá»« ná»£ cÅ© | `CUSTOMER_DEBT` | Giáº£m COD, trá»« vÃ o sá»‘ KH Ä‘ang ná»£ |
| Xin giáº£m giÃ¡ | `DISCOUNT` | Giáº£m COD theo deal |
| Nháº­n 1 pháº§n | `REJECT_PARTIAL` | Giáº£m COD, Ä‘Ã¡nh dáº¥u SP bá»‹ tá»« chá»‘i |

**Flow chi tiáº¿t:**

```mermaid
flowchart TD
    A[ğŸ“ Shipper gá»i xin sá»­a COD] --> B[CSKH táº¡o ticket FIX_COD]
    B --> C[Nháº­p COD má»›i + LÃ½ do]
    C --> D{LÃ½ do = Nháº­n 1 pháº§n?}
    D -->|CÃ³| E[Chá»n SP khÃ¡ch tá»« chá»‘i]
    E --> F[Ticket: PENDING_GOODS - Chá» SP thá»«a vá»]
    D -->|KhÃ´ng| G[Ticket: PENDING_FINANCE]
    F --> H[Kho nháº­n SP thá»«a]
    H --> G
    G --> I[Káº¿ toÃ¡n Ä‘á»‘i soÃ¡t]
    I --> J[HoÃ n tiá»n chÃªnh lá»‡ch cho ÄVVC]
    J --> K[Ticket: COMPLETED]
```

**CÃ´ng thá»©c tÃ­nh tiá»n:**
```
Tiá»n chÃªnh lá»‡ch = COD gá»‘c - COD má»›i
VÃ­ dá»¥: COD gá»‘c 500k, khÃ¡ch tráº£ 400k â†’ ChÃªnh lá»‡ch = 100k (shop ná»£ ÄVVC)
```

---

### A2.3 KHÃCH Gá»¬I - Tá»ˆNH (`RETURN_CLIENT`)

**TÃ¬nh huá»‘ng:** KhÃ¡ch hÃ ng tá»± gá»­i hÃ ng vá» shop qua bÆ°u Ä‘iá»‡n/ÄVVC.

**Flow:**

```mermaid
flowchart TD
    A[ğŸ“¬ KhÃ¡ch gá»­i hÃ ng vá»] --> B[CSKH táº¡o ticket RETURN_CLIENT]
    B --> C[Nháº­p mÃ£ váº­n Ä‘Æ¡n khÃ¡ch gá»­i]
    C --> D[Ticket: PENDING_GOODS]
    D --> E{HÃ ng vá» kho?}
    E -->|CÃ³| F[Kho kiá»ƒm tra hÃ ng]
    F --> G{HÃ ng OK?}
    G -->|OK| H[Táº¡o Phiáº¿u tráº£ hÃ ng TPOS]
    H --> I[Cá»™ng tiá»n vÃ o VÃ khÃ¡ch]
    I --> J[Ticket: COMPLETED]
    G -->|Lá»—i| K[ÄÃ¡nh dáº¥u hÃ ng lá»—i]
    K --> L[KhÃ´ng cá»™ng tiá»n / Cá»™ng 1 pháº§n]
    L --> J
```

**Tiá»n liÃªn quan:** `Sá»‘ tiá»n = GiÃ¡ trá»‹ SP khÃ¡ch gá»­i vá» (Ä‘Æ°á»£c cá»™ng vÃ o VÃ­)`

---

### A2.4 THU Vá»€ - CÃ”NG Ná»¢ áº¢O (`RETURN_SHIPPER`)

**TÃ¬nh huá»‘ng:** KhÃ¡ch muá»‘n Ä‘á»•i hÃ ng, shipper thu há»“i hÃ ng cÅ© khi giao Ä‘Æ¡n má»›i.

**âš ï¸ ÄÃ‚Y LÃ€ FLOW PHá»¨C Táº P NHáº¤T - Cáº¦N Äá»ŒC Ká»¸**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ FLOW CÃ”NG Ná»¢ áº¢O (Virtual Credit)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  BÆ°á»›c 1: KH muá»‘n Ä‘á»•i hÃ ng â†’ CSKH cáº¥p "CÃ´ng ná»£ áº£o" = GiÃ¡ trá»‹ hÃ ng cÅ©        â”‚
â”‚                                                                             â”‚
â”‚  BÆ°á»›c 2: KH dÃ¹ng cÃ´ng ná»£ áº£o Ä‘á»ƒ Ä‘áº·t Ä‘Æ¡n má»›i (COD = ÄÆ¡n má»›i - CÃ´ng ná»£ áº£o)    â”‚
â”‚                                                                             â”‚
â”‚  BÆ°á»›c 3: Shipper giao Ä‘Æ¡n má»›i â†’ Thu hÃ ng cÅ© vá»                             â”‚
â”‚                                                                             â”‚
â”‚  BÆ°á»›c 4: Kho nháº­n hÃ ng cÅ© â†’ HoÃ n táº¥t                                       â”‚
â”‚                                                                             â”‚
â”‚  â° QUAN TRá»ŒNG: CÃ´ng ná»£ áº£o cÃ³ THá»œI Háº N 15 NGÃ€Y                              â”‚
â”‚     - Náº¿u KH khÃ´ng Ä‘áº·t Ä‘Æ¡n má»›i â†’ CÃ´ng ná»£ áº£o Tá»° Äá»˜NG Háº¾T Háº N                â”‚
â”‚     - Cáº§n gá»i KH nháº¯c trÆ°á»›c khi háº¿t háº¡n                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**State Machine:**

```mermaid
stateDiagram-v2
    [*] --> VIRTUAL_CREDIT_ISSUED: CSKH cáº¥p cÃ´ng ná»£ áº£o

    VIRTUAL_CREDIT_ISSUED --> NEW_ORDER_PLACED: KH Ä‘áº·t Ä‘Æ¡n má»›i (dÃ¹ng cÃ´ng ná»£)
    VIRTUAL_CREDIT_ISSUED --> EXPIRED_NO_ACTION: QuÃ¡ 15 ngÃ y khÃ´ng Ä‘áº·t

    NEW_ORDER_PLACED --> PENDING_RECOVERY: ÄÆ¡n má»›i giao thÃ nh cÃ´ng
    NEW_ORDER_PLACED --> VIRTUAL_CREDIT_ISSUED: ÄÆ¡n má»›i bá»‹ há»§y/boom

    PENDING_RECOVERY --> COMPLETED: Kho nháº­n hÃ ng cÅ© OK
    PENDING_RECOVERY --> LOGISTICS_ISSUE: QuÃ¡ 10 ngÃ y hÃ ng chÆ°a vá»

    LOGISTICS_ISSUE --> COMPLETED: ÄVVC Ä‘á»n bÃ¹ / hÃ ng vá»
    EXPIRED_NO_ACTION --> COMPLETED: Xá»­ lÃ½ thá»§ cÃ´ng

    COMPLETED --> [*]
```

**VÃ­ dá»¥ cá»¥ thá»ƒ:**

```
NgÃ y 1: KH A mua Ã¡o 300k, giao thÃ nh cÃ´ng
NgÃ y 5: KH A muá»‘n Ä‘á»•i size
        â†’ CSKH táº¡o ticket THU Vá»€, cáº¥p cÃ´ng ná»£ áº£o 300k

NgÃ y 7: KH A Ä‘áº·t Ä‘Æ¡n má»›i (Ã¡o size khÃ¡c) 350k
        â†’ COD thá»±c = 350k - 300k = 50k
        â†’ Ticket chuyá»ƒn sang NEW_ORDER_PLACED

NgÃ y 9: Shipper giao Ä‘Æ¡n 50k + Thu Ã¡o cÅ© vá»
        â†’ Ticket chuyá»ƒn sang PENDING_RECOVERY

NgÃ y 10: Kho nháº­n Ã¡o cÅ© vá», kiá»ƒm tra OK
         â†’ Ticket: COMPLETED

---
TrÆ°á»ng há»£p xáº¥u:
NgÃ y 20: KH A khÃ´ng Ä‘áº·t Ä‘Æ¡n má»›i
         â†’ CÃ´ng ná»£ áº£o 300k Tá»° Äá»˜NG Háº¾T Háº N
         â†’ Ticket: EXPIRED_NO_ACTION
         â†’ CSKH cáº§n xá»­ lÃ½ thá»§ cÃ´ng (gá»i KH, quyáº¿t Ä‘á»‹nh...)
```

---

### A2.5 CSKH KHÃC (`OTHER`)

**TÃ¬nh huá»‘ng:** CÃ¡c váº¥n Ä‘á» khÃ´ng thuá»™c 4 loáº¡i trÃªn.

- TÆ° váº¥n sáº£n pháº©m
- Báº£o hÃ nh
- Khiáº¿u náº¡i dá»‹ch vá»¥
- Há»i thÃ´ng tin Ä‘Æ¡n hÃ ng

**Flow:** Táº¡o ticket â†’ Ghi chÃº â†’ HoÃ n táº¥t ngay (auto-complete)

---

## A3. Module VÃ­ KhÃ¡ch HÃ ng (Customer Wallet)

### A3.1 KhÃ¡i niá»‡m

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’³ VÃ KHÃCH HÃ€NG                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Má»—i khÃ¡ch hÃ ng cÃ³ 1 VÃ gá»“m 2 loáº¡i sá»‘ dÆ°:                                  â”‚
â”‚                                                                             â”‚
â”‚  1. Sá» DÆ¯ THá»°C (Real Balance)                                              â”‚
â”‚     - Tiá»n tháº­t khÃ¡ch Ä‘Ã£ náº¡p/Ä‘Æ°á»£c hoÃ n                                     â”‚
â”‚     - KhÃ´ng cÃ³ thá»i háº¡n                                                    â”‚
â”‚     - CÃ³ thá»ƒ rÃºt ra (chuyá»ƒn khoáº£n láº¡i cho KH)                              â”‚
â”‚                                                                             â”‚
â”‚  2. Sá» DÆ¯ áº¢O (Virtual Balance)                                             â”‚
â”‚     - CÃ´ng ná»£ áº£o tá»« flow THU Vá»€                                            â”‚
â”‚     - CÃ“ THá»œI Háº N (15 ngÃ y)                                                â”‚
â”‚     - Chá»‰ dÃ¹ng Ä‘Æ°á»£c khi Ä‘áº·t Ä‘Æ¡n má»›i                                        â”‚
â”‚     - Tá»± Ä‘á»™ng máº¥t náº¿u háº¿t háº¡n                                              â”‚
â”‚                                                                             â”‚
â”‚  Khi Ä‘áº·t Ä‘Æ¡n: Æ¯u tiÃªn trá»« Sá» DÆ¯ áº¢O trÆ°á»›c, sau Ä‘Ã³ má»›i trá»« Sá» DÆ¯ THá»°C        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### A3.2 CÃ¡c nguá»“n tiá»n vÃ o vÃ­

| Nguá»“n | Loáº¡i sá»‘ dÆ° | MÃ´ táº£ |
|-------|------------|-------|
| KH chuyá»ƒn khoáº£n | Thá»±c | KH CK tiá»n trÆ°á»›c Ä‘á»ƒ Ä‘áº·t hÃ ng |
| HoÃ n hÃ ng (RETURN_CLIENT) | Thá»±c | KH gá»­i hÃ ng vá», Ä‘Æ°á»£c hoÃ n tiá»n |
| Thu vá» (RETURN_SHIPPER) | **áº¢o** | Cáº¥p cÃ´ng ná»£ áº£o Ä‘á»ƒ Ä‘á»•i hÃ ng |

### A3.3 CÃ¡c nguá»“n tiá»n ra khá»i vÃ­

| TÃ¬nh huá»‘ng | Loáº¡i sá»‘ dÆ° | MÃ´ táº£ |
|------------|------------|-------|
| Äáº·t Ä‘Æ¡n má»›i | áº¢o trÆ°á»›c, rá»“i Thá»±c | Trá»« Ä‘á»ƒ giáº£m COD |
| RÃºt tiá»n | Thá»±c | KH xin rÃºt, shop CK láº¡i |
| Háº¿t háº¡n | áº¢o | CÃ´ng ná»£ áº£o quÃ¡ 15 ngÃ y |

---

## A4. Dashboard vÃ  bÃ¡o cÃ¡o

### A4.1 CÃ¡c tab hiá»ƒn thá»‹

| Tab | Lá»c theo | MÃ´ táº£ |
|-----|----------|-------|
| **Chá» HÃ ng Vá»** | `status = PENDING_GOODS` | Ticket Ä‘ang chá» hÃ ng vá» kho |
| **Chá» Äá»‘i SoÃ¡t** | `status = PENDING_FINANCE` | HÃ ng Ä‘Ã£ vá», chá» KT Ä‘á»‘i soÃ¡t |
| **HoÃ n Táº¥t** | `status = COMPLETED` | Ticket Ä‘Ã£ xá»­ lÃ½ xong |
| **CÃ´ng Ná»£ áº¢o** | `extendedStatus = VIRTUAL_CREDIT_*` | CÃ¡c ticket Thu vá» |

### A4.2 Cáº£nh bÃ¡o quan trá»ng

| Cáº£nh bÃ¡o | Äiá»u kiá»‡n | MÃ u |
|----------|-----------|-----|
| ğŸŸ¡ Sáº¯p háº¿t háº¡n | CÃ´ng ná»£ áº£o cÃ²n < 3 ngÃ y | VÃ ng |
| ğŸ”´ ÄÃ£ háº¿t háº¡n | CÃ´ng ná»£ áº£o quÃ¡ 15 ngÃ y | Äá» |
| ğŸ”´ ÄVVC cháº­m | HÃ ng chÆ°a vá» quÃ¡ 10 ngÃ y | Äá» |

---

<a id="phan-b"></a>
# PHáº¦N B: Äáº¶C Táº¢ Ká»¸ THUáº¬T

## B1. Kiáº¿n trÃºc há»‡ thá»‘ng

### B1.1 Stack cÃ´ng nghá»‡

```
Frontend:
â”œâ”€â”€ HTML5 + Vanilla JavaScript (ES6+)
â”œâ”€â”€ CSS3 (Custom variables, Flexbox, Grid)
â”œâ”€â”€ Mermaid.js (Flow diagrams)
â””â”€â”€ Firebase SDK 8.10.0

Backend/APIs:
â”œâ”€â”€ Firebase Realtime Database (Primary storage)
â”œâ”€â”€ Cloudflare Worker (Proxy to TPOS)
â”œâ”€â”€ TPOS OData API (Orders, Products, Invoices)
â””â”€â”€ SePay Webhook (Bank transactions)

Shared Modules:
â”œâ”€â”€ orders-report/api-config.js (Server URLs)
â”œâ”€â”€ orders-report/api-handler.js (Utilities)
â””â”€â”€ Firebase Auth (Authentication)
```

### B1.2 Cáº¥u trÃºc files

```
issue-tracking/
â”œâ”€â”€ index.html                    # UI chÃ­nh
â”œâ”€â”€ script.js                     # Core logic (850+ lines)
â”œâ”€â”€ api-service.js                # Firebase CRUD + TPOS API
â”œâ”€â”€ wallet-service.js             # [Má»šI] Module vÃ­ khÃ¡ch hÃ ng
â”œâ”€â”€ cron-jobs.js                  # [Má»šI] Auto-expire, warnings
â”œâ”€â”€ firebase-init.js              # Firebase config
â”œâ”€â”€ style.css                     # Styling
â”œâ”€â”€ images/                       # Guide images
â””â”€â”€ MASTER_DOCUMENTATION.md       # File nÃ y
```

### B1.3 SÆ¡ Ä‘á»“ kiáº¿n trÃºc

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Há»† SINH THÃI                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚  TPOS   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  WEB Ná»˜I Bá»˜  â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚  FIREBASE   â”‚       â”‚
â”‚   â”‚ (Core)  â”‚  OData  â”‚ (Issue Track)â”‚  RTDB  â”‚  Realtime   â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚       â”‚                      â”‚                      â”‚               â”‚
â”‚       â”‚                      â”‚                      â”‚               â”‚
â”‚       â–¼                      â–¼                      â–¼               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚  ÄVVC   â”‚         â”‚    SEPAY     â”‚        â”‚   USERS     â”‚       â”‚
â”‚   â”‚ GHN/SPX â”‚         â”‚  (Webhook)   â”‚        â”‚ Auth/Roles  â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## B2. Data Model

### B2.1 Ticket Object (Complete)

```typescript
interface Ticket {
  // === IDENTITY ===
  firebaseId: string;           // Auto-generated by Firebase push()

  // === ORDER INFO ===
  orderId: string;              // MÃ£ Ä‘Æ¡n TPOS (VD: "NJD/2026/42639")
  trackingCode?: string;        // MÃ£ váº­n Ä‘Æ¡n ÄVVC
  customer: string;             // TÃªn khÃ¡ch hÃ ng
  phone: string;                // SÄT khÃ¡ch
  channel: string;              // KÃªnh bÃ¡n: "TPOS", "SPX", "Shopee"...

  // === TICKET INFO ===
  type: TicketType;             // Loáº¡i sá»± vá»¥
  status: TicketStatus;         // Tráº¡ng thÃ¡i cÆ¡ báº£n
  extendedStatus?: ExtendedStatus; // Tráº¡ng thÃ¡i chi tiáº¿t

  // === PRODUCTS ===
  products: Product[];          // Danh sÃ¡ch SP liÃªn quan

  // === MONEY ===
  money: number;                // Sá»‘ tiá»n liÃªn quan
  originalCod?: number;         // COD gá»‘c (cho FIX_COD)
  newCod?: number;              // COD má»›i (cho FIX_COD)
  codDifference?: number;       // ChÃªnh lá»‡ch

  // === TYPE-SPECIFIC FIELDS ===
  fixReason?: FixCodReason;     // LÃ½ do sá»­a COD
  returnTrackingCode?: string;  // MÃ£ VÄ khÃ¡ch gá»­i vá»
  shipperName?: string;         // TÃªn shipper thu hÃ ng

  // === VIRTUAL CREDIT (cho RETURN_SHIPPER) ===
  virtualCredit?: {
    amount: number;
    issuedAt: number;           // Timestamp cáº¥p
    expiresAt: number;          // Timestamp háº¿t háº¡n (15 ngÃ y sau)
    status: 'ACTIVE' | 'USED' | 'EXPIRED' | 'CANCELLED';
    linkedOrderId?: string;     // MÃ£ Ä‘Æ¡n má»›i khi KH sá»­ dá»¥ng
    linkedOrderDeliveredAt?: number;
  };

  // === CARRIER TRACKING ===
  carrierRecoveryDeadline?: number; // Deadline ÄVVC pháº£i mang hÃ ng vá»
  carrierIssueFlag?: boolean;       // Cá» quÃ¡ háº¡n

  // === DEFECTIVE ITEMS ===
  hasDefectiveItems?: boolean;
  defectiveItemsNote?: string;

  // === NOTES ===
  note: string;                 // Ghi chÃº ná»™i bá»™

  // === TIMESTAMPS ===
  createdAt: number;
  updatedAt: number;
  completedAt?: number;

  // === AUDIT ===
  createdBy?: string;
  updatedBy?: string;
  actionHistory?: ActionLog[];
}

// Enums
type TicketType = 'FIX_COD' | 'RETURN_CLIENT' | 'RETURN_SHIPPER' | 'BOOM' | 'OTHER';

type TicketStatus = 'PENDING_GOODS' | 'PENDING_FINANCE' | 'COMPLETED';

type ExtendedStatus =
  | 'NEW'
  | 'PENDING_RETURN'
  | 'RECEIVED_VERIFIED'
  | 'ACCOUNTING_DONE'
  | 'VIRTUAL_CREDIT_ISSUED'
  | 'NEW_ORDER_PLACED'
  | 'PENDING_RECOVERY'
  | 'COMPLETED'
  | 'EXPIRED_NO_ACTION'
  | 'LOGISTICS_ISSUE';

type FixCodReason = 'WRONG_SHIP' | 'CUSTOMER_DEBT' | 'DISCOUNT' | 'REJECT_PARTIAL';

interface Product {
  id: string | number;
  name: string;
  price: number;
  quantity: number;
}

interface ActionLog {
  action: string;
  performedBy: string;
  performedAt: number;
  note?: string;
  oldStatus?: string;
  newStatus?: string;
}
```

### B2.2 Customer Wallet

```typescript
interface CustomerWallet {
  // === IDENTITY ===
  phone: string;                // Primary key (normalized: "0977888999")
  customerName: string;

  // === BALANCES ===
  balance: number;              // Sá»‘ dÆ° thá»±c (â‰¥ 0)
  virtualBalance: number;       // Sá»‘ dÆ° áº£o (tá»•ng cÃ¡c cÃ´ng ná»£ áº£o active)

  // === VIRTUAL CREDITS ===
  virtualCredits: VirtualCredit[];

  // === TIMESTAMPS ===
  createdAt: number;
  updatedAt: number;
}

interface VirtualCredit {
  ticketId: string;             // ID ticket Thu vá»
  amount: number;               // Sá»‘ tiá»n cÃ²n láº¡i
  issuedAt: number;
  expiresAt: number;
  status: 'ACTIVE' | 'USED' | 'EXPIRED' | 'CANCELLED';
}

interface WalletTransaction {
  id: string;
  phone: string;
  type: 'DEPOSIT' | 'WITHDRAW' | 'VIRTUAL_CREDIT' | 'VIRTUAL_DEBIT' | 'VIRTUAL_EXPIRE';
  amount: number;
  balanceAfter: number;
  source: 'BANK_TRANSFER' | 'RETURN_GOODS' | 'ORDER_PAYMENT' | 'VIRTUAL_CREDIT_ISSUE' | 'VIRTUAL_CREDIT_USE' | 'VIRTUAL_CREDIT_EXPIRE';
  reference?: string;           // ticketId, orderId, bankTxId
  note?: string;
  createdAt: number;
  createdBy?: string;
}
```

### B2.3 Firebase Database Structure

```
Firebase Realtime Database
â”‚
â”œâ”€â”€ issue_tracking/
â”‚   â”œâ”€â”€ tickets/
â”‚   â”‚   â””â”€â”€ {pushId}/                    # Ticket object
â”‚   â”‚       â”œâ”€â”€ firebaseId
â”‚   â”‚       â”œâ”€â”€ orderId
â”‚   â”‚       â”œâ”€â”€ customer
â”‚   â”‚       â”œâ”€â”€ phone
â”‚   â”‚       â”œâ”€â”€ type
â”‚   â”‚       â”œâ”€â”€ status
â”‚   â”‚       â”œâ”€â”€ extendedStatus
â”‚   â”‚       â”œâ”€â”€ products: []
â”‚   â”‚       â”œâ”€â”€ money
â”‚   â”‚       â”œâ”€â”€ virtualCredit: {}
â”‚   â”‚       â”œâ”€â”€ note
â”‚   â”‚       â”œâ”€â”€ createdAt
â”‚   â”‚       â”œâ”€â”€ updatedAt
â”‚   â”‚       â””â”€â”€ completedAt
â”‚   â”‚
â”‚   â””â”€â”€ reconciliation_batches/          # Lá»‹ch sá»­ Ä‘á»‘i soÃ¡t Excel
â”‚       â””â”€â”€ {batchId}/
â”‚
â”œâ”€â”€ customer_wallets/
â”‚   â””â”€â”€ {normalizedPhone}/               # VD: "0977888999"
â”‚       â”œâ”€â”€ phone
â”‚       â”œâ”€â”€ customerName
â”‚       â”œâ”€â”€ balance
â”‚       â”œâ”€â”€ virtualBalance
â”‚       â”œâ”€â”€ virtualCredits: []
â”‚       â”œâ”€â”€ createdAt
â”‚       â””â”€â”€ updatedAt
â”‚
â”œâ”€â”€ wallet_transactions/
â”‚   â””â”€â”€ {transactionId}/
â”‚       â”œâ”€â”€ phone
â”‚       â”œâ”€â”€ type
â”‚       â”œâ”€â”€ amount
â”‚       â”œâ”€â”€ balanceAfter
â”‚       â”œâ”€â”€ source
â”‚       â”œâ”€â”€ reference
â”‚       â”œâ”€â”€ note
â”‚       â””â”€â”€ createdAt
â”‚
â”œâ”€â”€ sepay_webhooks/
â”‚   â””â”€â”€ {webhookId}/                     # Log tá»« SePay
â”‚       â”œâ”€â”€ raw_payload
â”‚       â”œâ”€â”€ processedAt
â”‚       â”œâ”€â”€ status: 'SUCCESS' | 'NO_MATCH' | 'ERROR'
â”‚       â””â”€â”€ matchedPhone
â”‚
â””â”€â”€ system_config/
    â”œâ”€â”€ virtual_credit_expiry_days: 15
    â””â”€â”€ carrier_recovery_days: 10
```

---

## B3. API Reference

### B3.1 TPOS OData API

**Base URL:** Qua Cloudflare Worker proxy

**Search Orders:**
```javascript
// Endpoint
GET /api/odata/SaleOnline_Order/ODataService.GetView
    ?$filter=Phone eq '{phone}' or Code eq '{code}' or TrackingRef eq '{trackingCode}'
    &$top=20
    &$orderby=CreateDate desc

// Response Fields Mapping
{
  "Id": 42639,              â†’ orderId (number)
  "Number": "NJD/2026/42639", â†’ tposCode
  "Phone": "0773841886",    â†’ phone
  "State": "paid",          â†’ status
  "StateCode": "CrossCheckComplete", â†’ stateCode
  "CashOnDelivery": 325000, â†’ cod
  "AmountTotal": 325000,    â†’ totalAmount
  "TrackingRef": "12345678", â†’ trackingCode
  "CarrierName": "J&T",     â†’ carrier
  "DateInvoice": "2026-01-05", â†’ createdAt
  "CustomerName": "Nguyá»…n A", â†’ customer
  "Address": "123 ABC...",  â†’ address
  "OrderDetails": [...]     â†’ products
}

// State Values
"draft"  â†’ NhÃ¡p (bá» qua)
"open"   â†’ ÄÃ£ xÃ¡c nháº­n âœ“
"paid"   â†’ ÄÃ£ thanh toÃ¡n âœ“
"cancel" â†’ Há»§y bá» (bá» qua)

// StateCode Values
"CrossCheckComplete"  â†’ ÄÃ£ ÄS sáº£n pháº©m (ğŸŸ¢)
"NotEnoughInventory"  â†’ KhÃ´ng Ä‘á»§ tá»“n (ğŸŸ )
"None"                â†’ ChÆ°a ÄS sáº£n pháº©m (ğŸŸ )
```

**Create Return Invoice:**
```javascript
// Endpoint
POST /api/odata/SaleOnline_Order/ODataService.CreateReturnInvoice

// Body
{
  "OriginalOrderId": 42639,
  "Products": [
    { "ProductId": 123, "Quantity": 1, "Price": 150000 }
  ],
  "Note": "Ticket #xxx - Boom hÃ ng"
}
```

### B3.2 SePay Webhook

**Webhook URL:** Cloud Function endpoint

**Payload tá»« SePay:**
```json
{
  "id": "12345",
  "gateway": "VCB",
  "transactionDate": "2026-01-04 10:30:00",
  "accountNumber": "1234567890",
  "content": "0977888999 nop tien",
  "transferType": "in",
  "transferAmount": 500000,
  "referenceCode": "FT26004xxxx"
}
```

**Xá»­ lÃ½:**
1. Parse `content` Ä‘á»ƒ tÃ¬m SÄT (regex: `/(0\d{9,10})/`)
2. TÃ¬m wallet theo phone
3. Náº¿u tÃ¬m tháº¥y â†’ Deposit vÃ o wallet
4. Log webhook vÃ o `sepay_webhooks/`

---

## B4. Core Logic - Code Reference

### B4.1 Status Assignment (Táº¡o ticket má»›i)

```javascript
// File: script.js - handleSubmitTicket()

function determineInitialStatus(type) {
  switch (type) {
    case 'FIX_COD':
      return { status: 'PENDING_FINANCE', extendedStatus: 'NEW' };

    case 'OTHER':
      return { status: 'COMPLETED', extendedStatus: 'COMPLETED' };

    case 'RETURN_SHIPPER':
      // Flow cÃ´ng ná»£ áº£o
      return { status: 'PENDING_GOODS', extendedStatus: 'VIRTUAL_CREDIT_ISSUED' };

    case 'BOOM':
    case 'RETURN_CLIENT':
    default:
      return { status: 'PENDING_GOODS', extendedStatus: 'PENDING_RETURN' };
  }
}
```

### B4.2 Money Calculation

```javascript
// File: script.js

function calculateMoney(type, order, formData) {
  switch (type) {
    case 'FIX_COD':
      // ChÃªnh lá»‡ch COD
      return order.cod - formData.newCod;

    case 'BOOM':
    case 'RETURN_CLIENT':
    case 'RETURN_SHIPPER':
      // Tá»•ng giÃ¡ trá»‹ SP Ä‘Æ°á»£c chá»n
      return formData.selectedProducts.reduce((sum, p) => sum + p.price, 0);

    case 'OTHER':
    default:
      return 0;
  }
}
```

### B4.3 Wallet Operations Priority

```javascript
// File: wallet-service.js - withdraw()

async function withdraw(phone, amount, reference) {
  // 1. Æ¯u tiÃªn trá»« cÃ´ng ná»£ áº¢O trÆ°á»›c (FIFO - sáº¯p háº¿t háº¡n trÆ°á»›c)
  const activeCredits = wallet.virtualCredits
    .filter(c => c.status === 'ACTIVE' && c.expiresAt > Date.now())
    .sort((a, b) => a.expiresAt - b.expiresAt);

  for (const credit of activeCredits) {
    const useAmount = Math.min(credit.amount, remaining);
    credit.amount -= useAmount;
    remaining -= useAmount;
    virtualUsed += useAmount;

    if (credit.amount <= 0) credit.status = 'USED';
    if (remaining <= 0) break;
  }

  // 2. Sau Ä‘Ã³ má»›i trá»« cÃ´ng ná»£ THá»°C
  if (remaining > 0) {
    if (wallet.balance < remaining) throw new Error('Insufficient balance');
    realUsed = remaining;
  }

  // 3. Update wallet
  ...
}
```

### B4.4 Cron Jobs

```javascript
// File: cron-jobs.js

const CronJobs = {
  INTERVAL: 60 * 60 * 1000, // 1 giá»

  async runAll() {
    await this.expireVirtualCredits();    // Thu há»“i cÃ´ng ná»£ áº£o háº¿t háº¡n
    await this.checkCarrierDeadlines();   // Cáº£nh bÃ¡o ÄVVC cháº­m
  },

  async expireVirtualCredits() {
    // TÃ¬m táº¥t cáº£ virtualCredits cÃ³ status=ACTIVE vÃ  expiresAt <= now
    // Update status = EXPIRED
    // Update ticket extendedStatus = EXPIRED_NO_ACTION
    // Trá»« virtualBalance cá»§a wallet
  },

  async checkCarrierDeadlines() {
    // TÃ¬m tickets cÃ³ extendedStatus = PENDING_RECOVERY
    // VÃ  linkedOrderDeliveredAt + 10 ngÃ y < now
    // Update extendedStatus = LOGISTICS_ISSUE
    // Set carrierIssueFlag = true
  }
};
```

---

## B5. Validation Rules

### B5.1 Ticket Creation

| Field | Rule | Error Message |
|-------|------|---------------|
| `orderId` | Required | "ChÆ°a chá»n Ä‘Æ¡n hÃ ng!" |
| `type` | Required, enum | "Vui lÃ²ng chá»n loáº¡i váº¥n Ä‘á»" |
| `newCod` | Required if FIX_COD, >= 0 | "Vui lÃ²ng nháº­p COD má»›i há»£p lá»‡" |
| `products` | At least 1 if BOOM/RETURN | "Vui lÃ²ng chá»n Ã­t nháº¥t 1 sáº£n pháº©m" |

### B5.2 Wallet Operations

| Operation | Rule | Error |
|-----------|------|-------|
| Deposit | amount > 0 | "Sá»‘ tiá»n pháº£i > 0" |
| Withdraw | amount <= (balance + virtualBalance) | "Sá»‘ dÆ° khÃ´ng Ä‘á»§" |
| Virtual Credit | amount > 0, expiryDays > 0 | Invalid params |

---

## B6. Error Handling

### B6.1 API Errors

```javascript
// Standard error handling pattern
try {
  const result = await ApiService.someOperation();
  // success
} catch (error) {
  console.error('[Module] Operation failed:', error);

  // User-friendly message
  if (error.code === 'PERMISSION_DENIED') {
    alert('Báº¡n khÃ´ng cÃ³ quyá»n thá»±c hiá»‡n thao tÃ¡c nÃ y');
  } else if (error.code === 'NETWORK_ERROR') {
    alert('Lá»—i káº¿t ná»‘i. Vui lÃ²ng kiá»ƒm tra máº¡ng vÃ  thá»­ láº¡i');
  } else {
    alert('ÄÃ£ xáº£y ra lá»—i: ' + error.message);
  }
}
```

### B6.2 Firebase Error Codes

| Code | Meaning | Recovery |
|------|---------|----------|
| `PERMISSION_DENIED` | No auth or wrong rules | Check login, Firebase rules |
| `NETWORK_ERROR` | No internet | Retry later |
| `INVALID_INPUT` | Wrong data format | Fix data and retry |

---

<a id="phan-c"></a>
# PHáº¦N C: Káº¾ HOáº CH THá»°C HIá»†N

## C1. Roadmap tá»•ng quan

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ROADMAP IMPLEMENTATION                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  PHASE 0: CRITICAL FIX (Pháº£i lÃ m trÆ°á»›c)                                     â”‚
â”‚  â”œâ”€â”€ [P0-1] âœ… DONE - TÃ­ch há»£p TPOS API searchOrders()                      â”‚
â”‚  â””â”€â”€ [P0-2] âœ… DONE - Firebase realtime subscription                         â”‚
â”‚                                                                              â”‚
â”‚  PHASE 1: CORE FEATURES (TÃ­nh nÄƒng cá»‘t lÃµi)                                 â”‚
â”‚  â”œâ”€â”€ [P1-1] â³ TODO - Module Customer Wallet                                 â”‚
â”‚  â”œâ”€â”€ [P1-2] â³ TODO - Flow "Thu Vá»" vá»›i CÃ´ng ná»£ áº£o                          â”‚
â”‚  â”œâ”€â”€ [P1-3] â³ TODO - Extended Status system                                 â”‚
â”‚  â””â”€â”€ [P1-4] â³ TODO - UI hiá»ƒn thá»‹ Wallet                                    â”‚
â”‚                                                                              â”‚
â”‚  PHASE 2: AUTOMATION (Tá»± Ä‘á»™ng hÃ³a)                                          â”‚
â”‚  â”œâ”€â”€ [P2-1] â³ TODO - SePay Webhook Integration                             â”‚
â”‚  â”œâ”€â”€ [P2-2] â³ TODO - Cron Jobs (auto-expire, warnings)                     â”‚
â”‚  â”œâ”€â”€ [P2-3] â³ TODO - TPOS API táº¡o Phiáº¿u tráº£ hÃ ng                           â”‚
â”‚  â””â”€â”€ [P2-4] â³ TODO - Notification System                                   â”‚
â”‚                                                                              â”‚
â”‚  PHASE 3: POLISH (HoÃ n thiá»‡n)                                               â”‚
â”‚  â”œâ”€â”€ [P3-1] â³ TODO - Audit Trail                                           â”‚
â”‚  â”œâ”€â”€ [P3-2] â³ TODO - Reports & Analytics                                   â”‚
â”‚  â””â”€â”€ [P3-3] â³ TODO - Mobile Responsive                                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## C2. Chi tiáº¿t tá»«ng Task

### PHASE 0: CRITICAL FIX

#### [P0-1] TÃ­ch há»£p TPOS API - searchOrders() âœ… DONE

```
Files Ä‘Ã£ sá»­a:
â”œâ”€â”€ api-service.js     # Implement searchOrders() vá»›i TPOS OData
â””â”€â”€ script.js          # Handle multiple search results

Acceptance Criteria: âœ…
âœ“ TÃ¬m Ä‘Æ°á»£c Ä‘Æ¡n theo SÄT
âœ“ TÃ¬m Ä‘Æ°á»£c Ä‘Æ¡n theo MÃ£ VÄ
âœ“ Hiá»‡n danh sÃ¡ch náº¿u cÃ³ nhiá»u káº¿t quáº£
âœ“ Handle lá»—i API
```

#### [P0-2] Firebase Realtime Subscription âœ… DONE

```
Files Ä‘Ã£ implement:
â”œâ”€â”€ api-service.js     # subscribeToTickets() vá»›i Firebase v8 syntax
â””â”€â”€ script.js          # Gá»i subscription trong DOMContentLoaded

ÄÃ£ hoÃ n thÃ nh:
âœ“ Subscription code hoáº¡t Ä‘á»™ng táº¡i script.js:41-47
âœ“ ApiService.subscribeToTickets() táº¡i api-service.js:212-227
âœ“ Dashboard tá»± Ä‘á»™ng cáº­p nháº­t khi cÃ³ ticket má»›i
âœ“ Stats (sá»‘ lÆ°á»£ng) tá»± Ä‘á»™ng cáº­p nháº­t
âœ“ Sá»­ dá»¥ng Firebase v8 ref.on('value', ...) syntax Ä‘Ãºng chuáº©n
```

---

### PHASE 1: CORE FEATURES

#### [P1-1] Module Customer Wallet â³ TODO

```
Files cáº§n táº¡o Má»šI:
â”œâ”€â”€ wallet-service.js    # Core wallet logic
â””â”€â”€ wallet-ui.js         # UI components (optional)

Files cáº§n sá»­a:
â”œâ”€â”€ index.html           # Add wallet UI elements
â”œâ”€â”€ style.css            # Wallet styles
â””â”€â”€ firebase-init.js     # Add wallet database refs

Implementation Steps:
1. Táº¡o wallet-service.js vá»›i cÃ¡c methods:
   - getWallet(phone)
   - upsertWallet(phone, customerName)
   - deposit(phone, amount, source, reference, note)
   - withdraw(phone, amount, reference, note)
   - issueVirtualCredit(phone, amount, ticketId, expiryDays)
   - expireVirtualCredits(phone)

2. Táº¡o UI hiá»ƒn thá»‹ wallet trong modal táº¡o ticket
3. TÃ­ch há»£p vÃ o flow táº¡o Ä‘Æ¡n hÃ ng

Acceptance Criteria:
â–¡ CRUD Wallet hoáº¡t Ä‘á»™ng
â–¡ Deposit/Withdraw hoáº¡t Ä‘á»™ng
â–¡ CÃ³ transaction history
â–¡ UI hiá»ƒn thá»‹ sá»‘ dÆ°

ğŸ“‹ DEFINITION OF DONE (Test Cases):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Test 1: Gá»i deposit("0977888999", -50000, ...) â†’ PHáº¢I bÃ¡o lá»—i          â”‚
â”‚ Test 2: Gá»i deposit("0977888999", 100000, ...) â†’ balance tÄƒng 100k     â”‚
â”‚ Test 3: Gá»i withdraw() vá»›i amount > balance â†’ PHáº¢I bÃ¡o "Sá»‘ dÆ° khÃ´ng Ä‘á»§"â”‚
â”‚ Test 4: Kiá»ƒm tra Firebase â†’ CÃ³ node customer_wallets/0977888999        â”‚
â”‚ Test 5: Kiá»ƒm tra Firebase â†’ CÃ³ transaction log trong wallet_transactionsâ”‚
â”‚ Test 6: 2 ngÆ°á»i cÃ¹ng deposit â†’ Sá»‘ dÆ° cuá»‘i = tá»•ng 2 láº§n (atomic test)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### [P1-2] Flow "Thu Vá»" vá»›i CÃ´ng ná»£ áº£o â³ TODO

```
Files cáº§n sá»­a:
â”œâ”€â”€ script.js            # handleVirtualCreditFlow()
â”œâ”€â”€ api-service.js       # Support virtualCredit field
â””â”€â”€ index.html           # UI cho flow nÃ y

Implementation Steps:
1. ThÃªm option "Thu vá» (CÃ´ng ná»£ áº£o)" vÃ o issue type
2. Khi chá»n RETURN_SHIPPER, há»i confirm flow cÃ´ng ná»£ áº£o
3. Táº¡o ticket vá»›i extendedStatus = VIRTUAL_CREDIT_ISSUED
4. Gá»i WalletService.issueVirtualCredit()
5. Hiá»ƒn thá»‹ thÃ´ng tin cÃ´ng ná»£ áº£o trong ticket detail

Acceptance Criteria:
â–¡ Cáº¥p Ä‘Æ°á»£c cÃ´ng ná»£ áº£o khi táº¡o ticket Thu vá»
â–¡ CÃ´ng ná»£ áº£o cÃ³ ngÃ y háº¿t háº¡n (15 ngÃ y)
â–¡ Hiá»ƒn thá»‹ countdown trong UI
â–¡ State machine hoáº¡t Ä‘á»™ng Ä‘Ãºng

ğŸ“‹ DEFINITION OF DONE (Test Cases):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Test 1: Táº¡o ticket RETURN_SHIPPER â†’ Wallet cÃ³ virtualCredit má»›i       â”‚
â”‚ Test 2: virtualCredit.expiresAt = issuedAt + 15 ngÃ y                  â”‚
â”‚ Test 3: UI hiá»ƒn thá»‹ "CÃ²n X ngÃ y" countdown                            â”‚
â”‚ Test 4: Ticket cÃ³ extendedStatus = 'VIRTUAL_CREDIT_ISSUED'            â”‚
â”‚ Test 5: Wallet.virtualBalance = tá»•ng cÃ¡c cÃ´ng ná»£ áº£o ACTIVE            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### [P1-3] Extended Status System â³ TODO

```
Files cáº§n sá»­a:
â”œâ”€â”€ script.js            # translateStatus(), filter logic
â”œâ”€â”€ style.css            # Status badge colors
â””â”€â”€ api-service.js       # Query by extendedStatus

Implementation Steps:
1. Update translateStatus() Ä‘á»ƒ handle extendedStatus
2. ThÃªm filter dropdown cho extendedStatus
3. ThÃªm badge colors cho tá»«ng status
4. Update renderDashboard() Ä‘á»ƒ hiá»ƒn thá»‹ Ä‘Ãºng

Status Badge Colors:
- NEW: #3b82f6 (blue)
- PENDING_RETURN: #f59e0b (amber)
- VIRTUAL_CREDIT_ISSUED: #8b5cf6 (purple)
- NEW_ORDER_PLACED: #06b6d4 (cyan)
- PENDING_RECOVERY: #f59e0b (amber)
- COMPLETED: #10b981 (green)
- EXPIRED_NO_ACTION: #ef4444 (red)
- LOGISTICS_ISSUE: #ef4444 (red)

Acceptance Criteria:
â–¡ Táº¥t cáº£ 10+ tráº¡ng thÃ¡i cÃ³ badge riÃªng
â–¡ Filter theo extendedStatus hoáº¡t Ä‘á»™ng
â–¡ Thá»‘ng kÃª theo extendedStatus
```

#### [P1-4] UI Wallet Display â³ TODO

```
Files cáº§n sá»­a:
â”œâ”€â”€ index.html           # Wallet info panel
â”œâ”€â”€ script.js            # Fetch vÃ  display wallet
â””â”€â”€ style.css            # Wallet card styles

Implementation Steps:
1. ThÃªm section hiá»ƒn thá»‹ wallet trong customer info
2. Show balance + virtualBalance
3. Highlight warning náº¿u cÃ´ng ná»£ áº£o sáº¯p háº¿t háº¡n
4. Quick link xem transaction history

Acceptance Criteria:
â–¡ Hiá»ƒn thá»‹ sá»‘ dÆ° thá»±c + áº£o
â–¡ Warning cho cÃ´ng ná»£ áº£o < 3 ngÃ y
â–¡ Link xem lá»‹ch sá»­ giao dá»‹ch
```

---

### PHASE 2: AUTOMATION

#### [P2-1] SePay Webhook Integration â³ TODO

```
Files cáº§n táº¡o Má»šI:
â”œâ”€â”€ functions/
â”‚   â””â”€â”€ index.js         # Firebase Cloud Functions
â””â”€â”€ sepay-admin.html     # (Optional) Admin view

Implementation Steps:
1. Setup Firebase Cloud Functions project
2. Create webhook endpoint
3. Parse phone from content
4. Auto-deposit to wallet
5. Log all webhooks

Acceptance Criteria:
â–¡ Webhook nháº­n Ä‘Æ°á»£c tá»« SePay
â–¡ Parse SÄT tá»« ná»™i dung chuyá»ƒn khoáº£n
â–¡ Tá»± Ä‘á»™ng cá»™ng tiá»n vÃ o wallet
â–¡ Log Ä‘áº§y Ä‘á»§ Ä‘á»ƒ debug
```

#### [P2-2] Cron Jobs â³ TODO

```
Files cáº§n táº¡o Má»šI:
â””â”€â”€ cron-jobs.js         # Client-side polling

Implementation Steps:
1. Táº¡o CronJobs module
2. Job 1: expireVirtualCredits - cháº¡y má»—i giá»
3. Job 2: checkCarrierDeadlines - cháº¡y má»—i giá»
4. Log káº¿t quáº£ má»—i láº§n cháº¡y

Acceptance Criteria:
â–¡ CÃ´ng ná»£ áº£o tá»± Ä‘á»™ng expire sau 15 ngÃ y
â–¡ Ticket tá»± Ä‘á»™ng chuyá»ƒn LOGISTICS_ISSUE sau 10 ngÃ y
â–¡ KhÃ´ng cháº¡y quÃ¡ táº£i client

ğŸ“‹ DEFINITION OF DONE (Test Cases):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Test 1: Táº¡o virtualCredit vá»›i expiresAt = now - 1 ngÃ y                â”‚
â”‚         â†’ Cháº¡y expireVirtualCredits() â†’ status = 'EXPIRED'            â”‚
â”‚ Test 2: Ticket PENDING_RECOVERY vá»›i linkedOrderDeliveredAt = now - 11dâ”‚
â”‚         â†’ Cháº¡y checkCarrierDeadlines() â†’ extendedStatus = 'LOGISTICS' â”‚
â”‚ Test 3: Console.log cho tháº¥y "[CRON] Running..." má»—i giá»              â”‚
â”‚ Test 4: KhÃ´ng block UI khi cron Ä‘ang cháº¡y                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### [P2-3] TPOS API - Create Return Invoice â³ TODO

```
Files cáº§n sá»­a:
â”œâ”€â”€ api-service.js       # createReturnInvoice()
â””â”€â”€ script.js            # Gá»i khi nháº¥n "ÄÃ£ nháº­n hÃ ng"

Implementation Steps:
1. Research TPOS API endpoint cho Phiáº¿u tráº£ hÃ ng
2. Implement createReturnInvoice()
3. Gá»i API sau khi kho xÃ¡c nháº­n nháº­n hÃ ng
4. LiÃªn káº¿t Phiáº¿u tráº£ vá»›i ticket

Acceptance Criteria:
â–¡ Táº¡o Ä‘Æ°á»£c Phiáº¿u tráº£ hÃ ng trÃªn TPOS
â–¡ Tá»“n kho TPOS Ä‘Æ°á»£c cáº­p nháº­t
â–¡ Ticket lÆ°u reference Ä‘áº¿n Phiáº¿u tráº£
```

#### [P2-4] Notification System â³ TODO

```
Files cáº§n táº¡o Má»šI:
â””â”€â”€ notification-service.js

Implementation Steps:
1. Toast notifications cho events
2. Sound alert cho urgent items
3. (Optional) Desktop notifications

Acceptance Criteria:
â–¡ Toast khi cÃ³ ticket má»›i
â–¡ Sound cho LOGISTICS_ISSUE, EXPIRED
â–¡ Desktop notification (vá»›i permission)
```

---

### PHASE 3: POLISH

#### [P3-1] Audit Trail â³ TODO

```
Implementation:
- ThÃªm actionHistory array vÃ o ticket
- Log má»i action vá»›i user, timestamp
- UI xem history trong ticket detail

Acceptance Criteria:
â–¡ Má»i action Ä‘á»u Ä‘Æ°á»£c log
â–¡ CÃ³ UI xem history
â–¡ Export Ä‘Æ°á»£c audit log
```

#### [P3-2] Reports & Analytics â³ TODO

```
Implementation:
- BÃ¡o cÃ¡o theo ngÃ y/tuáº§n/thÃ¡ng
- Thá»‘ng kÃª theo loáº¡i ticket
- Tá»•ng tiá»n Ä‘Ã£ Ä‘á»‘i soÃ¡t

Acceptance Criteria:
â–¡ Chart thá»‘ng kÃª
â–¡ Export Excel
â–¡ Filter theo date range
```

---

## C3. Dependency Graph

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  [P0-1] TPOS API â”‚ âœ… DONE
                    â”‚   searchOrders   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
              â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   [P0-2]    â”‚  â”‚   [P1-1]    â”‚  â”‚   [P1-3]    â”‚
    â”‚  Firebase   â”‚  â”‚   Wallet    â”‚  â”‚  Extended   â”‚
    â”‚ Subscriptionâ”‚  â”‚   Module    â”‚  â”‚   Status    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚                â”‚                â”‚
           â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”         â”‚
           â”‚         â–¼             â–¼         â”‚
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚  â”‚   [P1-2]    â”‚ â”‚ [P1-4]  â”‚   â”‚
           â”‚  â”‚ Virtual     â”‚ â”‚ Wallet  â”‚   â”‚
           â”‚  â”‚ Credit Flow â”‚ â”‚   UI    â”‚   â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚
           â”‚         â”‚             â”‚        â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
              â–¼             â–¼             â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ [P2-1]   â”‚  â”‚ [P2-2]   â”‚  â”‚ [P2-3]   â”‚
       â”‚ SePay    â”‚  â”‚ Cron     â”‚  â”‚ TPOS     â”‚
       â”‚ Webhook  â”‚  â”‚ Jobs     â”‚  â”‚ Return   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

<a id="phan-d"></a>
# PHáº¦N D: TIáº¾N Äá»˜ VÃ€ CHANGELOG

## D1. Tiáº¿n Ä‘á»™ thá»±c hiá»‡n

### Phase 0: Critical Fix
- [x] **[P0-1]** TÃ­ch há»£p TPOS API searchOrders() - _HoÃ n thÃ nh 2026-01-05_
- [x] **[P0-2]** Firebase realtime subscription - _HoÃ n thÃ nh 2026-01-06_

### Phase 1: Core Features
- [ ] **[P1-1]** Module Customer Wallet
- [ ] **[P1-2]** Flow "Thu Vá»" vá»›i CÃ´ng ná»£ áº£o
- [ ] **[P1-3]** Extended Status system
- [ ] **[P1-4]** UI Wallet display

### Phase 2: Automation
- [ ] **[P2-1]** SePay Webhook Integration
- [ ] **[P2-2]** Cron Jobs
- [ ] **[P2-3]** TPOS Create Return Invoice
- [ ] **[P2-4]** Notification System

### Phase 3: Polish
- [ ] **[P3-1]** Audit Trail
- [ ] **[P3-2]** Reports & Analytics
- [ ] **[P3-3]** Mobile Responsive

---

## D2. Changelog

| NgÃ y | PhiÃªn báº£n | Thay Ä‘á»•i | NgÆ°á»i thá»±c hiá»‡n |
|------|-----------|----------|-----------------|
| 2026-01-04 | 1.0 | Táº¡o file business_flow_documentation.md | AI |
| 2026-01-04 | 2.0 | Táº¡o file TECHNICAL_SPEC_AND_IMPLEMENTATION_PLAN.md | AI |
| 2026-01-05 | 3.0 | HoÃ n thÃ nh [P0-1] - TPOS API searchOrders | AI |
| 2026-01-06 | 4.0 | Gá»™p 3 file thÃ nh MASTER_DOCUMENTATION.md | AI |
| 2026-01-06 | 5.0 | **Báº£n Thiáº¿t Káº¿ Thá»±c Thi Tuyá»‡t Äá»‘i** - Bá»• sung: | AI |
| | | - PROJECT CONTEXT (vá»‹ trÃ­ file, import order, env vars) | |
| | | - UI/UX STANDARDS (design tokens, layout, components) | |
| | | - GLOBAL STATE (AppState object, patterns) | |
| | | - SECURITY & DATA INTEGRITY (Firebase rules, RBAC, atomic transactions) | |
| | | - CÃ”NG THá»¨C TÃ€I CHÃNH (LaTeX formulas) | |
| | | - DEFINITION OF DONE cho má»—i task | |
| 2026-01-06 | 5.1 | Bá»• sung thÃªm Ä‘á»ƒ tá»‘i Æ°u AI Ä‘á»c: | AI |
| | | - ğŸš¨ ERROR MATRIX (ma tráº­n xá»­ lÃ½ lá»—i Ä‘áº§y Ä‘á»§) | |
| | | - âš¡ QUY Táº®C Cáº¬P NHáº¬T NGÆ¯á»¢C (critical rule) | |
| | | - ğŸ“‘ Má»¤C Lá»¤C theo thá»© tá»± Æ°u tiÃªn Ä‘á»c | |
| | | - ğŸ“– HÆ°á»›ng dáº«n cÃ¡ch Ä‘á»c tÃ i liá»‡u cho AI | |
| 2026-01-06 | 5.2 | Fix anchor links cho TOC navigation: | AI |
| | | - ThÃªm `<a id="...">` tags cho táº¥t cáº£ sections cÃ³ emoji | |
| | | - Cáº­p nháº­t TOC Jump links dÃ¹ng clean anchor IDs | |
| | | - Anchors: error-matrix, project-context, ui-standards, | |
| | | global-state, security, formulas, phan-a/b/c/d | |
| 2026-01-06 | 5.3 | Cáº­p nháº­t [P0-2] Firebase Subscription: | AI |
| | | - ÄÃ¡nh dáº¥u DONE vÃ¬ Ä‘Ã£ hoáº¡t Ä‘á»™ng táº¡i script.js:41-47 | |
| | | - Subscription dÃ¹ng ApiService.subscribeToTickets() | |
| | | - PHASE 0 hoÃ n táº¥t, sáºµn sÃ ng cho PHASE 1 | |
| 2026-01-06 | 5.4 | Bá»• sung Ma tráº­n Luá»“ng Tráº¡ng thÃ¡i (A1.4): | AI |
| | | - ThÃªm báº£ng tá»•ng há»£p 4 luá»“ng chuyá»ƒn tráº¡ng thÃ¡i | |
| | | - Quick reference table cho AI Agent xÃ¡c Ä‘á»‹nh status | |
| | | - Ghi chÃº OTHER sáº½ hoÃ n thiá»‡n sau | |

---

## D3. Ghi chÃº cho láº§n lÃ m viá»‡c tiáº¿p theo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ NEXT SESSION TODO                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  âœ… PHASE 0 HOÃ€N Táº¤T!                                                       â”‚
â”‚                                                                             â”‚
â”‚  Task tiáº¿p theo cáº§n lÃ m: [P1-1] Module Customer Wallet                      â”‚
â”‚  - Táº¡o file wallet-service.js má»›i                                           â”‚
â”‚  - Implement theo spec á»Ÿ má»¥c B2.2                                           â”‚
â”‚  - Táº¡o cÃ¡c methods: getWallet, deposit, withdraw, issueVirtualCredit        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## D4. Coding Standards (Quy táº¯c code)

### Naming Conventions
```javascript
// Variables: camelCase
const ticketData = {};
const virtualCreditAmount = 0;

// Functions: camelCase, verb prefix
function getWallet() {}
function handleSubmitTicket() {}
async function createReturnInvoice() {}

// Constants: UPPER_SNAKE_CASE
const VIRTUAL_CREDIT_EXPIRY_DAYS = 15;
const CARRIER_RECOVERY_DAYS = 10;

// Firebase paths: snake_case
'issue_tracking/tickets'
'customer_wallets'
'wallet_transactions'
```

### Error Handling Pattern
```javascript
async function someOperation() {
  try {
    // Main logic
    const result = await ApiService.doSomething();
    return result;
  } catch (error) {
    console.error('[ModuleName] Operation failed:', error);
    throw error; // Re-throw for caller to handle
  }
}
```

### Comment Style
```javascript
/**
 * Brief description of function
 * @param {string} phone - Customer phone number
 * @param {number} amount - Amount to deposit
 * @returns {Promise<number>} New balance
 */
async function deposit(phone, amount) {
  // Implementation
}
```

---

## D5. Glossary (Thuáº­t ngá»¯)

| Thuáº­t ngá»¯ | Tiáº¿ng Anh | Giáº£i thÃ­ch |
|-----------|-----------|------------|
| TPOS | Third-party POS | Há»‡ thá»‘ng POS bÃªn thá»© 3 (master vá» tá»“n kho) |
| ÄVVC | Delivery Carrier | ÄÆ¡n vá»‹ váº­n chuyá»ƒn (GHN, SPX, VTP...) |
| COD | Cash On Delivery | Tiá»n thu há»™ |
| CÃ´ng ná»£ áº£o | Virtual Credit | Sá»‘ tiá»n táº¡m cáº¥p cho KH, cÃ³ thá»i háº¡n |
| Boom hÃ ng | Failed Delivery | KhÃ¡ch khÃ´ng nháº­n Ä‘Æ¡n, hÃ ng hoÃ n vá» |
| Thu vá» | Return Collection | Shipper thu há»“i hÃ ng cÅ© khi giao Ä‘Æ¡n má»›i |
| SePay | - | Dá»‹ch vá»¥ webhook theo dÃµi giao dá»‹ch ngÃ¢n hÃ ng |
| VÃ­ | Wallet | Sá»‘ dÆ° cÃ´ng ná»£ cá»§a khÃ¡ch hÃ ng |

---

*TÃ i liá»‡u nÃ y lÃ  nguá»“n thÃ´ng tin duy nháº¥t (Single Source of Truth) cho há»‡ thá»‘ng Issue Tracking. Má»i thay Ä‘á»•i code PHáº¢I Ä‘Æ°á»£c cáº­p nháº­t vÃ o Ä‘Ã¢y.*
