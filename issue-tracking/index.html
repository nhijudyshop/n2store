<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω S·ª± v·ª• & ƒêi·ªÅu ph·ªëi sau b√°n h√†ng</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- Mermaid.js for Flow Diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <!-- Lucide Icons for Notifications -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>CSKH v√† Qu·∫£n L√Ω</h1>
                <p class="subtitle">Theo d√µi h√†ng ho√†n, s·ª≠a COD v√† x·ª≠ l√Ω c√¥ng n·ª£</p>
            </div>
            <div class="header-right">
                <button id="btn-create-ticket" class="btn btn-primary">+ T·∫°o Phi·∫øu M·ªõi</button>
                <button id="btn-open-reconcile" class="btn btn-secondary"
                    style="margin-left: 10px; background: #8b5cf6; border: none;">üìã ƒê·ªëi So√°t</button>
                <button id="btn-open-settings" class="btn btn-secondary"
                    style="margin-left: 10px; background: #64748b; border: none; padding: 8px 12px;" title="C√†i ƒë·∫∑t">‚öôÔ∏è</button>
            </div>

        </header>

        <!-- Dashboard Stats (Optional, nice to have) -->
        <div class="stats-overview">
            <div class="stat-card">
                <h3>Ch·ªù H√†ng V·ªÅ</h3>
                <p id="count-pending-goods" class="stat-number">0</p>
            </div>
            <div class="stat-card">
                <h3>Ch·ªù ƒê·ªëi So√°t</h3>
                <p id="count-pending-finance" class="stat-number">0</p>
            </div>
            <div class="stat-card">
                <h3>Ho√†n T·∫•t H√¥m Nay</h3>
                <p id="count-completed-today" class="stat-number">0</p>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn" data-tab="all">
                    T·∫•t c·∫£ s·ª± v·ª•
                </button>
                <button class="tab-btn active" data-tab="pending-goods">
                    Ch·ªù H√†ng V·ªÅ
                    <span class="badge" id="badge-pending-goods">0</span>
                </button>
                <button class="tab-btn" data-tab="pending-finance">
                    Ch·ªù ƒê·ªëi So√°t Ti·ªÅn
                    <span class="badge" id="badge-pending-finance">0</span>
                </button>
                <button class="tab-btn" data-tab="completed">
                    Ho√†n T·∫•t
                </button>
            </div>

            <!-- Guide Section (Dynamic) -->
            <div id="tab-guide" class="guide-panel hidden">
                <div class="guide-header">
                    <span class="guide-icon">‚ÑπÔ∏è</span>
                    <h4 id="guide-title">H∆∞·ªõng d·∫´n</h4>
                    <button class="btn-toggle-guide" onclick="toggleGuide()">‚ñº</button>
                </div>
                <div id="guide-content" class="guide-body">
                    <!-- Content injected by JS -->
                </div>
            </div>

            <!-- Filters (Simplified) -->
            <div class="filters-bar">
                <input type="text" id="search-ticket" placeholder="T√¨m theo SƒêT, M√£ ƒë∆°n..." class="search-input">
                <select id="filter-type" class="select-input">
                    <option value="all">T·∫•t c·∫£ lo·∫°i</option>
                    <option value="BOOM">Boom h√†ng</option>
                    <option value="RETURN_SHIPPER">Thu v·ªÅ (Shipper)</option>
                    <option value="RETURN_CLIENT">Kh√°ch g·ª≠i</option>
                    <option value="FIX_COD">S·ª≠a COD</option>
                </select>
            </div>

            <!-- Data Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width:8%;">M√£ ƒë∆°n / ID</th>
                            <th style="width:12%;">Kh√°ch h√†ng</th>
                            <th style="width:9%;">Lo·∫°i & K√™nh</th>
                            <th>Ghi Ch√∫ / S·∫£n Ph·∫©m</th>
                            <th style="width:10%;">T√†i ch√≠nh</th>
                            <th style="width:14%;">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="ticket-list-body">
                        <!-- Rows will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Modal: Create Ticket -->
    <div id="modal-create-ticket" class="modal">
        <div class="modal-content large-modal">
            <span class="close-modal">&times;</span>
            <h2>T·∫°o Phi·∫øu M·ªõi</h2>

            <!-- Step 1: Search Order -->
            <div class="form-group search-section">
                <label>T√¨m ƒë∆°n h√†ng g·ªëc</label>
                <div class="input-group">
                    <input type="text" id="order-search-input" placeholder="Nh·∫≠p SƒêT ho·∫∑c M√£ v·∫≠n ƒë∆°n">
                    <button id="btn-search-order" class="btn btn-secondary">T√¨m</button>
                </div>
                <div id="order-result" class="order-resultbox hidden">
                    <!-- Order details will appear here -->
                    <div class="order-info-header">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <div>
                                <strong>Kh√°ch:</strong> <span id="res-customer"></span> - <span id="res-phone"></span>
                                <span style="margin-left:15px;">|</span>
                                <strong style="margin-left:15px;">M√£ ƒêH:</strong> <span id="res-order-code"></span>
                            </div>
                        </div>
                        <div style="margin-bottom:10px;">
                            <strong>ƒê·ªãa ch·ªâ:</strong> <span id="res-address"></span>
                        </div>
                    </div>

                    <!-- Customer Info Section (Dynamically updated by JS) -->
                    <div id="customer-info-section" class="customer-info-section hidden" style="margin-top: 10px; padding: 10px; background: #e0f2f7; border-left: 5px solid #00bcd4; border-radius: 4px;">
                        <p style="margin: 0; font-size: 14px; font-weight: 500; color: #263238;">
                            <strong>Kh√°ch h√†ng:</strong> <span id="customer-info-name">N/A</span> (<span id="customer-info-phone">N/A</span>)
                        </p>
                        <p style="margin: 5px 0 0; font-size: 12px; color: #455a64;">
                            C·∫•p b·∫≠c: <span id="customer-info-tier">N/A</span> | S·ªë d∆∞ v√≠: <span id="customer-info-wallet-balance">0ƒë</span>
                        </p>
                        <p id="customer-info-new-customer-warning" class="hidden" style="margin: 5px 0 0; font-size: 12px; color: #f44336; font-weight: 500;">
                            ‚ö†Ô∏è Kh√°ch h√†ng m·ªõi s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông khi t·∫°o phi·∫øu n√†y.
                        </p>
                    </div>

                    <!-- Products Table -->
                    <div class="order-products-section">
                        <h4 style="margin:10px 0 8px 0;font-size:14px;font-weight:600;">S·∫£n ph·∫©m:</h4>
                        <table class="products-mini-table" style="width:100%;border-collapse:collapse;font-size:12px;">
                            <thead>
                                <tr style="background:#f8fafc;border-bottom:1px solid #e2e8f0;">
                                    <th style="padding:6px 8px;text-align:left;font-weight:600;">S·∫£n ph·∫©m</th>
                                    <th style="padding:6px 8px;text-align:center;width:80px;font-weight:600;">S·ªë l∆∞·ª£ng
                                    </th>
                                    <th style="padding:6px 8px;text-align:right;width:90px;font-weight:600;">ƒê∆°n gi√°
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="res-products-table">
                                <!-- Products will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Order Summary -->
                    <div class="order-summary"
                        style="margin-top:12px;padding:10px;background:#f8fafc;border-radius:6px;font-size:12px;">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                            <div><strong>T·ªïng s·ªë l∆∞·ª£ng:</strong> <span id="res-total-qty">0</span></div>
                            <div><strong>T·ªïng:</strong> <span id="res-amount-total">0ƒë</span></div>
                            <div><strong>Gi·∫£m gi√°:</strong> <span id="res-decrease-amount">0ƒë</span></div>
                            <div><strong>Ship:</strong> <span id="res-delivery-price">0ƒë</span></div>
                            <div><strong>T·ªïng ti·ªÅn:</strong> <span id="res-final-total"
                                    style="color:#ef4444;font-weight:600;">0ƒë</span></div>
                            <div><strong>C√¥ng n·ª£:</strong> <span id="res-payment-amount">0ƒë</span></div>
                            <div><strong>COD:</strong> <span id="res-cod"
                                    style="color:#3b82f6;font-weight:600;">0ƒë</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Issue Details -->
            <div id="issue-details-form" class="hidden">
                <div class="form-group">
                    <label>Tr∆∞·ªùng H·ª£p</label>
                    <select id="issue-type-select" class="select-input full-width">
                        <option value="">-- Ch·ªçn lo·∫°i --</option>
                        <option value="FIX_COD">S·ª≠a COD (Shipper g·ªçi)</option>
                        <option value="RETURN_CLIENT">Kh√°ch G·ª≠i (T·ªânh/B∆∞u c·ª•c)</option>
                        <option value="RETURN_SHIPPER">Thu V·ªÅ (Shipper/TP)</option>
                        <option value="BOOM">Boom H√†ng (Kh√°ch kh√¥ng nh·∫≠n)</option>
                        <option value="OTHER">CSKH / V·∫•n ƒë·ªÅ kh√°c</option>
                    </select>
                </div>

                <!-- Dynamic Fields based on Type -->
                <div id="dynamic-fields">
                    <!-- FIX COD Fields -->
                    <div class="field-group hidden" data-type="FIX_COD">
                        <div class="form-row">
                            <div class="form-group half">
                                <label>COD Gi·∫£m</label>
                                <div style="display:flex;gap:6px;align-items:center;">
                                    <input type="number" id="cod-reduce-amount" class="select-input" placeholder="0"
                                           oninput="calculateCodRemaining()" style="flex:1;">
                                    <button type="button" id="btn-edit-cod-reduce" onclick="toggleCodReduceEdit()"
                                            style="display:none;padding:8px 10px;border:1px solid #e0e7ff;border-radius:6px;background:#f8fafc;cursor:pointer;"
                                            title="Ch·ªânh s·ª≠a th·ªß c√¥ng">
                                        ‚úèÔ∏è
                                    </button>
                                </div>
                            </div>
                            <div class="form-group half">
                                <label>L√Ω do</label>
                                <select id="fix-cod-reason" class="select-input" onchange="onFixCodReasonChange()">
                                    <option value="WRONG_SHIP">T√≠nh sai ship</option>
                                    <option value="CUSTOMER_DEBT">Tr·ª´ c√¥ng n·ª£ kh√°ch</option>
                                    <option value="DISCOUNT">Gi·∫£m gi√°/L·∫ª ti·ªÅn</option>
                                    <option value="REJECT_PARTIAL">Kh√°ch nh·∫≠n 1 ph·∫ßn</option>
                                </select>
                            </div>
                        </div>
                        <div style="display:flex;gap:20px;margin-top:8px;">
                            <p class="calc-hint" style="margin:0;">COD c√≤n ph·∫£i thu: <strong id="cod-remaining-display" style="color:#10b981;">0ƒë</strong></p>
                            <p class="calc-hint" style="margin:0;">Ph·∫£i tr·∫£ ƒêVVC: <strong id="cod-diff-display" style="color:#ef4444;">0ƒë</strong></p>
                        </div>
                    </div>

                    <!-- RETURN Details -->
                    <div class="field-group hidden" data-type="RETURN">
                        <div class="form-group">
                            <label>S·∫£n ph·∫©m ho√†n v·ªÅ</label>
                            <div id="product-checklist" class="product-checklist">
                                <!-- Checkboxes generated from order products -->
                            </div>
                        </div>
                        <div class="form-group hidden" id="tracking-input-group">
                            <label>M√£ v·∫≠n ƒë∆°n kh√°ch g·ª≠i (N·∫øu c√≥)</label>
                            <input type="text" id="return-tracking-code" placeholder="Nh·∫≠p m√£ ƒë∆°n kh√°ch g·ª≠i v·ªÅ">
                        </div>
                        <div class="form-group hidden" id="shipper-input-group">
                            <label>Shipper / ƒê·ªôi giao h√†ng</label>
                            <input type="text" id="return-shipper-name" placeholder="T√™n shipper mang v·ªÅ">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ghi ch√∫ n·ªôi b·ªô</label>
                    <textarea id="ticket-note" rows="2" placeholder="Chi ti·∫øt th√™m..."></textarea>
                </div>

                <div class="modal-actions">
                    <button id="btn-submit-ticket" class="btn btn-primary">X√°c Nh·∫≠n T·∫°o</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Confirm Action (Receive / Settle) -->
    <div id="modal-confirm-action" class="modal">
        <div class="modal-content small-modal">
            <span class="close-modal">&times;</span>
            <h2 id="confirm-title">X√°c nh·∫≠n</h2>
            <p id="confirm-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn?</p>

            <div id="confirm-extra-fields"></div>

            <div class="modal-actions">
                <button id="btn-confirm-yes" class="btn btn-primary">X√°c Nh·∫≠n</button>
                <button class="btn btn-secondary close-modal-btn">H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Modal: Reconcile Excel (NEW) -->
    <div id="modal-reconcile" class="modal">
        <div class="modal-content large-modal">
            <span class="close-modal">&times;</span>
            <h2>ƒê·ªëi So√°t & Quy·∫øt To√°n Excel</h2>

            <div class="reconcile-layout">
                <!-- Left: Input -->
                <div class="reconcile-input-section">
                    <label style="font-weight:600;display:block;margin-bottom:5px;">1. D√°n d·ªØ li·ªáu t·ª´ file Excel (Bao
                        g·ªìm SƒêT v√† C·ªôt 1)</label>
                    <textarea id="excel-input" placeholder="Copy c√°c c·ªôt t·ª´ Excel v√† d√°n v√†o ƒë√¢y...
V√≠ d·ª•:
80266...  325,000  ...  0977888999
..."></textarea>
                    <button id="btn-process-excel" class="btn btn-primary full-width" style="margin-top:10px;">üîç Ph√¢n
                        T√≠ch & So S√°nh</button>
                </div>

                <!-- Right: Summary -->
                <div class="reconcile-summary-section">
                    <div class="summary-card">
                        <small>T·ªïng ƒë∆°n Excel</small>
                        <strong id="rec-total-count">0</strong>
                    </div>
                    <div class="summary-card valid">
                        <small>H·ª£p l·ªá (Ready)</small>
                        <strong id="rec-valid-count">0</strong>
                    </div>
                    <div class="summary-card error">
                        <small>L·ªói / ·∫¢o</small>
                        <strong id="rec-error-count">0</strong>
                    </div>
                </div>
            </div>

            <!-- Result Table -->
            <div class="reconcile-table-wrapper hidden" id="reconcile-result-container">
                <label style="font-weight:600;display:block;margin:15px 0 5px;">2. K·∫øt qu·∫£ ƒë·ªëi so√°t chi ti·∫øt</label>
                <table class="data-table reconcile-table">
                    <thead>
                        <tr>
                            <th>D·ªØ li·ªáu Excel (SƒêT / ID)</th>
                            <th>Th√¥ng tin tr√™n H·ªá th·ªëng</th>
                            <th>Tr·∫°ng th√°i ƒê·ªëi So√°t</th>
                        </tr>
                    </thead>
                    <tbody id="reconcile-table-body">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>

            <div class="modal-actions sticky-footer">
                <div class="total-money-display">
                    T·ªïng ti·ªÅn thanh to√°n: <span id="rec-total-money">0ƒë</span>
                </div>
                <div>
                    <button id="btn-confirm-reconcile" class="btn btn-primary" disabled>‚úì Quy·∫øt To√°n (<span
                            id="btn-rec-count">0</span>)</button>
                    <button class="btn btn-secondary close-modal-btn">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Settings -->
    <div id="modal-settings" class="modal">
        <div class="modal-content small-modal">
            <span class="close-modal">&times;</span>
            <h2>‚öôÔ∏è C√†i ƒë·∫∑t</h2>

            <div class="settings-group">
                <div class="setting-item">
                    <div class="setting-info">
                        <label for="setting-print-bill">In bill khi nh·∫≠n h√†ng</label>
                        <p class="setting-desc">T·ª± ƒë·ªông m·ªü c·ª≠a s·ªï in phi·∫øu tr·∫£ h√†ng sau khi x·ª≠ l√Ω "Nh·∫≠n h√†ng"</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="setting-print-bill">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="modal-actions" style="margin-top: 20px;">
                <button id="btn-save-settings" class="btn btn-primary">L∆∞u c√†i ƒë·∫∑t</button>
                <button class="btn btn-secondary close-modal-btn">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- Shared API Utils -->
    <script src="../orders-report/js/core/api-config.js"></script>
    <script src="../orders-report/js/core/token-manager.js"></script>
    <script src="../orders-report/js/core/api-handler.js"></script>

    <!-- Module Scripts -->
    <script src="firebase-init.js"></script>
    <script src="api-service.js"></script>
    <script src="../shared/js/notification-system.js"></script>
    <script src="script.js"></script>
</body>

</html>