<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch sử biến động số dư - Sepay</title>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Modern CSS + Styles -->
    <link rel="stylesheet" href="modern.css">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i data-lucide="zap"></i>
                <span>N2Shop</span>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i data-lucide="panel-left-close"></i>
            </button>
        </div>

        <nav class="sidebar-nav" id="sidebarNav">
            <!-- Menu items auto-generated by navigation-modern.js -->
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    <i data-lucide="user-circle"></i>
                </div>
                <div class="user-details">
                    <div class="user-name" id="userName">Admin</div>
                    <div class="user-role">Quản trị viên</div>
                </div>
            </div>
            <button class="btn-permissions" id="btnPermissions">
                <i data-lucide="shield-check"></i>
                <span>Xem Quyền Của Tôi</span>
            </button>
            <button class="btn-logout" id="btnLogout">
                <i data-lucide="log-out"></i>
                <span>Đăng xuất</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <h1><i data-lucide="wallet"></i> Lịch sử biến động số dư</h1>
                    <div class="header-actions">
                        <!-- Inline QR Generator with Customer Info -->
                        <div class="inline-qr-form">
                            <input type="text" id="inlineCustomerName" class="inline-input"
                                placeholder="Tên khách hàng">
                            <input type="tel" id="inlineCustomerPhone" class="inline-input"
                                placeholder="SĐT (tùy chọn)">
                            <button id="inlineGenerateQRBtn" class="btn btn-success">
                                <i data-lucide="qr-code"></i> Tạo QR
                            </button>
                            <!-- Inline QR Display -->
                            <div id="inlineQRDisplay" class="inline-qr-display" style="display: none;">
                                <img id="inlineQRImage" src="" alt="QR Code">
                                <span id="inlineCustomerInfo" class="inline-customer-info"></span>
                                <span id="inlineQRCode" class="inline-qr-code"></span>
                                <button id="copyInlineQRBtn" class="btn btn-primary btn-sm" title="Copy hình QR">
                                    <i data-lucide="copy"></i>
                                </button>
                                <button id="closeInlineQRBtn" class="btn btn-secondary btn-sm" title="Đóng">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                        </div>

                        <button id="viewPhoneDataBtn" class="btn btn-info">
                            <i data-lucide="phone-outgoing"></i> Xem Phone Data
                        </button>
                        <button id="fetchNamesBtn" class="btn btn-success">
                            <i data-lucide="user-check"></i> Lấy Tên từ TPOS
                        </button>
                        <button id="viewRawDataBtn" class="btn btn-secondary">
                            <i data-lucide="database"></i> Xem Raw Data
                        </button>
                        <button id="refreshBtn" class="btn btn-primary">
                            <i data-lucide="refresh-cw"></i> Làm mới
                        </button>
                    </div>
                </div>
            </header>

            <!-- Statistics Cards -->
            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-icon stat-blue">
                        <i data-lucide="arrow-down"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Tổng tiền vào</h3>
                        <p class="stat-value" id="totalIn">0 ₫</p>
                        <small id="totalInCount">0 giao dịch</small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-red">
                        <i data-lucide="arrow-up"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Tổng tiền ra</h3>
                        <p class="stat-value" id="totalOut">0 ₫</p>
                        <small id="totalOutCount">0 giao dịch</small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-green">
                        <i data-lucide="scale"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Biến động ròng</h3>
                        <p class="stat-value" id="netChange">0 ₫</p>
                        <small id="totalTransactions">0 giao dịch</small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-purple">
                        <i data-lucide="banknote"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Số dư hiện tại</h3>
                        <p class="stat-value" id="latestBalance">0 ₫</p>
                        <small>Cập nhật mới nhất</small>
                    </div>
                </div>

                <!-- Gap Detection Card -->
                <div class="stat-card" id="gapCard" style="display: none; cursor: pointer;" onclick="showGapsModal()">
                    <div class="stat-icon" style="background: #fef3c7; color: #d97706;">
                        <i data-lucide="alert-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Giao dịch thiếu</h3>
                        <p class="stat-value" id="totalGaps" style="color: #d97706;">0</p>
                        <small id="gapHint">Nhấn để xem chi tiết</small>
                    </div>
                </div>
            </div>

            <!-- Quick Date Filters -->
            <div class="quick-filters">
                <label><i data-lucide="calendar-clock"></i> Bộ lọc nhanh:</label>
                <div class="quick-filter-buttons">
                    <button class="btn-quick-filter" data-filter="today">
                        <i data-lucide="calendar-days"></i> Hôm nay
                    </button>
                    <button class="btn-quick-filter" data-filter="yesterday">
                        <i data-lucide="calendar-minus"></i> Hôm qua
                    </button>
                    <button class="btn-quick-filter" data-filter="thisWeek">
                        <i data-lucide="calendar-range"></i> Tuần này
                    </button>
                    <button class="btn-quick-filter" data-filter="lastWeek">
                        <i data-lucide="calendar-range"></i> Tuần trước
                    </button>
                    <button class="btn-quick-filter active" data-filter="thisMonth">
                        <i data-lucide="calendar"></i> Tháng này
                    </button>
                    <button class="btn-quick-filter" data-filter="lastMonth">
                        <i data-lucide="calendar"></i> Tháng trước
                    </button>
                    <button class="btn-quick-filter" data-filter="last7days">
                        <i data-lucide="calendar-clock"></i> 7 ngày qua
                    </button>
                    <button class="btn-quick-filter" data-filter="last30days">
                        <i data-lucide="calendar-clock"></i> 30 ngày qua
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label><i data-lucide="filter"></i> Loại giao dịch:</label>
                    <select id="filterType" class="filter-select">
                        <option value="">Tất cả</option>
                        <option value="in">Tiền vào</option>
                        <option value="out">Tiền ra</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i data-lucide="landmark"></i> Ngân hàng:</label>
                    <input type="text" id="filterGateway" class="filter-input" placeholder="VD: Vietcombank">
                </div>

                <div class="filter-group">
                    <label><i data-lucide="calendar"></i> Từ ngày:</label>
                    <input type="date" id="filterStartDate" class="filter-input">
                </div>

                <div class="filter-group">
                    <label><i data-lucide="calendar"></i> Đến ngày:</label>
                    <input type="date" id="filterEndDate" class="filter-input">
                </div>

                <div class="filter-group">
                    <label><i data-lucide="search"></i> Tìm kiếm:</label>
                    <input type="text" id="filterSearch" class="filter-input" placeholder="Tên KH, SĐT, nội dung...">
                </div>

                <div class="filter-group">
                    <label><i data-lucide="banknote"></i> Số tiền:</label>
                    <input type="text" id="filterAmount" class="filter-input" placeholder="VD: 100000 hoặc 100k">
                </div>

                <button id="applyFiltersBtn" class="btn btn-success">
                    <i data-lucide="check"></i> Áp dụng
                </button>

                <button id="resetFiltersBtn" class="btn btn-secondary">
                    <i data-lucide="rotate-ccw"></i> Đặt lại
                </button>

                <button id="filterGapsOnlyBtn" class="btn btn-warning" style="background: #fef3c7; color: #92400e; border: 1px solid #f59e0b;">
                    <i data-lucide="alert-triangle"></i> Chỉ GD thiếu
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading" style="display: none;">
                <i data-lucide="loader-2"></i> Đang tải dữ liệu...
            </div>

            <!-- Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ngày giờ</th>
                            <th>Ngân hàng</th>
                            <th>Loại</th>
                            <th>Số tiền</th>
                            <th>Số dư</th>
                            <th>Nội dung</th>
                            <th>Mã tham chiếu</th>
                            <th>Tên khách hàng</th>
                            <th>Số điện thoại</th>
                            <th>QR Code</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination">
                <button id="prevPageBtn" class="btn btn-secondary" disabled>
                    <i data-lucide="chevron-left"></i> Trước
                </button>
                <span id="pageInfo">Trang 1 / 1</span>
                <button id="nextPageBtn" class="btn btn-secondary" disabled>
                    Sau <i data-lucide="chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i data-lucide="info"></i> Chi tiết giao dịch</h2>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Detail will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Raw Data Modal -->
    <div id="rawDataModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h2><i data-lucide="database"></i> Raw Data - Toàn bộ dữ liệu SQL</h2>
                <button class="modal-close" id="closeRawDataModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <button id="copyRawDataBtn" class="btn btn-primary btn-sm">
                        <i data-lucide="copy"></i> Copy JSON
                    </button>
                    <button id="downloadRawDataBtn" class="btn btn-success btn-sm">
                        <i data-lucide="download"></i> Download JSON
                    </button>
                    <span id="rawDataCount" style="margin-left: auto; color: #666;"></span>
                </div>
                <div id="rawDataContent"
                    style="max-height: 70vh; overflow: auto; background: #f5f5f5; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;">
                    <!-- Raw data will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i data-lucide="qr-code"></i> QR Chuyển Khoản</h2>
                <button class="modal-close" id="closeQRModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="qrModalBody" style="text-align: center;">
                <!-- QR code will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Customer List By Phone Modal -->
    <div id="customerListModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <div class="modal-header">
                <h2><i data-lucide="users"></i> Khách hàng với SĐT: <span id="customerListPhone"></span></h2>
                <button class="modal-close" id="closeCustomerListModalBtn">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Loading State -->
                <div id="customerListLoading" style="text-align: center; padding: 40px; display: none;">
                    <i data-lucide="loader-2" class="animate-spin"
                        style="width: 48px; height: 48px; color: #3b82f6;"></i>
                    <p style="margin-top: 15px; color: #6b7280;">Đang tải danh sách khách hàng...</p>
                </div>

                <!-- Empty State -->
                <div id="customerListEmpty" style="text-align: center; padding: 40px; display: none;">
                    <i data-lucide="user-x" style="width: 48px; height: 48px; color: #9ca3af;"></i>
                    <p style="margin-top: 15px; color: #6b7280;">Không tìm thấy khách hàng với số điện thoại này</p>
                </div>

                <!-- Customer List -->
                <div id="customerListContent" style="display: none;">
                    <div id="customerListCount"
                        style="margin-bottom: 15px; padding: 10px; background: #f0f9ff; border-radius: 8px; color: #0369a1;">
                        <i data-lucide="info" style="width: 16px; height: 16px; vertical-align: middle;"></i>
                        <span>Tìm thấy <strong id="customerListTotal">0</strong> khách hàng</span>
                    </div>
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Tên</th>
                                <th>TPOS ID</th>
                                <th>Trạng thái</th>
                                <th>Tổng Công Nợ</th>
                                <th>Địa chỉ</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="customerListTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 15px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <a href="../customer-management/index.html" target="_blank" class="btn btn-primary"
                    style="text-decoration: none;">
                    <i data-lucide="external-link"></i> Mở Customer Management
                </a>
                <button class="btn btn-secondary" onclick="closeCustomerListModal()">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Edit Customer Info Modal -->
    <div id="editCustomerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i data-lucide="user-pen"></i> Chỉnh sửa thông tin khách hàng</h2>
                <button class="modal-close" id="closeEditCustomerModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editCustomerForm" style="display: flex; flex-direction: column; gap: 15px;">
                    <div
                        style="padding: 10px; background: #f8f9fa; border-radius: 6px; font-family: monospace; font-size: 13px; color: #495057;">
                        <strong>Mã giao dịch:</strong> <span id="editCustomerUniqueCode"></span>
                    </div>

                    <div>
                        <label for="editCustomerName" style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <i data-lucide="user" style="width: 16px; height: 16px; vertical-align: middle;"></i> Tên
                            khách hàng:
                        </label>
                        <input type="text" id="editCustomerName" class="filter-input" placeholder="Nhập tên khách hàng"
                            style="width: 100%;">
                    </div>

                    <div>
                        <label for="editCustomerPhone" style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <i data-lucide="phone" style="width: 16px; height: 16px; vertical-align: middle;"></i> Số
                            điện thoại:
                        </label>
                        <input type="tel" id="editCustomerPhone" class="filter-input" placeholder="Nhập số điện thoại"
                            style="width: 100%;">
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i data-lucide="save"></i> Lưu thông tin
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelEditCustomerBtn" style="flex: 1;">
                            <i data-lucide="x"></i> Hủy
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Missing Transactions (Gaps) Modal -->
    <div id="gapsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2><i data-lucide="alert-triangle"></i> Giao dịch bị thiếu</h2>
                <button class="modal-close" id="closeGapsModalBtn">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Loading State -->
                <div id="gapsLoading" style="text-align: center; padding: 40px;">
                    <i data-lucide="loader-2" class="animate-spin" style="width: 48px; height: 48px; color: #d97706;"></i>
                    <p style="margin-top: 15px; color: #6b7280;">Đang phân tích mã tham chiếu...</p>
                </div>

                <!-- Empty State -->
                <div id="gapsEmpty" style="text-align: center; padding: 40px; display: none;">
                    <i data-lucide="check-circle" style="width: 48px; height: 48px; color: #10b981;"></i>
                    <p style="margin-top: 15px; color: #10b981; font-weight: 600;">Không có giao dịch thiếu!</p>
                    <p style="color: #6b7280;">Tất cả mã tham chiếu đều liên tục.</p>
                </div>

                <!-- Gaps List -->
                <div id="gapsContent" style="display: none;">
                    <div id="gapsInfo" style="margin-bottom: 15px; padding: 12px; background: #fef3c7; border-left: 4px solid #d97706; border-radius: 4px;">
                        <i data-lucide="info" style="width: 16px; height: 16px; vertical-align: middle;"></i>
                        <span>Phát hiện <strong id="gapsTotal">0</strong> mã tham chiếu bị thiếu trong hệ thống.</span>
                        <p style="margin-top: 8px; font-size: 13px; color: #92400e;">
                            Đây có thể là các giao dịch webhook bị lỗi hoặc không nhận được.
                        </p>
                    </div>

                    <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <button id="detectGapsBtn" class="btn btn-primary btn-sm">
                            <i data-lucide="search"></i> Quét lại
                        </button>
                        <button id="retryAllGapsBtn" class="btn btn-success btn-sm">
                            <i data-lucide="refresh-cw"></i> Retry Failed Queue
                        </button>
                    </div>

                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Mã tham chiếu thiếu</th>
                                <th>Trước đó</th>
                                <th>Sau đó</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="gapsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer" style="padding: 15px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeGapsModal()">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Phone Data Modal -->
    <div id="phoneDataModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
            <div class="modal-header">
                <h2><i data-lucide="phone-outgoing"></i> Dữ liệu Phone từ Balance Customer Info</h2>
                <button class="modal-close" id="closePhoneDataModalBtn">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Loading State -->
                <div id="phoneDataLoading" style="text-align: center; padding: 40px;">
                    <i data-lucide="loader-2" class="animate-spin" style="width: 48px; height: 48px; color: #3b82f6;"></i>
                    <p style="margin-top: 15px; color: #6b7280;">Đang tải dữ liệu...</p>
                </div>

                <!-- Empty State -->
                <div id="phoneDataEmpty" style="text-align: center; padding: 40px; display: none;">
                    <i data-lucide="inbox" style="width: 48px; height: 48px; color: #9ca3af;"></i>
                    <p style="margin-top: 15px; color: #6b7280;">Chưa có dữ liệu phone nào!</p>
                    <p style="color: #9ca3af; font-size: 14px;">Click nút "Cập nhật Phone" để extract phone từ transactions.</p>
                </div>

                <!-- Phone Data Table -->
                <div id="phoneDataContent" style="display: none;">
                    <div style="margin-bottom: 15px; padding: 12px; background: #e0f2fe; border-left: 4px solid #3b82f6; border-radius: 4px;">
                        <i data-lucide="info" style="width: 16px; height: 16px; vertical-align: middle;"></i>
                        <span>Tổng: <strong id="phoneDataTotal">0</strong> records | Hiển thị: <strong id="phoneDataShown">0</strong></span>
                    </div>

                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 180px;">Unique Code</th>
                                <th style="width: 120px;">Phone</th>
                                <th style="width: 200px;">Customer Name</th>
                                <th style="width: 150px;">Extraction Note</th>
                                <th style="width: 120px;">Fetch Status</th>
                                <th style="width: 150px;">Created At</th>
                                <th style="width: 150px;">Updated At</th>
                            </tr>
                        </thead>
                        <tbody id="phoneDataTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer" style="padding: 15px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between;">
                <div>
                    <button id="refreshPhoneDataBtn" class="btn btn-primary btn-sm">
                        <i data-lucide="refresh-cw"></i> Làm mới
                    </button>
                </div>
                <button class="btn btn-secondary" onclick="closePhoneDataModal()">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../js/firebase-config.js"></script>

    <!-- Navigation & Auth -->
    <script src="../js/navigation-modern.js"></script>

    <!-- Page Scripts -->
    <script src="auth.js"></script>
    <script src="cache.js"></script>
    <script src="config.js"></script>
    <script src="qr-generator.js"></script>
    <script src="customer-info.js"></script>
    <script src="main.js"></script>

    <!-- Initialize Lucide Icons -->
    <script>
        lucide.createIcons();
    </script>
</body>

</html>