<!--
  üìñ GHI CH√ö CHO L·∫¨P TR√åNH VI√äN:
  Khi code ph·∫£i ƒë·ªçc th∆∞ m·ª•c https://github.com/nhijudyshop/n2store/tree/main/docs tr∆∞·ªõc!
  ƒê·ªçc c√°c file SHARED_*.md ƒë·ªÉ hi·ªÉu c√°ch s·ª≠ d·ª•ng shared modules.
-->
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch s·ª≠ bi·∫øn ƒë·ªông s·ªë d∆∞ - Sepay</title>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Modern CSS + Styles -->
    <link rel="stylesheet" href="css/modern.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/transfer-stats.css">
</head>

<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i data-lucide="zap"></i>
                <span>N2Shop</span>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i data-lucide="panel-left-close"></i>
            </button>
        </div>

        <nav class="sidebar-nav" id="sidebarNav">
            <!-- Menu items auto-generated by navigation-modern.js -->
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    <i data-lucide="user-circle"></i>
                </div>
                <div class="user-details">
                    <div class="user-name" id="userName">Admin</div>
                    <div class="user-role">Qu·∫£n tr·ªã vi√™n</div>
                </div>
            </div>
            <button class="btn-permissions" id="btnPermissions">
                <i data-lucide="shield-check"></i>
                <span>Xem Quy·ªÅn C·ªßa T√¥i</span>
            </button>
            <button class="btn-logout" id="btnLogout">
                <i data-lucide="log-out"></i>
                <span>ƒêƒÉng xu·∫•t</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <!-- Main Section Tabs -->
            <div class="main-tabs">
                <button class="main-tab active" data-section="balance-history" onclick="switchMainTab('balance-history')">
                    <i data-lucide="wallet"></i> L·ªãch s·ª≠ bi·∫øn ƒë·ªông s·ªë d∆∞
                </button>
                <button class="main-tab" data-section="transfer-stats" onclick="switchMainTab('transfer-stats')">
                    <i data-lucide="clipboard-check"></i> Th·ªëng K√™ Chuy·ªÉn Kho·∫£n
                    <span id="uncheckedBadge" class="unchecked-badge" style="display: none;">0</span>
                </button>
            </div>

            <!-- Tab Panel: Balance History -->
            <div id="balanceHistoryPanel" class="main-tab-panel active">

            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <h1 style="font-size: 1.2rem;"><i data-lucide="wallet"></i> L·ªãch s·ª≠ bi·∫øn ƒë·ªông s·ªë d∆∞</h1>
                    <div class="header-actions">
                        <!-- Inline QR Generator with Customer Info -->
                        <div class="inline-qr-form">
                            <input type="text" id="inlineCustomerName" class="inline-input" placeholder="T√™n kh√°ch h√†ng"
                                style="display: none;">
                            <input type="tel" id="inlineCustomerPhone" class="inline-input" placeholder="SƒêT">
                            <button id="inlineGenerateQRBtn" class="btn btn-success">
                                <i data-lucide="qr-code"></i> T·∫°o QR
                            </button>
                            <!-- Inline QR Display -->
                            <div id="inlineQRDisplay" class="inline-qr-display" style="display: none;">
                                <img id="inlineQRImage" src="" alt="QR Code">
                                <span id="inlineCustomerInfo" class="inline-customer-info"></span>
                                <span id="inlineQRCode" class="inline-qr-code"></span>
                                <button id="copyInlineQRBtn" class="btn btn-primary btn-sm" title="Copy h√¨nh QR">
                                    <i data-lucide="copy"></i>
                                </button>
                                <button id="closeInlineQRBtn" class="btn btn-secondary btn-sm" title="ƒê√≥ng">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                        </div>

                        <button id="viewPhoneDataBtn" class="btn btn-info">
                            <i data-lucide="phone-outgoing"></i> Xem Phone Data
                        </button>
                        <button id="reprocessOldTransactionsBtn" class="btn btn-warning" style="display: none;">
                            <i data-lucide="rotate-cw"></i> X·ª≠ l√Ω l·∫°i GD c≈©
                        </button>
                        <button id="fetchNamesBtn" class="btn btn-success" style="display: none;">
                            <i data-lucide="user-check"></i> L·∫•y T√™n t·ª´ TPOS
                        </button>
                        <button id="viewRawDataBtn" class="btn btn-secondary" style="display: none;">
                            <i data-lucide="database"></i> Xem Raw Data
                        </button>
                        <button id="refreshBtn" class="btn btn-primary">
                            <i data-lucide="refresh-cw"></i> L√†m m·ªõi
                        </button>
                    </div>
                </div>
            </header>

            <!-- Filter Toggle Button & Transaction View Tabs -->
            <div style="margin-bottom: 10px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <button id="toggleFiltersBtn" class="btn btn-secondary" onclick="toggleFilters()">
                    <i data-lucide="filter"></i> <span id="toggleFiltersText">Hi·ªán b·ªô l·ªçc</span>
                </button>

                <!-- Transaction View Tabs -->
                <div class="view-tabs">
                    <button class="view-tab active" data-view="all" onclick="setViewMode('all')">
                        <i data-lucide="list"></i> T·∫•t c·∫£
                    </button>
                    <button class="view-tab" data-view="visible" onclick="setViewMode('visible')">
                        <i data-lucide="eye"></i> Giao d·ªãch hi·ªán
                    </button>
                    <button class="view-tab" data-view="no-phone" onclick="setViewMode('no-phone')">
                        <i data-lucide="phone-off"></i> Ch∆∞a c√≥ SƒêT <span id="noPhoneCount" class="tab-badge"></span>
                    </button>
                    <button class="view-tab" data-view="hidden" onclick="setViewMode('hidden')">
                        <i data-lucide="eye-off"></i> Giao d·ªãch ·∫©n <span id="hiddenCount" class="tab-badge"></span>
                    </button>
                </div>
            </div>

            <!-- Filters Container (hidden by default) -->
            <div id="filtersContainer" style="display: none;">
                <!-- Quick Date Filters -->
                <div class="quick-filters">
                    <label><i data-lucide="calendar-clock"></i> B·ªô l·ªçc nhanh:</label>
                    <div class="quick-filter-buttons">
                        <button class="btn-quick-filter" data-filter="today">
                            <i data-lucide="calendar-days"></i> H√¥m nay
                        </button>
                        <button class="btn-quick-filter" data-filter="yesterday">
                            <i data-lucide="calendar-minus"></i> H√¥m qua
                        </button>
                        <button class="btn-quick-filter" data-filter="thisWeek">
                            <i data-lucide="calendar-range"></i> Tu·∫ßn n√†y
                        </button>
                        <button class="btn-quick-filter" data-filter="lastWeek">
                            <i data-lucide="calendar-range"></i> Tu·∫ßn tr∆∞·ªõc
                        </button>
                        <button class="btn-quick-filter" data-filter="thisMonth">
                            <i data-lucide="calendar"></i> Th√°ng n√†y
                        </button>
                        <button class="btn-quick-filter" data-filter="lastMonth">
                            <i data-lucide="calendar"></i> Th√°ng tr∆∞·ªõc
                        </button>
                        <button class="btn-quick-filter" data-filter="last7days">
                            <i data-lucide="calendar-clock"></i> 7 ng√†y qua
                        </button>
                        <button class="btn-quick-filter active" data-filter="last30days">
                            <i data-lucide="calendar-clock"></i> 30 ng√†y qua
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters">
                    <div class="filter-group">
                        <label><i data-lucide="filter"></i> Lo·∫°i giao d·ªãch:</label>
                        <select id="filterType" class="filter-select">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="in">Ti·ªÅn v√†o</option>
                            <option value="out">Ti·ªÅn ra</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label><i data-lucide="landmark"></i> Ng√¢n h√†ng:</label>
                        <input type="text" id="filterGateway" class="filter-input" placeholder="VD: Vietcombank">
                    </div>

                    <div class="filter-group">
                        <label><i data-lucide="calendar"></i> T·ª´ ng√†y:</label>
                        <input type="date" id="filterStartDate" class="filter-input">
                    </div>

                    <div class="filter-group">
                        <label><i data-lucide="calendar"></i> ƒê·∫øn ng√†y:</label>
                        <input type="date" id="filterEndDate" class="filter-input">
                    </div>

                    <div class="filter-group">
                        <label><i data-lucide="search"></i> T√¨m ki·∫øm:</label>
                        <input type="text" id="filterSearch" class="filter-input"
                            placeholder="T√™n KH, SƒêT, n·ªôi dung...">
                    </div>

                    <div class="filter-group">
                        <label><i data-lucide="banknote"></i> S·ªë ti·ªÅn:</label>
                        <input type="text" id="filterAmount" class="filter-input" placeholder="VD: 100000 ho·∫∑c 100k">
                    </div>

                    <button id="applyFiltersBtn" class="btn btn-success">
                        <i data-lucide="check"></i> √Åp d·ª•ng
                    </button>

                    <button id="resetFiltersBtn" class="btn btn-secondary">
                        <i data-lucide="rotate-ccw"></i> ƒê·∫∑t l·∫°i
                    </button>

                    <button id="filterGapsOnlyBtn" class="btn btn-warning"
                        style="background: #fef3c7; color: #92400e; border: 1px solid #f59e0b;">
                        <i data-lucide="alert-triangle"></i> Ch·ªâ GD thi·∫øu
                    </button>
                </div>
            </div>

            <script>
                function toggleFilters() {
                    const container = document.getElementById('filtersContainer');
                    const text = document.getElementById('toggleFiltersText');
                    if (container.style.display === 'none') {
                        container.style.display = 'block';
                        text.textContent = '·∫®n b·ªô l·ªçc';
                    } else {
                        container.style.display = 'none';
                        text.textContent = 'Hi·ªán b·ªô l·ªçc';
                    }
                    // Re-render icons for newly visible elements
                    lucide.createIcons();
                }

                function setViewMode(mode) {
                    // Update global viewMode (defined in main.js)
                    viewMode = mode;

                    // Save to localStorage
                    localStorage.setItem('bh_view_mode', mode);

                    // Update tabs UI
                    document.querySelectorAll('.view-tab').forEach(tab => {
                        tab.classList.toggle('active', tab.dataset.view === mode);
                    });

                    // Re-render icons
                    lucide.createIcons();

                    // Re-render table from cached data (no API call - instant!)
                    if (typeof renderCurrentView === 'function') {
                        renderCurrentView();
                    }
                }

                // Initialize view mode from localStorage on page load
                function initViewMode() {
                    const savedMode = localStorage.getItem('bh_view_mode') || 'all';
                    viewMode = savedMode;

                    // Update tabs UI
                    document.querySelectorAll('.view-tab').forEach(tab => {
                        tab.classList.toggle('active', tab.dataset.view === savedMode);
                    });
                }
            </script>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading" style="display: none;">
                <i data-lucide="loader-2"></i> ƒêang t·∫£i d·ªØ li·ªáu...
            </div>

            <!-- Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ng√†y gi·ªù</th>
                            <th>Ng√¢n h√†ng</th>
                            <th>Lo·∫°i</th>
                            <th>S·ªë ti·ªÅn</th>
                            <th>S·ªë d∆∞</th>
                            <th>N·ªôi dung</th>
                            <th>M√£ tham chi·∫øu</th>
                            <th>T√™n kh√°ch h√†ng</th>
                            <th>S·ªë ƒëi·ªán tho·∫°i</th>
                            <th>Ngu·ªìn</th>
                            <th>QR Code</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination">
                <button id="prevPageBtn" class="btn btn-secondary" disabled>
                    <i data-lucide="chevron-left"></i> Tr∆∞·ªõc
                </button>
                <span id="pageInfo">Trang 1 / 1</span>
                <button id="nextPageBtn" class="btn btn-secondary" disabled>
                    Sau <i data-lucide="chevron-right"></i>
                </button>
            </div>

            </div><!-- End Balance History Panel -->

            <!-- Tab Panel: Transfer Stats -->
            <div id="transferStatsPanel" class="main-tab-panel">
                <header class="header" style="margin-bottom: 15px;">
                    <div class="header-content">
                        <h1 style="font-size: 1.2rem;"><i data-lucide="clipboard-check"></i> Th·ªëng K√™ Chuy·ªÉn Kho·∫£n</h1>
                    </div>
                </header>

                <!-- Transfer Stats Filters -->
                <div class="ts-filters">
                    <div class="ts-filter-group">
                        <label>·∫®n/Hi·ªán:</label>
                        <select id="tsVisibilityFilter" onchange="filterTransferStats()">
                            <option value="all" selected>T·∫•t c·∫£</option>
                            <option value="visible">ƒêang hi·ªán</option>
                            <option value="hidden">ƒêang ·∫©n</option>
                        </select>
                    </div>
                    <div class="ts-filter-group">
                        <label>ƒê√£ KT:</label>
                        <select id="tsVerifiedFilter" onchange="filterTransferStats()">
                            <option value="all" selected>T·∫•t c·∫£</option>
                            <option value="verified">ƒê√£ ki·ªÉm tra</option>
                            <option value="unverified">Ch∆∞a ki·ªÉm tra</option>
                        </select>
                    </div>
                    <div class="ts-filter-group">
                        <label>T√¨m ki·∫øm:</label>
                        <input type="text" id="tsSearchInput" placeholder="T√™n, SƒêT, n·ªôi dung..." oninput="filterTransferStats()">
                    </div>
                    <div class="ts-stats-summary">
                        <span class="ts-stat">
                            <i data-lucide="inbox"></i> T·ªïng: <strong id="tsTotalCount">0</strong>
                        </span>
                        <span class="ts-stat unchecked">
                            <i data-lucide="clock"></i> Ch∆∞a KT: <strong id="tsUncheckedCount">0</strong>
                        </span>
                        <span class="ts-stat checked">
                            <i data-lucide="check-circle"></i> ƒê√£ KT: <strong id="tsCheckedCount">0</strong>
                        </span>
                    </div>
                </div>

                <!-- Transfer Stats Table -->
                <div class="table-container">
                    <table class="data-table ts-table">
                        <thead>
                            <tr>
                                <th class="col-date">Ng√†y gi·ªù</th>
                                <th class="col-name">T√™n KH</th>
                                <th class="col-phone">SƒêT</th>
                                <th class="col-amount">S·ªë ti·ªÅn</th>
                                <th class="col-content">N·ªôi dung</th>
                                <th class="col-note">Ghi ch√∫</th>
                                <th class="col-action">·∫®n/Hi·ªán</th>
                                <th class="col-action">ƒê√£ KT</th>
                                <th class="col-action">S·ª≠a</th>
                            </tr>
                        </thead>
                        <tbody id="tsTableBody">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Transfer Stats Pagination -->
                <div class="pagination" id="tsPagination">
                    <button id="tsPrevPageBtn" class="btn btn-secondary" disabled onclick="tsChangePage(-1)">
                        <i data-lucide="chevron-left"></i> Tr∆∞·ªõc
                    </button>
                    <span id="tsPageInfo">Trang 1 / 1</span>
                    <button id="tsNextPageBtn" class="btn btn-secondary" disabled onclick="tsChangePage(1)">
                        Sau <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div><!-- End Transfer Stats Panel -->

        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i data-lucide="info"></i> Chi ti·∫øt giao d·ªãch</h2>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Detail will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Raw Data Modal -->
    <div id="rawDataModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h2><i data-lucide="database"></i> Raw Data - To√†n b·ªô d·ªØ li·ªáu SQL</h2>
                <button class="modal-close" id="closeRawDataModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <button id="copyRawDataBtn" class="btn btn-primary btn-sm">
                        <i data-lucide="copy"></i> Copy JSON
                    </button>
                    <button id="downloadRawDataBtn" class="btn btn-success btn-sm">
                        <i data-lucide="download"></i> Download JSON
                    </button>
                    <span id="rawDataCount" style="margin-left: auto; color: #666;"></span>
                </div>
                <div id="rawDataContent"
                    style="max-height: 70vh; overflow: auto; background: #f5f5f5; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;">
                    <!-- Raw data will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i data-lucide="qr-code"></i> QR Chuy·ªÉn Kho·∫£n</h2>
                <button class="modal-close" id="closeQRModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="qrModalBody" style="text-align: center;">
                <!-- QR code will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Customer List By Phone Modal -->
    <div id="customerListModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <div class="modal-header">
                <h2><i data-lucide="users"></i> Kh√°ch h√†ng v·ªõi SƒêT: <span id="customerListPhone"></span></h2>
                <button class="modal-close" id="closeCustomerListModalBtn">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Loading State -->
                <div id="customerListLoading" style="text-align: center; padding: 40px; display: none;">
                    <i data-lucide="loader-2" class="animate-spin"
                        style="width: 48px; height: 48px; color: #3b82f6;"></i>
                    <p style="margin-top: 15px; color: #6b7280;">ƒêang t·∫£i danh s√°ch kh√°ch h√†ng...</p>
                </div>

                <!-- Empty State -->
                <div id="customerListEmpty" style="text-align: center; padding: 40px; display: none;">
                    <i data-lucide="user-x" style="width: 48px; height: 48px; color: #9ca3af;"></i>
                    <p style="margin-top: 15px; color: #6b7280;">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng v·ªõi s·ªë ƒëi·ªán tho·∫°i n√†y</p>
                </div>

                <!-- Customer List -->
                <div id="customerListContent" style="display: none;">
                    <div id="customerListCount"
                        style="margin-bottom: 15px; padding: 10px; background: #f0f9ff; border-radius: 8px; color: #0369a1;">
                        <i data-lucide="info" style="width: 16px; height: 16px; vertical-align: middle;"></i>
                        <span>T√¨m th·∫•y <strong id="customerListTotal">0</strong> kh√°ch h√†ng</span>
                    </div>
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>T√™n</th>
                                <th>TPOS ID</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>T·ªïng C√¥ng N·ª£</th>
                                <th>ƒê·ªãa ch·ªâ</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="customerListTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 15px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <a href="../customer-hub/index.html" target="_blank" class="btn btn-primary"
                    style="text-decoration: none;">
                    <i data-lucide="external-link"></i> M·ªü Customer 360
                </a>
                <button class="btn btn-secondary" onclick="closeCustomerListModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Edit Customer Info Modal -->
    <div id="editCustomerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i data-lucide="user-pen"></i> Ch·ªânh s·ª≠a th√¥ng tin kh√°ch h√†ng</h2>
                <button class="modal-close" id="closeEditCustomerModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editCustomerForm" style="display: flex; flex-direction: column; gap: 15px;">
                    <div
                        style="padding: 10px; background: #f8f9fa; border-radius: 6px; font-family: monospace; font-size: 13px; color: #495057;">
                        <strong>M√£ giao d·ªãch:</strong> <span id="editCustomerUniqueCode"></span>
                    </div>

                    <div>
                        <label for="editCustomerName" style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <i data-lucide="user" style="width: 16px; height: 16px; vertical-align: middle;"></i> T√™n
                            kh√°ch h√†ng:
                        </label>
                        <input type="text" id="editCustomerName" class="filter-input" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng"
                            style="width: 100%;">
                    </div>

                    <div>
                        <label for="editCustomerPhone" style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <i data-lucide="phone" style="width: 16px; height: 16px; vertical-align: middle;"></i> S·ªë
                            ƒëi·ªán tho·∫°i:
                        </label>
                        <input type="tel" id="editCustomerPhone" class="filter-input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                            style="width: 100%;">
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i data-lucide="save"></i> L∆∞u th√¥ng tin
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelEditCustomerBtn" style="flex: 1;">
                            <i data-lucide="x"></i> H·ªßy
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Missing Transactions (Gaps) Modal -->
    <div id="gapsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2><i data-lucide="alert-triangle"></i> Giao d·ªãch b·ªã thi·∫øu</h2>
                <button class="modal-close" id="closeGapsModalBtn">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Loading State -->
                <div id="gapsLoading" style="text-align: center; padding: 40px;">
                    <i data-lucide="loader-2" class="animate-spin"
                        style="width: 48px; height: 48px; color: #d97706;"></i>
                    <p style="margin-top: 15px; color: #6b7280;">ƒêang ph√¢n t√≠ch m√£ tham chi·∫øu...</p>
                </div>

                <!-- Empty State -->
                <div id="gapsEmpty" style="text-align: center; padding: 40px; display: none;">
                    <i data-lucide="check-circle" style="width: 48px; height: 48px; color: #10b981;"></i>
                    <p style="margin-top: 15px; color: #10b981; font-weight: 600;">Kh√¥ng c√≥ giao d·ªãch thi·∫øu!</p>
                    <p style="color: #6b7280;">T·∫•t c·∫£ m√£ tham chi·∫øu ƒë·ªÅu li√™n t·ª•c.</p>
                </div>

                <!-- Gaps List -->
                <div id="gapsContent" style="display: none;">
                    <div id="gapsInfo"
                        style="margin-bottom: 15px; padding: 12px; background: #fef3c7; border-left: 4px solid #d97706; border-radius: 4px;">
                        <i data-lucide="info" style="width: 16px; height: 16px; vertical-align: middle;"></i>
                        <span>Ph√°t hi·ªán <strong id="gapsTotal">0</strong> m√£ tham chi·∫øu b·ªã thi·∫øu trong h·ªá th·ªëng.</span>
                        <p style="margin-top: 8px; font-size: 13px; color: #92400e;">
                            ƒê√¢y c√≥ th·ªÉ l√† c√°c giao d·ªãch webhook b·ªã l·ªói ho·∫∑c kh√¥ng nh·∫≠n ƒë∆∞·ª£c.
                        </p>
                    </div>

                    <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <button id="detectGapsBtn" class="btn btn-primary btn-sm">
                            <i data-lucide="search"></i> Qu√©t l·∫°i
                        </button>
                        <button id="retryAllGapsBtn" class="btn btn-success btn-sm">
                            <i data-lucide="refresh-cw"></i> Retry Failed Queue
                        </button>
                    </div>

                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>M√£ tham chi·∫øu thi·∫øu</th>
                                <th>Tr∆∞·ªõc ƒë√≥</th>
                                <th>Sau ƒë√≥</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="gapsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 15px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeGapsModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Edit Transfer Stats Modal -->
    <div id="editTSModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i data-lucide="edit-3"></i> Ch·ªânh s·ª≠a Th·ªëng K√™</h2>
                <button class="modal-close" id="closeEditTSModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editTSForm" style="display: flex; flex-direction: column; gap: 15px;">
                    <input type="hidden" id="editTSId">

                    <div>
                        <label for="editTSCustomerName" style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <i data-lucide="user" style="width: 16px; height: 16px; vertical-align: middle;"></i> T√™n kh√°ch h√†ng:
                        </label>
                        <input type="text" id="editTSCustomerName" class="filter-input" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng" style="width: 100%;">
                    </div>

                    <div>
                        <label for="editTSCustomerPhone" style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <i data-lucide="phone" style="width: 16px; height: 16px; vertical-align: middle;"></i> S·ªë ƒëi·ªán tho·∫°i:
                        </label>
                        <input type="tel" id="editTSCustomerPhone" class="filter-input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" style="width: 100%;">
                    </div>

                    <div>
                        <label for="editTSNotes" style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <i data-lucide="file-text" style="width: 16px; height: 16px; vertical-align: middle;"></i> Ghi ch√∫:
                        </label>
                        <textarea id="editTSNotes" class="filter-input" placeholder="Nh·∫≠p ghi ch√∫..." style="width: 100%; min-height: 80px; resize: vertical;"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i data-lucide="save"></i> L∆∞u thay ƒë·ªïi
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelEditTSBtn" style="flex: 1;">
                            <i data-lucide="x"></i> H·ªßy
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Phone Data Modal -->
    <div id="phoneDataModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
            <div class="modal-header">
                <h2><i data-lucide="phone-outgoing"></i> D·ªØ li·ªáu Phone t·ª´ Balance Customer Info</h2>
                <button class="modal-close" id="closePhoneDataModalBtn">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Loading State -->
                <div id="phoneDataLoading" style="text-align: center; padding: 40px;">
                    <i data-lucide="loader-2" class="animate-spin"
                        style="width: 48px; height: 48px; color: #3b82f6;"></i>
                    <p style="margin-top: 15px; color: #6b7280;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>

                <!-- Empty State -->
                <div id="phoneDataEmpty" style="text-align: center; padding: 40px; display: none;">
                    <i data-lucide="inbox" style="width: 48px; height: 48px; color: #9ca3af;"></i>
                    <p style="margin-top: 15px; color: #6b7280;">Ch∆∞a c√≥ d·ªØ li·ªáu phone n√†o!</p>
                    <p style="color: #9ca3af; font-size: 14px;">Click n√∫t "C·∫≠p nh·∫≠t Phone" ƒë·ªÉ extract phone t·ª´
                        transactions.</p>
                </div>

                <!-- Phone Data Table -->
                <div id="phoneDataContent" style="display: none;">
                    <!-- Search Box -->
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="phoneDataSearch" placeholder="üîç T√¨m ki·∫øm theo SƒêT, t√™n, unique code..."
                            style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;"
                            oninput="filterPhoneDataTable()">
                    </div>

                    <div
                        style="margin-bottom: 15px; padding: 12px; background: #e0f2fe; border-left: 4px solid #3b82f6; border-radius: 4px;">
                        <i data-lucide="info" style="width: 16px; height: 16px; vertical-align: middle;"></i>
                        <span>T·ªïng: <strong id="phoneDataTotal">0</strong> records | Hi·ªÉn th·ªã: <strong
                                id="phoneDataShown">0</strong></span>
                    </div>

                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 150px;">Unique Code</th>
                                <th style="width: 110px;">Phone</th>
                                <th style="width: 200px;">Customer Name</th>
                                <th style="width: 120px;">C√¥ng n·ª£</th>
                                <th style="width: 180px;">Extraction Note</th>
                                <th style="width: 110px;">Fetch Status</th>
                                <th style="width: 140px;">Created At</th>
                                <th style="width: 140px;">Updated At</th>
                            </tr>
                        </thead>
                        <tbody id="phoneDataTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 15px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <button id="refreshPhoneDataBtn" class="btn btn-primary btn-sm">
                        <i data-lucide="refresh-cw"></i> L√†m m·ªõi
                    </button>
                </div>

                <!-- Pagination Controls -->
                <div id="phoneDataPagination" style="display: none;">
                    <button id="phoneDataPrevBtn" class="btn btn-secondary btn-sm" style="padding: 6px 12px;">
                        <i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i>
                    </button>
                    <span id="phoneDataPageInfo"
                        style="font-size: 14px; color: #6b7280; min-width: 120px; text-align: center; margin: 0 8px;">
                        Page 1 / 1
                    </span>
                    <button id="phoneDataNextBtn" class="btn btn-secondary btn-sm" style="padding: 6px 12px;">
                        <i data-lucide="chevron-right" style="width: 16px; height: 16px;"></i>
                    </button>
                </div>

                <button class="btn btn-secondary" onclick="closePhoneDataModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../shared/js/firebase-config.js"></script>

    <!-- Navigation & Auth -->
    <script src="../shared/js/navigation-modern.js"></script>

    <!-- Page Scripts -->
    <script src="js/notification-system.js"></script>
    <script>
        // Initialize NotificationManager globally
        window.NotificationManager = new NotificationManager();
    </script>
    <script src="js/auth.js"></script>
    <script src="js/cache.js"></script>
    <script src="js/config.js"></script>
    <script src="js/qr-generator.js"></script>
    <script src="js/customer-info.js"></script>
    <script src="js/main.js"></script>
    <script src="js/transfer-stats.js"></script>

    <!-- Initialize Lucide Icons, View Mode, and Main Tabs -->
    <script>
        lucide.createIcons();

        // Main Tab Switching
        function switchMainTab(section) {
            // Update tab buttons
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.section === section);
            });

            // Update panels
            document.querySelectorAll('.main-tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            if (section === 'balance-history') {
                document.getElementById('balanceHistoryPanel').classList.add('active');
            } else if (section === 'transfer-stats') {
                document.getElementById('transferStatsPanel').classList.add('active');
                // Load transfer stats when switching to this tab
                if (typeof loadTransferStats === 'function') {
                    loadTransferStats();
                }
            }

            // Save to localStorage
            localStorage.setItem('bh_main_tab', section);

            // Re-render icons
            lucide.createIcons();
        }

        // Initialize main tab from localStorage
        function initMainTab() {
            const savedTab = localStorage.getItem('bh_main_tab') || 'balance-history';
            switchMainTab(savedTab);
        }

        // Initialize on load
        initMainTab();

        // Initialize view mode tabs from localStorage
        if (typeof initViewMode === 'function') {
            initViewMode();
        }
    </script>
</body>

</html>