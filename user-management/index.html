<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Quản Lý Tài Khoản - N2 Shop</title>
        <meta http-equiv="Cache-Control" content="public, max-age=31536000" />

        <!-- External CSS -->
        <link rel="stylesheet" href="modern.css" />

        <!-- Lucide Icons -->
        <script src="https://unpkg.com/lucide@latest"></script>

        <!-- Firebase Scripts -->
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

        <!-- Crypto Libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/3.0.1/bcrypt.min.js"></script>

        <!-- Navigation & Utils -->
        <script src="../js/navigation-modern.js"></script>
        <script src="../js/common-utils.js"></script>
    </head>

    <body>
        <!-- Access Denied (Hidden by default) -->
        <div id="accessDenied" class="access-denied" style="display: none">
            <h1>
                <i data-lucide="shield-x"></i>
                Truy cập bị từ chối
            </h1>
            <p>
                Bạn không có quyền truy cập vào trang này.<br />
                Chỉ có Admin mới có thể quản lý tài khoản.
            </p>
            <a href="../live/index.html" class="btn btn-primary">
                <i data-lucide="arrow-left"></i>
                Quay về trang chính
            </a>
        </div>

        <!-- Main Container (Hidden until auth check) -->
        <div id="mainContainer" style="display: none">
            <!-- Sidebar Navigation -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="logo">
                        <i data-lucide="zap"></i>
                        <span>N2Shop</span>
                    </div>
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i data-lucide="panel-left-close"></i>
                    </button>
                </div>

                <nav class="sidebar-nav" id="sidebarNav">
                    <!-- Menu items will be auto-generated by navigation-modern.js -->
                </nav>

                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar">
                            <i data-lucide="user-circle"></i>
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Admin</div>
                            <div class="user-role">Quản trị viên</div>
                        </div>
                    </div>
                    <button class="btn-permissions" id="btnPermissions">
                        <i data-lucide="shield-check"></i>
                        <span>Xem Quyền Của Tôi</span>
                    </button>
                    <button class="btn-logout" id="btnLogout">
                        <i data-lucide="log-out"></i>
                        <span>Đăng xuất</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Top Bar -->
                <header class="top-bar">
                    <div class="top-bar-left">
                        <button class="btn-icon" id="menuToggle">
                            <i data-lucide="menu"></i>
                        </button>
                        <div class="breadcrumb">
                            <i data-lucide="home"></i>
                            <span>Quản Lý Tài Khoản</span>
                        </div>
                    </div>
                    <div class="top-bar-right">
                        <button class="btn btn-primary" id="btnShowCreate">
                            <i data-lucide="user-plus"></i>
                            <span>Tạo User</span>
                        </button>
                        <button
                            class="btn-icon"
                            id="btnRefresh"
                            title="Làm mới"
                        >
                            <i data-lucide="refresh-cw"></i>
                        </button>
                        <div class="search-box">
                            <i data-lucide="search"></i>
                            <input
                                type="text"
                                placeholder="Tìm kiếm..."
                                id="searchInput"
                            />
                        </div>
                    </div>
                </header>

                <!-- Tab Navigation -->
                <section
                    class="card"
                    style="margin: 0 var(--spacing-xl) var(--spacing-xl)"
                >
                    <div
                        class="card-header"
                        style="border-bottom: none; padding-bottom: 0"
                    >
                        <div class="category-tabs" style="margin: 0">
                            <button class="tab-btn active" data-tab="manage">
                                <i data-lucide="users"></i>
                                Quản Lý Users
                            </button>
                            <button class="tab-btn" data-tab="create">
                                <i data-lucide="user-plus"></i>
                                Tạo Mới
                            </button>
                            <button class="tab-btn" data-tab="permissions">
                                <i data-lucide="shield-check"></i>
                                Quyền Truy Cập
                            </button>
                            <button class="tab-btn" data-tab="tools">
                                <i data-lucide="settings"></i>
                                Tools
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Tab: Quản Lý Users -->
                <div id="manage" class="tab-content active">
                    <!-- Firebase Status -->
                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="database"></i>
                                <h2>Kết Nối Firebase</h2>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="firebaseStatus" class="output">
                                Đang kết nối Firebase...
                            </div>
                        </div>
                    </section>

                    <!-- User List Section -->
                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="users"></i>
                                <h2>Danh Sách Tài Khoản</h2>
                            </div>
                            <div class="card-actions">
                                <button
                                    class="btn btn-primary"
                                    onclick="loadUsers()"
                                >
                                    <i data-lucide="refresh-cw"></i>
                                    Tải Danh Sách
                                </button>
                                <button
                                    class="btn btn-secondary"
                                    onclick="exportUsers()"
                                >
                                    <i data-lucide="download"></i>
                                    Xuất Excel
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="userList" class="user-list-modern">
                                <div class="empty-state show">
                                    <i data-lucide="users"></i>
                                    <h3>Chưa có dữ liệu</h3>
                                    <p>Nhấn "Tải Danh Sách" để xem users</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Edit User Section -->
                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="edit"></i>
                                <h2>Chỉnh Sửa Tài Khoản</h2>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="user"></i>
                                        Username
                                    </label>
                                    <input
                                        type="text"
                                        id="editUsername"
                                        placeholder="Chọn user từ danh sách"
                                        readonly
                                        style="background: var(--gray-100)"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="tag"></i>
                                        Tên hiển thị
                                    </label>
                                    <input
                                        type="text"
                                        id="editDisplayName"
                                        placeholder="Tên hiển thị"
                                    />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="shield"></i>
                                        Quyền hạn
                                    </label>
                                    <select id="editCheckLogin">
                                        <option value="0">Admin (0)</option>
                                        <option value="1">User (1)</option>
                                        <option value="2">Limited (2)</option>
                                        <option value="3">Basic (3)</option>
                                        <option value="777">Guest (777)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="key"></i>
                                        Password mới (để trống nếu không đổi)
                                    </label>
                                    <input
                                        type="password"
                                        id="editNewPassword"
                                        placeholder="Password mới"
                                    />
                                </div>
                            </div>

                            <!-- Permissions Section -->
                            <div class="permissions-section">
                                <h3>
                                    <i data-lucide="shield-check"></i>
                                    Quyền Truy Cập Các Trang
                                </h3>
                                <p
                                    style="
                                        color: var(--text-secondary);
                                        font-size: 0.875rem;
                                        margin-bottom: var(--spacing-md);
                                    "
                                >
                                    Chọn các trang mà user này có thể truy cập
                                </p>

                                <div class="role-template">
                                    <h4>
                                        <i data-lucide="layout-template"></i>
                                        Template theo vai trò:
                                    </h4>
                                    <div class="template-buttons">
                                        <button
                                            type="button"
                                            class="btn btn-secondary template-btn"
                                            onclick="applyPermissionTemplate('admin')"
                                        >
                                            <i data-lucide="crown"></i>
                                            Admin
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary template-btn"
                                            onclick="applyPermissionTemplate('manager')"
                                        >
                                            <i data-lucide="briefcase"></i>
                                            Manager
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary template-btn"
                                            onclick="applyPermissionTemplate('staff')"
                                        >
                                            <i data-lucide="users"></i>
                                            Staff
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary template-btn"
                                            onclick="applyPermissionTemplate('viewer')"
                                        >
                                            <i data-lucide="eye"></i>
                                            Viewer
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary template-btn"
                                            onclick="applyPermissionTemplate('clear')"
                                        >
                                            <i data-lucide="trash-2"></i>
                                            Xóa tất cả
                                        </button>
                                    </div>
                                </div>

                                <div
                                    class="permissions-summary"
                                    id="permissionsSummary"
                                >
                                    <span class="permissions-count"
                                        >0/12 trang được chọn</span
                                    >
                                </div>

                                <div
                                    class="permissions-grid"
                                    id="editPermissionsGrid"
                                >
                                    <!-- Generated by JS -->
                                </div>
                            </div>

                            <div class="form-actions">
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    onclick="clearEditForm()"
                                >
                                    <i data-lucide="x"></i>
                                    Xóa Form
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-primary"
                                    onclick="updateUser()"
                                >
                                    <i data-lucide="check"></i>
                                    Cập Nhật
                                </button>
                            </div>

                            <div
                                id="editOutput"
                                class="output"
                                style="
                                    display: none;
                                    margin-top: var(--spacing-lg);
                                "
                            ></div>
                        </div>
                    </section>
                </div>

                <!-- Tab: Tạo User Mới -->
                <div id="create" class="tab-content">
                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="user-plus"></i>
                                <h2>Tạo Tài Khoản Mới</h2>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="user"></i>
                                        Username
                                    </label>
                                    <input
                                        type="text"
                                        id="newUsername"
                                        placeholder="Username (không dấu, không khoảng trắng)"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="key"></i>
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        id="newPassword"
                                        placeholder="Password mạnh"
                                    />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="tag"></i>
                                        Tên hiển thị
                                    </label>
                                    <input
                                        type="text"
                                        id="newDisplayName"
                                        placeholder="Tên hiển thị (tự động điền)"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="shield"></i>
                                        Quyền hạn
                                    </label>
                                    <select id="newCheckLogin">
                                        <option value="0">Admin (0)</option>
                                        <option value="1" selected>
                                            User (1)
                                        </option>
                                        <option value="2">Limited (2)</option>
                                        <option value="3">Basic (3)</option>
                                        <option value="777">Guest (777)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Permissions Section -->
                            <div class="permissions-section">
                                <h3>
                                    <i data-lucide="shield-check"></i>
                                    Quyền Truy Cập Các Trang
                                </h3>
                                <p
                                    style="
                                        color: var(--text-secondary);
                                        font-size: 0.875rem;
                                        margin-bottom: var(--spacing-md);
                                    "
                                >
                                    Chọn các trang mà user mới này có thể truy
                                    cập
                                </p>

                                <div class="role-template">
                                    <h4>
                                        <i data-lucide="layout-template"></i>
                                        Template theo vai trò:
                                    </h4>
                                    <div class="template-buttons">
                                        <button
                                            type="button"
                                            class="btn btn-secondary template-btn"
                                            onclick="applyPermissionTemplate('admin', 'new')"
                                        >
                                            <i data-lucide="crown"></i>
                                            Admin
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary template-btn"
                                            onclick="applyPermissionTemplate('manager', 'new')"
                                        >
                                            <i data-lucide="briefcase"></i>
                                            Manager
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary template-btn"
                                            onclick="applyPermissionTemplate('staff', 'new')"
                                        >
                                            <i data-lucide="users"></i>
                                            Staff
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary template-btn"
                                            onclick="applyPermissionTemplate('viewer', 'new')"
                                        >
                                            <i data-lucide="eye"></i>
                                            Viewer
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary template-btn"
                                            onclick="applyPermissionTemplate('clear', 'new')"
                                        >
                                            <i data-lucide="trash-2"></i>
                                            Xóa tất cả
                                        </button>
                                    </div>
                                </div>

                                <div
                                    class="permissions-summary"
                                    id="newPermissionsSummary"
                                >
                                    <span class="permissions-count"
                                        >0/12 trang được chọn</span
                                    >
                                </div>

                                <div
                                    class="permissions-grid"
                                    id="newPermissionsGrid"
                                >
                                    <!-- Generated by JS -->
                                </div>
                            </div>

                            <div class="form-actions">
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    onclick="clearCreateForm()"
                                >
                                    <i data-lucide="refresh-cw"></i>
                                    Làm Mới
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-primary"
                                    onclick="createUser()"
                                >
                                    <i data-lucide="check"></i>
                                    Tạo Tài Khoản
                                </button>
                            </div>

                            <div
                                id="createOutput"
                                class="output"
                                style="
                                    display: none;
                                    margin-top: var(--spacing-lg);
                                "
                            ></div>
                        </div>
                    </section>
                </div>

                <!-- Tab: Permissions -->
                <div id="permissions" class="tab-content">
                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="shield-check"></i>
                                <h2>Quản Lý Quyền Truy Cập</h2>
                            </div>
                            <div class="card-actions">
                                <button
                                    class="btn btn-primary"
                                    onclick="loadPermissionsOverview()"
                                >
                                    <i data-lucide="refresh-cw"></i>
                                    Tải Thống Kê
                                </button>
                                <button
                                    class="btn btn-secondary"
                                    onclick="exportPermissions()"
                                >
                                    <i data-lucide="download"></i>
                                    Xuất Báo Cáo
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="permissionsOverview">
                                <div class="empty-state show">
                                    <i data-lucide="shield-check"></i>
                                    <h3>Chưa có dữ liệu</h3>
                                    <p>Nhấn "Tải Thống Kê" để xem báo cáo</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Tab: Tools -->
                <div id="tools" class="tab-content">
                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="hash"></i>
                                <h2>Tạo Hash Password</h2>
                            </div>
                        </div>
                        <div class="card-body">
                            <div
                                class="method-selector"
                                style="margin-bottom: var(--spacing-lg)"
                            >
                                <label
                                    style="
                                        display: inline-flex;
                                        align-items: center;
                                        margin-right: var(--spacing-lg);
                                    "
                                >
                                    <input
                                        type="radio"
                                        name="method"
                                        value="cryptojs"
                                        checked
                                        style="
                                            width: auto;
                                            margin-right: var(--spacing-sm);
                                        "
                                    />
                                    Crypto-JS (Nhanh)
                                </label>
                                <label
                                    style="
                                        display: inline-flex;
                                        align-items: center;
                                    "
                                >
                                    <input
                                        type="radio"
                                        name="method"
                                        value="bcrypt"
                                        style="
                                            width: auto;
                                            margin-right: var(--spacing-sm);
                                        "
                                    />
                                    bcrypt (An toàn hơn)
                                </label>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="user"></i>
                                        Username
                                    </label>
                                    <input
                                        type="text"
                                        id="username"
                                        placeholder="Nhập username"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="key"></i>
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        id="password"
                                        placeholder="Nhập password"
                                    />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="tag"></i>
                                        Tên hiển thị
                                    </label>
                                    <input
                                        type="text"
                                        id="displayName"
                                        placeholder="Tên hiển thị"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="shield"></i>
                                        Quyền hạn
                                    </label>
                                    <select id="checkLogin">
                                        <option value="0">Admin (0)</option>
                                        <option value="1" selected>
                                            User (1)
                                        </option>
                                        <option value="2">Limited (2)</option>
                                        <option value="3">Basic (3)</option>
                                        <option value="777">Guest (777)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    onclick="clearHashForm()"
                                >
                                    <i data-lucide="refresh-cw"></i>
                                    Xóa Form
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-primary"
                                    onclick="generateHash()"
                                >
                                    <i data-lucide="hash"></i>
                                    Tạo Hash
                                </button>
                            </div>

                            <div
                                id="hashOutput"
                                style="
                                    display: none;
                                    margin-top: var(--spacing-lg);
                                    padding: var(--spacing-lg);
                                    background: var(--gray-50);
                                    border-radius: var(--radius);
                                    font-family: monospace;
                                    font-size: 0.875rem;
                                    white-space: pre-wrap;
                                    word-break: break-all;
                                "
                            ></div>
                        </div>
                    </section>

                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="check-circle"></i>
                                <h2>Kiểm Tra Password</h2>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="key"></i>
                                        Test Password
                                    </label>
                                    <input
                                        type="password"
                                        id="testPassword"
                                        placeholder="Nhập password để test"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="hexagon"></i>
                                        Salt (Crypto-JS)
                                    </label>
                                    <input
                                        type="text"
                                        id="testSalt"
                                        placeholder="Salt từ hash output"
                                    />
                                </div>
                            </div>

                            <div class="form-group">
                                <label>
                                    <i data-lucide="hash"></i>
                                    Hash để so sánh
                                </label>
                                <textarea
                                    id="testHash"
                                    rows="3"
                                    placeholder="Paste hash để kiểm tra"
                                    style="font-family: monospace"
                                ></textarea>
                            </div>

                            <div class="form-actions">
                                <button
                                    type="button"
                                    class="btn btn-primary"
                                    onclick="verifyPassword()"
                                >
                                    <i data-lucide="check"></i>
                                    Kiểm Tra
                                </button>
                            </div>

                            <div
                                id="verifyOutput"
                                style="
                                    display: none;
                                    margin-top: var(--spacing-lg);
                                    padding: var(--spacing-lg);
                                    background: var(--gray-50);
                                    border-radius: var(--radius);
                                    font-size: 0.875rem;
                                "
                            ></div>
                        </div>
                    </section>
                </div>
            </main>
        </div>

        <!-- Scripts -->
        <script src="notification-system.js"></script>

        <script>
            // Create compatibility elements before loading other scripts
            (function () {
                // Create hidden currentUser element for compatibility
                const currentUser = document.createElement("div");
                currentUser.id = "currentUser";
                currentUser.style.display = "none";
                document.body.insertBefore(
                    currentUser,
                    document.body.firstChild,
                );

                // Override checkAdminAccess to sync with userName
                window.addEventListener("load", () => {
                    const userNameEl = document.getElementById("userName");
                    const currentUserEl =
                        document.getElementById("currentUser");

                    if (userNameEl && currentUserEl) {
                        // Create sync function
                        const syncNames = () => {
                            if (
                                currentUserEl.textContent &&
                                userNameEl.textContent !==
                                    currentUserEl.textContent
                            ) {
                                userNameEl.textContent =
                                    currentUserEl.textContent;
                            }
                        };

                        // Sync immediately and on changes
                        syncNames();
                        const observer = new MutationObserver(syncNames);
                        observer.observe(currentUserEl, {
                            childList: true,
                            characterData: true,
                            subtree: true,
                        });
                    }
                });
            })();
        </script>
        <script src="image-system.js"></script>
        <script src="auth-with-cache-manager.js"></script>
        <script src="user-permission-page.js"></script>
        <script>
            // Initialize
            document.addEventListener("DOMContentLoaded", () => {
                lucide.createIcons();

                // Initialize notification manager
                window.notify = new NotificationManager();

                // Tab switching
                document.querySelectorAll(".tab-btn").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const tabName = btn.dataset.tab;

                        document
                            .querySelectorAll(".tab-btn")
                            .forEach((b) => b.classList.remove("active"));
                        btn.classList.add("active");

                        document
                            .querySelectorAll(".tab-content")
                            .forEach((content) => {
                                content.classList.remove("active");
                                content.style.display = "none";
                            });

                        const tabContent = document.getElementById(tabName);
                        if (tabContent) {
                            tabContent.classList.add("active");
                            tabContent.style.display = "block";
                        }

                        lucide.createIcons();
                    });
                });

                // Button handlers
                document
                    .getElementById("btnShowCreate")
                    ?.addEventListener("click", () => {
                        document.querySelector('[data-tab="create"]')?.click();
                    });

                document
                    .getElementById("btnRefresh")
                    ?.addEventListener("click", () => {
                        if (typeof loadUsers === "function") loadUsers();
                    });

                // Update stats when users load
                const originalLoadUsers = window.loadUsers;
                if (originalLoadUsers) {
                    window.loadUsers = async function () {
                        await originalLoadUsers();
                        updateStats();

                        // Re-render with modern design
                        if (window.users && window.users.length > 0) {
                            window.renderUserList(window.users);
                        }
                    };
                }
            });

            // Update stats
            function updateStats() {
                if (window.users && Array.isArray(window.users)) {
                    const total = window.users.length;
                    const admins = window.users.filter(
                        (u) => u.checkLogin === 0,
                    ).length;

                    document.getElementById("statTotalUsers").textContent =
                        total;
                    document.getElementById("statAdmins").textContent = admins;
                    document.getElementById("statActiveUsers").textContent =
                        total;
                    document.getElementById("statFirebase").textContent =
                        "Connected";
                }
            }

            // Override getRoleText with Lucide icons
            window.getRoleText = function (checkLogin) {
                const roles = {
                    0: '<i data-lucide="crown" style="width:12px;height:12px;display:inline-block;vertical-align:middle"></i> Admin',
                    1: '<i data-lucide="user" style="width:12px;height:12px;display:inline-block;vertical-align:middle"></i> User',
                    2: '<i data-lucide="lock" style="width:12px;height:12px;display:inline-block;vertical-align:middle"></i> Limited',
                    3: '<i data-lucide="circle" style="width:12px;height:12px;display:inline-block;vertical-align:middle"></i> Basic',
                    777: '<i data-lucide="user-x" style="width:12px;height:12px;display:inline-block;vertical-align:middle"></i> Guest',
                };
                return roles[checkLogin] || `Unknown (${checkLogin})`;
            };

            // Render user list with modern design
            window.renderUserList = function (users) {
                const userList = document.getElementById("userList");
                const emptyState = userList.querySelector(".empty-state");

                if (!users || users.length === 0) {
                    if (emptyState) emptyState.classList.add("show");
                    return;
                }

                if (emptyState) emptyState.classList.remove("show");

                let html = "";
                users.forEach((user) => {
                    const roleClass = getRoleClass(user.checkLogin);
                    const roleIcon = getRoleIcon(user.checkLogin);
                    const permissionCount = user.pagePermissions
                        ? user.pagePermissions.length
                        : 0;
                    const totalPages = window.AVAILABLE_PAGES
                        ? window.AVAILABLE_PAGES.length
                        : 12;
                    const createdDate = user.createdAt
                        ? new Date(
                              user.createdAt.seconds * 1000,
                          ).toLocaleDateString("vi-VN")
                        : "N/A";
                    const updatedDate = user.updatedAt
                        ? " | Cập nhật: " +
                          new Date(
                              user.updatedAt.seconds * 1000,
                          ).toLocaleDateString("vi-VN")
                        : "";

                    html += `
                        <div class="user-list-item">
                            <div class="user-list-info">
                                <div class="user-avatar-large">
                                    <i data-lucide="user"></i>
                                </div>
                                <div class="user-list-details">
                                    <div class="user-list-name">${user.displayName} <span style="color: var(--text-tertiary); font-weight: normal">(${user.id})</span></div>
                                    <div class="user-list-meta">
                                        <span class="user-role-badge ${roleClass}">
                                            <i data-lucide="${roleIcon}"></i>
                                            ${getRoleName(user.checkLogin)}
                                        </span>
                                        <span><i data-lucide="shield-check" style="width:14px;height:14px;display:inline-block;vertical-align:middle"></i> ${permissionCount}/${totalPages} trang</span>
                                        <span><i data-lucide="calendar" style="width:14px;height:14px;display:inline-block;vertical-align:middle"></i> ${createdDate}${updatedDate}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="user-list-actions">
                                <button class="btn-icon" onclick="editUser('${user.id}')" title="Chỉnh sửa">
                                    <i data-lucide="edit"></i>
                                </button>
                                <button class="btn-icon" onclick="viewUserPermissions('${user.id}')" title="Xem quyền">
                                    <i data-lucide="eye"></i>
                                </button>
                                <button class="btn-icon danger" onclick="deleteUser('${user.id}')" title="Xóa">
                                    <i data-lucide="trash-2"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });

                userList.innerHTML = html;
                lucide.createIcons();
            };

            function getRoleClass(checkLogin) {
                const classes = {
                    0: "admin",
                    1: "user",
                    2: "limited",
                    3: "basic",
                    777: "guest",
                };
                return classes[checkLogin] || "user";
            }

            function getRoleIcon(checkLogin) {
                const icons = {
                    0: "crown",
                    1: "user",
                    2: "lock",
                    3: "circle",
                    777: "user-x",
                };
                return icons[checkLogin] || "user";
            }

            function getRoleName(checkLogin) {
                const names = {
                    0: "Admin",
                    1: "User",
                    2: "Limited",
                    3: "Basic",
                    777: "Guest",
                };
                return names[checkLogin] || "Unknown";
            }

            // Helper functions
            function showFloatingAlert(message, type = "info") {
                if (window.notify) {
                    if (type === "loading") {
                        return window.notify.loading(message);
                    }
                    window.notify.show(message, type, 3000);
                }
            }

            function showSuccess(message) {
                if (window.notify) {
                    window.notify.success(message);
                }
            }

            function showError(message) {
                if (window.notify) {
                    window.notify.error(message);
                }
            }
        </script>
    </body>
</html>
