<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω T√†i Kho·∫£n - N2 Shop</title>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- Crypto Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/3.0.1/bcrypt.min.js"></script>
    
    <!-- Main CSS -->
    <link rel="stylesheet" href="../main.css">
    
    <!-- Navigation -->
    <script src="../js/navigation.js"></script>
    <script src="../js/common-utils.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 80px 20px 20px;
        }

        .access-denied {
            max-width: 600px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .access-denied h1 {
            color: #e74c3c;
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .access-denied p {
            color: #666;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh, ch·ªâ hi·ªán khi admin */
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .admin-badge {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .section h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: left;
                border-bottom: 1px solid #e0e0e0;
            }
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }

        input:focus, textarea:focus, select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        button.success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .output {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .user-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-info {
            flex: 1;
            min-width: 200px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .user-actions button {
            padding: 6px 12px;
            font-size: 12px;
            margin: 2px;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .method-selector {
            margin-bottom: 20px;
        }

        .method-selector input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }

        .method-selector label {
            display: inline;
            margin-right: 20px;
            font-weight: normal;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Th√¥ng b√°o truy c·∫≠p b·ªã t·ª´ ch·ªëi -->
    <div id="accessDenied" class="access-denied" style="display: none;">
        <h1>üö´ Truy c·∫≠p b·ªã t·ª´ ch·ªëi</h1>
        <p>B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p v√†o trang n√†y.<br>Ch·ªâ c√≥ Admin m·ªõi c√≥ th·ªÉ qu·∫£n l√Ω t√†i kho·∫£n.</p>
        <a href="../live/index.html" class="back-btn">‚Üê Quay v·ªÅ trang ch√≠nh</a>
    </div>

    <!-- N·ªôi dung ch√≠nh - Ch·ªâ hi·ªán v·ªõi Admin -->
    <div id="mainContainer" class="container">
        <div class="header">
            <h1>üîê Qu·∫£n L√Ω T√†i Kho·∫£n N2 Shop</h1>
            <div class="admin-badge">üëë ADMIN PANEL</div>
            <div style="margin-top: 10px; color: #666; font-size: 14px;">
                ƒêƒÉng nh·∫≠p: <span id="currentUser">Loading...</span>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('manage')">üë• Qu·∫£n L√Ω Users</button>
            <button class="tab" onclick="showTab('create')">‚ûï T·∫°o M·ªõi</button>
            <button class="tab" onclick="showTab('tools')">üîß Tools</button>
        </div>

        <!-- Tab 1: Qu·∫£n L√Ω Users -->
        <div id="manage" class="tab-content active">
            <div class="section">
                <h2>K·∫øt N·ªëi Firebase</h2>
                <div id="firebaseStatus" class="output">ƒêang k·∫øt n·ªëi Firebase...</div>
                <button onclick="connectFirebase()" style="display: none;">K·∫øt N·ªëi L·∫°i</button>
            </div>

            <div class="section">
                <h2>üìã Danh S√°ch T√†i Kho·∫£n</h2>
                <button onclick="loadUsers()">üîÑ T·∫£i Danh S√°ch</button>
                <button onclick="exportUsers()" class="success">üìä Xu·∫•t Excel</button>
                <div id="userList" class="user-list">
                    <div style="padding: 20px; text-align: center;">Nh·∫•n "T·∫£i Danh S√°ch" ƒë·ªÉ xem users</div>
                </div>
            </div>

            <div class="section">
                <h2>‚úèÔ∏è Ch·ªânh S·ª≠a T√†i Kho·∫£n</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editUsername">Username:</label>
                        <input type="text" id="editUsername" placeholder="Ch·ªçn user t·ª´ danh s√°ch" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editDisplayName">T√™n hi·ªÉn th·ªã:</label>
                        <input type="text" id="editDisplayName" placeholder="T√™n hi·ªÉn th·ªã m·ªõi">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCheckLogin">Quy·ªÅn h·∫°n:</label>
                        <select id="editCheckLogin">
                            <option value="0">üëë Admin (0)</option>
                            <option value="1">üë§ User (1)</option>
                            <option value="2">üîí Limited (2)</option>
                            <option value="3">üìù Basic (3)</option>
                            <option value="777">üë• Guest (777)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editNewPassword">Password m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi):</label>
                        <input type="password" id="editNewPassword" placeholder="Password m·ªõi">
                    </div>
                </div>
                <button class="success" onclick="updateUser()">üíæ C·∫≠p Nh·∫≠t</button>
                <button onclick="clearEditForm()">üóëÔ∏è X√≥a Form</button>
                <div id="editOutput" class="output" style="display: none;"></div>
            </div>
        </div>

        <!-- Tab 2: T·∫°o User M·ªõi -->
        <div id="create" class="tab-content">
            <div class="section">
                <h2>‚ûï T·∫°o T√†i Kho·∫£n M·ªõi</h2>
                <div class="info">
                    <strong>‚ÑπÔ∏è L∆∞u √Ω:</strong> Password s·∫Ω ƒë∆∞·ª£c hash t·ª± ƒë·ªông b·∫±ng Crypto-JS ƒë·ªÉ ƒë·∫£m b·∫£o b·∫£o m·∫≠t.
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="newUsername">Username:</label>
                        <input type="text" id="newUsername" placeholder="Username (kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng)">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Password:</label>
                        <input type="password" id="newPassword" placeholder="Password m·∫°nh">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="newDisplayName">T√™n hi·ªÉn th·ªã:</label>
                        <input type="text" id="newDisplayName" placeholder="T√™n hi·ªÉn th·ªã (t·ª± ƒë·ªông ƒëi·ªÅn)">
                    </div>
                    <div class="form-group">
                        <label for="newCheckLogin">Quy·ªÅn h·∫°n:</label>
                        <select id="newCheckLogin">
                            <option value="0">üëë Admin (0)</option>
                            <option value="1" selected>üë§ User (1)</option>
                            <option value="2">üîí Limited (2)</option>
                            <option value="3">üìù Basic (3)</option>
                            <option value="777">üë• Guest (777)</option>
                        </select>
                    </div>
                </div>
                <button class="success" onclick="createUser()">‚úÖ T·∫°o T√†i Kho·∫£n</button>
                <button onclick="clearCreateForm()">üóëÔ∏è X√≥a Form</button>
                <div id="createOutput" class="output" style="display: none;"></div>
            </div>
        </div>

        <!-- Tab 3: Tools -->
        <div id="tools" class="tab-content">
            <div class="section">
                <h2>üîê T·∫°o Hash Password</h2>
                
                <div class="method-selector">
                    <label><input type="radio" name="method" value="cryptojs" checked> Crypto-JS (Nhanh)</label>
                    <label><input type="radio" name="method" value="bcrypt"> bcrypt (An to√†n h∆°n)</label>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" placeholder="Nh·∫≠p username">
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" placeholder="Nh·∫≠p password">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="displayName">T√™n hi·ªÉn th·ªã:</label>
                        <input type="text" id="displayName" placeholder="T√™n hi·ªÉn th·ªã">
                    </div>
                    <div class="form-group">
                        <label for="checkLogin">Quy·ªÅn h·∫°n:</label>
                        <select id="checkLogin">
                            <option value="0">üëë Admin (0)</option>
                            <option value="1" selected>üë§ User (1)</option>
                            <option value="2">üîí Limited (2)</option>
                            <option value="3">üìù Basic (3)</option>
                            <option value="777">üë• Guest (777)</option>
                        </select>
                    </div>
                </div>

                <button onclick="generateHash()">üîê T·∫°o Hash</button>
                <button onclick="clearHashForm()">üóëÔ∏è X√≥a Form</button>
                <div id="hashOutput" class="output" style="display: none;"></div>
            </div>

            <div class="section">
                <h2>üîç Ki·ªÉm Tra Password</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="testPassword">Test Password:</label>
                        <input type="password" id="testPassword" placeholder="Nh·∫≠p password ƒë·ªÉ test">
                    </div>
                    <div class="form-group">
                        <label for="testSalt">Salt (Crypto-JS):</label>
                        <input type="text" id="testSalt" placeholder="Salt t·ª´ hash output">
                    </div>
                </div>

                <div class="form-group">
                    <label for="testHash">Hash ƒë·ªÉ so s√°nh:</label>
                    <textarea id="testHash" rows="3" placeholder="Paste hash ƒë·ªÉ ki·ªÉm tra"></textarea>
                </div>

                <button onclick="verifyPassword()">‚úÖ Ki·ªÉm Tra</button>
                <div id="verifyOutput" class="output" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        let db = null;
        let auth = null;
        let currentMethod = 'cryptojs';
        let users = [];

        // Ki·ªÉm tra quy·ªÅn admin ngay khi t·∫£i trang
        function checkAdminAccess() {
            const checkLogin = localStorage.getItem('checkLogin');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const authData = localStorage.getItem('loginindex_auth');
            
            console.log('Checking admin access:', { checkLogin, isLoggedIn, authData: !!authData });
            
            if (!isLoggedIn || isLoggedIn !== 'true') {
                showAccessDenied('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p h·ªá th·ªëng.');
                return false;
            }
            
            if (!checkLogin || (checkLogin !== '0' && checkLogin !== 0)) {
                showAccessDenied('B·∫°n kh√¥ng c√≥ quy·ªÅn Admin.');
                return false;
            }

            // Hi·ªÉn th·ªã th√¥ng tin user hi·ªán t·∫°i
            try {
                const auth = JSON.parse(authData);
                document.getElementById('currentUser').textContent = auth.displayName || auth.username || 'Admin';
            } catch (e) {
                document.getElementById('currentUser').textContent = 'Admin';
            }

            // Hi·ªán container ch√≠nh
            document.getElementById('mainContainer').style.display = 'block';
            
            // T·ª± ƒë·ªông k·∫øt n·ªëi Firebase
            setTimeout(connectFirebase, 500);
            
            return true;
        }

        function showAccessDenied(reason = '') {
            document.getElementById('accessDenied').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
            
            if (reason) {
                const msg = document.querySelector('#accessDenied p');
                msg.innerHTML = reason + '<br>Ch·ªâ c√≥ Admin m·ªõi c√≥ th·ªÉ qu·∫£n l√Ω t√†i kho·∫£n.';
            }
        }

        // Firebase Configuration
        function connectFirebase() {
            try {
                if (!firebase.apps.length) {
                    const config = {
                        apiKey: "AIzaSyA-legWlCgjMDEy70rsaTTwLK39F4ZCKhM",
                        authDomain: "n2shop-69e37.firebaseapp.com", 
                        projectId: "n2shop-69e37",
                        storageBucket: "n2shop-69e37-ne0q1",
                        messagingSenderId: "598906493303",
                        appId: "1:598906493303:web:46d6236a1fdc2eff33e972"
                    };

                    const app = firebase.initializeApp(config);
                    db = firebase.firestore();
                    auth = firebase.auth();
                }

                document.getElementById('firebaseStatus').textContent = '‚úÖ K·∫øt n·ªëi Firebase th√†nh c√¥ng!\nProject: n2shop-69e37\nTr·∫°ng th√°i: Admin Access Granted';
                document.getElementById('firebaseStatus').className = 'output success';
                
                // T·ª± ƒë·ªông t·∫£i danh s√°ch users
                setTimeout(loadUsers, 1000);
                
            } catch (error) {
                document.getElementById('firebaseStatus').textContent = '‚ùå L·ªói k·∫øt n·ªëi Firebase: ' + error.message;
                document.getElementById('firebaseStatus').className = 'output error';
            }
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // User Management Functions
        async function loadUsers() {
            if (!db) {
                alert('Firebase ch∆∞a ƒë∆∞·ª£c k·∫øt n·ªëi!');
                return;
            }

            const userList = document.getElementById('userList');
            userList.innerHTML = '<div style="padding: 20px; text-align: center;">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>';

            try {
                const snapshot = await db.collection("users").get();
                users = [];
                
                snapshot.forEach((doc) => {
                    users.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                if (users.length === 0) {
                    userList.innerHTML = '<div style="padding: 20px; text-align: center;">üìù Kh√¥ng c√≥ t√†i kho·∫£n n√†o</div>';
                    return;
                }

                // S·∫Øp x·∫øp users theo quy·ªÅn h·∫°n v√† t√™n
                users.sort((a, b) => {
                    if (a.checkLogin !== b.checkLogin) {
                        return a.checkLogin - b.checkLogin;
                    }
                    return a.displayName.localeCompare(b.displayName);
                });

                let html = '';
                users.forEach((user, index) => {
                    const roleText = getRoleText(user.checkLogin);
                    const roleColor = getRoleColor(user.checkLogin);
                    
                    html += `
                        <div class="user-item">
                            <div class="user-info">
                                <strong style="color: ${roleColor};">${user.displayName}</strong> 
                                <span style="color: #666;">(${user.id})</span><br>
                                <small>
                                    ${roleText} | 
                                    ${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : 'N/A'}
                                    ${user.updatedAt ? ' | C·∫≠p nh·∫≠t: ' + new Date(user.updatedAt.seconds * 1000).toLocaleDateString('vi-VN') : ''}
                                </small>
                            </div>
                            <div class="user-actions">
                                <button onclick="editUser('${user.id}')" title="Ch·ªânh s·ª≠a">‚úèÔ∏è S·ª≠a</button>
                                <button class="danger" onclick="deleteUser('${user.id}')" title="X√≥a t√†i kho·∫£n">üóëÔ∏è X√≥a</button>
                            </div>
                        </div>
                    `;
                });

                userList.innerHTML = html;

            } catch (error) {
                userList.innerHTML = `<div style="padding: 20px; color: red;">‚ùå L·ªói t·∫£i danh s√°ch: ${error.message}</div>`;
                console.error('Load users error:', error);
            }
        }

        function getRoleText(checkLogin) {
            const roles = {
                0: 'üëë Admin',
                1: 'üë§ User',
                2: 'üîí Limited',
                3: 'üìù Basic',
                777: 'üë• Guest'
            };
            return roles[checkLogin] || `‚ö†Ô∏è Unknown (${checkLogin})`;
        }

        function getRoleColor(checkLogin) {
            const colors = {
                0: '#e74c3c',    // Admin - Red
                1: '#3498db',    // User - Blue
                2: '#f39c12',    // Limited - Orange
                3: '#27ae60',    // Basic - Green
                777: '#95a5a6'   // Guest - Gray
            };
            return colors[checkLogin] || '#666';
        }

        function editUser(username) {
            const user = users.find(u => u.id === username);
            if (!user) return;

            document.getElementById('editUsername').value = user.id;
            document.getElementById('editDisplayName').value = user.displayName;
            document.getElementById('editCheckLogin').value = user.checkLogin;
            document.getElementById('editNewPassword').value = '';

            // Scroll to edit section v√† switch tab
            showTab('manage');
            document.querySelector('#manage .section:nth-child(3)').scrollIntoView({ behavior: 'smooth' });
        }

        async function updateUser() {
            if (!db) {
                alert('Firebase ch∆∞a ƒë∆∞·ª£c k·∫øt n·ªëi!');
                return;
            }

            const username = document.getElementById('editUsername').value.trim();
            const displayName = document.getElementById('editDisplayName').value.trim();
            const checkLogin = parseInt(document.getElementById('editCheckLogin').value);
            const newPassword = document.getElementById('editNewPassword').value.trim();
            
            if (!username || !displayName) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            const output = document.getElementById('editOutput');
            output.style.display = 'block';
            output.textContent = 'ƒêang c·∫≠p nh·∫≠t t√†i kho·∫£n...';
            output.className = 'output';
            
            try {
                let updateData = {
                    displayName: displayName,
                    checkLogin: checkLogin,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: JSON.parse(localStorage.getItem('loginindex_auth')).username
                };

                // Hash new password if provided
                if (newPassword) {
                    const salt = CryptoJS.lib.WordArray.random(128/8).toString();
                    const hash = CryptoJS.PBKDF2(newPassword, salt, { 
                        keySize: 256/32,
                        iterations: 1000 
                    }).toString();
                    
                    updateData.passwordHash = hash;
                    updateData.salt = salt;
                }

                await db.collection("users").doc(username).update(updateData);

                output.textContent = `‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!\nUsername: ${username}\nT√™n hi·ªÉn th·ªã: ${displayName}\nQuy·ªÅn h·∫°n: ${getRoleText(checkLogin)}${newPassword ? '\nüîê ƒê√£ thay ƒë·ªïi password' : ''}`;
                output.className = 'output success';

                // Reload user list
                setTimeout(loadUsers, 1000);
                setTimeout(() => {
                    clearEditForm();
                }, 3000);

            } catch (error) {
                output.textContent = '‚ùå L·ªói c·∫≠p nh·∫≠t: ' + error.message;
                output.className = 'output error';
            }
        }

        async function deleteUser(username) {
            if (!db) {
                alert('Firebase ch∆∞a ƒë∆∞·ª£c k·∫øt n·ªëi!');
                return;
            }

            const user = users.find(u => u.id === username);
            if (!user) return;

            // Kh√¥ng cho ph√©p x√≥a admin cu·ªëi c√πng
            const adminCount = users.filter(u => u.checkLogin === 0).length;
            if (user.checkLogin === 0 && adminCount === 1) {
                alert('‚ùå Kh√¥ng th·ªÉ x√≥a admin cu·ªëi c√πng!\nH·ªá th·ªëng ph·∫£i c√≥ √≠t nh·∫•t 1 admin.');
                return;
            }

            const confirmMsg = `‚ö†Ô∏è X√ÅC NH·∫¨N X√ìA T√ÄI KHO·∫¢N\n\nUsername: ${username}\nT√™n: ${user.displayName}\nQuy·ªÅn h·∫°n: ${getRoleText(user.checkLogin)}\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?`;
            
            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                // Delete from users collection
                await db.collection("users").doc(username).delete();
                
                // Try to delete from auth_users if exists
                try {
                    const authUsersSnapshot = await db.collection("auth_users").where("username", "==", username).get();
                    authUsersSnapshot.forEach(async (doc) => {
                        await doc.ref.delete();
                    });
                } catch (authError) {
                    console.log('Could not delete from auth_users:', authError);
                }

                alert(`‚úÖ ƒê√£ x√≥a t√†i kho·∫£n "${username}" th√†nh c√¥ng!`);
                loadUsers(); // Reload user list

            } catch (error) {
                alert('‚ùå L·ªói x√≥a t√†i kho·∫£n: ' + error.message);
            }
        }

        async function createUser() {
            if (!db) {
                alert('Firebase ch∆∞a ƒë∆∞·ª£c k·∫øt n·ªëi!');
                return;
            }

            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const password = document.getElementById('newPassword').value.trim();
            const displayName = document.getElementById('newDisplayName').value.trim() || username.charAt(0).toUpperCase() + username.slice(1);
            const checkLogin = parseInt(document.getElementById('newCheckLogin').value);
            
            if (!username || !password) {
                alert('Vui l√≤ng nh·∫≠p username v√† password!');
                return;
            }

            // Validate username
            if (!/^[a-z0-9_]+$/.test(username)) {
                alert('Username ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i th∆∞·ªùng, s·ªë v√† d·∫•u g·∫°ch d∆∞·ªõi!');
                return;
            }

            if (password.length < 6) {
                alert('Password ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
                return;
            }

            const output = document.getElementById('createOutput');
            output.style.display = 'block';
            output.textContent = 'ƒêang t·∫°o t√†i kho·∫£n...';
            output.className = 'output';
            
            try {
                // Check if user exists
                const userDoc = await db.collection("users").doc(username).get();
                if (userDoc.exists) {
                    output.textContent = '‚ùå Username ƒë√£ t·ªìn t·∫°i!';
                    output.className = 'output error';
                    return;
                }

                // Create hash
                const salt = CryptoJS.lib.WordArray.random(128/8).toString();
                const hash = CryptoJS.PBKDF2(password, salt, { 
                    keySize: 256/32,
                    iterations: 1000 
                }).toString();

                // Create user document
                await db.collection("users").doc(username).set({
                    displayName: displayName,
                    checkLogin: checkLogin,
                    passwordHash: hash,
                    salt: salt,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: JSON.parse(localStorage.getItem('loginindex_auth')).username
                });

                output.textContent = `‚úÖ T·∫°o t√†i kho·∫£n th√†nh c√¥ng!\n\nUsername: ${username}\nT√™n hi·ªÉn th·ªã: ${displayName}\nQuy·ªÅn h·∫°n: ${getRoleText(checkLogin)}\nüîê Password ƒë√£ ƒë∆∞·ª£c hash an to√†n`;
                output.className = 'output success';

                // Clear form
                clearCreateForm();

                // Reload user list
                setTimeout(loadUsers, 1000);

            } catch (error) {
                output.textContent = '‚ùå L·ªói t·∫°o t√†i kho·∫£n: ' + error.message;
                output.className = 'output error';
            }
        }

        // Hash Generation Functions
        document.querySelectorAll('input[name="method"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentMethod = e.target.value;
            });
        });

        async function generateHash() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const displayName = document.getElementById('displayName').value.trim() || username.charAt(0).toUpperCase() + username.slice(1);
            const checkLogin = parseInt(document.getElementById('checkLogin').value);
            
            if (!username || !password) {
                alert('Vui l√≤ng nh·∫≠p username v√† password!');
                return;
            }

            const output = document.getElementById('hashOutput');
            output.style.display = 'block';
            
            try {
                let result = {
                    username: username,
                    displayName: displayName,
                    checkLogin: checkLogin
                };

                if (currentMethod === 'cryptojs' && typeof CryptoJS !== 'undefined') {
                    const salt = CryptoJS.lib.WordArray.random(128/8).toString();
                    const hash = CryptoJS.PBKDF2(password, salt, { 
                        keySize: 256/32,
                        iterations: 1000 
                    }).toString();
                    
                    result.passwordHash = hash;
                    result.salt = salt;
                    result.method = 'crypto-js';
                    
                } else if (currentMethod === 'bcrypt' && typeof bcrypt !== 'undefined') {
                    output.textContent = 'ƒêang t·∫°o bcrypt hash...';
                    const saltRounds = 10;
                    const hash = await bcrypt.hash(password, saltRounds);
                    
                    result.passwordHash = hash;
                    result.method = 'bcrypt';
                } else {
                    output.textContent = 'L·ªói: Th∆∞ vi·ªán crypto ch∆∞a load!';
                    return;
                }
                
                displayHashResult(output, result);
                
                // Auto populate test fields
                document.getElementById('testHash').value = result.passwordHash;
                if (result.salt) {
                    document.getElementById('testSalt').value = result.salt;
                }
                
            } catch (error) {
                output.textContent = 'L·ªói: ' + error.message;
                output.className = 'output error';
            }
        }

        function displayHashResult(output, result) {
            let text = `‚úÖ T·∫°o hash th√†nh c√¥ng!\n\n`;
            text += `Method: ${result.method}\n`;
            text += `Username: ${result.username}\n`;
            text += `Display Name: ${result.displayName}\n`;
            text += `Check Login: ${result.checkLogin} (${getRoleText(result.checkLogin)})\n`;
            text += `Password Hash: ${result.passwordHash}\n`;
            if (result.salt) {
                text += `Salt: ${result.salt}\n`;
            }
            
            text += `\n--- Firebase Document ---\n`;
            text += `Collection: users\n`;
            text += `Document ID: ${result.username}\n\n`;
            text += JSON.stringify({
                displayName: result.displayName,
                checkLogin: result.checkLogin,
                passwordHash: result.passwordHash,
                ...(result.salt && { salt: result.salt })
            }, null, 2);
            
            output.textContent = text;
            output.className = 'output success';
        }

        async function verifyPassword() {
            const testPassword = document.getElementById('testPassword').value.trim();
            const testHash = document.getElementById('testHash').value.trim();
            const testSalt = document.getElementById('testSalt').value.trim();
            const output = document.getElementById('verifyOutput');
            
            if (!testPassword || !testHash) {
                output.style.display = 'block';
                output.textContent = 'Vui l√≤ng nh·∫≠p password v√† hash ƒë·ªÉ test!';
                output.className = 'output error';
                return;
            }

            output.style.display = 'block';
            
            try {
                let isMatch = false;
                let method = '';
                
                if (typeof bcrypt !== 'undefined' && testHash.startsWith('$2')) {
                    isMatch = await bcrypt.compare(testPassword, testHash);
                    method = 'bcrypt';
                } else if (typeof CryptoJS !== 'undefined' && testSalt) {
                    const computedHash = CryptoJS.PBKDF2(testPassword, testSalt, { 
                        keySize: 256/32,
                        iterations: 1000 
                    }).toString();
                    isMatch = computedHash === testHash;
                    method = 'crypto-js';
                } else {
                    output.textContent = 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh method ho·∫∑c thi·∫øu salt!';
                    output.className = 'output error';
                    return;
                }
                
                if (isMatch) {
                    output.textContent = `‚úÖ Password ƒê√öNG!\nMethod: ${method}\nHash kh·ªõp v·ªõi password ƒë√£ nh·∫≠p.`;
                    output.className = 'output success';
                } else {
                    output.textContent = `‚ùå Password SAI!\nMethod: ${method}\nHash kh√¥ng kh·ªõp v·ªõi password ƒë√£ nh·∫≠p.`;
                    output.className = 'output error';
                }
                
            } catch (error) {
                output.textContent = 'L·ªói: ' + error.message;
                output.className = 'output error';
            }
        }

        // Export function
        async function exportUsers() {
            if (users.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                return;
            }

            try {
                let csv = 'Username,Display Name,Role,Role Code,Created Date,Updated Date\n';
                
                users.forEach(user => {
                    const createdDate = user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : 'N/A';
                    const updatedDate = user.updatedAt ? new Date(user.updatedAt.seconds * 1000).toLocaleDateString('vi-VN') : 'N/A';
                    
                    csv += `${user.id},"${user.displayName}","${getRoleText(user.checkLogin)}",${user.checkLogin},"${createdDate}","${updatedDate}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `N2Shop_Users_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('‚úÖ ƒê√£ xu·∫•t file CSV th√†nh c√¥ng!');
                
            } catch (error) {
                alert('‚ùå L·ªói xu·∫•t file: ' + error.message);
            }
        }

        // Clear form functions
        function clearEditForm() {
            document.getElementById('editUsername').value = '';
            document.getElementById('editDisplayName').value = '';
            document.getElementById('editCheckLogin').value = '1';
            document.getElementById('editNewPassword').value = '';
            const output = document.getElementById('editOutput');
            output.style.display = 'none';
            output.textContent = '';
            output.className = 'output';
        }

        function clearCreateForm() {
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newDisplayName').value = '';
            document.getElementById('newCheckLogin').value = '1';
            const output = document.getElementById('createOutput');
            output.style.display = 'none';
            output.textContent = '';
            output.className = 'output';
        }

        function clearHashForm() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('displayName').value = '';
            document.getElementById('checkLogin').value = '1';
            const output = document.getElementById('hashOutput');
            output.style.display = 'none';
            output.textContent = '';
            output.className = 'output';
        }

        // Auto-fill display name when username changes
        document.getElementById('username').addEventListener('input', function() {
            const username = this.value.trim();
            if (username && !document.getElementById('displayName').value) {
                document.getElementById('displayName').value = username.charAt(0).toUpperCase() + username.slice(1);
            }
        });

        document.getElementById('newUsername').addEventListener('input', function() {
            const username = this.value.trim();
            if (username && !document.getElementById('newDisplayName').value) {
                document.getElementById('newDisplayName').value = username.charAt(0).toUpperCase() + username.slice(1);
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('User Management page loading...');
            
            // Check admin access first
            if (!checkAdminAccess()) {
                return;
            }
            
            console.log('Admin access granted, initializing...');
            
            // Initialize crypto libraries check
            setTimeout(() => {
                if (typeof CryptoJS !== 'undefined' && typeof bcrypt !== 'undefined') {
                    console.log('‚úÖ Crypto libraries loaded successfully');
                } else {
                    console.warn('‚ö†Ô∏è Some crypto libraries failed to load');
                }
            }, 1000);
        });

        // Security: Clear sensitive data on page unload
        window.addEventListener('beforeunload', function() {
            // Clear any sensitive data if needed
            console.log('Page unloading, cleaning up...');
        });

        // Prevent right-click context menu in production
        document.addEventListener('contextmenu', function(e) {
            const checkLogin = localStorage.getItem('checkLogin');
            if (checkLogin !== '0' && checkLogin !== 0) {
                e.preventDefault();
            }
        });

        console.log('User Management System initialized');
    </script>
</body>
</html><!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω T√†i Kho·∫£n Firebase</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/3.0.1/bcrypt.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .section h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }

        input:focus, textarea:focus, select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        button.success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .output {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .user-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .user-info {
            flex: 1;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-actions button {
            padding: 6px 12px;
            font-size: 12px;
        }

        .firebase-config {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .method-selector {
            margin-bottom: 20px;
        }

        .method-selector input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }

        .method-selector label {
            display: inline;
            margin-right: 20px;
            font-weight: normal;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Qu·∫£n L√Ω T√†i Kho·∫£n Firebase</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('hash')">T·∫°o Hash</button>
            <button class="tab" onclick="showTab('manage')">Qu·∫£n L√Ω T√†i Kho·∫£n</button>
            <button class="tab" onclick="showTab('firebase')">K·∫øt N·ªëi Firebase</button>
        </div>

        <!-- Tab 1: T·∫°o Hash Password -->
        <div id="hash" class="tab-content active">
            <div class="warning">
                <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> Tool n√†y ƒë·ªÉ t·∫°o hash password cho vi·ªác l∆∞u tr·ªØ an to√†n trong Firebase. Kh√¥ng bao gi·ªù l∆∞u password d·∫°ng plaintext!
            </div>

            <div class="section">
                <h2>1. T·∫°o Hash Password</h2>
                
                <div class="method-selector">
                    <label><input type="radio" name="method" value="cryptojs" checked> Crypto-JS (Nhanh)</label>
                    <label><input type="radio" name="method" value="bcrypt"> bcrypt (An to√†n h∆°n)</label>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" placeholder="Nh·∫≠p username" value="admin">
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" placeholder="Nh·∫≠p password" value="123456">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="displayName">T√™n hi·ªÉn th·ªã:</label>
                        <input type="text" id="displayName" placeholder="T√™n hi·ªÉn th·ªã">
                    </div>
                    <div class="form-group">
                        <label for="checkLogin">Quy·ªÅn h·∫°n:</label>
                        <select id="checkLogin">
                            <option value="0">Admin (0)</option>
                            <option value="1" selected>User (1)</option>
                            <option value="2">Limited (2)</option>
                            <option value="3">Basic (3)</option>
                            <option value="777">Guest (777)</option>
                        </select>
                    </div>
                </div>

                <button onclick="generateHash()">T·∫°o Hash</button>
                <button onclick="clearAll()">X√≥a t·∫•t c·∫£</button>

                <div id="hashOutput" class="output"></div>
            </div>

            <div class="section">
                <h2>2. Ki·ªÉm tra Password</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="testPassword">Test Password:</label>
                        <input type="password" id="testPassword" placeholder="Nh·∫≠p password ƒë·ªÉ test">
                    </div>
                    <div class="form-group">
                        <label for="testSalt">Salt (n·∫øu d√πng Crypto-JS):</label>
                        <input type="text" id="testSalt" placeholder="Paste salt t·ª´ output">
                    </div>
                </div>

                <div class="form-group">
                    <label for="testHash">Hash ƒë·ªÉ so s√°nh:</label>
                    <textarea id="testHash" rows="3" placeholder="Paste hash t·ª´ output tr√™n"></textarea>
                </div>

                <button onclick="verifyPassword()">Ki·ªÉm tra</button>
                <div id="verifyOutput" class="output"></div>
            </div>
        </div>

        <!-- Tab 2: Qu·∫£n L√Ω T√†i Kho·∫£n -->
        <div id="manage" class="tab-content">
            <div class="section">
                <h2>K·∫øt N·ªëi Firebase</h2>
                <div id="firebaseStatus" class="output">Ch∆∞a k·∫øt n·ªëi Firebase</div>
                <button onclick="connectFirebase()">K·∫øt N·ªëi Firebase</button>
            </div>

            <div class="section">
                <h2>T·∫°o T√†i Kho·∫£n M·ªõi</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="newUsername">Username:</label>
                        <input type="text" id="newUsername" placeholder="Nh·∫≠p username">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Password:</label>
                        <input type="password" id="newPassword" placeholder="Nh·∫≠p password">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="newDisplayName">T√™n hi·ªÉn th·ªã:</label>
                        <input type="text" id="newDisplayName" placeholder="T√™n hi·ªÉn th·ªã">
                    </div>
                    <div class="form-group">
                        <label for="newCheckLogin">Quy·ªÅn h·∫°n:</label>
                        <select id="newCheckLogin">
                            <option value="0">Admin (0)</option>
                            <option value="1" selected>User (1)</option>
                            <option value="2">Limited (2)</option>
                            <option value="3">Basic (3)</option>
                            <option value="777">Guest (777)</option>
                        </select>
                    </div>
                </div>
                <button class="success" onclick="createUser()">T·∫°o T√†i Kho·∫£n</button>
                <div id="createOutput" class="output"></div>
            </div>

            <div class="section">
                <h2>Danh S√°ch T√†i Kho·∫£n</h2>
                <button onclick="loadUsers()">T·∫£i Danh S√°ch</button>
                <div id="userList" class="user-list"></div>
            </div>

            <div class="section">
                <h2>Ch·ªânh S·ª≠a T√†i Kho·∫£n</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editUsername">Username:</label>
                        <input type="text" id="editUsername" placeholder="Username ƒë·ªÉ ch·ªânh s·ª≠a" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editDisplayName">T√™n hi·ªÉn th·ªã:</label>
                        <input type="text" id="editDisplayName" placeholder="T√™n hi·ªÉn th·ªã m·ªõi">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCheckLogin">Quy·ªÅn h·∫°n:</label>
                        <select id="editCheckLogin">
                            <option value="0">Admin (0)</option>
                            <option value="1">User (1)</option>
                            <option value="2">Limited (2)</option>
                            <option value="3">Basic (3)</option>
                            <option value="777">Guest (777)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editNewPassword">Password m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi):</label>
                        <input type="password" id="editNewPassword" placeholder="Password m·ªõi">
                    </div>
                </div>
                <button class="success" onclick="updateUser()">C·∫≠p Nh·∫≠t</button>
                <button onclick="clearEditForm()">X√≥a Form</button>
                <div id="editOutput" class="output"></div>
            </div>
        </div>

        <!-- Tab 3: Firebase Config -->
        <div id="firebase" class="tab-content">
            <div class="firebase-config">
                <h3>C·∫•u H√¨nh Firebase</h3>
                <p>Nh·∫≠p th√¥ng tin Firebase c·ªßa b·∫°n:</p>
            </div>

            <div class="section">
                <h2>Firebase Configuration</h2>
                <div class="form-group">
                    <label for="apiKey">API Key:</label>
                    <input type="text" id="apiKey" placeholder="AIzaSy...">
                </div>
                <div class="form-group">
                    <label for="authDomain">Auth Domain:</label>
                    <input type="text" id="authDomain" placeholder="your-app.firebaseapp.com">
                </div>
                <div class="form-group">
                    <label for="projectId">Project ID:</label>
                    <input type="text" id="projectId" placeholder="your-project-id">
                </div>
                <div class="form-group">
                    <label for="storageBucket">Storage Bucket:</label>
                    <input type="text" id="storageBucket" placeholder="your-app.appspot.com">
                </div>
                <div class="form-group">
                    <label for="messagingSenderId">Messaging Sender ID:</label>
                    <input type="text" id="messagingSenderId" placeholder="123456789">
                </div>
                <div class="form-group">
                    <label for="appId">App ID:</label>
                    <input type="text" id="appId" placeholder="1:123456789:web:...">
                </div>

                <button onclick="saveFirebaseConfig()">L∆∞u C·∫•u H√¨nh</button>
                <button onclick="loadDefaultConfig()">Load Config M·∫∑c ƒê·ªãnh</button>
                <div id="configOutput" class="output"></div>
            </div>
        </div>
    </div>

    <script>
        let db = null;
        let auth = null;
        let currentMethod = 'cryptojs';
        let users = [];

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            // Add active class to selected tab
            event.target.classList.add('active');
        }

        // Firebase Configuration
        function loadDefaultConfig() {
            document.getElementById('apiKey').value = 'AIzaSyA-legWlCgjMDEy70rsaTTwLK39F4ZCKhM';
            document.getElementById('authDomain').value = 'n2shop-69e37.firebaseapp.com';
            document.getElementById('projectId').value = 'n2shop-69e37';
            document.getElementById('storageBucket').value = 'n2shop-69e37-ne0q1';
            document.getElementById('messagingSenderId').value = '598906493303';
            document.getElementById('appId').value = '1:598906493303:web:46d6236a1fdc2eff33e972';
        }

        function saveFirebaseConfig() {
            const config = {
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                projectId: document.getElementById('projectId').value,
                storageBucket: document.getElementById('storageBucket').value,
                messagingSenderId: document.getElementById('messagingSenderId').value,
                appId: document.getElementById('appId').value
            };

            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            document.getElementById('configOutput').textContent = 'ƒê√£ l∆∞u c·∫•u h√¨nh Firebase v√†o localStorage';
            document.getElementById('configOutput').className = 'output success';
        }

        function connectFirebase() {
            try {
                const savedConfig = localStorage.getItem('firebaseConfig');
                let config;

                if (savedConfig) {
                    config = JSON.parse(savedConfig);
                } else {
                    // Use default config
                    config = {
                        apiKey: "AIzaSyA-legWlCgjMDEy70rsaTTwLK39F4ZCKhM",
                        authDomain: "n2shop-69e37.firebaseapp.com", 
                        projectId: "n2shop-69e37",
                        storageBucket: "n2shop-69e37-ne0q1",
                        messagingSenderId: "598906493303",
                        appId: "1:598906493303:web:46d6236a1fdc2eff33e972"
                    };
                }

                if (!firebase.apps.length) {
                    const app = firebase.initializeApp(config);
                    db = firebase.firestore();
                    auth = firebase.auth();
                    
                    document.getElementById('firebaseStatus').textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi Firebase th√†nh c√¥ng!\nProject: ' + config.projectId;
                    document.getElementById('firebaseStatus').className = 'output success';
                } else {
                    document.getElementById('firebaseStatus').textContent = '‚úÖ Firebase ƒë√£ ƒë∆∞·ª£c k·∫øt n·ªëi tr∆∞·ªõc ƒë√≥';
                    document.getElementById('firebaseStatus').className = 'output success';
                }
            } catch (error) {
                document.getElementById('firebaseStatus').textContent = '‚ùå L·ªói k·∫øt n·ªëi Firebase: ' + error.message;
                document.getElementById('firebaseStatus').className = 'output error';
            }
        }

        // Password Hash Functions
        document.querySelectorAll('input[name="method"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentMethod = e.target.value;
            });
        });

        async function generateHash() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const displayName = document.getElementById('displayName').value.trim() || username.charAt(0).toUpperCase() + username.slice(1);
            const checkLogin = parseInt(document.getElementById('checkLogin').value);
            
            if (!username || !password) {
                alert('Vui l√≤ng nh·∫≠p username v√† password!');
                return;
            }

            const output = document.getElementById('hashOutput');
            
            try {
                let result = {
                    username: username,
                    displayName: displayName,
                    checkLogin: checkLogin
                };

                if (currentMethod === 'cryptojs' && typeof CryptoJS !== 'undefined') {
                    const salt = CryptoJS.lib.WordArray.random(128/8).toString();
                    const hash = CryptoJS.PBKDF2(password, salt, { 
                        keySize: 256/32,
                        iterations: 1000 
                    }).toString();
                    
                    result.passwordHash = hash;
                    result.salt = salt;
                    result.method = 'crypto-js';
                    
                } else if (currentMethod === 'bcrypt' && typeof bcrypt !== 'undefined') {
                    output.textContent = 'ƒêang t·∫°o bcrypt hash...';
                    const saltRounds = 10;
                    const hash = await bcrypt.hash(password, saltRounds);
                    
                    result.passwordHash = hash;
                    result.method = 'bcrypt';
                } else {
                    output.textContent = 'L·ªói: Th∆∞ vi·ªán crypto ch∆∞a load!';
                    return;
                }
                
                displayHashResult(output, result);
                
                // Auto populate test fields
                document.getElementById('testHash').value = result.passwordHash;
                if (result.salt) {
                    document.getElementById('testSalt').value = result.salt;
                }
                
            } catch (error) {
                output.textContent = 'L·ªói: ' + error.message;
                output.className = 'output error';
            }
        }

        function displayHashResult(output, result) {
            let text = `‚úÖ T·∫°o hash th√†nh c√¥ng!\n\n`;
            text += `Method: ${result.method}\n`;
            text += `Username: ${result.username}\n`;
            text += `Display Name: ${result.displayName}\n`;
            text += `Check Login: ${result.checkLogin}\n`;
            text += `Password Hash: ${result.passwordHash}\n`;
            if (result.salt) {
                text += `Salt: ${result.salt}\n`;
            }
            
            text += `\n--- Firebase Document ---\n`;
            text += `Collection: users\n`;
            text += `Document ID: ${result.username}\n\n`;
            text += JSON.stringify({
                displayName: result.displayName,
                checkLogin: result.checkLogin,
                passwordHash: result.passwordHash,
                ...(result.salt && { salt: result.salt })
            }, null, 2);
            
            output.textContent = text;
            output.className = 'output success';
        }

        async function verifyPassword() {
            const testPassword = document.getElementById('testPassword').value.trim();
            const testHash = document.getElementById('testHash').value.trim();
            const testSalt = document.getElementById('testSalt').value.trim();
            const output = document.getElementById('verifyOutput');
            
            if (!testPassword || !testHash) {
                output.textContent = 'Vui l√≤ng nh·∫≠p password v√† hash ƒë·ªÉ test!';
                return;
            }

            try {
                let isMatch = false;
                let method = '';
                
                if (typeof bcrypt !== 'undefined' && testHash.startsWith('$2')) {
                    isMatch = await bcrypt.compare(testPassword, testHash);
                    method = 'bcrypt';
                } else if (typeof CryptoJS !== 'undefined' && testSalt) {
                    const computedHash = CryptoJS.PBKDF2(testPassword, testSalt, { 
                        keySize: 256/32,
                        iterations: 1000 
                    }).toString();
                    isMatch = computedHash === testHash;
                    method = 'crypto-js';
                } else {
                    output.textContent = 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh method ho·∫∑c thi·∫øu salt!';
                    return;
                }
                
                if (isMatch) {
                    output.textContent = `‚úÖ Password ƒê√öNG! (Method: ${method})`;
                    output.className = 'output success';
                } else {
                    output.textContent = `‚ùå Password SAI! (Method: ${method})`;
                    output.className = 'output error';
                }
                
            } catch (error) {
                output.textContent = 'L·ªói: ' + error.message;
                output.className = 'output error';
            }
        }

        // User Management Functions
        async function createUser() {
            if (!db) {
                alert('Vui l√≤ng k·∫øt n·ªëi Firebase tr∆∞·ªõc!');
                return;
            }

            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const displayName = document.getElementById('newDisplayName').value.trim() || username.charAt(0).toUpperCase() + username.slice(1);
            const checkLogin = parseInt(document.getElementById('newCheckLogin').value);
            
            if (!username || !password) {
                alert('Vui l√≤ng nh·∫≠p username v√† password!');
                return;
            }

            const output = document.getElementById('createOutput');
            output.textContent = 'ƒêang t·∫°o t√†i kho·∫£n...';
            
            try {
                // Check if user exists
                const userDoc = await db.collection("users").doc(username).get();
                if (userDoc.exists) {
                    output.textContent = '‚ùå Username ƒë√£ t·ªìn t·∫°i!';
                    output.className = 'output error';
                    return;
                }

                // Create hash
                const salt = CryptoJS.lib.WordArray.random(128/8).toString();
                const hash = CryptoJS.PBKDF2(password, salt, { 
                    keySize: 256/32,
                    iterations: 1000 
                }).toString();

                // Create user document
                await db.collection("users").doc(username).set({
                    displayName: displayName,
                    checkLogin: checkLogin,
                    passwordHash: hash,
                    salt: salt,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                output.textContent = `‚úÖ T·∫°o t√†i kho·∫£n th√†nh c√¥ng!\nUsername: ${username}\nT√™n hi·ªÉn th·ªã: ${displayName}\nQuy·ªÅn h·∫°n: ${checkLogin}`;
                output.className = 'output success';

                // Clear form
                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('newDisplayName').value = '';
                document.getElementById('newCheckLogin').value = '1';

                // Reload user list
                setTimeout(loadUsers, 1000);

            } catch (error) {
                output.textContent = '‚ùå L·ªói t·∫°o t√†i kho·∫£n: ' + error.message;
                output.className = 'output error';
            }
        }

        async function loadUsers() {
            if (!db) {
                alert('Vui l√≤ng k·∫øt n·ªëi Firebase tr∆∞·ªõc!');
                return;
            }

            const userList = document.getElementById('userList');
            userList.innerHTML = '<div style="padding: 20px; text-align: center;">ƒêang t·∫£i...</div>';

            try {
                const snapshot = await db.collection("users").get();
                users = [];
                
                snapshot.forEach((doc) => {
                    users.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                if (users.length === 0) {
                    userList.innerHTML = '<div style="padding: 20px; text-align: center;">Kh√¥ng c√≥ t√†i kho·∫£n n√†o</div>';
                    return;
                }

                let html = '';
                users.forEach((user, index) => {
                    html += `
                        <div class="user-item">
                            <div class="user-info">
                                <strong>${user.displayName}</strong> (${user.id})<br>
                                <small>Quy·ªÅn h·∫°n: ${user.checkLogin} | ${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</small>
                            </div>
                            <div class="user-actions">
                                <button onclick="editUser('${user.id}')">S·ª≠a</button>
                                <button class="danger" onclick="deleteUser('${user.id}')">X√≥a</button>
                            </div>
                        </div>
                    `;
                });

                userList.innerHTML = html;

            } catch (error) {
                userList.innerHTML = `<div style="padding: 20px; color: red;">‚ùå L·ªói t·∫£i danh s√°ch: ${error.message}</div>`;
            }
        }

        function editUser(username) {
            const user = users.find(u => u.id === username);
            if (!user) return;

            document.getElementById('editUsername').value = user.id;
            document.getElementById('editDisplayName').value = user.displayName;
            document.getElementById('editCheckLogin').value = user.checkLogin;
            document.getElementById('editNewPassword').value = '';

            // Scroll to edit section
            document.querySelector('#manage .section:nth-child(4)').scrollIntoView({ behavior: 'smooth' });
        }

        async function updateUser() {
            if (!db) {
                alert('Vui l√≤ng k·∫øt n·ªëi Firebase tr∆∞·ªõc!');
                return;
            }

            const username = document.getElementById('editUsername').value.trim();
            const displayName = document.getElementById('editDisplayName').value.trim();
            const checkLogin = parseInt(document.getElementById('editCheckLogin').value);
            const newPassword = document.getElementById('editNewPassword').value.trim();
            
            if (!username || !displayName) {
                alert('Vui l√≤ng nh·∫≠p username v√† t√™n hi·ªÉn th·ªã!');
                return;
            }

            const output = document.getElementById('editOutput');
            output.textContent = 'ƒêang c·∫≠p nh·∫≠t t√†i kho·∫£n...';
            
            try {
                let updateData = {
                    displayName: displayName,
                    checkLogin: checkLogin,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // If new password is provided, hash it
                if (newPassword) {
                    const salt = CryptoJS.lib.WordArray.random(128/8).toString();
                    const hash = CryptoJS.PBKDF2(newPassword, salt, { 
                        keySize: 256/32,
                        iterations: 1000 
                    }).toString();
                    
                    updateData.passwordHash = hash;
                    updateData.salt = salt;
                }

                await db.collection("users").doc(username).update(updateData);

                output.textContent = `‚úÖ C·∫≠p nh·∫≠t t√†i kho·∫£n th√†nh c√¥ng!\nUsername: ${username}\nT√™n hi·ªÉn th·ªã: ${displayName}\nQuy·ªÅn h·∫°n: ${checkLogin}${newPassword ? '\nƒê√£ thay ƒë·ªïi password' : ''}`;
                output.className = 'output success';

                // Reload user list
                setTimeout(loadUsers, 1000);

            } catch (error) {
                output.textContent = '‚ùå L·ªói c·∫≠p nh·∫≠t t√†i kho·∫£n: ' + error.message;
                output.className = 'output error';
            }
        }

        async function deleteUser(username) {
            if (!db) {
                alert('Vui l√≤ng k·∫øt n·ªëi Firebase tr∆∞·ªõc!');
                return;
            }

            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n "${username}"?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                return;
            }

            try {
                await db.collection("users").doc(username).delete();
                
                // Also try to delete from auth_users if exists
                try {
                    const authUsersSnapshot = await db.collection("auth_users").where("username", "==", username).get();
                    authUsersSnapshot.forEach(async (doc) => {
                        await doc.ref.delete();
                    });
                } catch (authError) {
                    console.log('Could not delete from auth_users:', authError);
                }

                alert(`‚úÖ ƒê√£ x√≥a t√†i kho·∫£n "${username}" th√†nh c√¥ng!`);
                loadUsers(); // Reload user list

            } catch (error) {
                alert('‚ùå L·ªói x√≥a t√†i kho·∫£n: ' + error.message);
            }
        }

        function clearEditForm() {
            document.getElementById('editUsername').value = '';
            document.getElementById('editDisplayName').value = '';
            document.getElementById('editCheckLogin').value = '1';
            document.getElementById('editNewPassword').value = '';
            document.getElementById('editOutput').textContent = '';
            document.getElementById('editOutput').className = 'output';
        }

        function clearAll() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('displayName').value = '';
            document.getElementById('checkLogin').value = '1';
            document.getElementById('testPassword').value = '';
            document.getElementById('testHash').value = '';
            document.getElementById('testSalt').value = '';
            document.getElementById('hashOutput').textContent = '';
            document.getElementById('verifyOutput').textContent = '';
            
            // Reset classes
            document.getElementById('hashOutput').className = 'output';
            document.getElementById('verifyOutput').className = 'output';
        }

        // Auto-fill display name when username changes
        document.getElementById('username').addEventListener('input', function() {
            const username = this.value.trim();
            if (username && !document.getElementById('displayName').value) {
                document.getElementById('displayName').value = username.charAt(0).toUpperCase() + username.slice(1);
            }
        });

        document.getElementById('newUsername').addEventListener('input', function() {
            const username = this.value.trim();
            if (username && !document.getElementById('newDisplayName').value) {
                document.getElementById('newDisplayName').value = username.charAt(0).toUpperCase() + username.slice(1);
            }
        });

        // Load saved config on page load
        window.addEventListener('load', () => {
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('apiKey').value = config.apiKey || '';
                    document.getElementById('authDomain').value = config.authDomain || '';
                    document.getElementById('projectId').value = config.projectId || '';
                    document.getElementById('storageBucket').value = config.storageBucket || '';
                    document.getElementById('messagingSenderId').value = config.messagingSenderId || '';
                    document.getElementById('appId').value = config.appId || '';
                } catch (e) {
                    console.log('Could not load saved config:', e);
                }
            } else {
                // Load default config
                loadDefaultConfig();
            }

            // Check if libraries are loaded
            setTimeout(() => {
                if (typeof CryptoJS !== 'undefined' && typeof bcrypt !== 'undefined') {
                    console.log('‚úÖ Crypto libraries loaded successfully');
                } else {
                    console.error('‚ùå Some crypto libraries failed to load');
                }
            }, 1000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + Enter to generate hash
            if (e.ctrlKey && e.key === 'Enter') {
                if (document.getElementById('hash').classList.contains('active')) {
                    generateHash();
                }
            }
        });
    </script>
</body>
</html>
