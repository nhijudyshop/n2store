<!--
  üìñ GHI CH√ö CHO L·∫¨P TR√åNH VI√äN:
  Khi code ph·∫£i ƒë·ªçc th∆∞ m·ª•c https://github.com/nhijudyshop/n2store/tree/main/docs tr∆∞·ªõc!
  ƒê·ªçc c√°c file SHARED_*.md ƒë·ªÉ hi·ªÉu c√°ch s·ª≠ d·ª•ng shared modules.
-->
<!doctype html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω T√†i Kho·∫£n - N2 Shop</title>
    <meta http-equiv="Cache-Control" content="public, max-age=31536000" />

    <!-- External CSS -->
    <link rel="stylesheet" href="css/modern.css" />
    <link rel="stylesheet" href="css/user-management.css" />
    <link rel="stylesheet" href="css/detailed-permissions.css" />

    <!-- Lucide Icons -->
    <!-- N2Store Optimization: Core Utilities Loader -->
    <script src="../shared/js/core-loader.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

    <!-- Crypto Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/3.0.1/bcrypt.min.js"></script>

    <!-- Navigation & Utils -->
    <script src="../shared/js/navigation-modern.js"></script>
    <script src="../shared/js/common-utils.js"></script>
</head>

<body>
    <!-- Access Denied (Hidden by default) -->
    <div id="accessDenied" class="access-denied" style="display: none">
        <h1>
            <i data-lucide="shield-x"></i>
            Truy c·∫≠p b·ªã t·ª´ ch·ªëi
        </h1>
        <p>
            B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p v√†o trang n√†y.<br />
            Ch·ªâ c√≥ Admin m·ªõi c√≥ th·ªÉ qu·∫£n l√Ω t√†i kho·∫£n.
        </p>
        <a href="../live/index.html" class="btn btn-primary">
            <i data-lucide="arrow-left"></i>
            Quay v·ªÅ trang ch√≠nh
        </a>
    </div>

    <!-- Main Container (Hidden until auth check) -->
    <div id="mainContainer" style="display: none">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i data-lucide="zap"></i>
                    <span>N2Shop</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i data-lucide="panel-left-close"></i>
                </button>
            </div>

            <nav class="sidebar-nav" id="sidebarNav">
                <!-- Menu items will be auto-generated by navigation-modern.js -->
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <i data-lucide="user-circle"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role">Qu·∫£n tr·ªã vi√™n</div>
                    </div>
                </div>
                <button class="btn-permissions" id="btnPermissions">
                    <i data-lucide="shield-check"></i>
                    <span>Xem Quy·ªÅn C·ªßa T√¥i</span>
                </button>
                <button class="btn-logout" id="btnLogout">
                    <i data-lucide="log-out"></i>
                    <span>ƒêƒÉng xu·∫•t</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="btn-icon" id="menuToggle">
                        <i data-lucide="menu"></i>
                    </button>
                    <div class="breadcrumb">
                        <i data-lucide="home"></i>
                        <span>Qu·∫£n L√Ω T√†i Kho·∫£n</span>
                    </div>
                </div>
                <div class="top-bar-right">
                    <button class="btn btn-primary" id="btnShowCreate">
                        <i data-lucide="user-plus"></i>
                        <span>T·∫°o User</span>
                    </button>
                    <button class="btn-icon" id="btnRefresh" title="L√†m m·ªõi">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                    <div class="search-box">
                        <i data-lucide="search"></i>
                        <input type="text" placeholder="T√¨m ki·∫øm..." id="searchInput" />
                    </div>
                </div>
            </header>

            <!-- Tab Navigation -->
            <section class="card" style="margin: 0 var(--spacing-xl) var(--spacing-xl)">
                <div class="card-header" style="border-bottom: none; padding-bottom: 0">
                    <div class="category-tabs" style="margin: 0">
                        <button class="tab-btn active" data-tab="manage">
                            <i data-lucide="users"></i>
                            Qu·∫£n L√Ω Users
                        </button>
                        <button class="tab-btn" data-tab="create">
                            <i data-lucide="user-plus"></i>
                            T·∫°o M·ªõi
                        </button>
                        <button class="tab-btn" data-tab="permissions">
                            <i data-lucide="shield-check"></i>
                            Quy·ªÅn Truy C·∫≠p
                        </button>
                        <button class="tab-btn" data-tab="decode-tool">
                            <i data-lucide="lock-keyhole"></i>
                            Gi·∫£i M√£
                        </button>
                        <button class="tab-btn" data-tab="menu-rename">
                            <i data-lucide="edit-3"></i>
                            ƒê·ªïi T√™n Menu
                        </button>
                        <button class="tab-btn" data-tab="templates">
                            <i data-lucide="layout-template"></i>
                            Qu·∫£n L√Ω Templates
                        </button>
                    </div>
                </div>
            </section>

            <!-- Tab: Qu·∫£n L√Ω Users -->
            <div id="manage" class="tab-content active">
                <!-- Firebase Status -->
                <section class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i data-lucide="database"></i>
                            <h2>K·∫øt N·ªëi Firebase</h2>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="firebaseStatus" class="output">
                            ƒêang k·∫øt n·ªëi Firebase...
                        </div>
                    </div>
                </section>

                <!-- User List Section -->
                <section class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i data-lucide="users"></i>
                            <h2>Danh S√°ch T√†i Kho·∫£n</h2>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-primary" onclick="loadUsers()">
                                <i data-lucide="refresh-cw"></i>
                                T·∫£i Danh S√°ch
                            </button>
                            <button class="btn btn-secondary" onclick="exportUsers()">
                                <i data-lucide="download"></i>
                                Xu·∫•t Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="userList" class="user-list-modern">
                            <div class="empty-state show">
                                <i data-lucide="users"></i>
                                <h3>Ch∆∞a c√≥ d·ªØ li·ªáu</h3>
                                <p>Nh·∫•n "T·∫£i Danh S√°ch" ƒë·ªÉ xem users</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Edit User Section -->
                <section class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i data-lucide="edit"></i>
                            <h2>Ch·ªânh S·ª≠a T√†i Kho·∫£n</h2>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    <i data-lucide="user"></i>
                                    Username
                                </label>
                                <input type="text" id="editUsername" placeholder="Ch·ªçn user t·ª´ danh s√°ch" readonly
                                    style="background: var(--gray-100)" />
                            </div>
                            <div class="form-group">
                                <label>
                                    <i data-lucide="tag"></i>
                                    T√™n hi·ªÉn th·ªã
                                </label>
                                <input type="text" id="editDisplayName" placeholder="T√™n hi·ªÉn th·ªã" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    <i data-lucide="fingerprint"></i>
                                    T√™n ƒë·ªãnh danh
                                </label>
                                <input type="text" id="editIdentifier" placeholder="T√™n ƒë·ªãnh danh (d√πng cho c√°c ch·ª©c nƒÉng c·∫ßn ƒë·ªãnh danh)" />
                            </div>
                            <div class="form-group">
                                <label>
                                    <i data-lucide="key"></i>
                                    Password m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)
                                </label>
                                <input type="password" id="editNewPassword" placeholder="Password m·ªõi" />
                            </div>
                        </div>

                        <!-- Permissions Section (Simplified - only detailed permissions) -->
                        <!-- Page access is now derived from detailed permissions -->
                        <div id="editDetailedPermissions" class="detailed-permissions-container"></div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="clearEditForm()">
                                <i data-lucide="x"></i>
                                X√≥a Form
                            </button>
                            <button type="button" class="btn btn-primary" onclick="updateUser()">
                                <i data-lucide="check"></i>
                                C·∫≠p Nh·∫≠t
                            </button>
                        </div>

                        <div id="editOutput" class="output" style="
                                    display: none;
                                    margin-top: var(--spacing-lg);
                                "></div>
                    </div>
                </section>
            </div>

            <!-- Tab: T·∫°o User M·ªõi -->
            <div id="create" class="tab-content">
                <section class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i data-lucide="user-plus"></i>
                            <h2>T·∫°o T√†i Kho·∫£n M·ªõi</h2>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    <i data-lucide="user"></i>
                                    Username
                                </label>
                                <input type="text" id="newUsername"
                                    placeholder="Username (kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng)" />
                            </div>
                            <div class="form-group">
                                <label>
                                    <i data-lucide="key"></i>
                                    Password
                                </label>
                                <input type="password" id="newPassword" placeholder="Password m·∫°nh" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    <i data-lucide="tag"></i>
                                    T√™n hi·ªÉn th·ªã
                                </label>
                                <input type="text" id="newDisplayName" placeholder="T√™n hi·ªÉn th·ªã (t·ª± ƒë·ªông ƒëi·ªÅn)" />
                            </div>
                            <div class="form-group">
                                <label>
                                    <i data-lucide="fingerprint"></i>
                                    T√™n ƒë·ªãnh danh
                                </label>
                                <input type="text" id="newIdentifier" placeholder="T√™n ƒë·ªãnh danh (d√πng cho c√°c ch·ª©c nƒÉng c·∫ßn ƒë·ªãnh danh)" />
                            </div>
                        </div>

                        <!-- Permissions Section (Simplified - only detailed permissions) -->
                        <!-- Page access is now derived from detailed permissions -->
                        <div id="newDetailedPermissions" class="detailed-permissions-container"></div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="clearCreateForm()">
                                <i data-lucide="refresh-cw"></i>
                                L√†m M·ªõi
                            </button>
                            <button type="button" class="btn btn-primary" onclick="createUser()">
                                <i data-lucide="check"></i>
                                T·∫°o T√†i Kho·∫£n
                            </button>
                        </div>

                        <div id="createOutput" class="output" style="
                                    display: none;
                                    margin-top: var(--spacing-lg);
                                "></div>
                    </div>
                </section>
            </div>

            <!-- Tab: Permissions Overview -->
            <div id="permissions" class="tab-content">
                <section class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i data-lucide="shield-check"></i>
                            <h2>Qu·∫£n L√Ω Quy·ªÅn Truy C·∫≠p</h2>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-primary" onclick="loadPermissionsOverview()">
                                <i data-lucide="refresh-cw"></i>
                                T·∫£i Th·ªëng K√™
                            </button>
                            <button class="btn btn-secondary" onclick="exportPermissions()">
                                <i data-lucide="download"></i>
                                Xu·∫•t B√°o C√°o
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="permissionsOverview">
                            <div class="empty-state show">
                                <i data-lucide="shield-check"></i>
                                <h3>Ch∆∞a c√≥ d·ªØ li·ªáu</h3>
                                <p>Nh·∫•n "T·∫£i Th·ªëng K√™" ƒë·ªÉ xem b√°o c√°o</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Tab: Decode Tool -->
            <div id="decode-tool" class="tab-content">
                <section class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i data-lucide="lock-keyhole"></i>
                            <h2>C√¥ng C·ª• Gi·∫£i M√£ Note</h2>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-secondary" onclick="clearDecodeForm()">
                                <i data-lucide="refresh-cw"></i>
                                L√†m M·ªõi
                            </button>
                            <button class="btn btn-primary" onclick="decodeNote()">
                                <i data-lucide="unlock"></i>
                                Gi·∫£i M√£
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>
                                <i data-lucide="file-text"></i>
                                Nh·∫≠p note ƒë√£ m√£ h√≥a (m·ªói d√≤ng m·ªôt chu·ªói encode)
                            </label>
                            <textarea id="encodeInput" placeholder="Nh·∫≠p note ƒë√£ encode... (h·ªó tr·ª£ nhi·ªÅu d√≤ng)" rows="8"
                                style="font-family: monospace; font-size: 13px;"></textarea>
                        </div>

                        <div class="form-group">
                            <label>
                                <i data-lucide="check-circle"></i>
                                K·∫øt qu·∫£ gi·∫£i m√£
                            </label>
                            <div id="decodeOutput" style="
                                        min-height: 200px;
                                        padding: var(--spacing-lg);
                                        background: var(--gray-50);
                                        border: 1px solid var(--gray-200);
                                        border-radius: var(--radius-md);
                                        font-size: 14px;
                                        line-height: 1.8;
                                    ">
                                <div class="empty-state show">
                                    <i data-lucide="lock-keyhole"></i>
                                    <h3>Ch∆∞a c√≥ k·∫øt qu·∫£</h3>
                                    <p>Nh·∫≠p note v√† nh·∫•n "Gi·∫£i M√£" ƒë·ªÉ xem k·∫øt qu·∫£</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Usage Guide -->
                <section class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i data-lucide="info"></i>
                            <h2>H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng</h2>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="
                                padding: var(--spacing-lg);
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                border-radius: var(--radius-lg);
                                color: white;
                            ">
                            <h3 style="margin-bottom: var(--spacing-md); font-size: 18px;">
                                <i data-lucide="lightbulb"></i>
                                C√°ch s·ª≠ d·ª•ng c√¥ng c·ª• gi·∫£i m√£
                            </h3>
                            <ul style="margin: 0; padding-left: var(--spacing-xl); line-height: 2;">
                                <li>Copy chu·ªói note ƒë√£ encode t·ª´ ƒë∆°n h√†ng TPOS</li>
                                <li>Paste v√†o √¥ "Nh·∫≠p note ƒë√£ m√£ h√≥a"</li>
                                <li>H·ªó tr·ª£ nhi·ªÅu d√≤ng - m·ªói d√≤ng m·ªôt chu·ªói encode</li>
                                <li>Nh·∫•n n√∫t "Gi·∫£i M√£" ƒë·ªÉ xem k·∫øt qu·∫£</li>
                            </ul>
                            <div
                                style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: rgba(255,255,255,0.2); border-radius: var(--radius-md);">
                                <strong>H·ªó tr·ª£ 2 lo·∫°i m√£ h√≥a:</strong>
                                <ul style="margin: 8px 0 0 var(--spacing-xl); line-height: 1.8;">
                                    <li>üü° <strong>Full Note</strong>: To√†n b·ªô note (text + s·∫£n ph·∫©m)</li>
                                    <li>üü¢ <strong>Product Line</strong>: T·ª´ng s·∫£n ph·∫©m ri√™ng l·∫ª (M√£ SP, SL, Gi√°, Th·ªùi
                                        gian)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Tab: Menu Rename -->
            <div id="menu-rename" class="tab-content">
                <div id="menuRenameContainer">
                    <div class="empty-state show">
                        <i data-lucide="edit-3"></i>
                        <h3>ƒêang t·∫£i...</h3>
                    </div>
                </div>
            </div>

            <!-- Tab: Template Management -->
            <div id="templates" class="tab-content">
                <section class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i data-lucide="layout-template"></i>
                            <h2>Qu·∫£n L√Ω M·∫´u Ph√¢n Quy·ªÅn (Templates)</h2>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-primary" onclick="templateManager.showCreateModal()">
                                <i data-lucide="plus"></i>
                                T·∫°o Template M·ªõi
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-tertiary); margin-bottom: 20px;">
                            T·∫°o v√† qu·∫£n l√Ω c√°c m·∫´u ph√¢n quy·ªÅn ƒë·ªÉ √°p d·ª•ng nhanh cho users.
                            Templates t√πy ch·ªânh s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o Firebase v√† c√≥ th·ªÉ s·ª≠ d·ª•ng khi t·∫°o/s·ª≠a user.
                        </p>
                        <div id="templatesList">
                            <div class="empty-state show">
                                <i data-lucide="layout-template"></i>
                                <h3>ƒêang t·∫£i templates...</h3>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Template Editor Modal will be injected here -->
                <div id="templateEditorModal"></div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../orders-report/decoding-utility.js"></script>
    <script src="js/menu-rename-manager.js"></script>
    <script src="../shared/js/notification-system.js"></script>

    <!-- Permissions Registry - Single Source of Truth (ph·∫£i load tr∆∞·ªõc c√°c UI) -->
    <script src="js/permissions-registry.js"></script>
    <!-- page-permissions-ui.js REMOVED - replaced by simplified system using only detailedPermissions -->

    <script>
        // Create compatibility elements before loading other scripts
        (function () {
            const currentUser = document.createElement("div");
            currentUser.id = "currentUser";
            currentUser.style.display = "none";
            document.body.insertBefore(
                currentUser,
                document.body.firstChild,
            );

            window.addEventListener("load", () => {
                const userNameEl = document.getElementById("userName");
                const currentUserEl =
                    document.getElementById("currentUser");

                if (userNameEl && currentUserEl) {
                    const syncNames = () => {
                        if (
                            currentUserEl.textContent &&
                            userNameEl.textContent !==
                            currentUserEl.textContent
                        ) {
                            userNameEl.textContent =
                                currentUserEl.textContent;
                        }
                    };

                    syncNames();
                    const observer = new MutationObserver(syncNames);
                    observer.observe(currentUserEl, {
                        childList: true,
                        characterData: true,
                        subtree: true,
                    });
                }
            });
        })();
    </script>

    <script src="js/image-system.js"></script>
    <script src="../shared/js/shared-auth-manager.js"></script>
    <!-- detailed-permissions-config.js REMOVED - replaced by permissions-registry.js -->
    <script src="js/detailed-permissions-ui.js"></script>
    <script src="js/user-management-enhanced.js"></script>
    <script src="js/permissions-overview.js"></script>
    <script src="js/template-manager.js"></script>

    <!-- Migration Script - C√≥ th·ªÉ x√≥a sau khi migration xong -->
    <script src="js/permissions-migration.js"></script>

    <script>
        // Initialize
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();

            // Initialize notification manager
            window.notify = new NotificationManager();

            // Tab switching
            document.querySelectorAll(".tab-btn").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const tabName = btn.dataset.tab;

                    document
                        .querySelectorAll(".tab-btn")
                        .forEach((b) => b.classList.remove("active"));
                    btn.classList.add("active");

                    document
                        .querySelectorAll(".tab-content")
                        .forEach((content) => {
                            content.classList.remove("active");
                            content.style.display = "none";
                        });

                    const tabContent = document.getElementById(tabName);
                    if (tabContent) {
                        tabContent.classList.add("active");
                        tabContent.style.display = "block";
                    }

                    // Initialize menu rename UI when tab is clicked
                    if (tabName === 'menu-rename' && window.menuRenameManager) {
                        window.menuRenameManager.renderUI('menuRenameContainer');
                    }

                    // Initialize templates UI when tab is clicked
                    if (tabName === 'templates' && window.templateManager) {
                        window.templateManager.loadTemplates();
                    }

                    lucide.createIcons();
                });
            });

            // Button handlers
            document
                .getElementById("btnShowCreate")
                ?.addEventListener("click", () => {
                    document.querySelector('[data-tab="create"]')?.click();
                });

            document
                .getElementById("btnRefresh")
                ?.addEventListener("click", () => {
                    if (typeof loadUsers === "function") loadUsers();
                });

            // Sidebar toggle
            document
                .getElementById("sidebarToggle")
                ?.addEventListener("click", () => {
                    document
                        .getElementById("sidebar")
                        ?.classList.toggle("collapsed");
                });

            document
                .getElementById("menuToggle")
                ?.addEventListener("click", () => {
                    document
                        .getElementById("sidebar")
                        ?.classList.toggle("active");
                });

            // Decode Tool Functions
            window.decodeNote = function () {
                const input = document.getElementById('encodeInput').value.trim();
                const output = document.getElementById('decodeOutput');

                if (!input) {
                    output.innerHTML = `
                            <div class="empty-state show">
                                <i data-lucide="alert-circle"></i>
                                <h3>Ch∆∞a c√≥ d·ªØ li·ªáu</h3>
                                <p style="color: #ef4444;">Vui l√≤ng nh·∫≠p note c·∫ßn gi·∫£i m√£</p>
                            </div>
                        `;
                    lucide.createIcons();
                    return;
                }

                if (!window.DecodingUtility) {
                    output.innerHTML = `
                            <div style="padding: var(--spacing-lg); background: #fef2f2; border: 1px solid #fecaca; border-radius: var(--radius-md); color: #b91c1c;">
                                <strong>‚ùå L·ªói:</strong> Kh√¥ng th·ªÉ load DecodingUtility. Vui l√≤ng refresh trang.
                            </div>
                        `;
                    return;
                }

                const lines = input.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                let resultHtml = '';
                let successCount = 0;
                let failCount = 0;

                lines.forEach((line, index) => {
                    // Try to decode - attempt Full Note first, then Product Line
                    let decodedText = null;
                    let decodedProduct = null;
                    let decodeType = null;

                    // Method 1: Try Full Note decode (NEW format)
                    decodedText = window.DecodingUtility.decodeFullNote(line);
                    if (decodedText) {
                        decodeType = 'FULL_NOTE';
                    } else {
                        // Method 2: Try Product Line decode (OLD format)
                        decodedProduct = window.DecodingUtility.decodeProductLine(line);
                        if (decodedProduct) {
                            decodeType = 'PRODUCT_LINE';
                        }
                    }

                    if (decodeType === 'FULL_NOTE') {
                        // Display full note text
                        successCount++;
                        const escapeHtml = (text) => {
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        };

                        resultHtml += `
                                <div style="
                                    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                                    border: 2px solid #f59e0b;
                                    border-radius: var(--radius-lg);
                                    padding: var(--spacing-lg);
                                    margin-bottom: var(--spacing-md);
                                    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.1);
                                ">
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm); color: #92400e; font-weight: 700; font-size: 16px;">
                                        <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
                                        <span>D√≤ng ${index + 1} - Full Note Decoded</span>
                                    </div>
                                    <div style="background: white; border-radius: var(--radius-md); padding: var(--spacing-md); margin-top: var(--spacing-sm);">
                                        <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">N·ªôi dung note</div>
                                        <div style="white-space: pre-wrap; font-size: 14px; line-height: 1.6; color: #1f2937; background: #f9fafb; padding: 10px; border-radius: 4px;">${escapeHtml(decodedText)}</div>
                                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px dashed #e5e7eb;">
                                            <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">Chu·ªói m√£ h√≥a</div>
                                            <div style="font-family: monospace; font-size: 11px; color: #9ca3af; word-break: break-all; background: #f9fafb; padding: 6px 10px; border-radius: 4px;">${line}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                    } else if (decodeType === 'PRODUCT_LINE') {
                        // Display product line info
                        successCount++;
                        const timeStr = decodedProduct.timestamp ? new Date(decodedProduct.timestamp).toLocaleString('vi-VN') : 'N/A';
                        const priceStr = (decodedProduct.price || 0).toLocaleString('vi-VN') + 'ƒë';

                        resultHtml += `
                                <div style="
                                    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
                                    border: 2px solid #10b981;
                                    border-radius: var(--radius-lg);
                                    padding: var(--spacing-lg);
                                    margin-bottom: var(--spacing-md);
                                    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
                                ">
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm); color: #047857; font-weight: 700; font-size: 16px;">
                                        <i data-lucide="check-circle" style="width: 20px; height: 20px;"></i>
                                        <span>D√≤ng ${index + 1} - Product Line Decoded</span>
                                    </div>
                                    <div style="background: white; border-radius: var(--radius-md); padding: var(--spacing-md); margin-top: var(--spacing-sm);">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                                            <div>
                                                <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">M√£ s·∫£n ph·∫©m</div>
                                                <div style="font-weight: 600; font-size: 16px; color: #1f2937;">${decodedProduct.productCode}</div>
                                            </div>
                                            <div>
                                                <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">S·ªë l∆∞·ª£ng</div>
                                                <div style="font-weight: 600; font-size: 16px; color: #0ea5e9;">x${decodedProduct.quantity}</div>
                                            </div>
                                            <div>
                                                <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">Gi√°</div>
                                                <div style="font-weight: 600; font-size: 16px; color: #10b981;">${priceStr}</div>
                                            </div>
                                            <div>
                                                <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">Th·ªùi gian</div>
                                                <div style="font-weight: 600; font-size: 14px; color: #6b7280;">${timeStr}</div>
                                            </div>
                                        </div>
                                        ${decodedProduct.orderId ? `
                                            <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px dashed #e5e7eb;">
                                                <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">Order ID</div>
                                                <div style="font-family: monospace; font-size: 13px; color: #4b5563; background: #f3f4f6; padding: 6px 10px; border-radius: 4px;">${decodedProduct.orderId}</div>
                                            </div>
                                        ` : ''}
                                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px dashed #e5e7eb;">
                                            <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">Chu·ªói m√£ h√≥a</div>
                                            <div style="font-family: monospace; font-size: 11px; color: #9ca3af; word-break: break-all; background: #f9fafb; padding: 6px 10px; border-radius: 4px;">${line}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                    } else {
                        failCount++;
                        resultHtml += `
                                <div style="
                                    background: #fef2f2;
                                    border: 1px solid #fecaca;
                                    border-radius: var(--radius-md);
                                    padding: var(--spacing-md);
                                    margin-bottom: var(--spacing-md);
                                ">
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); color: #dc2626; font-weight: 600;">
                                        <i data-lucide="x-circle" style="width: 18px; height: 18px;"></i>
                                        <span>D√≤ng ${index + 1} - Kh√¥ng gi·∫£i m√£ ƒë∆∞·ª£c</span>
                                    </div>
                                    <div style="margin-top: var(--spacing-sm); font-family: monospace; font-size: 11px; color: #7f1d1d; word-break: break-all; background: white; padding: 6px 10px; border-radius: 4px;">${line}</div>
                                </div>
                            `;
                    }
                });

                // Summary
                const summaryHtml = `
                        <div style="
                            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
                            border: 2px solid #6366f1;
                            border-radius: var(--radius-lg);
                            padding: var(--spacing-lg);
                            margin-bottom: var(--spacing-lg);
                        ">
                            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); color: #4338ca; font-weight: 700; font-size: 18px;">
                                <i data-lucide="bar-chart-3" style="width: 24px; height: 24px;"></i>
                                <span>T·ªïng K·∫øt</span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md);">
                                <div style="background: white; padding: var(--spacing-md); border-radius: var(--radius-md); text-align: center;">
                                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">T·ªïng d√≤ng</div>
                                    <div style="font-weight: 700; font-size: 24px; color: #4338ca;">${lines.length}</div>
                                </div>
                                <div style="background: white; padding: var(--spacing-md); border-radius: var(--radius-md); text-align: center;">
                                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">Th√†nh c√¥ng</div>
                                    <div style="font-weight: 700; font-size: 24px; color: #10b981;">${successCount}</div>
                                </div>
                                <div style="background: white; padding: var(--spacing-md); border-radius: var(--radius-md); text-align: center;">
                                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">Th·∫•t b·∫°i</div>
                                    <div style="font-weight: 700; font-size: 24px; color: #ef4444;">${failCount}</div>
                                </div>
                            </div>
                        </div>
                    `;

                output.innerHTML = summaryHtml + resultHtml;
                lucide.createIcons();

                // Show notification
                if (window.notify) {
                    window.notify.success(`Gi·∫£i m√£ th√†nh c√¥ng ${successCount}/${lines.length} d√≤ng`);
                }
            };

            window.clearDecodeForm = function () {
                document.getElementById('encodeInput').value = '';
                document.getElementById('decodeOutput').innerHTML = `
                        <div class="empty-state show">
                            <i data-lucide="lock-keyhole"></i>
                            <h3>Ch∆∞a c√≥ k·∫øt qu·∫£</h3>
                            <p>Nh·∫≠p note v√† nh·∫•n "Gi·∫£i M√£" ƒë·ªÉ xem k·∫øt qu·∫£</p>
                        </div>
                    `;
                lucide.createIcons();
            };
        });
    </script>
</body>

</html>