<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Quản Lý Tài Khoản - N2 Shop</title>
        <meta http-equiv="Cache-Control" content="public, max-age=31536000" />

        <!-- External CSS -->
        <link rel="stylesheet" href="modern.css" />
        <link rel="stylesheet" href="detailed-permissions.css" />

        <!-- Lucide Icons -->
        <!-- N2Store Optimization: Core Utilities Loader -->
        <script src="../js/core-loader.js"></script>

        <script src="https://unpkg.com/lucide@latest"></script>

        <!-- Firebase Scripts -->
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

        <!-- Crypto Libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/3.0.1/bcrypt.min.js"></script>

        <!-- Navigation & Utils -->
        <script src="../js/navigation-modern.js"></script>
        <script src="../js/common-utils.js"></script>
    </head>

    <body>
        <!-- Access Denied (Hidden by default) -->
        <div id="accessDenied" class="access-denied" style="display: none">
            <h1>
                <i data-lucide="shield-x"></i>
                Truy cập bị từ chối
            </h1>
            <p>
                Bạn không có quyền truy cập vào trang này.<br />
                Chỉ có Admin mới có thể quản lý tài khoản.
            </p>
            <a href="../live/index.html" class="btn btn-primary">
                <i data-lucide="arrow-left"></i>
                Quay về trang chính
            </a>
        </div>

        <!-- Main Container (Hidden until auth check) -->
        <div id="mainContainer" style="display: none">
            <!-- Sidebar Navigation -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="logo">
                        <i data-lucide="zap"></i>
                        <span>N2Shop</span>
                    </div>
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i data-lucide="panel-left-close"></i>
                    </button>
                </div>

                <nav class="sidebar-nav" id="sidebarNav">
                    <!-- Menu items will be auto-generated by navigation-modern.js -->
                </nav>

                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar">
                            <i data-lucide="user-circle"></i>
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Admin</div>
                            <div class="user-role">Quản trị viên</div>
                        </div>
                    </div>
                    <button class="btn-permissions" id="btnPermissions">
                        <i data-lucide="shield-check"></i>
                        <span>Xem Quyền Của Tôi</span>
                    </button>
                    <button class="btn-logout" id="btnLogout">
                        <i data-lucide="log-out"></i>
                        <span>Đăng xuất</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Top Bar -->
                <header class="top-bar">
                    <div class="top-bar-left">
                        <button class="btn-icon" id="menuToggle">
                            <i data-lucide="menu"></i>
                        </button>
                        <div class="breadcrumb">
                            <i data-lucide="home"></i>
                            <span>Quản Lý Tài Khoản</span>
                        </div>
                    </div>
                    <div class="top-bar-right">
                        <button class="btn btn-primary" id="btnShowCreate">
                            <i data-lucide="user-plus"></i>
                            <span>Tạo User</span>
                        </button>
                        <button
                            class="btn-icon"
                            id="btnRefresh"
                            title="Làm mới"
                        >
                            <i data-lucide="refresh-cw"></i>
                        </button>
                        <div class="search-box">
                            <i data-lucide="search"></i>
                            <input
                                type="text"
                                placeholder="Tìm kiếm..."
                                id="searchInput"
                            />
                        </div>
                    </div>
                </header>

                <!-- Tab Navigation -->
                <section
                    class="card"
                    style="margin: 0 var(--spacing-xl) var(--spacing-xl)"
                >
                    <div
                        class="card-header"
                        style="border-bottom: none; padding-bottom: 0"
                    >
                        <div class="category-tabs" style="margin: 0">
                            <button class="tab-btn active" data-tab="manage">
                                <i data-lucide="users"></i>
                                Quản Lý Users
                            </button>
                            <button class="tab-btn" data-tab="create">
                                <i data-lucide="user-plus"></i>
                                Tạo Mới
                            </button>
                            <button class="tab-btn" data-tab="permissions">
                                <i data-lucide="shield-check"></i>
                                Quyền Truy Cập
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Tab: Quản Lý Users -->
                <div id="manage" class="tab-content active">
                    <!-- Firebase Status -->
                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="database"></i>
                                <h2>Kết Nối Firebase</h2>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="firebaseStatus" class="output">
                                Đang kết nối Firebase...
                            </div>
                        </div>
                    </section>

                    <!-- User List Section -->
                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="users"></i>
                                <h2>Danh Sách Tài Khoản</h2>
                            </div>
                            <div class="card-actions">
                                <button
                                    class="btn btn-primary"
                                    onclick="loadUsers()"
                                >
                                    <i data-lucide="refresh-cw"></i>
                                    Tải Danh Sách
                                </button>
                                <button
                                    class="btn btn-secondary"
                                    onclick="exportUsers()"
                                >
                                    <i data-lucide="download"></i>
                                    Xuất Excel
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="userList" class="user-list-modern">
                                <div class="empty-state show">
                                    <i data-lucide="users"></i>
                                    <h3>Chưa có dữ liệu</h3>
                                    <p>Nhấn "Tải Danh Sách" để xem users</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Edit User Section -->
                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="edit"></i>
                                <h2>Chỉnh Sửa Tài Khoản</h2>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="user"></i>
                                        Username
                                    </label>
                                    <input
                                        type="text"
                                        id="editUsername"
                                        placeholder="Chọn user từ danh sách"
                                        readonly
                                        style="background: var(--gray-100)"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="tag"></i>
                                        Tên hiển thị
                                    </label>
                                    <input
                                        type="text"
                                        id="editDisplayName"
                                        placeholder="Tên hiển thị"
                                    />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="shield"></i>
                                        Quyền hạn
                                    </label>
                                    <select id="editCheckLogin">
                                        <option value="0">Admin (0)</option>
                                        <option value="1">User (1)</option>
                                        <option value="2">Limited (2)</option>
                                        <option value="3">Basic (3)</option>
                                        <option value="777">Guest (777)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="key"></i>
                                        Password mới (để trống nếu không đổi)
                                    </label>
                                    <input
                                        type="password"
                                        id="editNewPassword"
                                        placeholder="Password mới"
                                    />
                                </div>
                            </div>

                            <!-- Page Access Permissions Section -->
                            <div id="editPagePermissions" class="page-permissions-container"></div>

                            <!-- Detailed Permissions Section -->
                            <div
                                id="editDetailedPermissions"
                                class="detailed-permissions-container"
                            ></div>

                            <div class="form-actions">
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    onclick="clearEditForm()"
                                >
                                    <i data-lucide="x"></i>
                                    Xóa Form
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-primary"
                                    onclick="updateUser()"
                                >
                                    <i data-lucide="check"></i>
                                    Cập Nhật
                                </button>
                            </div>

                            <div
                                id="editOutput"
                                class="output"
                                style="
                                    display: none;
                                    margin-top: var(--spacing-lg);
                                "
                            ></div>
                        </div>
                    </section>
                </div>

                <!-- Tab: Tạo User Mới -->
                <div id="create" class="tab-content">
                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="user-plus"></i>
                                <h2>Tạo Tài Khoản Mới</h2>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="user"></i>
                                        Username
                                    </label>
                                    <input
                                        type="text"
                                        id="newUsername"
                                        placeholder="Username (không dấu, không khoảng trắng)"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="key"></i>
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        id="newPassword"
                                        placeholder="Password mạnh"
                                    />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="tag"></i>
                                        Tên hiển thị
                                    </label>
                                    <input
                                        type="text"
                                        id="newDisplayName"
                                        placeholder="Tên hiển thị (tự động điền)"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i data-lucide="shield"></i>
                                        Quyền hạn
                                    </label>
                                    <select id="newCheckLogin">
                                        <option value="0">Admin (0)</option>
                                        <option value="1" selected>
                                            User (1)
                                        </option>
                                        <option value="2">Limited (2)</option>
                                        <option value="3">Basic (3)</option>
                                        <option value="777">Guest (777)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Page Access Permissions Section -->
                            <div id="newPagePermissions" class="page-permissions-container"></div>

                            <!-- Detailed Permissions Section -->
                            <div
                                id="newDetailedPermissions"
                                class="detailed-permissions-container"
                            ></div>

                            <div class="form-actions">
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    onclick="clearCreateForm()"
                                >
                                    <i data-lucide="refresh-cw"></i>
                                    Làm Mới
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-primary"
                                    onclick="createUser()"
                                >
                                    <i data-lucide="check"></i>
                                    Tạo Tài Khoản
                                </button>
                            </div>

                            <div
                                id="createOutput"
                                class="output"
                                style="
                                    display: none;
                                    margin-top: var(--spacing-lg);
                                "
                            ></div>
                        </div>
                    </section>
                </div>

                <!-- Tab: Permissions Overview -->
                <div id="permissions" class="tab-content">
                    <section class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i data-lucide="shield-check"></i>
                                <h2>Quản Lý Quyền Truy Cập</h2>
                            </div>
                            <div class="card-actions">
                                <button
                                    class="btn btn-primary"
                                    onclick="loadPermissionsOverview()"
                                >
                                    <i data-lucide="refresh-cw"></i>
                                    Tải Thống Kê
                                </button>
                                <button
                                    class="btn btn-secondary"
                                    onclick="exportPermissions()"
                                >
                                    <i data-lucide="download"></i>
                                    Xuất Báo Cáo
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="permissionsOverview">
                                <div class="empty-state show">
                                    <i data-lucide="shield-check"></i>
                                    <h3>Chưa có dữ liệu</h3>
                                    <p>Nhấn "Tải Thống Kê" để xem báo cáo</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>

        <!-- Scripts -->
        <script src="notification-system.js"></script>
        <script src="page-permissions-ui.js"></script>

        <script>
            // Create compatibility elements before loading other scripts
            (function () {
                const currentUser = document.createElement("div");
                currentUser.id = "currentUser";
                currentUser.style.display = "none";
                document.body.insertBefore(
                    currentUser,
                    document.body.firstChild,
                );

                window.addEventListener("load", () => {
                    const userNameEl = document.getElementById("userName");
                    const currentUserEl =
                        document.getElementById("currentUser");

                    if (userNameEl && currentUserEl) {
                        const syncNames = () => {
                            if (
                                currentUserEl.textContent &&
                                userNameEl.textContent !==
                                    currentUserEl.textContent
                            ) {
                                userNameEl.textContent =
                                    currentUserEl.textContent;
                            }
                        };

                        syncNames();
                        const observer = new MutationObserver(syncNames);
                        observer.observe(currentUserEl, {
                            childList: true,
                            characterData: true,
                            subtree: true,
                        });
                    }
                });
            })();
        </script>

        <script src="image-system.js"></script>
        <script src="auth.js"></script>
        <script src="detailed-permissions-config.js"></script>
        <script src="detailed-permissions-ui.js"></script>
        <script src="user-management-enhanced.js"></script>

        <script>
            // Initialize
            document.addEventListener("DOMContentLoaded", () => {
                lucide.createIcons();

                // Initialize notification manager
                window.notify = new NotificationManager();

                // Tab switching
                document.querySelectorAll(".tab-btn").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const tabName = btn.dataset.tab;

                        document
                            .querySelectorAll(".tab-btn")
                            .forEach((b) => b.classList.remove("active"));
                        btn.classList.add("active");

                        document
                            .querySelectorAll(".tab-content")
                            .forEach((content) => {
                                content.classList.remove("active");
                                content.style.display = "none";
                            });

                        const tabContent = document.getElementById(tabName);
                        if (tabContent) {
                            tabContent.classList.add("active");
                            tabContent.style.display = "block";
                        }

                        lucide.createIcons();
                    });
                });

                // Button handlers
                document
                    .getElementById("btnShowCreate")
                    ?.addEventListener("click", () => {
                        document.querySelector('[data-tab="create"]')?.click();
                    });

                document
                    .getElementById("btnRefresh")
                    ?.addEventListener("click", () => {
                        if (typeof loadUsers === "function") loadUsers();
                    });

                // Sidebar toggle
                document
                    .getElementById("sidebarToggle")
                    ?.addEventListener("click", () => {
                        document
                            .getElementById("sidebar")
                            ?.classList.toggle("collapsed");
                    });

                document
                    .getElementById("menuToggle")
                    ?.addEventListener("click", () => {
                        document
                            .getElementById("sidebar")
                            ?.classList.toggle("active");
                    });
            });
        </script>
    </body>
</html>
