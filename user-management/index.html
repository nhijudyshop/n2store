<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Quản Lý Tài Khoản - N2 Shop</title>
        <!-- Firebase Scripts -->
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
        <!-- Crypto Libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/3.0.1/bcrypt.min.js"></script>

        <!-- User-Management CSS -->
        <link rel="stylesheet" href="user-management.css" />
        <!-- CSS script -->
        <script src="../js/device-detector.js"></script>

        <!-- Navigation -->
        <script src="../js/navigation.js"></script>
        <script src="../js/common-utils.js"></script>
    </head>

    <body>
        <!-- Thông báo truy cập bị từ chối -->
        <div id="accessDenied" class="access-denied" style="display: none">
            <h1>🚫 Truy cập bị từ chối</h1>
            <p>
                Bạn không có quyền truy cập vào trang này.<br />Chỉ có Admin mới
                có thể quản lý tài khoản.
            </p>
            <a href="../live/index.html" class="back-btn"
                >← Quay về trang chính</a
            >
        </div>

        <!-- Nội dung chính - Chỉ hiện với Admin -->
        <div id="mainContainer" class="container">
            <div class="header">
                <h1>🔐 Quản Lý Tài Khoản N2 Shop</h1>
                <div class="admin-badge">👑 ADMIN PANEL</div>
                <div style="margin-top: 10px; color: #666; font-size: 14px">
                    Đăng nhập: <span id="currentUser">Loading...</span>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('manage')">
                    👥 Quản Lý Users
                </button>
                <button class="tab" onclick="showTab('create')">
                    ➕ Tạo Mới
                </button>
                <button class="tab" onclick="showTab('permissions')">
                    🔑 Quyền Truy Cập
                </button>
                <button class="tab" onclick="showTab('tools')">🔧 Tools</button>
            </div>

            <!-- Tab 1: Quản Lý Users -->
            <div id="manage" class="tab-content active">
                <div class="section">
                    <h2>Kết Nối Firebase</h2>
                    <div id="firebaseStatus" class="output">
                        Đang kết nối Firebase...
                    </div>
                    <button onclick="connectFirebase()" style="display: none">
                        Kết Nối Lại
                    </button>
                </div>

                <div class="section">
                    <h2>📋 Danh Sách Tài Khoản</h2>
                    <button onclick="loadUsers()">🔄 Tải Danh Sách</button>
                    <button onclick="exportUsers()" class="success">
                        📤 Xuất Excel
                    </button>
                    <div id="userList" class="user-list">
                        <div style="padding: 20px; text-align: center">
                            Nhấn "Tải Danh Sách" để xem users
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>✏️ Chỉnh Sửa Tài Khoản</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUsername">Username:</label>
                            <input
                                type="text"
                                id="editUsername"
                                placeholder="Chọn user từ danh sách"
                                readonly
                            />
                        </div>
                        <div class="form-group">
                            <label for="editDisplayName">Tên hiển thị:</label>
                            <input
                                type="text"
                                id="editDisplayName"
                                placeholder="Tên hiển thị mới"
                            />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editCheckLogin">Quyền hạn:</label>
                            <select id="editCheckLogin">
                                <option value="0">👑 Admin (0)</option>
                                <option value="1">👤 User (1)</option>
                                <option value="2">🔒 Limited (2)</option>
                                <option value="3">💡 Basic (3)</option>
                                <option value="777">👥 Guest (777)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editNewPassword"
                                >Password mới (để trống nếu không đổi):</label
                            >
                            <input
                                type="password"
                                id="editNewPassword"
                                placeholder="Password mới"
                            />
                        </div>
                    </div>

                    <!-- Phần quyền truy cập trang -->
                    <div class="permissions-section">
                        <h3>🔑 Quyền Truy Cập Các Trang</h3>
                        <p
                            style="
                                color: #6c757d;
                                font-size: 13px;
                                margin-bottom: 15px;
                            "
                        >
                            Chọn các trang mà user này có thể truy cập. Admin
                            luôn có toàn quyền.
                        </p>

                        <div class="role-template">
                            <h4>📋 Template theo vai trò:</h4>
                            <div class="template-buttons">
                                <button
                                    class="template-btn"
                                    onclick="applyPermissionTemplate('admin')"
                                >
                                    👑 Admin - Toàn quyền
                                </button>
                                <button
                                    class="template-btn"
                                    onclick="applyPermissionTemplate('manager')"
                                >
                                    👨‍💼 Manager - Quản lý cơ bản
                                </button>
                                <button
                                    class="template-btn"
                                    onclick="applyPermissionTemplate('staff')"
                                >
                                    👤 Staff - Nhân viên
                                </button>
                                <button
                                    class="template-btn"
                                    onclick="applyPermissionTemplate('viewer')"
                                >
                                    👁️ Viewer - Chỉ xem
                                </button>
                                <button
                                    class="template-btn"
                                    onclick="applyPermissionTemplate('clear')"
                                >
                                    🚫 Xóa tất cả
                                </button>
                            </div>
                        </div>

                        <div
                            class="permissions-summary"
                            id="permissionsSummary"
                        >
                            <span class="permissions-count"
                                >0/11 trang được chọn</span
                            >
                        </div>

                        <div class="permissions-grid" id="editPermissionsGrid">
                            <!-- Permissions sẽ được tạo bằng JS -->
                        </div>
                    </div>

                    <button class="success" onclick="updateUser()">
                        💾 Cập Nhật
                    </button>
                    <button onclick="clearEditForm()">🗑️ Xóa Form</button>
                    <div
                        id="editOutput"
                        class="output"
                        style="display: none"
                    ></div>
                </div>
            </div>

            <!-- Tab 2: Tạo User Mới -->
            <div id="create" class="tab-content">
                <div class="section">
                    <h2>➕ Tạo Tài Khoản Mới</h2>
                    <div class="info">
                        <strong>ℹ️ Lưu ý:</strong> Password sẽ được hash tự động
                        bằng Crypto-JS để đảm bảo bảo mật.
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newUsername">Username:</label>
                            <input
                                type="text"
                                id="newUsername"
                                placeholder="Username (không dấu, không khoảng trắng)"
                            />
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Password:</label>
                            <input
                                type="password"
                                id="newPassword"
                                placeholder="Password mạnh"
                            />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newDisplayName">Tên hiển thị:</label>
                            <input
                                type="text"
                                id="newDisplayName"
                                placeholder="Tên hiển thị (tự động điền)"
                            />
                        </div>
                        <div class="form-group">
                            <label for="newCheckLogin">Quyền hạn:</label>
                            <select id="newCheckLogin">
                                <option value="0">👑 Admin (0)</option>
                                <option value="1" selected>👤 User (1)</option>
                                <option value="2">🔒 Limited (2)</option>
                                <option value="3">💡 Basic (3)</option>
                                <option value="777">👥 Guest (777)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Phần quyền truy cập trang cho user mới -->
                    <div class="permissions-section">
                        <h3>🔑 Quyền Truy Cập Các Trang</h3>
                        <p
                            style="
                                color: #6c757d;
                                font-size: 13px;
                                margin-bottom: 15px;
                            "
                        >
                            Chọn các trang mà user mới này có thể truy cập.
                        </p>

                        <div class="role-template">
                            <h4>📋 Template theo vai trò:</h4>
                            <div class="template-buttons">
                                <button
                                    class="template-btn"
                                    onclick="applyPermissionTemplate('admin', 'new')"
                                >
                                    👑 Admin - Toàn quyền
                                </button>
                                <button
                                    class="template-btn"
                                    onclick="applyPermissionTemplate('manager', 'new')"
                                >
                                    👨‍💼 Manager - Quản lý cơ bản
                                </button>
                                <button
                                    class="template-btn"
                                    onclick="applyPermissionTemplate('staff', 'new')"
                                >
                                    👤 Staff - Nhân viên
                                </button>
                                <button
                                    class="template-btn"
                                    onclick="applyPermissionTemplate('viewer', 'new')"
                                >
                                    👁️ Viewer - Chỉ xem
                                </button>
                                <button
                                    class="template-btn"
                                    onclick="applyPermissionTemplate('clear', 'new')"
                                >
                                    🚫 Xóa tất cả
                                </button>
                            </div>
                        </div>

                        <div
                            class="permissions-summary"
                            id="newPermissionsSummary"
                        >
                            <span class="permissions-count"
                                >0/11 trang được chọn</span
                            >
                        </div>

                        <div class="permissions-grid" id="newPermissionsGrid">
                            <!-- Permissions sẽ được tạo bằng JS -->
                        </div>
                    </div>

                    <button class="success" onclick="createUser()">
                        ✅ Tạo Tài Khoản
                    </button>
                    <button onclick="clearCreateForm()">🗑️ Xóa Form</button>
                    <div
                        id="createOutput"
                        class="output"
                        style="display: none"
                    ></div>
                </div>
            </div>

            <!-- Tab 3: Permissions Management -->
            <div id="permissions" class="tab-content">
                <div class="section">
                    <h2>🔑 Quản Lý Quyền Truy Cập</h2>
                    <div class="info">
                        <strong>ℹ️ Thông tin:</strong> Trang này cho phép xem và
                        quản lý quyền truy cập của tất cả users.
                    </div>

                    <button onclick="loadPermissionsOverview()">
                        🔄 Tải Thống Kê Quyền
                    </button>
                    <button onclick="exportPermissions()" class="success">
                        📤 Xuất Báo Cáo
                    </button>

                    <div id="permissionsOverview" class="permissions-overview">
                        <div
                            style="
                                padding: 20px;
                                text-align: center;
                                color: #6c757d;
                            "
                        >
                            Nhấn "Tải Thống Kê Quyền" để xem báo cáo
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Tools -->
            <div id="tools" class="tab-content">
                <div class="section">
                    <h2>🔐 Tạo Hash Password</h2>
                    <div class="method-selector">
                        <label
                            ><input
                                type="radio"
                                name="method"
                                value="cryptojs"
                                checked
                            />
                            Crypto-JS (Nhanh)</label
                        >
                        <label
                            ><input type="radio" name="method" value="bcrypt" />
                            bcrypt (An toàn hơn)</label
                        >
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="username">Username:</label>
                            <input
                                type="text"
                                id="username"
                                placeholder="Nhập username"
                            />
                        </div>
                        <div class="form-group">
                            <label for="password">Password:</label>
                            <input
                                type="password"
                                id="password"
                                placeholder="Nhập password"
                            />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="displayName">Tên hiển thị:</label>
                            <input
                                type="text"
                                id="displayName"
                                placeholder="Tên hiển thị"
                            />
                        </div>
                        <div class="form-group">
                            <label for="checkLogin">Quyền hạn:</label>
                            <select id="checkLogin">
                                <option value="0">👑 Admin (0)</option>
                                <option value="1" selected>👤 User (1)</option>
                                <option value="2">🔒 Limited (2)</option>
                                <option value="3">💡 Basic (3)</option>
                                <option value="777">👥 Guest (777)</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="generateHash()">🔐 Tạo Hash</button>
                    <button onclick="clearHashForm()">🗑️ Xóa Form</button>
                    <div
                        id="hashOutput"
                        class="output"
                        style="display: none"
                    ></div>
                </div>

                <div class="section">
                    <h2>🔍 Kiểm Tra Password</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="testPassword">Test Password:</label>
                            <input
                                type="password"
                                id="testPassword"
                                placeholder="Nhập password để test"
                            />
                        </div>
                        <div class="form-group">
                            <label for="testSalt">Salt (Crypto-JS):</label>
                            <input
                                type="text"
                                id="testSalt"
                                placeholder="Salt từ hash output"
                            />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="testHash">Hash để so sánh:</label>
                        <textarea
                            id="testHash"
                            rows="3"
                            placeholder="Paste hash để kiểm tra"
                        ></textarea>
                    </div>
                    <button onclick="verifyPassword()">✅ Kiểm Tra</button>
                    <div
                        id="verifyOutput"
                        class="output"
                        style="display: none"
                    ></div>
                </div>
            </div>
        </div>

        <!-- Enhanced Floating Alert -->
        <div id="floatingAlert">
            <div class="alert-content">
                <div class="loading-spinner" style="display: none">
                    <div class="spinner"></div>
                </div>
                <div class="alert-text">Thông báo hiển thị!</div>
            </div>
        </div>

        <!-- Tooltip -->
        <div id="tooltip" class="tooltip"></div>

        <script src="user-permission-page.js"></script>
    </body>
</html>
