<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPOS Manager - Qu·∫£n L√Ω S·∫£n Ph·∫©m & ƒê∆°n H√†ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tab-button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .size-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }
    .size-chip-remove {
      background: rgba(255, 255, 255, 0.3);
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
  <div class="container mx-auto p-6 max-w-7xl">
    <!-- Main Navigation -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-3xl font-bold text-gray-800">üöÄ TPOS Manager</h1>
        <div class="flex gap-3 flex-wrap">
          <button onclick="switchModule('product')" id="btnProduct" class="tab-button px-6 py-3 rounded-lg font-semibold transition active">
            üõçÔ∏è Qu·∫£n L√Ω S·∫£n Ph·∫©m
          </button>
          <button onclick="switchModule('order')" id="btnOrder" class="tab-button px-6 py-3 rounded-lg font-semibold transition bg-gray-200 text-gray-700">
            üì¶ Qu·∫£n L√Ω ƒê∆°n H√†ng
          </button>
        </div>
      </div>
    </div>

    <!-- Message Alert -->
    <div id="messageAlert" class="hidden mb-6 p-4 rounded-lg flex items-center gap-3 fade-in"></div>

    <!-- Product Module -->
    <div id="productModule">
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Th√™m S·∫£n Ph·∫©m M·ªõi</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">M√£ S·∫£n Ph·∫©m *</label>
            <input type="text" id="defaultCode" placeholder="VD: NTEST" value="NTEST" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">T√™n S·∫£n Ph·∫©m *</label>
            <input type="text" id="productName" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Gi√° B√°n (VNƒê) *</label>
            <input type="number" id="listPrice" value="200000" min="0"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Gi√° Mua (VNƒê) *</label>
            <input type="number" id="purchasePrice" value="100000" min="0"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë L∆∞·ª£ng *</label>
            <input type="number" id="qtyAvailable" value="1" min="0"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">H√¨nh ·∫¢nh</label>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500 transition" id="imageUpload">
              <div id="imageUploadPlaceholder">
                <p class="text-sm text-gray-600">üì∑ Click ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c Paste (Ctrl+V)</p>
              </div>
              <div id="imagePreviewContainer" class="hidden">
                <img id="imagePreview" src="" alt="Preview" class="max-h-40 mx-auto rounded-lg mb-2">
                <button type="button" onclick="ProductModule.removeImage(event)" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">üóëÔ∏è X√≥a ·∫£nh</button>
              </div>
              <input type="file" id="fileInput" accept="image/*" class="hidden">
            </div>
          </div>
        </div>
        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Bi·∫øn Th·ªÉ (AttributeLines)</label>
          <button onclick="ProductModule.openAttributeModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">üìù Ch·ªçn Bi·∫øn Th·ªÉ</button>
          <textarea id="attributeLinesDisplay" readonly class="w-full mt-2 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 font-mono text-xs" rows="3">[]</textarea>
        </div>
        <div class="flex gap-3 mt-6">
          <button onclick="ProductModule.createProductOneClick()" class="flex-1 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-bold py-4 px-6 rounded-lg transition-all transform hover:scale-105 shadow-lg">üöÄ T·∫°o S·∫£n Ph·∫©m (1 Click)</button>
        </div>
      </div>
      <div id="productResult" class="hidden bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">K·∫øt Qu·∫£</h3>
        <pre id="productResultContent" class="bg-gray-50 p-4 rounded-lg overflow-x-auto text-xs"></pre>
      </div>
    </div>

    <!-- Order Module -->
    <div id="orderModule" class="hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center"><div id="step1" class="w-10 h-10 rounded-full flex items-center justify-center font-bold bg-blue-500 text-white">1</div><div id="line1" class="w-20 h-1 bg-gray-200"></div></div>
          <div class="flex items-center"><div id="step2" class="w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">2</div><div id="line2" class="w-20 h-1 bg-gray-200"></div></div>
          <div class="flex items-center"><div id="step3" class="w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">3</div><div id="line3" class="w-20 h-1 bg-gray-200"></div></div>
          <div id="step4" class="w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">4</div>
        </div>
        <div class="flex justify-between mt-2 text-sm text-gray-600">
          <span>T√¨m ƒë∆°n</span><span>Ch·ªçn ƒë∆°n</span><span>Ch·ªçn SP</span><span>C·∫≠p nh·∫≠t</span>
        </div>
      </div>
      <div id="stepContent1" class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">üìÖ B∆∞·ªõc 1: Ch·ªçn kho·∫£ng th·ªùi gian</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Ng√†y b·∫Øt ƒë·∫ßu</label><input type="date" id="startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Ng√†y k·∫øt th√∫c</label><input type="date" id="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Session Index</label><input type="text" id="sessionIndex" value="60" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
        </div>
        <button onclick="fetchOrders()" id="btnFetchOrders" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">T√¨m ƒë∆°n h√†ng</button>
      </div>
      <div id="stepContent2" class="hidden bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">üõçÔ∏è B∆∞·ªõc 2: Ch·ªçn ƒë∆°n h√†ng (<span id="orderCount">0</span>)</h2>
        <div id="ordersList" class="max-h-96 overflow-y-auto space-y-3"></div>
        <div class="flex gap-3 mt-6">
          <button onclick="goToStep(1)" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition">Quay l·∫°i</button>
          <button onclick="fetchOrderDetail()" id="btnContinue" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">Ti·∫øp t·ª•c</button>
        </div>
      </div>
      <div id="stepContent3" class="hidden space-y-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">üîç B∆∞·ªõc 3: T√¨m v√† ch·ªçn s·∫£n ph·∫©m</h2>
          <div class="flex gap-3 mb-4">
            <input type="text" id="productSearch" placeholder="Nh·∫≠p t√™n ho·∫∑c m√£ s·∫£n ph·∫©m..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onkeypress="if(event.key==='Enter') searchProducts()">
            <button onclick="searchProducts()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg transition">T√¨m</button>
          </div>
          <div id="productsList" class="max-h-64 overflow-y-auto space-y-2"></div>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">S·∫£n ph·∫©m ƒë√£ ch·ªçn (<span id="selectedCount">0</span>)</h3>
          <div id="selectedProductsList"></div>
        </div>
        <div id="updateSection" class="hidden bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">üíæ B∆∞·ªõc 4: C·∫≠p nh·∫≠t ƒë∆°n h√†ng</h2>
          <div class="bg-blue-50 p-4 rounded-lg mb-4">
            <p class="text-sm text-gray-700"><strong>ƒê∆°n h√†ng:</strong> #<span id="orderCode"></span></p>
            <p class="text-sm text-gray-700"><strong>Kh√°ch h√†ng:</strong> <span id="customerName"></span></p>
            <p class="text-sm text-gray-700"><strong>S·ªë s·∫£n ph·∫©m m·ªõi:</strong> <span id="newProductCount"></span></p>
          </div>
          <div class="flex gap-3">
            <button onclick="goToStep(2)" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition">Quay l·∫°i</button>
            <button onclick="updateOrder()" id="btnUpdate" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition">C·∫≠p nh·∫≠t ƒë∆°n h√†ng</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Headers Configuration -->
    <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-800">üîß C·∫•u h√¨nh API TPOS</h2>
        <button onclick="toggleHeaders()" class="text-blue-500 hover:text-blue-600 font-medium"><span id="toggleText">Hi·ªán</span> ‚ñº</button>
      </div>
      <div id="headersSection" class="hidden space-y-4">
        <div class="grid grid-cols-1 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Authorization Token (TPOS) *</label>
            <textarea id="authToken" rows="3" placeholder="Bearer eyJhbGci..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-xs"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">x-request-id (GUID) <button onclick="generateNewGUID()" class="ml-2 text-blue-500 hover:text-blue-600 text-xs">üîÑ T·∫°o m·ªõi</button></label>
            <input type="text" id="requestId" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm">
          </div>
        </div>
        <div class="flex flex-wrap gap-3 mt-4">
          <button onclick="saveHeaders()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">üíæ L∆∞u</button>
          <button onclick="loadDefaultHeaders()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition">üîÑ M·∫∑c ƒë·ªãnh</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Attribute Modal -->
  <div id="attributeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">Ch·ªçn Bi·∫øn Th·ªÉ</h3>
        <button onclick="ProductModule.closeAttributeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
      </div>
      <div class="flex gap-2 mb-4 border-b">
        <button class="px-4 py-2 font-semibold border-b-2 border-blue-500 text-blue-500" onclick="ProductModule.switchAttrTab('sizeText', event)">Size Ch·ªØ</button>
        <button class="px-4 py-2 font-semibold text-gray-500" onclick="ProductModule.switchAttrTab('color', event)">M√†u</button>
        <button class="px-4 py-2 font-semibold text-gray-500" onclick="ProductModule.switchAttrTab('sizeNumber', event)">Size S·ªë</button>
      </div>
      <div id="tab-sizeText" class="attr-tab-content">
        <select id="sizeTextSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3"></select>
        <div id="sizeTextChips" class="min-h-16 p-3 bg-gray-50 rounded-lg flex flex-wrap gap-2"></div>
      </div>
      <div id="tab-color" class="attr-tab-content hidden">
        <select id="colorSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3"></select>
        <div id="colorChips" class="min-h-16 p-3 bg-gray-50 rounded-lg flex flex-wrap gap-2"></div>
      </div>
      <div id="tab-sizeNumber" class="attr-tab-content hidden">
        <select id="sizeNumberSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3"></select>
        <div id="sizeNumberChips" class="min-h-16 p-3 bg-gray-50 rounded-lg flex flex-wrap gap-2"></div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="ProductModule.saveAttributeLines()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">‚úÖ L∆∞u</button>
        <button onclick="ProductModule.closeAttributeModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">‚ùå H·ªßy</button>
      </div>
    </div>
  </div>

  <script src="product-module.js"></script>
  <script>
    // ========== SHARED STATE ==========
    let currentStep = 1;
    let orders = [];
    let selectedOrder = null;
    let products = [];
    let selectedProducts = [];
    let orderDetail = null;

    // ========== UTILITIES ==========
    function generateGUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function generateNewGUID() {
      document.getElementById('requestId').value = generateGUID();
      showMessage('success', 'ƒê√£ t·∫°o GUID m·ªõi');
    }

    function getHeaders() {
      return {
        'accept': 'application/json, text/plain, */*',
        'authorization': document.getElementById('authToken')?.value?.trim() || '',
        'accept-language': 'vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7',
        'content-type': 'application/json;charset=UTF-8',
        'origin': 'https://tomato.tpos.vn',
        'referer': 'https://tomato.tpos.vn/',
        'tposappversion': '5.9.10.1',
        'user-agent': navigator.userAgent,
        'x-request-id': document.getElementById('requestId')?.value || generateGUID()
      };
    }

    function showMessage(type, text) {
      const alert = document.getElementById('messageAlert');
      alert.className = `mb-6 p-4 rounded-lg flex items-center gap-3 fade-in ${
        type === 'success' ? 'bg-green-100 text-green-800' : 
        type === 'info' ? 'bg-blue-100 text-blue-800' :
        type === 'warning' ? 'bg-orange-100 text-orange-800' :
        'bg-red-100 text-red-800'
      }`;
      alert.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'info' ? '‚Ñπ' : '‚ö†'}</span><span>${text}</span>`;
      alert.classList.remove('hidden');
      setTimeout(() => alert.classList.add('hidden'), 5000);
    }

    function toggleHeaders() {
      const section = document.getElementById('headersSection');
      const toggleText = document.getElementById('toggleText');
      section.classList.toggle('hidden');
      toggleText.textContent = section.classList.contains('hidden') ? 'Hi·ªán' : '·∫®n';
    }

    function saveHeaders() {
      try {
        const config = {
          authToken: document.getElementById('authToken').value,
          requestId: document.getElementById('requestId').value
        };
        localStorage.setItem('tposHeaders', JSON.stringify(config));
        showMessage('success', 'ƒê√£ l∆∞u c·∫•u h√¨nh');
      } catch (e) {
        showMessage('error', 'L·ªói: ' + e.message);
      }
    }

    function loadDefaultHeaders() {
      document.getElementById('authToken').value = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJDbGllbnRJZCI6InRtdFdlYkFwcCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiZGQxMGFkZmMtZjNhYy00YjcxLWE5ZDQtM2I3MWRhMjYwYzU5IiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6InNob3AxIiwiRGlzcGxheU5hbWUiOiJTaG9wIiwiQXZhdGFyVXJsIjoiIiwiU2VjdXJpdHlTdGFtcCI6ImU4Mzk3YWQ3LTI2YzYtNDU2MS05NWQ5LTgxMThlMjA4NTFkOSIsIkNvbXBhbnlJZCI6IjEiLCJUZW5hbnRJZCI6InRvbWF0by50cG9zLnZuIiwiUm9sZUlkcyI6IjczMTU0MzU4LWQ1MGItNDA5ZS05OWZkLWE5ODQwMTNiNGVhNSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IkFkbWluaXN0cmF0b3JzIiwianRpIjoiZTkwMjg0NGYtNGIyNi00ZDY0LWIzZmEtMzVlODI5YWMwM2E3IiwiaWF0IjoiMTc2MDY5MjUxNiIsIm5iZiI6MTc2MDY5MjUxNiwiZXhwIjoxNzYxOTg4NTE2LCJpc3MiOiJodHRwczovL3RvbWF0by50cG9zLnZuIiwiYXVkIjoiaHR0cHM6Ly90b21hdG8udHBvcy52bixodHRwczovL3Rwb3Mudm4ifQ.7RrDsYu2eS9AFFP3fNsfNaXbEtkgpmEvLDm_zHm8jUg';
      generateNewGUID();
      showMessage('success', 'ƒê√£ kh√¥i ph·ª•c c·∫•u h√¨nh m·∫∑c ƒë·ªãnh');
    }

    function switchModule(module) {
      ['productModule', 'orderModule'].forEach(m => {
        document.getElementById(m).classList.add('hidden');
      });
      document.getElementById(`${module}Module`).classList.remove('hidden');
      
      const buttons = ['btnProduct', 'btnOrder'];
      buttons.forEach(btn => {
        const el = document.getElementById(btn);
        el.classList.remove('active');
        el.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      const activeBtn = module === 'product' ? 'btnProduct' : 'btnOrder';
      const activeEl = document.getElementById(activeBtn);
      activeEl.classList.add('active');
      activeEl.classList.remove('bg-gray-200', 'text-gray-700');
    }

    // ========== ORDER MODULE ==========
    const today = new Date();
    const twoDaysAgo = new Date(today);
    twoDaysAgo.setDate(today.getDate() - 2);
    document.getElementById('startDate').value = twoDaysAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];

    function formatDateForAPI(dateStr, isEndDate = false) {
      const date = new Date(dateStr);
      if (isEndDate) { date.setHours(16, 59, 59, 0); } else { date.setHours(17, 0, 0, 0); date.setDate(date.getDate() - 1); }
      return date.toISOString().replace(/\.\d{3}Z$/, 'Z');
    }

    function goToStep(step) { currentStep = step; updateStepUI(); }

    function updateStepUI() {
      document.getElementById('stepContent1').classList.toggle('hidden', currentStep !== 1);
      document.getElementById('stepContent2').classList.toggle('hidden', currentStep !== 2);
      document.getElementById('stepContent3').classList.toggle('hidden', currentStep < 3);
      document.getElementById('updateSection').classList.toggle('hidden', currentStep !== 4);
      for (let i = 1; i <= 4; i++) {
        const circle = document.getElementById(`step${i}`);
        circle.classList.toggle('bg-blue-500', i <= currentStep);
        circle.classList.toggle('text-white', i <= currentStep);
        circle.classList.toggle('bg-gray-200', i > currentStep);
        circle.classList.toggle('text-gray-500', i > currentStep);
      }
      for (let i = 1; i <= 3; i++) {
        document.getElementById(`line${i}`).classList.toggle('bg-blue-500', i < currentStep);
      }
    }

    async function fetchOrders() {
      try {
        const startDate = formatDateForAPI(document.getElementById('startDate').value, false);
        const endDate = formatDateForAPI(document.getElementById('endDate').value, true);
        const sessionIndex = document.getElementById('sessionIndex').value;
        const url = `https://tomato.tpos.vn/odata/SaleOnline_Order/ODataService.GetView?$top=50&$orderby=DateCreated desc&$filter=(DateCreated ge ${startDate} and DateCreated le ${endDate} and SessionIndex eq ${sessionIndex})&$count=true`;
        const response = await fetch(url, { headers: getHeaders() });
        const data = await response.json();
        orders = data.value || [];
        displayOrders();
        showMessage('success', `T√¨m th·∫•y ${data['@odata.count']} ƒë∆°n h√†ng`);
        goToStep(2);
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    function displayOrders() {
      document.getElementById('orderCount').textContent = orders.length;
      const container = document.getElementById('ordersList');
      container.innerHTML = orders.map(order => `
        <div onclick="selectOrder('${order.Id}')" id="order-${order.Id}" class="order-item p-4 border-2 rounded-lg cursor-pointer transition border-gray-200 hover:border-blue-300">
          <div class="flex justify-between">
            <div><p class="font-bold">#${order.Code}</p><p class="text-sm text-gray-600">${order.Name}</p></div>
            <div class="text-right"><p class="font-bold text-blue-600">${order.TotalAmount?.toLocaleString('vi-VN')}‚Ç´</p><p class="text-sm">SL: ${order.TotalQuantity}</p></div>
          </div>
        </div>
      `).join('');
    }

    function selectOrder(orderId) {
      selectedOrder = orders.find(o => o.Id === orderId);
      document.querySelectorAll('.order-item').forEach(item => item.classList.remove('border-blue-500', 'bg-blue-50'));
      document.getElementById(`order-${orderId}`).classList.add('border-blue-500', 'bg-blue-50');
    }

    async function fetchOrderDetail() {
      if (!selectedOrder) return showMessage('error', 'Vui l√≤ng ch·ªçn ƒë∆°n h√†ng');
      try {
        const response = await fetch(`https://tomato.tpos.vn/odata/SaleOnline_Order(${selectedOrder.Id})?$expand=Details,Partner,User,CRMTeam`, { headers: getHeaders() });
        orderDetail = await response.json();
        document.getElementById('orderCode').textContent = orderDetail.Code;
        document.getElementById('customerName').textContent = orderDetail.Name;
        showMessage('success', 'ƒê√£ t·∫£i chi ti·∫øt ƒë∆°n h√†ng');
        goToStep(4);
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    async function searchProducts() {
      const searchTerm = document.getElementById('productSearch').value.trim();
      if (!searchTerm) return showMessage('error', 'Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m');
      try {
        const response = await fetch(`https://tomato.tpos.vn/odata/Product/OdataService.GetViewV2?Active=true&Name=${encodeURIComponent(searchTerm)}`, { headers: getHeaders() });
        const data = await response.json();
        products = data.value || [];
        displayProducts();
        showMessage('success', `T√¨m th·∫•y ${data['@odata.count']} s·∫£n ph·∫©m`);
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    function displayProducts() {
      document.getElementById('productsList').innerHTML = products.map(product => `
        <div class="p-3 border rounded-lg flex justify-between items-center hover:border-blue-300">
          <div><p class="font-semibold">${product.NameGet}</p><p class="text-sm text-gray-600">${product.ListPrice?.toLocaleString('vi-VN')}‚Ç´</p></div>
          <button onclick='addProductToList(${JSON.stringify(product).replace(/'/g, "&apos;")})' class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Th√™m</button>
        </div>
      `).join('');
    }

    function addProductToList(product) {
      if (selectedProducts.find(p => p.ProductId === product.Id)) return showMessage('error', 'S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m');
      selectedProducts.push({
        ProductId: product.Id, ProductName: product.Name, ProductNameGet: product.NameGet,
        UOMId: 1, UOMName: product.UOMName || "C√°i", Quantity: 1, Price: product.ListPrice || 0, Factor: 1, ProductWeight: 0
      });
      displaySelectedProducts();
      showMessage('success', 'ƒê√£ th√™m s·∫£n ph·∫©m');
    }

    function displaySelectedProducts() {
      document.getElementById('selectedCount').textContent = selectedProducts.length;
      document.getElementById('newProductCount').textContent = selectedProducts.length;
      document.getElementById('selectedProductsList').innerHTML = selectedProducts.map((product, index) => `
        <div class="p-4 border rounded-lg flex justify-between items-center mb-3">
          <div class="flex-1"><p class="font-semibold">${product.ProductNameGet}</p><p class="text-sm text-gray-600">${product.Price?.toLocaleString('vi-VN')}‚Ç´</p></div>
          <div class="flex items-center gap-3">
            <input type="number" min="1" value="${product.Quantity}" onchange="updateQuantity(${index}, this.value)" class="w-20 px-3 py-2 border rounded-lg text-center">
            <button onclick="removeProduct(${index})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">X√≥a</button>
          </div>
        </div>
      `).join('');
    }

    function updateQuantity(index, quantity) { selectedProducts[index].Quantity = parseInt(quantity) || 1; }
    function removeProduct(index) { selectedProducts.splice(index, 1); displaySelectedProducts(); }

    async function updateOrder() {
      if (!orderDetail || selectedProducts.length === 0) return showMessage('error', 'Ch∆∞a ƒë·ªß d·ªØ li·ªáu');
      try {
        generateNewGUID();
        const updatedOrder = { ...orderDetail, Details: selectedProducts };
        const response = await fetch(`https://tomato.tpos.vn/odata/SaleOnline_Order(${orderDetail.Id})`,
          { method: 'PUT', headers: getHeaders(), body: JSON.stringify(updatedOrder) });
        if (response.ok) showMessage('success', 'C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng!');
        else showMessage('error', 'L·ªói khi c·∫≠p nh·∫≠t');
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    // ========== INITIALIZE ==========
    ProductModule.initProductModule(getHeaders, showMessage);

    const savedConfig = localStorage.getItem('tposHeaders');
    if (savedConfig) {
      try {
        const config = JSON.parse(savedConfig);
        if (config.authToken) document.getElementById('authToken').value = config.authToken;
        if (config.requestId) document.getElementById('requestId').value = config.requestId;
      } catch (e) {}
    } else {
      loadDefaultHeaders();
    }
    updateStepUI();
  </script>
</body>
</html>
