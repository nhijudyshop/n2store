<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPOS Manager - Qu·∫£n L√Ω T·ªïng H·ª£p</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3B82F6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tab-button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .size-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }
    .size-chip-remove {
      background: rgba(255, 255, 255, 0.3);
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
  <div class="container mx-auto p-6 max-w-7xl">
    <!-- Main Navigation -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-3xl font-bold text-gray-800">üöÄ TPOS Manager</h1>
        <div class="flex gap-3 flex-wrap">
          <button onclick="switchModule('product')" id="btnProduct" class="tab-button px-6 py-3 rounded-lg font-semibold transition active">
            üõçÔ∏è Qu·∫£n L√Ω S·∫£n Ph·∫©m
          </button>
          <button onclick="switchModule('order')" id="btnOrder" class="tab-button px-6 py-3 rounded-lg font-semibold transition bg-gray-200 text-gray-700">
            üì¶ Qu·∫£n L√Ω ƒê∆°n H√†ng
          </button>
          <button onclick="switchModule('fbpages')" id="btnFBPages" class="tab-button px-6 py-3 rounded-lg font-semibold transition bg-gray-200 text-gray-700">
            üì± Facebook Pages
          </button>
          <button onclick="switchModule('fbcomments')" id="btnFBComments" class="tab-button px-6 py-3 rounded-lg font-semibold transition bg-gray-200 text-gray-700">
            üí¨ FB Comments
          </button>
        </div>
      </div>
    </div>

    <!-- Message Alert -->
    <div id="messageAlert" class="hidden mb-6 p-4 rounded-lg flex items-center gap-3 fade-in"></div>

    <!-- Product Module -->
    <div id="productModule">
      <!-- Product Form -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Th√™m S·∫£n Ph·∫©m M·ªõi</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">M√£ S·∫£n Ph·∫©m *</label>
            <input type="text" id="defaultCode" placeholder="VD: NTEST" value="NTEST" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">T√™n S·∫£n Ph·∫©m *</label>
            <input type="text" id="productName" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Gi√° B√°n (VNƒê) *</label>
            <input type="number" id="listPrice" value="200000" min="0"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Gi√° Mua (VNƒê) *</label>
            <input type="number" id="purchasePrice" value="100000" min="0"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë L∆∞·ª£ng *</label>
            <input type="number" id="qtyAvailable" value="1" min="0"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">H√¨nh ·∫¢nh</label>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500 transition" id="imageUpload">
              <div id="imageUploadPlaceholder">
                <p class="text-sm text-gray-600">üì∑ Click ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c Paste (Ctrl+V)</p>
              </div>
              <div id="imagePreviewContainer" class="hidden">
                <img id="imagePreview" src="" alt="Preview" class="max-h-40 mx-auto rounded-lg mb-2">
                <button type="button" onclick="removeImage()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                  üóëÔ∏è X√≥a ·∫£nh
                </button>
              </div>
              <input type="file" id="fileInput" accept="image/*" class="hidden">
            </div>
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Bi·∫øn Th·ªÉ (AttributeLines)</label>
          <button onclick="openAttributeModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
            üìù Ch·ªçn Bi·∫øn Th·ªÉ
          </button>
          <textarea id="attributeLinesDisplay" readonly class="w-full mt-2 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 font-mono text-xs" rows="3">[]</textarea>
        </div>

        <div class="flex gap-3 mt-6">
          <button onclick="createProductOneClick()" class="flex-1 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-bold py-4 px-6 rounded-lg transition-all transform hover:scale-105 shadow-lg">
            üöÄ T·∫°o S·∫£n Ph·∫©m (1 Click)
          </button>
        </div>
      </div>

      <!-- Product Result -->
      <div id="productResult" class="hidden bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">K·∫øt Qu·∫£</h3>
        <pre id="productResultContent" class="bg-gray-50 p-4 rounded-lg overflow-x-auto text-xs"></pre>
      </div>
    </div>

    <!-- Order Module -->
    <div id="orderModule" class="hidden">
      <!-- Progress Steps -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div id="step1" class="w-10 h-10 rounded-full flex items-center justify-center font-bold bg-blue-500 text-white">1</div>
            <div id="line1" class="w-20 h-1 bg-gray-200"></div>
          </div>
          <div class="flex items-center">
            <div id="step2" class="w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">2</div>
            <div id="line2" class="w-20 h-1 bg-gray-200"></div>
          </div>
          <div class="flex items-center">
            <div id="step3" class="w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">3</div>
            <div id="line3" class="w-20 h-1 bg-gray-200"></div>
          </div>
          <div id="step4" class="w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">4</div>
        </div>
        <div class="flex justify-between mt-2 text-sm text-gray-600">
          <span>T√¨m ƒë∆°n</span>
          <span>Ch·ªçn ƒë∆°n</span>
          <span>Ch·ªçn SP</span>
          <span>C·∫≠p nh·∫≠t</span>
        </div>
      </div>

      <!-- Step 1: Date Range -->
      <div id="stepContent1" class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">üìÖ B∆∞·ªõc 1: Ch·ªçn kho·∫£ng th·ªùi gian</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ng√†y b·∫Øt ƒë·∫ßu</label>
            <input type="date" id="startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ng√†y k·∫øt th√∫c</label>
            <input type="date" id="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Session Index</label>
            <input type="text" id="sessionIndex" value="60" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        
        <button onclick="fetchOrders()" id="btnFetchOrders" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">
          T√¨m ƒë∆°n h√†ng
        </button>
      </div>

      <!-- Step 2: Select Order -->
      <div id="stepContent2" class="hidden bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">üõçÔ∏è B∆∞·ªõc 2: Ch·ªçn ƒë∆°n h√†ng (<span id="orderCount">0</span>)</h2>
        <div id="ordersList" class="max-h-96 overflow-y-auto space-y-3"></div>
        <div class="flex gap-3 mt-6">
          <button onclick="goToStep(1)" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition">
            Quay l·∫°i
          </button>
          <button onclick="fetchOrderDetail()" id="btnContinue" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">
            Ti·∫øp t·ª•c
          </button>
        </div>
      </div>

      <!-- Step 3 & 4: Product Selection -->
      <div id="stepContent3" class="hidden space-y-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">üîç B∆∞·ªõc 3: T√¨m v√† ch·ªçn s·∫£n ph·∫©m</h2>
          <div class="flex gap-3 mb-4">
            <input type="text" id="productSearch" placeholder="Nh·∫≠p t√™n ho·∫∑c m√£ s·∫£n ph·∫©m..." 
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                   onkeypress="if(event.key==='Enter') searchProducts()">
            <button onclick="searchProducts()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg transition">
              T√¨m
            </button>
          </div>
          <div id="productsList" class="max-h-64 overflow-y-auto space-y-2"></div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">S·∫£n ph·∫©m ƒë√£ ch·ªçn (<span id="selectedCount">0</span>)</h3>
          <div id="selectedProductsList"></div>
        </div>

        <div id="updateSection" class="hidden bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">üíæ B∆∞·ªõc 4: C·∫≠p nh·∫≠t ƒë∆°n h√†ng</h2>
          <div class="bg-blue-50 p-4 rounded-lg mb-4">
            <p class="text-sm text-gray-700"><strong>ƒê∆°n h√†ng:</strong> #<span id="orderCode"></span></p>
            <p class="text-sm text-gray-700"><strong>Kh√°ch h√†ng:</strong> <span id="customerName"></span></p>
            <p class="text-sm text-gray-700"><strong>S·ªë s·∫£n ph·∫©m m·ªõi:</strong> <span id="newProductCount"></span></p>
          </div>
          <div class="flex gap-3">
            <button onclick="goToStep(2)" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition">
              Quay l·∫°i
            </button>
            <button onclick="updateOrder()" id="btnUpdate" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition">
              C·∫≠p nh·∫≠t ƒë∆°n h√†ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Facebook Pages Module -->
    <div id="fbpagesModule" class="hidden space-y-6">
      <!-- Add New Page -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üì± Th√™m Facebook Page</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">T√™n Page *</label>
            <input type="text" id="fbPageName" placeholder="VD: NhiJudy Store"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Page ID *</label>
            <input type="text" id="fbPageId" placeholder="193642490509664"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <div class="mt-6">
          <button onclick="addFacebookPage()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition">
            ‚ûï Th√™m Page
          </button>
        </div>
      </div>

      <!-- Pages List -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Danh S√°ch Facebook Pages</h2>
          <button onclick="loadFacebookPages()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
            üîÑ L√†m m·ªõi
          </button>
        </div>
        
        <div id="fbPagesList" class="space-y-3"></div>
      </div>

      <!-- CRM Team Configuration -->
      <div id="crmConfigSection" class="hidden bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">‚öôÔ∏è C·∫•u h√¨nh CRM Team</h2>
        
        <div class="bg-blue-50 p-4 rounded-lg mb-4">
          <p class="text-sm text-gray-700"><strong>Page:</strong> <span id="configPageName"></span></p>
          <p class="text-sm text-gray-700"><strong>Page ID:</strong> <span id="configPageId"></span></p>
        </div>

        <div class="space-y-4">
          <div>
            <button onclick="loadCRMTeams()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition mb-3">
              üì• T·∫£i CRM Teams t·ª´ TPOS
            </button>
            
            <select id="crmTeamSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">-- Ch·ªçn CRM Team --</option>
            </select>
          </div>

          <div class="text-sm text-gray-600">Ho·∫∑c nh·∫≠p th·ªß c√¥ng:</div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">CRM Team ID</label>
              <input type="text" id="manualCrmTeamId" placeholder="VD: 123"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Team Name</label>
              <input type="text" id="manualCrmTeamName" placeholder="VD: Team A"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="saveCRMConfig()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition">
              üíæ L∆∞u CRM Team
            </button>
            <button onclick="cancelCRMConfig()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition">
              ‚ùå H·ªßy
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Facebook Comments Module -->
    <div id="fbcommentsModule" class="hidden space-y-6">
      <!-- Page Selection -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üí¨ Qu·∫£n L√Ω Comments Livestream</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn Facebook Page *</label>
            <select id="commentsPageSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="onCommentsPageChange()">
              <option value="">-- Ch·ªçn Page --</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë l∆∞·ª£ng videos</label>
            <input type="number" id="videoLimit" value="5" min="1" max="50"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <div class="mt-6">
          <button onclick="loadVideos()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">
            üìπ T·∫£i Videos
          </button>
        </div>
      </div>

      <!-- Videos List -->
      <div id="videosSection" class="hidden bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Danh S√°ch Videos (<span id="videoCount">0</span>)</h3>
        <div id="videosList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

      <!-- Comments Section -->
      <div id="commentsSection" class="hidden bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">
            Comments: <span id="selectedVideoTitle"></span>
          </h3>
          <div class="flex gap-2">
            <button onclick="refreshComments()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
              üîÑ L√†m m·ªõi
            </button>
            <button onclick="backToVideos()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition">
              ‚¨ÖÔ∏è Quay l·∫°i
            </button>
          </div>
        </div>

        <div class="mb-4">
          <input type="text" id="commentSearch" placeholder="T√¨m ki·∫øm comments..." 
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                 oninput="filterComments()">
        </div>

        <div id="commentsList" class="space-y-3 max-h-96 overflow-y-auto"></div>
      </div>
    </div>

    <!-- Headers Configuration (Shared) -->
    <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-800">üîß C·∫•u h√¨nh Headers API (D√πng chung)</h2>
        <button onclick="toggleHeaders()" class="text-blue-500 hover:text-blue-600 font-medium">
          <span id="toggleText">Hi·ªán</span> ‚ñº
        </button>
      </div>
      
      <div id="headersSection" class="hidden space-y-4">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
          <p class="text-sm text-yellow-800">
            ‚ö†Ô∏è <strong>Headers ƒë∆∞·ª£c chia s·∫ª gi·ªØa t·∫•t c·∫£ c√°c module.</strong> C·∫•u h√¨nh m·ªôt l·∫ßn, d√πng cho t·∫•t c·∫£.
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Authorization Token</label>
            <textarea id="authToken" rows="3" placeholder="Bearer eyJhbGci..."
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-xs"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              x-request-id (GUID)
              <button onclick="generateNewGUID()" class="ml-2 text-blue-500 hover:text-blue-600 text-xs">üîÑ T·∫°o m·ªõi</button>
            </label>
            <input type="text" id="requestId" readonly
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm">
          </div>
        </div>

        <div class="flex flex-wrap gap-3 mt-4">
          <button onclick="saveHeaders()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">
            üíæ L∆∞u
          </button>
          <button onclick="loadDefaultHeaders()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition">
            üîÑ M·∫∑c ƒë·ªãnh
          </button>
          <button onclick="loadBrowserHeaders()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition">
            üì± L·∫•y t·ª´ Browser
          </button>
          <button onclick="showPasteModal()" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition">
            üì• Paste Headers
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Attribute Modal -->
  <div id="attributeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">Ch·ªçn Bi·∫øn Th·ªÉ</h3>
        <button onclick="closeAttributeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
      </div>

      <div class="flex gap-2 mb-4 border-b">
        <button class="px-4 py-2 font-semibold border-b-2 border-blue-500 text-blue-500" onclick="switchAttrTab('sizeText')">Size Ch·ªØ</button>
        <button class="px-4 py-2 font-semibold text-gray-500" onclick="switchAttrTab('color')">M√†u</button>
        <button class="px-4 py-2 font-semibold text-gray-500" onclick="switchAttrTab('sizeNumber')">Size S·ªë</button>
      </div>

      <div id="tab-sizeText" class="attr-tab-content">
        <select id="sizeTextSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3"></select>
        <div id="sizeTextChips" class="min-h-16 p-3 bg-gray-50 rounded-lg flex flex-wrap gap-2"></div>
      </div>

      <div id="tab-color" class="attr-tab-content hidden">
        <select id="colorSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3"></select>
        <div id="colorChips" class="min-h-16 p-3 bg-gray-50 rounded-lg flex flex-wrap gap-2"></div>
      </div>

      <div id="tab-sizeNumber" class="attr-tab-content hidden">
        <select id="sizeNumberSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3"></select>
        <div id="sizeNumberChips" class="min-h-16 p-3 bg-gray-50 rounded-lg flex flex-wrap gap-2"></div>
      </div>

      <div class="flex gap-3 mt-6">
        <button onclick="saveAttributeLines()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">
          ‚úÖ L∆∞u
        </button>
        <button onclick="closeAttributeModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
          ‚ùå H·ªßy
        </button>
      </div>
    </div>
  </div>

  <!-- Paste Headers Modal -->
  <div id="pasteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">üì• Paste Raw Headers</h3>
        <button onclick="closePasteModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
      </div>
      
      <textarea id="rawHeadersInput" rows="15" placeholder="authorization: Bearer eyJhbGci...
content-type: application/json
x-request-id: 12345678-1234-4567..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
      
      <div class="flex gap-3 mt-4">
        <button onclick="closePasteModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
          ‚ùå H·ªßy
        </button>
        <button onclick="parseAndApplyHeaders()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">
          ‚úÖ √Åp d·ª•ng
        </button>
      </div>
    </div>
  </div>

  <script>
    // ========== SHARED STATE ==========
    const availableAttributes = {
      sizeText: {
        id: 1, name: "Size Ch·ªØ", code: "SZCh",
        values: [
          { Id: 31, Name: "XXL", Code: "xxl", Sequence: null },
          { Id: 32, Name: "XXXL", Code: "xxxl", Sequence: null },
          { Id: 5, Name: "Free Size", Code: "FS", Sequence: 0 },
          { Id: 1, Name: "S", Code: "S", Sequence: 1 },
          { Id: 2, Name: "M", Code: "M", Sequence: 2 },
          { Id: 3, Name: "L", Code: "L", Sequence: 3 },
          { Id: 4, Name: "XL", Code: "XL", Sequence: 4 },
        ],
      },
      color: {
        id: 3, name: "M√†u", code: "Mau",
        values: [
          { Id: 6, Name: "Tr·∫Øng", Code: "trang", Sequence: null },
          { Id: 7, Name: "ƒêen", Code: "den", Sequence: null },
          { Id: 8, Name: "ƒê·ªè", Code: "do", Sequence: null },
          { Id: 9, Name: "V√†ng", Code: "vang", Sequence: null },
          { Id: 10, Name: "Cam", Code: "cam", Sequence: null },
          { Id: 11, Name: "X√°m", Code: "xam", Sequence: null },
          { Id: 12, Name: "H·ªìng", Code: "hong", Sequence: null },
        ],
      },
      sizeNumber: {
        id: 4, name: "Size S·ªë", code: "SZNu",
        values: [
          { Id: 18, Name: "29", Code: "29", Sequence: null },
          { Id: 19, Name: "30", Code: "30", Sequence: null },
          { Id: 20, Name: "31", Code: "31", Sequence: null },
          { Id: 21, Name: "32", Code: "32", Sequence: null },
        ],
      },
    };

    let currentAttributeLines = [];
    let imageBase64 = null;
    let imagePreviewUrl = null;
    let currentModule = 'product';

    // Order module state
    let currentStep = 1;
    let orders = [];
    let selectedOrder = null;
    let products = [];
    let selectedProducts = [];
    let orderDetail = null;

    // Facebook Pages state
    let facebookPages = [];
    let selectedPageForConfig = null;
    let crmTeams = [];

    // Facebook Comments state
    let selectedCommentsPage = null;
    let videos = [];
    let selectedVideo = null;
    let comments = [];
    let allComments = [];

    // ========== MODULE SWITCHING ==========
    function switchModule(module) {
      currentModule = module;
      
      // Hide all modules
      document.getElementById('productModule').classList.add('hidden');
      document.getElementById('orderModule').classList.add('hidden');
      document.getElementById('fbpagesModule').classList.add('hidden');
      document.getElementById('fbcommentsModule').classList.add('hidden');
      
      // Show selected module
      document.getElementById(`${module}Module`).classList.remove('hidden');
      
      // Update button styles
      const buttons = ['btnProduct', 'btnOrder', 'btnFBPages', 'btnFBComments'];
      buttons.forEach(btn => {
        const element = document.getElementById(btn);
        element.classList.remove('active');
        element.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      const activeBtn = {
        'product': 'btnProduct',
        'order': 'btnOrder',
        'fbpages': 'btnFBPages',
        'fbcomments': 'btnFBComments'
      }[module];
      
      const activeElement = document.getElementById(activeBtn);
      activeElement.classList.add('active');
      activeElement.classList.remove('bg-gray-200', 'text-gray-700');

      // Load data for specific modules
      if (module === 'fbpages') {
        loadFacebookPages();
      } else if (module === 'fbcomments') {
        loadCommentsPageList();
      }
    }

    // ========== HEADERS MANAGEMENT ==========
    function generateGUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0;
        var v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function generateNewGUID() {
      const guid = generateGUID();
      document.getElementById('requestId').value = guid;
      showMessage('success', 'ƒê√£ t·∫°o GUID m·ªõi');
    }

    function getHeaders() {
      return {
        'accept': 'application/json, text/plain, */*',
        'authorization': document.getElementById('authToken').value.trim() || 'Bearer eyJhbGci...',
        'accept-language': 'vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7',
        'content-type': 'application/json;charset=UTF-8',
        'origin': 'https://tomato.tpos.vn',
        'referer': 'https://tomato.tpos.vn/',
        'tposappversion': '5.9.10.1',
        'user-agent': navigator.userAgent,
        'x-request-id': document.getElementById('requestId').value
      };
    }

    function toggleHeaders() {
      const section = document.getElementById('headersSection');
      const toggleText = document.getElementById('toggleText');
      section.classList.toggle('hidden');
      toggleText.textContent = section.classList.contains('hidden') ? 'Hi·ªán' : '·∫®n';
    }

    function saveHeaders() {
      const headers = {
        authToken: document.getElementById('authToken').value,
        requestId: document.getElementById('requestId').value
      };
      try {
        localStorage.setItem('tposHeaders', JSON.stringify(headers));
        showMessage('success', 'ƒê√£ l∆∞u headers');
      } catch (e) {
        showMessage('success', 'ƒê√£ √°p d·ª•ng headers');
      }
    }

    function loadDefaultHeaders() {
      document.getElementById('authToken').value = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJDbGllbnRJZCI6InRtdFdlYkFwcCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiZmMwZjQ0MzktOWNmNi00ZDg4LWE4YzctNzU5Y2E4Mjk1MTQyIiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6Im52MjAiLCJEaXNwbGF5TmFtZSI6IlTDuiIsIkF2YXRhclVybCI6IiIsIlNlY3VyaXR5U3RhbXAiOiI1ZjY1NjQwMy01NjdmLTRmYzAtYjYxNy0yODJhYzgxZGY1ZWQiLCJDb21wYW55SWQiOiIxIiwiVGVuYW50SWQiOiJ0b21hdG8udHBvcy52biIsIlJvbGVJZHMiOiI0MmZmYzk5Yi1lNGY2LTQwMDAtYjcyOS1hZTNmMDAyOGEyODksNmExZDAwMDAtNWQxYS0wMDE1LTBlNmMtMDhkYzM3OTUzMmU5LDc2MzlhMDQ4LTdjZmUtNDBiNS1hNDFkLWFlM2YwMDNiODlkZiw4YmM4ZjQ1YS05MWY4LTQ5NzMtYjE4Mi1hZTNmMDAzYWI4NTUsYTljMjAwMDAtNWRiNi0wMDE1LTQ1YWItMDhkYWIxYmZlMjIyIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjpbIlF14bqjbiBMw70gTWFpIiwiQ8OSSSIsIkNTS0ggLSBMw6BpIiwiS2hvIFBoxrDhu5tjLSBLaeG7h3QiLCJRdeG6o24gTMO9IEtobyAtIEJvIl0sImp0aSI6IjYxMDI0MTA5LTdmOGEtNDk3Zi05NGYxLTY3YzIwMjZiZWUyNCIsImlhdCI6IjE3NTk4MTI1MzAiLCJuYmYiOjE3NTk4MTI1MzAsImV4cCI6MTc2MTEwODUzMCwiaXNzIjoiaHR0cHM6Ly90b21hdG8udHBvcy52biIsImF1ZCI6Imh0dHBzOi8vdG9tYXRvLnRwb3Mudm4saHR0cHM6Ly90cG9zLnZuIn0.OVAcmG1fPovK8rJ65dkNlEADtnyWu-d6BUKP0wxZuXk';
      generateNewGUID();
      showMessage('success', 'ƒê√£ kh√¥i ph·ª•c c·∫•u h√¨nh m·∫∑c ƒë·ªãnh');
    }

    function loadBrowserHeaders() {
      generateNewGUID();
      showMessage('success', 'ƒê√£ load headers t·ª´ Browser');
    }

    function showPasteModal() {
      document.getElementById('pasteModal').classList.remove('hidden');
    }

    function closePasteModal() {
      document.getElementById('pasteModal').classList.add('hidden');
    }

    function parseAndApplyHeaders() {
      const rawInput = document.getElementById('rawHeadersInput').value.trim();
      if (!rawInput) {
        showMessage('error', 'Vui l√≤ng paste headers');
        return;
      }
      try {
        const headers = parseRawHeaders(rawInput);
        if (headers['x-request-id']) {
          document.getElementById('requestId').value = headers['x-request-id'];
        }
        showMessage('success', 'ƒê√£ √°p d·ª•ng headers (Token gi·ªØ nguy√™n)');
        closePasteModal();
      } catch (error) {
        showMessage('error', 'L·ªói parse headers: ' + error.message);
      }
    }

    function parseRawHeaders(rawText) {
      const headers = {};
      if (rawText.includes('curl ')) {
        const headerMatches = rawText.matchAll(/-H\s+['"]([^:]+):\s*([^'"]+)['"]/g);
        for (const match of headerMatches) {
          headers[match[1].toLowerCase().trim()] = match[2].trim();
        }
      } else {
        const lines = rawText.split('\n');
        for (const line of lines) {
          const colonIndex = line.indexOf(':');
          if (colonIndex > 0) {
            const key = line.substring(0, colonIndex).toLowerCase().trim();
            const value = line.substring(colonIndex + 1).trim();
            if (key && value) headers[key] = value;
          }
        }
      }
      return headers;
    }

    // ========== PRODUCT MODULE (Keep existing code) ==========
    document.getElementById('defaultCode').addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
    });

    document.getElementById('imageUpload').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleImageFile(file);
    });

    document.addEventListener('paste', (e) => {
      const items = e.clipboardData.items;
      for (let item of items) {
        if (item.type.indexOf('image') !== -1) {
          handleImageFile(item.getAsFile());
        }
      }
    });

    function handleImageFile(file) {
      if (!file.type.startsWith('image/')) {
        showMessage('error', 'Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const fullDataUrl = e.target.result;
        imageBase64 = fullDataUrl.split(',')[1];
        imagePreviewUrl = fullDataUrl;
        
        document.getElementById('imagePreview').src = imagePreviewUrl;
        document.getElementById('imageUploadPlaceholder').classList.add('hidden');
        document.getElementById('imagePreviewContainer').classList.remove('hidden');
        document.getElementById('imageUpload').classList.add('border-green-500');
        
        showMessage('success', `ƒê√£ t·∫£i ·∫£nh th√†nh c√¥ng! (${(file.size / 1024).toFixed(2)} KB)`);
      };
      reader.readAsDataURL(file);
    }

    function removeImage() {
      event.stopPropagation();
      imageBase64 = null;
      imagePreviewUrl = null;
      document.getElementById('imagePreview').src = '';
      document.getElementById('imageUploadPlaceholder').classList.remove('hidden');
      document.getElementById('imagePreviewContainer').classList.add('hidden');
      document.getElementById('imageUpload').classList.remove('border-green-500');
      document.getElementById('fileInput').value = '';
      showMessage('success', 'ƒê√£ x√≥a ·∫£nh');
    }

    window.removeImage = removeImage;

    function openAttributeModal() {
      try {
        currentAttributeLines = JSON.parse(document.getElementById('attributeLinesDisplay').value);
      } catch (e) {
        currentAttributeLines = [];
      }
      populateSelect('sizeTextSelect', availableAttributes.sizeText.values);
      populateSelect('colorSelect', availableAttributes.color.values);
      populateSelect('sizeNumberSelect', availableAttributes.sizeNumber.values);
      renderChips('sizeText');
      renderChips('color');
      renderChips('sizeNumber');
      document.getElementById('attributeModal').classList.remove('hidden');
    }

    function closeAttributeModal() {
      document.getElementById('attributeModal').classList.add('hidden');
    }

    function switchAttrTab(tab) {
      document.querySelectorAll('.attr-tab-content').forEach(el => el.classList.add('hidden'));
      document.getElementById(`tab-${tab}`).classList.remove('hidden');
      
      document.querySelectorAll('#attributeModal button').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-500');
        btn.classList.add('text-gray-500');
      });
      event.target.classList.add('border-blue-500', 'text-blue-500');
      event.target.classList.remove('text-gray-500');
    }

    function populateSelect(selectId, values) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">-- Ch·ªçn --</option>';
      values.forEach(item => {
        select.innerHTML += `<option value="${item.Id}">${item.Name}</option>`;
      });
      
      select.onchange = (e) => {
        const valueId = parseInt(e.target.value);
        if (!valueId) return;
        const type = selectId.replace('Select', '');
        const attrConfig = availableAttributes[type];
        const selectedValue = attrConfig.values.find(v => v.Id === valueId);
        if (!selectedValue) return;

        let attrLine = currentAttributeLines.find(line => line.AttributeId === attrConfig.id);
        if (!attrLine) {
          attrLine = {
            Attribute: { Id: attrConfig.id, Name: attrConfig.name, Code: attrConfig.code, Sequence: null, CreateVariant: true },
            Values: [],
            AttributeId: attrConfig.id,
          };
          currentAttributeLines.push(attrLine);
        }

        if (attrLine.Values.find(v => v.Id === valueId)) {
          showMessage('error', 'Gi√° tr·ªã ƒë√£ ƒë∆∞·ª£c th√™m');
          e.target.value = '';
          return;
        }

        attrLine.Values.push({
          Id: selectedValue.Id,
          Name: selectedValue.Name,
          Code: selectedValue.Code,
          Sequence: selectedValue.Sequence,
          AttributeId: attrConfig.id,
          AttributeName: attrConfig.name,
          PriceExtra: null,
          NameGet: `${attrConfig.name}: ${selectedValue.Name}`,
          DateCreated: null,
        });

        renderChips(type);
        e.target.value = '';
      };
    }

    function renderChips(type) {
      const attrConfig = availableAttributes[type];
      const chipsContainer = document.getElementById(`${type}Chips`);
      chipsContainer.innerHTML = '';

      const attrLine = currentAttributeLines.find(line => line.AttributeId === attrConfig.id);
      if (!attrLine || !attrLine.Values || attrLine.Values.length === 0) {
        chipsContainer.innerHTML = '<p class="text-gray-400 text-sm">Ch∆∞a c√≥ gi√° tr·ªã</p>';
        return;
      }

      attrLine.Values.forEach(val => {
        const chip = document.createElement('div');
        chip.className = 'size-chip';
        chip.innerHTML = `<span>${val.Name}</span><button class="size-chip-remove" onclick="removeValue('${type}', ${val.Id})">√ó</button>`;
        chipsContainer.appendChild(chip);
      });
    }

    window.removeValue = (type, valueId) => {
      const attrConfig = availableAttributes[type];
      const attrLine = currentAttributeLines.find(line => line.AttributeId === attrConfig.id);
      if (!attrLine) return;
      attrLine.Values = attrLine.Values.filter(v => v.Id !== valueId);
      if (attrLine.Values.length === 0) {
        currentAttributeLines = currentAttributeLines.filter(line => line.AttributeId !== attrLine.AttributeId);
      }
      renderChips(type);
    };

    function saveAttributeLines() {
      document.getElementById('attributeLinesDisplay').value = JSON.stringify(currentAttributeLines, null, 2);
      closeAttributeModal();
      showMessage('success', 'ƒê√£ l∆∞u bi·∫øn th·ªÉ');
    }

    async function createProductOneClick() {
      const defaultCode = document.getElementById('defaultCode').value.trim().toUpperCase();
      const productName = document.getElementById('productName').value.trim();
      const listPrice = parseFloat(document.getElementById('listPrice').value);
      const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
      const qtyAvailable = parseFloat(document.getElementById('qtyAvailable').value);

      if (!defaultCode || !productName) {
        showMessage('error', '‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß M√£ s·∫£n ph·∫©m v√† T√™n s·∫£n ph·∫©m!');
        return;
      }

      try {
        showMessage('info', 'üîç ƒêang ki·ªÉm tra s·∫£n ph·∫©m...');
        
        const checkResponse = await fetch(
          `https://tomato.tpos.vn/odata/ProductTemplate/OdataService.GetViewV2?Active=true&DefaultCode=${defaultCode}`,
          { headers: getHeaders() }
        );
        const checkData = await checkResponse.json();

        if (checkData.value && checkData.value.length > 0) {
          showMessage('error', '‚ùå S·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i! M√£: ' + defaultCode);
          displayProductResult('‚ùå S·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i', checkData.value[0]);
          return;
        }

        showMessage('info', '‚úÖ S·∫£n ph·∫©m ch∆∞a t·ªìn t·∫°i. ƒêang t·∫°o m·ªõi...');

        const attributeLines = JSON.parse(document.getElementById('attributeLinesDisplay').value);

        const payload = {
          Id: 0, Name: productName, Type: "product", ListPrice: listPrice, PurchasePrice: purchasePrice,
          DefaultCode: defaultCode, QtyAvailable: qtyAvailable, 
          Image: imageBase64,
          ImageUrl: null,
          Thumbnails: [],
          AttributeLines: attributeLines,
          Active: true, SaleOK: true, PurchaseOK: true, UOMId: 1, UOMPOId: 1, CategId: 2, CompanyId: 1,
          Tracking: "none", InvoicePolicy: "order", PurchaseMethod: "receive", AvailableInPOS: true,
          DiscountSale: 0, DiscountPurchase: 0, StandardPrice: 0, Weight: 0, SaleDelay: 0,
          UOM: { Id: 1, Name: "C√°i", Rounding: 0.001, Active: true, Factor: 1, FactorInv: 1, UOMType: "reference", CategoryId: 1, CategoryName: "ƒê∆°n v·ªã" },
          UOMPO: { Id: 1, Name: "C√°i", Rounding: 0.001, Active: true, Factor: 1, FactorInv: 1, UOMType: "reference", CategoryId: 1, CategoryName: "ƒê∆°n v·ªã" },
          Categ: { Id: 2, Name: "C√≥ th·ªÉ b√°n", CompleteName: "C√≥ th·ªÉ b√°n", Type: "normal", PropertyCostMethod: "average", NameNoSign: "Co the ban", IsPos: true },
          Items: [], UOMLines: [], ComboProducts: [], ProductSupplierInfos: []
        };

        const response = await fetch(
          'https://tomato.tpos.vn/odata/ProductTemplate/ODataService.InsertV2?$expand=ProductVariants,UOM,UOMPO',
          { 
            method: 'POST', 
            headers: getHeaders(), 
            body: JSON.stringify(payload) 
          }
        );
        const data = await response.json();

        if (response.ok) {
          showMessage('success', 'üéâ T·∫°o s·∫£n ph·∫©m th√†nh c√¥ng! M√£: ' + defaultCode);
          displayProductResult('‚úÖ T·∫°o s·∫£n ph·∫©m th√†nh c√¥ng', data);
          
          document.getElementById('productName').value = '';
          document.getElementById('defaultCode').value = 'NTEST';
          document.getElementById('attributeLinesDisplay').value = '[]';
          currentAttributeLines = [];
          if (imageBase64) {
            removeImage();
          }
        } else {
          showMessage('error', '‚ùå L·ªói khi t·∫°o s·∫£n ph·∫©m: ' + (data.error?.message || 'Unknown error'));
          displayProductResult('‚ùå L·ªói khi t·∫°o s·∫£n ph·∫©m', data);
        }
      } catch (error) {
        showMessage('error', '‚ùå L·ªói: ' + error.message);
      }
    }

    function displayProductResult(title, data) {
      document.getElementById('productResult').classList.remove('hidden');
      document.getElementById('productResultContent').textContent = JSON.stringify(data, null, 2);
    }

    // ========== ORDER MODULE (Keep existing code) ==========
    const today = new Date();
    const twoDaysAgo = new Date(today);
    twoDaysAgo.setDate(today.getDate() - 2);
    document.getElementById('startDate').value = twoDaysAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];

    function formatDateForAPI(dateStr, isEndDate = false) {
      const date = new Date(dateStr);
      if (isEndDate) {
        date.setHours(16, 59, 59, 0);
      } else {
        date.setHours(17, 0, 0, 0);
        date.setDate(date.getDate() - 1);
      }
      return date.toISOString().replace(/\.\d{3}Z$/, 'Z');
    }

    function goToStep(step) {
      currentStep = step;
      updateStepUI();
    }

    function updateStepUI() {
      document.getElementById('stepContent1').classList.toggle('hidden', currentStep !== 1);
      document.getElementById('stepContent2').classList.toggle('hidden', currentStep !== 2);
      document.getElementById('stepContent3').classList.toggle('hidden', currentStep < 3);
      document.getElementById('updateSection').classList.toggle('hidden', currentStep !== 4);

      for (let i = 1; i <= 4; i++) {
        const circle = document.getElementById(`step${i}`);
        circle.classList.toggle('bg-blue-500', i <= currentStep);
        circle.classList.toggle('text-white', i <= currentStep);
        circle.classList.toggle('bg-gray-200', i > currentStep);
        circle.classList.toggle('text-gray-500', i > currentStep);
      }

      for (let i = 1; i <= 3; i++) {
        document.getElementById(`line${i}`).classList.toggle('bg-blue-500', i < currentStep);
      }
    }

    async function fetchOrders() {
      try {
        const startDate = formatDateForAPI(document.getElementById('startDate').value, false);
        const endDate = formatDateForAPI(document.getElementById('endDate').value, true);
        const sessionIndex = document.getElementById('sessionIndex').value;
        
        const url = `https://tomato.tpos.vn/odata/SaleOnline_Order/ODataService.GetView?$top=50&$orderby=DateCreated desc&$filter=(DateCreated ge ${startDate} and DateCreated le ${endDate} and SessionIndex eq ${sessionIndex})&$count=true`;
        
        const response = await fetch(url, { headers: getHeaders() });
        const data = await response.json();
        
        orders = data.value || [];
        displayOrders();
        showMessage('success', `T√¨m th·∫•y ${data['@odata.count']} ƒë∆°n h√†ng`);
        goToStep(2);
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    function displayOrders() {
      document.getElementById('orderCount').textContent = orders.length;
      const container = document.getElementById('ordersList');
      container.innerHTML = orders.map(order => `
        <div onclick="selectOrder('${order.Id}')" id="order-${order.Id}"
             class="order-item p-4 border-2 rounded-lg cursor-pointer transition border-gray-200 hover:border-blue-300">
          <div class="flex justify-between">
            <div>
              <p class="font-bold">#${order.Code}</p>
              <p class="text-sm text-gray-600">${order.Name}</p>
            </div>
            <div class="text-right">
              <p class="font-bold text-blue-600">${order.TotalAmount?.toLocaleString('vi-VN')}‚Ç´</p>
              <p class="text-sm">SL: ${order.TotalQuantity}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    function selectOrder(orderId) {
      selectedOrder = orders.find(o => o.Id === orderId);
      document.querySelectorAll('.order-item').forEach(item => {
        item.classList.remove('border-blue-500', 'bg-blue-50');
      });
      document.getElementById(`order-${orderId}`).classList.add('border-blue-500', 'bg-blue-50');
    }

    async function fetchOrderDetail() {
      if (!selectedOrder) {
        showMessage('error', 'Vui l√≤ng ch·ªçn ƒë∆°n h√†ng');
        return;
      }
      try {
        const response = await fetch(
          `https://tomato.tpos.vn/odata/SaleOnline_Order(${selectedOrder.Id})?$expand=Details,Partner,User,CRMTeam`,
          { headers: getHeaders() }
        );
        orderDetail = await response.json();
        document.getElementById('orderCode').textContent = orderDetail.Code;
        document.getElementById('customerName').textContent = orderDetail.Name;
        showMessage('success', 'ƒê√£ t·∫£i chi ti·∫øt ƒë∆°n h√†ng');
        goToStep(4);
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    async function searchProducts() {
      const searchTerm = document.getElementById('productSearch').value.trim();
      if (!searchTerm) {
        showMessage('error', 'Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m');
        return;
      }
      try {
        const response = await fetch(
          `https://tomato.tpos.vn/odata/Product/OdataService.GetViewV2?Active=true&Name=${encodeURIComponent(searchTerm)}`,
          { headers: getHeaders() }
        );
        const data = await response.json();
        products = data.value || [];
        displayProducts();
        showMessage('success', `T√¨m th·∫•y ${data['@odata.count']} s·∫£n ph·∫©m`);
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    function displayProducts() {
      document.getElementById('productsList').innerHTML = products.map(product => `
        <div class="p-3 border rounded-lg flex justify-between items-center hover:border-blue-300">
          <div>
            <p class="font-semibold">${product.NameGet}</p>
            <p class="text-sm text-gray-600">${product.ListPrice?.toLocaleString('vi-VN')}‚Ç´</p>
          </div>
          <button onclick='addProductToList(${JSON.stringify(product).replace(/'/g, "&apos;")})' 
                  class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
            Th√™m
          </button>
        </div>
      `).join('');
    }

    function addProductToList(product) {
      if (selectedProducts.find(p => p.ProductId === product.Id)) {
        showMessage('error', 'S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m');
        return;
      }
      selectedProducts.push({
        ProductId: product.Id,
        ProductName: product.Name,
        ProductNameGet: product.NameGet,
        UOMId: 1,
        UOMName: product.UOMName || "C√°i",
        Quantity: 1,
        Price: product.ListPrice || 0,
        Factor: 1,
        ProductWeight: 0
      });
      displaySelectedProducts();
      showMessage('success', 'ƒê√£ th√™m s·∫£n ph·∫©m');
    }

    function displaySelectedProducts() {
      document.getElementById('selectedCount').textContent = selectedProducts.length;
      document.getElementById('newProductCount').textContent = selectedProducts.length;
      document.getElementById('selectedProductsList').innerHTML = selectedProducts.map((product, index) => `
        <div class="p-4 border rounded-lg flex justify-between items-center mb-3">
          <div class="flex-1">
            <p class="font-semibold">${product.ProductNameGet}</p>
            <p class="text-sm text-gray-600">${product.Price?.toLocaleString('vi-VN')}‚Ç´</p>
          </div>
          <div class="flex items-center gap-3">
            <input type="number" min="1" value="${product.Quantity}" 
                   onchange="updateQuantity(${index}, this.value)"
                   class="w-20 px-3 py-2 border rounded-lg text-center">
            <button onclick="removeProduct(${index})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
              X√≥a
            </button>
          </div>
        </div>
      `).join('');
    }

    function updateQuantity(index, quantity) {
      selectedProducts[index].Quantity = parseInt(quantity) || 1;
    }

    function removeProduct(index) {
      selectedProducts.splice(index, 1);
      displaySelectedProducts();
    }

    async function updateOrder() {
      if (!orderDetail || selectedProducts.length === 0) {
        showMessage('error', 'Ch∆∞a ƒë·ªß d·ªØ li·ªáu');
        return;
      }
      try {
        generateNewGUID();
        const updatedOrder = { ...orderDetail, Details: selectedProducts };
        const response = await fetch(
          `https://tomato.tpos.vn/odata/SaleOnline_Order(${orderDetail.Id})`,
          { method: 'PUT', headers: getHeaders(), body: JSON.stringify(updatedOrder) }
        );
        if (response.ok) {
          showMessage('success', 'C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng!');
        } else {
          showMessage('error', 'L·ªói khi c·∫≠p nh·∫≠t');
        }
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    // ========== FACEBOOK PAGES MODULE ==========
    async function addFacebookPage() {
      const pageName = document.getElementById('fbPageName').value.trim();
      const pageId = document.getElementById('fbPageId').value.trim();

      if (!pageName || !pageId) {
        showMessage('error', 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
        return;
      }

      try {
        // In real implementation, you would save this to a database
        // For now, we'll store in localStorage
        const pages = JSON.parse(localStorage.getItem('facebookPages') || '[]');
        
        if (pages.find(p => p.pageId === pageId)) {
          showMessage('error', 'Page ID ƒë√£ t·ªìn t·∫°i');
          return;
        }

        pages.push({
          id: generateGUID(),
          pageName,
          pageId,
          crmTeamId: null,
          crmTeamName: null,
          createdAt: new Date().toISOString()
        });

        localStorage.setItem('facebookPages', JSON.stringify(pages));
        
        document.getElementById('fbPageName').value = '';
        document.getElementById('fbPageId').value = '';
        
        showMessage('success', 'ƒê√£ th√™m Facebook Page');
        loadFacebookPages();
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    function loadFacebookPages() {
      try {
        facebookPages = JSON.parse(localStorage.getItem('facebookPages') || '[]');
        displayFacebookPages();
      } catch (error) {
        showMessage('error', 'L·ªói khi t·∫£i pages: ' + error.message);
      }
    }

    function displayFacebookPages() {
      const container = document.getElementById('fbPagesList');
      
      if (facebookPages.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ Facebook pages n√†o. Th√™m page m·ªõi ·ªü tr√™n.</p>';
        return;
      }

      container.innerHTML = facebookPages.map(page => `
        <div class="p-4 border rounded-lg">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="font-semibold text-base">${page.pageName}</div>
              <div class="text-sm text-gray-600">Page ID: ${page.pageId}</div>
              ${page.crmTeamId ? `
                <div class="text-sm mt-1">
                  <span class="text-gray-600">CRM Team:</span> 
                  <span class="font-medium text-green-600">${page.crmTeamName} (${page.crmTeamId})</span>
                </div>
              ` : `
                <div class="text-sm text-orange-600 mt-1">Ch∆∞a c·∫•u h√¨nh CRM Team</div>
              `}
            </div>
            <button onclick="editPageCRM('${page.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
              S·ª≠a CRM
            </button>
          </div>
        </div>
      `).join('');
    }

    function editPageCRM(pageId) {
      selectedPageForConfig = facebookPages.find(p => p.id === pageId);
      if (!selectedPageForConfig) return;

      document.getElementById('configPageName').textContent = selectedPageForConfig.pageName;
      document.getElementById('configPageId').textContent = selectedPageForConfig.pageId;
      
      if (selectedPageForConfig.crmTeamId) {
        document.getElementById('manualCrmTeamId').value = selectedPageForConfig.crmTeamId;
        document.getElementById('manualCrmTeamName').value = selectedPageForConfig.crmTeamName || '';
      } else {
        document.getElementById('manualCrmTeamId').value = '';
        document.getElementById('manualCrmTeamName').value = '';
      }

      document.getElementById('crmConfigSection').classList.remove('hidden');
      document.getElementById('crmConfigSection').scrollIntoView({ behavior: 'smooth' });
    }

    async function loadCRMTeams() {
      try {
        showMessage('info', 'ƒêang t·∫£i CRM Teams t·ª´ TPOS...');
        
        const response = await fetch(
          'https://tomato.tpos.vn/odata/CRMTeam/ODataService.GetAllFacebook?$expand=Childs',
          { headers: getHeaders() }
        );

        if (!response.ok) throw new Error('L·ªói khi t·∫£i CRM Teams');

        const data = await response.json();
        crmTeams = flattenCRMTeams(data.value || []);
        
        const select = document.getElementById('crmTeamSelect');
        select.innerHTML = '<option value="">-- Ch·ªçn CRM Team --</option>';
        
        crmTeams.forEach(team => {
          select.innerHTML += `<option value="${team.id}::${team.name}">${team.name}</option>`;
        });

        showMessage('success', `ƒê√£ t·∫£i ${crmTeams.length} CRM teams`);
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    function flattenCRMTeams(teams) {
      const flattened = [];
      teams.forEach(parent => {
        if (parent.Childs && Array.isArray(parent.Childs)) {
          parent.Childs.forEach(child => {
            flattened.push({ id: child.Id.toString(), name: child.Name });
          });
        }
        flattened.push({ id: parent.Id.toString(), name: parent.Name });
      });
      return flattened;
    }

    document.getElementById('crmTeamSelect')?.addEventListener('change', (e) => {
      const value = e.target.value;
      if (!value) return;
      
      const [id, name] = value.split('::');
      document.getElementById('manualCrmTeamId').value = id;
      document.getElementById('manualCrmTeamName').value = name;
    });

    function saveCRMConfig() {
      if (!selectedPageForConfig) return;

      const crmTeamId = document.getElementById('manualCrmTeamId').value.trim();
      const crmTeamName = document.getElementById('manualCrmTeamName').value.trim();

      if (!crmTeamId || !crmTeamName) {
        showMessage('error', 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß CRM Team ID v√† Team Name');
        return;
      }

      try {
        const pages = JSON.parse(localStorage.getItem('facebookPages') || '[]');
        const pageIndex = pages.findIndex(p => p.id === selectedPageForConfig.id);
        
        if (pageIndex !== -1) {
          pages[pageIndex].crmTeamId = crmTeamId;
          pages[pageIndex].crmTeamName = crmTeamName;
          localStorage.setItem('facebookPages', JSON.stringify(pages));
        }

        showMessage('success', 'ƒê√£ l∆∞u CRM Team ID');
        cancelCRMConfig();
        loadFacebookPages();
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    function cancelCRMConfig() {
      selectedPageForConfig = null;
      document.getElementById('crmConfigSection').classList.add('hidden');
      document.getElementById('manualCrmTeamId').value = '';
      document.getElementById('manualCrmTeamName').value = '';
      document.getElementById('crmTeamSelect').value = '';
    }

    // ========== FACEBOOK COMMENTS MODULE ==========
    function loadCommentsPageList() {
      facebookPages = JSON.parse(localStorage.getItem('facebookPages') || '[]');
      const select = document.getElementById('commentsPageSelect');
      
      select.innerHTML = '<option value="">-- Ch·ªçn Page --</option>';
      facebookPages.forEach(page => {
        select.innerHTML += `<option value="${page.id}">${page.pageName}</option>`;
      });
    }

    function onCommentsPageChange() {
      const pageId = document.getElementById('commentsPageSelect').value;
      selectedCommentsPage = facebookPages.find(p => p.id === pageId);
    }

    async function loadVideos() {
      if (!selectedCommentsPage) {
        showMessage('error', 'Vui l√≤ng ch·ªçn Facebook Page');
        return;
      }

      const limit = document.getElementById('videoLimit').value;

      try {
        showMessage('info', 'ƒêang t·∫£i videos...');
        
        // This would call your Supabase Edge Function or TPOS API
        // For demo, we'll simulate the response
        const response = await fetch(
          `https://tomato.tpos.vn/api/facebook-graph/livevideo?pageid=${selectedCommentsPage.pageId}&limit=${limit}`,
          { headers: getHeaders() }
        );

        if (!response.ok) throw new Error('L·ªói khi t·∫£i videos');

        videos = await response.json();
        displayVideos();
        showMessage('success', `ƒê√£ t·∫£i ${videos.length} videos`);
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    function displayVideos() {
      document.getElementById('videoCount').textContent = videos.length;
      document.getElementById('videosSection').classList.remove('hidden');
      
      const container = document.getElementById('videosList');
      container.innerHTML = videos.map(video => `
        <div class="border rounded-lg overflow-hidden cursor-pointer hover:shadow-lg transition" onclick="selectVideo('${video.objectId}')">
          <div class="relative aspect-video bg-gray-200">
            ${video.thumbnail?.url ? 
              `<img src="${video.thumbnail.url}" alt="${video.title}" class="w-full h-full object-cover">` :
              '<div class="w-full h-full flex items-center justify-center text-gray-400">üìπ No Thumbnail</div>'
            }
            ${video.statusLive === 1 ? '<div class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">üî¥ LIVE</div>' : ''}
          </div>
          <div class="p-4">
            <h4 class="font-semibold text-sm line-clamp-2 mb-2">${video.title}</h4>
            <div class="flex gap-4 text-xs text-gray-600">
              <span>üí¨ ${video.countComment || 0}</span>
              <span>‚ù§Ô∏è ${video.countReaction || 0}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function selectVideo(videoId) {
      selectedVideo = videos.find(v => v.objectId === videoId);
      if (!selectedVideo) return;

      document.getElementById('selectedVideoTitle').textContent = selectedVideo.title;
      document.getElementById('commentsSection').classList.remove('hidden');
      document.getElementById('videosSection').classList.add('hidden');

      await loadComments();
    }

    async function loadComments() {
      if (!selectedVideo || !selectedCommentsPage) return;

      try {
        showMessage('info', 'ƒêang t·∫£i comments...');
        
        const response = await fetch(
          `https://tomato.tpos.vn/api/facebook-graph/comment?pageid=${selectedCommentsPage.pageId}&postId=${selectedVideo.objectId}&limit=100&order=reverse_chronological`,
          { headers: getHeaders() }
        );

        if (!response.ok) throw new Error('L·ªói khi t·∫£i comments');

        const data = await response.json();
        allComments = data.data || [];
        comments = [...allComments];
        
        displayComments();
        showMessage('success', `ƒê√£ t·∫£i ${comments.length} comments`);
      } catch (error) {
        showMessage('error', 'L·ªói: ' + error.message);
      }
    }

    function displayComments() {
      const container = document.getElementById('commentsList');
      
      if (comments.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ comments</p>';
        return;
      }

      container.innerHTML = comments.map(comment => `
        <div class="p-4 border rounded-lg">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold">
              ${comment.from?.name?.charAt(0) || '?'}
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-semibold text-sm">${comment.from?.name || 'Unknown'}</span>
                <span class="text-xs text-gray-500">${new Date(comment.created_time).toLocaleString('vi-VN')}</span>
              </div>
              <p class="text-sm whitespace-pre-wrap">${comment.message || ''}</p>
              ${comment.like_count ? `<div class="mt-2 text-xs text-gray-500">‚ù§Ô∏è ${comment.like_count}</div>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function filterComments() {
      const query = document.getElementById('commentSearch').value.toLowerCase();
      
      if (!query) {
        comments = [...allComments];
      } else {
        comments = allComments.filter(c => 
          c.message?.toLowerCase().includes(query) ||
          c.from?.name?.toLowerCase().includes(query)
        );
      }
      
      displayComments();
    }

    function refreshComments() {
      loadComments();
    }

    function backToVideos() {
      document.getElementById('commentsSection').classList.add('hidden');
      document.getElementById('videosSection').classList.remove('hidden');
      selectedVideo = null;
      comments = [];
      allComments = [];
    }

    // ========== HELPERS ==========
    function showMessage(type, text) {
      const alert = document.getElementById('messageAlert');
      alert.className = `mb-6 p-4 rounded-lg flex items-center gap-3 fade-in ${
        type === 'success' ? 'bg-green-100 text-green-800' : 
        type === 'info' ? 'bg-blue-100 text-blue-800' :
        'bg-red-100 text-red-800'
      }`;
      alert.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'info' ? '‚Ñπ' : '‚ö†'}</span><span>${text}</span>`;
      alert.classList.remove('hidden');
      setTimeout(() => alert.classList.add('hidden'), 5000);
    }

    // Initialize
    loadDefaultHeaders();
    updateStepUI();
  </script>
</body>
</html>
