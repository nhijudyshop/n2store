<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Import Excel - TPOS</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 1200px;
        width: 100%;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
      }
      .header p {
        color: #666;
        font-size: 14px;
      }

      .upload-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .upload-box {
        border: 2px dashed #667eea;
        border-radius: 15px;
        padding: 30px 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #f8f9ff;
      }

      .upload-box:hover,
      .upload-box.dragover {
        border-color: #764ba2;
        background: #e8ebff;
        transform: scale(1.02);
      }

      .upload-box.selected {
        border-color: #28a745;
        background: #d4edda;
      }

      .upload-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }
      .upload-text {
        color: #333;
        font-size: 16px;
        margin-bottom: 5px;
        font-weight: 600;
      }
      .upload-hint {
        color: #999;
        font-size: 12px;
      }

      input[type="file"] {
        display: none;
      }

      .file-preview {
        margin-top: 10px;
        padding: 10px;
        background: white;
        border-radius: 8px;
        font-size: 13px;
        color: #2e7d32;
        display: none;
      }

      .file-preview.show {
        display: block;
      }

      .image-preview {
        margin-top: 10px;
        display: none;
      }

      .image-preview.show {
        display: block;
      }

      .image-preview img {
        max-width: 100%;
        max-height: 150px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .expand-section {
        margin-top: 25px;
        padding: 20px;
        background: #f8f9ff;
        border-radius: 12px;
        border: 2px solid #667eea;
      }

      .expand-section h3 {
        color: #333;
        font-size: 16px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .expand-section textarea {
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        resize: vertical;
        transition: border-color 0.3s ease;
      }

      .expand-section textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .expand-hint {
        margin-top: 8px;
        font-size: 12px;
        color: #666;
        line-height: 1.5;
      }

      .expand-presets {
        margin-top: 12px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .preset-btn {
        padding: 6px 12px;
        background: white;
        border: 2px solid #667eea;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #667eea;
        font-weight: 600;
      }

      .preset-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
      }

      .btn-process {
        width: 100%;
        padding: 18px;
        margin-top: 20px;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      .btn-process:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      .btn-process:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .progress {
        margin-top: 20px;
        display: none;
      }

      .progress.show {
        display: block;
      }

      .progress-step {
        padding: 12px 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        background: #f5f5f5;
        border-left: 4px solid #ddd;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
        cursor: default;
      }

      .progress-step.active {
        background: #e3f2fd;
        border-left-color: #2196f3;
      }

      .progress-step.success {
        background: #e8f5e9;
        border-left-color: #4caf50;
      }

      .progress-step.error {
        background: #ffebee;
        border-left-color: #f44336;
      }

      .step-icon {
        font-size: 20px;
        min-width: 24px;
        text-align: center;
      }
      .step-text {
        flex: 1;
        font-size: 14px;
      }

      .loader {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #2196f3;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .edit-section {
        margin-top: 30px;
        display: none;
        background: #f8f9ff;
        border-radius: 12px;
        padding: 20px;
        border: 2px solid #667eea;
      }

      .edit-section.show {
        display: block;
      }

      .edit-section h2 {
        color: #333;
        font-size: 20px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .toggle-fields-btn {
        padding: 8px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 15px;
      }

      .toggle-fields-btn:hover {
        background: #5568d3;
        transform: translateY(-1px);
      }

      .other-fields {
        display: none;
      }

      .other-fields.show {
        display: contents;
      }

      .search-box {
        margin-bottom: 15px;
        position: relative;
        display: none;
      }

      .search-box.show {
        display: block;
      }

      .search-box input {
        width: 100%;
        padding: 12px 45px 12px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .search-box input:focus {
        outline: none;
        border-color: #667eea;
      }

      .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        font-size: 18px;
        pointer-events: none;
      }

      .search-stats {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .highlight {
        background: yellow;
        font-weight: 600;
      }

      .special-edit-btn {
        padding: 6px 12px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-left: 10px;
      }

      .special-edit-btn:hover {
        background: #5568d3;
        transform: translateY(-1px);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #667eea;
      }

      .modal-header h3 {
        color: #333;
        font-size: 20px;
        margin: 0;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #999;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
      }

      .modal-close:hover {
        color: #333;
      }

      .size-selector {
        margin-bottom: 20px;
      }

      .size-selector label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
      }

      .size-selector select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
      }

      .size-selector select:focus {
        outline: none;
        border-color: #667eea;
      }

      .selected-sizes {
        margin-top: 15px;
      }

      .size-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #e8f5e9;
        border: 2px solid #4caf50;
        padding: 8px 12px;
        border-radius: 8px;
        margin: 5px;
        font-size: 14px;
      }

      .size-chip-remove {
        background: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        font-size: 12px;
        line-height: 1;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .modal-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .modal-btn-save {
        background: #4caf50;
        color: white;
      }

      .modal-btn-save:hover {
        background: #45a049;
      }

      .modal-btn-cancel {
        background: #f5f5f5;
        color: #333;
      }

      .modal-btn-cancel:hover {
        background: #e0e0e0;
      }

      .attribute-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
      }

      .attribute-tab {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
      }

      .attribute-tab:hover {
        color: #667eea;
      }

      .attribute-tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .edit-table {
        width: 100%;
        max-height: 500px;
        overflow: auto;
        background: white;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .edit-table table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      .edit-table th {
        background: #667eea;
        color: white;
        padding: 12px;
        text-align: left;
        position: sticky;
        top: 0;
        font-weight: 600;
        font-size: 14px;
      }

      .edit-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        font-size: 13px;
      }

      .edit-table tr {
        display: table;
        width: 100%;
        table-layout: fixed;
      }

      .edit-table tbody {
        display: block;
      }

      .edit-table thead {
        display: table;
        width: 100%;
        table-layout: fixed;
      }

      .edit-table tr:hover {
        background: #f5f5f5;
      }

      .edit-table input[type="text"],
      .edit-table input[type="number"],
      .edit-table textarea {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.2s ease;
      }

      .edit-table textarea {
        min-height: 80px;
        resize: vertical;
      }

      .edit-table input:focus,
      .edit-table textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .field-key {
        font-weight: 600;
        color: #555;
        width: 30%;
        vertical-align: top;
        padding-top: 15px;
      }

      .edit-table td:last-child {
        width: 70%;
      }

      .btn-continue {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        color: white;
        transition: all 0.3s ease;
      }

      .btn-continue:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
      }

      .result {
        margin-top: 30px;
        display: none;
      }

      .result.show {
        display: block;
      }

      .result h2 {
        color: #333;
        font-size: 20px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
      }

      .json-container {
        background: #f5f5f5;
        border-radius: 10px;
        padding: 20px;
        max-height: 400px;
        overflow: auto;
        font-family: "Courier New", monospace;
        font-size: 13px;
        line-height: 1.6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìä Import Excel & Update Product</h1>
        <p>
          Ch·ªçn file Excel v√† h√¨nh ·∫£nh, sau ƒë√≥ b·∫•m "X·ª≠ L√Ω" ƒë·ªÉ c·∫≠p nh·∫≠t s·∫£n ph·∫©m
        </p>
      </div>

      <div class="upload-section">
        <div class="upload-box" id="excelBox">
          <div class="upload-icon">üìÅ</div>
          <div class="upload-text">File Excel</div>
          <div class="upload-hint">Click ƒë·ªÉ ch·ªçn .xlsx, .xls</div>
          <div class="file-preview" id="excelPreview"></div>
        </div>

        <div class="upload-box" id="imageBox">
          <div class="upload-icon">üñºÔ∏è</div>
          <div class="upload-text">H√¨nh ·∫¢nh</div>
          <div class="upload-hint">Click ƒë·ªÉ ch·ªçn ·∫£nh</div>
          <div class="file-preview" id="imageFileName"></div>
          <div class="image-preview" id="imagePreview">
            <img id="previewImg" src="" alt="Preview" />
          </div>
        </div>
      </div>

      <input type="file" id="excelInput" accept=".xlsx,.xls" />
      <input type="file" id="imageInput" accept="image/*" />

      <div class="expand-section">
        <h3>‚öôÔ∏è Expand Parameters (OData)</h3>
        <textarea id="expandInput" placeholder="Nh·∫≠p c√°c tr∆∞·ªùng expand...">
UOM,UOMCateg,Categ,UOMPO,POSCateg,Taxes,SupplierTaxes,Product_Teams,Images,UOMView,Distributor,Importer,Producer,OriginCountry,ProductVariants($expand=UOM,Categ,UOMPO,POSCateg,AttributeValues),AttributeLines,UOMLines($expand=UOM),ComboProducts,ProductSupplierInfos</textarea
        >
        <div class="expand-hint">
          üí° C√°c tr∆∞·ªùng ph·ªï bi·∫øn: UOM, Categ, UOMPO, POSCateg, Taxes,
          ProductVariants, AttributeLines, Images, UOMLines, ComboProducts
        </div>
        <div class="expand-presets">
          <button class="preset-btn" onclick="setExpandPreset('basic')">
            üîπ C∆° b·∫£n
          </button>
          <button class="preset-btn" onclick="setExpandPreset('full')">
            üî∏ ƒê·∫ßy ƒë·ªß
          </button>
          <button class="preset-btn" onclick="setExpandPreset('minimal')">
            ‚ö™ T·ªëi thi·ªÉu
          </button>
          <button class="preset-btn" onclick="clearExpand()">üóëÔ∏è X√≥a</button>
        </div>
      </div>

      <button class="btn-process" id="processBtn">
        üöÄ B∆∞·ªõc 1-3: L·∫•y D·ªØ Li·ªáu
      </button>

      <div class="progress" id="progress">
        <div class="progress-step" id="step1">
          <span class="step-icon">1Ô∏è‚É£</span>
          <span class="step-text">Upload Excel</span>
        </div>
        <div class="progress-step" id="step2">
          <span class="step-icon">2Ô∏è‚É£</span>
          <span class="step-text">L·∫•y d·ªØ li·ªáu s·∫£n ph·∫©m</span>
        </div>
        <div class="progress-step" id="step3">
          <span class="step-icon">3Ô∏è‚É£</span>
          <span class="step-text">L·∫•y chi ti·∫øt s·∫£n ph·∫©m</span>
        </div>
      </div>

      <div class="edit-section" id="editSection">
        <h2>‚úèÔ∏è Ch·ªânh S·ª≠a D·ªØ Li·ªáu S·∫£n Ph·∫©m</h2>
        <!-- <button
          class="toggle-fields-btn"
          id="toggleFieldsBtn"
          onclick="toggleOtherFields()"
        >
          üëÅÔ∏è Hi·ªán C√°c Tr∆∞·ªùng Kh√°c
        </button> -->
        <div class="search-box" id="searchBox">
          <input
            type="text"
            id="searchInput"
            placeholder="üîç T√¨m ki·∫øm tr∆∞·ªùng (v√≠ d·ª•: Name, Price, AttributeLines...)"
          />
          <span class="search-icon">üîç</span>
          <div class="search-stats" id="searchStats"></div>
        </div>
        <div class="edit-table" id="editTable"></div>
        <button class="btn-continue" id="continueBtn">
          ‚ñ∂Ô∏è Ti·∫øp T·ª•c: X·ª≠ L√Ω ·∫¢nh & Upload
        </button>
      </div>

      <div class="result" id="result">
        <h2>‚úÖ K·∫øt Qu·∫£ Cu·ªëi C√πng</h2>
        <div class="json-container" id="resultContainer"></div>
      </div>

      <!-- AttributeLines Modal -->
      <div class="modal" id="attributeModal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>‚úèÔ∏è Ch·ªânh S·ª≠a Thu·ªôc T√≠nh</h3>
            <button class="modal-close" onclick="closeAttributeModal()">
              √ó
            </button>
          </div>

          <div class="attribute-tabs">
            <button
              class="attribute-tab active"
              onclick="switchTab('sizeText')"
            >
              üìè Size Ch·ªØ
            </button>
            <button class="attribute-tab" onclick="switchTab('color')">
              üé® M√†u
            </button>
            <button class="attribute-tab" onclick="switchTab('sizeNumber')">
              üî¢ Size S·ªë
            </button>
          </div>

          <!-- Size Ch·ªØ Tab -->
          <div class="tab-content active" id="tab-sizeText">
            <div class="size-selector">
              <label>Ch·ªçn Size Ch·ªØ:</label>
              <select id="sizeTextSelect">
                <option value="">-- Ch·ªçn size --</option>
              </select>
            </div>
            <div class="selected-sizes">
              <strong>Sizes ƒë√£ ch·ªçn:</strong>
              <div id="sizeTextChips"></div>
            </div>
          </div>

          <!-- M√†u Tab -->
          <div class="tab-content" id="tab-color">
            <div class="size-selector">
              <label>Ch·ªçn M√†u:</label>
              <select id="colorSelect">
                <option value="">-- Ch·ªçn m√†u --</option>
              </select>
            </div>
            <div class="selected-sizes">
              <strong>M√†u ƒë√£ ch·ªçn:</strong>
              <div id="colorChips"></div>
            </div>
          </div>

          <!-- Size S·ªë Tab -->
          <div class="tab-content" id="tab-sizeNumber">
            <div class="size-selector">
              <label>Ch·ªçn Size S·ªë:</label>
              <select id="sizeNumberSelect">
                <option value="">-- Ch·ªçn size --</option>
              </select>
            </div>
            <div class="selected-sizes">
              <strong>Sizes ƒë√£ ch·ªçn:</strong>
              <div id="sizeNumberChips"></div>
            </div>
          </div>

          <div class="modal-actions">
            <button
              class="modal-btn modal-btn-cancel"
              onclick="closeAttributeModal()"
            >
              H·ªßy
            </button>
            <button
              class="modal-btn modal-btn-save"
              onclick="saveAttributeLines()"
            >
              L∆∞u
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "https://tomato.tpos.vn/odata/ProductTemplate";
      const AUTH_TOKEN =
        "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJDbGllbnRJZCI6InRtdFdlYkFwcCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiZmMwZjQ0MzktOWNmNi00ZDg4LWE4YzctNzU5Y2E4Mjk1MTQyIiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6Im52MjAiLCJEaXNwbGF5TmFtZSI6IlTDuiIsIkF2YXRhclVybCI6IiIsIlNlY3VyaXR5U3RhbXAiOiI2ODgxNTgxYi1jZTc1LTRjMWQtYmM4ZC0yNjEwMzAzYzAzN2EiLCJDb21wYW55SWQiOiIxIiwiVGVuYW50SWQiOiJ0b21hdG8udHBvcy52biIsIlJvbGVJZHMiOiI0MmZmYzk5Yi1lNGY2LTQwMDAtYjcyOS1hZTNmMDAyOGEyODksNmExZDAwMDAtNWQxYS0wMDE1LTBlNmMtMDhkYzM3OTUzMmU5LDc2MzlhMDQ4LTdjZmUtNDBiNS1hNDFkLWFlM2YwMDNiODlkZiw4YmM4ZjQ1YS05MWY4LTQ5NzMtYjE4Mi1hZTNmMDAzYWI4NTUsYTljMjAwMDAtNWRiNi0wMDE1LTQ1YWItMDhkYWIxYmZlMjIyIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjpbIlF14bqjbiBMw70gTWFpIiwiQ8OSSSIsIkNTS0ggLSBMw6BpIiwiS2hvIFBoxrDhu5tjLSBLaeG7h3QiLCJRdeG6o24gTMO9IEtobyAtIEJvIl0sImp0aSI6IjY2MzA3MjlkLWJlM2MtNDcwOS1iOWJjLWM2YjNmNzc2ZGYyZSIsImlhdCI6IjE3NTkzODc4NjciLCJuYmYiOjE3NTkzODc4NjcsImV4cCI6MTc2MDY4Mzg2NywiaXNzIjoiaHR0cHM6Ly90b21hdG8udHBvcy52biIsImF1ZCI6Imh0dHBzOi8vdG9tYXRvLnRwb3Mudm4saHR0cHM6Ly90cG9zLnZuIn0.38Srsqs7uhUknlXr08NgtH34ZCBg9TuZ-geO2IrdYcU";

      const $ = (id) => document.getElementById(id);
      const show = (el, visible = true) => el.classList.toggle("show", visible);

      let excelFile = null;
      let imageFile = null;
      let productDetail = null;
      let currentAttributeLines = [];

      // Generate random request ID
      const generateRandomId = () => {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          },
        );
      };

      // Function to generate headers with fresh request ID for each call
      const getHeaders = () => ({
        accept: "application/json, text/plain, */*",
        "accept-encoding": "gzip, deflate, br",
        "accept-language": "vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7",
        authorization: AUTH_TOKEN,
        "content-type": "application/json;charset=UTF-8",
        origin: "https://tomato.tpos.vn",
        referer: "https://tomato.tpos.vn/",
        "sec-ch-ua":
          '"Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24"',
        "sec-ch-ua-mobile": "?0",
        "sec-ch-ua-platform": '"Windows"',
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors",
        "sec-fetch-site": "same-origin",
        tposappversion: "5.9.10.1",
        "user-agent":
          "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
        "x-request-id": generateRandomId(), // Fresh ID for each request
      });

      // Available attributes data
      const availableAttributes = {
        sizeText: {
          id: 1,
          name: "Size Ch·ªØ",
          code: "SZCh",
          values: [
            { Id: 31, Name: "XXL", Code: "xxl", Sequence: null },
            { Id: 32, Name: "XXXL", Code: "xxxl", Sequence: null },
            { Id: 5, Name: "Free Size", Code: "FS", Sequence: 0 },
            { Id: 1, Name: "S", Code: "S", Sequence: 1 },
            { Id: 2, Name: "M", Code: "M", Sequence: 2 },
            { Id: 3, Name: "L", Code: "L", Sequence: 3 },
            { Id: 4, Name: "XL", Code: "XL", Sequence: 4 },
          ],
        },
        color: {
          id: 3,
          name: "M√†u",
          code: "Mau",
          values: [
            { Id: 6, Name: "Tr·∫Øng", Code: "trang", Sequence: null },
            { Id: 7, Name: "ƒêen", Code: "den", Sequence: null },
            { Id: 8, Name: "ƒê·ªè", Code: "do", Sequence: null },
            { Id: 9, Name: "V√†ng", Code: "vang", Sequence: null },
            { Id: 10, Name: "Cam", Code: "cam", Sequence: null },
            { Id: 11, Name: "X√°m", Code: "xam", Sequence: null },
            { Id: 12, Name: "H·ªìng", Code: "hong", Sequence: null },
            { Id: 14, Name: "Nude", Code: "nude", Sequence: null },
            { Id: 15, Name: "N√¢u", Code: "nau", Sequence: null },
            { Id: 16, Name: "R√™u", Code: "reu", Sequence: null },
            { Id: 17, Name: "Xanh", Code: "xanh", Sequence: null },
            { Id: 25, Name: "B·∫°c", Code: "bac", Sequence: null },
            { Id: 26, Name: "T√≠m", Code: "tim", Sequence: null },
            { Id: 27, Name: "Xanh Min", Code: "xanhmin", Sequence: null },
            { Id: 28, Name: "Tr·∫Øng Kem", Code: "trangkem", Sequence: null },
            { Id: 29, Name: "Xanh L√°", Code: "xanhla", Sequence: null },
            { Id: 38, Name: "C·ªï V·ªãt", Code: "co vit", Sequence: null },
            { Id: 40, Name: "Xanh ƒê·∫≠u", Code: "xanh dau", Sequence: null },
            { Id: 42, Name: "T√≠m M√¥n", Code: "timmon", Sequence: null },
            { Id: 43, Name: "Mu·ªëi Ti√™u", Code: "muoitieu", Sequence: null },
            { Id: 45, Name: "Kem", Code: "kem", Sequence: null },
            { Id: 47, Name: "H·ªìng ƒê·∫≠m", Code: "hongdam", Sequence: null },
            { Id: 49, Name: "Ghi", Code: "ghi", Sequence: null },
            { Id: 50, Name: "Xanh M·∫°", Code: "xanhma", Sequence: null },
            { Id: 51, Name: "V√†ng ƒê·ªìng", Code: "vangdong", Sequence: null },
            { Id: 52, Name: "Xanh B∆°", Code: "xanhbo", Sequence: null },
            { Id: 53, Name: "Xanh ƒêen", Code: "xanhden", Sequence: null },
            { Id: 54, Name: "Xanh CoBan", Code: "xanhcoban", Sequence: null },
            { Id: 55, Name: "X√°m ƒê·∫≠m", Code: "xamdam", Sequence: null },
            { Id: 56, Name: "X√°m Nh·∫°t", Code: "xamnhat", Sequence: null },
            { Id: 57, Name: "Xanh D∆∞∆°ng", Code: "xanhduong", Sequence: null },
            { Id: 58, Name: "Cam S·ªØa", Code: "camsua", Sequence: null },
            { Id: 59, Name: "H·ªìng Nh·∫°t", Code: "hongnhat", Sequence: null },
            { Id: 60, Name: "ƒê·∫≠m", Code: "dam", Sequence: null },
            { Id: 61, Name: "Nh·∫°t", Code: "nhat", Sequence: null },
            { Id: 62, Name: "X√°m Kh√≥i", Code: "xamkhoi", Sequence: null },
            { Id: 63, Name: "X√°m Chu·ªôt", Code: "xamchuot", Sequence: null },
            { Id: 64, Name: "X√°m ƒêen", Code: "xamden", Sequence: null },
            { Id: 65, Name: "X√°m Tr·∫Øng", Code: "xamtrang", Sequence: null },
            { Id: 66, Name: "Xanh ƒê·∫≠m", Code: "xanhdam", Sequence: null },
            { Id: 67, Name: "S·ªçc ƒêen", Code: "socden", Sequence: null },
            { Id: 68, Name: "S·ªçc Tr·∫Øng", Code: "soctrang", Sequence: null },
            { Id: 69, Name: "S·ªçc X√°m", Code: "socxam", Sequence: null },
            { Id: 70, Name: "Jean Tr·∫Øng", Code: "jeantrang", Sequence: null },
            { Id: 71, Name: "Jean Xanh", Code: "jeanxanh", Sequence: null },
            { Id: 72, Name: "Cam ƒê·∫•t", Code: "camdat", Sequence: null },
            { Id: 73, Name: "N√¢u ƒê·∫≠m", Code: "naudam", Sequence: null },
            { Id: 74, Name: "N√¢u Nh·∫°t", Code: "naunhat", Sequence: null },
            { Id: 75, Name: "ƒê·ªè T∆∞∆°i", Code: "dotuoi", Sequence: null },
            { Id: 76, Name: "ƒêen V√†ng", Code: "denvang", Sequence: null },
            { Id: 77, Name: "C√† Ph√™", Code: "caphe", Sequence: null },
            { Id: 78, Name: "ƒêen B·∫°c", Code: "denbac", Sequence: null },
            { Id: 79, Name: "B√≤", Code: "bo", Sequence: null },
            { Id: 82, Name: "S·ªçc Xanh", Code: "socxanh", Sequence: null },
            { Id: 83, Name: "Xanh R√™u", Code: "xanhreu", Sequence: null },
            { Id: 84, Name: "H·ªìng Ru·ªëc", Code: "hongruoc", Sequence: null },
            { Id: 85, Name: "H·ªìng D√¢u", Code: "hongdau", Sequence: null },
            { Id: 86, Name: "Xanh Nh·∫°t", Code: "xanhnhat", Sequence: null },
            { Id: 87, Name: "Xanh Ng·ªçc", Code: "xanhngoc", Sequence: null },
            { Id: 88, Name: "Caro", Code: "caro", Sequence: null },
            { Id: 89, Name: "S·ªçc H·ªìng", Code: "sochong", Sequence: null },
            { Id: 90, Name: "Trong", Code: "trong", Sequence: null },
            { Id: 95, Name: "Tr·∫Øng H·ªìng", Code: "tranghong", Sequence: null },
            { Id: 96, Name: "Tr·∫Øng S√°ng", Code: "trangsang", Sequence: null },
            { Id: 97, Name: "ƒê·ªè ƒê√¥", Code: "dodo", Sequence: null },
            { Id: 98, Name: "Cam ƒê√†o", Code: "camdao", Sequence: null },
            { Id: 99, Name: "Cam L·∫°nh", Code: "camlanh", Sequence: null },
            { Id: 100, Name: "H·ªìng ƒê√†o", Code: "hongdao", Sequence: null },
            { Id: 101, Name: "H·ªìng ƒê·∫•t", Code: "hongdat", Sequence: null },
            { Id: 102, Name: "T√≠m ƒê·∫≠m", Code: "timdam", Sequence: null },
          ],
        },
        sizeNumber: {
          id: 4,
          name: "Size S·ªë",
          code: "SZNu",
          values: [
            { Id: 18, Name: "29", Code: "29", Sequence: null },
            { Id: 19, Name: "30", Code: "30", Sequence: null },
            { Id: 20, Name: "31", Code: "31", Sequence: null },
            { Id: 21, Name: "32", Code: "32", Sequence: null },
            { Id: 22, Name: "1", Code: "1", Sequence: null },
            { Id: 23, Name: "2", Code: "2", Sequence: null },
            { Id: 24, Name: "3", Code: "3", Sequence: null },
            { Id: 33, Name: "35", Code: "35", Sequence: null },
            { Id: 34, Name: "36", Code: "36", Sequence: null },
            { Id: 35, Name: "37", Code: "37", Sequence: null },
            { Id: 36, Name: "38", Code: "38", Sequence: null },
            { Id: 37, Name: "39", Code: "39", Sequence: null },
            { Id: 44, Name: "40", Code: "40", Sequence: null },
            { Id: 46, Name: "34", Code: "34", Sequence: null },
            { Id: 48, Name: "4", Code: "4", Sequence: null },
            { Id: 80, Name: "27", Code: "27", Sequence: null },
            { Id: 81, Name: "28", Code: "28", Sequence: null },
            { Id: 91, Name: "41", Code: "41", Sequence: null },
            { Id: 92, Name: "42", Code: "42", Sequence: null },
            { Id: 93, Name: "43", Code: "43", Sequence: null },
            { Id: 94, Name: "44", Code: "44", Sequence: null },
          ],
        },
      };

      const expandPresets = {
        basic: "UOM,Categ,UOMPO,POSCateg,ProductVariants,Images",
        full: "UOM,UOMCateg,Categ,UOMPO,POSCateg,Taxes,SupplierTaxes,Product_Teams,Images,UOMView,Distributor,Importer,Producer,OriginCountry,ProductVariants($expand=UOM,Categ,UOMPO,POSCateg,AttributeValues),AttributeLines,UOMLines($expand=UOM),ComboProducts,ProductSupplierInfos",
        minimal: "UOM,Categ,ProductVariants",
      };

      window.setExpandPreset = (preset) => {
        $("expandInput").value = expandPresets[preset];
      };

      window.clearExpand = () => {
        $("expandInput").value = "";
      };

      const toBase64 = (file) =>
        new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result.split(",")[1]);
          reader.onerror = reject;
        });

      const setStepStatus = (stepId, status) => {
        const step = $(stepId);
        const stepText = step.querySelector(".step-text").textContent;
        step.className = `progress-step ${status}`;

        if (status === "active") {
          step.innerHTML = `<div class="loader"></div><span class="step-text">${stepText}</span>`;
        } else if (status === "success") {
          step.innerHTML = `<span class="step-icon">‚úÖ</span><span class="step-text">${stepText}</span>`;
        } else if (status === "error") {
          step.innerHTML = `<span class="step-icon">‚ùå</span><span class="step-text">${stepText}</span>`;
        }
      };

      const renderEditTable = (data) => {
        const excludeFields = ["@odata.context"];

        let html =
          '<table><thead><tr><th style="width: 30%">Tr∆∞·ªùng</th><th>Gi√° Tr·ªã</th></tr></thead><tbody>';

        // Render AttributeLines first (always visible)
        if (data.AttributeLines !== undefined) {
          const jsonStr = JSON.stringify(data.AttributeLines, null, 2);
          html += `<tr>
            <td class="field-key">AttributeLines <span style="color: #999; font-size: 11px;">(Thu·ªôc t√≠nh)</span></td>
            <td>
              <button class="special-edit-btn" onclick="openAttributeModal()">‚úèÔ∏è Ch·ªânh S·ª≠a Thu·ªôc T√≠nh</button>
              <textarea data-field="AttributeLines" data-type="json" style="min-height: 120px; display: none;">${jsonStr}</textarea>
            </td>
          </tr>`;
        }

        // Render other fields (hidden by default)
        for (const [key, value] of Object.entries(data)) {
          if (excludeFields.includes(key) || key === "AttributeLines") continue;

          // Handle other complex objects/arrays as JSON
          if (typeof value === "object" && value !== null) {
            const jsonStr = JSON.stringify(value, null, 2);
            html += `<tr class="other-fields">
              <td class="field-key">${key} <span style="color: #999; font-size: 11px;">(JSON)</span></td>
              <td><textarea data-field="${key}" data-type="json" style="min-height: 120px;">${jsonStr}</textarea></td>
            </tr>`;
          } else {
            // Handle simple values
            const valueStr = value === null ? "" : String(value);
            const inputType = typeof value === "number" ? "number" : "text";

            if (valueStr.length > 100) {
              html += `<tr class="other-fields">
                <td class="field-key">${key}</td>
                <td><textarea data-field="${key}">${valueStr}</textarea></td>
              </tr>`;
            } else {
              html += `<tr class="other-fields">
                <td class="field-key">${key}</td>
                <td><input type="${inputType}" data-field="${key}" value="${valueStr}"></td>
              </tr>`;
            }
          }
        }

        html += "</tbody></table>";
        $("editTable").innerHTML = html;
      };

      const getEditedData = () => {
        const inputs = $("editTable").querySelectorAll("input, textarea");
        const edited = { ...productDetail };

        inputs.forEach((input) => {
          const field = input.getAttribute("data-field");
          const dataType = input.getAttribute("data-type");
          let value = input.value;

          // Handle JSON fields
          if (dataType === "json") {
            try {
              value = JSON.parse(value);
            } catch (e) {
              console.error(`Failed to parse JSON for field ${field}:`, e);
              alert(
                `‚ö†Ô∏è L·ªói JSON ·ªü tr∆∞·ªùng "${field}". Vui l√≤ng ki·ªÉm tra l·∫°i c√∫ ph√°p JSON.`,
              );
              throw e;
            }
          } else if (input.type === "number") {
            value = value === "" ? null : Number(value);
          } else if (value === "") {
            value = null;
          }

          edited[field] = value;
        });

        return edited;
      };

      // Excel Upload
      $("excelBox").addEventListener("click", () => $("excelInput").click());
      $("excelInput").addEventListener("change", (e) => {
        excelFile = e.target.files[0];
        if (excelFile) {
          $("excelBox").classList.add("selected");
          $("excelPreview").textContent =
            `üìÑ ${excelFile.name} (${(excelFile.size / 1024).toFixed(2)} KB)`;
          show($("excelPreview"));
        }
      });

      // Image Upload
      $("imageBox").addEventListener("click", () => $("imageInput").click());
      $("imageInput").addEventListener("change", async (e) => {
        imageFile = e.target.files[0];
        if (imageFile) {
          $("imageBox").classList.add("selected");
          $("imageFileName").textContent = `üñºÔ∏è ${imageFile.name}`;
          show($("imageFileName"));

          const base64 = await toBase64(imageFile);
          $("previewImg").src = `data:${imageFile.type};base64,${base64}`;
          show($("imagePreview"));
        }
      });

      // Step 1-3: Get Product Data
      $("processBtn").addEventListener("click", async () => {
        if (!excelFile || !imageFile) {
          alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn c·∫£ file Excel v√† h√¨nh ·∫£nh!");
          return;
        }

        const expandValue = $("expandInput").value.trim();
        if (!expandValue) {
          alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p expand parameters!");
          return;
        }

        const btn = $("processBtn");
        btn.disabled = true;
        show($("progress"));
        show($("editSection"), false);
        show($("result"), false);

        try {
          // Step 1: Upload Excel
          setStepStatus("step1", "active");
          const excelBase64 = await toBase64(excelFile);
          const uploadRes = await fetch(
            `${API_BASE}/ODataService.ActionImportSimple`,
            {
              method: "POST",
              headers: getHeaders(),
              body: JSON.stringify({
                do_inventory: false,
                file: excelBase64,
                version: "2701",
              }),
            },
          );
          if (!uploadRes.ok) throw new Error("Upload Excel th·∫•t b·∫°i");
          await uploadRes.json();
          setStepStatus("step1", "success");
          await new Promise((r) => setTimeout(r, 500));

          // Step 2: Get Product List
          setStepStatus("step2", "active");
          const listRes = await fetch(`${API_BASE}/ODataService.GetViewV2`, {
            headers: getHeaders(),
          });
          const listData = await listRes.json();
          if (!listRes.ok) throw new Error("L·∫•y danh s√°ch th·∫•t b·∫°i");

          const items = (listData.value || listData).filter(
            (item) => item.CreatedByName === "T√∫",
          );
          if (items.length === 0)
            throw new Error('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m c·ªßa "T√∫"');

          const latestProduct = items.reduce((max, item) =>
            item.Id > max.Id ? item : max,
          );
          const productId = latestProduct.Id;
          setStepStatus("step2", "success");
          await new Promise((r) => setTimeout(r, 500));

          // Step 3: Get Product Detail
          setStepStatus("step3", "active");
          const detailRes = await fetch(
            `${API_BASE}(${productId})?$expand=${encodeURIComponent(expandValue)}`,
            { headers: getHeaders() },
          );
          if (!detailRes.ok) throw new Error("L·∫•y chi ti·∫øt th·∫•t b·∫°i");

          productDetail = await detailRes.json();
          setStepStatus("step3", "success");

          // Show edit table
          renderEditTable(productDetail);
          show($("editSection"));

          // Setup search functionality
          setupSearch();

          $("editSection").scrollIntoView({ behavior: "smooth" });
        } catch (err) {
          alert(`‚ùå L·ªói: ${err.message}`);
          console.error(err);
        } finally {
          btn.disabled = false;
        }
      });

      // Continue: Process Image & Upload
      $("continueBtn").addEventListener("click", async () => {
        const btn = $("continueBtn");
        btn.disabled = true;
        btn.textContent = "‚è≥ ƒêang x·ª≠ l√Ω...";

        try {
          // Step 4: Process Image to Base64
          const imageBase64 = await toBase64(imageFile);

          // Step 5: Merge and Upload
          const finalData = getEditedData();
          delete finalData["@odata.context"];
          finalData.Image = imageBase64;

          const updateRes = await fetch(`${API_BASE}/ODataService.UpdateV2`, {
            method: "POST",
            headers: getHeaders(),
            body: JSON.stringify(finalData),
          });

          const result = await updateRes.json();

          if (updateRes.ok) {
            $("resultContainer").innerHTML =
              `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            show($("result"));
            alert("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!");
            $("result").scrollIntoView({ behavior: "smooth" });
          } else {
            throw new Error(result.error || "C·∫≠p nh·∫≠t th·∫•t b·∫°i");
          }
        } catch (err) {
          alert(`‚ùå L·ªói: ${err.message}`);
          console.error(err);
        } finally {
          btn.disabled = false;
          btn.textContent = "‚ñ∂Ô∏è Ti·∫øp T·ª•c: X·ª≠ L√Ω ·∫¢nh & Upload";
        }
      });

      // Setup search functionality
      const setupSearch = () => {
        const searchInput = $("searchInput");
        const searchStats = $("searchStats");

        searchInput.addEventListener("input", (e) => {
          const query = e.target.value.toLowerCase().trim();
          const rows = $("editTable").querySelectorAll("tbody tr");
          let visibleCount = 0;

          rows.forEach((row) => {
            const fieldName = row
              .querySelector(".field-key")
              .textContent.toLowerCase();
            const fieldValue = row
              .querySelector("input, textarea")
              .value.toLowerCase();

            if (fieldName.includes(query) || fieldValue.includes(query)) {
              row.style.display = "";
              visibleCount++;

              // Highlight matching text
              const fieldKey = row.querySelector(".field-key");
              let originalText = fieldKey.textContent.replace(" (JSON)", "");
              const isJson = fieldKey.textContent.includes("(JSON)");

              if (query && fieldName.includes(query)) {
                const regex = new RegExp(`(${query})`, "gi");
                originalText = originalText.replace(
                  regex,
                  '<span class="highlight">$1</span>',
                );
              }

              fieldKey.innerHTML =
                originalText +
                (isJson
                  ? ' <span style="color: #999; font-size: 11px;">(JSON)</span>'
                  : "");
            } else {
              row.style.display = "none";
            }
          });

          if (query) {
            searchStats.textContent = `T√¨m th·∫•y ${visibleCount} tr∆∞·ªùng`;
          } else {
            searchStats.textContent = `T·ªïng c·ªông ${rows.length} tr∆∞·ªùng`;
          }
        });

        // Show initial stats
        const totalRows = $("editTable").querySelectorAll("tbody tr").length;
        searchStats.textContent = `T·ªïng c·ªông ${totalRows} tr∆∞·ªùng`;
      };

      // AttributeLines Modal Functions
      let currentTab = "sizeText";

      window.switchTab = (tabName) => {
        currentTab = tabName;

        // Update tab buttons
        document.querySelectorAll(".attribute-tab").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.onclick.toString().includes(tabName)) {
            btn.classList.add("active");
          }
        });

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`tab-${tabName}`).classList.add("active");
      };

      window.openAttributeModal = () => {
        // Load current AttributeLines data
        const textarea = document.querySelector(
          'textarea[data-field="AttributeLines"]',
        );
        if (textarea) {
          try {
            const attributeLines = JSON.parse(textarea.value);
            currentAttributeLines = attributeLines;
          } catch (e) {
            currentAttributeLines = [];
          }
        }

        // Populate all selects
        populateSelect("sizeTextSelect", availableAttributes.sizeText.values);
        populateSelect("colorSelect", availableAttributes.color.values);
        populateSelect(
          "sizeNumberSelect",
          availableAttributes.sizeNumber.values,
        );

        // Render current values for all tabs
        renderChips("sizeText");
        renderChips("color");
        renderChips("sizeNumber");

        // Show modal
        show($("attributeModal"));
      };

      const populateSelect = (selectId, values) => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Ch·ªçn --</option>';
        values.forEach((item) => {
          select.innerHTML += `<option value="${item.Id}">${item.Name}</option>`;
        });
      };

      window.closeAttributeModal = () => {
        show($("attributeModal"), false);
      };

      const getAttributeLineByType = (type) => {
        const attrConfig = availableAttributes[type];
        return currentAttributeLines.find(
          (line) => line.AttributeId === attrConfig.id,
        );
      };

      const renderChips = (type) => {
        const attrConfig = availableAttributes[type];
        const chipsContainer = document.getElementById(`${type}Chips`);
        chipsContainer.innerHTML = "";

        const attrLine = getAttributeLineByType(type);

        if (!attrLine || !attrLine.Values || attrLine.Values.length === 0) {
          chipsContainer.innerHTML =
            '<p style="color: #999; font-size: 13px; margin-top: 10px;">Ch∆∞a c√≥ gi√° tr·ªã n√†o</p>';
          return;
        }

        attrLine.Values.forEach((val) => {
          const chip = document.createElement("div");
          chip.className = "size-chip";
          chip.innerHTML = `
            <span>${val.Name}</span>
            <button class="size-chip-remove" onclick="removeValue('${type}', ${val.Id})">√ó</button>
          `;
          chipsContainer.appendChild(chip);
        });
      };

      // Handle select change for all types
      ["sizeText", "color", "sizeNumber"].forEach((type) => {
        const selectId = `${type}Select`;
        const select = document.getElementById(selectId);

        if (select) {
          select.addEventListener("change", (e) => {
            const valueId = parseInt(e.target.value);
            if (!valueId) return;

            const attrConfig = availableAttributes[type];
            const selectedValue = attrConfig.values.find(
              (v) => v.Id === valueId,
            );
            if (!selectedValue) return;

            // Initialize AttributeLines if empty
            if (!currentAttributeLines) {
              currentAttributeLines = [];
            }

            // Find or create attribute line for this type
            let attrLine = getAttributeLineByType(type);

            if (!attrLine) {
              attrLine = {
                Attribute: {
                  Id: attrConfig.id,
                  Name: attrConfig.name,
                  Code: attrConfig.code,
                  Sequence: type === "sizeText" ? 1 : null,
                  CreateVariant: true,
                },
                Values: [],
                AttributeId: attrConfig.id,
              };
              currentAttributeLines.push(attrLine);
            }

            // Check if value already exists
            const existingValue = attrLine.Values.find((v) => v.Id === valueId);
            if (existingValue) {
              alert("‚ö†Ô∏è Gi√° tr·ªã n√†y ƒë√£ ƒë∆∞·ª£c th√™m r·ªìi!");
              e.target.value = "";
              return;
            }

            // Add new value
            attrLine.Values.push({
              Id: selectedValue.Id,
              Name: selectedValue.Name,
              Code: selectedValue.Code,
              Sequence: selectedValue.Sequence,
              AttributeId: attrConfig.id,
              AttributeName: attrConfig.name,
              PriceExtra: null,
              NameGet: `${attrConfig.name}: ${selectedValue.Name}`,
              DateCreated: null,
            });

            // Re-render chips
            renderChips(type);

            // Reset select
            e.target.value = "";
          });
        }
      });

      window.removeValue = (type, valueId) => {
        const attrLine = getAttributeLineByType(type);
        if (!attrLine) return;

        // Remove from Values array
        attrLine.Values = attrLine.Values.filter((v) => v.Id !== valueId);

        // If no values left, remove the entire attribute line
        if (attrLine.Values.length === 0) {
          currentAttributeLines = currentAttributeLines.filter(
            (line) => line.AttributeId !== attrLine.AttributeId,
          );
        }

        // Re-render
        renderChips(type);
      };

      window.saveAttributeLines = () => {
        // Update the hidden textarea
        const textarea = document.querySelector(
          'textarea[data-field="AttributeLines"]',
        );
        if (textarea) {
          textarea.value = JSON.stringify(currentAttributeLines, null, 2);
        }

        // Close modal
        closeAttributeModal();

        alert("‚úÖ ƒê√£ l∆∞u thay ƒë·ªïi AttributeLines!");
      };

      // Toggle other fields visibility
      let fieldsVisible = false;

      window.toggleOtherFields = () => {
        fieldsVisible = !fieldsVisible;
        const otherFields = document.querySelectorAll(".other-fields");
        const toggleBtn = $("toggleFieldsBtn");
        const searchBox = $("searchBox");

        if (fieldsVisible) {
          otherFields.forEach((field) => field.classList.add("show"));
          toggleBtn.textContent = "üôà ·∫®n C√°c Tr∆∞·ªùng Kh√°c";
          searchBox.classList.add("show");

          // Update search stats
          const totalRows = $("editTable").querySelectorAll("tbody tr").length;
          $("searchStats").textContent = `T·ªïng c·ªông ${totalRows} tr∆∞·ªùng`;
        } else {
          otherFields.forEach((field) => field.classList.remove("show"));
          toggleBtn.textContent = "üëÅÔ∏è Hi·ªán C√°c Tr∆∞·ªùng Kh√°c";
          searchBox.classList.remove("show");
        }
      };
    </script>
  </body>
</html>
