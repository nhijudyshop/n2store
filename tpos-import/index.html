<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Manager - TPOS</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 1200px;
        width: 100%;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
      }
      .header p {
        color: #666;
        font-size: 14px;
      }

      .section {
        margin-top: 25px;
        padding: 20px;
        background: #fff5f5;
        border-radius: 12px;
        border: 2px solid #ff6b6b;
      }

      .section h3 {
        color: #333;
        font-size: 16px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      input[type="text"] {
        flex: 1;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      input[type="text"]:focus {
        outline: none;
        border-color: #ff6b6b;
      }

      .btn {
        padding: 12px 24px;
        background: #4ecdc4;
        color: white;
        border: 2px solid #4ecdc4;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn:hover {
        background: #45b8af;
        border-color: #45b8af;
        transform: translateY(-2px);
      }

      .data-display {
        margin-bottom: 20px;
      }

      .data-display h4 {
        margin-bottom: 10px;
        color: #333;
      }

      .json-container {
        background: #f5f5f5;
        border-radius: 10px;
        padding: 20px;
        max-height: 300px;
        overflow: auto;
        font-family: "Courier New", monospace;
        font-size: 13px;
        line-height: 1.6;
      }

      .edit-form {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #ff6b6b;
      }

      .edit-form h4 {
        margin-bottom: 15px;
        color: #333;
      }

      .form-section {
        background: #f8f9ff;
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #667eea;
        margin-bottom: 15px;
      }

      .form-section h5 {
        margin-bottom: 10px;
        color: #333;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .form-field {
        display: flex;
        flex-direction: column;
      }

      .form-field.full-width {
        grid-column: 1 / -1;
      }

      .form-field label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #555;
      }

      .form-field input[type="number"],
      .form-field input[type="text"] {
        width: 100%;
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 13px;
        transition: border-color 0.2s ease;
      }

      .form-field input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn-update {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        transition: all 0.3s ease;
      }

      .btn-update:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
      }

      .hidden {
        display: none;
      }

      .nav-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding: 15px;
        background: #fff5f5;
        border-radius: 12px;
        border: 2px solid #ff6b6b;
      }

      .nav-btn {
        flex: 1;
        padding: 12px 20px;
        border: 2px solid #ff6b6b;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        text-align: center;
        display: block;
      }

      .nav-btn.active {
        background: #ff6b6b;
        color: white;
      }

      .nav-btn:not(.active) {
        background: white;
        color: #ff6b6b;
      }

      .nav-btn:not(.active):hover {
        background: #ffe5e5;
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üõí Order Manager - TPOS</h1>
        <p>Qu·∫£n l√Ω ƒë∆°n h√†ng SaleOnline_Order</p>
      </div>

      <div class="nav-bar">
        <a href="product_manager.html" class="nav-btn">üì¶ Product Manager</a>
        <a href="#" class="nav-btn active">üõí Order Manager</a>
      </div>

      <div class="section">
        <h3>üîç L·∫•y Th√¥ng Tin ƒê∆°n H√†ng</h3>

        <div class="input-group">
          <input
            type="text"
            id="orderIdInput"
            value="67700000-5d43-0015-a138-08de03dabe8d"
            placeholder="Nh·∫≠p ID ƒë∆°n h√†ng"
          />
          <button class="btn" onclick="getOrderData()">üì• L·∫•y D·ªØ Li·ªáu</button>
        </div>

        <div id="orderDataDisplay" class="data-display hidden">
          <h4>üìã D·ªØ Li·ªáu ƒê∆°n H√†ng:</h4>
          <div class="json-container" id="orderJsonContainer"></div>
        </div>

        <div id="orderEditForm" class="edit-form hidden">
          <h4>‚úèÔ∏è Ch·ªânh S·ª≠a ƒê∆°n H√†ng</h4>

          <div class="form-section">
            <h5>üì¶ Chi Ti·∫øt S·∫£n Ph·∫©m (Details)</h5>
            <div class="form-grid">
              <div class="form-field">
                <label>Product ID:</label>
                <input type="number" id="editProductId" value="122955" />
              </div>
              <div class="form-field">
                <label>Quantity:</label>
                <input type="number" id="editQuantity" value="1" />
              </div>
              <div class="form-field">
                <label>Product Name:</label>
                <input
                  type="text"
                  id="editProductName"
                  value="TH SET √ÅO X√ÅM+ QU·∫¶N D√ÄI SU√îNG"
                />
              </div>
              <div class="form-field">
                <label>Price:</label>
                <input type="number" id="editPrice" value="350000" />
              </div>
              <div class="form-field full-width">
                <label>Product Name Get:</label>
                <input
                  type="text"
                  id="editProductNameGet"
                  value="[LSET3] TH SET √ÅO X√ÅM+ QU·∫¶N D√ÄI SU√îNG"
                />
              </div>
            </div>
          </div>

          <button class="btn-update" onclick="updateOrder()">
            üöÄ C·∫≠p Nh·∫≠t ƒê∆°n H√†ng
          </button>
        </div>
      </div>
    </div>

    <script>
      const AUTH_TOKEN =
        "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJDbGllbnRJZCI6InRtdFdlYkFwcCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiZmMwZjQ0MzktOWNmNi00ZDg4LWE4YzctNzU5Y2E4Mjk1MTQyIiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6Im52MjAiLCJEaXNwbGF5TmFtZSI6IlTDuiIsIkF2YXRhclVybCI6IiIsIlNlY3VyaXR5U3RhbXAiOiI2ODgxNTgxYi1jZTc1LTRjMWQtYmM4ZC0yNjEwMzAzYzAzN2EiLCJDb21wYW55SWQiOiIxIiwiVGVuYW50SWQiOiJ0b21hdG8udHBvcy52biIsIlJvbGVJZHMiOiI0MmZmYzk5Yi1lNGY2LTQwMDAtYjcyOS1hZTNmMDAyOGEyODksNmExZDAwMDAtNWQxYS0wMDE1LTBlNmMtMDhkYzM3OTUzMmU5LDc2MzlhMDQ4LTdjZmUtNDBiNS1hNDFkLWFlM2YwMDNiODlkZiw4YmM4ZjQ1YS05MWY4LTQ5NzMtYjE4Mi1hZTNmMDAzYWI4NTUsYTljMjAwMDAtNWRiNi0wMDE1LTQ1YWItMDhkYWIxYmZlMjIyIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjpbIlF14bqjbiBMw70gTWFpIiwiQ8OSSSIsIkNTS0ggLSBMw6BpIiwiS2hvIFBoxrDhu5tjLSBLaeG7h3QiLCJRdeG6o24gTMO9IEtobyAtIEJvIl0sImp0aSI6IjY2MzA3MjlkLWJlM2MtNDcwOS1iOWJjLWM2YjNmNzc2ZGYyZSIsImlhdCI6IjE3NTkzODc4NjciLCJuYmYiOjE3NTkzODc4NjcsImV4cCI6MTc2MDY4Mzg2NywiaXNzIjoiaHR0cHM6Ly90b21hdG8udHBvcy52biIsImF1ZCI6Imh0dHBzOi8vdG9tYXRvLnRwb3Mudm4saHR0cHM6Ly90cG9zLnZuIn0.38Srsqs7uhUknlXr08NgtH34ZCBg9TuZ-geO2IrdYcU";

      const $ = (id) => document.getElementById(id);
      let currentOrderData = null;

      const generateRandomId = () => {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          },
        );
      };

      const getHeaders = () => ({
        accept: "application/json, text/plain, */*",
        "accept-encoding": "gzip, deflate, br",
        "accept-language": "vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7",
        authorization: AUTH_TOKEN,
        "content-type": "application/json;charset=UTF-8",
        origin: "https://tomato.tpos.vn",
        referer: "https://tomato.tpos.vn/",
        "sec-ch-ua":
          '"Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24"',
        "sec-ch-ua-mobile": "?0",
        "sec-ch-ua-platform": '"Windows"',
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors",
        "sec-fetch-site": "same-origin",
        tposappversion: "5.9.10.1",
        "user-agent":
          "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
        "x-request-id": generateRandomId(),
      });

      window.getOrderData = async () => {
        const orderId = $("orderIdInput").value.trim();
        if (!orderId) {
          alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ID ƒë∆°n h√†ng!");
          return;
        }

        try {
          const response = await fetch(
            `https://tomato.tpos.vn/odata/SaleOnline_Order(${orderId})?$expand=Details,Partner,User,CRMTeam`,
            { headers: getHeaders() },
          );

          if (!response.ok) {
            throw new Error(`L·ªói ${response.status}: ${response.statusText}`);
          }

          currentOrderData = await response.json();

          $("orderJsonContainer").innerHTML =
            `<pre>${JSON.stringify(currentOrderData, null, 2)}</pre>`;
          $("orderDataDisplay").classList.remove("hidden");

          if (currentOrderData.Details && currentOrderData.Details.length > 0) {
            const detail = currentOrderData.Details[0];
            $("editProductId").value = detail.ProductId || 122955;
            $("editProductName").value =
              detail.ProductName || "TH SET √ÅO X√ÅM+ QU·∫¶N D√ÄI SU√îNG";
            $("editProductNameGet").value =
              detail.ProductNameGet || "[LSET3] TH SET √ÅO X√ÅM+ QU·∫¶N D√ÄI SU√îNG";
            $("editQuantity").value = detail.Quantity || 1;
            $("editPrice").value = detail.Price || 350000;
          }

          $("orderEditForm").classList.remove("hidden");

          setTimeout(() => {
            $("orderEditForm").scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }, 100);
        } catch (err) {
          alert(`‚ùå L·ªói: ${err.message}`);
          console.error(err);
        }
      };

      window.updateOrder = async () => {
        if (!currentOrderData) {
          alert("‚ö†Ô∏è Vui l√≤ng l·∫•y d·ªØ li·ªáu ƒë∆°n h√†ng tr∆∞·ªõc!");
          return;
        }

        const orderId = currentOrderData.Id;

        try {
          const quantity = Number($("editQuantity").value);
          const price = Number($("editPrice").value);

          const totalAmount = quantity * price;
          const totalQuantity = quantity;

          const updatePayload = {
            ...currentOrderData,
            TotalAmount: totalAmount,
            TotalQuantity: totalQuantity,
            PrintCount: (currentOrderData.PrintCount || 0) + 1,
            Details: [
              {
                ProductId: Number($("editProductId").value),
                ProductName: $("editProductName").value,
                ProductNameGet: $("editProductNameGet").value,
                UOMId: 1,
                UOMName: "C√°i",
                Quantity: quantity,
                Price: price,
                Factor: 1,
                ProductWeight: 0,
              },
            ],
          };

          delete updatePayload["@odata.context"];

          const response = await fetch(
            `https://tomato.tpos.vn/odata/SaleOnline_Order(${orderId})`,
            {
              method: "PUT",
              headers: getHeaders(),
              body: JSON.stringify(updatePayload),
            },
          );

          if (!response.ok) {
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
              const errorData = await response.json();
              throw new Error(
                errorData.error?.message || `L·ªói ${response.status}`,
              );
            } else {
              const errorText = await response.text();
              throw new Error(
                `L·ªói ${response.status}: ${errorText || response.statusText}`,
              );
            }
          }

          const contentType = response.headers.get("content-type");
          let result;

          if (contentType && contentType.includes("application/json")) {
            const text = await response.text();
            result = text ? JSON.parse(text) : { success: true };
          } else {
            result = { success: true, status: response.status };
          }

          $("orderJsonContainer").innerHTML =
            `<pre>${JSON.stringify(result, null, 2)}</pre>`;

          alert("‚úÖ C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng!");

          await getOrderData();
        } catch (err) {
          alert(`‚ùå L·ªói: ${err.message}`);
          console.error(err);
        }
      };
    </script>
  </body>
</html>
