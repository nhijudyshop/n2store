<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Import Excel - TPOS</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 900px;
        width: 100%;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
      }
      .header p {
        color: #666;
        font-size: 14px;
      }

      .upload-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .upload-box {
        border: 2px dashed #667eea;
        border-radius: 15px;
        padding: 30px 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #f8f9ff;
      }

      .upload-box:hover,
      .upload-box.dragover {
        border-color: #764ba2;
        background: #e8ebff;
        transform: scale(1.02);
      }

      .upload-box.selected {
        border-color: #28a745;
        background: #d4edda;
      }

      .upload-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }
      .upload-text {
        color: #333;
        font-size: 16px;
        margin-bottom: 5px;
        font-weight: 600;
      }
      .upload-hint {
        color: #999;
        font-size: 12px;
      }

      input[type="file"] {
        display: none;
      }

      .file-preview {
        margin-top: 10px;
        padding: 10px;
        background: white;
        border-radius: 8px;
        font-size: 13px;
        color: #2e7d32;
        display: none;
      }

      .file-preview.show {
        display: block;
      }

      .image-preview {
        margin-top: 10px;
        display: none;
      }

      .image-preview.show {
        display: block;
      }

      .image-preview img {
        max-width: 100%;
        max-height: 150px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .btn-process {
        width: 100%;
        padding: 18px;
        margin-top: 20px;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      .btn-process:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      .btn-process:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .progress {
        margin-top: 20px;
        display: none;
      }

      .progress.show {
        display: block;
      }

      .progress-step {
        padding: 12px 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        background: #f5f5f5;
        border-left: 4px solid #ddd;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
      }

      .progress-step.active {
        background: #e3f2fd;
        border-left-color: #2196f3;
      }

      .progress-step.success {
        background: #e8f5e9;
        border-left-color: #4caf50;
      }

      .progress-step.error {
        background: #ffebee;
        border-left-color: #f44336;
      }

      .step-icon {
        font-size: 20px;
      }
      .step-text {
        flex: 1;
        font-size: 14px;
      }

      .loader {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #2196f3;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .result {
        margin-top: 30px;
        display: none;
      }

      .result.show {
        display: block;
      }

      .result h2 {
        color: #333;
        font-size: 20px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
      }

      .json-container {
        background: #f5f5f5;
        border-radius: 10px;
        padding: 20px;
        max-height: 400px;
        overflow: auto;
        font-family: "Courier New", monospace;
        font-size: 13px;
        line-height: 1.6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìä Import Excel & Update Product</h1>
        <p>
          Ch·ªçn file Excel v√† h√¨nh ·∫£nh, sau ƒë√≥ b·∫•m "X·ª≠ L√Ω" ƒë·ªÉ c·∫≠p nh·∫≠t s·∫£n ph·∫©m
        </p>
      </div>

      <div class="upload-section">
        <div class="upload-box" id="excelBox">
          <div class="upload-icon">üìÅ</div>
          <div class="upload-text">File Excel</div>
          <div class="upload-hint">Click ƒë·ªÉ ch·ªçn .xlsx, .xls</div>
          <div class="file-preview" id="excelPreview"></div>
        </div>

        <div class="upload-box" id="imageBox">
          <div class="upload-icon">üñºÔ∏è</div>
          <div class="upload-text">H√¨nh ·∫¢nh</div>
          <div class="upload-hint">Click ƒë·ªÉ ch·ªçn ·∫£nh</div>
          <div class="file-preview" id="imageFileName"></div>
          <div class="image-preview" id="imagePreview">
            <img id="previewImg" src="" alt="Preview" />
          </div>
        </div>
      </div>

      <input type="file" id="excelInput" accept=".xlsx,.xls" />
      <input type="file" id="imageInput" accept="image/*" />

      <button class="btn-process" id="processBtn">üöÄ X·ª≠ L√Ω T·∫•t C·∫£</button>

      <div class="progress" id="progress">
        <div class="progress-step" id="step1">
          <span class="step-icon">1Ô∏è‚É£</span>
          <span class="step-text">Upload Excel</span>
        </div>
        <div class="progress-step" id="step2">
          <span class="step-icon">2Ô∏è‚É£</span>
          <span class="step-text">L·∫•y d·ªØ li·ªáu s·∫£n ph·∫©m</span>
        </div>
        <div class="progress-step" id="step3">
          <span class="step-icon">3Ô∏è‚É£</span>
          <span class="step-text">L·∫•y chi ti·∫øt s·∫£n ph·∫©m</span>
        </div>
        <div class="progress-step" id="step4">
          <span class="step-icon">4Ô∏è‚É£</span>
          <span class="step-text">X·ª≠ l√Ω h√¨nh ·∫£nh</span>
        </div>
        <div class="progress-step" id="step5">
          <span class="step-icon">5Ô∏è‚É£</span>
          <span class="step-text">C·∫≠p nh·∫≠t s·∫£n ph·∫©m</span>
        </div>
      </div>

      <div class="result" id="result">
        <h2>‚úÖ K·∫øt qu·∫£ c·∫≠p nh·∫≠t</h2>
        <div class="json-container" id="resultContainer"></div>
      </div>
    </div>

    <script>
      const API_BASE = "https://tomato.tpos.vn/odata/ProductTemplate";
      const AUTH_TOKEN =
        "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJDbGllbnRJZCI6InRtdFdlYkFwcCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiZmMwZjQ0MzktOWNmNi00ZDg4LWE4YzctNzU5Y2E4Mjk1MTQyIiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6Im52MjAiLCJEaXNwbGF5TmFtZSI6IlTDuiIsIkF2YXRhclVybCI6IiIsIlNlY3VyaXR5U3RhbXAiOiI2ODgxNTgxYi1jZTc1LTRjMWQtYmM4ZC0yNjEwMzAzYzAzN2EiLCJDb21wYW55SWQiOiIxIiwiVGVuYW50SWQiOiJ0b21hdG8udHBvcy52biIsIlJvbGVJZHMiOiI0MmZmYzk5Yi1lNGY2LTQwMDAtYjcyOS1hZTNmMDAyOGEyODksNmExZDAwMDAtNWQxYS0wMDE1LTBlNmMtMDhkYzM3OTUzMmU5LDc2MzlhMDQ4LTdjZmUtNDBiNS1hNDFkLWFlM2YwMDNiODlkZiw4YmM4ZjQ1YS05MWY4LTQ5NzMtYjE4Mi1hZTNmMDAzYWI4NTUsYTljMjAwMDAtNWRiNi0wMDE1LTQ1YWItMDhkYWIxYmZlMjIyIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjpbIlF14bqjbiBMw70gTWFpIiwiQ8OSSSIsIkNTS0ggLSBMw6BpIiwiS2hvIFBoxrDhu5tjLSBLaeG7h3QiLCJRdeG6o24gTMO9IEtobyAtIEJvIl0sImp0aSI6IjY2MzA3MjlkLWJlM2MtNDcwOS1iOWJjLWM2YjNmNzc2ZGYyZSIsImlhdCI6IjE3NTkzODc4NjciLCJuYmYiOjE3NTkzODc4NjcsImV4cCI6MTc2MDY4Mzg2NywiaXNzIjoiaHR0cHM6Ly90b21hdG8udHBvcy52biIsImF1ZCI6Imh0dHBzOi8vdG9tYXRvLnRwb3Mudm4saHR0cHM6Ly90cG9zLnZuIn0.38Srsqs7uhUknlXr08NgtH34ZCBg9TuZ-geO2IrdYcU";

      const $ = (id) => document.getElementById(id);
      const show = (el, visible = true) => el.classList.toggle("show", visible);

      let excelFile = null;
      let imageFile = null;

      const headers = {
        accept: "application/json, text/plain, */*",
        authorization: AUTH_TOKEN,
        "content-type": "application/json;charset=UTF-8",
        tposappversion: "5.9.10.1",
        origin: "https://tomato.tpos.vn",
        referer: "https://tomato.tpos.vn/",
      };

      const toBase64 = (file) =>
        new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result.split(",")[1]);
          reader.onerror = reject;
        });

      const setStepStatus = (stepId, status) => {
        const step = $(stepId);
        step.className = `progress-step ${status}`;
        if (status === "active") {
          step.innerHTML = `<div class="loader"></div><span class="step-text">${step.querySelector(".step-text").textContent}</span>`;
        }
      };

      // Excel Upload
      $("excelBox").addEventListener("click", () => $("excelInput").click());
      $("excelInput").addEventListener("change", (e) => {
        excelFile = e.target.files[0];
        if (excelFile) {
          $("excelBox").classList.add("selected");
          $("excelPreview").textContent =
            `üìÑ ${excelFile.name} (${(excelFile.size / 1024).toFixed(2)} KB)`;
          show($("excelPreview"));
        }
      });

      // Image Upload
      $("imageBox").addEventListener("click", () => $("imageInput").click());
      $("imageInput").addEventListener("change", async (e) => {
        imageFile = e.target.files[0];
        if (imageFile) {
          $("imageBox").classList.add("selected");
          $("imageFileName").textContent = `üñºÔ∏è ${imageFile.name}`;
          show($("imageFileName"));

          const base64 = await toBase64(imageFile);
          $("previewImg").src = `data:${imageFile.type};base64,${base64}`;
          show($("imagePreview"));
        }
      });

      // Process All
      $("processBtn").addEventListener("click", async () => {
        if (!excelFile || !imageFile) {
          alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn c·∫£ file Excel v√† h√¨nh ·∫£nh!");
          return;
        }

        const btn = $("processBtn");
        btn.disabled = true;
        show($("progress"));
        show($("result"), false);

        try {
          // Step 1: Upload Excel
          setStepStatus("step1", "active");
          const excelBase64 = await toBase64(excelFile);
          const uploadRes = await fetch(
            `${API_BASE}/ODataService.ActionImportSimple`,
            {
              method: "POST",
              headers,
              body: JSON.stringify({
                do_inventory: false,
                file: excelBase64,
                version: "2701",
              }),
            },
          );
          if (!uploadRes.ok) throw new Error("Upload Excel th·∫•t b·∫°i");
          setStepStatus("step1", "success");
          await new Promise((r) => setTimeout(r, 500));

          // Step 2: Get Product List
          setStepStatus("step2", "active");
          const listRes = await fetch(`${API_BASE}/ODataService.GetViewV2`, {
            headers,
          });
          const listData = await listRes.json();
          if (!listRes.ok) throw new Error("L·∫•y danh s√°ch th·∫•t b·∫°i");

          const items = (listData.value || listData).filter(
            (item) => item.CreatedByName === "T√∫",
          );
          if (items.length === 0)
            throw new Error('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m c·ªßa "T√∫"');

          const latestProduct = items.reduce((max, item) =>
            item.Id > max.Id ? item : max,
          );
          const productId = latestProduct.Id;
          setStepStatus("step2", "success");
          await new Promise((r) => setTimeout(r, 500));

          // Step 3: Get Product Detail
          setStepStatus("step3", "active");
          const expand =
            "UOM,UOMCateg,Categ,UOMPO,POSCateg,Taxes,SupplierTaxes,Product_Teams,Images,UOMView,Distributor,Importer,Producer,OriginCountry,ProductVariants($expand=UOM,Categ,UOMPO,POSCateg,AttributeValues),AttributeLines,UOMLines($expand=UOM),ComboProducts,ProductSupplierInfos";
          const detailRes = await fetch(
            `${API_BASE}(${productId})?$expand=${expand}`,
            { headers },
          );
          if (!detailRes.ok) throw new Error("L·∫•y chi ti·∫øt th·∫•t b·∫°i");

          const productDetail = await detailRes.json();
          setStepStatus("step3", "success");
          await new Promise((r) => setTimeout(r, 500));

          // Step 4: Process Image
          setStepStatus("step4", "active");
          const imageBase64 = await toBase64(imageFile);
          setStepStatus("step4", "success");
          await new Promise((r) => setTimeout(r, 500));

          // Step 5: Update Product
          setStepStatus("step5", "active");
          const payload = { ...productDetail };
          delete payload["@odata.context"];
          payload.Image = imageBase64;

          const updateRes = await fetch(`${API_BASE}/ODataService.UpdateV2`, {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          });

          const result = await updateRes.json();

          if (updateRes.ok) {
            setStepStatus("step5", "success");
            $("resultContainer").innerHTML =
              `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            show($("result"));
          } else {
            throw new Error(result.error || "C·∫≠p nh·∫≠t th·∫•t b·∫°i");
          }
        } catch (err) {
          alert(`‚ùå L·ªói: ${err.message}`);
          console.error(err);
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
