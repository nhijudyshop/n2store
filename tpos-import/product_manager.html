<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Manager - TPOS</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 1200px;
        width: 100%;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
      }
      .header p {
        color: #666;
        font-size: 14px;
      }

      .upload-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .upload-box {
        border: 2px dashed #667eea;
        border-radius: 15px;
        padding: 30px 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #f8f9ff;
      }

      .upload-box:hover,
      .upload-box.dragover {
        border-color: #764ba2;
        background: #e8ebff;
        transform: scale(1.02);
      }

      .upload-box.selected {
        border-color: #28a745;
        background: #d4edda;
      }

      .upload-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }
      .upload-text {
        color: #333;
        font-size: 16px;
        margin-bottom: 5px;
        font-weight: 600;
      }
      .upload-hint {
        color: #999;
        font-size: 12px;
      }

      input[type="file"] {
        display: none;
      }

      .file-preview {
        margin-top: 10px;
        padding: 10px;
        background: white;
        border-radius: 8px;
        font-size: 13px;
        color: #2e7d32;
        display: none;
      }

      .file-preview.show {
        display: block;
      }

      .image-preview {
        margin-top: 10px;
        display: none;
      }

      .image-preview.show {
        display: block;
      }

      .image-preview img {
        max-width: 100%;
        max-height: 150px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .expand-section {
        margin-top: 25px;
        padding: 20px;
        background: #f8f9ff;
        border-radius: 12px;
        border: 2px solid #667eea;
      }

      .expand-section h3 {
        color: #333;
        font-size: 16px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .expand-section textarea {
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        resize: vertical;
        transition: border-color 0.3s ease;
      }

      .expand-section textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .expand-hint {
        margin-top: 8px;
        font-size: 12px;
        color: #666;
        line-height: 1.5;
      }

      .expand-presets {
        margin-top: 12px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .preset-btn {
        padding: 6px 12px;
        background: white;
        border: 2px solid #667eea;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #667eea;
        font-weight: 600;
      }

      .preset-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
      }

      .btn-process {
        width: 100%;
        padding: 18px;
        margin-top: 20px;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      .btn-process:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      .btn-process:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .progress {
        margin-top: 20px;
        display: none;
      }

      .progress.show {
        display: block;
      }

      .progress-step {
        padding: 12px 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        background: #f5f5f5;
        border-left: 4px solid #ddd;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
        cursor: default;
      }

      .progress-step.active {
        background: #e3f2fd;
        border-left-color: #2196f3;
      }

      .progress-step.success {
        background: #e8f5e9;
        border-left-color: #4caf50;
      }

      .progress-step.error {
        background: #ffebee;
        border-left-color: #f44336;
      }

      .step-icon {
        font-size: 20px;
        min-width: 24px;
        text-align: center;
      }
      .step-text {
        flex: 1;
        font-size: 14px;
      }

      .loader {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #2196f3;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .edit-section {
        margin-top: 30px;
        display: none;
        background: #f8f9ff;
        border-radius: 12px;
        padding: 20px;
        border: 2px solid #667eea;
      }

      .edit-section.show {
        display: block;
      }

      .edit-section h2 {
        color: #333;
        font-size: 20px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .special-edit-btn {
        padding: 6px 12px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-left: 10px;
      }

      .special-edit-btn:hover {
        background: #5568d3;
        transform: translateY(-1px);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #667eea;
      }

      .modal-header h3 {
        color: #333;
        font-size: 20px;
        margin: 0;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #999;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
      }

      .modal-close:hover {
        color: #333;
      }

      .size-selector {
        margin-bottom: 20px;
      }

      .size-selector label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
      }

      .size-selector select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
      }

      .size-selector select:focus {
        outline: none;
        border-color: #667eea;
      }

      .selected-sizes {
        margin-top: 15px;
      }

      .size-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #e8f5e9;
        border: 2px solid #4caf50;
        padding: 8px 12px;
        border-radius: 8px;
        margin: 5px;
        font-size: 14px;
      }

      .size-chip-remove {
        background: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        font-size: 12px;
        line-height: 1;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .modal-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .modal-btn-save {
        background: #4caf50;
        color: white;
      }

      .modal-btn-save:hover {
        background: #45a049;
      }

      .modal-btn-cancel {
        background: #f5f5f5;
        color: #333;
      }

      .modal-btn-cancel:hover {
        background: #e0e0e0;
      }

      .attribute-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
      }

      .attribute-tab {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
      }

      .attribute-tab:hover {
        color: #667eea;
      }

      .attribute-tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .edit-table {
        width: 100%;
        max-height: 500px;
        overflow: auto;
        background: white;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .edit-table table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      .edit-table th {
        background: #667eea;
        color: white;
        padding: 12px;
        text-align: left;
        position: sticky;
        top: 0;
        font-weight: 600;
        font-size: 14px;
      }

      .edit-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        font-size: 13px;
      }

      .edit-table tr {
        display: table;
        width: 100%;
        table-layout: fixed;
      }

      .edit-table tbody {
        display: block;
      }

      .edit-table thead {
        display: table;
        width: 100%;
        table-layout: fixed;
      }

      .edit-table tr:hover {
        background: #f5f5f5;
      }

      .edit-table input[type="text"],
      .edit-table input[type="number"],
      .edit-table textarea {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.2s ease;
      }

      .edit-table textarea {
        min-height: 80px;
        resize: vertical;
      }

      .edit-table input:focus,
      .edit-table textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .field-key {
        font-weight: 600;
        color: #555;
        width: 30%;
        vertical-align: top;
        padding-top: 15px;
      }

      .edit-table td:last-child {
        width: 70%;
      }

      .btn-continue {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        color: white;
        transition: all 0.3s ease;
      }

      .btn-continue:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
      }

      .result {
        margin-top: 30px;
        display: none;
      }

      .result.show {
        display: block;
      }

      .result h2 {
        color: #333;
        font-size: 20px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
      }

      .json-container {
        background: #f5f5f5;
        border-radius: 10px;
        padding: 20px;
        max-height: 400px;
        overflow: auto;
        font-family: "Courier New", monospace;
        font-size: 13px;
        line-height: 1.6;
      }

      .nav-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9ff;
        border-radius: 12px;
        border: 2px solid #667eea;
      }

      .nav-btn {
        flex: 1;
        padding: 12px 20px;
        border: 2px solid #667eea;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        text-align: center;
        display: block;
      }

      .nav-btn.active {
        background: #667eea;
        color: white;
      }

      .nav-btn:not(.active) {
        background: white;
        color: #667eea;
      }

      .nav-btn:not(.active):hover {
        background: #e8ebff;
        transform: translateY(-2px);
      }

      .notification {
        padding: 15px 20px;
        border-radius: 8px;
        margin-top: 20px;
        font-size: 14px;
        font-weight: 500;
        display: none;
        animation: slideIn 0.3s ease;
      }

      .notification.show {
        display: block;
      }

      .notification.success {
        background: #d4edda;
        border: 2px solid #28a745;
        color: #155724;
      }

      .notification.error {
        background: #f8d7da;
        border: 2px solid #dc3545;
        color: #721c24;
      }

      .notification.warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        color: #856404;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üì¶ Product Manager - TPOS</h1>
        <p>
          Ch·ªçn file Excel v√† h√¨nh ·∫£nh, sau ƒë√≥ b·∫•m "X·ª≠ L√Ω" ƒë·ªÉ c·∫≠p nh·∫≠t s·∫£n ph·∫©m
        </p>
      </div>

      <div class="nav-bar">
        <a href="#" class="nav-btn active">üì¶ Product Manager</a>
        <a href="index.html" class="nav-btn">üõí Order Manager</a>
      </div>

      <div class="upload-section">
        <div class="upload-box" id="excelBox">
          <div class="upload-icon">üìë</div>
          <div class="upload-text">File Excel</div>
          <div class="upload-hint">Click ƒë·ªÉ ch·ªçn .xlsx, .xls</div>
          <div class="file-preview" id="excelPreview"></div>
        </div>

        <div class="upload-box" id="imageBox">
          <div class="upload-icon">üñºÔ∏è</div>
          <div class="upload-text">H√¨nh ·∫¢nh</div>
          <div class="upload-hint">Click ƒë·ªÉ ch·ªçn ·∫£nh</div>
          <div class="file-preview" id="imageFileName"></div>
          <div class="image-preview" id="imagePreview">
            <img id="previewImg" src="" alt="Preview" />
          </div>
        </div>
      </div>

      <input type="file" id="excelInput" accept=".xlsx,.xls" />
      <input type="file" id="imageInput" accept="image/*" />

      <div class="expand-section">
        <h3>‚öôÔ∏è Expand Parameters (OData)</h3>
        <textarea id="expandInput" placeholder="Nh·∫≠p c√°c tr∆∞·ªùng expand...">
UOM,UOMCateg,Categ,UOMPO,POSCateg,Taxes,SupplierTaxes,Product_Teams,Images,UOMView,Distributor,Importer,Producer,OriginCountry,ProductVariants($expand=UOM,Categ,UOMPO,POSCateg,AttributeValues),AttributeLines,UOMLines($expand=UOM),ComboProducts,ProductSupplierInfos</textarea
        >
        <div class="expand-hint">
          üí° C√°c tr∆∞·ªùng ph·ªï bi·∫øn: UOM, Categ, UOMPO, POSCateg, Taxes,
          ProductVariants, AttributeLines, Images, UOMLines, ComboProducts
        </div>
        <div class="expand-presets">
          <button class="preset-btn" onclick="setExpandPreset('basic')">
            üîπ C∆° b·∫£n
          </button>
          <button class="preset-btn" onclick="setExpandPreset('full')">
            üî∏ ƒê·∫ßy ƒë·ªß
          </button>
          <button class="preset-btn" onclick="setExpandPreset('minimal')">
            ‚ö™ T·ªëi thi·ªÉu
          </button>
          <button class="preset-btn" onclick="clearExpand()">üóëÔ∏è X√≥a</button>
        </div>
      </div>

      <button class="btn-process" id="processBtn">
        üöÄ B∆∞·ªõc 1-3: L·∫•y D·ªØ Li·ªáu
      </button>

      <div class="progress" id="progress">
        <div class="progress-step" id="step1">
          <span class="step-icon">1Ô∏è‚É£</span>
          <span class="step-text">Upload Excel</span>
        </div>
        <div class="progress-step" id="step2">
          <span class="step-icon">2Ô∏è‚É£</span>
          <span class="step-text">L·∫•y d·ªØ li·ªáu s·∫£n ph·∫©m</span>
        </div>
        <div class="progress-step" id="step3">
          <span class="step-icon">3Ô∏è‚É£</span>
          <span class="step-text">L·∫•y chi ti·∫øt s·∫£n ph·∫©m</span>
        </div>
      </div>

      <div class="edit-section" id="editSection">
        <h2>‚úèÔ∏è Ch·ªânh S·ª≠a D·ªØ Li·ªáu S·∫£n Ph·∫©m</h2>
        <div class="edit-table" id="editTable"></div>
        <button class="btn-continue" id="continueBtn">
          ‚ñ∂Ô∏è Ti·∫øp T·ª•c: X·ª≠ L√Ω ·∫¢nh & Upload
        </button>
      </div>

      <div class="result" id="result">
        <h2>‚úÖ K·∫øt Qu·∫£ Cu·ªëi C√πng</h2>
        <div class="json-container" id="resultContainer"></div>
        <div id="notification" class="notification"></div>
      </div>

      <!-- AttributeLines Modal -->
      <div class="modal" id="attributeModal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>‚úèÔ∏è Ch·ªânh S·ª≠a Thu·ªôc T√≠nh</h3>
            <button class="modal-close" onclick="closeAttributeModal()">
              √ó
            </button>
          </div>

          <div class="attribute-tabs">
            <button
              class="attribute-tab active"
              onclick="switchTab('sizeText')"
            >
              üìè Size Ch·ªØ
            </button>
            <button class="attribute-tab" onclick="switchTab('color')">
              üé® M√†u
            </button>
            <button class="attribute-tab" onclick="switchTab('sizeNumber')">
              üî¢ Size S·ªë
            </button>
          </div>

          <div class="tab-content active" id="tab-sizeText">
            <div class="size-selector">
              <label>Ch·ªçn Size Ch·ªØ:</label>
              <select id="sizeTextSelect">
                <option value="">-- Ch·ªçn size --</option>
              </select>
            </div>
            <div class="selected-sizes">
              <strong>Sizes ƒë√£ ch·ªçn:</strong>
              <div id="sizeTextChips"></div>
            </div>
          </div>

          <div class="tab-content" id="tab-color">
            <div class="size-selector">
              <label>Ch·ªçn M√†u:</label>
              <select id="colorSelect">
                <option value="">-- Ch·ªçn m√†u --</option>
              </select>
            </div>
            <div class="selected-sizes">
              <strong>M√†u ƒë√£ ch·ªçn:</strong>
              <div id="colorChips"></div>
            </div>
          </div>

          <div class="tab-content" id="tab-sizeNumber">
            <div class="size-selector">
              <label>Ch·ªçn Size S·ªë:</label>
              <select id="sizeNumberSelect">
                <option value="">-- Ch·ªçn size --</option>
              </select>
            </div>
            <div class="selected-sizes">
              <strong>Sizes ƒë√£ ch·ªçn:</strong>
              <div id="sizeNumberChips"></div>
            </div>
          </div>

          <div class="modal-actions">
            <button
              class="modal-btn modal-btn-cancel"
              onclick="closeAttributeModal()"
            >
              H·ªßy
            </button>
            <button
              class="modal-btn modal-btn-save"
              onclick="saveAttributeLines()"
            >
              L∆∞u
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "https://tomato.tpos.vn/odata/ProductTemplate";

      const $ = (id) => document.getElementById(id);
      const show = (el, visible = true) => el.classList.toggle("show", visible);

      let excelFile = null;
      let imageFile = null;
      let productDetail = null;
      let currentAttributeLines = [];

      const showNotification = (message, type = "success") => {
        const notification = $("notification");
        notification.textContent = message;
        notification.className = `notification ${type} show`;

        setTimeout(() => {
          notification.classList.remove("show");
        }, 5000);
      };

      const generateRandomId = () => {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          },
        );
      };

      const getHeaders = () => ({
        accept: "application/json, text/plain, */*",
        "accept-encoding": "gzip, deflate, br",
        "accept-language": "vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7",
        authorization: AUTH_TOKEN,
        "content-type": "application/json;charset=UTF-8",
        origin: "https://tomato.tpos.vn",
        referer: "https://tomato.tpos.vn/",
        "sec-ch-ua":
          '"Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24"',
        "sec-ch-ua-mobile": "?0",
        "sec-ch-ua-platform": '"Windows"',
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors",
        "sec-fetch-site": "same-origin",
        tposappversion: "5.9.10.1",
        "user-agent":
          "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
        "x-request-id": generateRandomId(),
      });

      const availableAttributes = {
        sizeText: {
          id: 1,
          name: "Size Ch·ªØ",
          code: "SZCh",
          values: [
            { Id: 31, Name: "XXL", Code: "xxl", Sequence: null },
            { Id: 32, Name: "XXXL", Code: "xxxl", Sequence: null },
            { Id: 5, Name: "Free Size", Code: "FS", Sequence: 0 },
            { Id: 1, Name: "S", Code: "S", Sequence: 1 },
            { Id: 2, Name: "M", Code: "M", Sequence: 2 },
            { Id: 3, Name: "L", Code: "L", Sequence: 3 },
            { Id: 4, Name: "XL", Code: "XL", Sequence: 4 },
          ],
        },
        color: {
          id: 3,
          name: "M√†u",
          code: "Mau",
          values: [
            { Id: 6, Name: "Tr·∫Øng", Code: "trang", Sequence: null },
            { Id: 7, Name: "ƒêen", Code: "den", Sequence: null },
            { Id: 8, Name: "ƒê·ªè", Code: "do", Sequence: null },
            { Id: 9, Name: "V√†ng", Code: "vang", Sequence: null },
            { Id: 10, Name: "Cam", Code: "cam", Sequence: null },
            { Id: 11, Name: "X√°m", Code: "xam", Sequence: null },
            { Id: 12, Name: "H·ªìng", Code: "hong", Sequence: null },
          ],
        },
        sizeNumber: {
          id: 4,
          name: "Size S·ªë",
          code: "SZNu",
          values: [
            { Id: 18, Name: "29", Code: "29", Sequence: null },
            { Id: 19, Name: "30", Code: "30", Sequence: null },
            { Id: 20, Name: "31", Code: "31", Sequence: null },
            { Id: 21, Name: "32", Code: "32", Sequence: null },
          ],
        },
      };

      const expandPresets = {
        basic: "UOM,Categ,UOMPO,POSCateg,ProductVariants,Images",
        full: "UOM,UOMCateg,Categ,UOMPO,POSCateg,Taxes,SupplierTaxes,Product_Teams,Images,UOMView,Distributor,Importer,Producer,OriginCountry,ProductVariants($expand=UOM,Categ,UOMPO,POSCateg,AttributeValues),AttributeLines,UOMLines($expand=UOM),ComboProducts,ProductSupplierInfos",
        minimal: "UOM,Categ,ProductVariants",
      };

      window.setExpandPreset = (preset) => {
        $("expandInput").value = expandPresets[preset];
      };

      window.clearExpand = () => {
        $("expandInput").value = "";
      };

      const toBase64 = (file) =>
        new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result.split(",")[1]);
          reader.onerror = reject;
        });

      const setStepStatus = (stepId, status) => {
        const step = $(stepId);
        const stepText = step.querySelector(".step-text").textContent;
        step.className = `progress-step ${status}`;

        if (status === "active") {
          step.innerHTML = `<div class="loader"></div><span class="step-text">${stepText}</span>`;
        } else if (status === "success") {
          step.innerHTML = `<span class="step-icon">‚úÖ</span><span class="step-text">${stepText}</span>`;
        } else if (status === "error") {
          step.innerHTML = `<span class="step-icon">‚ùå</span><span class="step-text">${stepText}</span>`;
        }
      };

      const renderEditTable = (data) => {
        let html =
          '<table><thead><tr><th style="width: 30%">Tr∆∞·ªùng</th><th>Gi√° Tr·ªã</th></tr></thead><tbody>';

        if (data.AttributeLines !== undefined) {
          const jsonStr = JSON.stringify(data.AttributeLines, null, 2);
          html += `<tr>
            <td class="field-key">AttributeLines <span style="color: #999; font-size: 11px;">(Thu·ªôc t√≠nh)</span></td>
            <td>
              <button class="special-edit-btn" onclick="openAttributeModal()">‚úèÔ∏è Ch·ªânh S·ª≠a Thu·ªôc T√≠nh</button>
              <textarea data-field="AttributeLines" data-type="json" style="min-height: 120px; display: none;">${jsonStr}</textarea>
            </td>
          </tr>`;
        }

        html += "</tbody></table>";
        $("editTable").innerHTML = html;
      };

      const getEditedData = () => {
        const inputs = $("editTable").querySelectorAll("input, textarea");
        const edited = { ...productDetail };

        inputs.forEach((input) => {
          const field = input.getAttribute("data-field");
          const dataType = input.getAttribute("data-type");
          let value = input.value;

          if (dataType === "json") {
            try {
              value = JSON.parse(value);
            } catch (e) {
              console.error(`Failed to parse JSON for field ${field}:`, e);
              showNotification(
                `L·ªói JSON ·ªü tr∆∞·ªùng "${field}". Vui l√≤ng ki·ªÉm tra l·∫°i c√∫ ph√°p JSON.`,
                "error",
              );
              throw e;
            }
          } else if (input.type === "number") {
            value = value === "" ? null : Number(value);
          } else if (value === "") {
            value = null;
          }

          edited[field] = value;
        });

        return edited;
      };

      $("excelBox").addEventListener("click", () => $("excelInput").click());
      $("excelInput").addEventListener("change", (e) => {
        excelFile = e.target.files[0];
        if (excelFile) {
          $("excelBox").classList.add("selected");
          $("excelPreview").textContent =
            `üìÑ ${excelFile.name} (${(excelFile.size / 1024).toFixed(2)} KB)`;
          show($("excelPreview"));
        }
      });

      $("imageBox").addEventListener("click", () => $("imageInput").click());
      $("imageInput").addEventListener("change", async (e) => {
        imageFile = e.target.files[0];
        if (imageFile) {
          $("imageBox").classList.add("selected");
          $("imageFileName").textContent = `üñºÔ∏è ${imageFile.name}`;
          show($("imageFileName"));

          const base64 = await toBase64(imageFile);
          $("previewImg").src = `data:${imageFile.type};base64,${base64}`;
          show($("imagePreview"));
        }
      });

      $("processBtn").addEventListener("click", async () => {
        if (!excelFile || !imageFile) {
          showNotification(
            "Vui l√≤ng ch·ªçn c·∫£ file Excel v√† h√¨nh ·∫£nh!",
            "warning",
          );
          return;
        }

        const expandValue = $("expandInput").value.trim();
        if (!expandValue) {
          showNotification("Vui l√≤ng nh·∫≠p expand parameters!", "warning");
          return;
        }

        const btn = $("processBtn");
        btn.disabled = true;
        show($("progress"));
        show($("editSection"), false);
        show($("result"), false);

        try {
          setStepStatus("step1", "active");
          const excelBase64 = await toBase64(excelFile);
          const uploadRes = await fetch(
            `${API_BASE}/ODataService.ActionImportSimple`,
            {
              method: "POST",
              headers: getHeaders(),
              body: JSON.stringify({
                do_inventory: false,
                file: excelBase64,
                version: "2701",
              }),
            },
          );
          if (!uploadRes.ok) throw new Error("Upload Excel th·∫•t b·∫°i");
          await uploadRes.json();
          setStepStatus("step1", "success");
          await new Promise((r) => setTimeout(r, 500));

          setStepStatus("step2", "active");
          const listRes = await fetch(`${API_BASE}/ODataService.GetViewV2`, {
            headers: getHeaders(),
          });
          const listData = await listRes.json();
          if (!listRes.ok) throw new Error("L·∫•y danh s√°ch th·∫•t b·∫°i");

          const items = (listData.value || listData).filter(
            (item) => item.CreatedByName === "T√∫",
          );
          if (items.length === 0)
            throw new Error('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m c·ªßa "T√∫"');

          const latestProduct = items.reduce((max, item) =>
            item.Id > max.Id ? item : max,
          );
          const productId = latestProduct.Id;
          setStepStatus("step2", "success");
          await new Promise((r) => setTimeout(r, 500));

          setStepStatus("step3", "active");
          const detailRes = await fetch(
            `${API_BASE}(${productId})?$expand=${encodeURIComponent(expandValue)}`,
            { headers: getHeaders() },
          );
          if (!detailRes.ok) throw new Error("L·∫•y chi ti·∫øt th·∫•t b·∫°i");

          productDetail = await detailRes.json();
          setStepStatus("step3", "success");

          renderEditTable(productDetail);
          show($("editSection"));

          $("editSection").scrollIntoView({ behavior: "smooth" });
        } catch (err) {
          showNotification(`L·ªói: ${err.message}`, "error");
          console.error(err);
        } finally {
          btn.disabled = false;
        }
      });

      $("continueBtn").addEventListener("click", async () => {
        const btn = $("continueBtn");
        btn.disabled = true;
        btn.textContent = "‚è≥ ƒêang x·ª≠ l√Ω...";

        try {
          const imageBase64 = await toBase64(imageFile);
          const finalData = getEditedData();
          delete finalData["@odata.context"];
          finalData.Image = imageBase64;

          const updateRes = await fetch(`${API_BASE}/ODataService.UpdateV2`, {
            method: "POST",
            headers: getHeaders(),
            body: JSON.stringify(finalData),
          });

          const result = await updateRes.json();

          if (updateRes.ok) {
            $("resultContainer").innerHTML =
              `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            show($("result"));
            showNotification("C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success");
            $("result").scrollIntoView({ behavior: "smooth" });
          } else {
            throw new Error(result.error || "C·∫≠p nh·∫≠t th·∫•t b·∫°i");
          }
        } catch (err) {
          showNotification(`L·ªói: ${err.message}`, "error");
          console.error(err);
        } finally {
          btn.disabled = false;
          btn.textContent = "‚ñ∂Ô∏è Ti·∫øp T·ª•c: X·ª≠ L√Ω ·∫¢nh & Upload";
        }
      });

      let currentTab = "sizeText";

      window.switchTab = (tabName) => {
        currentTab = tabName;

        document.querySelectorAll(".attribute-tab").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.onclick.toString().includes(tabName)) {
            btn.classList.add("active");
          }
        });

        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`tab-${tabName}`).classList.add("active");
      };

      window.openAttributeModal = () => {
        const textarea = document.querySelector(
          'textarea[data-field="AttributeLines"]',
        );
        if (textarea) {
          try {
            const attributeLines = JSON.parse(textarea.value);
            currentAttributeLines = attributeLines;
          } catch (e) {
            currentAttributeLines = [];
          }
        }

        populateSelect("sizeTextSelect", availableAttributes.sizeText.values);
        populateSelect("colorSelect", availableAttributes.color.values);
        populateSelect(
          "sizeNumberSelect",
          availableAttributes.sizeNumber.values,
        );

        renderChips("sizeText");
        renderChips("color");
        renderChips("sizeNumber");

        show($("attributeModal"));
      };

      const populateSelect = (selectId, values) => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Ch·ªçn --</option>';
        values.forEach((item) => {
          select.innerHTML += `<option value="${item.Id}">${item.Name}</option>`;
        });
      };

      window.closeAttributeModal = () => {
        show($("attributeModal"), false);
      };

      const getAttributeLineByType = (type) => {
        const attrConfig = availableAttributes[type];
        return currentAttributeLines.find(
          (line) => line.AttributeId === attrConfig.id,
        );
      };

      const renderChips = (type) => {
        const attrConfig = availableAttributes[type];
        const chipsContainer = document.getElementById(`${type}Chips`);
        chipsContainer.innerHTML = "";

        const attrLine = getAttributeLineByType(type);

        if (!attrLine || !attrLine.Values || attrLine.Values.length === 0) {
          chipsContainer.innerHTML =
            '<p style="color: #999; font-size: 13px; margin-top: 10px;">Ch∆∞a c√≥ gi√° tr·ªã n√†o</p>';
          return;
        }

        attrLine.Values.forEach((val) => {
          const chip = document.createElement("div");
          chip.className = "size-chip";
          chip.innerHTML = `
            <span>${val.Name}</span>
            <button class="size-chip-remove" onclick="removeValue('${type}', ${val.Id})">√ó</button>
          `;
          chipsContainer.appendChild(chip);
        });
      };

      ["sizeText", "color", "sizeNumber"].forEach((type) => {
        const selectId = `${type}Select`;
        const select = document.getElementById(selectId);

        if (select) {
          select.addEventListener("change", (e) => {
            const valueId = parseInt(e.target.value);
            if (!valueId) return;

            const attrConfig = availableAttributes[type];
            const selectedValue = attrConfig.values.find(
              (v) => v.Id === valueId,
            );
            if (!selectedValue) return;

            if (!currentAttributeLines) {
              currentAttributeLines = [];
            }

            let attrLine = getAttributeLineByType(type);

            if (!attrLine) {
              attrLine = {
                Attribute: {
                  Id: attrConfig.id,
                  Name: attrConfig.name,
                  Code: attrConfig.code,
                  Sequence: type === "sizeText" ? 1 : null,
                  CreateVariant: true,
                },
                Values: [],
                AttributeId: attrConfig.id,
              };
              currentAttributeLines.push(attrLine);
            }

            if (!attrLine.Values || !Array.isArray(attrLine.Values)) {
              attrLine.Values = [];
            }

            const existingValue = attrLine.Values.find((v) => v.Id === valueId);
            if (existingValue) {
              showNotification("Gi√° tr·ªã n√†y ƒë√£ ƒë∆∞·ª£c th√™m r·ªìi!", "warning");
              e.target.value = "";
              return;
            }

            attrLine.Values.push({
              Id: selectedValue.Id,
              Name: selectedValue.Name,
              Code: selectedValue.Code,
              Sequence: selectedValue.Sequence,
              AttributeId: attrConfig.id,
              AttributeName: attrConfig.name,
              PriceExtra: null,
              NameGet: `${attrConfig.name}: ${selectedValue.Name}`,
              DateCreated: null,
            });

            renderChips(type);
            e.target.value = "";
          });
        }
      });

      window.removeValue = (type, valueId) => {
        const attrLine = getAttributeLineByType(type);
        if (!attrLine) return;

        attrLine.Values = attrLine.Values.filter((v) => v.Id !== valueId);

        if (attrLine.Values.length === 0) {
          currentAttributeLines = currentAttributeLines.filter(
            (line) => line.AttributeId !== attrLine.AttributeId,
          );
        }

        renderChips(type);
      };

      window.saveAttributeLines = () => {
        const textarea = document.querySelector(
          'textarea[data-field="AttributeLines"]',
        );
        if (textarea) {
          textarea.value = JSON.stringify(currentAttributeLines, null, 2);
        }

        closeAttributeModal();
        showNotification("ƒê√£ l∆∞u thay ƒë·ªïi AttributeLines!", "success");
      };
    </script>
  </body>
</html>
