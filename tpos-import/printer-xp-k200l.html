<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XP-K200L Web Serial Printer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
        }

        .card-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .card-body {
            padding: 24px;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .alert-info {
            background: #dbeafe;
            border: 2px solid #60a5fa;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            border: 2px solid #34d399;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            border: 2px solid #f87171;
            color: #991b1b;
        }

        .alert-warning {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            color: #92400e;
        }

        .alert-icon {
            font-size: 20px;
            margin-top: 2px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .status-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-icon {
            font-size: 28px;
        }

        .status-text h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .status-text p {
            font-size: 14px;
            color: #6b7280;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .badge-success {
            background: #10b981;
            color: white;
        }

        .badge-secondary {
            background: #6b7280;
            color: white;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            width: 100%;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .radio-group {
            margin-bottom: 20px;
        }

        .radio-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 12px;
            color: #374151;
        }

        .radio-option {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .radio-option:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .radio-option.active {
            border-color: #10b981;
            background: #d1fae5;
            border-width: 3px;
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-label {
            flex: 1;
        }

        .radio-label .title {
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .radio-label .desc {
            font-size: 13px;
            color: #6b7280;
        }

        .radio-option.active .title {
            color: #065f46;
        }

        .radio-option.active .desc {
            color: #047857;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .hidden {
            display: none;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .instructions {
            font-size: 14px;
            line-height: 1.6;
        }

        .instructions div {
            padding: 4px 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .card-header, .card-body {
                padding: 16px;
            }

            .card-header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1>
                    <span>üñ®Ô∏è</span>
                    XP-K200L - In tr·ª±c ti·∫øp qua USB
                </h1>
                <p>Kh√¥ng c·∫ßn Bridge Server ‚Ä¢ Kh√¥ng c√≥ Dialog popup l√†m phi·ªÅn</p>
            </div>
            <div class="card-body">
                <!-- Browser Support Alert -->
                <div id="browserAlert" class="alert alert-error hidden">
                    <span class="alert-icon">‚ùå</span>
                    <div class="alert-content">
                        <div class="alert-title">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Serial API</div>
                        <div>
                            Vui l√≤ng s·ª≠ d·ª•ng Chrome 89+, Edge 89+, ho·∫∑c Opera 75+<br>
                            <strong>Ho·∫∑c d√πng Bridge Server</strong> (gi·∫£i ph√°p kh√°c)
                        </div>
                    </div>
                </div>

                <!-- Info Alert -->
                <div class="alert alert-info">
                    <span class="alert-icon">‚ú®</span>
                    <div class="alert-content">
                        <div class="alert-title">Web Serial API</div>
                        <div class="instructions">
                            <div>‚úÖ K·∫øt n·ªëi USB tr·ª±c ti·∫øp t·ª´ tr√¨nh duy·ªát</div>
                            <div>‚úÖ Kh√¥ng c·∫ßn c√†i ƒë·∫∑t ph·∫ßn m·ªÅm</div>
                            <div>‚úÖ Kh√¥ng c√≥ popup l√†m phi·ªÅn (ch·ªâ h·ªèi 1 l·∫ßn ƒë·∫ßu)</div>
                            <div>‚ö†Ô∏è Ch·ªâ ho·∫°t ƒë·ªông tr√™n Chrome/Edge/Opera</div>
                        </div>
                    </div>
                </div>

                <!-- Status Box -->
                <div class="status-box">
                    <div class="status-info">
                        <span class="status-icon">üñ®Ô∏è</span>
                        <div class="status-text">
                            <h3>Tr·∫°ng th√°i k·∫øt n·ªëi</h3>
                            <p id="statusText">Ch∆∞a k·∫øt n·ªëi</p>
                        </div>
                    </div>
                    <span id="statusBadge" class="badge badge-secondary">Ch∆∞a k·∫øt n·ªëi</span>
                </div>

                <!-- Connection Buttons -->
                <div id="connectSection" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="connectPrinter()">
                        <span>üîå</span>
                        K·∫øt n·ªëi m√°y in USB
                    </button>
                </div>

                <div id="disconnectSection" class="hidden" style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="disconnectPrinter()">
                        Ng·∫Øt k·∫øt n·ªëi
                    </button>
                </div>

                <!-- Print Settings (Hidden until connected) -->
                <div id="printSettings" class="hidden">
                    <!-- Mode Selection -->
                    <div class="radio-group">
                        <label>Ch·∫ø ƒë·ªô encoding</label>
                        
                        <div class="radio-option active" onclick="selectMode('cp1258', this)">
                            <input type="radio" name="printMode" value="cp1258" checked>
                            <div class="radio-label">
                                <div class="title">‚úÖ CP1258 (C√≥ d·∫•u ƒë·∫ßy ƒë·ªß)</div>
                                <div class="desc">Hi·ªÉn th·ªã: "Xin ch√†o Vi·ªát Nam!" - Y√™u c·∫ßu m√°y in h·ªó tr·ª£ CP1258</div>
                            </div>
                        </div>

                        <div class="radio-option" onclick="selectMode('no-accents', this)">
                            <input type="radio" name="printMode" value="no-accents">
                            <div class="radio-label">
                                <div class="title">üîÑ NO-ACCENTS (B·ªè d·∫•u)</div>
                                <div class="desc">Hi·ªÉn th·ªã: "Xin chao Viet Nam!" - Ho·∫°t ƒë·ªông 100% m·ªçi m√°y in</div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Content -->
                    <div class="form-group">
                        <label for="testContent">N·ªôi dung in th·ª≠</label>
                        <textarea id="testContent" rows="10">================================
   XP-K200L TEST TI·∫æNG VI·ªÜT
================================
M√°y in: XP-K200L 80mm
Th·ªùi gian: [TIME]
--------------------------------
In th·ª≠ ti·∫øng Vi·ªát:
- Xin ch√†o Vi·ªát Nam!
- ƒê√¢y l√† b·∫£n in th·ª≠ nghi·ªám.
- C√°c k√Ω t·ª±: √°√†·∫£√£·∫° √©√®·∫ª·∫Ω·∫π
- Gi√°: 150,000 VNƒê
================================


</textarea>
                    </div>

                    <!-- Print Button -->
                    <button id="printBtn" class="btn btn-success" onclick="printTest()">
                        <span>üñ®Ô∏è</span>
                        In th·ª≠ (cp1258)
                    </button>
                </div>

                <!-- Result Alert (Hidden initially) -->
                <div id="resultAlert" class="alert hidden" style="margin-top: 20px;">
                    <span id="resultIcon" class="alert-icon"></span>
                    <div class="alert-content">
                        <div id="resultTitle" class="alert-title"></div>
                        <div id="resultMessage"></div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="alert alert-info" style="margin-top: 20px;">
                    <span class="alert-icon">üí°</span>
                    <div class="alert-content">
                        <div class="alert-title">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</div>
                        <div class="instructions">
                            <div>1. K·∫øt n·ªëi m√°y in XP-K200L qua c·ªïng USB v·ªõi m√°y t√≠nh</div>
                            <div>2. Click n√∫t "K·∫øt n·ªëi m√°y in USB"</div>
                            <div>3. Ch·ªçn c·ªïng COM trong popup (ch·ªâ 1 l·∫ßn duy nh·∫•t)</div>
                            <div>4. Ch·ªçn ch·∫ø ƒë·ªô: CP1258 (c√≥ d·∫•u) ho·∫∑c NO-ACCENTS (b·ªè d·∫•u)</div>
                            <div>5. Click "In th·ª≠" ƒë·ªÉ ki·ªÉm tra</div>
                            <div>6. Xem gi·∫•y in ƒë·ªÉ ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let port = null;
        let currentMode = 'cp1258';

        // CP1258 encoding map
        const CP1258_MAP = {
            '√†': '\xE0', '√°': '\xE1', '·∫£': '\xE3', '√£': '\xE3', '·∫°': '\xE1',
            '√®': '\xE8', '√©': '\xE9', '·∫ª': '\xEB', '·∫Ω': '\xEB', '·∫π': '\xE9',
            '√¨': '\xEC', '√≠': '\xED', '·ªâ': '\xEF', 'ƒ©': '\xEF', '·ªã': '\xED',
            '√≤': '\xF2', '√≥': '\xF3', '·ªè': '\xF5', '√µ': '\xF5', '·ªç': '\xF3',
            '√π': '\xF9', '√∫': '\xFA', '·ªß': '\xFC', '≈©': '\xFC', '·ª•': '\xFA',
            '·ª≥': '\xFD', '√Ω': '\xFD', '·ª∑': '\xFF', '·ªπ': '\xFF', '·ªµ': '\xFD',
            'ƒë': '\xF0', 'ƒê': '\xD0',
            '√Ä': '\xC0', '√Å': '\xC1', '·∫¢': '\xC3', '√É': '\xC3', '·∫†': '\xC1',
            '√à': '\xC8', '√â': '\xC9', '·∫∫': '\xCB', '·∫º': '\xCB', '·∫∏': '\xC9',
            '√å': '\xCC', '√ç': '\xCD', '·ªà': '\xCF', 'ƒ®': '\xCF', '·ªä': '\xCD',
            '√í': '\xD2', '√ì': '\xD3', '·ªé': '\xD5', '√ï': '\xD5', '·ªå': '\xD3',
            '√ô': '\xD9', '√ö': '\xDA', '·ª¶': '\xDC', '≈®': '\xDC', '·ª§': '\xDA',
            '·ª≤': '\xDD', '√ù': '\xDD', '·ª∂': '\xDF', '·ª∏': '\xDF', '·ª¥': '\xDD'
        };

        // Check browser support
        window.addEventListener('load', () => {
            if (!('serial' in navigator)) {
                document.getElementById('browserAlert').classList.remove('hidden');
                document.getElementById('connectSection').classList.add('hidden');
            }
        });

        // Convert to CP1258
        function convertToCP1258(text) {
            return text.split('').map(char => CP1258_MAP[char] || char).join('');
        }

        // Remove Vietnamese tones
        function removeVietnameseTones(str) {
            const tones = {
                '√†': 'a', '√°': 'a', '·∫£': 'a', '√£': 'a', '·∫°': 'a',
                'ƒÉ': 'a', '·∫±': 'a', '·∫Ø': 'a', '·∫≥': 'a', '·∫µ': 'a', '·∫∑': 'a',
                '√¢': 'a', '·∫ß': 'a', '·∫•': 'a', '·∫©': 'a', '·∫´': 'a', '·∫≠': 'a',
                'ƒë': 'd', '√®': 'e', '√©': 'e', '·∫ª': 'e', '·∫Ω': 'e', '·∫π': 'e',
                '√™': 'e', '·ªÅ': 'e', '·∫ø': 'e', '·ªÉ': 'e', '·ªÖ': 'e', '·ªá': 'e',
                '√¨': 'i', '√≠': 'i', '·ªâ': 'i', 'ƒ©': 'i', '·ªã': 'i',
                '√≤': 'o', '√≥': 'o', '·ªè': 'o', '√µ': 'o', '·ªç': 'o',
                '√¥': 'o', '·ªì': 'o', '·ªë': 'o', '·ªï': 'o', '·ªó': 'o', '·ªô': 'o',
                '∆°': 'o', '·ªù': 'o', '·ªõ': 'o', '·ªü': 'o', '·ª°': 'o', '·ª£': 'o',
                '√π': 'u', '√∫': 'u', '·ªß': 'u', '≈©': 'u', '·ª•': 'u',
                '∆∞': 'u', '·ª´': 'u', '·ª©': 'u', '·ª≠': 'u', '·ªØ': 'u', '·ª±': 'u',
                '·ª≥': 'y', '√Ω': 'y', '·ª∑': 'y', '·ªπ': 'y', '·ªµ': 'y',
                '√Ä': 'A', '√Å': 'A', '·∫¢': 'A', '√É': 'A', '·∫†': 'A',
                'ƒÇ': 'A', '·∫∞': 'A', '·∫Æ': 'A', '·∫≤': 'A', '·∫¥': 'A', '·∫∂': 'A',
                '√Ç': 'A', '·∫¶': 'A', '·∫§': 'A', '·∫®': 'A', '·∫™': 'A', '·∫¨': 'A',
                'ƒê': 'D', '√à': 'E', '√â': 'E', '·∫∫': 'E', '·∫º': 'E', '·∫∏': 'E',
                '√ä': 'E', '·ªÄ': 'E', '·∫æ': 'E', '·ªÇ': 'E', '·ªÑ': 'E', '·ªÜ': 'E',
                '√å': 'I', '√ç': 'I', '·ªà': 'I', 'ƒ®': 'I', '·ªä': 'I',
                '√í': 'O', '√ì': 'O', '·ªé': 'O', '√ï': 'O', '·ªå': 'O',
                '√î': 'O', '·ªí': 'O', '·ªê': 'O', '·ªî': 'O', '·ªñ': 'O', '·ªò': 'O',
                '∆†': 'O', '·ªú': 'O', '·ªö': 'O', '·ªû': 'O', '·ª†': 'O', '·ª¢': 'O',
                '√ô': 'U', '√ö': 'U', '·ª¶': 'U', '≈®': 'U', '·ª§': 'U',
                '∆Ø': 'U', '·ª™': 'U', '·ª®': 'U', '·ª¨': 'U', '·ªÆ': 'U', '·ª∞': 'U',
                '·ª≤': 'Y', '√ù': 'Y', '·ª∂': 'Y', '·ª∏': 'Y', '·ª¥': 'Y'
            };
            return str.split('').map(char => tones[char] || char).join('');
        }

        // Build ESC/POS commands
        function buildESCPOS(content, mode) {
            const commands = [];
            
            // Initialize
            commands.push(0x1B, 0x40); // ESC @
            
            // Set Code Page
            if (mode === 'cp1258') {
                commands.push(0x1B, 0x74, 0x1E); // ESC t 30
                content = convertToCP1258(content);
            } else if (mode === 'no-accents') {
                commands.push(0x1B, 0x74, 0x00); // ESC t 0
                content = removeVietnameseTones(content);
            }
            
            // Content
            for (let i = 0; i < content.length; i++) {
                commands.push(content.charCodeAt(i));
            }
            
            // Feed and cut
            commands.push(0x1B, 0x64, 0x03); // ESC d 3
            commands.push(0x1D, 0x56, 0x00); // GS V 0
            
            return new Uint8Array(commands);
        }

        // Select mode
        function selectMode(mode, element) {
            currentMode = mode;
            
            // Update UI
            document.querySelectorAll('.radio-option').forEach(option => {
                option.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update button text
            document.getElementById('printBtn').innerHTML = `<span>üñ®Ô∏è</span> In th·ª≠ (${mode})`;
        }

        // Connect to printer
        async function connectPrinter() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                
                // Update UI
                document.getElementById('statusText').textContent = 'ƒê√£ k·∫øt n·ªëi v·ªõi XP-K200L';
                document.getElementById('statusBadge').textContent = 'ƒê√£ k·∫øt n·ªëi';
                document.getElementById('statusBadge').className = 'badge badge-success';
                
                document.getElementById('connectSection').classList.add('hidden');
                document.getElementById('disconnectSection').classList.remove('hidden');
                document.getElementById('printSettings').classList.remove('hidden');
                
                showResult(true, 'Th√†nh c√¥ng', 'ƒê√£ k·∫øt n·ªëi v·ªõi m√°y in XP-K200L!');
            } catch (error) {
                showResult(false, 'L·ªói k·∫øt n·ªëi', error.message);
            }
        }

        // Disconnect printer
        async function disconnectPrinter() {
            if (port) {
                try {
                    await port.close();
                    port = null;
                    
                    // Update UI
                    document.getElementById('statusText').textContent = 'Ch∆∞a k·∫øt n·ªëi';
                    document.getElementById('statusBadge').textContent = 'Ch∆∞a k·∫øt n·ªëi';
                    document.getElementById('statusBadge').className = 'badge badge-secondary';
                    
                    document.getElementById('connectSection').classList.remove('hidden');
                    document.getElementById('disconnectSection').classList.add('hidden');
                    document.getElementById('printSettings').classList.add('hidden');
                    
                    showResult(true, 'Th√†nh c√¥ng', 'ƒê√£ ng·∫Øt k·∫øt n·ªëi m√°y in');
                } catch (error) {
                    showResult(false, 'L·ªói', error.message);
                }
            }
        }

        // Print test
        async function printTest() {
            if (!port) {
                showResult(false, 'L·ªói', 'Ch∆∞a k·∫øt n·ªëi m√°y in');
                return;
            }

            const printBtn = document.getElementById('printBtn');
            const originalHTML = printBtn.innerHTML;
            
            // Disable button
            printBtn.disabled = true;
            printBtn.innerHTML = '<div class="spinner"></div> ƒêang in...';

            try {
                let content = document.getElementById('testContent').value;
                content = content.replace('[TIME]', new Date().toLocaleString('vi-VN'));
                
                const data = buildESCPOS(content, currentMode);
                
                const writer = port.writable.getWriter();
                await writer.write(data);
                writer.releaseLock();
                
                showResult(true, 'In th√†nh c√¥ng', `‚úÖ ƒê√£ in v·ªõi ch·∫ø ƒë·ªô ${currentMode}! Ki·ªÉm tra gi·∫•y in.`);
            } catch (error) {
                showResult(false, 'L·ªói in', error.message);
            } finally {
                // Re-enable button
                printBtn.disabled = false;
                printBtn.innerHTML = originalHTML;
            }
        }

        // Show result
        function showResult(success, title, message) {
            const resultAlert = document.getElementById('resultAlert');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            
            resultAlert.className = 'alert ' + (success ? 'alert-success' : 'alert-error');
            resultIcon.textContent = success ? '‚úÖ' : '‚ùå';
            resultTitle.textContent = title;
            resultMessage.textContent = message;
            
            resultAlert.classList.remove('hidden');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                resultAlert.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
