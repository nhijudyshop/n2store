/**
 * =====================================================
 * XC80 Print Bridge v5.0 - CP1258 Vietnamese Support
 * =====================================================
 *
 * FULL CODE - Ready to use
 *
 * Features:
 * - Full Vietnamese support with CP1258 encoding
 * - Direct TCP/IP printing to thermal printers
 * - Bill printing format
 * - Test endpoints
 *
 * Requirements:
 * - Node.js 14+
 * - Printer configured with Code Page 30 (CP1258)
 *
 * Installation:
 * 1. npm install express cors iconv-lite
 * 2. node xc80-bridge-cp1258.js
 *
 * API Endpoints:
 * - POST /print        - Print text content
 * - POST /print-bill   - Print bill format
 * - POST /printers/test - Test connection
 * - GET  /health       - Health check
 * =====================================================
 */

const express = require("express");
const cors = require("cors");
const net = require("net");
const iconv = require("iconv-lite");

const app = express();
const PORT = 9100;

// Middleware
app.use(cors());
app.use(express.json({ limit: "10mb" }));

// ESC/POS Commands
const ESC = "\x1B";
const GS = "\x1D";
const FS = "\x1C";

/**
 * Generate ESC/POS commands with CP1258 encoding
 * @param {string} content - Text content to print
 * @param {object} options - Printing options
 * @returns {string} ESC/POS command string
 */
function generateESCPOS_CP1258(content, options = {}) {
  const align = options.align || "left";
  const bold = options.bold || false;
  const doubleSize = options.doubleSize || false;
  const feeds = options.feeds || 3;

  let commands = "";

  // 1. Initialize printer
  commands += ESC + "@";

  // 2. Set Code Page 30 (CP1258) for Vietnamese
  commands += ESC + "t" + String.fromCharCode(30);

  // 3. Set alignment
  const alignCode = align === "center" ? 1 : align === "right" ? 2 : 0;
  commands += ESC + "a" + String.fromCharCode(alignCode);

  // 4. Set text style
  if (bold) {
    commands += ESC + "E" + String.fromCharCode(1);
  }

  if (doubleSize) {
    commands += GS + "!" + String.fromCharCode(0x11); // Double width + height
  }

  // 5. Add content
  commands += content;

  // 6. Reset styles
  if (bold) {
    commands += ESC + "E" + String.fromCharCode(0);
  }
  if (doubleSize) {
    commands += GS + "!" + String.fromCharCode(0);
  }

  // 7. Feed paper
  commands += ESC + "d" + String.fromCharCode(feeds);

  // 8. Cut paper (full cut)
  commands += GS + "V" + String.fromCharCode(0);

  return commands;
}

/**
 * Generate bill format ESC/POS
 * @param {object} billData - Bill information
 * @returns {string} ESC/POS command string
 */
function generateBillESCPOS(billData) {
  let commands = "";

  // Initialize
  commands += ESC + "@";

  // Set CP1258
  commands += ESC + "t" + String.fromCharCode(30);

  // Center align
  commands += ESC + "a" + String.fromCharCode(1);

  // Double size - Order number
  commands += GS + "!" + String.fromCharCode(0x11);
  commands += `#${billData.sessionIndex} - ${billData.phone || "Ch∆∞a c√≥ SƒêT"}\n`;

  // Normal size + Bold - Customer name
  commands += GS + "!" + String.fromCharCode(0);
  commands += ESC + "E" + String.fromCharCode(1);
  commands += `${billData.customerName}\n`;
  commands += ESC + "E" + String.fromCharCode(0);

  // Product info
  const productName = billData.productName.replace(/^\d+\s+/, "");
  commands += `${billData.productCode} - ${productName}\n`;

  // Comment
  if (billData.comment) {
    commands += `"${billData.comment}"\n`;
  }

  // Separator
  commands += "--------------------------------\n";

  // Date/time
  const dateStr = new Date(billData.createdTime).toLocaleString("vi-VN", {
    timeZone: "Asia/Bangkok",
    hour12: false,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
  });
  commands += `${dateStr}\n`;

  // Feed and cut
  commands += ESC + "d" + String.fromCharCode(3);
  commands += GS + "V" + String.fromCharCode(0);

  return commands;
}

/**
 * Send data to printer via TCP
 * @param {string} ip - Printer IP address
 * @param {number} port - Printer port
 * @param {Buffer} data - Data to send
 * @returns {Promise}
 */
function sendToPrinter(ip, port, data) {
  return new Promise((resolve, reject) => {
    const client = new net.Socket();
    let timeout;

    // Set connection timeout
    client.setTimeout(5000);

    client.connect(port, ip, () => {
      console.log(`‚úÖ Connected to ${ip}:${port}`);
      client.write(data);

      // Auto-close after 2 seconds
      timeout = setTimeout(() => {
        client.end();
      }, 2000);
    });

    client.on("data", (response) => {
      console.log(
        "üì• Printer response:",
        response.toString("hex").substring(0, 100),
      );
    });

    client.on("close", () => {
      console.log("üîå Connection closed");
      clearTimeout(timeout);
      resolve({ success: true });
    });

    client.on("timeout", () => {
      console.error("‚è±Ô∏è Connection timeout");
      client.destroy();
      clearTimeout(timeout);
      reject(new Error("Connection timeout"));
    });

    client.on("error", (err) => {
      console.error("‚ùå Socket error:", err.message);
      clearTimeout(timeout);
      reject(err);
    });
  });
}

// =====================================================
// API ENDPOINTS
// =====================================================

/**
 * POST /print
 * Print text content with CP1258 encoding
 */
app.post("/print", async (req, res) => {
  try {
    const { ipAddress, port, content, options } = req.body;

    // Validate input
    if (!ipAddress || !port || !content) {
      return res.status(400).json({
        success: false,
        error: "Missing required fields: ipAddress, port, content",
      });
    }

    console.log(`\nüìù Print request (CP1258):`, {
      ip: ipAddress,
      port,
      contentLength: content.length,
      options: options || {},
    });

    // Generate ESC/POS commands
    const escposCommands = generateESCPOS_CP1258(content, options);

    // Encode to CP1258 (Windows-1258)
    const buffer = iconv.encode(escposCommands, "windows-1258");

    console.log(`üì¶ Buffer size: ${buffer.length} bytes`);
    console.log(
      `üî§ Content preview: ${content.substring(0, 100)}${content.length > 100 ? "..." : ""}`,
    );

    // Send to printer
    await sendToPrinter(ipAddress, port, buffer);

    const jobID = `CP1258-${Date.now()}`;
    console.log(`‚úÖ Print job ${jobID} completed successfully`);

    res.json({
      success: true,
      jobID,
      encoding: "CP1258",
      bytesWritten: buffer.length,
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    console.error("‚ùå Print error:", error.message);
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

/**
 * POST /print-bill
 * Print bill format with CP1258 encoding
 */
app.post("/print-bill", async (req, res) => {
  try {
    const { ipAddress, port, billData } = req.body;

    // Validate input
    if (!ipAddress || !port || !billData) {
      return res.status(400).json({
        success: false,
        error: "Missing required fields: ipAddress, port, billData",
      });
    }

    console.log(`\nüßæ Print bill (CP1258):`, {
      ip: ipAddress,
      port,
      orderNumber: billData.sessionIndex,
      customer: billData.customerName,
      product: billData.productCode,
    });

    // Generate bill ESC/POS
    const escposCommands = generateBillESCPOS(billData);

    // Encode to CP1258
    const buffer = iconv.encode(escposCommands, "windows-1258");

    console.log(`üì¶ Bill buffer size: ${buffer.length} bytes`);

    // Send to printer
    await sendToPrinter(ipAddress, port, buffer);

    const jobID = `BILL-${Date.now()}`;
    console.log(`‚úÖ Bill printed successfully: ${jobID}`);

    res.json({
      success: true,
      jobID,
      encoding: "CP1258",
      billNumber: billData.sessionIndex,
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    console.error("‚ùå Bill print error:", error.message);
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

/**
 * POST /printers/test
 * Test printer connection with Vietnamese test
 */
app.post("/printers/test", async (req, res) => {
  try {
    const { ipAddress, port } = req.body;

    // Validate input
    if (!ipAddress || !port) {
      return res.status(400).json({
        success: false,
        error: "Missing required fields: ipAddress, port",
      });
    }

    console.log(`\nüß™ Testing CP1258 on ${ipAddress}:${port}...`);

    // Test content with full Vietnamese characters
    const testContent =
      "================================\n" +
      "   TEST TI·∫æNG VI·ªÜT CP1258\n" +
      "================================\n" +
      "M√°y in: XC80 Thermal Printer\n" +
      "ƒê·ªãa ch·ªâ: " +
      ipAddress +
      ":" +
      port +
      "\n" +
      "--------------------------------\n" +
      "Test c√°c k√Ω t·ª± ti·∫øng Vi·ªát:\n" +
      "- Xin ch√†o Vi·ªát Nam! ‚úì\n" +
      "- ƒê√¢y l√† b·∫£n in th·ª≠ nghi·ªám\n" +
      "- √°√†·∫£√£·∫° √©√®·∫ª·∫Ω·∫π √≠√¨·ªâƒ©·ªã\n" +
      "- √≥√≤·ªè√µ·ªç √∫√π·ªß≈©·ª• √Ω·ª≥·ª∑·ªπ·ªµ\n" +
      "- ƒÇ·∫Æ·∫∞·∫≤·∫¥·∫∂ √ä·∫æ·ªÄ·ªÇ·ªÑ·ªÜ √î·ªê·ªí·ªî·ªñ·ªò\n" +
      "- ∆†·ªö·ªú·ªû·ª†·ª¢ ∆Ø·ª®·ª™·ª¨·ªÆ·ª∞ ƒê ƒë\n" +
      "- Gi√°: 150,000 VNƒê\n" +
      "================================\n" +
      "\n" +
      "‚úÖ N·∫øu th·∫•y ch·ªØ Vi·ªát ƒë√∫ng\n" +
      "   ‚Üí C·∫•u h√¨nh CP1258 th√†nh c√¥ng!\n" +
      "\n" +
      "‚ùå N·∫øu th·∫•y k√Ω t·ª± l·∫°\n" +
      "   ‚Üí M√°y in ch∆∞a h·ªó tr·ª£ CP1258\n" +
      "   ‚Üí D√πng mode NO-ACCENTS\n" +
      "================================\n\n";

    // Generate ESC/POS
    const escposCommands = generateESCPOS_CP1258(testContent, {
      align: "center",
      feeds: 3,
    });

    // Encode to CP1258
    const buffer = iconv.encode(escposCommands, "windows-1258");

    console.log(`üì¶ Test buffer size: ${buffer.length} bytes`);

    // Send to printer
    await sendToPrinter(ipAddress, port, buffer);

    console.log(`‚úÖ Test print completed`);

    res.json({
      success: true,
      message: "Test in ti·∫øng Vi·ªát th√†nh c√¥ng! Ki·ªÉm tra m√°y in.",
      encoding: "CP1258",
      testContentLength: testContent.length,
      instructions: [
        "N·∫øu th·∫•y ch·ªØ Vi·ªát c√≥ d·∫•u ƒë√∫ng ‚Üí M√°y in ƒë√£ h·ªó tr·ª£ CP1258",
        "N·∫øu th·∫•y k√Ω t·ª± l·∫° ‚Üí C·∫ßn c·∫•u h√¨nh Code Page 30 tr√™n m√°y in",
        "Ho·∫∑c d√πng mode NO-ACCENTS ƒë·ªÉ b·ªè d·∫•u",
      ],
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    console.error("‚ùå Test failed:", error.message);
    res.status(500).json({
      success: false,
      error: error.message,
      troubleshooting: [
        "Ki·ªÉm tra IP v√† Port c√≥ ƒë√∫ng kh√¥ng",
        "ƒê·∫£m b·∫£o m√°y in ƒë√£ b·∫≠t v√† k·∫øt n·ªëi m·∫°ng",
        "Ping th·ª≠ IP m√°y in: ping " + (req.body.ipAddress || "192.168.1.100"),
        "Ki·ªÉm tra firewall c√≥ ch·∫∑n port " + (req.body.port || 9100),
      ],
    });
  }
});

/**
 * GET /health
 * Health check endpoint
 */
app.get("/health", (req, res) => {
  res.json({
    status: "OK",
    version: "5.0.0-CP1258",
    encoding: "CP1258 (Windows-1258)",
    features: [
      "Full Vietnamese support with diacritics",
      "Bill printing format",
      "Text formatting (bold, size, align)",
      "TCP/IP direct printing",
    ],
    endpoints: {
      "POST /print": "Print text content",
      "POST /print-bill": "Print bill format",
      "POST /printers/test": "Test connection with Vietnamese",
      "GET /health": "Health check",
    },
    requirements: [
      "Printer must support Code Page 30 (CP1258)",
      "TCP port 9100 must be accessible",
      "Network connection to printer",
    ],
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
  });
});

/**
 * GET /
 * Root endpoint
 */
app.get("/", (req, res) => {
  res.json({
    name: "XC80 Print Bridge",
    version: "5.0.0-CP1258",
    status: "Running",
    message: "Vietnamese thermal printer bridge with CP1258 encoding",
    documentation: {
      health: "GET /",
      test: "POST /printers/test",
      print: "POST /print",
      bill: "POST /print-bill",
    },
  });
});

// Error handling middleware
app.use((err, req, res, next) => {
  console.error("Unhandled error:", err);
  res.status(500).json({
    success: false,
    error: "Internal server error",
    message: err.message,
  });
});

// Start server
app.listen(PORT, () => {
  console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                       ‚ïë
‚ïë       XC80 Print Bridge v5.0 - CP1258                ‚ïë
‚ïë                                                       ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                       ‚ïë
‚ïë  üöÄ Server Status: RUNNING                            ‚ïë
‚ïë  üåê Port: ${PORT}                                        ‚ïë
‚ïë  üìù Encoding: CP1258 (Windows-1258)                   ‚ïë
‚ïë  üáªüá≥ Vietnamese Support: FULL (with diacritics)       ‚ïë
‚ïë                                                       ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                       ‚ïë
‚ïë  üì° API Endpoints:                                    ‚ïë
‚ïë                                                       ‚ïë
‚ïë    GET  /health                                       ‚ïë
‚ïë         ‚Üí Health check v√† th√¥ng tin h·ªá th·ªëng          ‚ïë
‚ïë                                                       ‚ïë
‚ïë    POST /print                                        ‚ïë
‚ïë         ‚Üí In n·ªôi dung text v·ªõi CP1258                 ‚ïë
‚ïë         ‚Üí Body: { ipAddress, port, content, options } ‚ïë
‚ïë                                                       ‚ïë
‚ïë    POST /print-bill                                   ‚ïë
‚ïë         ‚Üí In h√≥a ƒë∆°n format chu·∫©n                     ‚ïë
‚ïë         ‚Üí Body: { ipAddress, port, billData }         ‚ïë
‚ïë                                                       ‚ïë
‚ïë    POST /printers/test                                ‚ïë
‚ïë         ‚Üí Test k·∫øt n·ªëi v√† in th·ª≠ ti·∫øng Vi·ªát          ‚ïë
‚ïë         ‚Üí Body: { ipAddress, port }                   ‚ïë
‚ïë                                                       ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                       ‚ïë
‚ïë  ‚úÖ Features:                                         ‚ïë
‚ïë     ‚Ä¢ Full Vietnamese characters (c√≥ d·∫•u ƒë·∫ßy ƒë·ªß)     ‚ïë
‚ïë     ‚Ä¢ Direct TCP/IP printing                          ‚ïë
‚ïë     ‚Ä¢ Bill format printing                            ‚ïë
‚ïë     ‚Ä¢ Text formatting support                         ‚ïë
‚ïë                                                       ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                       ‚ïë
‚ïë  ‚öôÔ∏è  Requirements:                                    ‚ïë
‚ïë     ‚Ä¢ M√°y in ph·∫£i c·∫•u h√¨nh Code Page 30 (CP1258)     ‚ïë
‚ïë     ‚Ä¢ Port 9100 ph·∫£i accessible                       ‚ïë
‚ïë     ‚Ä¢ Network connection t·ªõi m√°y in                   ‚ïë
‚ïë                                                       ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                       ‚ïë
‚ïë  üìö Quick Test:                                       ‚ïë
‚ïë     curl http://localhost:${PORT}/health                ‚ïë
‚ïë                                                       ‚ïë
‚ïë  üîß Configuration:                                    ‚ïë
‚ïë     D√πng XPrinter Tool ƒë·ªÉ set Code Page 30            ‚ïë
‚ïë     Ho·∫∑c ch·∫°y: node config-xc80-cp1258.js             ‚ïë
‚ïë                                                       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

‚úÖ Server is ready to accept connections!
üìç Listening on http://localhost:${PORT}
‚è∞ Started at ${new Date().toLocaleString("vi-VN")}

`);

  // Log system info
  console.log("System Information:");
  console.log("- Node.js version:", process.version);
  console.log("- Platform:", process.platform);
  console.log("- Architecture:", process.arch);
  console.log(
    "- Memory usage:",
    Math.round(process.memoryUsage().heapUsed / 1024 / 1024) + " MB",
  );
  console.log("\n");
});
