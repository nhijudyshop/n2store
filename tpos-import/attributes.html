<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Product Attribute Manager</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/lucide@latest"></script>
        <style>
            .json-display {
                background: #1e293b;
                color: #e2e8f0;
                font-family: "Courier New", monospace;
                font-size: 12px;
                max-height: 400px;
                overflow: auto;
            }
            .attribute-checkbox:checked + label {
                background: #3b82f6;
                color: white;
            }
        </style>
    </head>
    <body class="bg-gray-50 min-h-screen">
        <div class="container mx-auto p-6 max-w-7xl">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center gap-3 mb-6">
                    <i
                        data-lucide="package"
                        class="text-blue-600"
                        style="width: 32px; height: 32px"
                    ></i>
                    <h1 class="text-3xl font-bold text-gray-800">
                        Product Attribute Manager
                    </h1>
                </div>

                <!-- Step 1: GET Product -->
                <div class="mb-8">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="download" class="text-blue-600"></i>
                        <h2 class="text-xl font-semibold text-gray-700">
                            Bước 1: Lấy thông tin sản phẩm
                        </h2>
                    </div>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                >Product Template ID</label
                            >
                            <input
                                type="text"
                                id="productId"
                                value="107812"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                        </div>
                        <div class="flex items-end">
                            <button
                                onclick="getProduct()"
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                            >
                                <i
                                    data-lucide="search"
                                    style="width: 20px; height: 20px"
                                ></i>
                                GET Product
                            </button>
                        </div>
                    </div>
                    <div id="getStatus" class="mt-3"></div>
                    <div id="originalJson" class="mt-4 hidden">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">
                            Response JSON:
                        </h3>
                        <pre class="json-display p-4 rounded-lg"></pre>
                    </div>
                </div>

                <!-- Step 2: Select Attributes -->
                <div class="mb-8" id="attributeSection" style="display: none">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="tags" class="text-green-600"></i>
                        <h2 class="text-xl font-semibold text-gray-700">
                            Bước 2: Chọn Attributes
                        </h2>
                    </div>

                    <!-- Size Chữ -->
                    <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center gap-2 mb-3">
                            <input
                                type="checkbox"
                                id="enableSizeText"
                                class="w-5 h-5 text-blue-600"
                            />
                            <label
                                for="enableSizeText"
                                class="text-lg font-semibold text-gray-800"
                                >Size Chữ</label
                            >
                        </div>
                        <div
                            id="sizeTextOptions"
                            class="grid grid-cols-7 gap-2"
                            style="display: none"
                        >
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Size Số -->
                    <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center gap-2 mb-3">
                            <input
                                type="checkbox"
                                id="enableSizeNumber"
                                class="w-5 h-5 text-blue-600"
                            />
                            <label
                                for="enableSizeNumber"
                                class="text-lg font-semibold text-gray-800"
                                >Size Số</label
                            >
                        </div>
                        <div
                            id="sizeNumberOptions"
                            class="grid grid-cols-10 gap-2"
                            style="display: none"
                        >
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Màu -->
                    <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center gap-2 mb-3">
                            <input
                                type="checkbox"
                                id="enableColor"
                                class="w-5 h-5 text-blue-600"
                            />
                            <label
                                for="enableColor"
                                class="text-lg font-semibold text-gray-800"
                                >Màu</label
                            >
                        </div>
                        <div
                            id="colorOptions"
                            class="grid grid-cols-6 gap-2"
                            style="display: none"
                        >
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <button
                        onclick="generatePayload()"
                        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2"
                    >
                        <i
                            data-lucide="wand-2"
                            style="width: 20px; height: 20px"
                        ></i>
                        Generate Payload
                    </button>
                </div>

                <!-- Step 3: POST Payload -->
                <div id="payloadSection" style="display: none">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="upload" class="text-purple-600"></i>
                        <h2 class="text-xl font-semibold text-gray-700">
                            Bước 3: POST Payload
                        </h2>
                    </div>
                    <div id="payloadJson" class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">
                            Payload JSON:
                        </h3>
                        <pre class="json-display p-4 rounded-lg"></pre>
                    </div>
                    <button
                        onclick="postPayload()"
                        class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center gap-2"
                    >
                        <i
                            data-lucide="send"
                            style="width: 20px; height: 20px"
                        ></i>
                        POST to UpdateV2
                    </button>
                    <div id="postStatus" class="mt-3"></div>
                </div>
            </div>
        </div>

        <script>
            // Authorization token
            const AUTH_TOKEN =
                "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJDbGllbnRJZCI6InRtdFdlYkFwcCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiZGQxMGFkZmMtZjNhYy00YjcxLWE5ZDQtM2I3MWRhMjYwYzU5IiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6InNob3AxIiwiRGlzcGxheU5hbWUiOiJTaG9wIiwiQXZhdGFyVXJsIjoiIiwiU2VjdXJpdHlTdGFtcCI6IjVkODdiMDE1LWFlMjgtNDlkZS04NGY5LWNmMWE4ZTMyZjExNCIsIkNvbXBhbnlJZCI6IjEiLCJUZW5hbnRJZCI6InRvbWF0by50cG9zLnZuIiwiUm9sZUlkcyI6IjczMTU0MzU4LWQ1MGItNDA5ZS05OWZkLWE5ODQwMTNiNGVhNSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IkFkbWluaXN0cmF0b3JzIiwianRpIjoiYmU1NWE0MjUtZWVkYi00ZTlhLWJkYmItMmQxMTAwMDIzMDgxIiwiaWF0IjoiMTc1OTQwNTg0OSIsIm5iZiI6MTc1OTQwNTg0OSwiZXhwIjoxNzYwNzAxODQ5LCJpc3MiOiJodHRwczovL3RvbWF0by50cG9zLnZuIiwiYXVkIjoiaHR0cHM6Ly90b21hdG8udHBvcy52bixodHRwczovL3Rwb3Mudm4ifQ.hlvsyDGjg_5T18LUXd9VK59eX5gUsxYFmerBEFlsR-4";

            // Helper functions
            function generateRandomId() {
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
                    /[xy]/g,
                    function (c) {
                        const r = (Math.random() * 16) | 0;
                        const v = c === "x" ? r : (r & 0x3) | 0x8;
                        return v.toString(16);
                    },
                );
            }

            function getHeaders() {
                return {
                    accept: "application/json, text/plain, */*",
                    "accept-encoding": "gzip, deflate, br",
                    "accept-language": "vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7",
                    "content-type": "application/json;charset=UTF-8",
                    origin: "https://tomato.tpos.vn",
                    referer: "https://tomato.tpos.vn/",
                    "sec-ch-ua":
                        '"Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24"',
                    "sec-ch-ua-mobile": "?0",
                    "sec-ch-ua-platform": '"Windows"',
                    "sec-fetch-dest": "empty",
                    "sec-fetch-mode": "cors",
                    "sec-fetch-site": "same-origin",
                    tposappversion: "5.9.10.1",
                    "user-agent":
                        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
                    "x-request-id": generateRandomId(),
                    authorization: AUTH_TOKEN,
                };
            }

            // Attribute data
            const attributeData = {
                sizeText: [
                    {
                        Id: 5,
                        Name: "Free Size",
                        Code: "FS",
                        Sequence: 0,
                        AttributeId: 1,
                        AttributeName: "Size Chữ",
                    },
                    {
                        Id: 1,
                        Name: "S",
                        Code: "S",
                        Sequence: 1,
                        AttributeId: 1,
                        AttributeName: "Size Chữ",
                    },
                    {
                        Id: 2,
                        Name: "M",
                        Code: "M",
                        Sequence: 2,
                        AttributeId: 1,
                        AttributeName: "Size Chữ",
                    },
                    {
                        Id: 3,
                        Name: "L",
                        Code: "L",
                        Sequence: 3,
                        AttributeId: 1,
                        AttributeName: "Size Chữ",
                    },
                    {
                        Id: 4,
                        Name: "XL",
                        Code: "XL",
                        Sequence: 4,
                        AttributeId: 1,
                        AttributeName: "Size Chữ",
                    },
                    {
                        Id: 31,
                        Name: "XXL",
                        Code: "xxl",
                        Sequence: null,
                        AttributeId: 1,
                        AttributeName: "Size Chữ",
                    },
                    {
                        Id: 32,
                        Name: "XXXL",
                        Code: "xxxl",
                        Sequence: null,
                        AttributeId: 1,
                        AttributeName: "Size Chữ",
                    },
                ],
                sizeNumber: [
                    {
                        Id: 80,
                        Name: "27",
                        Code: "27",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 81,
                        Name: "28",
                        Code: "28",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 18,
                        Name: "29",
                        Code: "29",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 19,
                        Name: "30",
                        Code: "30",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 20,
                        Name: "31",
                        Code: "31",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 21,
                        Name: "32",
                        Code: "32",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 46,
                        Name: "34",
                        Code: "34",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 33,
                        Name: "35",
                        Code: "35",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 34,
                        Name: "36",
                        Code: "36",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 35,
                        Name: "37",
                        Code: "37",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 36,
                        Name: "38",
                        Code: "38",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 37,
                        Name: "39",
                        Code: "39",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 44,
                        Name: "40",
                        Code: "40",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 91,
                        Name: "41",
                        Code: "41",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 92,
                        Name: "42",
                        Code: "42",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 93,
                        Name: "43",
                        Code: "43",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 94,
                        Name: "44",
                        Code: "44",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 22,
                        Name: "1",
                        Code: "1",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 23,
                        Name: "2",
                        Code: "2",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 24,
                        Name: "3",
                        Code: "3",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                    {
                        Id: 48,
                        Name: "4",
                        Code: "4",
                        AttributeId: 4,
                        AttributeName: "Size Số",
                    },
                ],
                color: [
                    {
                        Id: 6,
                        Name: "Trắng",
                        Code: "trang",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                    {
                        Id: 7,
                        Name: "Đen",
                        Code: "den",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                    {
                        Id: 8,
                        Name: "Đỏ",
                        Code: "do",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                    {
                        Id: 11,
                        Name: "Xám",
                        Code: "xam",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                    {
                        Id: 12,
                        Name: "Hồng",
                        Code: "hong",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                    {
                        Id: 15,
                        Name: "Nâu",
                        Code: "nau",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                    {
                        Id: 17,
                        Name: "Xanh",
                        Code: "xanh",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                    {
                        Id: 9,
                        Name: "Vàng",
                        Code: "vang",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                    {
                        Id: 10,
                        Name: "Cam",
                        Code: "cam",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                    {
                        Id: 14,
                        Name: "Nude",
                        Code: "nude",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                    {
                        Id: 16,
                        Name: "Rêu",
                        Code: "reu",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                    {
                        Id: 26,
                        Name: "Tím",
                        Code: "tim",
                        AttributeId: 3,
                        AttributeName: "Màu",
                    },
                ],
            };

            let originalProduct = null;
            let generatedPayload = null;

            // Initialize
            document.addEventListener("DOMContentLoaded", function () {
                lucide.createIcons();
                populateAttributeOptions();
                setupEventListeners();
            });

            function setupEventListeners() {
                document
                    .getElementById("enableSizeText")
                    .addEventListener("change", function () {
                        document.getElementById(
                            "sizeTextOptions",
                        ).style.display = this.checked ? "grid" : "none";
                    });
                document
                    .getElementById("enableSizeNumber")
                    .addEventListener("change", function () {
                        document.getElementById(
                            "sizeNumberOptions",
                        ).style.display = this.checked ? "grid" : "none";
                    });
                document
                    .getElementById("enableColor")
                    .addEventListener("change", function () {
                        document.getElementById("colorOptions").style.display =
                            this.checked ? "grid" : "none";
                    });
            }

            function populateAttributeOptions() {
                // Size Chữ
                const sizeTextContainer =
                    document.getElementById("sizeTextOptions");
                attributeData.sizeText.forEach((attr) => {
                    const div = document.createElement("div");
                    div.innerHTML = `
                    <input type="checkbox" id="size_${attr.Id}" class="attribute-checkbox hidden" value='${JSON.stringify(attr)}'>
                    <label for="size_${attr.Id}" class="block px-3 py-2 border border-gray-300 rounded cursor-pointer hover:bg-blue-50 text-center transition">
                        ${attr.Name}
                    </label>
                `;
                    sizeTextContainer.appendChild(div);
                });

                // Size Số
                const sizeNumberContainer =
                    document.getElementById("sizeNumberOptions");
                attributeData.sizeNumber.forEach((attr) => {
                    const div = document.createElement("div");
                    div.innerHTML = `
                    <input type="checkbox" id="sizenum_${attr.Id}" class="attribute-checkbox hidden" value='${JSON.stringify(attr)}'>
                    <label for="sizenum_${attr.Id}" class="block px-2 py-2 border border-gray-300 rounded cursor-pointer hover:bg-blue-50 text-center transition text-sm">
                        ${attr.Name}
                    </label>
                `;
                    sizeNumberContainer.appendChild(div);
                });

                // Màu
                const colorContainer = document.getElementById("colorOptions");
                attributeData.color.forEach((attr) => {
                    const div = document.createElement("div");
                    div.innerHTML = `
                    <input type="checkbox" id="color_${attr.Id}" class="attribute-checkbox hidden" value='${JSON.stringify(attr)}'>
                    <label for="color_${attr.Id}" class="block px-3 py-2 border border-gray-300 rounded cursor-pointer hover:bg-blue-50 text-center transition">
                        ${attr.Name}
                    </label>
                `;
                    colorContainer.appendChild(div);
                });
            }

            async function getProduct() {
                const productId = document.getElementById("productId").value;
                const statusDiv = document.getElementById("getStatus");

                statusDiv.innerHTML =
                    '<div class="flex items-center gap-2 text-blue-600"><i data-lucide="loader-2" class="animate-spin"></i> Đang tải...</div>';
                lucide.createIcons();

                try {
                    const url = `https://tomato.tpos.vn/odata/ProductTemplate(${productId})?$expand=UOM,UOMCateg,Categ,UOMPO,POSCateg,Taxes,SupplierTaxes,Product_Teams,Images,UOMView,Distributor,Importer,Producer,OriginCountry,ProductVariants($expand=UOM,Categ,UOMPO,POSCateg,AttributeValues)`;

                    const response = await fetch(url, {
                        method: "GET",
                        headers: getHeaders(),
                    });
                    const data = await response.json();

                    originalProduct = data;

                    document
                        .getElementById("originalJson")
                        .classList.remove("hidden");
                    document
                        .getElementById("originalJson")
                        .querySelector("pre").textContent = JSON.stringify(
                        data,
                        null,
                        2,
                    );
                    document.getElementById("attributeSection").style.display =
                        "block";

                    statusDiv.innerHTML =
                        '<div class="flex items-center gap-2 text-green-600"><i data-lucide="check-circle"></i> Thành công!</div>';
                    lucide.createIcons();
                } catch (error) {
                    statusDiv.innerHTML = `<div class="flex items-center gap-2 text-red-600"><i data-lucide="x-circle"></i> Lỗi: ${error.message}</div>`;
                    lucide.createIcons();
                }
            }

            function generatePayload() {
                if (!originalProduct) {
                    alert("Vui lòng GET product trước!");
                    return;
                }

                const selectedAttributes = getSelectedAttributes();

                if (selectedAttributes.attributeLines.length === 0) {
                    alert("Vui lòng chọn ít nhất 1 attribute!");
                    return;
                }

                // Create payload based on original product
                const payload = JSON.parse(JSON.stringify(originalProduct));

                // Remove OData context
                delete payload["@odata.context"];

                // Set Version to 0
                payload.Version = 0;

                // Add AttributeLines
                payload.AttributeLines = selectedAttributes.attributeLines;

                // Generate ProductVariants
                const variants = generateVariants(selectedAttributes.allValues);

                // Mark old variant as inactive if exists
                if (
                    originalProduct.ProductVariants &&
                    originalProduct.ProductVariants.length > 0
                ) {
                    originalProduct.ProductVariants.forEach((oldVariant) => {
                        if (oldVariant.Id > 0) {
                            const inactiveVariant = JSON.parse(
                                JSON.stringify(oldVariant),
                            );
                            delete inactiveVariant.UOM;
                            delete inactiveVariant.Categ;
                            delete inactiveVariant.UOMPO;
                            delete inactiveVariant.POSCateg;
                            inactiveVariant.Active = false;
                            variants.push(inactiveVariant);
                        }
                    });
                }

                payload.ProductVariants = variants;

                // Add required arrays
                payload.Items = [];
                payload.UOMLines = [
                    {
                        Id: 109326,
                        ProductTmplId: payload.Id,
                        ProductTmplListPrice: null,
                        UOMId: 1,
                        TemplateUOMFactor: 0,
                        ListPrice: payload.ListPrice,
                        Barcode: "",
                        Price: null,
                        ProductId: 0,
                        UOMName: null,
                        NameGet: null,
                        Factor: 0,
                        UOM: payload.UOM,
                    },
                ];
                payload.ComboProducts = [];
                payload.ProductSupplierInfos = [];

                generatedPayload = payload;

                document
                    .getElementById("payloadJson")
                    .querySelector("pre").textContent = JSON.stringify(
                    payload,
                    null,
                    2,
                );
                document.getElementById("payloadSection").style.display =
                    "block";
            }

            function getSelectedAttributes() {
                const attributeLines = [];
                const allValues = [];

                // Size Chữ
                if (document.getElementById("enableSizeText").checked) {
                    const selected = [];
                    document
                        .querySelectorAll("#sizeTextOptions input:checked")
                        .forEach((cb) => {
                            const attr = JSON.parse(cb.value);
                            selected.push({
                                Id: attr.Id,
                                Name: attr.Name,
                                Code: attr.Code,
                                Sequence: attr.Sequence,
                                AttributeId: attr.AttributeId,
                                AttributeName: attr.AttributeName,
                                PriceExtra: null,
                                NameGet: `${attr.AttributeName}: ${attr.Name}`,
                                DateCreated: null,
                            });
                        });
                    if (selected.length > 0) {
                        attributeLines.push({
                            Attribute: {
                                Id: 1,
                                Name: "Size Chữ",
                                Code: "SZCh",
                                Sequence: 1,
                                CreateVariant: true,
                            },
                            Values: selected,
                            AttributeId: 1,
                        });
                        allValues.push(selected);
                    }
                }

                // Size Số
                if (document.getElementById("enableSizeNumber").checked) {
                    const selected = [];
                    document
                        .querySelectorAll("#sizeNumberOptions input:checked")
                        .forEach((cb) => {
                            const attr = JSON.parse(cb.value);
                            selected.push({
                                Id: attr.Id,
                                Name: attr.Name,
                                Code: attr.Code,
                                Sequence: attr.Sequence,
                                AttributeId: attr.AttributeId,
                                AttributeName: attr.AttributeName,
                                PriceExtra: null,
                                NameGet: `${attr.AttributeName}: ${attr.Name}`,
                                DateCreated: null,
                            });
                        });
                    if (selected.length > 0) {
                        attributeLines.push({
                            Attribute: {
                                Id: 4,
                                Name: "Size Số",
                                Code: "SZS",
                                Sequence: 2,
                                CreateVariant: true,
                            },
                            Values: selected,
                            AttributeId: 4,
                        });
                        allValues.push(selected);
                    }
                }

                // Màu
                if (document.getElementById("enableColor").checked) {
                    const selected = [];
                    document
                        .querySelectorAll("#colorOptions input:checked")
                        .forEach((cb) => {
                            const attr = JSON.parse(cb.value);
                            selected.push({
                                Id: attr.Id,
                                Name: attr.Name,
                                Code: attr.Code,
                                Sequence: attr.Sequence,
                                AttributeId: attr.AttributeId,
                                AttributeName: attr.AttributeName,
                                PriceExtra: null,
                                NameGet: `${attr.AttributeName}: ${attr.Name}`,
                                DateCreated: null,
                            });
                        });
                    if (selected.length > 0) {
                        attributeLines.push({
                            Attribute: {
                                Id: 3,
                                Name: "Màu",
                                Code: "mau",
                                Sequence: 3,
                                CreateVariant: true,
                            },
                            Values: selected,
                            AttributeId: 3,
                        });
                        allValues.push(selected);
                    }
                }

                return { attributeLines, allValues };
            }

            function generateVariants(allValues) {
                if (allValues.length === 0) return [];

                // Generate all combinations
                const combinations = cartesianProduct(...allValues);

                return combinations.map((combo) => {
                    const attrArray = Array.isArray(combo) ? combo : [combo];
                    const names = attrArray.map((a) => a.Name).join(", ");

                    return {
                        Id: 0,
                        EAN13: null,
                        DefaultCode: null,
                        NameTemplate: originalProduct.Name,
                        NameNoSign: null,
                        ProductTmplId: originalProduct.Id,
                        UOMId: 0,
                        UOMName: null,
                        UOMPOId: 0,
                        QtyAvailable: 0,
                        VirtualAvailable: 0,
                        OutgoingQty: null,
                        IncomingQty: null,
                        NameGet: `${originalProduct.Name} (${names})`,
                        POSCategId: null,
                        Price: null,
                        Barcode: null,
                        Image: null,
                        ImageUrl: null,
                        Thumbnails: [],
                        PriceVariant: originalProduct.ListPrice,
                        SaleOK: true,
                        PurchaseOK: true,
                        DisplayAttributeValues: null,
                        LstPrice: 0,
                        Active: true,
                        ListPrice: 0,
                        PurchasePrice: null,
                        DiscountSale: null,
                        DiscountPurchase: null,
                        StandardPrice: 0,
                        Weight: 0,
                        Volume: null,
                        OldPrice: null,
                        IsDiscount: false,
                        ProductTmplEnableAll: false,
                        Version: 0,
                        Description: null,
                        LastUpdated: null,
                        Type: "product",
                        CategId: 0,
                        CostMethod: null,
                        InvoicePolicy: "order",
                        Variant_TeamId: 0,
                        Name: `${originalProduct.Name} (${names})`,
                        PropertyCostMethod: null,
                        PropertyValuation: null,
                        PurchaseMethod: "receive",
                        SaleDelay: 0,
                        Tracking: null,
                        Valuation: null,
                        AvailableInPOS: true,
                        CompanyId: null,
                        IsCombo: null,
                        NameTemplateNoSign: originalProduct.NameNoSign,
                        TaxesIds: [],
                        StockValue: null,
                        SaleValue: null,
                        PosSalesCount: null,
                        Factor: null,
                        CategName: null,
                        AmountTotal: null,
                        NameCombos: [],
                        RewardName: null,
                        Product_UOMId: null,
                        Tags: null,
                        DateCreated: null,
                        InitInventory: 0,
                        OrderTag: null,
                        StringExtraProperties: null,
                        CreatedById: null,
                        Error: null,
                        AttributeValues: attrArray.map((a) => ({
                            Id: a.Id,
                            Name: a.Name,
                            Code: null,
                            Sequence: null,
                            AttributeId: a.AttributeId,
                            AttributeName: a.AttributeName,
                            PriceExtra: null,
                            NameGet: `${a.AttributeName}: ${a.Name}`,
                            DateCreated: null,
                        })),
                    };
                });
            }

            function cartesianProduct(...arrays) {
                return arrays.reduce(
                    (acc, array) => {
                        return acc.flatMap((x) =>
                            array.map((y) => [x, y].flat()),
                        );
                    },
                    [[]],
                );
            }

            async function postPayload() {
                if (!generatedPayload) {
                    alert("Vui lòng generate payload trước!");
                    return;
                }

                const statusDiv = document.getElementById("postStatus");
                statusDiv.innerHTML =
                    '<div class="flex items-center gap-2 text-blue-600"><i data-lucide="loader-2" class="animate-spin"></i> Đang POST...</div>';
                lucide.createIcons();

                try {
                    const response = await fetch(
                        "https://tomato.tpos.vn/odata/ProductTemplate/ODataService.UpdateV2",
                        {
                            method: "POST",
                            headers: getHeaders(),
                            body: JSON.stringify(generatedPayload),
                        },
                    );

                    const result = await response.json();

                    if (response.ok) {
                        statusDiv.innerHTML =
                            '<div class="flex items-center gap-2 text-green-600"><i data-lucide="check-circle"></i> POST thành công!</div>';
                    } else {
                        statusDiv.innerHTML = `<div class="flex items-center gap-2 text-red-600"><i data-lucide="x-circle"></i> Lỗi: ${JSON.stringify(result)}</div>`;
                    }
                    lucide.createIcons();
                } catch (error) {
                    statusDiv.innerHTML = `<div class="flex items-center gap-2 text-red-600"><i data-lucide="x-circle"></i> Lỗi: ${error.message}</div>`;
                    lucide.createIcons();
                }
            }
        </script>
    </body>
</html>
