<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• Qu·∫£n L√Ω ƒê∆°n H√†ng TPOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div id="app" class="p-6">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    üõí C√¥ng C·ª• Qu·∫£n L√Ω ƒê∆°n H√†ng TPOS
                </h1>
                <p class="text-gray-600">T√¨m ki·∫øm, ch·ªânh s·ª≠a v√† c·∫≠p nh·∫≠t ƒë∆°n h√†ng</p>
            </div>

            <!-- Message Alert -->
            <div id="messageAlert" class="hidden mb-6 p-4 rounded-lg flex items-center gap-3 fade-in"></div>

            <!-- Progress Steps -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div id="step1" class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold bg-blue-500 text-white">1</div>
                        <div id="line1" class="w-20 h-1 bg-gray-200"></div>
                    </div>
                    <div class="flex items-center">
                        <div id="step2" class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">2</div>
                        <div id="line2" class="w-20 h-1 bg-gray-200"></div>
                    </div>
                    <div class="flex items-center">
                        <div id="step3" class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">3</div>
                        <div id="line3" class="w-20 h-1 bg-gray-200"></div>
                    </div>
                    <div id="step4" class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">4</div>
                </div>
                <div class="flex justify-between mt-2 text-sm text-gray-600">
                    <span>T√¨m ƒë∆°n</span>
                    <span>Ch·ªçn ƒë∆°n</span>
                    <span>Ch·ªçn SP</span>
                    <span>C·∫≠p nh·∫≠t</span>
                </div>
            </div>

            <!-- Step 1: Date Range -->
            <div id="stepContent1" class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    üìÖ B∆∞·ªõc 1: Ch·ªçn kho·∫£ng th·ªùi gian
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ng√†y b·∫Øt ƒë·∫ßu</label>
                        <input type="date" id="startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ng√†y k·∫øt th√∫c</label>
                        <input type="date" id="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Session Index</label>
                        <input type="text" id="sessionIndex" value="60" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                
                <button onclick="fetchOrders()" id="btnFetchOrders" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition disabled:opacity-50">
                    T√¨m ƒë∆°n h√†ng
                </button>
            </div>

            <!-- Step 2: Select Order -->
            <div id="stepContent2" class="hidden bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    üõçÔ∏è B∆∞·ªõc 2: Ch·ªçn ƒë∆°n h√†ng (<span id="orderCount">0</span>)
                </h2>
                
                <div id="ordersList" class="max-h-96 overflow-y-auto space-y-3"></div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="goToStep(1)" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition">
                        Quay l·∫°i
                    </button>
                    <button onclick="fetchOrderDetail()" id="btnContinue" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition disabled:opacity-50">
                        Ti·∫øp t·ª•c
                    </button>
                </div>
            </div>

            <!-- Step 3 & 4: Product Selection -->
            <div id="stepContent3" class="hidden space-y-6">
                <!-- Search Products -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        üîç B∆∞·ªõc 3: T√¨m v√† ch·ªçn s·∫£n ph·∫©m
                    </h2>
                    
                    <div class="flex gap-3 mb-4">
                        <input type="text" id="productSearch" placeholder="Nh·∫≠p t√™n ho·∫∑c m√£ s·∫£n ph·∫©m (VD: N55, N87)..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               onkeypress="if(event.key==='Enter') searchProducts()">
                        <button onclick="searchProducts()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg transition">
                            T√¨m
                        </button>
                    </div>
                    
                    <div id="productsList" class="max-h-64 overflow-y-auto space-y-2"></div>
                </div>

                <!-- Selected Products -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        S·∫£n ph·∫©m ƒë√£ ch·ªçn (<span id="selectedCount">0</span>)
                    </h3>
                    
                    <div id="selectedProductsList"></div>
                </div>

                <!-- Update Order -->
                <div id="updateSection" class="hidden bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        üíæ B∆∞·ªõc 4: C·∫≠p nh·∫≠t ƒë∆°n h√†ng
                    </h2>
                    
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <p class="text-sm text-gray-700">
                            <strong>ƒê∆°n h√†ng:</strong> #<span id="orderCode"></span>
                        </p>
                        <p class="text-sm text-gray-700">
                            <strong>Kh√°ch h√†ng:</strong> <span id="customerName"></span>
                        </p>
                        <p class="text-sm text-gray-700">
                            <strong>S·ªë s·∫£n ph·∫©m m·ªõi:</strong> <span id="newProductCount"></span>
                        </p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="goToStep(2)" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition">
                            Quay l·∫°i
                        </button>
                        <button onclick="updateOrder()" id="btnUpdate" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition disabled:opacity-50">
                            C·∫≠p nh·∫≠t ƒë∆°n h√†ng
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State variables
        let currentStep = 1;
        let orders = [];
        let selectedOrder = null;
        let products = [];
        let selectedProducts = [];
        let orderDetail = null;

        // Initialize dates
        const today = new Date();
        const twoDaysAgo = new Date(today);
        twoDaysAgo.setDate(today.getDate() - 2);
        
        document.getElementById('startDate').value = twoDaysAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];

        // Helper functions
        function showMessage(type, text) {
            const alert = document.getElementById('messageAlert');
            alert.className = `mb-6 p-4 rounded-lg flex items-center gap-3 fade-in ${
                type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            alert.innerHTML = `
                <span>${type === 'success' ? '‚úì' : '‚ö†'}</span>
                <span>${text}</span>
            `;
            alert.classList.remove('hidden');
            setTimeout(() => alert.classList.add('hidden'), 5000);
        }

        function formatDateForAPI(dateStr) {
            const date = new Date(dateStr);
            date.setHours(0, 0, 0, 0);
            return date.toISOString().replace('.000Z', '+00:00');
        }

        function goToStep(step) {
            currentStep = step;
            updateStepUI();
        }

        function updateStepUI() {
            // Hide all steps
            document.getElementById('stepContent1').classList.add('hidden');
            document.getElementById('stepContent2').classList.add('hidden');
            document.getElementById('stepContent3').classList.add('hidden');
            
            // Show current step
            if (currentStep === 1) {
                document.getElementById('stepContent1').classList.remove('hidden');
            } else if (currentStep === 2) {
                document.getElementById('stepContent2').classList.remove('hidden');
            } else if (currentStep >= 3) {
                document.getElementById('stepContent3').classList.remove('hidden');
                if (currentStep === 4) {
                    document.getElementById('updateSection').classList.remove('hidden');
                }
            }
            
            // Update progress circles
            for (let i = 1; i <= 4; i++) {
                const circle = document.getElementById(`step${i}`);
                if (i <= currentStep) {
                    circle.classList.remove('bg-gray-200', 'text-gray-500');
                    circle.classList.add('bg-blue-500', 'text-white');
                } else {
                    circle.classList.remove('bg-blue-500', 'text-white');
                    circle.classList.add('bg-gray-200', 'text-gray-500');
                }
            }
            
            // Update lines
            for (let i = 1; i <= 3; i++) {
                const line = document.getElementById(`line${i}`);
                if (i < currentStep) {
                    line.classList.remove('bg-gray-200');
                    line.classList.add('bg-blue-500');
                } else {
                    line.classList.remove('bg-blue-500');
                    line.classList.add('bg-gray-200');
                }
            }
        }

        // Step 1: Fetch Orders
        async function fetchOrders() {
            const btn = document.getElementById('btnFetchOrders');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner mx-auto"></div>';
            
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const sessionIndex = document.getElementById('sessionIndex').value;
                
                const startDateTime = formatDateForAPI(startDate);
                const endDateTime = formatDateForAPI(endDate);
                
                const url = `https://tomato.tpos.vn/odata/SaleOnline_Order/ODataService.GetView?$top=50&$orderby=DateCreated desc&$filter=(DateCreated ge ${startDateTime} and DateCreated le ${endDateTime} and SessionIndex eq ${sessionIndex})&$count=true`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                orders = data.value || [];
                displayOrders();
                showMessage('success', `T√¨m th·∫•y ${data['@odata.count']} ƒë∆°n h√†ng`);
                goToStep(2);
            } catch (error) {
                showMessage('error', 'L·ªói khi t·∫£i ƒë∆°n h√†ng: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'T√¨m ƒë∆°n h√†ng';
            }
        }

        function displayOrders() {
            const container = document.getElementById('ordersList');
            document.getElementById('orderCount').textContent = orders.length;
            
            if (orders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o</p>';
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div onclick="selectOrder('${order.Id}')" 
                     id="order-${order.Id}"
                     class="order-item p-4 border-2 rounded-lg cursor-pointer transition border-gray-200 hover:border-blue-300">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">#${order.Code}</p>
                            <p class="text-sm text-gray-600">${order.Name}</p>
                            <p class="text-sm text-gray-500">${order.Telephone}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-blue-600">
                                ${order.TotalAmount?.toLocaleString('vi-VN')}‚Ç´
                            </p>
                            <p class="text-sm text-gray-500">
                                SL: ${order.TotalQuantity}
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectOrder(orderId) {
            selectedOrder = orders.find(o => o.Id === orderId);
            
            // Update UI
            document.querySelectorAll('.order-item').forEach(item => {
                item.classList.remove('border-blue-500', 'bg-blue-50');
                item.classList.add('border-gray-200');
            });
            
            const selectedItem = document.getElementById(`order-${orderId}`);
            selectedItem.classList.remove('border-gray-200');
            selectedItem.classList.add('border-blue-500', 'bg-blue-50');
        }

        // Step 3: Fetch Order Detail
        async function fetchOrderDetail() {
            if (!selectedOrder) {
                showMessage('error', 'Vui l√≤ng ch·ªçn ƒë∆°n h√†ng');
                return;
            }
            
            const btn = document.getElementById('btnContinue');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner mx-auto"></div>';
            
            try {
                const url = `https://tomato.tpos.vn/odata/SaleOnline_Order(${selectedOrder.Id})?$expand=Details,Partner,User,CRMTeam`;
                
                const response = await fetch(url);
                orderDetail = await response.json();
                
                document.getElementById('orderCode').textContent = orderDetail.Code;
                document.getElementById('customerName').textContent = orderDetail.Name;
                
                showMessage('success', 'ƒê√£ t·∫£i chi ti·∫øt ƒë∆°n h√†ng');
                goToStep(4);
            } catch (error) {
                showMessage('error', 'L·ªói khi t·∫£i chi ti·∫øt: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ti·∫øp t·ª•c';
            }
        }

        // Step 3: Search Products
        async function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.trim();
            if (!searchTerm) {
                showMessage('error', 'Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m');
                return;
            }
            
            try {
                const url = `https://tomato.tpos.vn/odata/Product/OdataService.GetViewV2?Active=true&Name=${encodeURIComponent(searchTerm)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                products = data.value || [];
                displayProducts();
                showMessage('success', `T√¨m th·∫•y ${data['@odata.count']} s·∫£n ph·∫©m`);
            } catch (error) {
                showMessage('error', 'L·ªói khi t√¨m s·∫£n ph·∫©m: ' + error.message);
            }
        }

        function displayProducts() {
            const container = document.getElementById('productsList');
            
            if (products.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = products.map(product => `
                <div class="p-3 border border-gray-200 rounded-lg hover:border-blue-300 transition flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        ${product.ImageUrl ? `<img src="${product.ImageUrl}" alt="${product.Name}" class="w-12 h-12 object-cover rounded">` : ''}
                        <div>
                            <p class="font-semibold text-gray-800">${product.NameGet}</p>
                            <p class="text-sm text-gray-600">${product.ListPrice?.toLocaleString('vi-VN')}‚Ç´</p>
                        </div>
                    </div>
                    <button onclick='addProductToList(${JSON.stringify(product).replace(/'/g, "&apos;")})' 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                        Th√™m
                    </button>
                </div>
            `).join('');
        }

        function addProductToList(product) {
            const exists = selectedProducts.find(p => p.ProductId === product.Id);
            if (exists) {
                showMessage('error', 'S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m');
                return;
            }
            
            const productData = {
                ProductId: product.Id,
                ProductName: product.Name,
                ProductNameGet: product.NameGet,
                UOMId: 1,
                UOMName: product.UOMName || "C√°i",
                Quantity: 1,
                Price: product.ListPrice || product.PriceVariant || 0,
                Factor: 1,
                ProductWeight: 0
            };
            
            selectedProducts.push(productData);
            displaySelectedProducts();
            showMessage('success', 'ƒê√£ th√™m s·∫£n ph·∫©m');
        }

        function displaySelectedProducts() {
            const container = document.getElementById('selectedProductsList');
            document.getElementById('selectedCount').textContent = selectedProducts.length;
            document.getElementById('newProductCount').textContent = selectedProducts.length;
            
            if (selectedProducts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o. Vui l√≤ng t√¨m v√† th√™m s·∫£n ph·∫©m.</p>';
                return;
            }
            
            container.innerHTML = '<div class="space-y-3">' + selectedProducts.map((product, index) => `
                <div class="p-4 border border-gray-200 rounded-lg flex justify-between items-center">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">${product.ProductNameGet}</p>
                        <p class="text-sm text-gray-600">${product.Price?.toLocaleString('vi-VN')}‚Ç´</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="number" min="1" value="${product.Quantity}" 
                               onchange="updateQuantity(${index}, this.value)"
                               class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center">
                        <button onclick="removeProduct(${index})" 
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                            X√≥a
                        </button>
                    </div>
                </div>
            `).join('') + '</div>';
        }

        function updateQuantity(index, quantity) {
            selectedProducts[index].Quantity = parseInt(quantity) || 1;
        }

        function removeProduct(index) {
            selectedProducts.splice(index, 1);
            displaySelectedProducts();
        }

        // Step 4: Update Order
        async function updateOrder() {
            if (!orderDetail) {
                showMessage('error', 'Ch∆∞a c√≥ d·ªØ li·ªáu ƒë∆°n h√†ng');
                return;
            }
            
            if (selectedProducts.length === 0) {
                showMessage('error', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m');
                return;
            }
            
            const btn = document.getElementById('btnUpdate');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner mx-auto"></div>';
            
            try {
                const updatedOrder = {
                    ...orderDetail,
                    Details: selectedProducts
                };
                
                const url = `https://tomato.tpos.vn/odata/SaleOnline_Order(${orderDetail.Id})`;
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedOrder)
                });
                
                if (response.ok) {
                    showMessage('success', 'C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng!');
                } else {
                    showMessage('error', 'L·ªói khi c·∫≠p nh·∫≠t: ' + response.statusText);
                }
            } catch (error) {
                showMessage('error', 'L·ªói khi c·∫≠p nh·∫≠t: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'C·∫≠p nh·∫≠t ƒë∆°n h√†ng';
            }
        }

        // Initialize
        updateStepUI();
    </script>
</body>
</html>
