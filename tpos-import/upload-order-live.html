<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• Qu·∫£n L√Ω ƒê∆°n H√†ng TPOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div id="app" class="p-6">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    üõí C√¥ng C·ª• Qu·∫£n L√Ω ƒê∆°n H√†ng TPOS
                </h1>
                <p class="text-gray-600">T√¨m ki·∫øm, ch·ªânh s·ª≠a v√† c·∫≠p nh·∫≠t ƒë∆°n h√†ng</p>
            </div>

            <!-- Message Alert -->
            <div id="messageAlert" class="hidden mb-6 p-4 rounded-lg flex items-center gap-3 fade-in"></div>

            <!-- Progress Steps -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div id="step1" class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold bg-blue-500 text-white">1</div>
                        <div id="line1" class="w-20 h-1 bg-gray-200"></div>
                    </div>
                    <div class="flex items-center">
                        <div id="step2" class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">2</div>
                        <div id="line2" class="w-20 h-1 bg-gray-200"></div>
                    </div>
                    <div class="flex items-center">
                        <div id="step3" class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">3</div>
                        <div id="line3" class="w-20 h-1 bg-gray-200"></div>
                    </div>
                    <div id="step4" class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200 text-gray-500">4</div>
                </div>
                <div class="flex justify-between mt-2 text-sm text-gray-600">
                    <span>T√¨m ƒë∆°n</span>
                    <span>Ch·ªçn ƒë∆°n</span>
                    <span>Ch·ªçn SP</span>
                    <span>C·∫≠p nh·∫≠t</span>
                </div>
            </div>

            <!-- Step 1: Date Range -->
            <div id="stepContent1" class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    üìÖ B∆∞·ªõc 1: Ch·ªçn kho·∫£ng th·ªùi gian
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ng√†y b·∫Øt ƒë·∫ßu</label>
                        <input type="date" id="startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ng√†y k·∫øt th√∫c</label>
                        <input type="date" id="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Session Index</label>
                        <input type="text" id="sessionIndex" value="60" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                
                <button onclick="fetchOrders()" id="btnFetchOrders" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition disabled:opacity-50">
                    T√¨m ƒë∆°n h√†ng
                </button>
            </div>

            <!-- Step 2: Select Order -->
            <div id="stepContent2" class="hidden bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    üõçÔ∏è B∆∞·ªõc 2: Ch·ªçn ƒë∆°n h√†ng (<span id="orderCount">0</span>)
                </h2>
                
                <div id="ordersList" class="max-h-96 overflow-y-auto space-y-3"></div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="goToStep(1)" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition">
                        Quay l·∫°i
                    </button>
                    <button onclick="fetchOrderDetail()" id="btnContinue" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition disabled:opacity-50">
                        Ti·∫øp t·ª•c
                    </button>
                </div>
            </div>

            <!-- Step 3 & 4: Product Selection -->
            <div id="stepContent3" class="hidden space-y-6">
                <!-- Search Products -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        üîç B∆∞·ªõc 3: T√¨m v√† ch·ªçn s·∫£n ph·∫©m
                    </h2>
                    
                    <div class="flex gap-3 mb-4">
                        <input type="text" id="productSearch" placeholder="Nh·∫≠p t√™n ho·∫∑c m√£ s·∫£n ph·∫©m (VD: N55, N87)..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               onkeypress="if(event.key==='Enter') searchProducts()">
                        <button onclick="searchProducts()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg transition">
                            T√¨m
                        </button>
                    </div>
                    
                    <div id="productsList" class="max-h-64 overflow-y-auto space-y-2"></div>
                </div>

                <!-- Selected Products -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        S·∫£n ph·∫©m ƒë√£ ch·ªçn (<span id="selectedCount">0</span>)
                    </h3>
                    
                    <div id="selectedProductsList"></div>
                </div>

                <!-- Update Order -->
                <div id="updateSection" class="hidden bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        üíæ B∆∞·ªõc 4: C·∫≠p nh·∫≠t ƒë∆°n h√†ng
                    </h2>
                    
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <p class="text-sm text-gray-700">
                            <strong>ƒê∆°n h√†ng:</strong> #<span id="orderCode"></span>
                        </p>
                        <p class="text-sm text-gray-700">
                            <strong>Kh√°ch h√†ng:</strong> <span id="customerName"></span>
                        </p>
                        <p class="text-sm text-gray-700">
                            <strong>S·ªë s·∫£n ph·∫©m m·ªõi:</strong> <span id="newProductCount"></span>
                        </p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="goToStep(2)" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition">
                            Quay l·∫°i
                        </button>
                        <button onclick="updateOrder()" id="btnUpdate" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition disabled:opacity-50">
                            C·∫≠p nh·∫≠t ƒë∆°n h√†ng
                        </button>
                    </div>
                </div>
            </div>

            <!-- API Headers Configuration -->
            <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        üîß C·∫•u h√¨nh Headers API
                    </h2>
                    <button onclick="toggleHeaders()" class="text-blue-500 hover:text-blue-600 font-medium">
                        <span id="toggleText">Hi·ªán</span> ‚ñº
                    </button>
                </div>
                
                <div id="headersSection" class="hidden space-y-4">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                        <p class="text-sm text-yellow-800">
                            ‚ö†Ô∏è <strong>Quan tr·ªçng:</strong> Authorization token s·∫Ω h·∫øt h·∫°n sau m·ªôt th·ªùi gian. N·∫øu g·∫∑p l·ªói 401, c·∫ßn l·∫•y token m·ªõi t·ª´ h·ªá th·ªëng.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Authorization Token
                            </label>
                            <textarea id="authToken" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-xs"
                                      placeholder="Bearer eyJhbGci..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                x-request-id (GUID)
                                <button onclick="generateNewGUID()" class="ml-2 text-blue-500 hover:text-blue-600 text-xs">
                                    üîÑ T·∫°o m·ªõi
                                </button>
                            </label>
                            <input type="text" id="requestId" readonly
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"
                                   placeholder="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Content-Type
                            </label>
                            <input type="text" id="contentType" 
                                   value="application/json;charset=UTF-8"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                tposappversion
                            </label>
                            <input type="text" id="appVersion" 
                                   value="5.9.10.1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Accept-Language
                            </label>
                            <input type="text" id="acceptLanguage" 
                                   value="vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                User-Agent
                            </label>
                            <input type="text" id="userAgent" 
                                   value="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mt-4">
                        <button onclick="saveHeaders()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                            üíæ L∆∞u
                        </button>
                        <button onclick="loadDefaultHeaders()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                            üîÑ M·∫∑c ƒë·ªãnh
                        </button>
                        <button onclick="copyHeaders()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                            üìã Copy
                        </button>
                        <button onclick="loadBrowserHeaders()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                            üì± L·∫•y t·ª´ Browser
                        </button>
                        <button onclick="showPasteModal()" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                            üì• Paste Headers
                        </button>
                    </div>

                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-gray-700 mb-2">üìù 3 C√°ch l·∫•y headers:</h4>
                        <div class="space-y-3 text-sm text-gray-600">
                            <div class="border-l-4 border-purple-400 pl-3">
                                <strong>C√°ch 1: L·∫•y t·ª´ Browser (Nhanh nh·∫•t) üì±</strong>
                                <p class="mt-1">Click n√∫t "üì± L·∫•y t·ª´ Browser" ‚Üí T·ª± ƒë·ªông detect User-Agent v√† Accept-Language c·ªßa tr√¨nh duy·ªát b·∫°n</p>
                            </div>
                            <div class="border-l-4 border-orange-400 pl-3">
                                <strong>C√°ch 2: Paste Raw Headers (Ch√≠nh x√°c nh·∫•t) üì•</strong>
                                <ol class="mt-1 list-decimal list-inside">
                                    <li>M·ªü tomato.tpos.vn ‚Üí F12 ‚Üí Tab Network</li>
                                    <li>Ch·ªçn request ‚Üí Headers ‚Üí Copy all as cURL</li>
                                    <li>Click "üì• Paste Headers" ‚Üí Paste ‚Üí √Åp d·ª•ng</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Paste Headers -->
    <div id="pasteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">üì• Paste Raw Headers t·ª´ DevTools</h3>
                <button onclick="closePasteModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                <p class="text-sm text-blue-800">
                    <strong>H∆∞·ªõng d·∫´n:</strong>
                </p>
                <ol class="text-sm text-blue-700 mt-2 space-y-1 list-decimal list-inside">
                    <li>M·ªü DevTools (F12) ‚Üí Tab <strong>Network</strong></li>
                    <li>Ch·ªçn m·ªôt request b·∫•t k·ª≥ ƒë·∫øn <strong>tomato.tpos.vn</strong></li>
                    <li>Tab <strong>Headers</strong> ‚Üí Ph·∫ßn <strong>Request Headers</strong></li>
                    <li>Click chu·ªôt ph·∫£i ‚Üí <strong>Copy all as cURL</strong> ho·∫∑c copy t·ª´ng d√≤ng</li>
                    <li>Paste v√†o √¥ d∆∞·ªõi (format: <code>header-name: value</code>)</li>
                </ol>
            </div>

            <textarea id="rawHeadersInput" rows="15" 
                      placeholder="accept: application/json, text/plain, */*
authorization: Bearer eyJhbGci...
content-type: application/json;charset=UTF-8
x-request-id: 12345678-1234-4567-8901-123456789012
user-agent: Mozilla/5.0..."
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"></textarea>
            
            <div class="flex gap-3 mt-4">
                <button onclick="closePasteModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                    ‚ùå H·ªßy
                </button>
                <button onclick="parseAndApplyHeaders()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                    ‚úÖ √Åp d·ª•ng Headers
                </button>
            </div>

            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <details>
                    <summary class="cursor-pointer font-semibold text-gray-700">üí° M·∫πo: Copy t·ª´ cURL command</summary>
                    <div class="mt-2 text-sm text-gray-600">
                        <p>N·∫øu b·∫°n copy <strong>"Copy as cURL"</strong> t·ª´ DevTools, paste v√†o ƒë√¢y v√† tool s·∫Ω t·ª± ƒë·ªông parse headers!</p>
                        <pre class="bg-gray-100 p-2 rounded mt-2 text-xs overflow-x-auto">curl 'https://tomato.tpos.vn/...' \
  -H 'authorization: Bearer ...' \
  -H 'content-type: application/json'</pre>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <script>
        // State variables
        let currentStep = 1;
        let orders = [];
        let selectedOrder = null;
        let products = [];
        let selectedProducts = [];
        let orderDetail = null;

        // Initialize dates
        const today = new Date();
        const twoDaysAgo = new Date(today);
        twoDaysAgo.setDate(today.getDate() - 2);
        
        document.getElementById('startDate').value = twoDaysAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];

        // ========== GUID GENERATION FUNCTIONS ==========
        
        /**
         * T·∫°o GUID/UUID ng·∫´u nhi√™n gi·ªëng {{$guid}} trong Postman
         * Format: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
         */
        function generateGUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0;
                var v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        /**
         * T·∫°o GUID m·ªõi v√† hi·ªÉn th·ªã trong input
         */
        function generateNewGUID() {
            const guid = generateGUID();
            document.getElementById('requestId').value = guid;
            showMessage('success', 'ƒê√£ t·∫°o GUID m·ªõi: ' + guid);
        }

        /**
         * L·∫•y headers ƒë·ªÉ s·ª≠ d·ª•ng trong API calls
         */
        function getHeaders() {
            return {
                'accept': 'application/json, text/plain, */*',
                'authorization': document.getElementById('authToken').value.trim() || 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJDbGllbnRJZCI6InRtdFdlYkFwcCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiZmMwZjQ0MzktOWNmNi00ZDg4LWE4YzctNzU5Y2E4Mjk1MTQyIiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6Im52MjAiLCJEaXNwbGF5TmFtZSI6IlTDuiIsIkF2YXRhclVybCI6IiIsIlNlY3VyaXR5U3RhbXAiOiI1ZjY1NjQwMy01NjdmLTRmYzAtYjYxNy0yODJhYzgxZGY1ZWQiLCJDb21wYW55SWQiOiIxIiwiVGVuYW50SWQiOiJ0b21hdG8udHBvcy52biIsIlJvbGVJZHMiOiI0MmZmYzk5Yi1lNGY2LTQwMDAtYjcyOS1hZTNmMDAyOGEyODksNmExZDAwMDAtNWQxYS0wMDE1LTBlNmMtMDhkYzM3OTUzMmU5LDc2MzlhMDQ4LTdjZmUtNDBiNS1hNDFkLWFlM2YwMDNiODlkZiw4YmM4ZjQ1YS05MWY4LTQ5NzMtYjE4Mi1hZTNmMDAzYWI4NTUsYTljMjAwMDAtNWRiNi0wMDE1LTQ1YWItMDhkYWIxYmZlMjIyIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjpbIlF14bqjbiBMw70gTWFpIiwiQ8OSSSIsIkNTS0ggLSBMw6BpIiwiS2hvIFBoxrDhu5tjLSBLaeG7h3QiLCJRdeG6o24gTMO9IEtobyAtIEJvIl0sImp0aSI6IjBiZmQwYTIyLWY0NmUtNDNkZS1iMmJhLTZhZjRlMWMyY2ZjYyIsImlhdCI6IjE3NTk3MjE0NjciLCJuYmYiOjE3NTk3MjE0NjcsImV4cCI6MTc2MTAxNzQ2NywiaXNzIjoiaHR0cHM6Ly90b21hdG8udHBvcy52biIsImF1ZCI6Imh0dHBzOi8vdG9tYXRvLnRwb3Mudm4saHR0cHM6Ly90cG9zLnZuIn0.618RIQqBAamtvWgPUwP6xuNjzB8nw9eI-Vh8fhrVbds',
                'accept-language': document.getElementById('acceptLanguage').value,
                'content-type': document.getElementById('contentType').value,
                'origin': 'https://tomato.tpos.vn',
                'referer': 'https://tomato.tpos.vn/',
                'tposappversion': document.getElementById('appVersion').value,
                'user-agent': document.getElementById('userAgent').value,
                'x-request-id': document.getElementById('requestId').value
            };
        }

        /**
         * Toggle hi·ªÉn th·ªã headers section
         */
        function toggleHeaders() {
            const section = document.getElementById('headersSection');
            const toggleText = document.getElementById('toggleText');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggleText.textContent = '·∫®n';
            } else {
                section.classList.add('hidden');
                toggleText.textContent = 'Hi·ªán';
            }
        }

        /**
         * L∆∞u headers v√†o localStorage
         */
        function saveHeaders() {
            const headers = {
                authToken: document.getElementById('authToken').value,
                requestId: document.getElementById('requestId').value,
                contentType: document.getElementById('contentType').value,
                appVersion: document.getElementById('appVersion').value,
                acceptLanguage: document.getElementById('acceptLanguage').value,
                userAgent: document.getElementById('userAgent').value
            };
            
            // Note: localStorage kh√¥ng ho·∫°t ƒë·ªông trong artifacts, nh∆∞ng s·∫Ω ho·∫°t ƒë·ªông khi download file
            try {
                localStorage.setItem('tposHeaders', JSON.stringify(headers));
                showMessage('success', 'ƒê√£ l∆∞u c·∫•u h√¨nh headers');
            } catch (e) {
                showMessage('success', 'ƒê√£ √°p d·ª•ng c·∫•u h√¨nh headers (l∆∞u v√†o localStorage kh√¥ng kh·∫£ d·ª•ng trong m√¥i tr∆∞·ªùng n√†y)');
            }
        }

        /**
         * Load headers m·∫∑c ƒë·ªãnh
         */
        function loadDefaultHeaders() {
            document.getElementById('authToken').value = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJDbGllbnRJZCI6InRtdFdlYkFwcCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiZmMwZjQ0MzktOWNmNi00ZDg4LWE4YzctNzU5Y2E4Mjk1MTQyIiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6Im52MjAiLCJEaXNwbGF5TmFtZSI6IlTDuiIsIkF2YXRhclVybCI6IiIsIlNlY3VyaXR5U3RhbXAiOiI1ZjY1NjQwMy01NjdmLTRmYzAtYjYxNy0yODJhYzgxZGY1ZWQiLCJDb21wYW55SWQiOiIxIiwiVGVuYW50SWQiOiJ0b21hdG8udHBvcy52biIsIlJvbGVJZHMiOiI0MmZmYzk5Yi1lNGY2LTQwMDAtYjcyOS1hZTNmMDAyOGEyODksNmExZDAwMDAtNWQxYS0wMDE1LTBlNmMtMDhkYzM3OTUzMmU5LDc2MzlhMDQ4LTdjZmUtNDBiNS1hNDFkLWFlM2YwMDNiODlkZiw4YmM4ZjQ1YS05MWY4LTQ5NzMtYjE4Mi1hZTNmMDAzYWI4NTUsYTljMjAwMDAtNWRiNi0wMDE1LTQ1YWItMDhkYWIxYmZlMjIyIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjpbIlF14bqjbiBMw70gTWFpIiwiQ8OSSSIsIkNTS0ggLSBMw6BpIiwiS2hvIFBoxrDhu5tjLSBLaeG7h3QiLCJRdeG6o24gTMO9IEtobyAtIEJvIl0sImp0aSI6IjBiZmQwYTIyLWY0NmUtNDNkZS1iMmJhLTZhZjRlMWMyY2ZjYyIsImlhdCI6IjE3NTk3MjE0NjciLCJuYmYiOjE3NTk3MjE0NjcsImV4cCI6MTc2MTAxNzQ2NywiaXNzIjoiaHR0cHM6Ly90b21hdG8udHBvcy52biIsImF1ZCI6Imh0dHBzOi8vdG9tYXRvLnRwb3Mudm4saHR0cHM6Ly90cG9zLnZuIn0.618RIQqBAamtvWgPUwP6xuNjzB8nw9eI-Vh8fhrVbds';
            document.getElementById('contentType').value = 'application/json;charset=UTF-8';
            document.getElementById('appVersion').value = '5.9.10.1';
            document.getElementById('acceptLanguage').value = 'vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7';
            document.getElementById('userAgent').value = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36';
            generateNewGUID();
            showMessage('success', 'ƒê√£ kh√¥i ph·ª•c c·∫•u h√¨nh m·∫∑c ƒë·ªãnh');
        }

        /**
         * Copy headers ra clipboard
         */
        function copyHeaders() {
            const headers = getHeaders();
            const headersText = Object.entries(headers)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');
            
            navigator.clipboard.writeText(headersText).then(() => {
                showMessage('success', 'ƒê√£ copy headers v√†o clipboard');
            }).catch(() => {
                showMessage('error', 'Kh√¥ng th·ªÉ copy. H√£y copy th·ªß c√¥ng.');
            });
        }

        /**
         * L·∫•y headers t·ª´ tr√¨nh duy·ªát hi·ªán t·∫°i
         */
        function loadBrowserHeaders() {
            // Detect browser info
            const userAgent = navigator.userAgent;
            const language = navigator.language || navigator.userLanguage;
            
            // Get browser name and version
            let browserInfo = 'Chrome'; // default
            if (userAgent.indexOf('Firefox') > -1) browserInfo = 'Firefox';
            else if (userAgent.indexOf('Safari') > -1 && userAgent.indexOf('Chrome') === -1) browserInfo = 'Safari';
            else if (userAgent.indexOf('Edge') > -1) browserInfo = 'Edge';
            
            // Update form fields
            document.getElementById('userAgent').value = userAgent;
            document.getElementById('acceptLanguage').value = language + ',en;q=0.9';
            
            // Generate new GUID
            generateNewGUID();
            
            showMessage('success', `ƒê√£ load headers t·ª´ ${browserInfo}!`);
        }

        /**
         * Hi·ªÉn th·ªã modal ƒë·ªÉ paste raw headers
         */
        function showPasteModal() {
            document.getElementById('pasteModal').classList.remove('hidden');
            document.getElementById('rawHeadersInput').focus();
        }

        /**
         * ƒê√≥ng modal
         */
        function closePasteModal() {
            document.getElementById('pasteModal').classList.add('hidden');
            document.getElementById('rawHeadersInput').value = '';
        }

        /**
         * Parse v√† √°p d·ª•ng raw headers
         */
        function parseAndApplyHeaders() {
            const rawInput = document.getElementById('rawHeadersInput').value.trim();
            
            if (!rawInput) {
                showMessage('error', 'Vui l√≤ng paste headers v√†o √¥ b√™n tr√™n');
                return;
            }

            try {
                const headers = parseRawHeaders(rawInput);
                
                // Apply headers to form
                if (headers.authorization) {
                    document.getElementById('authToken').value = headers.authorization;
                }
                if (headers['x-request-id']) {
                    document.getElementById('requestId').value = headers['x-request-id'];
                } else {
                    generateNewGUID(); // Generate if not provided
                }
                if (headers['content-type']) {
                    document.getElementById('contentType').value = headers['content-type'];
                }
                if (headers['tposappversion']) {
                    document.getElementById('appVersion').value = headers['tposappversion'];
                }
                if (headers['accept-language']) {
                    document.getElementById('acceptLanguage').value = headers['accept-language'];
                }
                if (headers['user-agent']) {
                    document.getElementById('userAgent').value = headers['user-agent'];
                }
                
                closePasteModal();
                showMessage('success', `ƒê√£ √°p d·ª•ng ${Object.keys(headers).length} headers th√†nh c√¥ng!`);
                
            } catch (error) {
                showMessage('error', 'L·ªói parse headers: ' + error.message);
            }
        }

        /**
         * Parse raw headers t·ª´ nhi·ªÅu format kh√°c nhau
         */
        function parseRawHeaders(rawText) {
            const headers = {};
            
            // Check if it's cURL command
            if (rawText.includes('curl ')) {
                // Extract headers from cURL command
                const headerMatches = rawText.matchAll(/-H\s+['"]([^:]+):\s*([^'"]+)['"]/g);
                for (const match of headerMatches) {
                    const key = match[1].toLowerCase().trim();
                    const value = match[2].trim();
                    headers[key] = value;
                }
            } else {
                // Parse as plain headers (key: value format)
                const lines = rawText.split('\n');
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine || trimmedLine.startsWith('#')) continue;
                    
                    const colonIndex = trimmedLine.indexOf(':');
                    if (colonIndex > 0) {
                        const key = trimmedLine.substring(0, colonIndex).toLowerCase().trim();
                        const value = trimmedLine.substring(colonIndex + 1).trim();
                        if (key && value) {
                            headers[key] = value;
                        }
                    }
                }
            }
            
            if (Object.keys(headers).length === 0) {
                throw new Error('Kh√¥ng t√¨m th·∫•y headers h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra format.');
            }
            
            return headers;
        }

        // Close modal when clicking outside
        document.getElementById('pasteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePasteModal();
            }
        });

        // ESC key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePasteModal();
            }
        });

        // ========== HELPER FUNCTIONS ==========
        
        function showMessage(type, text) {
            const alert = document.getElementById('messageAlert');
            alert.className = `mb-6 p-4 rounded-lg flex items-center gap-3 fade-in ${
                type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            alert.innerHTML = `
                <span>${type === 'success' ? '‚úì' : '‚ö†'}</span>
                <span>${text}</span>
            `;
            alert.classList.remove('hidden');
            setTimeout(() => alert.classList.add('hidden'), 5000);
        }

        function formatDateForAPI(dateStr) {
            const date = new Date(dateStr);
            date.setHours(0, 0, 0, 0);
            return date.toISOString().replace('.000Z', '+00:00');
        }

        function goToStep(step) {
            currentStep = step;
            updateStepUI();
        }

        function updateStepUI() {
            // Hide all steps
            document.getElementById('stepContent1').classList.add('hidden');
            document.getElementById('stepContent2').classList.add('hidden');
            document.getElementById('stepContent3').classList.add('hidden');
            
            // Show current step
            if (currentStep === 1) {
                document.getElementById('stepContent1').classList.remove('hidden');
            } else if (currentStep === 2) {
                document.getElementById('stepContent2').classList.remove('hidden');
            } else if (currentStep >= 3) {
                document.getElementById('stepContent3').classList.remove('hidden');
                if (currentStep === 4) {
                    document.getElementById('updateSection').classList.remove('hidden');
                }
            }
            
            // Update progress circles
            for (let i = 1; i <= 4; i++) {
                const circle = document.getElementById(`step${i}`);
                if (i <= currentStep) {
                    circle.classList.remove('bg-gray-200', 'text-gray-500');
                    circle.classList.add('bg-blue-500', 'text-white');
                } else {
                    circle.classList.remove('bg-blue-500', 'text-white');
                    circle.classList.add('bg-gray-200', 'text-gray-500');
                }
            }
            
            // Update lines
            for (let i = 1; i <= 3; i++) {
                const line = document.getElementById(`line${i}`);
                if (i < currentStep) {
                    line.classList.remove('bg-gray-200');
                    line.classList.add('bg-blue-500');
                } else {
                    line.classList.remove('bg-blue-500');
                    line.classList.add('bg-gray-200');
                }
            }
        }

        // ========== API CALLS ==========

        // Step 1: Fetch Orders
        async function fetchOrders() {
            const btn = document.getElementById('btnFetchOrders');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner mx-auto"></div>';
            
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const sessionIndex = document.getElementById('sessionIndex').value;
                
                const startDateTime = formatDateForAPI(startDate);
                const endDateTime = formatDateForAPI(endDate);
                
                const url = `https://tomato.tpos.vn/odata/SaleOnline_Order/ODataService.GetView?$top=1&$orderby=DateCreated desc&$filter=(DateCreated ge ${startDateTime} and DateCreated le ${endDateTime} and SessionIndex eq ${sessionIndex})&$count=true`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                orders = data.value || [];
                displayOrders();
                showMessage('success', `T√¨m th·∫•y ${data['@odata.count']} ƒë∆°n h√†ng`);
                goToStep(2);
            } catch (error) {
                showMessage('error', 'L·ªói khi t·∫£i ƒë∆°n h√†ng: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'T√¨m ƒë∆°n h√†ng';
            }
        }

        function displayOrders() {
            const container = document.getElementById('ordersList');
            document.getElementById('orderCount').textContent = orders.length;
            
            if (orders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o</p>';
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div onclick="selectOrder('${order.Id}')" 
                     id="order-${order.Id}"
                     class="order-item p-4 border-2 rounded-lg cursor-pointer transition border-gray-200 hover:border-blue-300">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">#${order.Code}</p>
                            <p class="text-sm text-gray-600">${order.Name}</p>
                            <p class="text-sm text-gray-500">${order.Telephone}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-blue-600">
                                ${order.TotalAmount?.toLocaleString('vi-VN')}‚Ç´
                            </p>
                            <p class="text-sm text-gray-500">
                                SL: ${order.TotalQuantity}
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectOrder(orderId) {
            selectedOrder = orders.find(o => o.Id === orderId);
            
            // Update UI
            document.querySelectorAll('.order-item').forEach(item => {
                item.classList.remove('border-blue-500', 'bg-blue-50');
                item.classList.add('border-gray-200');
            });
            
            const selectedItem = document.getElementById(`order-${orderId}`);
            selectedItem.classList.remove('border-gray-200');
            selectedItem.classList.add('border-blue-500', 'bg-blue-50');
        }

        // Step 3: Fetch Order Detail
        async function fetchOrderDetail() {
            if (!selectedOrder) {
                showMessage('error', 'Vui l√≤ng ch·ªçn ƒë∆°n h√†ng');
                return;
            }
            
            const btn = document.getElementById('btnContinue');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner mx-auto"></div>';
            
            try {
                const url = `https://tomato.tpos.vn/odata/SaleOnline_Order(${selectedOrder.Id})?$expand=Details,Partner,User,CRMTeam`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                orderDetail = await response.json();
                
                document.getElementById('orderCode').textContent = orderDetail.Code;
                document.getElementById('customerName').textContent = orderDetail.Name;
                
                showMessage('success', 'ƒê√£ t·∫£i chi ti·∫øt ƒë∆°n h√†ng');
                goToStep(4);
            } catch (error) {
                showMessage('error', 'L·ªói khi t·∫£i chi ti·∫øt: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ti·∫øp t·ª•c';
            }
        }

        // Step 3: Search Products
        async function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.trim();
            if (!searchTerm) {
                showMessage('error', 'Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m');
                return;
            }
            
            try {
                const url = `https://tomato.tpos.vn/odata/Product/OdataService.GetViewV2?Active=true&Name=${encodeURIComponent(searchTerm)}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                products = data.value || [];
                displayProducts();
                showMessage('success', `T√¨m th·∫•y ${data['@odata.count']} s·∫£n ph·∫©m`);
            } catch (error) {
                showMessage('error', 'L·ªói khi t√¨m s·∫£n ph·∫©m: ' + error.message);
            }
        }

        function displayProducts() {
            const container = document.getElementById('productsList');
            
            if (products.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = products.map(product => `
                <div class="p-3 border border-gray-200 rounded-lg hover:border-blue-300 transition flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        ${product.ImageUrl ? `<img src="${product.ImageUrl}" alt="${product.Name}" class="w-12 h-12 object-cover rounded">` : ''}
                        <div>
                            <p class="font-semibold text-gray-800">${product.NameGet}</p>
                            <p class="text-sm text-gray-600">${product.ListPrice?.toLocaleString('vi-VN')}‚Ç´</p>
                        </div>
                    </div>
                    <button onclick='addProductToList(${JSON.stringify(product).replace(/'/g, "&apos;")})' 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                        Th√™m
                    </button>
                </div>
            `).join('');
        }

        function addProductToList(product) {
            const exists = selectedProducts.find(p => p.ProductId === product.Id);
            if (exists) {
                showMessage('error', 'S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m');
                return;
            }
            
            const productData = {
                ProductId: product.Id,
                ProductName: product.Name,
                ProductNameGet: product.NameGet,
                UOMId: 1,
                UOMName: product.UOMName || "C√°i",
                Quantity: 1,
                Price: product.ListPrice || product.PriceVariant || 0,
                Factor: 1,
                ProductWeight: 0
            };
            
            selectedProducts.push(productData);
            displaySelectedProducts();
            showMessage('success', 'ƒê√£ th√™m s·∫£n ph·∫©m');
        }

        function displaySelectedProducts() {
            const container = document.getElementById('selectedProductsList');
            document.getElementById('selectedCount').textContent = selectedProducts.length;
            document.getElementById('newProductCount').textContent = selectedProducts.length;
            
            if (selectedProducts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o. Vui l√≤ng t√¨m v√† th√™m s·∫£n ph·∫©m.</p>';
                return;
            }
            
            container.innerHTML = '<div class="space-y-3">' + selectedProducts.map((product, index) => `
                <div class="p-4 border border-gray-200 rounded-lg flex justify-between items-center">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">${product.ProductNameGet}</p>
                        <p class="text-sm text-gray-600">${product.Price?.toLocaleString('vi-VN')}‚Ç´</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="number" min="1" value="${product.Quantity}" 
                               onchange="updateQuantity(${index}, this.value)"
                               class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center">
                        <button onclick="removeProduct(${index})" 
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                            X√≥a
                        </button>
                    </div>
                </div>
            `).join('') + '</div>';
        }

        function updateQuantity(index, quantity) {
            selectedProducts[index].Quantity = parseInt(quantity) || 1;
        }

        function removeProduct(index) {
            selectedProducts.splice(index, 1);
            displaySelectedProducts();
        }

        // Step 4: Update Order
        async function updateOrder() {
            if (!orderDetail) {
                showMessage('error', 'Ch∆∞a c√≥ d·ªØ li·ªáu ƒë∆°n h√†ng');
                return;
            }
            
            if (selectedProducts.length === 0) {
                showMessage('error', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m');
                return;
            }
            
            const btn = document.getElementById('btnUpdate');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner mx-auto"></div>';
            
            try {
                // Generate new GUID for this request
                generateNewGUID();
                
                const updatedOrder = {
                    ...orderDetail,
                    Details: selectedProducts
                };
                
                const url = `https://tomato.tpos.vn/odata/SaleOnline_Order(${orderDetail.Id})`;
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify(updatedOrder)
                });
                
                if (response.ok) {
                    showMessage('success', 'C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng!');
                } else {
                    showMessage('error', 'L·ªói khi c·∫≠p nh·∫≠t: ' + response.statusText);
                }
            } catch (error) {
                showMessage('error', 'L·ªói khi c·∫≠p nh·∫≠t: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'C·∫≠p nh·∫≠t ƒë∆°n h√†ng';
            }
        }

        // ========== INITIALIZE ==========
        
        // Initialize with default values
        loadDefaultHeaders();
        updateStepUI();
    </script>
</body>
</html>
