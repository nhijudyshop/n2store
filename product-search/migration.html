<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Script - Array to Object</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }

        .warning strong {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #0c5460;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }

        .progress {
            background: #e9ecef;
            border-radius: 8px;
            height: 30px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .status {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .status-item {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .status-item strong {
            display: block;
            font-size: 24px;
            margin-bottom: 5px;
            color: #667eea;
        }

        .status-item span {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Migration Script</h1>
        <p style="color: #6c757d; margin-bottom: 20px;">Chuy·ªÉn ƒë·ªïi Firebase Structure: Array ‚Üí Object</p>

        <div class="warning">
            <strong>‚ö†Ô∏è C·∫¢NH B√ÅO QUAN TR·ªåNG:</strong>
            <ul style="margin-left: 20px;">
                <li>Script n√†y s·∫Ω thay ƒë·ªïi c·∫•u tr√∫c d·ªØ li·ªáu Firebase</li>
                <li>Backup t·ª± ƒë·ªông s·∫Ω ƒë∆∞·ª£c t·∫°o tr∆∞·ªõc khi migration</li>
                <li>ƒê·∫£m b·∫£o KH√îNG c√≥ tab n√†o kh√°c ƒëang m·ªü index.html ho·∫∑c product-list.html</li>
                <li>Qu√° tr√¨nh m·∫•t kho·∫£ng 30s - 2 ph√∫t t√πy s·ªë l∆∞·ª£ng s·∫£n ph·∫©m</li>
            </ul>
        </div>

        <div class="info">
            <strong>‚ÑπÔ∏è Th√¥ng tin Migration:</strong>
            <p>C·∫•u tr√∫c m·ªõi s·∫Ω cho ph√©p ƒë·ªìng b·ªô nhanh h∆°n 10-20x b·∫±ng c√°ch ch·ªâ sync s·∫£n ph·∫©m thay ƒë·ªïi thay v√¨ to√†n b·ªô danh s√°ch.</p>
        </div>

        <div class="status">
            <div class="status-item">
                <strong id="productCount">-</strong>
                <span>S·∫£n ph·∫©m</span>
            </div>
            <div class="status-item">
                <strong id="backupCount">-</strong>
                <span>Backups</span>
            </div>
            <div class="status-item">
                <strong id="structureType">-</strong>
                <span>C·∫•u tr√∫c</span>
            </div>
        </div>

        <div class="progress" id="progressContainer">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>

        <div class="buttons">
            <button class="btn-primary" id="btnCheckStatus" onclick="checkCurrentStatus()">
                üîç Ki·ªÉm tra tr·∫°ng th√°i
            </button>
            <button class="btn-success" id="btnMigrate" onclick="runMigration()" disabled>
                üöÄ Ch·∫°y Migration
            </button>
            <button class="btn-danger" id="btnRollback" onclick="rollback()" disabled>
                ‚Ü©Ô∏è Rollback
            </button>
        </div>

        <pre id="log">Nh·∫•n "Ki·ªÉm tra tr·∫°ng th√°i" ƒë·ªÉ b·∫Øt ƒë·∫ßu...</pre>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2izLYXLYWR8RtsIS7vvQWroPPtxi_50A",
            authDomain: "product-s-98d2c.firebaseapp.com",
            databaseURL: "https://product-s-98d2c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "product-s-98d2c",
            storageBucket: "product-s-98d2c.firebasestorage.app",
            messagingSenderId: "692514176406",
            appId: "1:692514176406:web:429fb683b8905e10e131b7",
            measurementId: "G-MXT4TJK349"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentStructure = null;
        let productData = null;

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logEl.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.style.display = 'block';
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
        }

        async function checkCurrentStatus() {
            const btnCheck = document.getElementById('btnCheckStatus');
            btnCheck.disabled = true;

            log('ƒêang ki·ªÉm tra c·∫•u tr√∫c Firebase hi·ªán t·∫°i...');

            try {
                // Check savedProducts structure
                const snapshot = await database.ref('savedProducts').once('value');
                productData = snapshot.val();

                if (!productData) {
                    log('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu savedProducts', 'warning');
                    document.getElementById('productCount').textContent = '0';
                    document.getElementById('structureType').textContent = 'Empty';
                    return;
                }

                // Detect structure type
                if (Array.isArray(productData)) {
                    currentStructure = 'array';
                    const validProducts = productData.filter(p => p && p.Id);
                    document.getElementById('productCount').textContent = validProducts.length;
                    document.getElementById('structureType').textContent = 'Array';
                    log(`C·∫•u tr√∫c hi·ªán t·∫°i: ARRAY v·ªõi ${validProducts.length} s·∫£n ph·∫©m`, 'info');
                    log('‚úÖ C√≥ th·ªÉ ch·∫°y migration', 'success');
                    document.getElementById('btnMigrate').disabled = false;
                } else if (typeof productData === 'object') {
                    currentStructure = 'object';
                    const productCount = Object.keys(productData).length;
                    document.getElementById('productCount').textContent = productCount;
                    document.getElementById('structureType').textContent = 'Object';
                    log(`C·∫•u tr√∫c hi·ªán t·∫°i: OBJECT v·ªõi ${productCount} s·∫£n ph·∫©m`, 'success');
                    log('‚ÑπÔ∏è ƒê√£ ƒë∆∞·ª£c migrate r·ªìi!', 'info');
                }

                // Check backups
                const rootSnapshot = await database.ref('/').once('value');
                const rootData = rootSnapshot.val();
                const backupKeys = Object.keys(rootData || {}).filter(k => k.startsWith('savedProducts_backup_'));
                document.getElementById('backupCount').textContent = backupKeys.length;

                if (backupKeys.length > 0) {
                    log(`T√¨m th·∫•y ${backupKeys.length} backup(s)`, 'info');
                    document.getElementById('btnRollback').disabled = false;

                    // Show latest backup
                    const latestBackup = backupKeys.sort().reverse()[0];
                    const backupTime = new Date(parseInt(latestBackup.split('_').pop()));
                    log(`  ‚Üí Backup m·ªõi nh·∫•t: ${backupTime.toLocaleString()}`, 'info');
                }

            } catch (error) {
                log('L·ªói khi ki·ªÉm tra: ' + error.message, 'error');
                console.error(error);
            } finally {
                btnCheck.disabled = false;
            }
        }

        async function runMigration() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ch·∫°y migration?\n\n‚ö†Ô∏è ƒê·∫£m b·∫£o ƒë√£ ƒë√≥ng t·∫•t c·∫£ tab kh√°c!')) {
                return;
            }

            const btnMigrate = document.getElementById('btnMigrate');
            const btnCheck = document.getElementById('btnCheckStatus');
            const btnRollback = document.getElementById('btnRollback');

            btnMigrate.disabled = true;
            btnCheck.disabled = true;
            btnRollback.disabled = true;

            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log('B·∫ÆTƒê·∫¶U MIGRATION', 'info');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

            try {
                // Step 1: Backup
                updateProgress(10);
                log('Step 1/5: T·∫°o backup d·ªØ li·ªáu c≈©...', 'info');

                if (!productData || !Array.isArray(productData)) {
                    throw new Error('D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ ƒë∆∞·ª£c migrate');
                }

                const backupKey = 'savedProducts_backup_' + Date.now();
                await database.ref(backupKey).set(productData);
                log(`‚úÖ ƒê√£ backup ${productData.length} s·∫£n ph·∫©m v√†o ${backupKey}`, 'success');

                // Step 2: Prepare new structure
                updateProgress(30);
                log('Step 2/5: Chuy·ªÉn ƒë·ªïi c·∫•u tr√∫c...', 'info');

                const productsObject = {};
                const sortedIds = [];
                let processedCount = 0;

                productData.forEach((product, index) => {
                    if (product && product.Id) {
                        const productKey = `product_${product.Id}`;
                        productsObject[productKey] = product;
                        sortedIds.push(product.Id.toString());
                        processedCount++;

                        if ((index + 1) % 10 === 0) {
                            log(`  ‚Üí ƒê√£ x·ª≠ l√Ω ${index + 1}/${productData.length} s·∫£n ph·∫©m`);
                        }
                    }
                });

                log(`‚úÖ ƒê√£ chuy·ªÉn ƒë·ªïi ${processedCount} s·∫£n ph·∫©m sang c·∫•u tr√∫c Object`, 'success');

                // Step 3: Write new structure
                updateProgress(60);
                log('Step 3/5: Ghi c·∫•u tr√∫c m·ªõi l√™n Firebase...', 'info');

                await database.ref('savedProducts').set(productsObject);
                log('‚úÖ ƒê√£ ghi savedProducts (object structure)', 'success');

                updateProgress(80);
                log('Step 4/5: Ghi metadata...', 'info');

                await database.ref('savedProductsMeta').set({
                    sortedIds: sortedIds,
                    count: sortedIds.length,
                    lastUpdated: Date.now(),
                    migratedAt: Date.now(),
                    version: 2
                });
                log('‚úÖ ƒê√£ ghi metadata', 'success');

                // Step 5: Verify
                updateProgress(90);
                log('Step 5/5: X√°c minh d·ªØ li·ªáu...', 'info');

                const verifySnapshot = await database.ref('savedProducts').once('value');
                const newData = verifySnapshot.val();

                if (typeof newData === 'object' && !Array.isArray(newData)) {
                    const newProductCount = Object.keys(newData).length;
                    if (newProductCount === processedCount) {
                        updateProgress(100);
                        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
                        log('üéâ MIGRATION TH√ÄNH C√îNG!', 'success');
                        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
                        log(`  ‚Üí C·∫•u tr√∫c: Object-based ‚úì`, 'success');
                        log(`  ‚Üí T·ªïng s·∫£n ph·∫©m: ${newProductCount}`, 'success');
                        log(`  ‚Üí Backup t·∫°i: ${backupKey}`, 'success');
                        log('', 'info');
                        log('üìù B∆Ø·ªöC TI·∫æP THEO:', 'info');
                        log('  1. Deploy code m·ªõi (index.html & product-list.html)', 'info');
                        log('  2. Test th√™m/x√≥a/update s·∫£n ph·∫©m', 'info');
                        log('  3. N·∫øu c√≥ v·∫•n ƒë·ªÅ, click "Rollback"', 'info');

                        // Update UI
                        await checkCurrentStatus();
                    } else {
                        throw new Error(`S·ªë l∆∞·ª£ng s·∫£n ph·∫©m kh√¥ng kh·ªõp: ${newProductCount} vs ${processedCount}`);
                    }
                } else {
                    throw new Error('C·∫•u tr√∫c m·ªõi v·∫´n l√† array!');
                }

            } catch (error) {
                updateProgress(0);
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'error');
                log('‚ùå MIGRATION TH·∫§T B·∫†I!', 'error');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'error');
                log('L·ªói: ' + error.message, 'error');
                log('', 'error');
                log('D·ªØ li·ªáu backup v·∫´n c√≤n, b·∫°n c√≥ th·ªÉ rollback.', 'warning');
                console.error(error);

                btnRollback.disabled = false;
            } finally {
                btnCheck.disabled = false;
            }
        }

        async function rollback() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ROLLBACK v·ªÅ c·∫•u tr√∫c c≈©?\n\n‚ö†Ô∏è Thao t√°c n√†y s·∫Ω kh√¥i ph·ª•c backup g·∫ßn nh·∫•t.')) {
                return;
            }

            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
            log('ROLLBACK...', 'warning');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');

            try {
                // Find latest backup
                const rootSnapshot = await database.ref('/').once('value');
                const rootData = rootSnapshot.val();
                const backupKeys = Object.keys(rootData).filter(k => k.startsWith('savedProducts_backup_'));

                if (backupKeys.length === 0) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y backup n√†o!');
                }

                const latestBackup = backupKeys.sort().reverse()[0];
                const backupData = rootData[latestBackup];

                log(`ƒêang kh√¥i ph·ª•c t·ª´: ${latestBackup}`, 'info');

                // Restore
                await database.ref('savedProducts').set(backupData);

                // Remove metadata
                await database.ref('savedProductsMeta').remove();

                log('‚úÖ ROLLBACK TH√ÄNH C√îNG!', 'success');
                log(`ƒê√£ kh√¥i ph·ª•c ${backupData.length} s·∫£n ph·∫©m`, 'success');

                // Refresh status
                await checkCurrentStatus();

            } catch (error) {
                log('‚ùå L·ªói khi rollback: ' + error.message, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
