<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <title>B·∫£ng Ki·ªÉm H√†ng - G·ªôp theo NCC</title>
        <meta http-equiv="Cache-Control" content="public, max-age=31536000" />
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="preconnect" href="https://fonts.googleapis.com/" />
        <link
            rel="preconnect"
            href="https://fonts.gstatic.com/"
            crossorigin=""
        />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- Firebase SDKs -->
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

        <!-- CSS script -->
        <script src="../js/device-detector.js"></script>
        <!-- Navigation Manager - Load tr∆∞·ªõc khi load page scripts -->
        <script src="../js/navigation.js"></script>
        <script src="../js/common-utils.js"></script>
    </head>

    <body>
        <!-- Top buttons -->
        <div class="top-buttons">
            <button
                data-icon="üõ†Ô∏è"
                id="toggleGroupingButton"
                class="toggle-grouping-btn"
            >
                T·∫Øt g·ªôp NCC
            </button>
            <button data-icon="üîÑ" id="toggleFormButton">
                L√†m m·ªõi d·ªØ li·ªáu
            </button>
            <button data-icon="üì§" id="exportButton">Xu·∫•t Excel</button>
            <button data-icon="üö™" id="toggleLogoutButton">ƒêƒÉng xu·∫•t</button>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <div class="header" style="text-align: center; margin: 20px 0">
                <h1 class="page-title">B·∫¢NG KI·ªÇM H√ÄNG - G·ªòP THEO NCC</h1>
            </div>

            <div class="inventory-container">
                <!-- Filter Section -->
                <div class="filter-section">
                    <h3>
                        B·ªô l·ªçc d·ªØ li·ªáu
                        <span id="groupingIndicator">G·ªòP THEO NCC</span>
                    </h3>
                    <div class="filter-group">
                        <div>
                            <label for="filterSupplier"
                                >Ch·ªçn nh√† cung c·∫•p:</label
                            >
                            <select id="filterSupplier">
                                <option value="all">T·∫•t c·∫£</option>
                            </select>
                        </div>
                        <div>
                            <label for="dateFilter">L·ªçc ng√†y nh·∫≠n h√†ng:</label>
                            <select id="dateFilter">
                                <option value="all">T·∫•t c·∫£</option>
                                <option value="today">H√¥m nay</option>
                                <option value="week">Tu·∫ßn n√†y</option>
                                <option value="month">Th√°ng n√†y</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterProduct">L·ªçc s·∫£n ph·∫©m:</label>
                            <input
                                type="text"
                                id="filterProduct"
                                placeholder="T√¨m ki·∫øm theo t√™n ho·∫∑c m√£ s·∫£n ph·∫©m..."
                            />
                        </div>
                    </div>

                    <div id="groupingExplanation">
                        <strong>üìã Ch·∫ø ƒë·ªô g·ªôp theo NCC:</strong> T·∫•t c·∫£ c√°c ƒë∆°n
                        h√†ng t·ª´ c√πng nh√† cung c·∫•p s·∫Ω ƒë∆∞·ª£c g·ªôp l·∫°i th√†nh m·ªôt d√≤ng
                        ƒë·ªÉ d·ªÖ theo d√µi.
                    </div>
                </div>

                <!-- Table Section -->
                <div class="table-container">
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th style="width: 10%">Ng√†y ƒë·∫∑t h√†ng</th>
                                <th style="width: 10%">Ng√†y nh·∫≠n h√†ng</th>
                                <th style="width: 12%">Nh√† cung c·∫•p</th>
                                <th style="width: 12%">M√£ s·∫£n ph·∫©m</th>
                                <th style="width: 15%">T√™n s·∫£n ph·∫©m</th>
                                <th style="width: 12%">S·ªë l∆∞·ª£ng ƒë·∫∑t</th>
                                <th style="width: 10%">Th·ª±c nh·∫≠n</th>
                                <th style="width: 10%">T·ªïng nh·∫≠n</th>
                                <th style="width: 9%">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="orderTableBody">
                            <tr class="loading-row">
                                <td
                                    colspan="9"
                                    style="
                                        text-align: center;
                                        padding: 40px;
                                        color: #6c757d;
                                        font-style: italic;
                                    "
                                >
                                    <div
                                        style="
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            gap: 10px;
                                        "
                                    >
                                        <div
                                            style="
                                                width: 20px;
                                                height: 20px;
                                                border: 2px solid #f3f3f3;
                                                border-top: 2px solid #007bff;
                                                border-radius: 50%;
                                                animation: spin 1s linear
                                                    infinite;
                                            "
                                        ></div>
                                        ƒêang t·∫£i d·ªØ li·ªáu ki·ªÉm h√†ng t·ª´
                                        Firebase...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Statistics Section -->
                <div class="filter-section" style="margin-top: 30px">
                    <h3>Th·ªëng k√™ nhanh</h3>
                    <div class="stats-grid">
                        <div class="stat-card total">
                            <div class="stat-number" id="totalProducts">0</div>
                            <div class="stat-label">T·ªïng s·∫£n ph·∫©m</div>
                        </div>
                        <div class="stat-card completed">
                            <div class="stat-number" id="completedProducts">
                                0
                            </div>
                            <div class="stat-label">ƒê√£ ho√†n th√†nh</div>
                        </div>
                        <div class="stat-card partial">
                            <div class="stat-number" id="partialProducts">
                                0
                            </div>
                            <div class="stat-label">Nh·∫≠n m·ªôt ph·∫ßn</div>
                        </div>
                        <div class="stat-card pending">
                            <div class="stat-number" id="pendingProducts">
                                0
                            </div>
                            <div class="stat-label">Ch∆∞a nh·∫≠n</div>
                        </div>
                        <div class="stat-card grouped">
                            <div class="stat-number" id="groupedItems">0</div>
                            <div class="stat-label">M·ª•c ƒë√£ g·ªôp</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Floating Alert -->
        <div id="floatingAlert">
            <div class="loading-spinner"></div>
            <div class="alert-text">Th√¥ng b√°o hi·ªÉn th·ªã!</div>
        </div>

        <!-- JavaScript -->
        <script>
            // =====================================================
            // CONFIGURATION & GLOBAL VARIABLES
            // =====================================================

            // Firebase Configuration
            const firebaseConfig = {
                apiKey: "AIzaSyA-legWlCgjMDEy70rsaTTwLK39F4ZCKhM",
                authDomain: "n2shop-69e37.firebaseapp.com",
                projectId: "n2shop-69e37",
                storageBucket: "n2shop-69e37-ne0q1",
                messagingSenderId: "598906493303",
                appId: "1:598906493303:web:46d6236a1fdc2eff33e972",
                measurementId: "G-TEJH3S2T1D",
            };

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const collectionRef = db.collection("dathang");
            const historyCollectionRef = db.collection("edit_history");

            // DOM Elements
            const tbody = document.getElementById("orderTableBody");
            const filterSupplierSelect =
                document.getElementById("filterSupplier");
            const dateFilterSelect = document.getElementById("dateFilter");
            const filterProductInput = document.getElementById("filterProduct");

            // Configuration
            const CACHE_EXPIRY = 10 * 60 * 1000; // 10 minutes
            const MAX_VISIBLE_ROWS = 500;
            const FILTER_DEBOUNCE_DELAY = 500;

            // Global variables
            let groupingEnabled = true;
            let memoryCache = { data: null, timestamp: null };
            let isFilteringInProgress = false;
            let currentFilters = { supplier: "all", date: "all", product: "" };

            // =====================================================
            // AUTHENTICATION FUNCTIONS
            // =====================================================

            const AUTH_STORAGE_KEY = "loginindex_auth";
            let authState = null;

            function getAuthState() {
                try {
                    const stored = localStorage.getItem(AUTH_STORAGE_KEY);
                    if (stored) {
                        authState = JSON.parse(stored);
                        return authState;
                    }
                } catch (error) {
                    console.error("Error reading auth state:", error);
                }
                return null;
            }

            function isAuthenticated() {
                const auth = getAuthState();
                return auth && auth.isLoggedIn === "true";
            }

            function getUserName() {
                const auth = getAuthState();
                return auth && auth.userType
                    ? auth.userType.split("-")[0]
                    : "Admin";
            }

            function hasPermission(requiredLevel) {
                const auth = getAuthState();
                if (!auth) return false;
                const userLevel = parseInt(auth.checkLogin);
                return userLevel <= requiredLevel;
            }

            // =====================================================
            // UTILITY FUNCTIONS
            // =====================================================

            function sanitizeInput(input) {
                if (typeof input !== "string") return "";
                return input.replace(/[<>"'&]/g, "").trim();
            }

            function formatDate(date) {
                if (!date || !(date instanceof Date)) return "";
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, "0");
                const day = date.getDate().toString().padStart(2, "0");
                return `${day}/${month}/${year}`;
            }

            function parseVietnameseDate(dateString) {
                if (!dateString) return null;

                try {
                    const cleanDateString = dateString
                        .replace(/,?\s*/g, " ")
                        .trim();
                    const patterns = [
                        /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s+(\d{1,2}):(\d{2})/,
                        /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,
                    ];

                    for (let pattern of patterns) {
                        const match = cleanDateString.match(pattern);
                        if (match) {
                            const [, day, month, year, hour = 0, minute = 0] =
                                match;
                            return new Date(
                                parseInt(year),
                                parseInt(month) - 1,
                                parseInt(day),
                                parseInt(hour),
                                parseInt(minute),
                            );
                        }
                    }

                    const date = new Date(dateString);
                    return isNaN(date.getTime()) ? null : date;
                } catch (error) {
                    console.warn("Error parsing date:", dateString, error);
                    return null;
                }
            }

            function getFormattedDateTime() {
                const currentDate = new Date();
                const day = currentDate.getDate().toString().padStart(2, "0");
                const month = (currentDate.getMonth() + 1)
                    .toString()
                    .padStart(2, "0");
                const year = currentDate.getFullYear();
                const hour = currentDate.getHours().toString().padStart(2, "0");
                const minute = currentDate
                    .getMinutes()
                    .toString()
                    .padStart(2, "0");
                return `${day}/${month}/${year}, ${hour}:${minute}`;
            }

            function generateUniqueID() {
                const timestamp = Date.now().toString(36);
                const random = Math.random().toString(36).substr(2, 9);
                return `inv_${timestamp}_${random}`;
            }

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // =====================================================
            // CACHE FUNCTIONS
            // =====================================================

            function getCachedData() {
                try {
                    if (memoryCache.data && memoryCache.timestamp) {
                        if (Date.now() - memoryCache.timestamp < CACHE_EXPIRY) {
                            console.log("Using cached inventory data");
                            return [...memoryCache.data];
                        } else {
                            console.log("Cache expired, clearing");
                            invalidateCache();
                        }
                    }
                } catch (e) {
                    console.warn("Error accessing cache:", e);
                    invalidateCache();
                }
                return null;
            }

            function setCachedData(data) {
                try {
                    memoryCache.data = [...data];
                    memoryCache.timestamp = Date.now();
                    console.log("Inventory data cached successfully");
                } catch (e) {
                    console.warn("Cannot cache data:", e);
                }
            }

            function invalidateCache() {
                memoryCache.data = null;
                memoryCache.timestamp = null;
                console.log("Cache invalidated");
            }

            // =====================================================
            // FLOATING ALERT FUNCTIONS
            // =====================================================

            function showFloatingAlert(
                message,
                isLoading = false,
                duration = 0,
            ) {
                const alert = document.getElementById("floatingAlert");
                const alertText = alert.querySelector(".alert-text");
                const spinner = alert.querySelector(".loading-spinner");

                alertText.textContent = message;

                if (isLoading) {
                    alert.classList.add("loading");
                    spinner.style.display = "block";
                } else {
                    alert.classList.remove("loading");
                    spinner.style.display = "none";
                }

                alert.classList.add("show");

                if (duration > 0) {
                    setTimeout(() => {
                        hideFloatingAlert();
                    }, duration);
                }
            }

            function hideFloatingAlert() {
                const alert = document.getElementById("floatingAlert");
                alert.classList.remove("show", "loading");
                alert.querySelector(".loading-spinner").style.display = "none";
            }

            // =====================================================
            // DATA TRANSFORMATION WITH GROUPING
            // =====================================================

            function transformOrderDataToInventory(
                orderData,
                enableGrouping = true,
            ) {
                if (!Array.isArray(orderData)) return [];

                const inventoryMap = new Map();

                orderData.forEach((order) => {
                    if (!order.maSanPham && !order.tenSanPham) return;

                    // Only group by supplier (nhaCungCap), not by product
                    const supplier = order.nhaCungCap || "Unknown";
                    const groupingKey = enableGrouping ? supplier : order.id;

                    if (inventoryMap.has(groupingKey)) {
                        const existing = inventoryMap.get(groupingKey);
                        existing.soLuong += order.soLuong || 0;
                        existing.thucNhan += order.thucNhan || 0;
                        existing.tongNhan += order.tongNhan || 0;

                        if (!existing.groupedOrderIds) {
                            existing.groupedOrderIds = [
                                existing.originalOrderId,
                            ];
                        }
                        existing.groupedOrderIds.push(order.id);
                        existing.groupedCount =
                            (existing.groupedCount || 1) + 1;

                        const existingDate = parseVietnameseDate(
                            existing.ngayNhan,
                        );
                        const orderDate = parseVietnameseDate(
                            order.thoiGianUpload,
                        );

                        if (
                            orderDate &&
                            (!existingDate || orderDate > existingDate)
                        ) {
                            existing.ngayNhan = order.thoiGianUpload;
                            existing.lastOrderId = order.id;
                        }

                        if (order.ngayDatHang)
                            existing.ngayDatHang = order.ngayDatHang;

                        // For grouped items, combine product names and codes
                        if (
                            order.maSanPham &&
                            existing.maSanPham &&
                            !existing.maSanPham.includes(order.maSanPham)
                        ) {
                            existing.maSanPham += `, ${order.maSanPham}`;
                        }
                        if (
                            order.tenSanPham &&
                            existing.tenSanPham &&
                            !existing.tenSanPham.includes(order.tenSanPham)
                        ) {
                            existing.tenSanPham += `, ${order.tenSanPham}`;
                        }
                    } else {
                        const inventoryRecord = {
                            id: enableGrouping
                                ? `grouped_${supplier}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                : order.id || generateUniqueID(),
                            ngayDatHang: order.ngayDatHang,
                            ngayNhan: order.thoiGianUpload,
                            nhaCungCap: order.nhaCungCap,
                            maSanPham: order.maSanPham || "",
                            tenSanPham: order.tenSanPham || "",
                            soLuong: order.soLuong || 0,
                            thucNhan: order.thucNhan || 0,
                            tongNhan: order.tongNhan || 0,
                            originalOrderId: order.id,
                            lastUpdated:
                                order.lastUpdated || getFormattedDateTime(),
                            updatedBy: order.updatedBy || getUserName(),
                            inventoryUpdated: order.inventoryUpdated || false,
                            isGrouped: false,
                            groupedCount: 1,
                            groupingKey: supplier,
                        };

                        inventoryMap.set(groupingKey, inventoryRecord);
                    }
                });

                // Mark grouped items
                Array.from(inventoryMap.values()).forEach((item) => {
                    if (item.groupedCount > 1) {
                        item.isGrouped = true;
                    }
                });

                return Array.from(inventoryMap.values());
            }

            // =====================================================
            // DATA LOADING FUNCTIONS
            // =====================================================

            async function loadInventoryData(enableGrouping = true) {
                const cachedData = getCachedData();
                if (cachedData && !enableGrouping) {
                    showFloatingAlert("S·ª≠ d·ª•ng d·ªØ li·ªáu cache...", true);
                    renderInventoryTable(cachedData);
                    updateFilterOptions(cachedData);
                    hideFloatingAlert();
                    showFloatingAlert(
                        "T·∫£i d·ªØ li·ªáu t·ª´ cache ho√†n t·∫•t!",
                        false,
                        2000,
                    );
                    return;
                }

                showFloatingAlert(
                    "ƒêang t·∫£i d·ªØ li·ªáu ƒë·∫∑t h√†ng t·ª´ Firebase...",
                    true,
                );

                try {
                    // Load order data from Firebase 'dathang' collection
                    const doc = await collectionRef.doc("dathang").get();
                    let orderData = [];

                    if (doc.exists) {
                        const data = doc.data();
                        if (data && Array.isArray(data.data)) {
                            orderData = data.data;
                            console.log(
                                `Loaded ${orderData.length} orders from Firebase`,
                            );
                        } else {
                            console.warn(
                                "No data array found in dathang document",
                            );
                            showFloatingAlert(
                                "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·∫∑t h√†ng!",
                                false,
                                3000,
                            );
                            return;
                        }
                    } else {
                        console.warn("dathang document does not exist");
                        showFloatingAlert(
                            "Kh√¥ng t√¨m th·∫•y collection dathang!",
                            false,
                            3000,
                        );
                        return;
                    }

                    if (orderData.length === 0) {
                        showFloatingAlert(
                            "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·∫∑t h√†ng n√†o!",
                            false,
                            3000,
                        );
                        tbody.innerHTML =
                            '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã</td></tr>';
                        return;
                    }

                    const inventoryData = transformOrderDataToInventory(
                        orderData,
                        enableGrouping,
                    );

                    const sortedData = inventoryData.sort((a, b) => {
                        const dateA = parseVietnameseDate(a.ngayNhan);
                        const dateB = parseVietnameseDate(b.ngayNhan);

                        if (dateA && dateB) {
                            return dateB - dateA;
                        }

                        return 0;
                    });

                    renderInventoryTable(sortedData);
                    updateFilterOptions(sortedData);
                    setCachedData(sortedData);

                    hideFloatingAlert();
                    showFloatingAlert("T·∫£i d·ªØ li·ªáu ho√†n t·∫•t!", false, 2000);
                } catch (error) {
                    console.error("Error loading inventory data:", error);
                    hideFloatingAlert();
                    showFloatingAlert(
                        "L·ªói khi t·∫£i d·ªØ li·ªáu: " + error.message,
                        false,
                        3000,
                    );
                }
            }

            // =====================================================
            // FILTER FUNCTIONS
            // =====================================================

            function applyFiltersToInventory(dataArray) {
                const filterSupplier = filterSupplierSelect
                    ? filterSupplierSelect.value
                    : "all";
                const filterDate = dateFilterSelect
                    ? dateFilterSelect.value
                    : "all";
                const filterProductText = filterProductInput
                    ? filterProductInput.value.toLowerCase().trim()
                    : "";

                return dataArray.filter((item) => {
                    const matchSupplier =
                        filterSupplier === "all" ||
                        item.nhaCungCap === filterSupplier;

                    let matchDate = true;
                    if (filterDate !== "all") {
                        const itemDate =
                            parseVietnameseDate(item.ngayNhan) ||
                            parseVietnameseDate(item.ngayDatHang);
                        if (itemDate) {
                            const today = new Date();
                            const todayStart = new Date(
                                today.getFullYear(),
                                today.getMonth(),
                                today.getDate(),
                            );

                            if (filterDate === "today") {
                                const itemDateStart = new Date(
                                    itemDate.getFullYear(),
                                    itemDate.getMonth(),
                                    itemDate.getDate(),
                                );
                                matchDate =
                                    itemDateStart.getTime() ===
                                    todayStart.getTime();
                            } else if (filterDate === "week") {
                                const weekAgo = new Date(
                                    todayStart.getTime() -
                                        7 * 24 * 60 * 60 * 1000,
                                );
                                matchDate = itemDate >= weekAgo;
                            } else if (filterDate === "month") {
                                const monthAgo = new Date(
                                    todayStart.getFullYear(),
                                    todayStart.getMonth() - 1,
                                    todayStart.getDate(),
                                );
                                matchDate = itemDate >= monthAgo;
                            }
                        }
                    }

                    const matchProduct =
                        !filterProductText ||
                        (item.tenSanPham &&
                            item.tenSanPham
                                .toLowerCase()
                                .includes(filterProductText)) ||
                        (item.maSanPham &&
                            item.maSanPham
                                .toLowerCase()
                                .includes(filterProductText));

                    return matchSupplier && matchDate && matchProduct;
                });
            }

            function updateFilterOptions(fullDataArray) {
                if (!filterSupplierSelect) return;

                const suppliers = [
                    ...new Set(
                        fullDataArray
                            .map((item) => item.nhaCungCap)
                            .filter((supplier) => supplier),
                    ),
                ];
                const currentSelectedValue = filterSupplierSelect.value;

                while (filterSupplierSelect.children.length > 1) {
                    filterSupplierSelect.removeChild(
                        filterSupplierSelect.lastChild,
                    );
                }

                suppliers.forEach((supplier) => {
                    const option = document.createElement("option");
                    option.value = supplier;
                    option.textContent = supplier;
                    filterSupplierSelect.appendChild(option);
                });

                if (
                    currentSelectedValue &&
                    currentSelectedValue !== "all" &&
                    suppliers.includes(currentSelectedValue)
                ) {
                    filterSupplierSelect.value = currentSelectedValue;
                }
            }

            const debouncedApplyFilters = debounce(() => {
                if (isFilteringInProgress) return;
                isFilteringInProgress = true;
                showFloatingAlert("ƒêang l·ªçc d·ªØ li·ªáu...", true);

                setTimeout(() => {
                    try {
                        const cachedData = getCachedData();
                        if (cachedData) {
                            renderInventoryTable(cachedData);
                        } else {
                            loadInventoryData(groupingEnabled);
                        }
                        hideFloatingAlert();
                        showFloatingAlert("L·ªçc d·ªØ li·ªáu ho√†n t·∫•t!", false, 1000);
                    } catch (error) {
                        console.error("Error during filtering:", error);
                        hideFloatingAlert();
                        showFloatingAlert(
                            "C√≥ l·ªói x·∫£y ra khi l·ªçc d·ªØ li·ªáu",
                            false,
                            3000,
                        );
                    } finally {
                        isFilteringInProgress = false;
                    }
                }, 100);
            }, FILTER_DEBOUNCE_DELAY);

            function applyFilters() {
                debouncedApplyFilters();
            }

            // =====================================================
            // TABLE RENDERING
            // =====================================================

            function renderInventoryTable(inventoryData) {
                if (!tbody) {
                    console.error("Table body not found");
                    return;
                }

                const filteredData = applyFiltersToInventory(inventoryData);
                tbody.innerHTML = "";

                // Add summary row
                if (filteredData.length > 0) {
                    const summaryRow = document.createElement("tr");
                    summaryRow.className = "summary-row";
                    const summaryTd = document.createElement("td");
                    summaryTd.colSpan = 9;

                    const totalItems = filteredData.length;
                    const groupedItems = filteredData.filter(
                        (item) => item.isGrouped,
                    ).length;
                    const originalOrders = filteredData.reduce(
                        (sum, item) => sum + (item.groupedCount || 1),
                        0,
                    );

                    summaryTd.innerHTML = `
                    Hi·ªÉn th·ªã: <strong>${totalItems}</strong> s·∫£n ph·∫©m 
                    (<strong>${groupedItems}</strong> ƒë√£ g·ªôp t·ª´ <strong>${originalOrders}</strong> ƒë∆°n h√†ng g·ªëc)
                `;
                    summaryRow.appendChild(summaryTd);
                    tbody.appendChild(summaryRow);
                }

                // Render inventory rows
                const maxRender = Math.min(
                    filteredData.length,
                    MAX_VISIBLE_ROWS,
                );

                for (let i = 0; i < maxRender; i++) {
                    const item = filteredData[i];
                    const tr = document.createElement("tr");
                    tr.className = "inventory-row";
                    tr.setAttribute("data-inventory-id", item.id || "");

                    // Add special styling for grouped items
                    if (item.isGrouped) {
                        tr.classList.add("grouped");
                    }

                    // Create cells
                    const cells = [];
                    for (let j = 0; j < 9; j++) {
                        cells[j] = document.createElement("td");
                    }

                    // Ng√†y ƒë·∫∑t h√†ng
                    cells[0].textContent = item.ngayDatHang || "Ch∆∞a nh·∫≠p";

                    // Ng√†y nh·∫≠n h√†ng
                    const receivedDate = parseVietnameseDate(item.ngayNhan);
                    if (receivedDate) {
                        cells[1].textContent = formatDate(receivedDate);
                    } else {
                        cells[1].textContent = item.ngayNhan || "Ch∆∞a nh·∫≠p";
                    }

                    // Nh√† cung c·∫•p
                    cells[2].textContent = sanitizeInput(item.nhaCungCap || "");

                    // M√£ s·∫£n ph·∫©m
                    cells[3].textContent = sanitizeInput(item.maSanPham || "");

                    // T√™n s·∫£n ph·∫©m
                    cells[4].textContent = sanitizeInput(item.tenSanPham || "");

                    // S·ªë l∆∞·ª£ng (with grouping indicator)
                    const quantityDiv = document.createElement("div");
                    if (item.isGrouped) {
                        quantityDiv.innerHTML = `
                        <strong>${item.soLuong || 0}</strong>
                        <br><small style="color: #28a745; font-weight: bold;">
                            (G·ªôp ${item.groupedCount} ƒë∆°n)
                        </small>
                    `;
                    } else {
                        quantityDiv.textContent = item.soLuong || 0;
                    }
                    quantityDiv.style.textAlign = "center";
                    quantityDiv.style.fontWeight = "bold";
                    cells[5].appendChild(quantityDiv);

                    // Th·ª±c nh·∫≠n
                    const receivedContainer = document.createElement("div");
                    const receivedLabel = document.createElement("span");
                    receivedLabel.className = "received-label";
                    if (item.thucNhan || item.thucNhan === 0) {
                        receivedLabel.textContent = item.thucNhan;
                        if (item.isGrouped && item.thucNhan > 0) {
                            receivedLabel.style.background = "#d4edda";
                            receivedLabel.style.borderColor = "#28a745";
                        }
                    } else {
                        receivedLabel.textContent = "Ch∆∞a nh·∫≠p";
                        receivedLabel.classList.add("empty");
                    }
                    receivedLabel.setAttribute("data-field", "thucNhan");
                    receivedLabel.setAttribute(
                        "data-inventory-id",
                        item.id || "",
                    );
                    receivedContainer.appendChild(receivedLabel);
                    cells[6].appendChild(receivedContainer);

                    // T·ªïng nh·∫≠n
                    const totalContainer = document.createElement("div");
                    const totalLabel = document.createElement("span");
                    totalLabel.className = "total-label";
                    if (item.tongNhan || item.tongNhan === 0) {
                        totalLabel.textContent = item.tongNhan;
                        if (item.isGrouped && item.tongNhan > 0) {
                            totalLabel.style.background = "#d4edda";
                            totalLabel.style.borderColor = "#28a745";
                        }
                    } else {
                        totalLabel.textContent = "Ch∆∞a nh·∫≠p";
                        totalLabel.classList.add("empty");
                    }
                    totalLabel.setAttribute("data-field", "tongNhan");
                    totalLabel.setAttribute("data-inventory-id", item.id || "");
                    totalContainer.appendChild(totalLabel);
                    cells[7].appendChild(totalContainer);

                    // Buttons
                    const buttonGroup = document.createElement("div");
                    buttonGroup.className = "button-group";

                    const editButton = document.createElement("button");
                    editButton.className = "edit-button";
                    editButton.setAttribute("data-inventory-id", item.id || "");
                    editButton.setAttribute(
                        "data-inventory-info",
                        `${sanitizeInput(item.tenSanPham || item.maSanPham || "Unknown")}`,
                    );
                    editButton.setAttribute(
                        "data-is-grouped",
                        item.isGrouped ? "true" : "false",
                    );
                    editButton.addEventListener("click", editInventoryItem);

                    const deleteButton = document.createElement("button");
                    deleteButton.className = "delete-button";
                    deleteButton.setAttribute(
                        "data-inventory-id",
                        item.id || "",
                    );
                    deleteButton.setAttribute(
                        "data-inventory-info",
                        `${sanitizeInput(item.tenSanPham || item.maSanPham || "Unknown")}`,
                    );
                    deleteButton.setAttribute(
                        "data-is-grouped",
                        item.isGrouped ? "true" : "false",
                    );
                    deleteButton.addEventListener("click", deleteInventoryItem);

                    buttonGroup.appendChild(editButton);
                    buttonGroup.appendChild(deleteButton);
                    cells[8].appendChild(buttonGroup);

                    // Apply permissions
                    const auth = getAuthState();
                    if (auth) {
                        const editableElements = [receivedLabel, totalLabel];
                        applyRowPermissions(
                            tr,
                            editableElements,
                            [editButton, deleteButton],
                            parseInt(auth.checkLogin),
                        );
                    }

                    // Append cells to row
                    cells.forEach((cell) => tr.appendChild(cell));
                    tbody.appendChild(tr);
                }

                updateFilterOptions(inventoryData);
                updateStatistics(inventoryData);
            }

            function applyRowPermissions(
                row,
                editableElements,
                buttons,
                userRole,
            ) {
                if (userRole !== 0) {
                    editableElements.forEach((element) => {
                        element.style.opacity = "0.6";
                        element.style.cursor = "not-allowed";
                    });
                    buttons.forEach(
                        (button) => (button.style.display = "none"),
                    );
                    row.style.opacity = "0.7";
                } else {
                    editableElements.forEach((element) => {
                        element.style.opacity = "1";
                        element.style.cursor = "pointer";
                    });
                    buttons.forEach((button) => (button.style.display = ""));
                    row.style.opacity = "1";
                }
            }

            // =====================================================
            // CRUD OPERATIONS
            // =====================================================

            async function editInventoryItem(event) {
                const auth = getAuthState();
                if (!auth || parseInt(auth.checkLogin) > 0) {
                    showFloatingAlert("Kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a", false, 3000);
                    return;
                }

                const button = event.currentTarget;
                const inventoryId = button.getAttribute("data-inventory-id");
                const itemInfo = button.getAttribute("data-inventory-info");
                const isGrouped =
                    button.getAttribute("data-is-grouped") === "true";

                if (!inventoryId) {
                    showFloatingAlert(
                        "Kh√¥ng t√¨m th·∫•y ID s·∫£n ph·∫©m!",
                        false,
                        3000,
                    );
                    return;
                }

                const row = button.closest("tr");

                if (row.classList.contains("editing")) {
                    await saveInventoryChanges(
                        row,
                        inventoryId,
                        itemInfo,
                        isGrouped,
                    );
                } else {
                    startEditingInventory(row, button, isGrouped);
                }
            }

            function startEditingInventory(row, button, isGrouped) {
                row.classList.add("editing");
                button.textContent = "L∆∞u";
                button.style.background = "var(--success-gradient)";

                const receivedLabel = row.querySelector(".received-label");
                const totalLabel = row.querySelector(".total-label");

                if (receivedLabel) {
                    const currentValue = receivedLabel.classList.contains(
                        "empty",
                    )
                        ? ""
                        : receivedLabel.textContent;
                    const input = document.createElement("input");
                    input.type = "number";
                    input.className = "received-input";
                    input.value =
                        currentValue === "Ch∆∞a nh·∫≠p" ? "" : currentValue;
                    input.min = "0";
                    input.step = "any";
                    input.placeholder = "0";
                    input.setAttribute("data-field", "thucNhan");
                    input.setAttribute(
                        "data-inventory-id",
                        receivedLabel.getAttribute("data-inventory-id"),
                    );

                    receivedLabel.parentNode.replaceChild(input, receivedLabel);
                    input.focus();
                    input.select();
                }

                if (totalLabel) {
                    const currentValue = totalLabel.classList.contains("empty")
                        ? ""
                        : totalLabel.textContent;
                    const input = document.createElement("input");
                    input.type = "number";
                    input.className = "total-input";
                    input.value =
                        currentValue === "Ch∆∞a nh·∫≠p" ? "" : currentValue;
                    input.min = "0";
                    input.step = "any";
                    input.placeholder = "0";
                    input.setAttribute("data-field", "tongNhan");
                    input.setAttribute(
                        "data-inventory-id",
                        totalLabel.getAttribute("data-inventory-id"),
                    );

                    totalLabel.parentNode.replaceChild(input, totalLabel);
                }
            }

            async function saveInventoryChanges(
                row,
                inventoryId,
                itemInfo,
                isGrouped,
            ) {
                try {
                    showFloatingAlert("ƒêang l∆∞u thay ƒë·ªïi...", true);

                    const receivedInput = row.querySelector(".received-input");
                    const totalInput = row.querySelector(".total-input");

                    const receivedValue = receivedInput
                        ? parseFloat(receivedInput.value) || 0
                        : 0;
                    const totalValue = totalInput
                        ? parseFloat(totalInput.value) || 0
                        : 0;

                    const updateData = {
                        thucNhan: receivedValue,
                        tongNhan: totalValue,
                        lastUpdated: getFormattedDateTime(),
                        updatedBy: getUserName(),
                        inventoryUpdated: true,
                    };

                    // Update in Firebase
                    await updateOrderInventoryData(inventoryId, updateData);

                    // Convert inputs back to labels
                    if (receivedInput) {
                        const label = document.createElement("span");
                        label.className = "received-label";
                        label.textContent =
                            receivedValue || receivedValue === 0
                                ? receivedValue
                                : "Ch∆∞a nh·∫≠p";
                        if (!receivedValue && receivedValue !== 0)
                            label.classList.add("empty");
                        label.setAttribute("data-field", "thucNhan");
                        label.setAttribute("data-inventory-id", inventoryId);
                        receivedInput.parentNode.replaceChild(
                            label,
                            receivedInput,
                        );
                    }

                    if (totalInput) {
                        const label = document.createElement("span");
                        label.className = "total-label";
                        label.textContent =
                            totalValue || totalValue === 0
                                ? totalValue
                                : "Ch∆∞a nh·∫≠p";
                        if (!totalValue && totalValue !== 0)
                            label.classList.add("empty");
                        label.setAttribute("data-field", "tongNhan");
                        label.setAttribute("data-inventory-id", inventoryId);
                        totalInput.parentNode.replaceChild(label, totalInput);
                    }

                    // Reset row state
                    row.classList.remove("editing");

                    // Reset button
                    const editButton = row.querySelector(".edit-button");
                    editButton.textContent = "S·ª≠a";
                    editButton.style.background = "";

                    // Update cached data
                    const cachedData = getCachedData();
                    if (cachedData) {
                        const index = cachedData.findIndex(
                            (item) => item.id === inventoryId,
                        );
                        if (index !== -1) {
                            cachedData[index].thucNhan = receivedValue;
                            cachedData[index].tongNhan = totalValue;
                            cachedData[index].lastUpdated =
                                getFormattedDateTime();
                            cachedData[index].updatedBy = getUserName();
                            setCachedData(cachedData);
                        }
                    }

                    hideFloatingAlert();
                    showFloatingAlert("L∆∞u thay ƒë·ªïi th√†nh c√¥ng!", false, 2000);
                } catch (error) {
                    console.error("L·ªói khi l∆∞u thay ƒë·ªïi:", error);
                    showFloatingAlert(
                        "L·ªói khi l∆∞u thay ƒë·ªïi: " + error.message,
                        false,
                        3000,
                    );
                    // Revert changes on error
                    row.classList.remove("editing");
                    const editButton = row.querySelector(".edit-button");
                    editButton.textContent = "S·ª≠a";
                    editButton.style.background = "";
                }
            }

            async function updateOrderInventoryData(orderId, updateData) {
                try {
                    const doc = await collectionRef.doc("dathang").get();
                    let orderData = [];

                    if (doc.exists) {
                        const data = doc.data();
                        if (data && Array.isArray(data.data)) {
                            orderData = data.data;
                        }
                    } else {
                        throw new Error("Kh√¥ng t√¨m th·∫•y document dathang");
                    }

                    let orderIndex = -1;
                    let cachedData = getCachedData();
                    let targetItem = null;

                    if (cachedData) {
                        targetItem = cachedData.find(
                            (item) => item.id === orderId,
                        );
                    }

                    if (
                        targetItem &&
                        targetItem.isGrouped &&
                        targetItem.groupedOrderIds
                    ) {
                        let updatedCount = 0;
                        targetItem.groupedOrderIds.forEach(
                            (originalOrderId) => {
                                const index = orderData.findIndex(
                                    (order) => order.id === originalOrderId,
                                );
                                if (index !== -1) {
                                    orderData[index] = {
                                        ...orderData[index],
                                        ...updateData,
                                    };
                                    updatedCount++;
                                }
                            },
                        );

                        if (updatedCount === 0) {
                            throw new Error(
                                "Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng g·ªëc n√†o ƒë·ªÉ c·∫≠p nh·∫≠t",
                            );
                        }

                        console.log(
                            `Updated ${updatedCount} grouped orders for inventory item ${orderId}`,
                        );
                    } else {
                        if (targetItem && targetItem.originalOrderId) {
                            orderIndex = orderData.findIndex(
                                (order) =>
                                    order.id === targetItem.originalOrderId,
                            );
                        } else {
                            orderIndex = orderData.findIndex(
                                (order) => order.id === orderId,
                            );
                        }

                        if (orderIndex !== -1) {
                            orderData[orderIndex] = {
                                ...orderData[orderIndex],
                                ...updateData,
                            };
                            console.log(
                                `Updated individual order ${orderId} with inventory data`,
                            );
                        } else {
                            throw new Error(
                                "Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ƒë·ªÉ c·∫≠p nh·∫≠t",
                            );
                        }
                    }

                    await collectionRef
                        .doc("dathang")
                        .update({ data: orderData });
                    console.log(
                        "Successfully updated Firebase with inventory data",
                    );
                } catch (error) {
                    console.error(
                        "Error updating order inventory data:",
                        error,
                    );
                    throw error;
                }
            }

            async function deleteInventoryItem(event) {
                const auth = getAuthState();
                if (!auth || parseInt(auth.checkLogin) > 0) {
                    showFloatingAlert(
                        "Kh√¥ng ƒë·ªß quy·ªÅn th·ª±c hi·ªán ch·ª©c nƒÉng n√†y.",
                        false,
                        3000,
                    );
                    return;
                }

                const button = event.currentTarget;
                const inventoryId = button.getAttribute("data-inventory-id");
                const itemInfo = button.getAttribute("data-inventory-info");
                const isGrouped =
                    button.getAttribute("data-is-grouped") === "true";

                if (!inventoryId) {
                    showFloatingAlert(
                        "Kh√¥ng t√¨m th·∫•y ID s·∫£n ph·∫©m!",
                        false,
                        3000,
                    );
                    return;
                }

                const confirmMessage = isGrouped
                    ? `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th√¥ng tin ki·ªÉm kho g·ªôp c·ªßa s·∫£n ph·∫©m "${itemInfo}"?\nL∆∞u √Ω: ƒê√¢y l√† m·ª•c ƒë√£ g·ªôp t·ª´ nhi·ªÅu ƒë∆°n h√†ng. Ch·ªâ x√≥a th√¥ng tin ki·ªÉm kho, kh√¥ng x√≥a ƒë∆°n h√†ng g·ªëc.\nID: ${inventoryId}`
                    : `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th√¥ng tin ki·ªÉm kho c·ªßa s·∫£n ph·∫©m "${itemInfo}"?\nL∆∞u √Ω: Ch·ªâ x√≥a th√¥ng tin ki·ªÉm kho, ƒë∆°n h√†ng g·ªëc v·∫´n ƒë∆∞·ª£c gi·ªØ l·∫°i.\nID: ${inventoryId}`;

                const confirmDelete = confirm(confirmMessage);
                if (!confirmDelete) return;

                const row = button.closest("tr");

                showFloatingAlert("ƒêang x√≥a th√¥ng tin ki·ªÉm kho...", true);

                try {
                    const cachedData = getCachedData();
                    let oldItemData = null;

                    if (cachedData) {
                        const index = cachedData.findIndex(
                            (item) => item.id === inventoryId,
                        );
                        if (index !== -1) {
                            oldItemData = { ...cachedData[index] };
                            cachedData.splice(index, 1);
                            setCachedData(cachedData);
                        }
                    }

                    await removeInventoryDataFromOrder(inventoryId);

                    hideFloatingAlert();
                    showFloatingAlert(
                        "ƒê√£ x√≥a th√¥ng tin ki·ªÉm kho th√†nh c√¥ng!",
                        false,
                        2000,
                    );

                    if (row) row.remove();
                } catch (error) {
                    hideFloatingAlert();
                    console.error("L·ªói khi x√≥a:", error);
                    showFloatingAlert(
                        "L·ªói khi x√≥a: " + error.message,
                        false,
                        3000,
                    );

                    if (cachedData && oldItemData) {
                        cachedData.push(oldItemData);
                        setCachedData(cachedData);
                    }
                }
            }

            async function removeInventoryDataFromOrder(inventoryId) {
                try {
                    const doc = await collectionRef.doc("dathang").get();
                    let orderData = [];

                    if (doc.exists) {
                        const data = doc.data();
                        if (data && Array.isArray(data.data)) {
                            orderData = data.data;
                        }
                    } else {
                        throw new Error("Kh√¥ng t√¨m th·∫•y document dathang");
                    }

                    const cachedData = getCachedData();
                    let targetItem = null;

                    if (cachedData) {
                        targetItem = cachedData.find(
                            (item) => item.id === inventoryId,
                        );
                    }

                    let updatedCount = 0;

                    if (
                        targetItem &&
                        targetItem.isGrouped &&
                        targetItem.groupedOrderIds
                    ) {
                        targetItem.groupedOrderIds.forEach(
                            (originalOrderId) => {
                                const orderIndex = orderData.findIndex(
                                    (order) => order.id === originalOrderId,
                                );
                                if (orderIndex !== -1) {
                                    delete orderData[orderIndex].thucNhan;
                                    delete orderData[orderIndex].tongNhan;
                                    delete orderData[orderIndex]
                                        .inventoryUpdated;

                                    orderData[orderIndex].lastUpdated =
                                        getFormattedDateTime();
                                    orderData[orderIndex].updatedBy =
                                        getUserName();
                                    updatedCount++;
                                }
                            },
                        );

                        console.log(
                            `Removed inventory data from ${updatedCount} grouped orders`,
                        );
                    } else {
                        let orderIndex = -1;

                        if (targetItem && targetItem.originalOrderId) {
                            orderIndex = orderData.findIndex(
                                (order) =>
                                    order.id === targetItem.originalOrderId,
                            );
                        } else {
                            orderIndex = orderData.findIndex(
                                (order) => order.id === inventoryId,
                            );
                        }

                        if (orderIndex !== -1) {
                            delete orderData[orderIndex].thucNhan;
                            delete orderData[orderIndex].tongNhan;
                            delete orderData[orderIndex].inventoryUpdated;

                            orderData[orderIndex].lastUpdated =
                                getFormattedDateTime();
                            orderData[orderIndex].updatedBy = getUserName();
                            updatedCount++;

                            console.log(
                                `Removed inventory data from individual order ${inventoryId}`,
                            );
                        } else {
                            throw new Error(
                                "Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ƒë·ªÉ x√≥a th√¥ng tin ki·ªÉm kho",
                            );
                        }
                    }

                    if (updatedCount === 0) {
                        throw new Error("Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c c·∫≠p nh·∫≠t");
                    }

                    await collectionRef
                        .doc("dathang")
                        .update({ data: orderData });
                    console.log(
                        "Successfully removed inventory data from Firebase",
                    );
                } catch (error) {
                    console.error(
                        "Error removing inventory data from order:",
                        error,
                    );
                    throw error;
                }
            }

            // =====================================================
            // STATISTICS FUNCTIONS
            // =====================================================

            function updateStatistics(inventoryData) {
                const totalProducts = document.getElementById("totalProducts");
                const completedProducts =
                    document.getElementById("completedProducts");
                const partialProducts =
                    document.getElementById("partialProducts");
                const pendingProducts =
                    document.getElementById("pendingProducts");
                const groupedItems = document.getElementById("groupedItems");

                if (!inventoryData || !Array.isArray(inventoryData)) return;

                let total = inventoryData.length;
                let completed = 0;
                let partial = 0;
                let pending = 0;
                let grouped = 0;

                inventoryData.forEach((item) => {
                    const ordered = item.soLuong || 0;
                    const received =
                        (item.thucNhan || 0) + (item.tongNhan || 0);

                    if (received >= ordered && received > 0) {
                        completed++;
                    } else if (received > 0 && received < ordered) {
                        partial++;
                    } else {
                        pending++;
                    }

                    if (item.isGrouped) {
                        grouped++;
                    }
                });

                if (totalProducts) totalProducts.textContent = total;
                if (completedProducts)
                    completedProducts.textContent = completed;
                if (partialProducts) partialProducts.textContent = partial;
                if (pendingProducts) pendingProducts.textContent = pending;
                if (groupedItems) groupedItems.textContent = grouped;
            }

            // =====================================================
            // GROUPING FUNCTIONS
            // =====================================================

            function toggleGrouping() {
                groupingEnabled = !groupingEnabled;
                const toggleButton = document.getElementById(
                    "toggleGroupingButton",
                );
                const indicator = document.getElementById("groupingIndicator");
                const explanation = document.getElementById(
                    "groupingExplanation",
                );

                if (toggleButton) {
                    toggleButton.textContent = groupingEnabled
                        ? "T·∫Øt g·ªôp NCC"
                        : "B·∫≠t g·ªôp NCC";
                    if (groupingEnabled) {
                        toggleButton.classList.remove("enabled");
                    } else {
                        toggleButton.classList.add("enabled");
                    }
                }

                if (indicator) {
                    indicator.textContent = groupingEnabled
                        ? "G·ªòP THEO NCC"
                        : "CHI TI·∫æT";
                    indicator.style.background = groupingEnabled
                        ? "#007bff"
                        : "#6c757d";
                }

                if (explanation) {
                    explanation.style.display = groupingEnabled
                        ? "block"
                        : "none";
                }

                invalidateCache();
                loadInventoryData(groupingEnabled);

                showFloatingAlert(
                    groupingEnabled
                        ? "ƒê√£ b·∫≠t g·ªôp s·∫£n ph·∫©m theo NCC"
                        : "ƒê√£ t·∫Øt g·ªôp s·∫£n ph·∫©m theo NCC",
                    false,
                    2000,
                );
            }

            // =====================================================
            // EXPORT FUNCTIONALITY
            // =====================================================

            function exportToExcel() {
                const cachedData = getCachedData();
                if (!cachedData || cachedData.length === 0) {
                    showFloatingAlert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t", false, 3000);
                    return;
                }

                showFloatingAlert("ƒêang t·∫°o file Excel...", true);

                try {
                    const filteredData = applyFiltersToInventory(cachedData);
                    const excelData = filteredData.map((item, index) => ({
                        STT: index + 1,
                        "Ng√†y ƒë·∫∑t h√†ng": item.ngayDatHang || "",
                        "Ng√†y nh·∫≠n h√†ng": item.ngayNhan || "",
                        "Nh√† cung c·∫•p": item.nhaCungCap || "",
                        "M√£ s·∫£n ph·∫©m": item.maSanPham || "",
                        "T√™n s·∫£n ph·∫©m": item.tenSanPham || "",
                        "S·ªë l∆∞·ª£ng ƒë·∫∑t": item.soLuong || 0,
                        "Th·ª±c nh·∫≠n": item.thucNhan || 0,
                        "T·ªïng nh·∫≠n": item.tongNhan || 0,
                        "Tr·∫°ng th√°i": item.isGrouped ? "ƒê√£ g·ªôp" : "ƒê∆°n l·∫ª",
                        "S·ªë ƒë∆°n g·ªôp": item.groupedCount || 1,
                    }));

                    const ws = XLSX.utils.json_to_sheet(excelData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Ki·ªÉm H√†ng");

                    const fileName = `KiemHang_${groupingEnabled ? "Gop" : "ChiTiet"}_${new Date().toLocaleDateString("vi-VN").replace(/\//g, "-")}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    hideFloatingAlert();
                    showFloatingAlert("Xu·∫•t Excel th√†nh c√¥ng!", false, 2000);
                } catch (error) {
                    console.error("L·ªói khi xu·∫•t Excel:", error);
                    hideFloatingAlert();
                    showFloatingAlert("L·ªói khi xu·∫•t Excel!", false, 3000);
                }
            }

            // =====================================================
            // EVENT HANDLERS
            // =====================================================

            function initializeFilterEvents() {
                if (filterSupplierSelect) {
                    filterSupplierSelect.addEventListener(
                        "change",
                        applyFilters,
                    );
                }
                if (dateFilterSelect) {
                    dateFilterSelect.addEventListener("change", applyFilters);
                }
                if (filterProductInput) {
                    filterProductInput.addEventListener(
                        "input",
                        debounce(applyFilters, 300),
                    );
                }
            }

            async function refreshInventoryData() {
                try {
                    showFloatingAlert("ƒêang l√†m m·ªõi d·ªØ li·ªáu...", true);
                    invalidateCache();
                    await loadInventoryData(groupingEnabled);
                    hideFloatingAlert();
                    showFloatingAlert(
                        "L√†m m·ªõi d·ªØ li·ªáu th√†nh c√¥ng!",
                        false,
                        2000,
                    );
                } catch (error) {
                    console.error("Error refreshing inventory data:", error);
                    hideFloatingAlert();
                    showFloatingAlert("L·ªói khi l√†m m·ªõi d·ªØ li·ªáu!", false, 3000);
                }
            }

            function handleLogout() {
                const confirmLogout = confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?");
                if (confirmLogout) {
                    localStorage.clear();
                    sessionStorage.clear();
                    invalidateCache();
                    window.location.href = "../index.html";
                }
            }

            // =====================================================
            // INITIALIZATION
            // =====================================================

            async function initializeInventorySystem() {
                const auth = getAuthState();
                if (!isAuthenticated()) {
                    console.log("User not authenticated, redirecting to login");
                    // Uncomment for production:
                    // window.location.href = '../index.html';
                    // return;
                }

                if (auth && auth.userType && auth.userType !== "Admin") {
                    const titleElement = document.querySelector(".page-title");
                    if (titleElement) {
                        titleElement.textContent += " - " + auth.displayName;
                    }
                }

                initializeFilterEvents();
                await loadInventoryData(groupingEnabled);

                // Set up event listeners
                const toggleLogoutButton =
                    document.getElementById("toggleLogoutButton");
                if (toggleLogoutButton) {
                    toggleLogoutButton.addEventListener("click", handleLogout);
                }

                const toggleFormButton =
                    document.getElementById("toggleFormButton");
                if (toggleFormButton) {
                    toggleFormButton.addEventListener(
                        "click",
                        refreshInventoryData,
                    );
                }

                const exportButton = document.getElementById("exportButton");
                if (exportButton) {
                    exportButton.addEventListener("click", exportToExcel);
                }

                const toggleGroupingButton = document.getElementById(
                    "toggleGroupingButton",
                );
                if (toggleGroupingButton) {
                    toggleGroupingButton.addEventListener(
                        "click",
                        toggleGrouping,
                    );
                }

                console.log(
                    "Inventory Management System with Grouping initialized successfully",
                );
                console.log('Data source: Firebase collection "dathang"');
                console.log("Grouping enabled:", groupingEnabled);
            }

            // =====================================================
            // DOM INITIALIZATION
            // =====================================================

            document.addEventListener("DOMContentLoaded", function () {
                // Force unblock any blocking overlays
                document.body.style.pointerEvents = "auto";
                document.body.style.userSelect = "auto";
                document.body.style.overflow = "auto";
                document.body.style.cursor = "default";

                // Initialize the inventory system
                initializeInventorySystem();

                console.log(
                    "Inventory System with Firebase Integration loaded successfully",
                );
            });

            // =====================================================
            // DEBUG AND UTILITY FUNCTIONS
            // =====================================================

            // Emergency reset function
            window.forceUnblock = function () {
                document.body.style.pointerEvents = "auto";
                document.body.style.userSelect = "auto";
                document.body.style.overflow = "auto";
                document.body.style.cursor = "default";

                const alertBox = document.getElementById("floatingAlert");
                if (alertBox) {
                    alertBox.style.display = "none";
                    alertBox.style.opacity = "0";
                    alertBox.style.visibility = "hidden";
                }

                console.log("Force unblocked - page should be interactive now");
            };

            // Global error handlers
            window.addEventListener("error", function (e) {
                console.error("Global error:", e.error);
                showFloatingAlert(
                    "C√≥ l·ªói x·∫£y ra. Vui l√≤ng t·∫£i l·∫°i trang.",
                    false,
                    5000,
                );
            });

            window.addEventListener("unhandledrejection", function (e) {
                console.error("Unhandled promise rejection:", e.reason);
                showFloatingAlert(
                    "C√≥ l·ªói x·∫£y ra trong x·ª≠ l√Ω d·ªØ li·ªáu.",
                    false,
                    5000,
                );
            });

            console.log(
                "Inventory Management System - JavaScript loaded successfully",
            );
        </script>
    </body>
</html>
