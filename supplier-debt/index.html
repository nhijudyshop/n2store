<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công nợ nhà cung cấp</title>

    <!-- Core Loader -->
    <script src="../shared/js/core-loader.js"></script>

    <!-- ES Module: Shared utilities -->
    <script type="module" src="../shared/esm/compat.js"></script>

    <!-- Storage Migration -->
    <script src="../shared/js/storage-migration.js"></script>

    <!-- Lucide Icons -->
    <script defer src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="../balance-history/css/modern.css">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i data-lucide="zap"></i>
                <span>N2Shop</span>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i data-lucide="panel-left-close"></i>
            </button>
        </div>

        <nav class="sidebar-nav" id="sidebarNav">
            <!-- Menu items auto-generated by navigation-modern.js -->
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    <i data-lucide="user-circle"></i>
                </div>
                <div class="user-details">
                    <div class="user-name" id="userName">Admin</div>
                    <div class="user-role">Quản trị viên</div>
                </div>
            </div>
            <button class="btn-logout" id="btnLogout">
                <i data-lucide="log-out"></i>
                <span>Đăng xuất</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <!-- Page Header -->
            <header class="page-header">
                <h1><i data-lucide="receipt"></i> Công nợ nhà cung cấp</h1>
            </header>

            <!-- Filter Section -->
            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Thời gian</label>
                        <div class="date-input-wrapper">
                            <input type="text" id="dateFromDisplay" class="date-input date-display"
                                placeholder="dd/mm/yyyy" maxlength="10">
                            <input type="datetime-local" id="dateFrom" class="date-input-hidden">
                            <i data-lucide="calendar" class="date-icon"></i>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Ngày kết thúc</label>
                        <div class="date-input-wrapper">
                            <input type="text" id="dateToDisplay" class="date-input date-display"
                                placeholder="dd/mm/yyyy" maxlength="10">
                            <input type="datetime-local" id="dateTo" class="date-input-hidden">
                            <i data-lucide="calendar" class="date-icon"></i>
                        </div>
                    </div>

                    <div class="filter-group filter-group-display">
                        <label>Hiển thị</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="display" value="all" checked>
                                <span>Tất cả</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="display" value="endnonzero">
                                <span>Nợ cuối kỳ khác 0</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group filter-group-supplier">
                        <label>Nhà cung cấp</label>
                        <div class="select-wrapper">
                            <select id="supplierFilter">
                                <option value="">Chọn nhà cung cấp</option>
                            </select>
                            <button type="button" class="clear-select" id="clearSupplier" style="display: none;">
                                <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                            </button>
                        </div>
                    </div>

                    <div class="filter-actions">
                        <button class="btn btn-primary" id="btnSearch">
                            <i data-lucide="search"></i> Tìm kiếm
                        </button>
                        <button class="btn btn-success" id="btnExport">
                            <i data-lucide="file-spreadsheet"></i> Xuất excel
                        </button>
                        <div class="column-toggle-wrapper">
                            <button class="btn btn-secondary" id="btnColumnToggle">
                                <i data-lucide="columns"></i> Ẩn/Hiện cột
                            </button>
                            <div class="column-toggle-dropdown" id="columnToggleDropdown">
                                <div class="column-toggle-item">
                                    <input type="checkbox" id="col-code" checked>
                                    <label for="col-code">Mã khách hàng</label>
                                </div>
                                <div class="column-toggle-item">
                                    <input type="checkbox" id="col-name" checked>
                                    <label for="col-name">Tên KH/Facebook</label>
                                </div>
                                <div class="column-toggle-item">
                                    <input type="checkbox" id="col-phone" checked>
                                    <label for="col-phone">Điện thoại</label>
                                </div>
                                <div class="column-toggle-item">
                                    <input type="checkbox" id="col-begin" checked>
                                    <label for="col-begin">Nợ đầu kỳ</label>
                                </div>
                                <div class="column-toggle-item">
                                    <input type="checkbox" id="col-debit" checked>
                                    <label for="col-debit">Phát sinh</label>
                                </div>
                                <div class="column-toggle-item">
                                    <input type="checkbox" id="col-credit" checked>
                                    <label for="col-credit">Thanh toán</label>
                                </div>
                                <div class="column-toggle-item">
                                    <input type="checkbox" id="col-end" checked>
                                    <label for="col-end">Nợ cuối kỳ</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading" style="display: none;">
                <i data-lucide="loader-2"></i> Đang tải dữ liệu...
            </div>

            <!-- Data Table -->
            <div class="table-container">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th class="col-code-header" data-col="code">
                                Mã khách hàng
                                <button class="filter-btn" data-column="code">
                                    <i data-lucide="filter" style="width: 12px; height: 12px;"></i>
                                </button>
                            </th>
                            <th class="col-name" data-col="name">
                                Tên KH/Facebook
                                <button class="filter-btn" data-column="name">
                                    <i data-lucide="filter" style="width: 12px; height: 12px;"></i>
                                </button>
                            </th>
                            <th class="col-phone" data-col="phone">
                                Điện thoại
                                <button class="filter-btn" data-column="phone">
                                    <i data-lucide="filter" style="width: 12px; height: 12px;"></i>
                                </button>
                            </th>
                            <th class="col-number" data-col="begin">
                                Nợ đầu kỳ
                                <button class="filter-btn" data-column="begin">
                                    <i data-lucide="filter" style="width: 12px; height: 12px;"></i>
                                </button>
                            </th>
                            <th class="col-number" data-col="debit">
                                Phát sinh
                                <button class="filter-btn" data-column="debit">
                                    <i data-lucide="filter" style="width: 12px; height: 12px;"></i>
                                </button>
                            </th>
                            <th class="col-number" data-col="credit">
                                Thanh toán
                                <button class="filter-btn" data-column="credit">
                                    <i data-lucide="filter" style="width: 12px; height: 12px;"></i>
                                </button>
                            </th>
                            <th class="col-number" data-col="end">
                                Nợ cuối kỳ
                                <button class="filter-btn" data-column="end">
                                    <i data-lucide="filter" style="width: 12px; height: 12px;"></i>
                                </button>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be rendered here -->
                    </tbody>
                    <tfoot id="tableFoot">
                        <tr class="total-row">
                            <td data-col="code"><strong>Tổng</strong></td>
                            <td data-col="name"></td>
                            <td data-col="phone"></td>
                            <td data-col="begin" class="col-number" id="totalBegin">0</td>
                            <td data-col="debit" class="col-number" id="totalDebit">0</td>
                            <td data-col="credit" class="col-number" id="totalCredit">0</td>
                            <td data-col="end" class="col-number" id="totalEnd">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <div class="pagination-nav">
                    <button class="btn-page" id="btnFirst" title="Trang đầu">
                        <i data-lucide="chevrons-left"></i>
                    </button>
                    <button class="btn-page" id="btnPrev" title="Trang trước">
                        <i data-lucide="chevron-left"></i>
                    </button>
                    <div class="page-numbers" id="pageNumbers">
                        <!-- Page numbers will be rendered here -->
                    </div>
                    <button class="btn-page" id="btnNext" title="Trang sau">
                        <i data-lucide="chevron-right"></i>
                    </button>
                    <button class="btn-page" id="btnLast" title="Trang cuối">
                        <i data-lucide="chevrons-right"></i>
                    </button>
                </div>

                <div class="pagination-info">
                    <select id="pageSize" class="page-size-select">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="200">200</option>
                        <option value="1000">1000</option>
                    </select>
                    <span>Số dòng trên trang</span>
                    <span class="page-info" id="pageInfo">0 - 0 của 0 dòng</span>
                    <button class="btn-refresh" id="btnRefresh" title="Làm mới">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Đăng ký thanh toán</h3>
                <button class="modal-close" id="btnCloseModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nhà cung cấp</label>
                            <div class="form-value" id="paymentSupplierName"></div>
                        </div>
                        <div class="form-group">
                            <label>Ngày thanh toán</label>
                            <input type="datetime-local" id="paymentDate" class="form-input">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phương thức</label>
                            <select id="paymentMethod" class="form-select">
                                <option value="">-- Chọn phương thức --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nội dung</label>
                            <input type="text" id="paymentContent" class="form-input" placeholder="Nhập nội dung">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Số tiền</label>
                            <input type="number" id="paymentAmount" class="form-input" step="1000">
                        </div>
                        <div class="form-group"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="btnSubmitPayment">Thanh toán</button>
                <button class="btn btn-secondary" id="btnCancelPayment">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Note Edit Modal -->
    <div class="modal-overlay" id="noteEditModal">
        <div class="modal modal-note">
            <div class="modal-header">
                <h3>Chỉnh sửa ghi chú</h3>
                <button class="modal-close" id="btnCloseNoteModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-form">
                    <div class="form-group">
                        <label>Nhà cung cấp - Bút toán</label>
                        <div class="form-value" id="noteEditSupplier"></div>
                    </div>
                    <div class="form-group">
                        <label>Ghi chú TPOS <span class="text-muted">(không thể sửa)</span></label>
                        <div class="form-value note-readonly" id="noteEditTpos"></div>
                    </div>
                    <div class="form-group">
                        <label>Ghi chú Web <span class="text-muted">(có thể sửa)</span></label>
                        <textarea id="noteEditWeb" class="form-input form-textarea" rows="3" placeholder="Nhập ghi chú..."></textarea>
                        <div class="form-hint">Nhấn Ctrl+Enter để lưu nhanh</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="btnSaveNote">Lưu</button>
                <button class="btn btn-secondary" id="btnCancelNote">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Invoice Detail Modal -->
    <div class="modal-overlay" id="invoiceDetailModal">
        <div class="modal modal-invoice-detail">
            <div class="modal-header">
                <h3>Chi tiết hóa đơn</h3>
                <button class="modal-close" id="btnCloseInvoiceDetail">&times;</button>
            </div>
            <div class="modal-body" id="invoiceDetailBody">
                <!-- Content will be rendered by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btnCloseInvoiceDetailFooter">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../shared/js/firebase-config.js"></script>

    <!-- Auth Manager -->
    <script src="../shared/js/shared-auth-manager.js"></script>

    <!-- Navigation -->
    <script defer src="../shared/js/navigation-modern.js"></script>

    <!-- Notification System -->
    <script src="../shared/js/notification-system.js"></script>

    <!-- Token Manager & API Config -->
    <script src="../orders-report/js/core/api-config.js"></script>
    <script src="../orders-report/js/core/token-manager.js"></script>

    <!-- Page Script -->
    <script src="js/main.js"></script>

    <!-- Initialize Lucide Icons -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>

</html>
