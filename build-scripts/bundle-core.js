#!/usr/bin/env node

/**
 * CORE UTILITIES BUNDLE SCRIPT
 *
 * Bundles all core shared utilities into a single file for script-tag usage.
 * Reduces HTTP requests from 8-9 scripts to 1 bundle.
 *
 * Usage: node build-scripts/bundle-core.js
 *
 * Output: shared/js/shared-core-bundle.js
 */

const fs = require('fs');
const path = require('path');

console.log('üî® N2Store Build Script - Core Bundle');
console.log('='.repeat(60));

const ROOT_DIR = path.join(__dirname, '..');
const SHARED_JS_DIR = path.join(ROOT_DIR, 'shared', 'js');
const OUTPUT_FILE = path.join(SHARED_JS_DIR, 'shared-core-bundle.js');

// Files to bundle in order (dependencies first)
const BUNDLE_FILES = [
    'logger.js',
    'dom-utils.js',
    'common-utils.js',
    'date-utils.js',
    'form-utils.js',
    'shared-cache-manager.js',
    'notification-system.js',
    'shared-auth-manager.js',
];

// Files that should be loaded separately (have their own dependencies)
const SEPARATE_FILES = [
    'firebase-config.js',      // Needs Firebase SDK first
    'navigation-modern.js',    // Loaded with defer
    'tpos-config.js',          // Optional, not all pages need
    'realtime-client.js',      // Optional, WebSocket
];

let bundleContent = `/**
 * N2Store Core Utilities Bundle
 *
 * Auto-generated by build-scripts/bundle-core.js
 * Generated: ${new Date().toISOString()}
 *
 * Includes:
 * ${BUNDLE_FILES.map(f => ` * - ${f}`).join('\n')}
 *
 * Usage:
 * <script src="../shared/js/shared-core-bundle.js"></script>
 *
 * This bundle provides:
 * - window.Logger, window.logger
 * - window.DOMUtils, window.$, window.$$
 * - window.CommonUtils, window.showStatusMessage, etc.
 * - window.DateUtils, window.formatDate, etc.
 * - window.FormUtils, window.debounce, window.throttle, etc.
 * - window.CacheManager, window.PersistentCacheManager
 * - window.NotificationManager, window.notificationManager
 * - window.AuthManager, window.authManager
 */

(function(window) {
    'use strict';

    // Prevent double-loading
    if (window.CORE_BUNDLE_LOADED) {
        console.log('[Core Bundle] Already loaded, skipping');
        return;
    }

`;

let totalSize = 0;
let filesIncluded = 0;

console.log('\nüì¶ Bundling core utilities...\n');

BUNDLE_FILES.forEach((filename, index) => {
    const filePath = path.join(SHARED_JS_DIR, filename);

    if (!fs.existsSync(filePath)) {
        console.error(`  ‚ùå ${filename} - File not found`);
        return;
    }

    try {
        let content = fs.readFileSync(filePath, 'utf8');
        const originalSize = Buffer.byteLength(content);
        totalSize += originalSize;
        filesIncluded++;

        // Remove 'use strict' as we have it in the wrapper
        content = content.replace(/"use strict";?\s*/g, '');
        content = content.replace(/'use strict';?\s*/g, '');

        // Add section comment
        bundleContent += `
    // ========================================
    // ${filename}
    // ========================================
${content}

`;

        console.log(`  ‚úÖ ${filename} (${(originalSize / 1024).toFixed(2)} KB)`);

    } catch (error) {
        console.error(`  ‚ùå ${filename} - ${error.message}`);
    }
});

// Add auto-initialization code
bundleContent += `
    // ========================================
    // AUTO-INITIALIZATION
    // ========================================

    // Mark bundle as loaded
    window.CORE_BUNDLE_LOADED = true;
    window.CORE_UTILITIES_LOADED = true;

    // Auto-initialize authManager if AuthManager exists
    if (typeof AuthManager !== 'undefined' && !window.authManager) {
        try {
            window.authManager = new AuthManager({
                redirectUrl: '../index.html',
                sessionDuration: 8 * 60 * 60 * 1000,
                rememberDuration: 30 * 24 * 60 * 60 * 1000
            });
            console.log('[Core Bundle] AuthManager auto-initialized');
        } catch (e) {
            console.warn('[Core Bundle] Failed to auto-init AuthManager:', e);
        }
    }

    // Auto-initialize notificationManager if NotificationManager exists
    if (typeof NotificationManager !== 'undefined' && !window.notificationManager) {
        try {
            window.notificationManager = new NotificationManager();
            console.log('[Core Bundle] NotificationManager auto-initialized');
        } catch (e) {
            console.warn('[Core Bundle] Failed to auto-init NotificationManager:', e);
        }
    }

    // Dispatch event to signal core utilities are loaded
    document.dispatchEvent(new CustomEvent('coreUtilitiesLoaded'));
    window.dispatchEvent(new CustomEvent('sharedModulesLoaded'));

    console.log('[Core Bundle] All core utilities loaded');

})(typeof window !== 'undefined' ? window : this);
`;

// Write bundle file
try {
    fs.writeFileSync(OUTPUT_FILE, bundleContent);
    const bundleSize = Buffer.byteLength(bundleContent);

    console.log('\n' + '='.repeat(60));
    console.log('üìä BUNDLE SUMMARY');
    console.log('='.repeat(60));
    console.log(`Files bundled:   ${filesIncluded}/${BUNDLE_FILES.length}`);
    console.log(`Original total:  ${(totalSize / 1024).toFixed(2)} KB`);
    console.log(`Bundle size:     ${(bundleSize / 1024).toFixed(2)} KB`);
    console.log(`Output:          ${path.relative(ROOT_DIR, OUTPUT_FILE)}`);
    console.log('='.repeat(60));
    console.log('\n‚úÖ Bundle created successfully!\n');

    // Also create minified version
    console.log('üì¶ Creating minified version...');

    try {
        const { minify } = require('terser');

        minify(bundleContent, {
            compress: {
                dead_code: true,
                drop_debugger: true,
                unused: true
            },
            mangle: false,
            format: {
                comments: /^!/
            }
        }).then(result => {
            if (result.code) {
                const minPath = OUTPUT_FILE.replace('.js', '.min.js');
                fs.writeFileSync(minPath, result.code);
                const minSize = Buffer.byteLength(result.code);
                const saved = ((bundleSize - minSize) / bundleSize * 100).toFixed(1);
                console.log(`  ‚úÖ Minified: ${(minSize / 1024).toFixed(2)} KB (-${saved}%)`);
                console.log(`  Output: ${path.relative(ROOT_DIR, minPath)}`);
            }
        }).catch(err => {
            console.warn('  ‚ö†Ô∏è Minification skipped:', err.message);
        });

    } catch (e) {
        console.log('  ‚ö†Ô∏è terser not installed, skipping minification');
        console.log('  Run: npm install terser');
    }

} catch (error) {
    console.error('‚ùå Failed to write bundle:', error.message);
    process.exit(1);
}

// Print usage instructions
console.log('\nüìù USAGE INSTRUCTIONS');
console.log('='.repeat(60));
console.log(`
Replace multiple script tags:

  <!-- BEFORE: 8 separate requests -->
  <script src="../shared/js/logger.js"></script>
  <script src="../shared/js/dom-utils.js"></script>
  <script src="../shared/js/common-utils.js"></script>
  <script src="../shared/js/date-utils.js"></script>
  <script src="../shared/js/form-utils.js"></script>
  <script src="../shared/js/shared-cache-manager.js"></script>
  <script src="../shared/js/notification-system.js"></script>
  <script src="../shared/js/shared-auth-manager.js"></script>

  <!-- AFTER: 1 request -->
  <script src="../shared/js/shared-core-bundle.js"></script>

Note: firebase-config.js and navigation-modern.js should still
be loaded separately as they have specific dependencies.
`);
