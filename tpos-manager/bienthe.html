<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Qu·∫£n l√Ω Bi·∫øn th·ªÉ S·∫£n ph·∫©m</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .spinner {
                border: 3px solid #f3f3f3;
                border-top: 3px solid #3b82f6;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="container mx-auto p-6 max-w-7xl">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h1 class="text-3xl font-bold text-green-700 mb-4">
                    Qu·∫£n l√Ω Bi·∫øn th·ªÉ S·∫£n ph·∫©m
                </h1>

                <!-- Product ID Input -->
                <div class="flex gap-4 items-end">
                    <div class="flex-1">
                        <label
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Product Template ID
                        </label>
                        <input
                            type="text"
                            id="productId"
                            value="108758"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        />
                    </div>
                    <button
                        onclick="loadProduct()"
                        id="loadBtn"
                        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium"
                    >
                        T·∫£i s·∫£n ph·∫©m
                    </button>
                </div>
            </div>

            <!-- Product Info -->
            <div
                id="productInfo"
                class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden"
            >
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    Th√¥ng tin s·∫£n ph·∫©m
                </h2>
                <div
                    id="productDetails"
                    class="grid grid-cols-2 gap-4 text-sm"
                ></div>
            </div>

            <!-- Attribute Management -->
            <div
                id="attributeSection"
                class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden"
            >
                <h2 class="text-xl font-bold text-green-700 mb-4">
                    D√≤ng thu·ªôc t√≠nh
                </h2>

                <!-- Attribute Lines List -->
                <div id="attributeLinesList" class="space-y-3 mb-6"></div>

                <!-- Clear All Button (hidden by default) -->
                <button
                    onclick="clearAllAttributes()"
                    id="clearAllBtn"
                    class="hidden w-full mb-3 py-2 border-2 border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition flex items-center justify-center gap-2"
                >
                    üóëÔ∏è X√≥a t·∫•t c·∫£ thu·ªôc t√≠nh
                </button>

                <!-- Add Button -->
                <button
                    onclick="showAddForm()"
                    id="addBtn"
                    class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-green-500 hover:text-green-600 transition flex items-center justify-center gap-2"
                >
                    <span class="text-xl">+</span> Th√™m d√≤ng thu·ªôc t√≠nh
                </button>

                <!-- Random Button -->
                <button
                    onclick="autoRandomVariants()"
                    id="randomBtn"
                    class="hidden w-full mt-3 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2 font-medium"
                >
                    üé≤ T·∫°o bi·∫øn th·ªÉ ng·∫´u nhi√™n
                </button>

                <!-- Add/Edit Form -->
                <div
                    id="addForm"
                    class="hidden mt-6 border-2 border-green-500 rounded-lg p-6 bg-green-50"
                >
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg" id="formTitle">
                            Th√™m thu·ªôc t√≠nh m·ªõi
                        </h3>
                        <button
                            onclick="hideAddForm()"
                            class="text-gray-500 hover:text-gray-700"
                        >
                            ‚úï
                        </button>
                    </div>

                    <!-- Attribute Select -->
                    <div class="mb-4">
                        <label
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Thu·ªôc t√≠nh
                        </label>
                        <select
                            id="attributeSelect"
                            class="w-full p-3 border border-gray-300 rounded-lg"
                        >
                            <option value="">-- Ch·ªçn thu·ªôc t√≠nh --</option>
                        </select>
                    </div>

                    <!-- Values Select -->
                    <div id="valuesContainer" class="mb-4 hidden">
                        <label
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Gi√° tr·ªã thu·ªôc t√≠nh (<span id="selectedCount"
                                >0</span
                            >
                            ƒë√£ ch·ªçn)
                        </label>
                        <div
                            id="valuesList"
                            class="max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-white"
                        >
                            <div
                                class="grid grid-cols-3 gap-2"
                                id="valuesGrid"
                            ></div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex gap-3">
                        <button
                            onclick="saveAttributeLine()"
                            class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-medium"
                        >
                            L∆∞u
                        </button>
                        <button
                            onclick="hideAddForm()"
                            class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                        >
                            H·ªßy
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview & Comparison Section -->
            <div
                id="variantsPreview"
                class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden"
            >
                <h2 class="text-xl font-bold text-blue-600 mb-4">
                    Bi·∫øn th·ªÉ & So s√°nh
                </h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left: Preview Variants -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">
                            üìã Bi·∫øn th·ªÉ s·∫Ω t·∫°o
                        </h3>
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th
                                            class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold"
                                        >
                                            STT
                                        </th>
                                        <th
                                            class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold"
                                        >
                                            M√£ SKU
                                        </th>
                                        <th
                                            class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold"
                                        >
                                            T√™n
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="variantsList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Right: Comparison Result -->
                    <div id="comparisonResult" class="hidden">
                        <h3 class="font-semibold text-gray-700 mb-3">
                            üîç K·∫øt qu·∫£ so s√°nh
                        </h3>
                        <div id="comparisonContent" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div id="saveSection" class="hidden mb-6">
                <button
                    onclick="executeFullFlow()"
                    id="saveBtn"
                    class="w-full bg-green-600 text-white py-4 rounded-lg hover:bg-green-700 transition font-medium text-lg"
                >
                    L∆∞u Variants v√†o Database
                </button>
            </div>

            <!-- Bearer Token -->
            <div class="bg-gray-100 rounded-lg shadow-sm p-6">
                <details>
                    <summary
                        class="cursor-pointer font-semibold text-gray-700 mb-2"
                    >
                        ‚öôÔ∏è C·∫•u h√¨nh Bearer Token
                    </summary>
                    <div class="mt-4">
                        <label
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Bearer Token
                        </label>
                        <textarea
                            id="bearerToken"
                            rows="3"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent font-mono text-sm"
                            placeholder="Nh·∫≠p Bearer token v√†o ƒë√¢y..."
                        >
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJDbGllbnRJZCI6InRtdFdlYkFwcCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiZmMwZjQ0MzktOWNmNi00ZDg4LWE4YzctNzU5Y2E4Mjk1MTQyIiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6Im52MjAiLCJEaXNwbGF5TmFtZSI6IlTDuiIsIkF2YXRhclVybCI6IiIsIlNlY3VyaXR5U3RhbXAiOiI1MjgxNzBjZC01YmM4LTRkZjEtYjcxMS03Nzg2MmMzOTZiYzQiLCJDb21wYW55SWQiOiIxIiwiVGVuYW50SWQiOiJ0b21hdG8udHBvcy52biIsIlJvbGVJZHMiOiI0MmZmYzk5Yi1lNGY2LTQwMDAtYjcyOS1hZTNmMDAyOGEyODksNmExZDAwMDAtNWQxYS0wMDE1LTBlNmMtMDhkYzM3OTUzMmU5LDc2MzlhMDQ4LTdjZmUtNDBiNS1hNDFkLWFlM2YwMDNiODlkZiw4YmM4ZjQ1YS05MWY4LTQ5NzMtYjE4Mi1hZTNmMDAzYWI4NTUsYTljMjAwMDAtNWRiNi0wMDE1LTQ1YWItMDhkYWIxYmZlMjIyIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjpbIlF14bqjbiBMw70gTWFpIiwiQ8OSSSIsIkNTS0ggLSBMw6BpIiwiS2hvIFBoxrDhu5tjLSBLaeG7h3QiLCJRdeG6o24gTMO9IEtobyAtIEJvIl0sImp0aSI6IjAzYmI2ZWMyLWUwYzEtNDkzYi05Y2JhLTA4Mzk2ODdhYzQzYiIsImlhdCI6IjE3NjA4ODI4MjEiLCJuYmYiOjE3NjA4ODI4MjEsImV4cCI6MTc2MjE3ODgyMSwiaXNzIjoiaHR0cHM6Ly90b21hdG8udHBvcy52biIsImF1ZCI6Imh0dHBzOi8vdG9tYXRvLnRwb3Mudm4saHR0cHM6Ly90cG9zLnZuIn0.qMsUC883I5Id2NdOOd5UCuqVtGzTk8xoty5-zS6OKIg</textarea
                        >
                    </div>
                </details>
            </div>
        </div>

        <script>
            // Global State
            let productData = null;
            let attributeLines = [];
            let currentEditIndex = null;
            let previewData = null;

            // Attribute data - FULL LIST FROM API
            const ATTRIBUTES = [
                { Id: 1, Name: "Size Ch·ªØ", Code: "SZCh" },
                { Id: 3, Name: "M√†u", Code: "Mau" },
                { Id: 4, Name: "Size S·ªë", Code: "SZNu" },
            ];

            const ATTRIBUTE_VALUES = {
                1: [
                    { Id: 5, Name: "Free Size", Code: "FS" },
                    { Id: 1, Name: "S", Code: "S" },
                    { Id: 2, Name: "M", Code: "M" },
                    { Id: 3, Name: "L", Code: "L" },
                    { Id: 4, Name: "XL", Code: "XL" },
                    { Id: 31, Name: "XXL", Code: "xxl" },
                    { Id: 32, Name: "XXXL", Code: "xxxl" },
                ],
                3: [
                    { Id: 6, Name: "Tr·∫Øng", Code: "trang" },
                    { Id: 7, Name: "ƒêen", Code: "den" },
                    { Id: 8, Name: "ƒê·ªè", Code: "do" },
                    { Id: 9, Name: "V√†ng", Code: "vang" },
                    { Id: 10, Name: "Cam", Code: "cam" },
                    { Id: 11, Name: "X√°m", Code: "xam" },
                    { Id: 12, Name: "H·ªìng", Code: "hong" },
                    { Id: 14, Name: "Nude", Code: "nude" },
                    { Id: 15, Name: "N√¢u", Code: "nau" },
                    { Id: 16, Name: "R√™u", Code: "reu" },
                    { Id: 17, Name: "Xanh", Code: "xanh" },
                    { Id: 25, Name: "B·∫°c", Code: "bac" },
                    { Id: 26, Name: "T√≠m", Code: "tim" },
                    { Id: 27, Name: "Xanh Min", Code: "xanhmin" },
                    { Id: 28, Name: "Tr·∫Øng Kem", Code: "trangkem" },
                    { Id: 29, Name: "Xanh L√°", Code: "xanhla" },
                    { Id: 38, Name: "C·ªï V·ªãt", Code: "co vit" },
                    { Id: 40, Name: "Xanh ƒê·∫≠u", Code: "xanh dau" },
                    { Id: 42, Name: "T√≠m M√¥n", Code: "timmon" },
                    { Id: 43, Name: "Mu·ªëi Ti√™u", Code: "muoitieu" },
                    { Id: 45, Name: "Kem", Code: "kem" },
                    { Id: 47, Name: "H·ªìng ƒê·∫≠m", Code: "hongdam" },
                    { Id: 49, Name: "Ghi", Code: "ghi" },
                    { Id: 50, Name: "Xanh M·∫°", Code: "xanhma" },
                    { Id: 51, Name: "V√†ng ƒê·ªìng", Code: "vangdong" },
                    { Id: 52, Name: "Xanh B∆°", Code: "xanhbo" },
                    { Id: 53, Name: "Xanh ƒêen", Code: "xanhden" },
                    { Id: 54, Name: "Xanh CoBan", Code: "xanhcoban" },
                    { Id: 55, Name: "X√°m ƒê·∫≠m", Code: "xamdam" },
                    { Id: 56, Name: "X√°m Nh·∫°t", Code: "xamnhat" },
                    { Id: 57, Name: "Xanh D∆∞∆°ng", Code: "xanhduong" },
                    { Id: 58, Name: "Cam S·ªØa", Code: "camsua" },
                    { Id: 59, Name: "H·ªìng Nh·∫°t", Code: "hongnhat" },
                    { Id: 60, Name: "ƒê·∫≠m", Code: "dam" },
                    { Id: 61, Name: "Nh·∫°t", Code: "nhat" },
                    { Id: 62, Name: "X√°m Kh√≥i", Code: "xamkhoi" },
                    { Id: 63, Name: "X√°m Chu·ªôt", Code: "xamchuot" },
                    { Id: 64, Name: "X√°m ƒêen", Code: "xamden" },
                    { Id: 65, Name: "X√°m Tr·∫Øng", Code: "xamtrang" },
                    { Id: 66, Name: "Xanh ƒê·∫≠m", Code: "xanhdam" },
                    { Id: 67, Name: "S·ªçc ƒêen", Code: "socden" },
                    { Id: 68, Name: "S·ªçc Tr·∫Øng", Code: "soctrang" },
                    { Id: 69, Name: "S·ªçc X√°m", Code: "socxam" },
                    { Id: 70, Name: "Jean Tr·∫Øng", Code: "jeantrang" },
                    { Id: 71, Name: "Jean Xanh", Code: "jeanxanh" },
                    { Id: 72, Name: "Cam ƒê·∫•t", Code: "camdat" },
                    { Id: 73, Name: "N√¢u ƒê·∫≠m", Code: "naudam" },
                    { Id: 74, Name: "N√¢u Nh·∫°t", Code: "naunhat" },
                    { Id: 75, Name: "ƒê·ªè T∆∞∆°i", Code: "dotuoi" },
                    { Id: 76, Name: "ƒêen V√†ng", Code: "denvang" },
                    { Id: 77, Name: "C√† Ph√™", Code: "caphe" },
                    { Id: 78, Name: "ƒêen B·∫°c", Code: "denbac" },
                    { Id: 79, Name: "B√≤", Code: "bo" },
                    { Id: 82, Name: "S·ªçc Xanh", Code: "socxanh" },
                    { Id: 83, Name: "Xanh R√™u", Code: "xanhreu" },
                    { Id: 84, Name: "H·ªìng Ru·ªëc", Code: "hongruoc" },
                    { Id: 85, Name: "H·ªìng D√¢u", Code: "hongdau" },
                    { Id: 86, Name: "Xanh Nh·∫°t", Code: "xanhnhat" },
                    { Id: 87, Name: "Xanh Ng·ªçc", Code: "xanhngoc" },
                    { Id: 88, Name: "Caro", Code: "caro" },
                    { Id: 89, Name: "S·ªçc H·ªìng", Code: "sochong" },
                    { Id: 90, Name: "Trong", Code: "trong" },
                    { Id: 95, Name: "Tr·∫Øng H·ªìng", Code: "tranghong" },
                    { Id: 96, Name: "Tr·∫Øng S√°ng", Code: "trangsang" },
                    { Id: 97, Name: "ƒê·ªè ƒê√¥", Code: "dodo" },
                    { Id: 98, Name: "Cam ƒê√†o", Code: "camdao" },
                    { Id: 99, Name: "Cam L·∫°nh", Code: "camlanh" },
                    { Id: 100, Name: "H·ªìng ƒê√†o", Code: "hongdao" },
                    { Id: 101, Name: "H·ªìng ƒê·∫•t", Code: "hongdat" },
                    { Id: 102, Name: "T√≠m ƒê·∫≠m", Code: "timdam" },
                ],
                4: [
                    { Id: 22, Name: "1", Code: "1" },
                    { Id: 23, Name: "2", Code: "2" },
                    { Id: 24, Name: "3", Code: "3" },
                    { Id: 48, Name: "4", Code: "4" },
                    { Id: 80, Name: "27", Code: "27" },
                    { Id: 81, Name: "28", Code: "28" },
                    { Id: 18, Name: "29", Code: "29" },
                    { Id: 19, Name: "30", Code: "30" },
                    { Id: 20, Name: "31", Code: "31" },
                    { Id: 21, Name: "32", Code: "32" },
                    { Id: 46, Name: "34", Code: "34" },
                    { Id: 33, Name: "35", Code: "35" },
                    { Id: 34, Name: "36", Code: "36" },
                    { Id: 35, Name: "37", Code: "37" },
                    { Id: 36, Name: "38", Code: "38" },
                    { Id: 37, Name: "39", Code: "39" },
                    { Id: 44, Name: "40", Code: "40" },
                    { Id: 91, Name: "41", Code: "41" },
                    { Id: 92, Name: "42", Code: "42" },
                    { Id: 93, Name: "43", Code: "43" },
                    { Id: 94, Name: "44", Code: "44" },
                ],
            };

            // Load product from API
            async function loadProduct() {
                const productId = document.getElementById("productId").value;
                const token = document
                    .getElementById("bearerToken")
                    .value.trim();
                const btn = document.getElementById("loadBtn");

                if (!token) {
                    alert("Vui l√≤ng nh·∫≠p Bearer token!");
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<div class="spinner mx-auto"></div>';

                try {
                    const response = await fetch(
                        `https://tomato.tpos.vn/odata/ProductTemplate(${productId})?$expand=UOM,UOMCateg,Categ,UOMPO,POSCateg,Taxes,SupplierTaxes,Product_Teams,Images,UOMView,Distributor,Importer,Producer,OriginCountry,ProductVariants($expand=UOM,Categ,UOMPO,POSCateg,AttributeValues)`,
                        {
                            headers: {
                                accept: "application/json, text/plain, */*",
                                authorization: `Bearer ${token}`,
                                "x-tpos-lang": "vi",
                            },
                        },
                    );

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    productData = await response.json();
                    displayProductInfo();

                    document
                        .getElementById("attributeSection")
                        .classList.remove("hidden");
                    document
                        .getElementById("randomBtn")
                        .classList.remove("hidden");
                } catch (error) {
                    alert("L·ªói khi t·∫£i s·∫£n ph·∫©m: " + error.message);
                    console.error(error);
                } finally {
                    btn.disabled = false;
                    btn.textContent = "T·∫£i s·∫£n ph·∫©m";
                }
            }

            // Display product info
            function displayProductInfo() {
                const infoDiv = document.getElementById("productInfo");
                const detailsDiv = document.getElementById("productDetails");

                detailsDiv.innerHTML = `
                <div><strong>ID:</strong> ${productData.Id}</div>
                <div><strong>T√™n:</strong> ${productData.Name}</div>
                <div><strong>M√£:</strong> ${productData.DefaultCode}</div>
                <div><strong>Gi√°:</strong> ${productData.ListPrice}</div>
                <div><strong>Danh m·ª•c:</strong> ${productData.Categ?.Name}</div>
                <div><strong>Variants hi·ªán t·∫°i:</strong> ${productData.ProductVariantCount}</div>
            `;

                infoDiv.classList.remove("hidden");
            }

            // Render attribute lines
            function renderAttributeLines() {
                const container = document.getElementById("attributeLinesList");
                const clearAllBtn = document.getElementById("clearAllBtn");

                if (attributeLines.length === 0) {
                    container.innerHTML =
                        '<p class="text-gray-500 text-center py-4">Ch∆∞a c√≥ thu·ªôc t√≠nh n√†o</p>';
                    document
                        .getElementById("saveSection")
                        .classList.add("hidden");
                    document
                        .getElementById("addBtn")
                        .classList.remove("hidden");
                    clearAllBtn.classList.add("hidden");
                    if (productData) {
                        document
                            .getElementById("randomBtn")
                            .classList.remove("hidden");
                    }
                    return;
                }

                container.innerHTML = attributeLines
                    .map(
                        (line, index) => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex-1">
                        <div class="font-semibold text-gray-900">${line.Attribute.Name}</div>
                        <div class="text-sm text-gray-600 mt-1">
                            ${line.Values.map((v) => v.Name).join(", ")} (${line.Values.length} gi√° tr·ªã)
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editAttributeLine(${index})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="deleteAttributeLine(${index})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `,
                    )
                    .join("");

                updatePreview();
                document
                    .getElementById("saveSection")
                    .classList.remove("hidden");
                document.getElementById("randomBtn").classList.add("hidden");
                clearAllBtn.classList.remove("hidden");
            }

            // Update variants preview
            function updatePreview() {
                if (attributeLines.length === 0) {
                    document
                        .getElementById("variantsPreview")
                        .classList.add("hidden");
                    return;
                }

                const variants = generateVariantCombinations();
                const previewDiv = document.getElementById("variantsPreview");
                const listDiv = document.getElementById("variantsList");

                const oldVariant = productData.ProductVariants.find(
                    (v) => v.Id > 0,
                );

                let rows = variants
                    .map(
                        (variant, idx) => `
                <tr class="${idx % 2 === 0 ? "bg-white" : "bg-gray-50"}">
                    <td class="border border-gray-300 px-3 py-2 text-center text-sm">${idx + 1}</td>
                    <td class="border border-gray-300 px-3 py-2 font-mono text-xs">[${variant.DefaultCode}]</td>
                    <td class="border border-gray-300 px-3 py-2 text-sm">${variant.Name}</td>
                </tr>
            `,
                    )
                    .join("");

                if (oldVariant) {
                    rows += `
                    <tr class="${variants.length % 2 === 0 ? "bg-white" : "bg-gray-50"}">
                        <td class="border border-gray-300 px-3 py-2 text-center text-sm">${variants.length + 1}</td>
                        <td class="border border-gray-300 px-3 py-2 font-mono text-xs text-gray-500 line-through">[${oldVariant.DefaultCode}]</td>
                        <td class="border border-gray-300 px-3 py-2 text-sm text-gray-500 line-through">${oldVariant.NameGet}</td>
                    </tr>
                `;
                }

                listDiv.innerHTML = rows;
                previewDiv.classList.remove("hidden");

                document
                    .getElementById("comparisonResult")
                    .classList.add("hidden");
            }

            // Generate unique SKU code
            function generateSKU(baseCode, attrs, existingCodes) {
                let code = baseCode;

                // Duy·ªát theo th·ª© t·ª± t·ª± nhi√™n c·ªßa attrs (theo th·ª© t·ª± attribute lines)
                for (const attr of attrs) {
                    const attrCode = attr.Code || attr.Name;
                    if (/^\d+$/.test(attrCode)) {
                        code += attrCode;
                    } else {
                        code += attrCode.charAt(0).toUpperCase();
                    }
                }

                let finalCode = code;
                let suffix = "";
                let counter = 0;

                while (existingCodes.has(finalCode)) {
                    counter++;
                    suffix = "1".repeat(counter);
                    finalCode = code + suffix;
                }

                existingCodes.add(finalCode);
                return finalCode;
            }

            // Generate variant combinations
            function generateVariantCombinations() {
                if (attributeLines.length === 0) return [];

                const combinations = [];

                function generate(index, current) {
                    if (index === attributeLines.length) {
                        combinations.push([...current]);
                        return;
                    }

                    const line = attributeLines[index];
                    for (const value of line.Values) {
                        generate(index + 1, [
                            ...current,
                            {
                                AttributeId: line.Attribute.Id,
                                AttributeName: line.Attribute.Name,
                                ...value,
                            },
                        ]);
                    }
                }

                generate(0, []);

                const existingCodes = new Set();
                const baseCode = productData?.DefaultCode || "PRODUCT";

                return combinations.map((attrs) => {
                    // KH√îNG SORT - gi·ªØ nguy√™n th·ª© t·ª± t·ª´ attributeLines
                    // Th·ª© t·ª± trong () s·∫Ω theo ƒë√∫ng th·ª© t·ª± ng∆∞·ªùi d√πng th√™m attribute lines
                    const variantName = `${productData?.Name || "Product"} (${attrs.map((a) => a.Name).join(", ")})`;

                    // T·∫°o m√£ SKU c≈©ng theo th·ª© t·ª± t·ª± nhi√™n
                    const variantCode = generateSKU(
                        baseCode,
                        attrs,
                        existingCodes,
                    );

                    return {
                        Id: 0,
                        Name: variantName,
                        NameGet: variantName,
                        DefaultCode: variantCode,
                        AttributeValues: attrs,
                        Active: true,
                        ProductTmplId: productData?.Id || 0,
                        PriceVariant: productData?.ListPrice || 0,
                    };
                });
            }

            // Clear all attributes
            function clearAllAttributes() {
                if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ thu·ªôc t√≠nh?")) {
                    attributeLines = [];
                    renderAttributeLines();
                }
            }

            // Auto random variants
            function autoRandomVariants() {
                if (!productData) {
                    alert("Vui l√≤ng t·∫£i s·∫£n ph·∫©m tr∆∞·ªõc!");
                    return;
                }

                const btn = document.getElementById("randomBtn");
                btn.disabled = true;
                btn.innerHTML = "üé≤ ƒêang random...";

                setTimeout(() => {
                    // Random s·ªë l∆∞·ª£ng attributes (1-3)
                    const numAttributes = Math.floor(Math.random() * 3) + 1;

                    // Shuffle v√† ch·ªçn random attributes
                    const shuffledAttrs = [...ATTRIBUTES].sort(
                        () => Math.random() - 0.5,
                    );
                    const selectedAttrs = shuffledAttrs.slice(0, numAttributes);

                    // Clear existing attribute lines
                    attributeLines = [];

                    // T·∫°o attribute lines v·ªõi random values
                    selectedAttrs.forEach((attr) => {
                        const availableValues = ATTRIBUTE_VALUES[attr.Id];

                        // Random s·ªë l∆∞·ª£ng values (2-5 ho·∫∑c t·ªëi ƒëa available)
                        const maxValues = Math.min(availableValues.length, 5);
                        const minValues = Math.min(2, availableValues.length);
                        const numValues =
                            Math.floor(
                                Math.random() * (maxValues - minValues + 1),
                            ) + minValues;

                        // Shuffle v√† ch·ªçn random values
                        const shuffledValues = [...availableValues].sort(
                            () => Math.random() - 0.5,
                        );
                        const selectedValues = shuffledValues.slice(
                            0,
                            numValues,
                        );

                        // Th√™m v√†o attribute lines
                        const line = {
                            Attribute: { ...attr, CreateVariant: true },
                            Values: selectedValues.map((v) => ({
                                ...v,
                                AttributeId: attr.Id,
                                AttributeName: attr.Name,
                            })),
                            AttributeId: attr.Id,
                        };

                        attributeLines.push(line);
                    });

                    // Render k·∫øt qu·∫£
                    renderAttributeLines();

                    // Reset button
                    btn.disabled = false;
                    btn.innerHTML = "üé≤ T·∫°o bi·∫øn th·ªÉ ng·∫´u nhi√™n";

                    // Hi·ªÉn th·ªã th√¥ng b√°o
                    const totalVariants = attributeLines.reduce(
                        (acc, line) => acc * line.Values.length,
                        1,
                    );
                    const attrNames = attributeLines
                        .map((l) => l.Attribute.Name)
                        .join(", ");
                    alert(
                        `üé≤ ƒê√£ random!\n\n‚úÖ ${attributeLines.length} thu·ªôc t√≠nh: ${attrNames}\n‚úÖ T·ªïng ${totalVariants} bi·∫øn th·ªÉ`,
                    );
                }, 300);
            }

            // Show add form
            function showAddForm() {
                document.getElementById("addForm").classList.remove("hidden");
                document.getElementById("addBtn").classList.add("hidden");
                populateAttributeSelect();
            }

            // Hide add form
            function hideAddForm() {
                document.getElementById("addForm").classList.add("hidden");
                document.getElementById("addBtn").classList.remove("hidden");
                document.getElementById("attributeSelect").value = "";
                document
                    .getElementById("valuesContainer")
                    .classList.add("hidden");
                currentEditIndex = null;
            }

            // Populate attribute select
            function populateAttributeSelect() {
                const select = document.getElementById("attributeSelect");
                const usedIds = attributeLines.map((line) => line.Attribute.Id);
                const available = ATTRIBUTES.filter(
                    (attr) => !usedIds.includes(attr.Id),
                );

                select.innerHTML =
                    '<option value="">-- Ch·ªçn thu·ªôc t√≠nh --</option>' +
                    available
                        .map(
                            (attr) =>
                                `<option value="${attr.Id}">${attr.Name}</option>`,
                        )
                        .join("");

                select.onchange = () => {
                    if (select.value) {
                        showValuesList(parseInt(select.value));
                    } else {
                        document
                            .getElementById("valuesContainer")
                            .classList.add("hidden");
                    }
                };
            }

            // Show values list
            function showValuesList(attributeId) {
                const container = document.getElementById("valuesContainer");
                const grid = document.getElementById("valuesGrid");
                const values = ATTRIBUTE_VALUES[attributeId];

                grid.innerHTML = values
                    .map(
                        (value) => `
                <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" value="${value.Id}" class="value-checkbox" data-name="${value.Name}">
                    <span class="text-sm">${value.Name}</span>
                </label>
            `,
                    )
                    .join("");

                container.classList.remove("hidden");
                updateSelectedCount();

                document.querySelectorAll(".value-checkbox").forEach((cb) => {
                    cb.onchange = updateSelectedCount;
                });
            }

            // Update selected count
            function updateSelectedCount() {
                const checked = document.querySelectorAll(
                    ".value-checkbox:checked",
                ).length;
                document.getElementById("selectedCount").textContent = checked;
            }

            // Save attribute line
            function saveAttributeLine() {
                const attrId = parseInt(
                    document.getElementById("attributeSelect").value,
                );
                if (!attrId) {
                    alert("Vui l√≤ng ch·ªçn thu·ªôc t√≠nh!");
                    return;
                }

                const checkedBoxes = document.querySelectorAll(
                    ".value-checkbox:checked",
                );
                if (checkedBoxes.length === 0) {
                    alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 gi√° tr·ªã!");
                    return;
                }

                const attribute = ATTRIBUTES.find((a) => a.Id === attrId);
                const values = Array.from(checkedBoxes).map((cb) => {
                    const value = ATTRIBUTE_VALUES[attrId].find(
                        (v) => v.Id === parseInt(cb.value),
                    );
                    return {
                        ...value,
                        AttributeId: attrId,
                        AttributeName: attribute.Name,
                    };
                });

                const line = {
                    Attribute: { ...attribute, CreateVariant: true },
                    Values: values,
                    AttributeId: attrId,
                };

                if (currentEditIndex !== null) {
                    attributeLines[currentEditIndex] = line;
                } else {
                    attributeLines.push(line);
                }

                hideAddForm();
                renderAttributeLines();
            }

            // Edit attribute line
            function editAttributeLine(index) {
                currentEditIndex = index;
                showAddForm();

                const line = attributeLines[index];
                document.getElementById("attributeSelect").value =
                    line.Attribute.Id;
                showValuesList(line.Attribute.Id);

                setTimeout(() => {
                    line.Values.forEach((value) => {
                        const checkbox = document.querySelector(
                            `.value-checkbox[value="${value.Id}"]`,
                        );
                        if (checkbox) checkbox.checked = true;
                    });
                    updateSelectedCount();
                }, 100);
            }

            // Delete attribute line
            function deleteAttributeLine(index) {
                if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a thu·ªôc t√≠nh n√†y?")) {
                    attributeLines.splice(index, 1);
                    renderAttributeLines();
                }
            }

            // Remove OData metadata from object
            function removeODataMetadata(obj) {
                if (Array.isArray(obj)) {
                    return obj.map((item) => removeODataMetadata(item));
                } else if (obj !== null && typeof obj === "object") {
                    const cleaned = {};
                    for (const key in obj) {
                        if (!key.startsWith("@odata.")) {
                            cleaned[key] = removeODataMetadata(obj[key]);
                        }
                    }
                    return cleaned;
                }
                return obj;
            }

            // Execute full flow
            async function executeFullFlow() {
                if (!productData) {
                    alert("Vui l√≤ng t·∫£i s·∫£n ph·∫©m tr∆∞·ªõc!");
                    return;
                }

                if (attributeLines.length === 0) {
                    alert("Vui l√≤ng th√™m √≠t nh·∫•t 1 thu·ªôc t√≠nh!");
                    return;
                }

                const token = document
                    .getElementById("bearerToken")
                    .value.trim();
                const btn = document.getElementById("saveBtn");

                if (
                    !confirm(
                        "B·∫°n c√≥ ch·∫Øc mu·ªën l∆∞u c√°c variants n√†y v√†o database?",
                    )
                ) {
                    return;
                }

                btn.disabled = true;
                btn.innerHTML =
                    '<div class="spinner mx-auto"></div> ƒêang x·ª≠ l√Ω...';

                try {
                    btn.innerHTML =
                        '<div class="spinner mx-auto"></div> B∆∞·ªõc 1/3: ƒêang t·∫°o preview...';
                    const variants = generateVariantCombinations();
                    const originalVariant = productData.ProductVariants[0];
                    if (originalVariant) {
                        variants.push({ ...originalVariant, Active: false });
                    }

                    const cleanProductData = removeODataMetadata(productData);

                    const previewPayload = {
                        model: {
                            ...cleanProductData,
                            ProductVariants: variants,
                            AttributeLines: attributeLines,
                        },
                    };

                    const previewResponse = await fetch(
                        "https://tomato.tpos.vn/odata/ProductTemplate/ODataService.SuggestionsVariant?$expand=AttributeValues",
                        {
                            method: "POST",
                            headers: {
                                accept: "application/json, text/plain, */*",
                                authorization: `Bearer ${token}`,
                                "content-type":
                                    "application/json;charset=UTF-8",
                                "x-tpos-lang": "vi",
                            },
                            body: JSON.stringify(previewPayload),
                        },
                    );

                    if (!previewResponse.ok) {
                        const errorData = await previewResponse.json();
                        throw new Error(
                            "Preview failed: " +
                                (errorData.error?.message ||
                                    previewResponse.status),
                        );
                    }

                    previewData = await previewResponse.json();

                    btn.innerHTML =
                        '<div class="spinner mx-auto"></div> B∆∞·ªõc 2/3: ƒêang l∆∞u v√†o database...';
                    const savePayload = {
                        ...cleanProductData,
                        ProductVariants: previewData.value,
                        AttributeLines: attributeLines,
                        Version: 0,
                    };

                    const saveResponse = await fetch(
                        "https://tomato.tpos.vn/odata/ProductTemplate/ODataService.UpdateV2",
                        {
                            method: "POST",
                            headers: {
                                accept: "application/json, text/plain, */*",
                                authorization: `Bearer ${token}`,
                                "content-type":
                                    "application/json;charset=UTF-8",
                                "x-tpos-lang": "vi",
                            },
                            body: JSON.stringify(savePayload),
                        },
                    );

                    if (!saveResponse.ok) {
                        const errorData = await saveResponse.json();
                        throw new Error(
                            "Save failed: " +
                                (errorData.error?.message ||
                                    saveResponse.status),
                        );
                    }

                    btn.innerHTML =
                        '<div class="spinner mx-auto"></div> B∆∞·ªõc 3/3: ƒêang ki·ªÉm tra d·ªØ li·ªáu...';
                    const productId =
                        document.getElementById("productId").value;
                    const verifyResponse = await fetch(
                        `https://tomato.tpos.vn/odata/ProductTemplate(${productId})?$expand=UOM,UOMCateg,Categ,UOMPO,POSCateg,Taxes,SupplierTaxes,Product_Teams,Images,UOMView,Distributor,Importer,Producer,OriginCountry,ProductVariants($expand=UOM,Categ,UOMPO,POSCateg,AttributeValues)`,
                        {
                            headers: {
                                accept: "application/json, text/plain, */*",
                                authorization: `Bearer ${token}`,
                                "x-tpos-lang": "vi",
                            },
                        },
                    );

                    if (!verifyResponse.ok) {
                        throw new Error(
                            "Verify failed: " + verifyResponse.status,
                        );
                    }

                    const verifiedData = await verifyResponse.json();

                    const expectedVariants = previewData.value.filter(
                        (v) => v.Active === true,
                    );
                    const actualVariants = verifiedData.ProductVariants.filter(
                        (v) => v.Active === true,
                    );

                    const comparisonResult = compareVariants(
                        expectedVariants,
                        actualVariants,
                    );

                    showComparisonResult(
                        comparisonResult,
                        expectedVariants.length,
                        actualVariants.length,
                    );

                    productData = verifiedData;
                    displayProductInfo();

                    attributeLines = [];
                    previewData = null;
                    renderAttributeLines();
                } catch (error) {
                    alert("‚åõ L·ªói: " + error.message);
                    console.error(error);
                } finally {
                    btn.disabled = false;
                    btn.textContent = "L∆∞u Variants v√†o Database";
                }
            }

            // Compare variants - so s√°nh theo AttributeValues thay v√¨ Name
            function compareVariants(expected, actual) {
                const matches = [];
                const missing = [];
                const extra = [];

                // T·∫°o signature d·ª±a tr√™n AttributeValues (set of attribute value IDs)
                function getVariantSignature(variant) {
                    if (
                        !variant.AttributeValues ||
                        variant.AttributeValues.length === 0
                    ) {
                        return "";
                    }
                    // Sort attribute value IDs ƒë·ªÉ ƒë·∫£m b·∫£o signature nh·∫•t qu√°n
                    const attrValueIds = variant.AttributeValues.map(
                        (av) => av.Id,
                    )
                        .sort((a, b) => a - b)
                        .join(",");
                    return attrValueIds;
                }

                // T·∫°o map t·ª´ signature -> variant
                const actualMap = new Map();
                actual.forEach((v) => {
                    const sig = getVariantSignature(v);
                    if (sig) {
                        actualMap.set(sig, v);
                    }
                });

                // So s√°nh expected v·ªõi actual
                for (const exp of expected) {
                    const sig = getVariantSignature(exp);
                    const variantName = exp.Name || exp.NameGet;
                    const variantCode = exp.DefaultCode;

                    if (actualMap.has(sig)) {
                        matches.push({ code: variantCode, name: variantName });
                        actualMap.delete(sig);
                    } else {
                        missing.push({ code: variantCode, name: variantName });
                    }
                }

                // Nh·ªØng variants c√≤n l·∫°i l√† th·ª´a
                for (const [sig, v] of actualMap) {
                    extra.push({ code: v.DefaultCode, name: v.Name });
                }

                return { matches, missing, extra };
            }

            // Show comparison result inline
            function showComparisonResult(result, expectedCount, actualCount) {
                const { matches, missing, extra } = result;
                const comparisonDiv =
                    document.getElementById("comparisonResult");
                const contentDiv = document.getElementById("comparisonContent");

                let statusIcon = "‚úÖ";
                let statusText = "Ho√†n th√†nh";
                let statusColor = "text-green-600";
                let bgColor = "bg-green-50";

                if (missing.length > 0 || extra.length > 0) {
                    statusIcon = "‚ö†Ô∏è";
                    statusText = "C√≥ c·∫£nh b√°o";
                    statusColor = "text-yellow-600";
                    bgColor = "bg-yellow-50";
                }

                let content = `
                    <div class="${bgColor} border-2 ${statusColor.replace("text-", "border-")} rounded-lg p-4 text-center">
                        <div class="text-3xl mb-1">${statusIcon}</div>
                        <div class="font-bold ${statusColor}">${statusText}</div>
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-blue-50 rounded p-2 text-center">
                            <div class="text-xl font-bold text-blue-600">${expectedCount}</div>
                            <div class="text-xs text-gray-600">D·ª± ki·∫øn</div>
                        </div>
                        <div class="bg-green-50 rounded p-2 text-center">
                            <div class="text-xl font-bold text-green-600">${actualCount}</div>
                            <div class="text-xs text-gray-600">Th·ª±c t·∫ø</div>
                        </div>
                        <div class="bg-purple-50 rounded p-2 text-center">
                            <div class="text-xl font-bold text-purple-600">${matches.length}</div>
                            <div class="text-xs text-gray-600">Kh·ªõp</div>
                        </div>
                    </div>
                `;

                if (matches.length > 0) {
                    content += `
                        <div>
                            <h4 class="font-semibold text-green-600 mb-2 text-sm">‚úì Kh·ªõp (${matches.length})</h4>
                            <div class="bg-green-50 rounded p-2 max-h-48 overflow-y-auto border border-green-200">
                                <ul class="text-xs space-y-1">
                                    ${matches
                                        .map(
                                            (v, idx) => `
                                        <li class="text-gray-700">
                                            ${idx + 1}. <span class="font-mono font-semibold">[${v.code}]</span>
                                            <br><span class="text-gray-600 ml-4">${v.name}</span>
                                        </li>
                                    `,
                                        )
                                        .join("")}
                                </ul>
                            </div>
                        </div>
                    `;
                }

                if (missing.length > 0) {
                    content += `
                        <div>
                            <h4 class="font-semibold text-red-600 mb-2 text-sm">‚úó Thi·∫øu (${missing.length})</h4>
                            <div class="bg-red-50 rounded p-2 max-h-48 overflow-y-auto border border-red-200">
                                <ul class="text-xs space-y-1">
                                    ${missing
                                        .map(
                                            (v, idx) => `
                                        <li class="text-gray-700">
                                            ${idx + 1}. <span class="font-mono font-semibold">[${v.code}]</span>
                                            <br><span class="text-gray-600 ml-4">${v.name}</span>
                                        </li>
                                    `,
                                        )
                                        .join("")}
                                </ul>
                            </div>
                        </div>
                    `;
                }

                if (extra.length > 0) {
                    content += `
                        <div>
                            <h4 class="font-semibold text-orange-600 mb-2 text-sm">+ Th·ª´a (${extra.length})</h4>
                            <div class="bg-orange-50 rounded p-2 max-h-48 overflow-y-auto border border-orange-200">
                                <ul class="text-xs space-y-1">
                                    ${extra
                                        .map(
                                            (v, idx) => `
                                        <li class="text-gray-700">
                                            ${idx + 1}. <span class="font-mono font-semibold">[${v.code}]</span>
                                            <br><span class="text-gray-600 ml-4">${v.name}</span>
                                        </li>
                                    `,
                                        )
                                        .join("")}
                                </ul>
                            </div>
                        </div>
                    `;
                }

                if (missing.length === 0 && extra.length === 0) {
                    content += `
                        <div class="bg-green-100 border-2 border-green-500 rounded-lg p-3 text-center">
                            <div class="text-2xl mb-1">üéâ</div>
                            <div class="font-semibold text-green-700 text-sm">Ho√†n h·∫£o! T·∫•t c·∫£ ${matches.length} variants ƒë√£ kh·ªõp!</div>
                        </div>
                    `;
                }

                contentDiv.innerHTML = content;
                comparisonDiv.classList.remove("hidden");
            }

            // Initialize
            renderAttributeLines();
        </script>
    </body>
</html>
