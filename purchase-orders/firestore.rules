rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // PURCHASE ORDERS COLLECTION
    // ========================================
    match /purchase_orders/{orderId} {

      // Helper: Check if user is authenticated
      function isAuthenticated() {
        return request.auth != null;
      }

      // Helper: Check if user is admin (level 0-1)
      function isAdmin() {
        return request.auth != null &&
               request.auth.token.checkLogin != null &&
               request.auth.token.checkLogin <= 1;
      }

      // Helper: Get order status
      function getStatus() {
        return resource.data.status;
      }

      // Helper: Check if order is in editable state
      function isEditable() {
        return getStatus() != 'COMPLETED' && getStatus() != 'CANCELLED';
      }

      // Helper: Check if order can be deleted
      // Only DRAFT and CANCELLED orders can be deleted
      function isDeletable() {
        return getStatus() == 'DRAFT' || getStatus() == 'CANCELLED';
      }

      // Helper: Validate status transition
      function isValidTransition(from, to) {
        return (from == 'DRAFT' && (to == 'AWAITING_PURCHASE' || to == 'CANCELLED')) ||
               (from == 'AWAITING_PURCHASE' && (to == 'AWAITING_DELIVERY' || to == 'DRAFT' || to == 'CANCELLED')) ||
               (from == 'AWAITING_DELIVERY' && (to == 'RECEIVED' || to == 'CANCELLED')) ||
               (from == 'RECEIVED' && to == 'COMPLETED');
      }

      // READ: Authenticated users can read
      allow read: if isAuthenticated();

      // CREATE: Authenticated users can create
      // Validate required fields
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['orderNumber', 'status', 'createdAt', 'items']) &&
                       request.resource.data.status in ['DRAFT', 'AWAITING_PURCHASE'];

      // UPDATE: Authenticated users can update editable orders
      // Check status transition validity
      allow update: if isAuthenticated() &&
                       isEditable() &&
                       (
                         // Status unchanged
                         request.resource.data.status == resource.data.status ||
                         // Valid status transition
                         isValidTransition(resource.data.status, request.resource.data.status)
                       );

      // DELETE: Only deletable orders (DRAFT, CANCELLED)
      allow delete: if isAuthenticated() && isDeletable();
    }

    // ========================================
    // SUPPLIERS COLLECTION (if needed)
    // ========================================
    match /suppliers/{supplierId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}
