<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>B√°o c√°o livestream</title>
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../logo.jpg" />
    
    <!-- The core Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <!-- The Firebase storage SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <!-- The Firebase firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Load jQuery from a CDN -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    
    <!-- Main CSS -->
    <link rel="stylesheet" href="../main.css">
    
    <!-- Navigation Manager - Load tr∆∞·ªõc khi load page scripts -->
    <script src="../js/navigation.js"></script>
    <script src="../js/common-utils.js"></script>
</head>

<body>
    <!-- Security Indicator -->
    <div class="security-indicator" id="securityIndicator">Secure</div>
    
    <!-- Performance Indicator -->
    <div class="performance-indicator" id="performanceIndicator">Fast Load</div>
    
    <!-- Menu Toggle Button -->
    <button class="menu-toggle">
        <div class="hamburger"></div>
    </button>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Menu ƒêi·ªÅu H∆∞·ªõng</h3>
            <button class="close-btn">&times;</button>
        </div>
        <ul class="nav-list"></ul>
    </nav>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <div class="main-content">
        <div class="header">
            <h2>Nh·∫≠p d·ªØ li·ªáu s·∫£n ph·∫©m</h2>
        </div>

        <div class="input-section">
            <div class="input-group">
                <textarea id="productInput" placeholder="V√≠ d·ª•:
G·∫•u - 1 - 100
Th·ªè - 3 - 200
C√° - 5 - 100
Ch·ªçn 'T·∫•t c·∫£' ƒë·ªÉ xem to√†n b·ªô d·ªØ li·ªáu
K√©o b·∫£ng nh·∫≠p li·ªáu ·ªü d∆∞·ªõi g√≥c ph·∫£i"></textarea>
                <input type="date" id="dateInput">
                <button onclick="addProducts()">X√°c nh·∫≠n</button>
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-group">
                <label>L·ªçc theo ng√†y: </label>
                <input type="date" id="filterDate">
                <button onclick="applyFilter()">L·ªçc</button>
                <button onclick="clearFilter()">T·∫•t c·∫£</button>
                <button onclick="deleteByFilter()">Xo√° h·∫øt theo l·ªçc</button>
                <button class="btn-export" onclick="exportToExcel()">üì• Xu·∫•t Excel</button>
            </div>
        </div>

        <div class="table-container">
            <table id="productTable">
                <thead>
                    <tr>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Gi√° ti·ªÅn</th>
                        <th>Th√†nh ti·ªÅn</th>
                        <th>Ng√†y nh·∫≠p</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Enhanced Floating Alert -->
    <div id="floatingAlert">
        <div class="alert-content">
            <div class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
            </div>
            <div class="alert-text">Th√¥ng b√°o hi·ªÉn th·ªã!</div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay"></div>
    
    <!-- Blocking Overlay -->
    <div id="blockingOverlay"></div>
    
    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const historyCollectionRef = db.collection("edit_history");

        let unsubscribe = null;
        let currentProductData = []; // Store current displayed data for export
        const today = new Date().toISOString().split("T")[0];
        
        // Check both localStorage and sessionStorage for login status
		var isLoggedIn = localStorage.getItem('isLoggedIn') || sessionStorage.getItem('isLoggedIn') || 'false';
		const userType = localStorage.getItem('userType') || sessionStorage.getItem('userType') || null;
		const checkLogin = localStorage.getItem('checkLogin') || sessionStorage.getItem('checkLogin');

		if (isLoggedIn === 'true') {
			
		} else {
			// Comment out redirect for development/testing
			window.location.href = '../index.html';
			console.log('User not logged in - redirect to index.html disabled for development');
		}
        
        document.getElementById("dateInput").value = today;
        document.getElementById("filterDate").value = today;

        // üîπ Logging function
        function logAction(action, description, oldData = null, newData = null, pageName = 'Nh·∫≠p h√†ng') {
            const logEntry = {
                timestamp: new Date(),
                user: currentUser,
                page: pageName,
                action: action,
                description: description,
                oldData: oldData,
                newData: newData,
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };

            // Save to Firebase
            historyCollectionRef.add(logEntry)
                .then(() => {
                    console.log("Log entry saved successfully");
                })
                .catch((error) => {
                    console.error("Error saving log entry: ", error);
                });
        }

        // üîπ Show floating alert
        function showFloatingAlert(message) {
            const alertBox = document.getElementById('floatingAlert');
            alertBox.innerText = message;
            alertBox.classList.add('show');

            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 3000);
        }

        // üîπ Export to Excel function
        function exportToExcel() {
            if (currentProductData.length === 0) {
                showFloatingAlert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
                return;
            }

            try {
                // Prepare data for export
                const exportData = currentProductData.map((item, index) => ({
                    'STT': index + 1,
                    'T√™n s·∫£n ph·∫©m': item.ten,
                    'S·ªë l∆∞·ª£ng': item.soLuong,
                    'Gi√° ti·ªÅn': item.gia,
                    'Th√†nh ti·ªÅn': item.thanhTien,
                    'Ng√†y nh·∫≠p': item.ngay
                }));

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);

                // Set column widths
                const wscols = [
                    {wch: 5},   // STT
                    {wch: 30},  // T√™n s·∫£n ph·∫©m
                    {wch: 12},  // S·ªë l∆∞·ª£ng
                    {wch: 15},  // Gi√° ti·ªÅn
                    {wch: 15},  // Th√†nh ti·ªÅn
                    {wch: 15}   // Ng√†y nh·∫≠p
                ];
                ws['!cols'] = wscols;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, "Nh·∫≠p h√†ng");

                // Generate filename with current date
                const currentDate = new Date().toISOString().split('T')[0];
                const filterDate = document.getElementById("filterDate").value;
                const filename = filterDate ? 
                    `NhapHang_${filterDate}.xlsx` : 
                    `NhapHang_TatCa_${currentDate}.xlsx`;

                // Write file
                XLSX.writeFile(wb, filename);

                // Log the export action
                logAction('export', `Xu·∫•t d·ªØ li·ªáu nh·∫≠p h√†ng ra Excel (${currentProductData.length} s·∫£n ph·∫©m)`, null, {
                    filename: filename,
                    recordCount: currentProductData.length,
                    filterDate: filterDate || 'T·∫•t c·∫£'
                });

                showFloatingAlert(`ƒê√£ xu·∫•t ${currentProductData.length} s·∫£n ph·∫©m ra file ${filename}!`);
            } catch (error) {
                console.error("Error exporting to Excel:", error);
                showFloatingAlert("L·ªói khi xu·∫•t file Excel!");
            }
        }

        // üîπ Th√™m nhi·ªÅu s·∫£n ph·∫©m (c√≥ ki·ªÉm tra tr√πng)
        function addProducts() {
            const inputText = document.getElementById("productInput").value.trim();
            const date = document.getElementById("dateInput").value;

            if (!inputText) {
                showFloatingAlert("Vui l√≤ng nh·∫≠p d·ªØ li·ªáu!");
                return;
            }

            const lines = inputText.split("\n").map(line => line.trim()).filter(line => line);
            let products = [];

            for (let line of lines) {
                let parts = line.split("-").map(p => p.trim());
                if (parts.length < 3) continue;

                let ten = parts[0];
                let soLuong = parseInt(parts[1]) || 0;
                let gia = parseInt(parts[2]) || 0;
                let thanhTien = soLuong * gia;

                products.push({ ten, soLuong, gia, thanhTien, ngay: date });
            }

            if (products.length === 0) {
                showFloatingAlert("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá!");
                return;
            }

            if (!confirm(`X√°c nh·∫≠n th√™m ${products.length} s·∫£n ph·∫©m v√†o ng√†y ${date}?`)) return;

            processProducts(products);
        }

        // üîπ Process products with duplicate checking
        async function processProducts(products) {
            let addedCount = 0;
            let duplicateCount = 0;

            for (let p of products) {
                // ki·ªÉm tra tr√πng (t√™n + ng√†y)
                let existing = await db.collection("nhaphang")
                    .where("ten", "==", p.ten)
                    .where("ngay", "==", p.ngay)
                    .get();

                if (!existing.empty) {
                    duplicateCount++;
                    showFloatingAlert(`‚ùå L·ªói: S·∫£n ph·∫©m "${p.ten}" ƒë√£ t·ªìn t·∫°i trong ng√†y ${p.ngay}, kh√¥ng th·ªÉ th√™m tr√πng!`);
                } else {
                    await db.collection("nhaphang").add({
                        ...p,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    addedCount++;

                    // Log the add action
                    logAction('add', `Th√™m s·∫£n ph·∫©m: ${p.ten}`, null, p);
                }
            }

            if (addedCount > 0) {
                showFloatingAlert(`‚úÖ ƒê√£ th√™m ${addedCount} s·∫£n ph·∫©m th√†nh c√¥ng!`);
                document.getElementById("productInput").value = "";
            }

            if (duplicateCount > 0) {
                showFloatingAlert(`‚ö†Ô∏è C√≥ ${duplicateCount} s·∫£n ph·∫©m b·ªã tr√πng kh√¥ng th·ªÉ th√™m!`);
            }
        }

        // üîπ L·∫Øng nghe v√† hi·ªÉn th·ªã d·ªØ li·ªáu
        function listenProducts(filterDate = null) {
            if (unsubscribe) unsubscribe();

            let query = db.collection("nhaphang").orderBy("createdAt", "asc");
            if (filterDate) query = query.where("ngay", "==", filterDate);

            unsubscribe = query.onSnapshot(snapshot => {
                const tbody = document.getElementById("productTable").querySelector("tbody");
                tbody.innerHTML = "";
                currentProductData = []; // Reset current data for export

                snapshot.forEach(doc => {
                    const data = doc.data();
                    currentProductData.push(data); // Store for export

                    let row = tbody.insertRow();
                    row.insertCell(0).textContent = data.ten;
                    row.insertCell(1).textContent = data.soLuong;
                    row.insertCell(2).textContent = data.gia;
                    row.insertCell(3).textContent = data.thanhTien;
                    row.insertCell(4).textContent = data.ngay;

                    let actionsCell = row.insertCell(5);
                    let btnDelete = document.createElement("button");
                    btnDelete.textContent = "Xo√°";
                    btnDelete.className = "btn-delete";
                    btnDelete.onclick = () => deleteProduct(doc.id, data);
                    actionsCell.appendChild(btnDelete);
                });
            });
        }

        // üîπ Xo√° 1 s·∫£n ph·∫©m
        async function deleteProduct(id, productData) {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° s·∫£n ph·∫©m n√†y?")) {
                await db.collection("nhaphang").doc(id).delete();
                
                // Log the delete action
                logAction('delete', `X√≥a s·∫£n ph·∫©m: ${productData.ten}`, productData, null);
                
                showFloatingAlert("ƒê√£ x√≥a s·∫£n ph·∫©m th√†nh c√¥ng!");
            }
        }

        // üîπ L·ªçc d·ªØ li·ªáu theo ng√†y
        function applyFilter() {
            const date = document.getElementById("filterDate").value;
            listenProducts(date);
            
            // Log filter action
            logAction('filter', `L·ªçc d·ªØ li·ªáu theo ng√†y: ${date || 'T·∫•t c·∫£'}`, null, { filterDate: date });
            
            showFloatingAlert(date ? `ƒê√£ l·ªçc d·ªØ li·ªáu ng√†y ${date}` : "Hi·ªÉn th·ªã t·∫•t c·∫£ d·ªØ li·ªáu");
        }

        // üîπ Xem t·∫•t c·∫£
        function clearFilter() {
            document.getElementById("filterDate").value = "";
            listenProducts(null);
            showFloatingAlert("Hi·ªÉn th·ªã t·∫•t c·∫£ d·ªØ li·ªáu");
        }

        // üîπ Xo√° theo filter
        async function deleteByFilter() {
            const date = document.getElementById("filterDate").value;
            const isAll = !date;
            
            if (!confirm(isAll ? "Xo√° t·∫•t c·∫£ s·∫£n ph·∫©m?" : `Xo√° t·∫•t c·∫£ s·∫£n ph·∫©m ng√†y ${date}?`)) return;

            let query = db.collection("nhaphang");
            if (!isAll) query = query.where("ngay", "==", date);

            const snapshot = await query.get();
            const deleteCount = snapshot.size;
            
            if (deleteCount === 0) {
                showFloatingAlert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ x√≥a!");
                return;
            }

            // Store data for logging before deletion
            const deletedProducts = [];
            snapshot.forEach(doc => {
                deletedProducts.push(doc.data());
            });

            let batch = db.batch();
            snapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();

            // Log bulk delete action
            logAction('delete', isAll ? 
                `X√≥a t·∫•t c·∫£ s·∫£n ph·∫©m (${deleteCount} s·∫£n ph·∫©m)` : 
                `X√≥a t·∫•t c·∫£ s·∫£n ph·∫©m ng√†y ${date} (${deleteCount} s·∫£n ph·∫©m)`,
                { deletedProducts: deletedProducts, count: deleteCount },
                null
            );

            showFloatingAlert(`ƒê√£ x√≥a ${deleteCount} s·∫£n ph·∫©m th√†nh c√¥ng!`);
        }

        // üîπ Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const menuToggle = document.querySelector('.menu-toggle');
            
            const isOpen = sidebar.classList.contains('open');
            
            if (isOpen) {
                // ƒê√≥ng sidebar
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                menuToggle.classList.remove('active');
                menuToggle.classList.remove('hidden');
            } else {
                // M·ªü sidebar
                sidebar.classList.add('open');
                overlay.classList.add('active');
                menuToggle.classList.add('active');
                menuToggle.classList.add('hidden');
            }
        }

        // üîπ Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Hi·ªÉn th·ªã t·∫•t c·∫£ d·ªØ li·ªáu thay v√¨ ch·ªâ h√¥m nay
			listenProducts(null);
			
			// Nh∆∞ng v·∫´n set ng√†y h√¥m nay cho c√°c input
			document.getElementById("dateInput").value = today;
			document.getElementById("filterDate").value = today;
        });

        // üîπ Make functions globally available
        window.addProducts = addProducts;
        window.deleteProduct = deleteProduct;
        window.applyFilter = applyFilter;
        window.clearFilter = clearFilter;
        window.deleteByFilter = deleteByFilter;
        window.exportToExcel = exportToExcel;
        window.toggleSidebar = toggleSidebar;
    </script>
</body>

</html>
