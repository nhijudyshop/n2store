<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Nh·∫≠p H√†ng</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        textarea,
        input,
        select {
            padding: 8px;
            margin: 5px 5px 5px 0;
        }

        textarea {
            width: 400px;
            height: 120px;
        }

        button {
            padding: 8px 12px;
            margin-right: 5px;
            cursor: pointer;
        }

        table {
            margin-top: 20px;
            border-collapse: collapse;
            width: 95%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background: #f2f2f2;
        }

        .error {
            color: red;
            font-weight: bold;
        }
    </style>

    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link href="../css/ck.css" rel="stylesheet"> -->
    <link rel="stylesheet" type="text/css" href="../css/trangchu.css">
    <title>TH√îNG TIN CHUY·ªÇN KHO·∫¢N</title>
    <link rel="shortcut icon" href="../logo.jpg" />
    <!-- The core Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <!-- The Firebase storage SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <!-- The Firebase firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Load jQuery from a CDN -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
</head>

<body>
    <div class="nav-container">
       <ul class="nav-list">
          <li class="nav-item"><a href="../live/index.html">H√åNH ·∫¢NH LIVE ƒê·∫¶Y ƒê·ª¶</a></li>
          <li class="nav-item"><a href="../hangrotxa/index.html">H√ÄNG R·ªöT - X·∫¢</a></li>
          <!-- <li class="nav-item"><a href="../dubi/index.html">KH√ÅCH LIVE D·ª∞ B·ªä</a></li> -->
          <li class="nav-item"><a href="../ib/index.html">CHECK INBOX KH√ÅCH H√ÄNG</a></li>
          <li class="nav-item"><a href="../ck/index.html">TH√îNG TIN CHUY·ªÇN KHO·∫¢N</a></li>
          <!-- <li class="nav-item"><a href="../banhang/index.html">B√ÅN H√ÄNG KH√ÅCH VIP</a></li> -->
          <li class="nav-item"><a href="../hanghoan/index.html">H√ÄNG HO√ÄN</a></li>
          <li class="nav-item"><a id="current-page-link" href="../nhaphang/index.html">NH·∫¨P H√ÄNG</a></li>
       </ul>
    </div>
    <h2>Nh·∫≠p d·ªØ li·ªáu s·∫£n ph·∫©m</h2>
    <textarea id="productInput" placeholder="V√≠ d·ª•:
G·∫•u - 1 - 100
Th·ªè - 3 - 200
C√° - 5 - 100
K√©o b·∫£ng nh·∫≠p li·ªáu ·ªü d∆∞·ªõi g√≥c ph·∫£i"></textarea>
    <input type="date" id="dateInput">
    <button onclick="addProducts()">X√°c nh·∫≠n</button>

    <div style="margin-top:20px;">
        <label>L·ªçc theo ng√†y: </label>
        <input type="date" id="filterDate">
        <button onclick="applyFilter()">L·ªçc</button>
        <button onclick="clearFilter()">T·∫•t c·∫£</button>
        <button onclick="deleteByFilter()">Xo√° h·∫øt theo l·ªçc</button>
    </div>

    <table id="productTable">
        <thead>
            <tr>
                <th>T√™n s·∫£n ph·∫©m</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>Gi√° ti·ªÅn</th>
                <th>Th√†nh ti·ªÅn</th>
                <th>Ng√†y nh·∫≠p</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        // üîπ TODO: thay b·∫±ng config Firebase c·ªßa b·∫°n
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        function _0x1ab2(_0x36a23b, _0x52223b) {
            const _0x2e058f = _0x2e05();
            return _0x1ab2 = function(_0x1ab212, _0x4110aa) {
                _0x1ab212 = _0x1ab212 - 0x162;
                let _0x120a0e = _0x2e058f[_0x1ab212];
                return _0x120a0e;
            }, _0x1ab2(_0x36a23b, _0x52223b);
        }

        function _0x2e05() {
            const _0x5a5dc7 = ['1235460FrnjKH', '22977963vpMYJv', 'AIzaSyA-legWlCgjMDEy70rsaTTwLK39F4ZCKhM', 'n2shop-69e37-ne0q1', 'G-TEJH3S2T1D', '1345047lnZTNJ', '366711YpKMry', '13142736zaWdgA', '598906493303', '3756921uppNah', '25XRvqCS', 'n2shop-69e37', '14dthlHY', 'n2shop-69e37.firebaseapp.com', '10009662EXBqRi'];
            _0x2e05 = function() {
                return _0x5a5dc7;
            };
            return _0x2e05();
        }
        const _0x3a343d = _0x1ab2;
        (function(_0x46d1e0, _0x1a2442) {
            const _0x1acdbc = _0x1ab2,
                _0x2a2d1c = _0x46d1e0();
            while (!![]) {
                try {
                    const _0x1aa040 = parseInt(_0x1acdbc(0x168)) / 0x1 + -parseInt(_0x1acdbc(0x16f)) / 0x2 * (-parseInt(_0x1acdbc(0x169)) / 0x3) + parseInt(_0x1acdbc(0x163)) / 0x4 * (-parseInt(_0x1acdbc(0x16d)) / 0x5) + parseInt(_0x1acdbc(0x162)) / 0x6 + -parseInt(_0x1acdbc(0x16c)) / 0x7 + parseInt(_0x1acdbc(0x16a)) / 0x8 + -parseInt(_0x1acdbc(0x164)) / 0x9;
                    if (_0x1aa040 === _0x1a2442) break;
                    else _0x2a2d1c['push'](_0x2a2d1c['shift']());
                } catch (_0x3223ad) {
                    _0x2a2d1c['push'](_0x2a2d1c['shift']());
                }
            }
        }(_0x2e05, 0xd647a));
        const firebaseConfig = {
            'apiKey': _0x3a343d(0x165),
            'authDomain': _0x3a343d(0x170),
            'projectId': _0x3a343d(0x16e),
            'storageBucket': _0x3a343d(0x166),
            'messagingSenderId': _0x3a343d(0x16b),
            'appId': '1:598906493303:web:46d6236a1fdc2eff33e972',
            'measurementId': _0x3a343d(0x167)
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let unsubscribe = null;
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("dateInput").value = today;
        document.getElementById("filterDate").value = today;

        // üîπ Th√™m nhi·ªÅu s·∫£n ph·∫©m (c√≥ ki·ªÉm tra tr√πng)
        async function addProducts() {
            const inputText = document.getElementById("productInput").value.trim();
            const date = document.getElementById("dateInput").value;

            if (!inputText) {
                alert("Vui l√≤ng nh·∫≠p d·ªØ li·ªáu!");
                return;
            }

            const lines = inputText.split("\n").map(line => line.trim()).filter(line => line);
            let products = [];

            for (let line of lines) {
                let parts = line.split("-").map(p => p.trim());
                if (parts.length < 3) continue;

                let ten = parts[0];
                let soLuong = parseInt(parts[1]) || 0;
                let gia = parseInt(parts[2]) || 0;
                let thanhTien = soLuong * gia;

                products.push({ ten, soLuong, gia, thanhTien, ngay: date });
            }

            if (products.length === 0) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá!");
                return;
            }

            if (!confirm(`X√°c nh·∫≠n th√™m ${products.length} s·∫£n ph·∫©m v√†o ng√†y ${date}?`)) return;

            for (let p of products) {
                // ki·ªÉm tra tr√πng (t√™n + ng√†y)
                let existing = await db.collection("nhaphang")
                    .where("ten", "==", p.ten)
                    .where("ngay", "==", p.ngay)
                    .get();

                if (!existing.empty) {
                    alert(`‚ùå L·ªói: S·∫£n ph·∫©m "${p.ten}" ƒë√£ t·ªìn t·∫°i trong ng√†y ${p.ngay}, kh√¥ng th·ªÉ th√™m tr√πng!`);
                } else {
                    await db.collection("nhaphang").add({
                        ...p,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }

            document.getElementById("productInput").value = "";
        }

        // üîπ L·∫Øng nghe v√† hi·ªÉn th·ªã d·ªØ li·ªáu
        function listenProducts(filterDate = null) {
            if (unsubscribe) unsubscribe();

            let query = db.collection("nhaphang").orderBy("createdAt", "asc");
            if (filterDate) query = query.where("ngay", "==", filterDate);

            unsubscribe = query.onSnapshot(snapshot => {
                const tbody = document.getElementById("productTable").querySelector("tbody");
                tbody.innerHTML = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let row = tbody.insertRow();
                    row.insertCell(0).textContent = data.ten;
                    row.insertCell(1).textContent = data.soLuong;
                    row.insertCell(2).textContent = data.gia;
                    row.insertCell(3).textContent = data.thanhTien;
                    row.insertCell(4).textContent = data.ngay;

                    let actionsCell = row.insertCell(5);
                    let btnDelete = document.createElement("button");
                    btnDelete.textContent = "Xo√°";
                    btnDelete.onclick = () => deleteProduct(doc.id);
                    actionsCell.appendChild(btnDelete);
                });
            });
        }

        // üîπ Xo√° 1 s·∫£n ph·∫©m
        async function deleteProduct(id) {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° s·∫£n ph·∫©m n√†y?")) {
                await db.collection("nhaphang").doc(id).delete();
            }
        }

        // üîπ L·ªçc d·ªØ li·ªáu theo ng√†y
        function applyFilter() {
            const date = document.getElementById("filterDate").value;
            listenProducts(date);
        }

        // üîπ Xem t·∫•t c·∫£
        function clearFilter() {
            listenProducts(null);
        }

        // üîπ Xo√° theo filter
        async function deleteByFilter() {
            const date = document.getElementById("filterDate").value;
            const isAll = !date;
            if (!confirm(isAll ? "Xo√° t·∫•t c·∫£ s·∫£n ph·∫©m?" : `Xo√° t·∫•t c·∫£ s·∫£n ph·∫©m ng√†y ${date}?`)) return;

            let query = db.collection("nhaphang");
            if (!isAll) query = query.where("ngay", "==", date);

            const snapshot = await query.get();
            let batch = db.batch();
            snapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
        }

        // üîπ M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã h√¥m nay
        listenProducts(today);
    </script>
</body>

</html>
