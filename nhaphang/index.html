<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Nh·∫≠p H√†ng</title>
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../logo.jpg" />
    
    <!-- The core Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <!-- The Firebase storage SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <!-- The Firebase firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Load jQuery from a CDN -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="../navigation.js"></script>
	
    <style>
        /* CSS ƒë∆∞·ª£c nh√∫ng tr·ª±c ti·∫øp */
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          margin: 0;
          padding: 0;
          overflow-x: hidden;
        }

        .container {
          display: flex;
          min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
          position: fixed;
          left: -300px;
          top: 0;
          width: 300px;
          height: 100vh;
          background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
          box-shadow: 2px 0 15px rgba(0, 0, 0, 0.2);
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          z-index: 1000;
          overflow-y: auto;
        }

        .sidebar.open {
          left: 0;
        }

        .sidebar-header {
          padding: 30px 20px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          text-align: center;
          position: relative;
        }

        .sidebar-header h3 {
          margin: 0;
          font-size: 1.2rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 1px;
        }

        .close-btn {
          position: absolute;
          right: 15px;
          top: 50%;
          transform: translateY(-50%);
          background: rgba(255, 255, 255, 0.2);
          border: none;
          color: white;
          width: 35px;
          height: 35px;
          border-radius: 50%;
          cursor: pointer;
          font-size: 18px;
          transition: all 0.3s ease;
        }

        .close-btn:hover {
          background: rgba(255, 255, 255, 0.3);
          transform: translateY(-50%) scale(1.1);
        }

        .nav-list {
          list-style: none;
          padding: 0;
          margin: 0;
        }

        .nav-item {
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-item:last-child {
          border-bottom: none;
        }

        .nav-item a {
          display: flex;
          align-items: center;
          padding: 18px 25px;
          text-decoration: none;
          color: #ecf0f1;
          font-weight: 500;
          font-size: 14px;
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        }

        .nav-item a .icon {
          margin-right: 15px;
          font-size: 18px;
          width: 24px;
          text-align: center;
          transition: transform 0.3s ease;
        }

        .nav-item a:hover .icon {
          transform: scale(1.2);
        }

        .nav-item a::before {
          content: "";
          position: absolute;
          left: 0;
          top: 0;
          width: 4px;
          height: 100%;
          background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
          transform: scaleY(0);
          transition: transform 0.3s ease;
        }

        .nav-item a:hover::before {
          transform: scaleY(1);
        }

        .nav-item a:hover {
          background: rgba(255, 255, 255, 0.08);
          padding-left: 35px;
        }

        #current-page-link {
          background: linear-gradient(90deg, #e74c3c, #c0392b) !important;
          font-weight: 600;
        }

        #current-page-link::before {
          transform: scaleY(1) !important;
          background: #fff !important;
        }

        /* Menu Toggle Button */
        .menu-toggle {
          position: fixed;
          top: 20px;
          left: 20px;
          width: 50px;
          height: 50px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border: none;
          border-radius: 12px;
          cursor: pointer;
          z-index: 1001;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
          transition: all 0.3s ease;
          opacity: 1;
          visibility: visible;
          transform: translateX(0);
        }

        .menu-toggle.hidden {
          opacity: 0;
          visibility: hidden;
          transform: translateX(-100px);
        }

        .menu-toggle:hover {
          transform: scale(1.05);
          box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .menu-toggle.hidden:hover {
          transform: translateX(-100px) scale(1.05);
        }

        .hamburger {
          position: relative;
          width: 24px;
          height: 2px;
          background: white;
          margin: 0 auto;
          transition: all 0.3s ease;
        }

        .hamburger::before,
        .hamburger::after {
          content: "";
          position: absolute;
          width: 24px;
          height: 2px;
          background: white;
          transition: all 0.3s ease;
        }

        .hamburger::before {
          top: -8px;
        }

        .hamburger::after {
          bottom: -8px;
        }

        .menu-toggle.active .hamburger {
          background: transparent;
        }

        .menu-toggle.active .hamburger::before {
          top: 0;
          transform: rotate(45deg);
        }

        .menu-toggle.active .hamburger::after {
          bottom: 0;
          transform: rotate(-45deg);
        }

        /* Overlay */
        .overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
          z-index: 999;
        }

        .overlay.active {
          opacity: 1;
          visibility: visible;
        }

        /* Main content */
        .main-content {
          padding: 40px;
          width: 100%;
          background: rgba(255, 255, 255, 0.95);
          border-radius: 20px;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
          margin: 20px;
          backdrop-filter: blur(10px);
        }

        .header h2 {
          color: #2c3e50;
          font-size: 2.5rem;
          font-weight: 300;
          margin-bottom: 30px;
          text-align: center;
          background: linear-gradient(90deg, #667eea, #764ba2);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }

        .input-section {
          background: white;
          padding: 30px;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
          margin-bottom: 30px;
          border: 1px solid #e9ecef;
        }

        .input-group {
          display: flex;
          gap: 20px;
          align-items: flex-start;
          margin-bottom: 20px;
        }

        textarea {
          flex: 1;
          padding: 15px;
          border: 2px solid #e9ecef;
          border-radius: 10px;
          font-size: 14px;
          font-family: "Consolas", monospace;
          resize: vertical;
          min-height: 120px;
          transition: all 0.3s ease;
          background: #fafafa;
        }

        textarea:focus {
          outline: none;
          border-color: #667eea;
          background: white;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea::placeholder {
          color: #6c757d;
          font-style: italic;
        }

        input[type="date"] {
          padding: 12px 15px;
          border: 2px solid #e9ecef;
          border-radius: 10px;
          font-size: 14px;
          transition: all 0.3s ease;
          background: white;
          min-width: 160px;
        }

        input[type="date"]:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn, button {
          padding: 12px 25px;
          border: none;
          border-radius: 10px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .filter-section {
          background: white;
          padding: 25px;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
          margin-bottom: 30px;
          border: 1px solid #e9ecef;
        }

        .filter-group {
          display: flex;
          gap: 15px;
          align-items: center;
          flex-wrap: wrap;
        }

        .filter-group label {
          font-weight: 500;
          color: #2c3e50;
          margin-right: 10px;
        }

        .table-container {
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
          overflow: hidden;
          border: 1px solid #e9ecef;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          font-size: 14px;
        }

        th {
          background: linear-gradient(90deg, #2c3e50 0%, #34495e 100%);
          color: white;
          padding: 20px 15px;
          text-align: center;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          font-size: 13px;
        }

        td {
          padding: 15px;
          text-align: center;
          border-bottom: 1px solid #f8f9fa;
          transition: background-color 0.3s ease;
        }

        tbody tr:hover {
          background-color: #f8f9fa;
        }

        tbody tr:nth-child(even) {
          background-color: #fafafa;
        }

        tbody tr:nth-child(even):hover {
          background-color: #f1f3f4;
        }

        .btn-delete {
          padding: 8px 15px;
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 12px;
          font-weight: 500;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .btn-delete:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-export {
          background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
          margin-left: 10px;
        }

        .btn-export:hover {
          background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
          .sidebar {
            width: 280px;
            left: -280px;
          }
          
          .main-content {
            margin: 10px;
            padding: 20px;
          }

          .input-group {
            flex-direction: column;
          }

          .filter-group {
            justify-content: center;
          }

          table {
            font-size: 12px;
          }

          th, td {
            padding: 10px 8px;
          }

          .menu-toggle {
            top: 15px;
            left: 15px;
            width: 45px;
            height: 45px;
          }
        }

        /* Improved scrollbar */
        ::-webkit-scrollbar {
          width: 8px;
        }

        ::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        /* Floating Alert */
        #floatingAlert {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(44, 62, 80, 0.9) 100%);
          color: white;
          padding: 20px 30px;
          border-radius: 12px;
          font-size: 14px;
          font-weight: 500;
          width: auto;
          min-width: 200px;
          max-width: 350px;
          text-align: center;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
          pointer-events: none;
          z-index: 9999;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
          letter-spacing: 0.3px;
          border: 1px solid rgba(255, 255, 255, 0.1);
          backdrop-filter: blur(10px);
        }

        #floatingAlert.show {
          opacity: 1;
          visibility: visible;
          transform: translate(-50%, -50%) scale(1.02);
        }
    </style>
</head>

<body>
    <!-- Menu Toggle Button -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <div class="hamburger"></div>
    </button>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Menu ƒêi·ªÅu H∆∞·ªõng</h3>
            <button class="close-btn" onclick="toggleSidebar()">&times;</button>
        </div>
        <ul class="nav-list">
            <li class="nav-item">
                <a href="../live/index.html">
                    <i class="icon">üì∏</i>
                    <span>H√åNH ·∫¢NH LIVE ƒê·∫¶Y ƒê·ª¶</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="../hangrotxa/index.html">
                    <i class="icon">üì¶</i>
                    <span>H√ÄNG R·ªöT - X·∫¢</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="../ib/index.html">
                    <i class="icon">üí¨</i>
                    <span>CHECK INBOX KH√ÅCH H√ÄNG</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="../ck/index.html">
                    <i class="icon">üí≥</i>
                    <span>TH√îNG TIN CHUY·ªÇN KHO·∫¢N</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="../hanghoan/index.html">
                    <i class="icon">‚Ü©Ô∏è</i>
                    <span>H√ÄNG HO√ÄN</span>
                </a>
            </li>
            <li class="nav-item">
                <a id="current-page-link" href="../nhaphang/index.html">
                    <i class="icon">üìã</i>
                    <span>NH·∫¨P H√ÄNG</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="main-content">
        <div class="header">
            <h2>Nh·∫≠p d·ªØ li·ªáu s·∫£n ph·∫©m</h2>
        </div>

        <div class="input-section">
            <div class="input-group">
                <textarea id="productInput" placeholder="V√≠ d·ª•:
G·∫•u - 1 - 100
Th·ªè - 3 - 200
C√° - 5 - 100
Ch·ªçn 'T·∫•t c·∫£' ƒë·ªÉ xem to√†n b·ªô d·ªØ li·ªáu
K√©o b·∫£ng nh·∫≠p li·ªáu ·ªü d∆∞·ªõi g√≥c ph·∫£i"></textarea>
                <input type="date" id="dateInput">
                <button onclick="addProducts()">X√°c nh·∫≠n</button>
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-group">
                <label>L·ªçc theo ng√†y: </label>
                <input type="date" id="filterDate">
                <button onclick="applyFilter()">L·ªçc</button>
                <button onclick="clearFilter()">T·∫•t c·∫£</button>
                <button onclick="deleteByFilter()">Xo√° h·∫øt theo l·ªçc</button>
                <button class="btn-export" onclick="exportToExcel()">üì• Xu·∫•t Excel</button>
            </div>
        </div>

        <div class="table-container">
            <table id="productTable">
                <thead>
                    <tr>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Gi√° ti·ªÅn</th>
                        <th>Th√†nh ti·ªÅn</th>
                        <th>Ng√†y nh·∫≠p</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Floating Alert -->
    <div id="floatingAlert">Th√¥ng b√°o hi·ªÉn th·ªã!</div>

    <script>
        // üîπ TODO: thay b·∫±ng config Firebase c·ªßa b·∫°n
        function _0x1ab2(_0x36a23b, _0x52223b) {
            const _0x2e058f = _0x2e05();
            return _0x1ab2 = function(_0x1ab212, _0x4110aa) {
                _0x1ab212 = _0x1ab212 - 0x162;
                let _0x120a0e = _0x2e058f[_0x1ab212];
                return _0x120a0e;
            }, _0x1ab2(_0x36a23b, _0x52223b);
        }

        function _0x2e05() {
            const _0x5a5dc7 = ['1235460FrnjKH', '22977963vpMYJv', 'AIzaSyA-legWlCgjMDEy70rsaTTwLK39F4ZCKhM', 'n2shop-69e37-ne0q1', 'G-TEJH3S2T1D', '1345047lnZTNJ', '366711YpKMry', '13142736zaWdgA', '598906493303', '3756921uppNah', '25XRvqCS', 'n2shop-69e37', '14dthlHY', 'n2shop-69e37.firebaseapp.com', '10009662EXBqRi'];
            _0x2e05 = function() {
                return _0x5a5dc7;
            };
            return _0x2e05();
        }
        const _0x3a343d = _0x1ab2;
        (function(_0x46d1e0, _0x1a2442) {
            const _0x1acdbc = _0x1ab2,
                _0x2a2d1c = _0x46d1e0();
            while (!![]) {
                try {
                    const _0x1aa040 = parseInt(_0x1acdbc(0x168)) / 0x1 + -parseInt(_0x1acdbc(0x16f)) / 0x2 * (-parseInt(_0x1acdbc(0x169)) / 0x3) + parseInt(_0x1acdbc(0x163)) / 0x4 * (-parseInt(_0x1acdbc(0x16d)) / 0x5) + parseInt(_0x1acdbc(0x162)) / 0x6 + -parseInt(_0x1acdbc(0x16c)) / 0x7 + parseInt(_0x1acdbc(0x16a)) / 0x8 + -parseInt(_0x1acdbc(0x164)) / 0x9;
                    if (_0x1aa040 === _0x1a2442) break;
                    else _0x2a2d1c['push'](_0x2a2d1c['shift']());
                } catch (_0x3223ad) {
                    _0x2a2d1c['push'](_0x2a2d1c['shift']());
                }
            }
        }(_0x2e05, 0xd647a));
        const firebaseConfig = {
            'apiKey': _0x3a343d(0x165),
            'authDomain': _0x3a343d(0x170),
            'projectId': _0x3a343d(0x16e),
            'storageBucket': _0x3a343d(0x166),
            'messagingSenderId': _0x3a343d(0x16b),
            'appId': '1:598906493303:web:46d6236a1fdc2eff33e972',
            'measurementId': _0x3a343d(0x167)
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const historyCollectionRef = db.collection("edit_history");

        let unsubscribe = null;
        let currentProductData = []; // Store current displayed data for export
        const today = new Date().toISOString().split("T")[0];
        
        // Check both localStorage and sessionStorage for login status
		var isLoggedIn = localStorage.getItem('isLoggedIn') || sessionStorage.getItem('isLoggedIn') || 'false';
		const userType = localStorage.getItem('userType') || sessionStorage.getItem('userType') || null;
		const checkLogin = localStorage.getItem('checkLogin') || sessionStorage.getItem('checkLogin');

		if (isLoggedIn === 'true') {
			
		} else {
			// Comment out redirect for development/testing
			window.location.href = '../index.html';
			console.log('User not logged in - redirect to index.html disabled for development');
		}
        
        document.getElementById("dateInput").value = today;
        document.getElementById("filterDate").value = today;

        // üîπ Logging function
        function logAction(action, description, oldData = null, newData = null, pageName = 'Nh·∫≠p h√†ng') {
            const logEntry = {
                timestamp: new Date(),
                user: currentUser,
                page: pageName,
                action: action,
                description: description,
                oldData: oldData,
                newData: newData,
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };

            // Save to Firebase
            historyCollectionRef.add(logEntry)
                .then(() => {
                    console.log("Log entry saved successfully");
                })
                .catch((error) => {
                    console.error("Error saving log entry: ", error);
                });
        }

        // üîπ Show floating alert
        function showFloatingAlert(message) {
            const alertBox = document.getElementById('floatingAlert');
            alertBox.innerText = message;
            alertBox.classList.add('show');

            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 3000);
        }

        // üîπ Export to Excel function
        function exportToExcel() {
            if (currentProductData.length === 0) {
                showFloatingAlert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
                return;
            }

            try {
                // Prepare data for export
                const exportData = currentProductData.map((item, index) => ({
                    'STT': index + 1,
                    'T√™n s·∫£n ph·∫©m': item.ten,
                    'S·ªë l∆∞·ª£ng': item.soLuong,
                    'Gi√° ti·ªÅn': item.gia,
                    'Th√†nh ti·ªÅn': item.thanhTien,
                    'Ng√†y nh·∫≠p': item.ngay
                }));

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);

                // Set column widths
                const wscols = [
                    {wch: 5},   // STT
                    {wch: 30},  // T√™n s·∫£n ph·∫©m
                    {wch: 12},  // S·ªë l∆∞·ª£ng
                    {wch: 15},  // Gi√° ti·ªÅn
                    {wch: 15},  // Th√†nh ti·ªÅn
                    {wch: 15}   // Ng√†y nh·∫≠p
                ];
                ws['!cols'] = wscols;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, "Nh·∫≠p h√†ng");

                // Generate filename with current date
                const currentDate = new Date().toISOString().split('T')[0];
                const filterDate = document.getElementById("filterDate").value;
                const filename = filterDate ? 
                    `NhapHang_${filterDate}.xlsx` : 
                    `NhapHang_TatCa_${currentDate}.xlsx`;

                // Write file
                XLSX.writeFile(wb, filename);

                // Log the export action
                logAction('export', `Xu·∫•t d·ªØ li·ªáu nh·∫≠p h√†ng ra Excel (${currentProductData.length} s·∫£n ph·∫©m)`, null, {
                    filename: filename,
                    recordCount: currentProductData.length,
                    filterDate: filterDate || 'T·∫•t c·∫£'
                });

                showFloatingAlert(`ƒê√£ xu·∫•t ${currentProductData.length} s·∫£n ph·∫©m ra file ${filename}!`);
            } catch (error) {
                console.error("Error exporting to Excel:", error);
                showFloatingAlert("L·ªói khi xu·∫•t file Excel!");
            }
        }

        // üîπ Th√™m nhi·ªÅu s·∫£n ph·∫©m (c√≥ ki·ªÉm tra tr√πng)
        function addProducts() {
            const inputText = document.getElementById("productInput").value.trim();
            const date = document.getElementById("dateInput").value;

            if (!inputText) {
                showFloatingAlert("Vui l√≤ng nh·∫≠p d·ªØ li·ªáu!");
                return;
            }

            const lines = inputText.split("\n").map(line => line.trim()).filter(line => line);
            let products = [];

            for (let line of lines) {
                let parts = line.split("-").map(p => p.trim());
                if (parts.length < 3) continue;

                let ten = parts[0];
                let soLuong = parseInt(parts[1]) || 0;
                let gia = parseInt(parts[2]) || 0;
                let thanhTien = soLuong * gia;

                products.push({ ten, soLuong, gia, thanhTien, ngay: date });
            }

            if (products.length === 0) {
                showFloatingAlert("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá!");
                return;
            }

            if (!confirm(`X√°c nh·∫≠n th√™m ${products.length} s·∫£n ph·∫©m v√†o ng√†y ${date}?`)) return;

            processProducts(products);
        }

        // üîπ Process products with duplicate checking
        async function processProducts(products) {
            let addedCount = 0;
            let duplicateCount = 0;

            for (let p of products) {
                // ki·ªÉm tra tr√πng (t√™n + ng√†y)
                let existing = await db.collection("nhaphang")
                    .where("ten", "==", p.ten)
                    .where("ngay", "==", p.ngay)
                    .get();

                if (!existing.empty) {
                    duplicateCount++;
                    showFloatingAlert(`‚ùå L·ªói: S·∫£n ph·∫©m "${p.ten}" ƒë√£ t·ªìn t·∫°i trong ng√†y ${p.ngay}, kh√¥ng th·ªÉ th√™m tr√πng!`);
                } else {
                    await db.collection("nhaphang").add({
                        ...p,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    addedCount++;

                    // Log the add action
                    logAction('add', `Th√™m s·∫£n ph·∫©m: ${p.ten}`, null, p);
                }
            }

            if (addedCount > 0) {
                showFloatingAlert(`‚úÖ ƒê√£ th√™m ${addedCount} s·∫£n ph·∫©m th√†nh c√¥ng!`);
                document.getElementById("productInput").value = "";
            }

            if (duplicateCount > 0) {
                showFloatingAlert(`‚ö†Ô∏è C√≥ ${duplicateCount} s·∫£n ph·∫©m b·ªã tr√πng kh√¥ng th·ªÉ th√™m!`);
            }
        }

        // üîπ L·∫Øng nghe v√† hi·ªÉn th·ªã d·ªØ li·ªáu
        function listenProducts(filterDate = null) {
            if (unsubscribe) unsubscribe();

            let query = db.collection("nhaphang").orderBy("createdAt", "asc");
            if (filterDate) query = query.where("ngay", "==", filterDate);

            unsubscribe = query.onSnapshot(snapshot => {
                const tbody = document.getElementById("productTable").querySelector("tbody");
                tbody.innerHTML = "";
                currentProductData = []; // Reset current data for export

                snapshot.forEach(doc => {
                    const data = doc.data();
                    currentProductData.push(data); // Store for export

                    let row = tbody.insertRow();
                    row.insertCell(0).textContent = data.ten;
                    row.insertCell(1).textContent = data.soLuong;
                    row.insertCell(2).textContent = data.gia;
                    row.insertCell(3).textContent = data.thanhTien;
                    row.insertCell(4).textContent = data.ngay;

                    let actionsCell = row.insertCell(5);
                    let btnDelete = document.createElement("button");
                    btnDelete.textContent = "Xo√°";
                    btnDelete.className = "btn-delete";
                    btnDelete.onclick = () => deleteProduct(doc.id, data);
                    actionsCell.appendChild(btnDelete);
                });
            });
        }

        // üîπ Xo√° 1 s·∫£n ph·∫©m
        async function deleteProduct(id, productData) {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° s·∫£n ph·∫©m n√†y?")) {
                await db.collection("nhaphang").doc(id).delete();
                
                // Log the delete action
                logAction('delete', `X√≥a s·∫£n ph·∫©m: ${productData.ten}`, productData, null);
                
                showFloatingAlert("ƒê√£ x√≥a s·∫£n ph·∫©m th√†nh c√¥ng!");
            }
        }

        // üîπ L·ªçc d·ªØ li·ªáu theo ng√†y
        function applyFilter() {
            const date = document.getElementById("filterDate").value;
            listenProducts(date);
            
            // Log filter action
            logAction('filter', `L·ªçc d·ªØ li·ªáu theo ng√†y: ${date || 'T·∫•t c·∫£'}`, null, { filterDate: date });
            
            showFloatingAlert(date ? `ƒê√£ l·ªçc d·ªØ li·ªáu ng√†y ${date}` : "Hi·ªÉn th·ªã t·∫•t c·∫£ d·ªØ li·ªáu");
        }

        // üîπ Xem t·∫•t c·∫£
        function clearFilter() {
            document.getElementById("filterDate").value = "";
            listenProducts(null);
            showFloatingAlert("Hi·ªÉn th·ªã t·∫•t c·∫£ d·ªØ li·ªáu");
        }

        // üîπ Xo√° theo filter
        async function deleteByFilter() {
            const date = document.getElementById("filterDate").value;
            const isAll = !date;
            
            if (!confirm(isAll ? "Xo√° t·∫•t c·∫£ s·∫£n ph·∫©m?" : `Xo√° t·∫•t c·∫£ s·∫£n ph·∫©m ng√†y ${date}?`)) return;

            let query = db.collection("nhaphang");
            if (!isAll) query = query.where("ngay", "==", date);

            const snapshot = await query.get();
            const deleteCount = snapshot.size;
            
            if (deleteCount === 0) {
                showFloatingAlert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ x√≥a!");
                return;
            }

            // Store data for logging before deletion
            const deletedProducts = [];
            snapshot.forEach(doc => {
                deletedProducts.push(doc.data());
            });

            let batch = db.batch();
            snapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();

            // Log bulk delete action
            logAction('delete', isAll ? 
                `X√≥a t·∫•t c·∫£ s·∫£n ph·∫©m (${deleteCount} s·∫£n ph·∫©m)` : 
                `X√≥a t·∫•t c·∫£ s·∫£n ph·∫©m ng√†y ${date} (${deleteCount} s·∫£n ph·∫©m)`,
                { deletedProducts: deletedProducts, count: deleteCount },
                null
            );

            showFloatingAlert(`ƒê√£ x√≥a ${deleteCount} s·∫£n ph·∫©m th√†nh c√¥ng!`);
        }

        // üîπ Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const menuToggle = document.querySelector('.menu-toggle');
            
            const isOpen = sidebar.classList.contains('open');
            
            if (isOpen) {
                // ƒê√≥ng sidebar
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                menuToggle.classList.remove('active');
                menuToggle.classList.remove('hidden');
            } else {
                // M·ªü sidebar
                sidebar.classList.add('open');
                overlay.classList.add('active');
                menuToggle.classList.add('active');
                menuToggle.classList.add('hidden');
            }
        }

        // üîπ Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Hi·ªÉn th·ªã t·∫•t c·∫£ d·ªØ li·ªáu thay v√¨ ch·ªâ h√¥m nay
			listenProducts(null);
			
			// Nh∆∞ng v·∫´n set ng√†y h√¥m nay cho c√°c input
			document.getElementById("dateInput").value = today;
			document.getElementById("filterDate").value = today;
        });

        // üîπ Make functions globally available
        window.addProducts = addProducts;
        window.deleteProduct = deleteProduct;
        window.applyFilter = applyFilter;
        window.clearFilter = clearFilter;
        window.deleteByFilter = deleteByFilter;
        window.exportToExcel = exportToExcel;
        window.toggleSidebar = toggleSidebar;
    </script>
</body>

</html>