// ═══════════════════════════════════════════════════════════════════════════════
// UNIFIED CUSTOMER 360 & FINANCIAL HUB
// Prisma Schema
// ═══════════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════════════════════════════════════════
// SYSTEM CONFIGURATION
// ═══════════════════════════════════════════════════════════════════════════════

model system_config {
  key         String   @id @db.VarChar(100)
  value       Json
  description String?
  updated_at  DateTime @default(now())
  updated_by  String?  @db.VarChar(100)
}

// ═══════════════════════════════════════════════════════════════════════════════
// USER & ACCESS CONTROL
// ═══════════════════════════════════════════════════════════════════════════════

model roles {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  description String?
  permissions Json     @default("{}")
  created_at  DateTime @default(now())
  users       users[]
}

model users {
  id            Int       @id @default(autoincrement())
  username      String    @unique @db.VarChar(50)
  email         String?   @unique @db.VarChar(255)
  password_hash String    @db.VarChar(255)
  full_name     String?   @db.VarChar(255)
  role_id       Int?
  is_active     Boolean   @default(true)
  last_login    DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @default(now())

  role                         roles?                @relation(fields: [role_id], references: [id])
  customers_created            customers[]           @relation("CustomerCreatedBy")
  wallets_frozen               wallets[]             @relation("WalletFrozenBy")
  virtual_credits_created      virtual_credits[]     @relation("VirtualCreditCreatedBy")
  virtual_credits_cancelled    virtual_credits[]     @relation("VirtualCreditCancelledBy")
  wallet_transactions          wallet_transactions[]
  bank_transactions_processed  bank_transactions[]   @relation("BankTxProcessedBy")
  tickets_created              tickets[]             @relation("TicketCreatedBy")
  tickets_received             tickets[]             @relation("TicketReceivedBy")
  tickets_settled              tickets[]             @relation("TicketSettledBy")
  tickets_completed            tickets[]             @relation("TicketCompletedBy")
  tickets_cancelled            tickets[]             @relation("TicketCancelledBy")
  tickets_assigned             tickets[]             @relation("TicketAssignedTo")
  customer_activities          customer_activities[]
  customer_notes               customer_notes[]
  audit_logs                   audit_logs[]
  pending_matches_resolved     pending_matches[]

  @@index([role_id])
  @@index([is_active])
}

// ═══════════════════════════════════════════════════════════════════════════════
// CUSTOMERS
// ═══════════════════════════════════════════════════════════════════════════════

model customers {
  id                   Int       @id @default(autoincrement())
  phone                String    @unique @db.VarChar(11)
  name                 String?   @db.VarChar(255)
  email                String?   @db.VarChar(255)
  addresses            Json      @default("[]")
  tpos_partner_ids     Json      @default("[]")
  facebook_psid        String?   @db.VarChar(100)
  zalo_id              String?   @db.VarChar(100)
  status               String    @default("active") @db.VarChar(20)
  tier                 String    @default("normal") @db.VarChar(20)
  tags                 Json      @default("[]")
  total_orders         Int       @default(0)
  successful_orders    Int       @default(0)
  returned_orders      Int       @default(0)
  total_spent          Decimal   @default(0) @db.Decimal(15, 2)
  first_order_date     DateTime?
  last_order_date      DateTime?
  last_interaction_at  DateTime?
  rfm_recency          Int       @default(0)
  rfm_frequency        Int       @default(0)
  rfm_monetary         Int       @default(0)
  rfm_segment          String?   @db.VarChar(30)
  rfm_calculated_at    DateTime?
  internal_note        String?
  created_at           DateTime  @default(now())
  updated_at           DateTime  @default(now())
  created_by           Int?

  created_by_user       users?                @relation("CustomerCreatedBy", fields: [created_by], references: [id])
  wallet                wallets?
  virtual_credits       virtual_credits[]
  wallet_transactions   wallet_transactions[]
  bank_transactions     bank_transactions[]   @relation("BankTxMatchedCustomer")
  tickets               tickets[]
  customer_activities   customer_activities[]
  customer_notes        customer_notes[]
  pending_matches       pending_matches[]
  qr_code_mappings      qr_code_mappings[]

  @@index([phone])
  @@index([status])
  @@index([tier])
  @@index([last_order_date(sort: Desc)])
  @@index([rfm_segment])
}

// ═══════════════════════════════════════════════════════════════════════════════
// WALLETS
// ═══════════════════════════════════════════════════════════════════════════════

model wallets {
  id                   Int       @id @default(autoincrement())
  customer_id          Int       @unique
  phone                String    @unique @db.VarChar(11)
  real_balance         Decimal   @default(0) @db.Decimal(15, 2)
  virtual_balance      Decimal   @default(0) @db.Decimal(15, 2)
  total_deposited      Decimal   @default(0) @db.Decimal(15, 2)
  total_withdrawn      Decimal   @default(0) @db.Decimal(15, 2)
  total_virtual_issued Decimal   @default(0) @db.Decimal(15, 2)
  total_virtual_used   Decimal   @default(0) @db.Decimal(15, 2)
  total_virtual_expired Decimal  @default(0) @db.Decimal(15, 2)
  created_at           DateTime  @default(now())
  updated_at           DateTime  @default(now())
  is_frozen            Boolean   @default(false)
  frozen_reason        String?
  frozen_at            DateTime?
  frozen_by            Int?

  customer             customers           @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  frozen_by_user       users?              @relation("WalletFrozenBy", fields: [frozen_by], references: [id])
  virtual_credits      virtual_credits[]
  wallet_transactions  wallet_transactions[]

  @@index([phone])
  @@index([is_frozen])
}

// ═══════════════════════════════════════════════════════════════════════════════
// VIRTUAL CREDITS
// ═══════════════════════════════════════════════════════════════════════════════

model virtual_credits {
  id               Int       @id @default(autoincrement())
  wallet_id        Int
  phone            String    @db.VarChar(11)
  original_amount  Decimal   @db.Decimal(15, 2)
  remaining_amount Decimal   @db.Decimal(15, 2)
  issued_at        DateTime  @default(now())
  expires_at       DateTime
  status           String    @default("ACTIVE") @db.VarChar(20)
  source_type      String    @db.VarChar(30)
  source_ticket_id Int?
  source_note      String?
  usage_history    Json      @default("[]")
  created_by       Int?
  cancelled_by     Int?
  cancelled_at     DateTime?
  cancel_reason    String?
  created_at       DateTime  @default(now())
  updated_at       DateTime  @default(now())

  wallet              wallets               @relation(fields: [wallet_id], references: [id], onDelete: Cascade)
  customer            customers             @relation(fields: [phone], references: [phone])
  created_by_user     users?                @relation("VirtualCreditCreatedBy", fields: [created_by], references: [id])
  cancelled_by_user   users?                @relation("VirtualCreditCancelledBy", fields: [cancelled_by], references: [id])
  source_ticket       tickets?              @relation("VirtualCreditSourceTicket", fields: [source_ticket_id], references: [id])
  wallet_transactions wallet_transactions[]
  tickets             tickets[]             @relation("TicketVirtualCredit")

  @@index([wallet_id])
  @@index([phone])
  @@index([status])
  @@index([expires_at])
  @@index([source_ticket_id])
}

// ═══════════════════════════════════════════════════════════════════════════════
// WALLET TRANSACTIONS (IMMUTABLE)
// ═══════════════════════════════════════════════════════════════════════════════

model wallet_transactions {
  id                     BigInt    @id @default(autoincrement())
  transaction_code       String    @unique @db.VarChar(30)
  wallet_id              Int
  phone                  String    @db.VarChar(11)
  transaction_type       String    @db.VarChar(30)
  amount                 Decimal   @db.Decimal(15, 2)
  real_balance_before    Decimal   @db.Decimal(15, 2)
  real_balance_after     Decimal   @db.Decimal(15, 2)
  virtual_balance_before Decimal   @db.Decimal(15, 2)
  virtual_balance_after  Decimal   @db.Decimal(15, 2)
  source_type            String?   @db.VarChar(30)
  source_id              String?   @db.VarChar(100)
  source_details         Json?
  virtual_credit_id      Int?
  description            String?
  internal_note          String?
  created_by             Int?
  created_at             DateTime  @default(now())

  wallet            wallets           @relation(fields: [wallet_id], references: [id])
  customer          customers         @relation(fields: [phone], references: [phone])
  virtual_credit    virtual_credits?  @relation(fields: [virtual_credit_id], references: [id])
  created_by_user   users?            @relation(fields: [created_by], references: [id])
  bank_transactions bank_transactions[]
  tickets           tickets[]

  @@index([wallet_id])
  @@index([phone])
  @@index([transaction_type])
  @@index([created_at(sort: Desc)])
  @@index([source_type, source_id])
}

// ═══════════════════════════════════════════════════════════════════════════════
// BANK TRANSACTIONS
// ═══════════════════════════════════════════════════════════════════════════════

model bank_transactions {
  id                    BigInt    @id @default(autoincrement())
  sepay_id              BigInt    @unique
  gateway               String    @db.VarChar(50)
  transaction_date      DateTime
  account_number        String    @db.VarChar(50)
  content               String?
  transfer_type         String    @db.VarChar(10)
  transfer_amount       Decimal   @db.Decimal(15, 2)
  accumulated_balance   Decimal?  @db.Decimal(15, 2)
  reference_code        String?   @db.VarChar(100)
  extracted_code        String?   @db.VarChar(50)
  extracted_phone       String?   @db.VarChar(11)
  extraction_method     String?   @db.VarChar(30)
  extraction_note       String?
  matched_customer_id   Int?
  matched_phone         String?   @db.VarChar(11)
  match_status          String    @default("PENDING") @db.VarChar(20)
  wallet_processed      Boolean   @default(false)
  wallet_transaction_id BigInt?
  processed_at          DateTime?
  processed_by          Int?
  is_hidden             Boolean   @default(false)
  raw_webhook_data      Json?
  webhook_received_at   DateTime  @default(now())
  created_at            DateTime  @default(now())
  updated_at            DateTime  @default(now())

  matched_customer   customers?           @relation("BankTxMatchedCustomer", fields: [matched_customer_id], references: [id])
  wallet_transaction wallet_transactions? @relation(fields: [wallet_transaction_id], references: [id])
  processed_by_user  users?               @relation("BankTxProcessedBy", fields: [processed_by], references: [id])
  pending_matches    pending_matches[]
  qr_code_mappings   qr_code_mappings[]

  @@index([sepay_id])
  @@index([transaction_date(sort: Desc)])
  @@index([matched_phone])
  @@index([wallet_processed])
  @@index([match_status])
}

// ═══════════════════════════════════════════════════════════════════════════════
// TICKETS
// ═══════════════════════════════════════════════════════════════════════════════

model tickets {
  id                          Int       @id @default(autoincrement())
  ticket_code                 String    @unique @db.VarChar(20)
  customer_id                 Int
  phone                       String    @db.VarChar(11)
  customer_name               String?   @db.VarChar(255)
  order_id                    String?   @db.VarChar(50)
  tpos_order_id               Int?
  tracking_code               String?   @db.VarChar(50)
  carrier                     String?   @db.VarChar(50)
  ticket_type                 String    @db.VarChar(30)
  status                      String    @default("PENDING_GOODS") @db.VarChar(30)
  priority                    String    @default("normal") @db.VarChar(20)
  products                    Json      @default("[]")
  original_cod                Decimal?  @db.Decimal(15, 2)
  new_cod                     Decimal?  @db.Decimal(15, 2)
  refund_amount               Decimal?  @db.Decimal(15, 2)
  wallet_action               String?   @db.VarChar(30)
  wallet_credited             Boolean   @default(false)
  wallet_transaction_id       BigInt?
  virtual_credit_id           Int?
  fix_cod_reason              String?   @db.VarChar(30)
  linked_new_order_id         String?   @db.VarChar(50)
  linked_new_order_delivered_at DateTime?
  carrier_deadline            DateTime?
  carrier_issue_flag          Boolean   @default(false)
  received_at                 DateTime?
  received_by                 Int?
  settled_at                  DateTime?
  settled_by                  Int?
  completed_at                DateTime?
  completed_by                Int?
  cancelled_at                DateTime?
  cancelled_by                Int?
  cancel_reason               String?
  assigned_to                 Int?
  internal_note               String?
  action_history              Json      @default("[]")
  created_at                  DateTime  @default(now())
  updated_at                  DateTime  @default(now())
  created_by                  Int?

  customer             customers             @relation(fields: [customer_id], references: [id])
  wallet_transaction   wallet_transactions?  @relation(fields: [wallet_transaction_id], references: [id])
  virtual_credit       virtual_credits?      @relation("TicketVirtualCredit", fields: [virtual_credit_id], references: [id])
  created_by_user      users?                @relation("TicketCreatedBy", fields: [created_by], references: [id])
  received_by_user     users?                @relation("TicketReceivedBy", fields: [received_by], references: [id])
  settled_by_user      users?                @relation("TicketSettledBy", fields: [settled_by], references: [id])
  completed_by_user    users?                @relation("TicketCompletedBy", fields: [completed_by], references: [id])
  cancelled_by_user    users?                @relation("TicketCancelledBy", fields: [cancelled_by], references: [id])
  assigned_to_user     users?                @relation("TicketAssignedTo", fields: [assigned_to], references: [id])
  virtual_credits_source virtual_credits[]   @relation("VirtualCreditSourceTicket")

  @@index([ticket_code])
  @@index([phone])
  @@index([status])
  @@index([ticket_type])
  @@index([order_id])
  @@index([created_at(sort: Desc)])
  @@index([assigned_to])
}

// ═══════════════════════════════════════════════════════════════════════════════
// CUSTOMER ACTIVITIES
// ═══════════════════════════════════════════════════════════════════════════════

model customer_activities {
  id             BigInt   @id @default(autoincrement())
  customer_id    Int
  phone          String   @db.VarChar(11)
  activity_type  String   @db.VarChar(50)
  title          String   @db.VarChar(255)
  description    String?
  reference_type String?  @db.VarChar(30)
  reference_id   String?  @db.VarChar(100)
  metadata       Json     @default("{}")
  icon           String?  @db.VarChar(30)
  color          String?  @db.VarChar(20)
  created_by     Int?
  created_at     DateTime @default(now())

  customer        customers @relation(fields: [customer_id], references: [id])
  created_by_user users?    @relation(fields: [created_by], references: [id])

  @@index([phone])
  @@index([customer_id])
  @@index([activity_type])
  @@index([created_at(sort: Desc)])
  @@index([reference_type, reference_id])
}

// ═══════════════════════════════════════════════════════════════════════════════
// CUSTOMER NOTES
// ═══════════════════════════════════════════════════════════════════════════════

model customer_notes {
  id          Int      @id @default(autoincrement())
  customer_id Int
  phone       String   @db.VarChar(11)
  content     String
  is_pinned   Boolean  @default(false)
  category    String   @default("general") @db.VarChar(30)
  created_by  Int
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())

  customer        customers @relation(fields: [customer_id], references: [id])
  created_by_user users     @relation(fields: [created_by], references: [id])

  @@index([phone])
  @@index([is_pinned])
}

// ═══════════════════════════════════════════════════════════════════════════════
// AUDIT LOGS (IMMUTABLE)
// ═══════════════════════════════════════════════════════════════════════════════

model audit_logs {
  id                    BigInt   @id @default(autoincrement())
  action                String   @db.VarChar(100)
  entity_type           String   @db.VarChar(50)
  entity_id             String?  @db.VarChar(100)
  entity_phone          String?  @db.VarChar(11)
  old_value             Json?
  new_value             Json?
  description           String?
  performed_by          Int?
  performed_by_username String?  @db.VarChar(50)
  performed_by_role     String?  @db.VarChar(50)
  ip_address            String?
  user_agent            String?
  request_id            String?  @db.VarChar(50)
  is_suspicious         Boolean  @default(false)
  fraud_score           Int      @default(0)
  created_at            DateTime @default(now())

  performed_by_user users? @relation(fields: [performed_by], references: [id])

  @@index([action])
  @@index([entity_type, entity_id])
  @@index([performed_by])
  @@index([created_at(sort: Desc)])
  @@index([is_suspicious])
  @@index([entity_phone])
}

// ═══════════════════════════════════════════════════════════════════════════════
// PENDING MATCHES
// ═══════════════════════════════════════════════════════════════════════════════

model pending_matches {
  id                     Int       @id @default(autoincrement())
  bank_transaction_id    BigInt
  extracted_phone_partial String   @db.VarChar(20)
  matched_customers      Json
  selected_customer_id   Int?
  status                 String    @default("PENDING") @db.VarChar(20)
  resolution_note        String?
  resolved_by            Int?
  resolved_at            DateTime?
  created_at             DateTime  @default(now())

  bank_transaction   bank_transactions @relation(fields: [bank_transaction_id], references: [id])
  selected_customer  customers?        @relation(fields: [selected_customer_id], references: [id])
  resolved_by_user   users?            @relation(fields: [resolved_by], references: [id])

  @@index([status])
  @@index([bank_transaction_id])
}

// ═══════════════════════════════════════════════════════════════════════════════
// QR CODE MAPPINGS
// ═══════════════════════════════════════════════════════════════════════════════

model qr_code_mappings {
  id                  Int       @id @default(autoincrement())
  unique_code         String    @unique @db.VarChar(50)
  customer_id         Int?
  phone               String?   @db.VarChar(11)
  amount              Decimal?  @db.Decimal(15, 2)
  status              String    @default("ACTIVE") @db.VarChar(20)
  used_at             DateTime?
  bank_transaction_id BigInt?
  created_at          DateTime  @default(now())
  expires_at          DateTime?

  customer         customers?         @relation(fields: [customer_id], references: [id])
  bank_transaction bank_transactions? @relation(fields: [bank_transaction_id], references: [id])

  @@index([unique_code])
  @@index([phone])
  @@index([status])
}

// ═══════════════════════════════════════════════════════════════════════════════
// SCHEDULED JOBS
// ═══════════════════════════════════════════════════════════════════════════════

model scheduled_jobs {
  id                   Int       @id @default(autoincrement())
  job_name             String    @db.VarChar(100)
  job_type             String    @db.VarChar(50)
  last_run_at          DateTime?
  last_run_status      String?   @db.VarChar(20)
  last_run_duration_ms Int?
  last_run_result      Json?
  next_run_at          DateTime?
  is_enabled           Boolean   @default(true)
  cron_expression      String?   @db.VarChar(50)
  created_at           DateTime  @default(now())
  updated_at           DateTime  @default(now())

  @@unique([job_name])
}
