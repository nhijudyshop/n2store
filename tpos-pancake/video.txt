# PH√ÇN T√çCH K·ª∏ THU·∫¨T: C∆† CH·∫æ HO·∫†T ƒê·ªòNG SOCKET REALTIME (TPOS)

**Ng√†y ghi nh·∫≠n:** 07/01/2026
**Ngu·ªìn d·ªØ li·ªáu:** Video ph√¢n t√≠ch Network Log (WebSocket)

---

## 1. T·ªïng quan Giao th·ª©c (Protocol Overview)
H·ªá th·ªëng s·ª≠ d·ª•ng th∆∞ vi·ªán **Socket.IO** ch·∫°y tr√™n n·ªÅn giao th·ª©c **WebSocket (WSS)** ƒë·ªÉ duy tr√¨ k·∫øt n·ªëi th·ªùi gian th·ª±c gi·ªØa Client (Tr√¨nh duy·ªát) v√† Server.

- **Endpoint:** `wss://[domain]/socket.io/?EIO=4&transport=websocket`
- **Namespace:** `/chatomni` (K√™nh ri√™ng cho chat ƒëa n·ªÅn t·∫£ng)
- **C∆° ch·∫ø:** Event-based (D·ª±a tr√™n s·ª± ki·ªán)

---

## 2. C·∫•u tr√∫c G√≥i tin (Packet Structure)
D·ªØ li·ªáu ƒë∆∞·ª£c truy·ªÅn t·∫£i d∆∞·ªõi d·∫°ng Text Frame. ƒê·ªãnh d·∫°ng chu·∫©n c·ªßa m·ªôt g√≥i tin nh·∫≠n ƒë∆∞·ª£c t·ª´ Server:

`42[SequenceID]/chatomni,["on-events","[Serialized_JSON]"]`

**Gi·∫£i th√≠ch c√°c th√†nh ph·∫ßn trong log video:**
* **`4`**: Engine.IO Message packet (G√≥i tin d·ªØ li·ªáu).
* **`2`**: Socket.IO Event packet (G√≥i tin s·ª± ki·ªán).
* **`SequenceID`**: S·ªë th·ª© t·ª± tin nh·∫Øn (V√≠ d·ª•: `423`, `424`...).
* **`/chatomni`**: Namespace ƒë√≠ch.
* **`on-events`**: T√™n s·ª± ki·ªán client c·∫ßn l·∫Øng nghe.
* **`Serialized_JSON`**: D·ªØ li·ªáu nghi·ªáp v·ª• ƒë∆∞·ª£c ƒë√≥ng g√≥i th√†nh chu·ªói String.

---

## 3. Chi ti·∫øt D·ªØ li·ªáu Nghi·ªáp v·ª• (Payload Analysis)
D·ªØ li·ªáu th·ª±c t·∫ø n·∫±m trong ph·∫ßn t·ª≠ th·ª© 2 c·ªßa m·∫£ng JSON. Sau khi th·ª±c hi·ªán `JSON.parse()`, ta c√≥ ƒë·ªëi t∆∞·ª£ng sau:

### 3.1. C·∫•u tr√∫c JSON g·ªëc
```json
{
  "C": "Conversation",
  "d": {
    "Id": "65434898e35...",
    "t": "SaleOnline_Order",
    "Message": "Huy·ªÅn Nh·ªè: √Åo ƒëen 50kg...",
    "ConversationId": "...",
    "IsRead": false,
    "Customer": { ... },
    "Product": { ... }
  }
}

Tr∆∞·ªùng,√ù nghƒ©a,M·ª•c ƒë√≠ch s·ª≠ d·ª•ng
C,Context,"X√°c ƒë·ªãnh ng·ªØ c·∫£nh (th∆∞·ªùng l√† ""Conversation"")."
d.t,Type,Lo·∫°i s·ª± ki·ªán. Quan tr·ªçng nh·∫•t ƒë·ªÉ ƒëi·ªÅu h∆∞·ªõng x·ª≠ l√Ω UI.  - SaleOnline_Order: Kh√°ch ch·ªët ƒë∆°n/Comment m·ªõi. - SaleOnline_Update: C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n.
d.Message,Content,N·ªôi dung hi·ªÉn th·ªã bao g·ªìm T√™n kh√°ch v√† Comment.
d.ConversationId,Scope ID,ID c·ªßa phi√™n livestream hi·ªán t·∫°i ƒë·ªÉ gom nh√≥m comment.

## 4. Lu·ªìng x·ª≠ l√Ω d·ªØ li·ªáu (Workflow)
ƒê·ªÉ t√°i hi·ªán l·∫°i vi·ªác b·∫Øt d·ªØ li·ªáu n√†y (v√≠ d·ª• vi·∫øt Tool ho·∫∑c Extension), c·∫ßn th·ª±c hi·ªán theo lu·ªìng sau:

Handshake: K·∫øt n·ªëi t·ªõi WSS Server v·ªõi c√°c tham s·ªë EIO=4 v√† transport=websocket.

Subscribe: G·ª≠i g√≥i tin 40/chatomni, ƒë·ªÉ ƒëƒÉng k√Ω v√†o namespace chat.

Listen: L·∫Øng nghe c√°c frame b·∫Øt ƒë·∫ßu b·∫±ng 42/chatomni.

Parse:

T√°ch ph·∫ßn header 42.../chatomni,.

L·∫•y ph·∫ßn m·∫£ng JSON ph√≠a sau.

L·∫•y ph·∫ßn t·ª≠ index [1] c·ªßa m·∫£ng.

Parse chu·ªói JSON ƒë√≥ ra object.

Render: Ki·ªÉm tra d.t == 'SaleOnline_Order' ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o ch·ªët ƒë∆°n l√™n m√†n h√¨nh.

## 5. V√≠ d·ª• Code x·ª≠ l√Ω (JavaScript/Node.js)
// Gi·∫£ l·∫≠p x·ª≠ l√Ω s·ª± ki·ªán khi nh·∫≠n packet t·ª´ socket
socket.on('on-events', (payloadString) => {
    try {
        // 1. Gi·∫£i m√£ chu·ªói JSON
        const dataObj = JSON.parse(payloadString);
        
        // 2. Ki·ªÉm tra d·ªØ li·ªáu an to√†n
        if (!dataObj || !dataObj.d) return;

        const eventData = dataObj.d;

        // 3. X·ª≠ l√Ω nghi·ªáp v·ª•: ƒê∆°n h√†ng m·ªõi
        if (eventData.t === 'SaleOnline_Order') {
            console.log("üî• C√ì ƒê∆†N H√ÄNG M·ªöI!");
            console.log("- Kh√°ch h√†ng:", eventData.Message.split(':')[0]);
            console.log("- N·ªôi dung:", eventData.Message.split(':')[1]);
            console.log("- ID H·ªôi tho·∫°i:", eventData.ConversationId);
        }

    } catch (e) {
        console.error("L·ªói parse JSON:", e);
    }
});