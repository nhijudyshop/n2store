name: Inject Gemini API Keys
on:
  push:
    branches:
      - main
      - claude/**
    paths:
      - 'AI/gemini.html'
  workflow_dispatch:

jobs:
  inject-gemini-keys:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Inject GEMINI_PRO_KEY into gemini.html
        run: |
          echo "üîß Starting API key injection..."
          
          # Inject GEMINI_PRO_KEY
          sed -i "s|window.GEMINI_PRO_KEY = savedGeminiProKey \|\| '' \|\| '';|window.GEMINI_PRO_KEY = savedGeminiProKey \|\| '${{ secrets.GEMINI_PRO_KEY }}' \|\| '';|g" AI/gemini.html
          
          echo "‚úÖ GEMINI_PRO_KEY injected successfully"
      
      - name: Verify injection
        run: |
          echo "üîç Checking if GEMINI_PRO_KEY was injected..."
          if grep -q "GEMINI_PRO_KEY = savedGeminiProKey" AI/gemini.html; then
            echo "‚úÖ GEMINI_PRO_KEY pattern found"
          else
            echo "‚ùå Pattern not found - injection may have failed"
            exit 1
          fi
      
      - name: Commit changes (if any)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet AI/gemini.html; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            git add AI/gemini.html
            git commit -m "üîë Auto-inject Gemini API key from secrets [skip ci]"
            git push
            echo "‚úÖ Changes committed and pushed"
          fi
      
      - name: Display success message
        run: |
          echo "=================================================="
          echo "‚úÖ Gemini API Key Injection Complete"
          echo "=================================================="
          echo ""
          echo "Key has been injected into:"
          echo "  - AI/gemini.html"
          echo ""
          echo "The application will now use:"
          echo "  1. localStorage (if user set manually)"
          echo "  2. GitHub Secrets GEMINI_PRO_KEY (fallback)"
          echo ""
          echo "‚ö†Ô∏è  WARNING: The API key is now visible in the"
          echo "    HTML source code. Make sure this is intended."
          echo ""
          echo "=================================================="
