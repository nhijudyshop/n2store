name: Inject API Keys

on:
  push:
    branches:
      - main
      - claude/**
    paths:
      - 'invoice-compare/**'
  workflow_dispatch:

jobs:
  inject-keys:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Inject API Keys into HTML
        run: |
          # Inject GEMINI_KEYS (free keys)
          sed -i "s|window.GEMINI_KEYS = savedGeminiKeys \|\| window.GEMINI_KEYS \|\| '';|window.GEMINI_KEYS = savedGeminiKeys \|\| '${{ secrets.GEMINI_KEYS }}' \|\| '';|g" invoice-compare/index.html

          # Inject GEMINI_PRO_KEY (Pro key as fallback)
          sed -i "s|window.GEMINI_PRO_KEY = window.GEMINI_PRO_KEY \|\| '';|window.GEMINI_PRO_KEY = '${{ secrets.GEMINI_PRO_KEY }}' \|\| '';|g" invoice-compare/index.html

          # Inject HF_KEYS
          sed -i "s|window.HF_KEYS = savedHFKeys \|\| window.HF_KEYS \|\| '';|window.HF_KEYS = savedHFKeys \|\| '${{ secrets.HF_KEYS }}' \|\| '';|g" invoice-compare/index.html

          echo "‚úÖ API Keys injected successfully"

      - name: Verify injection
        run: |
          echo "Checking if keys were injected..."
          grep -q "GEMINI_KEYS = savedGeminiKeys" invoice-compare/index.html && echo "‚úÖ GEMINI_KEYS pattern found" || echo "‚ùå GEMINI_KEYS pattern not found"
          grep -q "GEMINI_PRO_KEY = " invoice-compare/index.html && echo "‚úÖ GEMINI_PRO_KEY pattern found" || echo "‚ùå GEMINI_PRO_KEY pattern not found"

      - name: Commit changes (if any)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet invoice-compare/index.html; then
            echo "No changes to commit"
          else
            git add invoice-compare/index.html
            git commit -m "üîë Auto-inject API keys from secrets [skip ci]"
            git push
            echo "‚úÖ Changes committed and pushed"
          fi

      - name: Display success message
        run: |
          echo "=================================================="
          echo "‚úÖ API Keys Injection Complete"
          echo "=================================================="
          echo ""
          echo "Keys have been injected into:"
          echo "  - invoice-compare/index.html"
          echo ""
          echo "Injected keys:"
          echo "  - GEMINI_KEYS: Free keys (tried first)"
          echo "  - GEMINI_PRO_KEY: Pro key (fallback, always last)"
          echo "  - HF_KEYS: HuggingFace keys"
          echo ""
          echo "The application will now automatically use keys from:"
          echo "  1. localStorage (if user set manually)"
          echo "  2. GitHub Secrets (injected by this workflow)"
          echo "  3. Pro key as final fallback"
          echo ""
          echo "=================================================="
